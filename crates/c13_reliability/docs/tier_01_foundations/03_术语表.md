# æœ¯è¯­è¡¨ - C13 Reliability

**æœ€åæ›´æ–°**: 2025-10-24

æœ¬æ–‡æ¡£æ±‡æ€»äº† Rust å¯é æ€§å·¥ç¨‹ä¸­çš„æ ¸å¿ƒæœ¯è¯­å’Œæ¦‚å¿µã€‚

---

## ğŸ“‹ ç›®å½•

- [æœ¯è¯­è¡¨ - C13 Reliability](#æœ¯è¯­è¡¨---c13-reliability)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ§ª æµ‹è¯•ç›¸å…³æœ¯è¯­](#-æµ‹è¯•ç›¸å…³æœ¯è¯­)
    - [Unit Test (å•å…ƒæµ‹è¯•)](#unit-test-å•å…ƒæµ‹è¯•)
    - [Integration Test (é›†æˆæµ‹è¯•)](#integration-test-é›†æˆæµ‹è¯•)
    - [Benchmark (åŸºå‡†æµ‹è¯•)](#benchmark-åŸºå‡†æµ‹è¯•)
    - [Fuzz Testing (æ¨¡ç³Šæµ‹è¯•)](#fuzz-testing-æ¨¡ç³Šæµ‹è¯•)
    - [Property-Based Testing (å±æ€§æµ‹è¯•)](#property-based-testing-å±æ€§æµ‹è¯•)
    - [Test Coverage (æµ‹è¯•è¦†ç›–ç‡)](#test-coverage-æµ‹è¯•è¦†ç›–ç‡)
  - [âŒ é”™è¯¯å¤„ç†æœ¯è¯­](#-é”™è¯¯å¤„ç†æœ¯è¯­)
    - [Result Type (Result ç±»å‹)](#result-type-result-ç±»å‹)
    - [Panic (ææ…Œ)](#panic-ææ…Œ)
    - [Error Propagation (é”™è¯¯ä¼ æ’­)](#error-propagation-é”™è¯¯ä¼ æ’­)
    - [Error Chain (é”™è¯¯é“¾)](#error-chain-é”™è¯¯é“¾)
    - [Custom Error Type (è‡ªå®šä¹‰é”™è¯¯ç±»å‹)](#custom-error-type-è‡ªå®šä¹‰é”™è¯¯ç±»å‹)
  - [ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§æœ¯è¯­](#-ç›‘æ§ä¸å¯è§‚æµ‹æ€§æœ¯è¯­)
    - [Logging (æ—¥å¿—è®°å½•)](#logging-æ—¥å¿—è®°å½•)
    - [Metrics (æŒ‡æ ‡)](#metrics-æŒ‡æ ‡)
    - [Tracing (è¿½è¸ª)](#tracing-è¿½è¸ª)
    - [Observability (å¯è§‚æµ‹æ€§)](#observability-å¯è§‚æµ‹æ€§)
    - [SLI/SLO/SLA](#slislosla)
  - [ğŸ”„ æ•…éšœæ¢å¤æœ¯è¯­](#-æ•…éšœæ¢å¤æœ¯è¯­)
    - [Timeout (è¶…æ—¶)](#timeout-è¶…æ—¶)
    - [Retry (é‡è¯•)](#retry-é‡è¯•)
    - [Circuit Breaker (æ–­è·¯å™¨)](#circuit-breaker-æ–­è·¯å™¨)
    - [Bulkhead (èˆ±å£)](#bulkhead-èˆ±å£)
    - [Graceful Degradation (ä¼˜é›…é™çº§)](#graceful-degradation-ä¼˜é›…é™çº§)
    - [Graceful Shutdown (ä¼˜é›…å…³æœº)](#graceful-shutdown-ä¼˜é›…å…³æœº)
  - [ğŸ“ˆ æ€§èƒ½ç›¸å…³æœ¯è¯­](#-æ€§èƒ½ç›¸å…³æœ¯è¯­)
    - [Latency (å»¶è¿Ÿ)](#latency-å»¶è¿Ÿ)
    - [Throughput (ååé‡)](#throughput-ååé‡)
    - [Profiling (æ€§èƒ½å‰–æ)](#profiling-æ€§èƒ½å‰–æ)
  - [ğŸ—ï¸ æ¶æ„æ¨¡å¼æœ¯è¯­](#ï¸-æ¶æ„æ¨¡å¼æœ¯è¯­)
    - [High Availability (é«˜å¯ç”¨)](#high-availability-é«˜å¯ç”¨)
    - [Fault Tolerance (å®¹é”™)](#fault-tolerance-å®¹é”™)
    - [Load Balancing (è´Ÿè½½å‡è¡¡)](#load-balancing-è´Ÿè½½å‡è¡¡)
    - [Chaos Engineering (æ··æ²Œå·¥ç¨‹)](#chaos-engineering-æ··æ²Œå·¥ç¨‹)

---

## ğŸ§ª æµ‹è¯•ç›¸å…³æœ¯è¯­

### Unit Test (å•å…ƒæµ‹è¯•)

é’ˆå¯¹å•ä¸ªå‡½æ•°æˆ–æ¨¡å—çš„æµ‹è¯•ï¼Œé€šè¿‡ `#[test]` å±æ€§æ ‡è®°ã€‚

```rust
#[test]
fn test_add() {
    assert_eq!(2 + 2, 4);
}
```

**ç‰¹ç‚¹**:

- å¿«é€Ÿæ‰§è¡Œ
- éš”ç¦»æ€§å¼º
- æµ‹è¯•æœ€å°å•å…ƒ

---

### Integration Test (é›†æˆæµ‹è¯•)

æµ‹è¯•å¤šä¸ªæ¨¡å—åä½œçš„æµ‹è¯•ï¼Œä½äº `tests/` ç›®å½•ã€‚

```rust
// tests/integration_test.rs
#[test]
fn test_end_to_end() {
    // æµ‹è¯•å¤šä¸ªæ¨¡å—çš„äº¤äº’
}
```

**ç‰¹ç‚¹**:

- æµ‹è¯•æ¨¡å—é—´äº¤äº’
- æ›´æ¥è¿‘çœŸå®ä½¿ç”¨åœºæ™¯
- æ‰§è¡Œæ—¶é—´è¾ƒé•¿

---

### Benchmark (åŸºå‡†æµ‹è¯•)

è¡¡é‡ä»£ç æ€§èƒ½çš„æµ‹è¯•ï¼Œé€šå¸¸ä½¿ç”¨ Criterion æ¡†æ¶ã€‚

```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn fibonacci_benchmark(c: &mut Criterion) {
    c.bench_function("fib 20", |b| b.iter(|| fibonacci(black_box(20))));
}
```

**å…³é”®æŒ‡æ ‡**:

- ååé‡ (Throughput)
- å»¶è¿Ÿ (Latency)
- å†…å­˜ä½¿ç”¨

---

### Fuzz Testing (æ¨¡ç³Šæµ‹è¯•)

é€šè¿‡ç”Ÿæˆéšæœºè¾“å…¥æ¥å‘ç°ç¨‹åºæ¼æ´çš„æµ‹è¯•æ–¹æ³•ã€‚

```rust
#[cfg(test)]
mod fuzz_tests {
    use libfuzzer_sys::fuzz_target;
    
    fuzz_target!(|data: &[u8]| {
        let _ = parse_input(data);
    });
}
```

**ç‰¹ç‚¹**:

- å‘ç°è¾¹ç•Œæƒ…å†µ
- è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
- å‘ç°æœªé¢„æœŸçš„é”™è¯¯

---

### Property-Based Testing (å±æ€§æµ‹è¯•)

é€šè¿‡éªŒè¯å±æ€§è€Œéå…·ä½“å€¼çš„æµ‹è¯•æ–¹æ³•ï¼Œä½¿ç”¨ `proptest` æˆ– `quickcheck`ã€‚

```rust
use proptest::prelude::*;

proptest! {
    #[test]
    fn test_reverse_twice(v: Vec<i32>) {
        let reversed_twice: Vec<i32> = v.iter().copied().rev().rev().collect();
        prop_assert_eq!(v, reversed_twice);
    }
}
```

**ç‰¹ç‚¹**:

- éªŒè¯æ•°å­¦æ€§è´¨
- è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•æ•°æ®
- å‘ç°é€šç”¨è§„å¾‹

---

### Test Coverage (æµ‹è¯•è¦†ç›–ç‡)

ä»£ç è¢«æµ‹è¯•è¦†ç›–çš„ç™¾åˆ†æ¯”ï¼Œä½¿ç”¨ `tarpaulin` æˆ– `llvm-cov` æµ‹é‡ã€‚

```bash
cargo tarpaulin --out Html
cargo llvm-cov --html
```

**æŒ‡æ ‡**:

- è¡Œè¦†ç›–ç‡ (Line Coverage)
- åˆ†æ”¯è¦†ç›–ç‡ (Branch Coverage)
- å‡½æ•°è¦†ç›–ç‡ (Function Coverage)

---

## âŒ é”™è¯¯å¤„ç†æœ¯è¯­

### Result Type (Result ç±»å‹)

Rust çš„å¯æ¢å¤é”™è¯¯ç±»å‹ï¼ŒåŒ…å« `Ok(T)` å’Œ `Err(E)` ä¸¤ç§å˜ä½“ã€‚

```rust
fn divide(a: f64, b: f64) -> Result<f64, String> {
    if b == 0.0 {
        Err("Division by zero".to_string())
    } else {
        Ok(a / b)
    }
}
```

**ç‰¹ç‚¹**:

- å¼ºåˆ¶é”™è¯¯å¤„ç†
- ç±»å‹å®‰å…¨
- å¯ç»„åˆ

---

### Panic (ææ…Œ)

ä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œå¯¼è‡´ç¨‹åºç»ˆæ­¢æˆ–çº¿ç¨‹é€€å‡ºã€‚

```rust
panic!("Something went terribly wrong!");
```

**ä½¿ç”¨åœºæ™¯**:

- é€»è¾‘é”™è¯¯
- ä¸å¯æ¢å¤çš„é”™è¯¯
- æµ‹è¯•æ–­è¨€å¤±è´¥

---

### Error Propagation (é”™è¯¯ä¼ æ’­)

é€šè¿‡ `?` è¿ç®—ç¬¦å‘ä¸Šå±‚ä¼ é€’é”™è¯¯ã€‚

```rust
fn read_file() -> Result<String, std::io::Error> {
    let content = std::fs::read_to_string("file.txt")?;
    Ok(content)
}
```

**ä¼˜åŠ¿**:

- ç®€æ´è¯­æ³•
- è‡ªåŠ¨ç±»å‹è½¬æ¢
- ä¿æŒé”™è¯¯ä¸Šä¸‹æ–‡

---

### Error Chain (é”™è¯¯é“¾)

ä¿ç•™é”™è¯¯çš„åŸå§‹ä¸Šä¸‹æ–‡å’Œè°ƒç”¨é“¾ã€‚

```rust
use anyhow::{Context, Result};

fn process() -> Result<()> {
    read_config()
        .context("Failed to read config")?;
    Ok(())
}
```

**ç‰¹ç‚¹**:

- ä¿ç•™é”™è¯¯å†å²
- ä¾¿äºè°ƒè¯•
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

---

### Custom Error Type (è‡ªå®šä¹‰é”™è¯¯ç±»å‹)

ä½¿ç”¨ `thiserror` æˆ–æ‰‹åŠ¨å®ç° `std::error::Error`ã€‚

```rust
use thiserror::Error;

#[derive(Error, Debug)]
pub enum MyError {
    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),
    
    #[error("Parse error: {0}")]
    Parse(String),
}
```

**ä¼˜åŠ¿**:

- ç±»å‹å®‰å…¨
- ä¸°å¯Œçš„é”™è¯¯ä¿¡æ¯
- ä¾¿äºé”™è¯¯åˆ†ç±»

---

## ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§æœ¯è¯­

### Logging (æ—¥å¿—è®°å½•)

è®°å½•ç¨‹åºè¿è¡Œæ—¶çš„äº‹ä»¶å’ŒçŠ¶æ€ã€‚

```rust
use tracing::{info, warn, error};

info!("Server started");
warn!("High memory usage: {}MB", mem);
error!("Database connection failed");
```

**æ—¥å¿—çº§åˆ«**:

- TRACE: æœ€è¯¦ç»†
- DEBUG: è°ƒè¯•ä¿¡æ¯
- INFO: ä¸€èˆ¬ä¿¡æ¯
- WARN: è­¦å‘Š
- ERROR: é”™è¯¯

---

### Metrics (æŒ‡æ ‡)

é‡åŒ–çš„æ€§èƒ½å’ŒçŠ¶æ€æ•°æ®ï¼Œé€šå¸¸ç”¨äº Prometheusã€‚

```rust
use prometheus::{Counter, Histogram, Gauge};

let requests_total = Counter::new("requests_total", "Total requests")?;
let response_time = Histogram::new("response_time", "Response time")?;
let active_connections = Gauge::new("active_connections", "Active connections")?;
```

**å¸¸è§æŒ‡æ ‡ç±»å‹**:

- Counter: åªå¢ä¸å‡çš„è®¡æ•°å™¨
- Gauge: å¯å¢å¯å‡çš„ä»ªè¡¨
- Histogram: åˆ†å¸ƒç»Ÿè®¡

---

### Tracing (è¿½è¸ª)

åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¯·æ±‚çš„å®Œæ•´è·¯å¾„è·Ÿè¸ªã€‚

```rust
use tracing::{span, instrument};

#[instrument]
async fn process_request(id: u64) {
    let span = span!(tracing::Level::INFO, "database_query");
    let _enter = span.enter();
    // æ•°æ®åº“æŸ¥è¯¢...
}
```

**ç‰¹ç‚¹**:

- è·¨æœåŠ¡è¿½è¸ª
- å¯è§†åŒ–è°ƒç”¨é“¾
- æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

---

### Observability (å¯è§‚æµ‹æ€§)

ç³»ç»Ÿé€šè¿‡æ—¥å¿—ã€æŒ‡æ ‡ã€è¿½è¸ªæ¥æš´éœ²å†…éƒ¨çŠ¶æ€çš„èƒ½åŠ›ã€‚

**ä¸‰å¤§æ”¯æŸ±**:

1. **Logs**: ç¦»æ•£äº‹ä»¶
2. **Metrics**: èšåˆæ•°æ®
3. **Traces**: è¯·æ±‚è·¯å¾„

---

### SLI/SLO/SLA

- **SLI (Service Level Indicator)**: æœåŠ¡æ°´å¹³æŒ‡æ ‡
- **SLO (Service Level Objective)**: æœåŠ¡æ°´å¹³ç›®æ ‡
- **SLA (Service Level Agreement)**: æœåŠ¡æ°´å¹³åè®®

```rust
// ç¤ºä¾‹ï¼š99.9% å¯ç”¨æ€§ SLO
const AVAILABILITY_SLO: f64 = 0.999;
```

---

## ğŸ”„ æ•…éšœæ¢å¤æœ¯è¯­

### Timeout (è¶…æ—¶)

é™åˆ¶æ“ä½œçš„æœ€é•¿æ‰§è¡Œæ—¶é—´ã€‚

```rust
use tokio::time::{timeout, Duration};

let result = timeout(Duration::from_secs(5), long_operation()).await;
```

**ç›®çš„**:

- é˜²æ­¢æ— é™ç­‰å¾…
- å¿«é€Ÿå¤±è´¥
- èµ„æºé‡Šæ”¾

---

### Retry (é‡è¯•)

å¤±è´¥åé‡æ–°å°è¯•æ“ä½œã€‚

```rust
for attempt in 1..=3 {
    match try_operation().await {
        Ok(result) => return Ok(result),
        Err(e) if attempt < 3 => continue,
        Err(e) => return Err(e),
    }
}
```

**ç­–ç•¥**:

- å›ºå®šå»¶è¿Ÿ
- æŒ‡æ•°é€€é¿
- æŠ–åŠ¨ (Jitter)

---

### Circuit Breaker (æ–­è·¯å™¨)

é˜²æ­¢çº§è”æ•…éšœçš„ä¿æŠ¤æœºåˆ¶ã€‚

**çŠ¶æ€**:

- **Closed**: æ­£å¸¸è¿è¡Œ
- **Open**: æ•…éšœæ‰“å¼€ï¼Œå¿«é€Ÿå¤±è´¥
- **Half-Open**: å°è¯•æ¢å¤

---

### Bulkhead (èˆ±å£)

éš”ç¦»èµ„æºï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£ã€‚

```rust
let pool = ThreadPool::new(4); // é™åˆ¶çº¿ç¨‹æ•°
```

**ç›®çš„**:

- èµ„æºéš”ç¦»
- æ•…éšœéš”ç¦»
- é˜²æ­¢èµ„æºè€—å°½

---

### Graceful Degradation (ä¼˜é›…é™çº§)

åŠŸèƒ½éƒ¨åˆ†å¤±æ•ˆæ—¶æä¾›é™çº§æœåŠ¡ã€‚

```rust
async fn get_data() -> Result<Data> {
    match fetch_from_cache().await {
        Ok(data) => Ok(data),
        Err(_) => fetch_from_database().await, // é™çº§åˆ°æ•°æ®åº“
    }
}
```

---

### Graceful Shutdown (ä¼˜é›…å…³æœº)

åœ¨åœæ­¢æœåŠ¡å‰å®Œæˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ã€‚

```rust
tokio::select! {
    _ = server.run() => {},
    _ = shutdown_signal() => {
        // æ¸…ç†èµ„æº
        server.graceful_shutdown().await;
    }
}
```

---

## ğŸ“ˆ æ€§èƒ½ç›¸å…³æœ¯è¯­

### Latency (å»¶è¿Ÿ)

è¯·æ±‚ä»å‘å‡ºåˆ°æ”¶åˆ°å“åº”çš„æ—¶é—´ã€‚

**æŒ‡æ ‡**:

- P50: ä¸­ä½æ•°
- P95: 95% è¯·æ±‚çš„å»¶è¿Ÿ
- P99: 99% è¯·æ±‚çš„å»¶è¿Ÿ

---

### Throughput (ååé‡)

å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚

```rust
// requests per second (RPS)
let rps = total_requests / duration_seconds;
```

---

### Profiling (æ€§èƒ½å‰–æ)

åˆ†æç¨‹åºæ€§èƒ½ç“¶é¢ˆçš„è¿‡ç¨‹ã€‚

**å·¥å…·**:

- `perf`: Linux æ€§èƒ½åˆ†æ
- `flamegraph`: ç«ç„°å›¾å¯è§†åŒ–
- `criterion`: åŸºå‡†æµ‹è¯•

---

## ğŸ—ï¸ æ¶æ„æ¨¡å¼æœ¯è¯­

### High Availability (é«˜å¯ç”¨)

ç³»ç»ŸæŒç»­å¯ç”¨çš„èƒ½åŠ›ï¼Œé€šå¸¸ç”¨"å‡ ä¸ª9"è¡¨ç¤ºã€‚

- 99% = å¹´åœæœº 3.65 å¤©
- 99.9% = å¹´åœæœº 8.76 å°æ—¶
- 99.99% = å¹´åœæœº 52.56 åˆ†é’Ÿ

---

### Fault Tolerance (å®¹é”™)

ç³»ç»Ÿåœ¨éƒ¨åˆ†ç»„ä»¶æ•…éšœæ—¶ç»§ç»­è¿è¡Œçš„èƒ½åŠ›ã€‚

**æŠ€æœ¯**:

- å†—ä½™
- ä¸»å¤‡åˆ‡æ¢
- æ•°æ®å¤åˆ¶

---

### Load Balancing (è´Ÿè½½å‡è¡¡)

å°†è¯·æ±‚åˆ†é…åˆ°å¤šä¸ªæœåŠ¡å®ä¾‹ã€‚

**ç®—æ³•**:

- Round Robin
- Least Connections
- IP Hash

---

### Chaos Engineering (æ··æ²Œå·¥ç¨‹)

ä¸»åŠ¨æ³¨å…¥æ•…éšœä»¥æµ‹è¯•ç³»ç»ŸéŸ§æ€§ã€‚

```rust
// æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
async fn inject_latency() {
    if rand::random::<f64>() < 0.1 { // 10% æ¦‚ç‡
        sleep(Duration::from_millis(500)).await;
    }
}
```

---

**ä¸Šä¸€æ­¥**: [ä¸»ç´¢å¼•å¯¼èˆª](./02_ä¸»ç´¢å¼•å¯¼èˆª.md)  
**ä¸‹ä¸€æ­¥**: [å¸¸è§é—®é¢˜](./04_å¸¸è§é—®é¢˜.md)
