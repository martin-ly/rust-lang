# C13 Reliability - Tier 2: éƒ¨ç½²å®è·µæŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
> **æœ€åæ›´æ–°**: 2025-10-23  
> **Rust ç‰ˆæœ¬**: 1.90+  
> **é¢„è®¡é˜…è¯»**: 35 åˆ†é’Ÿ

---

## ğŸ“‹ ç›®å½•

- [C13 Reliability - Tier 2: éƒ¨ç½²å®è·µæŒ‡å—](#c13-reliability---tier-2-éƒ¨ç½²å®è·µæŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ„å»ºä¼˜åŒ–](#1-æ„å»ºä¼˜åŒ–)
    - [1.1 Release æ„å»º](#11-release-æ„å»º)
    - [1.2 äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–](#12-äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–)
    - [1.3 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–](#13-ç¼–è¯‘æ—¶é—´ä¼˜åŒ–)
  - [2. Docker å®¹å™¨åŒ–](#2-docker-å®¹å™¨åŒ–)
    - [2.1 å¤šé˜¶æ®µæ„å»º](#21-å¤šé˜¶æ®µæ„å»º)
    - [2.2 æœ€å°åŒ–é•œåƒ](#22-æœ€å°åŒ–é•œåƒ)
    - [2.3 å®‰å…¨åŠ å›º](#23-å®‰å…¨åŠ å›º)
  - [3. Kubernetes éƒ¨ç½²](#3-kubernetes-éƒ¨ç½²)
    - [3.1 Deployment é…ç½®](#31-deployment-é…ç½®)
    - [3.2 Service ä¸ Ingress](#32-service-ä¸-ingress)
    - [3.3 æ»šåŠ¨æ›´æ–°](#33-æ»šåŠ¨æ›´æ–°)
  - [4. é…ç½®ç®¡ç†](#4-é…ç½®ç®¡ç†)
    - [4.1 ç¯å¢ƒå˜é‡](#41-ç¯å¢ƒå˜é‡)
    - [4.2 é…ç½®æ–‡ä»¶](#42-é…ç½®æ–‡ä»¶)
    - [4.3 Secret ç®¡ç†](#43-secret-ç®¡ç†)
  - [5. æ—¥å¿—ä¸ç›‘æ§](#5-æ—¥å¿—ä¸ç›‘æ§)
    - [5.1 æ—¥å¿—æ”¶é›†](#51-æ—¥å¿—æ”¶é›†)
    - [5.2 æŒ‡æ ‡æš´éœ²](#52-æŒ‡æ ‡æš´éœ²)
    - [5.3 å¥åº·æ£€æŸ¥](#53-å¥åº·æ£€æŸ¥)
  - [6. å¼¹æ€§ä¼¸ç¼©](#6-å¼¹æ€§ä¼¸ç¼©)
    - [6.1 HPA æ°´å¹³æ‰©å±•](#61-hpa-æ°´å¹³æ‰©å±•)
    - [6.2 VPA å‚ç›´æ‰©å±•](#62-vpa-å‚ç›´æ‰©å±•)
    - [6.3 èµ„æºé™åˆ¶](#63-èµ„æºé™åˆ¶)
  - [7. å®æˆ˜æ¡ˆä¾‹](#7-å®æˆ˜æ¡ˆä¾‹)
    - [7.1 å®Œæ•´éƒ¨ç½²æµç¨‹](#71-å®Œæ•´éƒ¨ç½²æµç¨‹)
    - [7.2 è“ç»¿éƒ¨ç½²](#72-è“ç»¿éƒ¨ç½²)
    - [7.3 é‡‘ä¸é›€å‘å¸ƒ](#73-é‡‘ä¸é›€å‘å¸ƒ)
  - [8. æ€»ç»“](#8-æ€»ç»“)
    - [æ ¸å¿ƒè¦ç‚¹](#æ ¸å¿ƒè¦ç‚¹)
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)

---

## 1. æ„å»ºä¼˜åŒ–

### 1.1 Release æ„å»º

```toml
# Cargo.toml
[profile.release]
# ä¼˜åŒ–çº§åˆ«
opt-level = 3           # æœ€å¤§ä¼˜åŒ– (0-3, s, z)

# é“¾æ¥æ—¶ä¼˜åŒ–
lto = "fat"             # LTO: off | thin | fat
codegen-units = 1       # å•ä¸ªç¼–è¯‘å•å…ƒï¼Œæœ€å¤§ä¼˜åŒ–

# è°ƒè¯•ç¬¦å·
debug = false           # ç¦ç”¨è°ƒè¯•ç¬¦å·
strip = true            # å‰¥ç¦»ç¬¦å·è¡¨

# Panic è¡Œä¸º
panic = "abort"         # abort è€Œé unwindï¼Œå‡å°äºŒè¿›åˆ¶å¤§å°
```

**æ„å»ºå‘½ä»¤**:

```bash
# æ ‡å‡† release æ„å»º
cargo build --release

# é’ˆå¯¹ç‰¹å®š CPU ä¼˜åŒ–
RUSTFLAGS="-C target-cpu=native" cargo build --release

# å¯ç”¨é“¾æ¥æ—¶ä¼˜åŒ–
cargo build --release --config profile.release.lto=true
```

### 1.2 äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–

```toml
# Cargo.toml
[profile.release]
opt-level = "z"     # ä¼˜åŒ–äºŒè¿›åˆ¶å¤§å°
lto = true
codegen-units = 1
panic = "abort"
strip = true
```

**é¢å¤–ä¼˜åŒ–**:

```bash
# ä½¿ç”¨ upx å‹ç¼©ï¼ˆå¯é€‰ï¼‰
upx --best --lzma target/release/my_app

# æ£€æŸ¥äºŒè¿›åˆ¶å¤§å°
ls -lh target/release/my_app

# åˆ†æäºŒè¿›åˆ¶ç»„æˆ
cargo bloat --release
cargo bloat --release --crates
```

### 1.3 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–

```toml
# .cargo/config.toml
[build]
incremental = true      # å¢é‡ç¼–è¯‘
pipelining = true       # æµæ°´çº¿ç¼–è¯‘

[profile.dev]
opt-level = 1           # å¼€å‘æ—¶è½»é‡ä¼˜åŒ–
```

**å¹¶è¡Œæ„å»º**:

```bash
# ä½¿ç”¨ mold é“¾æ¥å™¨ï¼ˆLinuxï¼‰
cargo install -f mold
RUSTFLAGS="-C link-arg=-fuse-ld=mold" cargo build --release

# ä½¿ç”¨ sccache ç¼“å­˜
cargo install sccache
export RUSTC_WRAPPER=sccache
cargo build --release
```

---

## 2. Docker å®¹å™¨åŒ–

### 2.1 å¤šé˜¶æ®µæ„å»º

```dockerfile
# Dockerfile
# é˜¶æ®µ1: æ„å»º
FROM rust:1.90-slim as builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY Cargo.toml Cargo.lock ./

# æ„å»ºä¾èµ–ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰
RUN mkdir src && \
    echo "fn main() {}" > src/main.rs && \
    cargo build --release && \
    rm -rf src

# å¤åˆ¶æºä»£ç 
COPY src ./src

# æ„å»ºåº”ç”¨
RUN cargo build --release

# é˜¶æ®µ2: è¿è¡Œæ—¶
FROM debian:bookworm-slim

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# åˆ›å»ºé root ç”¨æˆ·
RUN useradd -m -u 1000 appuser

WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶
COPY --from=builder /app/target/release/my_app /app/my_app

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨åº”ç”¨
CMD ["/app/my_app"]
```

### 2.2 æœ€å°åŒ–é•œåƒ

**ä½¿ç”¨ distroless**:

```dockerfile
# Dockerfile.distroless
FROM rust:1.90-slim as builder
WORKDIR /app
COPY . .
RUN cargo build --release

# ä½¿ç”¨ Google çš„ distroless é•œåƒ
FROM gcr.io/distroless/cc-debian12

COPY --from=builder /app/target/release/my_app /app/my_app

USER nonroot:nonroot

ENTRYPOINT ["/app/my_app"]
```

**ä½¿ç”¨ Alpine** (å¦‚æœå…¼å®¹):

```dockerfile
# Dockerfile.alpine
FROM rust:1.90-alpine as builder

# å®‰è£… musl å·¥å…·é“¾
RUN apk add --no-cache musl-dev

WORKDIR /app
COPY . .

# æ„å»ºé™æ€é“¾æ¥äºŒè¿›åˆ¶
RUN cargo build --release --target x86_64-unknown-linux-musl

FROM alpine:latest

RUN apk add --no-cache ca-certificates

COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/my_app /app/my_app

USER 1000:1000

ENTRYPOINT ["/app/my_app"]
```

### 2.3 å®‰å…¨åŠ å›º

```dockerfile
# Dockerfile.secure
FROM rust:1.90-slim as builder
WORKDIR /app
COPY . .
RUN cargo build --release && \
    cargo audit

FROM gcr.io/distroless/cc-debian12

# æ·»åŠ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD ["/app/my_app", "--health-check"]

# åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
# VOLUME ["/tmp"]

COPY --from=builder /app/target/release/my_app /app/my_app

USER 65534:65534

ENTRYPOINT ["/app/my_app"]
```

---

## 3. Kubernetes éƒ¨ç½²

### 3.1 Deployment é…ç½®

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rust-app
  labels:
    app: rust-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rust-app
  template:
    metadata:
      labels:
        app: rust-app
    spec:
      containers:
      - name: rust-app
        image: myregistry/rust-app:v1.0.0
        ports:
        - containerPort: 8080
          name: http
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /health/liveness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health/readiness
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: RUST_LOG
          value: "info"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: database-url
        
        # æŒ‚è½½é…ç½®
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
      
      volumes:
      - name: config
        configMap:
          name: rust-app-config
```

### 3.2 Service ä¸ Ingress

```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: rust-app
spec:
  selector:
    app: rust-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP

---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rust-app
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
spec:
  tls:
  - hosts:
    - api.example.com
    secretName: rust-app-tls
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rust-app
            port:
              number: 80
```

### 3.3 æ»šåŠ¨æ›´æ–°

```yaml
# deployment.yaml (æ»šåŠ¨æ›´æ–°ç­–ç•¥)
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # æœ€å¤šé¢å¤–å¯åŠ¨ 1 ä¸ª Pod
      maxUnavailable: 1  # æœ€å¤š 1 ä¸ª Pod ä¸å¯ç”¨
```

**æ›´æ–°å‘½ä»¤**:

```bash
# æ›´æ–°é•œåƒ
kubectl set image deployment/rust-app rust-app=myregistry/rust-app:v1.1.0

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/rust-app

# å›æ»šæ›´æ–°
kubectl rollout undo deployment/rust-app

# æŸ¥çœ‹å†å²
kubectl rollout history deployment/rust-app
```

---

## 4. é…ç½®ç®¡ç†

### 4.1 ç¯å¢ƒå˜é‡

```rust
use std::env;

fn load_config_from_env() -> Config {
    Config {
        database_url: env::var("DATABASE_URL")
            .expect("DATABASE_URL must be set"),
        
        redis_url: env::var("REDIS_URL")
            .expect("REDIS_URL must be set"),
        
        log_level: env::var("RUST_LOG")
            .unwrap_or_else(|_| "info".to_string()),
        
        port: env::var("PORT")
            .unwrap_or_else(|_| "8080".to_string())
            .parse()
            .expect("PORT must be a number"),
    }
}

struct Config {
    database_url: String,
    redis_url: String,
    log_level: String,
    port: u16,
}
```

### 4.2 é…ç½®æ–‡ä»¶

```rust
use serde::Deserialize;
use config::{Config, File, Environment};

#[derive(Debug, Deserialize)]
struct AppConfig {
    server: ServerConfig,
    database: DatabaseConfig,
    redis: RedisConfig,
}

#[derive(Debug, Deserialize)]
struct ServerConfig {
    host: String,
    port: u16,
}

#[derive(Debug, Deserialize)]
struct DatabaseConfig {
    url: String,
    max_connections: u32,
}

#[derive(Debug, Deserialize)]
struct RedisConfig {
    url: String,
    pool_size: u32,
}

fn load_config() -> Result<AppConfig, config::ConfigError> {
    let config = Config::builder()
        // é»˜è®¤é…ç½®
        .add_source(File::with_name("config/default"))
        
        // ç¯å¢ƒç‰¹å®šé…ç½®
        .add_source(
            File::with_name(&format!("config/{}", env::var("RUN_ENV").unwrap_or_else(|_| "dev".into())))
                .required(false)
        )
        
        // ç¯å¢ƒå˜é‡è¦†ç›– (å‰ç¼€ APP_)
        .add_source(Environment::with_prefix("APP").separator("__"))
        
        .build()?;
    
    config.try_deserialize()
}
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹** (`config/default.toml`):

```toml
[server]
host = "0.0.0.0"
port = 8080

[database]
url = "postgres://localhost/mydb"
max_connections = 20

[redis]
url = "redis://localhost:6379"
pool_size = 10
```

### 4.3 Secret ç®¡ç†

```yaml
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
stringData:
  database-url: "postgres://user:pass@db:5432/mydb"
  redis-url: "redis://:password@redis:6379"
  api-key: "secret-api-key-12345"
```

**ä» Secret è¯»å–** (Rust):

```rust
use std::fs;

fn load_secret(path: &str) -> Result<String, std::io::Error> {
    fs::read_to_string(path)
        .map(|s| s.trim().to_string())
}

fn init_with_secrets() -> Result<Config, Box<dyn std::error::Error>> {
    let database_url = load_secret("/var/secrets/database-url")?;
    let redis_url = load_secret("/var/secrets/redis-url")?;
    
    Ok(Config {
        database_url,
        redis_url,
    })
}

struct Config {
    database_url: String,
    redis_url: String,
}
```

---

## 5. æ—¥å¿—ä¸ç›‘æ§

### 5.1 æ—¥å¿—æ”¶é›†

```yaml
# deployment.yaml (æ—¥å¿—é…ç½®)
spec:
  template:
    spec:
      containers:
      - name: rust-app
        # æ—¥å¿—è¾“å‡ºåˆ° stdout/stderr
        env:
        - name: RUST_LOG
          value: "info"
        - name: LOG_FORMAT
          value: "json"  # JSON æ ¼å¼æ–¹ä¾¿è§£æ
```

**Fluentd/Fluent Bit æ”¶é›†**:

```yaml
# fluent-bit-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush        1
        Log_Level    info
    
    [INPUT]
        Name              tail
        Path              /var/log/containers/*rust-app*.log
        Parser            docker
        Tag               kube.*
    
    [OUTPUT]
        Name  es
        Match *
        Host  elasticsearch
        Port  9200
        Index kubernetes
```

### 5.2 æŒ‡æ ‡æš´éœ²

```yaml
# deployment.yaml (Prometheus æ³¨è§£)
metadata:
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
```

**ServiceMonitor** (Prometheus Operator):

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rust-app
spec:
  selector:
    matchLabels:
      app: rust-app
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

### 5.3 å¥åº·æ£€æŸ¥

```rust
use axum::{Router, routing::get, http::StatusCode};

async fn liveness() -> StatusCode {
    StatusCode::OK
}

async fn readiness() -> Result<StatusCode, StatusCode> {
    if check_dependencies().await {
        Ok(StatusCode::OK)
    } else {
        Err(StatusCode::SERVICE_UNAVAILABLE)
    }
}

async fn check_dependencies() -> bool {
    // æ£€æŸ¥æ•°æ®åº“ã€ç¼“å­˜ç­‰ä¾èµ–
    true
}

fn health_routes() -> Router {
    Router::new()
        .route("/health/liveness", get(liveness))
        .route("/health/readiness", get(readiness))
}
```

---

## 6. å¼¹æ€§ä¼¸ç¼©

### 6.1 HPA æ°´å¹³æ‰©å±•

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: rust-app
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: rust-app
  minReplicas: 3
  maxReplicas: 10
  metrics:
  # CPU ä½¿ç”¨ç‡
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  
  # å†…å­˜ä½¿ç”¨ç‡
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  
  # è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "1000"
  
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 5åˆ†é’Ÿç¨³å®šæœŸ
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
```

### 6.2 VPA å‚ç›´æ‰©å±•

```yaml
# vpa.yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: rust-app
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: rust-app
  updatePolicy:
    updateMode: "Auto"  # Auto | Initial | Off
  resourcePolicy:
    containerPolicies:
    - containerName: rust-app
      minAllowed:
        memory: "128Mi"
        cpu: "100m"
      maxAllowed:
        memory: "2Gi"
        cpu: "2000m"
```

### 6.3 èµ„æºé™åˆ¶

```yaml
# deployment.yaml
spec:
  template:
    spec:
      containers:
      - name: rust-app
        resources:
          requests:
            memory: "256Mi"  # æœ€å°ä¿è¯
            cpu: "250m"
          limits:
            memory: "512Mi"  # æœ€å¤§é™åˆ¶
            cpu: "500m"
```

**QoS ç±»åˆ«**:

| ç±»åˆ« | æ¡ä»¶ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **Guaranteed** | requests == limits | æœ€é«˜ |
| **Burstable** | requests < limits | ä¸­ç­‰ |
| **BestEffort** | æ—  requests/limits | æœ€ä½ |

---

## 7. å®æˆ˜æ¡ˆä¾‹

### 7.1 å®Œæ•´éƒ¨ç½²æµç¨‹

```bash
#!/bin/bash
# deploy.sh

set -e

# 1. æ„å»ºé•œåƒ
docker build -t myregistry/rust-app:$VERSION .

# 2. æ¨é€é•œåƒ
docker push myregistry/rust-app:$VERSION

# 3. æ›´æ–° K8s é…ç½®
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secret.yaml
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml
kubectl apply -f k8s/ingress.yaml
kubectl apply -f k8s/hpa.yaml

# 4. ç­‰å¾…æ›´æ–°å®Œæˆ
kubectl rollout status deployment/rust-app --timeout=300s

# 5. éªŒè¯å¥åº·æ£€æŸ¥
kubectl run test --rm -it --image=curlimages/curl -- \
  curl -f http://rust-app/health/readiness || exit 1

echo "Deployment successful!"
```

### 7.2 è“ç»¿éƒ¨ç½²

```yaml
# blue-green-deployment.yaml
# Blue (å½“å‰ç”Ÿäº§ç‰ˆæœ¬)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rust-app-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rust-app
      version: blue
  template:
    metadata:
      labels:
        app: rust-app
        version: blue
    spec:
      containers:
      - name: rust-app
        image: myregistry/rust-app:v1.0.0

---
# Green (æ–°ç‰ˆæœ¬)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rust-app-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rust-app
      version: green
  template:
    metadata:
      labels:
        app: rust-app
        version: green
    spec:
      containers:
      - name: rust-app
        image: myregistry/rust-app:v1.1.0

---
# Service (åˆ‡æ¢ç‰ˆæœ¬)
apiVersion: v1
kind: Service
metadata:
  name: rust-app
spec:
  selector:
    app: rust-app
    version: blue  # åˆ‡æ¢åˆ° green å®ç°è“ç»¿åˆ‡æ¢
  ports:
  - port: 80
    targetPort: 8080
```

### 7.3 é‡‘ä¸é›€å‘å¸ƒ

```yaml
# canary-deployment.yaml
# Stable (ç¨³å®šç‰ˆæœ¬ - 90% æµé‡)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rust-app-stable
spec:
  replicas: 9
  selector:
    matchLabels:
      app: rust-app
      track: stable
  template:
    metadata:
      labels:
        app: rust-app
        track: stable
    spec:
      containers:
      - name: rust-app
        image: myregistry/rust-app:v1.0.0

---
# Canary (é‡‘ä¸é›€ç‰ˆæœ¬ - 10% æµé‡)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rust-app-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rust-app
      track: canary
  template:
    metadata:
      labels:
        app: rust-app
        track: canary
    spec:
      containers:
      - name: rust-app
        image: myregistry/rust-app:v1.1.0

---
# Service (ç»Ÿä¸€æµé‡å…¥å£)
apiVersion: v1
kind: Service
metadata:
  name: rust-app
spec:
  selector:
    app: rust-app  # åŒ¹é… stable å’Œ canary
  ports:
  - port: 80
    targetPort: 8080
```

---

## 8. æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ„å»ºä¼˜åŒ–**: ä½¿ç”¨ LTOã€å‰¥ç¦»ç¬¦å·ã€ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹
2. **å®¹å™¨åŒ–**: å¤šé˜¶æ®µæ„å»ºã€æœ€å°åŒ–é•œåƒã€å®‰å…¨åŠ å›º
3. **K8s éƒ¨ç½²**: Deployment + Service + Ingress + HPA
4. **é…ç½®ç®¡ç†**: ç¯å¢ƒå˜é‡ + ConfigMap + Secret
5. **å¯è§‚æµ‹æ€§**: æ—¥å¿— + æŒ‡æ ‡ + è¿½è¸ª + å¥åº·æ£€æŸ¥

### æœ€ä½³å®è·µ

| é˜¶æ®µ | æœ€ä½³å®è·µ | å·¥å…· |
|------|---------|------|
| **æ„å»º** | LTO + strip + panic=abort | Cargo profile |
| **é•œåƒ** | å¤šé˜¶æ®µæ„å»º + distroless | Docker |
| **éƒ¨ç½²** | æ»šåŠ¨æ›´æ–° + å¥åº·æ£€æŸ¥ | Kubernetes |
| **é…ç½®** | ConfigMap + Secret | K8s |
| **ç›‘æ§** | Prometheus + Grafana | metrics |
| **æ—¥å¿—** | JSON æ ¼å¼ + Fluentd | tracing |
| **æ‰©å±•** | HPA + VPA | K8s autoscaling |

**å¸¸è§é™·é˜±**:

- âŒ ä½¿ç”¨ debug æ„å»ºéƒ¨ç½²
- âŒ é•œåƒè¿‡å¤§ (>500MB)
- âŒ æ²¡æœ‰èµ„æºé™åˆ¶
- âŒ ç¼ºå°‘å¥åº·æ£€æŸ¥
- âŒ é…ç½®ç¡¬ç¼–ç 
- âœ… ä½¿ç”¨ release æ„å»º
- âœ… å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒ
- âœ… è®¾ç½®åˆç†çš„ requests/limits
- âœ… å®ç° liveness/readiness æ¢é’ˆ
- âœ… ä½¿ç”¨ ConfigMap/Secret

---

## ğŸ“š å‚è€ƒèµ„æº

**å·¥å…·**:

- [Docker](https://docs.docker.com/) - å®¹å™¨åŒ–
- [Kubernetes](https://kubernetes.io/docs/) - å®¹å™¨ç¼–æ’
- [Helm](https://helm.sh/) - K8s åŒ…ç®¡ç†å™¨
- [cargo-audit](https://crates.io/crates/cargo-audit) - å®‰å…¨å®¡è®¡

**ç›¸å…³æ–‡æ¡£**:

- [Tier 2: é”™è¯¯å¤„ç†æŒ‡å—](./01_é”™è¯¯å¤„ç†æŒ‡å—.md)
- [Tier 2: ç›‘æ§å¯è§‚æµ‹æ€§æŒ‡å—](./04_ç›‘æ§å¯è§‚æµ‹æ€§æŒ‡å—.md)
- [Tier 3: API å‚è€ƒ](../tier_03_references/)

---

**æ–‡æ¡£ç»´æŠ¤**: C13 Reliability Team  
**æœ€åå®¡æ ¸**: 2025-10-23  
**ä¸‹æ¬¡æ›´æ–°**: 2026-01-23
