# å®åŸºç¡€ç†è®º

> **æ–‡æ¡£å®šä½**: Rustå®ç³»ç»Ÿçš„åŸºç¡€æ¦‚å¿µå’ŒåŸç†  
> **éš¾åº¦çº§åˆ«**: â­ å…¥é—¨  
> **é¢„è®¡æ—¶é—´**: 2å°æ—¶  
> **æœ€åæ›´æ–°**: 2025-10-20

---

## ğŸ“‹ ç›®å½•

- [å®åŸºç¡€ç†è®º](#å®åŸºç¡€ç†è®º)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ å­¦ä¹ ç›®æ ‡](#-å­¦ä¹ ç›®æ ‡)
  - [1. ä»€ä¹ˆæ˜¯å®ï¼Ÿ](#1-ä»€ä¹ˆæ˜¯å®)
    - [1.1 åŸºæœ¬æ¦‚å¿µ](#11-åŸºæœ¬æ¦‚å¿µ)
    - [1.2 å…³é”®ç‰¹æ€§](#12-å…³é”®ç‰¹æ€§)
  - [2. ä¸ºä»€ä¹ˆéœ€è¦å®ï¼Ÿ](#2-ä¸ºä»€ä¹ˆéœ€è¦å®)
    - [2.1 å‡å°‘æ ·æ¿ä»£ç ](#21-å‡å°‘æ ·æ¿ä»£ç )
    - [2.2 é¢†åŸŸç‰¹å®šè¯­è¨€(DSL)](#22-é¢†åŸŸç‰¹å®šè¯­è¨€dsl)
    - [2.3 ç¼–è¯‘æœŸè®¡ç®—](#23-ç¼–è¯‘æœŸè®¡ç®—)
    - [2.4 è‡ªåŠ¨å®ç°Trait](#24-è‡ªåŠ¨å®ç°trait)
  - [3. å® vs å‡½æ•°](#3-å®-vs-å‡½æ•°)
    - [3.1 å¯¹æ¯”è¡¨](#31-å¯¹æ¯”è¡¨)
    - [3.2 è¯¦ç»†æ¯”è¾ƒ](#32-è¯¦ç»†æ¯”è¾ƒ)
      - [æ‰§è¡Œæ—¶æœº](#æ‰§è¡Œæ—¶æœº)
      - [å‚æ•°çµæ´»æ€§](#å‚æ•°çµæ´»æ€§)
      - [å¯å˜å‚æ•°](#å¯å˜å‚æ•°)
  - [4. Rustä¸­çš„å®ç±»å‹](#4-rustä¸­çš„å®ç±»å‹)
    - [4.1 å£°æ˜å® (Declarative Macros)](#41-å£°æ˜å®-declarative-macros)
    - [4.2 è¿‡ç¨‹å® (Procedural Macros)](#42-è¿‡ç¨‹å®-procedural-macros)
      - [4.2.1 æ´¾ç”Ÿå® (Derive Macros)](#421-æ´¾ç”Ÿå®-derive-macros)
      - [4.2.2 å±æ€§å® (Attribute Macros)](#422-å±æ€§å®-attribute-macros)
      - [4.2.3 å‡½æ•°å¼å® (Function-like Macros)](#423-å‡½æ•°å¼å®-function-like-macros)
  - [5. å®çš„å·¥ä½œåŸç†](#5-å®çš„å·¥ä½œåŸç†)
    - [5.1 ç¼–è¯‘æµç¨‹](#51-ç¼–è¯‘æµç¨‹)
    - [5.2 å®å±•å¼€è¿‡ç¨‹](#52-å®å±•å¼€è¿‡ç¨‹)
    - [5.3 æŸ¥çœ‹å®å±•å¼€](#53-æŸ¥çœ‹å®å±•å¼€)
  - [6. åŸºæœ¬ä½¿ç”¨åœºæ™¯](#6-åŸºæœ¬ä½¿ç”¨åœºæ™¯)
    - [6.1 å˜é•¿å‚æ•°å‡½æ•°](#61-å˜é•¿å‚æ•°å‡½æ•°)
    - [6.2 åˆ›å»ºé›†åˆ](#62-åˆ›å»ºé›†åˆ)
    - [6.3 æ¡ä»¶ç¼–è¯‘](#63-æ¡ä»¶ç¼–è¯‘)
    - [6.4 è°ƒè¯•è¾…åŠ©](#64-è°ƒè¯•è¾…åŠ©)
  - [7. å®çš„ä¼˜åŠ¿](#7-å®çš„ä¼˜åŠ¿)
    - [7.1 æ€§èƒ½ä¼˜åŠ¿](#71-æ€§èƒ½ä¼˜åŠ¿)
    - [7.2 ç±»å‹çµæ´»æ€§](#72-ç±»å‹çµæ´»æ€§)
    - [7.3 å‡å°‘é‡å¤](#73-å‡å°‘é‡å¤)
  - [8. å®çš„é™åˆ¶](#8-å®çš„é™åˆ¶)
    - [8.1 è°ƒè¯•å›°éš¾](#81-è°ƒè¯•å›°éš¾)
    - [8.2 ç¼–è¯‘æ—¶é—´å¢åŠ ](#82-ç¼–è¯‘æ—¶é—´å¢åŠ )
    - [8.3 å«ç”Ÿæ€§é—®é¢˜](#83-å«ç”Ÿæ€§é—®é¢˜)
  - [9. ä½•æ—¶ä½¿ç”¨å®](#9-ä½•æ—¶ä½¿ç”¨å®)
    - [âœ… é€‚åˆä½¿ç”¨å®çš„åœºæ™¯](#-é€‚åˆä½¿ç”¨å®çš„åœºæ™¯)
    - [âŒ ä¸é€‚åˆä½¿ç”¨å®çš„åœºæ™¯](#-ä¸é€‚åˆä½¿ç”¨å®çš„åœºæ™¯)
  - [10. å®è·µç¤ºä¾‹](#10-å®è·µç¤ºä¾‹)
    - [ç¤ºä¾‹1: ç®€å•çš„æ‰“å°å®](#ç¤ºä¾‹1-ç®€å•çš„æ‰“å°å®)
    - [ç¤ºä¾‹2: åˆ›å»ºç»“æ„ä½“å®](#ç¤ºä¾‹2-åˆ›å»ºç»“æ„ä½“å®)
    - [ç¤ºä¾‹3: è®¡ç®—å®](#ç¤ºä¾‹3-è®¡ç®—å®)
  - [ğŸ“š æ€»ç»“](#-æ€»ç»“)
    - [å…³é”®è¦ç‚¹](#å…³é”®è¦ç‚¹)
    - [ä¸‹ä¸€æ­¥](#ä¸‹ä¸€æ­¥)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬ç« åï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… ç†è§£ä»€ä¹ˆæ˜¯å®ä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®
- âœ… åŒºåˆ†å®ä¸å‡½æ•°çš„å…³é”®å·®å¼‚
- âœ… äº†è§£Rustä¸­çš„ä¸¤ç§ä¸»è¦å®ç±»å‹
- âœ… ç†è§£å®çš„åŸºæœ¬å·¥ä½œåŸç†
- âœ… æŒæ¡å®çš„åŸºæœ¬ä½¿ç”¨åœºæ™¯

---

## 1. ä»€ä¹ˆæ˜¯å®ï¼Ÿ

### 1.1 åŸºæœ¬æ¦‚å¿µ

**å®(Macro)**æ˜¯ä¸€ç§**å…ƒç¼–ç¨‹**å·¥å…·ï¼Œå…è®¸åœ¨**ç¼–è¯‘æœŸ**ç”Ÿæˆä»£ç ã€‚

```rust
// å®è°ƒç”¨
println!("Hello, {}!", "world");

// åœ¨ç¼–è¯‘æœŸå±•å¼€ä¸ºç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š
{
    use std::io::{self, Write};
    match writeln!(io::stdout(), "Hello, {}!", "world") {
        Ok(_) => {},
        Err(_) => panic!("failed printing to stdout"),
    }
}
```

### 1.2 å…³é”®ç‰¹æ€§

1. **ç¼–è¯‘æœŸæ‰§è¡Œ** - å®åœ¨ç¼–è¯‘æ—¶å±•å¼€ï¼Œè¿è¡Œæ—¶é›¶å¼€é”€
2. **ä»£ç ç”Ÿæˆ** - å®å¯ä»¥ç”Ÿæˆä»»æ„åˆæ³•çš„Rustä»£ç 
3. **è¯­æ³•è½¬æ¢** - å®å¯ä»¥æ¥å—å¹¶è½¬æ¢ä»»æ„è¯­æ³•
4. **å¯å˜å‚æ•°** - å®å¯ä»¥æ¥å—ä»»æ„æ•°é‡å’Œç±»å‹çš„å‚æ•°

---

## 2. ä¸ºä»€ä¹ˆéœ€è¦å®ï¼Ÿ

### 2.1 å‡å°‘æ ·æ¿ä»£ç 

**é—®é¢˜**: é‡å¤çš„æ¨¡å¼éœ€è¦å¤šæ¬¡ç¼–å†™

```rust
// ä¸ä½¿ç”¨å® - é‡å¤ä»£ç 
struct Point2D { x: f64, y: f64 }
struct Point3D { x: f64, y: f64, z: f64 }
struct Point4D { x: f64, y: f64, z: f64, w: f64 }

// ä½¿ç”¨å® - è‡ªåŠ¨ç”Ÿæˆ
macro_rules! make_point {
    ($name:ident, $($field:ident),+) => {
        struct $name {
            $($field: f64),+
        }
    };
}

make_point!(Point2D, x, y);
make_point!(Point3D, x, y, z);
make_point!(Point4D, x, y, z, w);
```

### 2.2 é¢†åŸŸç‰¹å®šè¯­è¨€(DSL)

å®å¯ä»¥åˆ›å»ºæ›´ç›´è§‚çš„è¯­æ³•ï¼š

```rust
// HTML DSL
html! {
    <div class="container">
        <h1>"Welcome"</h1>
        <p>"Hello World"</p>
    </div>
}

// SQL DSL
let users = sql!("SELECT * FROM users WHERE id = ?", user_id);
```

### 2.3 ç¼–è¯‘æœŸè®¡ç®—

```rust
// ç¼–è¯‘æœŸè®¡ç®—æ•°ç»„å¤§å°
const SIZE: usize = compute_size!(1, 2, 3, 4, 5);  // ç»“æœ: 5
```

### 2.4 è‡ªåŠ¨å®ç°Trait

```rust
#[derive(Debug, Clone, PartialEq)]
struct User {
    name: String,
    age: u32,
}
// è‡ªåŠ¨ç”ŸæˆDebugã€Cloneã€PartialEqçš„å®ç°
```

---

## 3. å® vs å‡½æ•°

### 3.1 å¯¹æ¯”è¡¨

| ç‰¹æ€§ | å® | å‡½æ•° |
|------|-----|------|
| **æ‰§è¡Œæ—¶æœº** | ç¼–è¯‘æœŸ | è¿è¡Œæ—¶ |
| **å‚æ•°ç±»å‹** | ä»»æ„è¯­æ³• | å¿…é¡»ç±»å‹åŒ¹é… |
| **å‚æ•°æ•°é‡** | å¯å˜ | å›ºå®š |
| **è¿”å›å€¼** | ä»£ç  | å…·ä½“å€¼ |
| **ç±»å‹æ£€æŸ¥** | å±•å¼€åæ£€æŸ¥ | è°ƒç”¨æ—¶æ£€æŸ¥ |
| **æ€§èƒ½** | é›¶å¼€é”€ï¼ˆå†…è”ï¼‰ | å¯èƒ½æœ‰è°ƒç”¨å¼€é”€ |
| **è°ƒè¯•** | è¾ƒéš¾ | è¾ƒæ˜“ |

### 3.2 è¯¦ç»†æ¯”è¾ƒ

#### æ‰§è¡Œæ—¶æœº

```rust
// å‡½æ•° - è¿è¡Œæ—¶æ‰§è¡Œ
fn double(x: i32) -> i32 {
    x * 2
}
let result = double(5);  // è¿è¡Œæ—¶è®¡ç®—

// å® - ç¼–è¯‘æœŸå±•å¼€
macro_rules! double {
    ($x:expr) => { $x * 2 };
}
let result = double!(5);  // ç¼–è¯‘æœŸå±•å¼€ä¸º: let result = 5 * 2;
```

#### å‚æ•°çµæ´»æ€§

```rust
// å‡½æ•° - å‚æ•°å¿…é¡»ç±»å‹åŒ¹é…
fn print_number(x: i32) {
    println!("{}", x);
}
print_number(42);       // âœ…
// print_number("text"); // âŒ ç±»å‹é”™è¯¯

// å® - å¯æ¥å—ä»»æ„ç±»å‹
macro_rules! print_any {
    ($x:expr) => {
        println!("{}", $x);
    };
}
print_any!(42);      // âœ…
print_any!("text");  // âœ…
print_any!(3.14);    // âœ…
```

#### å¯å˜å‚æ•°

```rust
// å‡½æ•° - å‚æ•°æ•°é‡å›ºå®š
fn sum_two(a: i32, b: i32) -> i32 {
    a + b
}

// å® - å¯å˜æ•°é‡å‚æ•°
macro_rules! sum_all {
    ($($x:expr),+) => {
        { $($x)+* }
    };
}

sum_all!(1, 2);           // âœ…
sum_all!(1, 2, 3, 4, 5);  // âœ…
```

---

## 4. Rustä¸­çš„å®ç±»å‹

Rustæœ‰**ä¸¤å¤§ç±»**å®ï¼š

### 4.1 å£°æ˜å® (Declarative Macros)

ä½¿ç”¨`macro_rules!`å®šä¹‰ï¼Œé€šè¿‡æ¨¡å¼åŒ¹é…å·¥ä½œã€‚

```rust
macro_rules! say_hello {
    () => {
        println!("Hello!");
    };
    ($name:expr) => {
        println!("Hello, {}!", $name);
    };
}

say_hello!();           // è¾“å‡º: Hello!
say_hello!("Alice");    // è¾“å‡º: Hello, Alice!
```

**ç‰¹ç‚¹**:

- âœ… è¯­æ³•ç®€å•
- âœ… æ¨¡å¼åŒ¹é…å¼ºå¤§
- âœ… é€‚åˆå¤§å¤šæ•°åœºæ™¯

### 4.2 è¿‡ç¨‹å® (Procedural Macros)

ä½¿ç”¨Rustä»£ç å®ç°ï¼Œæœ‰ä¸‰ç§ç±»å‹ï¼š

#### 4.2.1 æ´¾ç”Ÿå® (Derive Macros)

```rust
#[derive(Debug, Clone)]
struct Point {
    x: i32,
    y: i32,
}
```

#### 4.2.2 å±æ€§å® (Attribute Macros)

```rust
#[route(GET, "/api/users")]
fn get_users() -> Response {
    // ...
}
```

#### 4.2.3 å‡½æ•°å¼å® (Function-like Macros)

```rust
let query = sql!("SELECT * FROM users WHERE id = ?");
```

**ç‰¹ç‚¹**:

- âœ… æ›´å¼ºå¤§å’Œçµæ´»
- âœ… å¯ä»¥æ“ä½œæŠ½è±¡è¯­æ³•æ ‘(AST)
- âœ… é€‚åˆå¤æ‚åœºæ™¯
- âŒ å®ç°è¾ƒå¤æ‚

---

## 5. å®çš„å·¥ä½œåŸç†

### 5.1 ç¼–è¯‘æµç¨‹

```text
æºä»£ç  
  â†“
è¯æ³•åˆ†æ (Lexing)
  â†“
è¯­æ³•åˆ†æ (Parsing)
  â†“
å®å±•å¼€ (Macro Expansion) â† å®åœ¨è¿™é‡Œå·¥ä½œ
  â†“
ç±»å‹æ£€æŸ¥
  â†“
ä»£ç ç”Ÿæˆ
  â†“
å¯æ‰§è¡Œæ–‡ä»¶
```

### 5.2 å®å±•å¼€è¿‡ç¨‹

```rust
// 1. åŸå§‹ä»£ç 
let v = vec![1, 2, 3];

// 2. å®å±•å¼€
let v = {
    let mut temp_vec = Vec::new();
    temp_vec.push(1);
    temp_vec.push(2);
    temp_vec.push(3);
    temp_vec
};

// 3. ç»§ç»­ç¼–è¯‘
```

### 5.3 æŸ¥çœ‹å®å±•å¼€

ä½¿ç”¨`cargo-expand`å·¥å…·ï¼š

```bash
cargo install cargo-expand
cargo expand
```

---

## 6. åŸºæœ¬ä½¿ç”¨åœºæ™¯

### 6.1 å˜é•¿å‚æ•°å‡½æ•°

```rust
macro_rules! print_all {
    ($($arg:expr),*) => {
        $(println!("{}", $arg);)*
    };
}

print_all!(1, 2, 3, 4, 5);
```

### 6.2 åˆ›å»ºé›†åˆ

```rust
// Vec
let v = vec![1, 2, 3, 4, 5];

// HashMap
let map = hashmap! {
    "key1" => "value1",
    "key2" => "value2",
};
```

### 6.3 æ¡ä»¶ç¼–è¯‘

```rust
macro_rules! platform_msg {
    () => {
        #[cfg(target_os = "windows")]
        println!("Running on Windows");
        
        #[cfg(target_os = "linux")]
        println!("Running on Linux");
    };
}
```

### 6.4 è°ƒè¯•è¾…åŠ©

```rust
macro_rules! debug_print {
    ($($arg:tt)*) => {
        #[cfg(debug_assertions)]
        eprintln!("[DEBUG] {}", format!($($arg)*));
    };
}

debug_print!("Value: {}", x);  // åªåœ¨debugæ¨¡å¼æ‰“å°
```

---

## 7. å®çš„ä¼˜åŠ¿

### 7.1 æ€§èƒ½ä¼˜åŠ¿

```rust
// å® - é›¶å¼€é”€
macro_rules! square {
    ($x:expr) => { $x * $x };
}
let result = square!(5);  // ç›´æ¥å±•å¼€ä¸º: 5 * 5

// vs å‡½æ•° - å¯èƒ½æœ‰è°ƒç”¨å¼€é”€
fn square(x: i32) -> i32 { x * x }
let result = square(5);   // éœ€è¦å‡½æ•°è°ƒç”¨
```

### 7.2 ç±»å‹çµæ´»æ€§

```rust
macro_rules! max {
    ($a:expr, $b:expr) => {
        if $a > $b { $a } else { $b }
    };
}

max!(1, 2);        // é€‚ç”¨äºi32
max!(1.5, 2.3);    // é€‚ç”¨äºf64
max!("a", "b");    // é€‚ç”¨äº&str
```

### 7.3 å‡å°‘é‡å¤

```rust
// è‡ªåŠ¨å®ç°å¤šä¸ªç±»å‹çš„ç›¸åŒé€»è¾‘
macro_rules! impl_display {
    ($($t:ty),*) => {
        $(
            impl std::fmt::Display for $t {
                fn fmt(&self, f: &mut std::fmt::Formatter) -> std::fmt::Result {
                    write!(f, "{:?}", self)
                }
            }
        )*
    };
}

impl_display!(Point, Line, Circle);
```

---

## 8. å®çš„é™åˆ¶

### 8.1 è°ƒè¯•å›°éš¾

```rust
// å®é”™è¯¯ä¿¡æ¯å¯èƒ½ä¸æ¸…æ™°
let v = vec![1, 2, 3,];  // å¤šä½™çš„é€—å·å¯èƒ½å¯¼è‡´æ··ä¹±çš„é”™è¯¯
```

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨`cargo expand`æŸ¥çœ‹å±•å¼€åçš„ä»£ç 

### 8.2 ç¼–è¯‘æ—¶é—´å¢åŠ 

```rust
// å¤æ‚çš„å®ä¼šæ˜¾è‘—å¢åŠ ç¼–è¯‘æ—¶é—´
macro_rules! complex_macro {
    // ... å¤§é‡é€’å½’å’Œæ¨¡å¼åŒ¹é…
}
```

### 8.3 å«ç”Ÿæ€§é—®é¢˜

```rust
// å®å¯èƒ½å¼•å…¥æ„å¤–çš„æ ‡è¯†ç¬¦å†²çªï¼ˆè™½ç„¶Rustçš„å®æ˜¯å«ç”Ÿçš„ï¼‰
macro_rules! define_x {
    () => { let x = 42; };
}
```

---

## 9. ä½•æ—¶ä½¿ç”¨å®

### âœ… é€‚åˆä½¿ç”¨å®çš„åœºæ™¯

- éœ€è¦ç”Ÿæˆé‡å¤çš„æ ·æ¿ä»£ç 
- éœ€è¦å¯å˜æ•°é‡çš„å‚æ•°
- éœ€è¦ç¼–è¯‘æœŸè®¡ç®—
- éœ€è¦è‡ªå®šä¹‰è¯­æ³•
- éœ€è¦å®ç°æ³›å‹traitï¼ˆå¦‚`Debug`ï¼‰

### âŒ ä¸é€‚åˆä½¿ç”¨å®çš„åœºæ™¯

- ç®€å•çš„ä»£ç å°è£…ï¼ˆç”¨å‡½æ•°ï¼‰
- è¿è¡Œæ—¶é€»è¾‘ï¼ˆç”¨å‡½æ•°ï¼‰
- éœ€è¦é¢‘ç¹è°ƒè¯•çš„ä»£ç 
- ç±»å‹ç³»ç»Ÿå¯ä»¥è§£å†³çš„é—®é¢˜ï¼ˆç”¨æ³›å‹ï¼‰

---

## 10. å®è·µç¤ºä¾‹

### ç¤ºä¾‹1: ç®€å•çš„æ‰“å°å®

```rust
macro_rules! info {
    ($msg:expr) => {
        println!("[INFO] {}", $msg);
    };
}

info!("Application started");
```

### ç¤ºä¾‹2: åˆ›å»ºç»“æ„ä½“å®

```rust
macro_rules! create_struct {
    ($name:ident { $($field:ident: $ty:ty),* }) => {
        struct $name {
            $($field: $ty),*
        }
    };
}

create_struct!(Person {
    name: String,
    age: u32
});
```

### ç¤ºä¾‹3: è®¡ç®—å®

```rust
macro_rules! calculate {
    ($e:expr) => {{
        let val = $e;
        println!("{} = {}", stringify!($e), val);
        val
    }};
}

let result = calculate!(2 + 3 * 4);  // è¾“å‡º: 2 + 3 * 4 = 14
```

---

## ğŸ“š æ€»ç»“

### å…³é”®è¦ç‚¹

1. **å®æ˜¯ç¼–è¯‘æœŸçš„ä»£ç ç”Ÿæˆå·¥å…·**
2. **å®ä¸æ˜¯å‡½æ•°**ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘æœŸå±•å¼€
3. **ä¸¤ç§ä¸»è¦ç±»å‹**: å£°æ˜å®(`macro_rules!`)å’Œè¿‡ç¨‹å®
4. **ä¸»è¦ç”¨é€”**: å‡å°‘é‡å¤ã€DSLã€è‡ªåŠ¨å®ç°trait
5. **æƒè¡¡è€ƒè™‘**: æ€§èƒ½vsè°ƒè¯•éš¾åº¦

### ä¸‹ä¸€æ­¥

- ğŸ“– å­¦ä¹  [å«ç”Ÿå®ä¸ä½œç”¨åŸŸ](./02_hygiene_and_scope.md)
- ğŸ“– å®è·µ [macro_rules!åŸºç¡€](../02_declarative/01_macro_rules_basics.md)
- ğŸ’» è¿è¡Œç¤ºä¾‹: `cargo run --example 01_macro_rules_basics`

---

## ğŸ”— ç›¸å…³èµ„æº

- [The Rust Book - Macros](https://doc.rust-lang.org/book/ch19-06-macros.html)
- [The Rust Reference - Macros](https://doc.rust-lang.org/reference/macros.html)
- [The Little Book of Rust Macros](https://veykril.github.io/tlborm/)

---

**ä½œè€…**: Rustå­¦ä¹ ç¤¾åŒº  
**æœ€åæ›´æ–°**: 2025-10-20  
**è®¸å¯**: MIT
