# C14 Macro System - Tier 2: 宏调试与测试

> **文档版本**: v1.0.0  
> **最后更新**: 2025-10-23  
> **Rust 版本**: 1.90+  
> **预计阅读**: 30 分钟

---


## 📊 目录

- [📋 目录](#目录)
- [1. 调试工具](#1-调试工具)
  - [1.1 cargo expand](#11-cargo-expand)
  - [1.2 println! 调试](#12-println-调试)
  - [1.3 IDE 支持](#13-ide-支持)
- [2. 宏展开](#2-宏展开)
  - [2.1 查看展开结果](#21-查看展开结果)
  - [2.2 部分展开](#22-部分展开)
- [3. 错误处理](#3-错误处理)
  - [3.1 编译错误](#31-编译错误)
  - [3.2 自定义错误消息](#32-自定义错误消息)
- [4. 测试策略](#4-测试策略)
  - [4.1 集成测试](#41-集成测试)
  - [4.2 编译失败测试](#42-编译失败测试)
  - [4.3 快照测试](#43-快照测试)
- [5. 实战案例](#5-实战案例)
  - [5.1 调试 Builder 宏](#51-调试-builder-宏)
  - [5.2 错误诊断](#52-错误诊断)
  - [5.3 性能测试](#53-性能测试)
- [6. 总结](#6-总结)
  - [核心要点](#核心要点)
  - [最佳实践](#最佳实践)
- [📚 参考资源](#参考资源)


## 📋 目录

- [C14 Macro System - Tier 2: 宏调试与测试](#c14-macro-system---tier-2-宏调试与测试)
  - [📋 目录](#-目录)
  - [1. 调试工具](#1-调试工具)
    - [1.1 cargo expand](#11-cargo-expand)
    - [1.2 println! 调试](#12-println-调试)
    - [1.3 IDE 支持](#13-ide-支持)
  - [2. 宏展开](#2-宏展开)
    - [2.1 查看展开结果](#21-查看展开结果)
    - [2.2 部分展开](#22-部分展开)
  - [3. 错误处理](#3-错误处理)
    - [3.1 编译错误](#31-编译错误)
    - [3.2 自定义错误消息](#32-自定义错误消息)
  - [4. 测试策略](#4-测试策略)
    - [4.1 集成测试](#41-集成测试)
    - [4.2 编译失败测试](#42-编译失败测试)
    - [4.3 快照测试](#43-快照测试)
  - [5. 实战案例](#5-实战案例)
    - [5.1 调试 Builder 宏](#51-调试-builder-宏)
    - [5.2 错误诊断](#52-错误诊断)
    - [5.3 性能测试](#53-性能测试)
  - [6. 总结](#6-总结)
    - [核心要点](#核心要点)
    - [最佳实践](#最佳实践)
  - [📚 参考资源](#-参考资源)

---

## 1. 调试工具

### 1.1 cargo expand

```bash
# 安装
cargo install cargo-expand

# 查看宏展开
cargo expand

# 展开特定模块
cargo expand module_name

# 展开特定函数
cargo expand function_name
```

### 1.2 println! 调试

```rust
#[proc_macro]
pub fn debug_macro(input: TokenStream) -> TokenStream {
    // 打印输入
    eprintln!("Input: {:?}", input);
    
    let output = process(input);
    
    // 打印输出
    eprintln!("Output: {:?}", output);
    
    output
}
```

### 1.3 IDE 支持

- **rust-analyzer**: 内联显示宏展开
- **IntelliJ RUST**: 宏展开和调试支持

---

## 2. 宏展开

### 2.1 查看展开结果

```rust
// 原始代码
#[derive(Debug, Clone)]
struct User {
    name: String,
    age: u32,
}

// 展开后 (cargo expand)
struct User {
    name: String,
    age: u32,
}

impl std::fmt::Debug for User {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("User")
            .field("name", &self.name)
            .field("age", &self.age)
            .finish()
    }
}

impl std::clone::Clone for User {
    fn clone(&self) -> Self {
        User {
            name: self.name.clone(),
            age: self.age.clone(),
        }
    }
}
```

### 2.2 部分展开

```bash
# 只展开特定宏
cargo expand --ugly  # 保留原始格式

# 展开到文件
cargo expand > expanded.rs
```

---

## 3. 错误处理

### 3.1 编译错误

```rust
use proc_macro::TokenStream;
use syn::Error;

#[proc_macro_derive(MyTrait)]
pub fn derive_my_trait(input: TokenStream) -> TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    
    // 检查是否为结构体
    match input.data {
        Data::Struct(_) => {},
        _ => {
            return Error::new_spanned(
                input,
                "MyTrait can only be derived for structs"
            ).to_compile_error().into();
        }
    }
    
    TokenStream::new()
}
```

### 3.2 自定义错误消息

```rust
#[proc_macro_derive(Builder)]
pub fn derive_builder(input: TokenStream) -> TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    
    let fields = match &input.data {
        Data::Struct(data) => {
            match &data.fields {
                Fields::Named(fields) => &fields.named,
                Fields::Unnamed(_) => {
                    return Error::new_spanned(
                        data,
                        "Builder derive does not support tuple structs.\n\
                         Use a struct with named fields instead:\n\
                         struct MyStruct {{ field: Type }}"
                    ).to_compile_error().into();
                }
                Fields::Unit => {
                    return Error::new_spanned(
                        data,
                        "Builder derive does not support unit structs"
                    ).to_compile_error().into();
                }
            }
        }
        _ => {
            return Error::new_spanned(
                input,
                "Builder can only be derived for structs"
            ).to_compile_error().into();
        }
    };
    
    TokenStream::new()
}
```

---

## 4. 测试策略

### 4.1 集成测试

```rust
// tests/integration_test.rs
use my_macros::*;

#[test]
fn test_derive_builder() {
    #[derive(Builder)]
    struct User {
        name: String,
        age: u32,
    }
    
    let user = User::builder()
        .name("Alice".to_string())
        .age(30)
        .build()
        .unwrap();
    
    assert_eq!(user.name, "Alice");
    assert_eq!(user.age, 30);
}
```

### 4.2 编译失败测试

```rust
// 使用 trybuild
#[test]
fn test_compile_fail() {
    let t = trybuild::TestCases::new();
    t.compile_fail("tests/ui/fail_*.rs");
}

// tests/ui/fail_unsupported_type.rs
use my_macros::Builder;

#[derive(Builder)]
enum MyEnum {  // 应该编译失败
    Variant,
}

fn main() {}
```

### 4.3 快照测试

```rust
#[test]
fn test_expansion() {
    let input = quote! {
        #[derive(Builder)]
        struct User {
            name: String,
        }
    };
    
    let expected = quote! {
        // 预期的展开结果
    };
    
    assert_eq!(
        derive_builder(input.into()).to_string(),
        expected.to_string()
    );
}
```

---

## 5. 实战案例

### 5.1 调试 Builder 宏

```rust
#[proc_macro_derive(Builder)]
pub fn derive_builder(input: TokenStream) -> TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    
    // 调试：打印结构体名称
    eprintln!("Processing struct: {}", input.ident);
    
    let fields = match &input.data {
        Data::Struct(data) => {
            match &data.fields {
                Fields::Named(fields) => {
                    // 调试：打印字段数量
                    eprintln!("Found {} fields", fields.named.len());
                    &fields.named
                }
                _ => panic!("Only named fields supported"),
            }
        }
        _ => panic!("Only structs supported"),
    };
    
    // 调试：打印每个字段
    for field in fields {
        eprintln!("Field: {:?}", field.ident);
    }
    
    TokenStream::new()
}
```

### 5.2 错误诊断

```rust
#[proc_macro_attribute]
pub fn route(attr: TokenStream, item: TokenStream) -> TokenStream {
    let args = parse_macro_input!(attr as AttributeArgs);
    let input = parse_macro_input!(item as ItemFn);
    
    // 验证参数数量
    if args.is_empty() {
        return Error::new_spanned(
            &input.sig.ident,
            "route attribute requires at least one argument: method and path\n\
             Example: #[route(\"GET\", \"/users\")]"
        ).to_compile_error().into();
    }
    
    if args.len() > 2 {
        return Error::new_spanned(
            &input.sig.ident,
            "route attribute takes at most 2 arguments: method and path"
        ).to_compile_error().into();
    }
    
    TokenStream::new()
}
```

### 5.3 性能测试

```rust
#[test]
fn bench_macro_expansion() {
    use std::time::Instant;
    
    let input = quote! {
        #[derive(Builder)]
        struct LargeStruct {
            field1: String,
            field2: i32,
            // ... 100 个字段
        }
    };
    
    let start = Instant::now();
    let _ = derive_builder(input.into());
    let duration = start.elapsed();
    
    assert!(duration.as_millis() < 100, "Macro expansion took too long");
}
```

---

## 6. 总结

### 核心要点

1. **cargo expand**: 查看宏展开结果
2. **错误处理**: 使用 `syn::Error` 提供清晰错误
3. **测试**: 集成测试 + 编译失败测试
4. **调试**: `eprintln!` + IDE 支持
5. **性能**: 避免生成过多代码

### 最佳实践

| 场景 | 推荐做法 |
|------|---------|
| **调试** | 使用 `cargo expand` |
| **错误** | 提供清晰的错误信息和建议 |
| **测试** | 使用 `trybuild` 测试编译失败 |
| **性能** | 避免递归生成代码 |
| **文档** | 添加 `#[doc]` 属性 |

**常见陷阱**:

- ❌ 错误信息不清晰
- ❌ 缺少测试
- ❌ 生成的代码不符合预期
- ❌ 性能问题
- ✅ 提供有用的错误信息
- ✅ 编写完整的测试
- ✅ 使用 `cargo expand` 验证
- ✅ 监控编译时间

---

## 📚 参考资源

**工具**:

- `cargo expand` - 宏展开
- `trybuild` - 编译失败测试
- `rust-analyzer` - IDE 支持

**相关文档**:

- [Tier 2: 声明宏实践指南](./01_声明宏实践指南.md)
- [Tier 2: Derive 宏开发指南](./02_Derive宏开发指南.md)
- [Tier 3: 理论参考](../tier_03_references/)

---

**文档维护**: C14 Macro System Team  
**最后审核**: 2025-10-23  
**下次更新**: 2026-01-23
