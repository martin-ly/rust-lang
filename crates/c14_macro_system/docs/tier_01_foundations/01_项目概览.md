# 项目概览 - Rust 宏系统

**模块**: C14 Macro System  
**版本**: 对齐 Rust 1.90  
**最后更新**: 2025-10-24

---

## 📋 目录

- [项目概览 - Rust 宏系统](#项目概览---rust-宏系统)
  - [📋 目录](#-目录)
  - [🎯 模块定位](#-模块定位)
  - [🌟 核心主题](#-核心主题)
    - [1. 声明宏 (Declarative Macros)](#1-声明宏-declarative-macros)
    - [2. 过程宏 (Procedural Macros)](#2-过程宏-procedural-macros)
    - [3. 宏卫生性 (Hygiene)](#3-宏卫生性-hygiene)
    - [4. 元编程 (Metaprogramming)](#4-元编程-metaprogramming)
  - [📚 学习路径](#-学习路径)
    - [🔰 初学者路径 (2-3 周)](#-初学者路径-2-3-周)
    - [🚀 进阶路径 (3-4 周)](#-进阶路径-3-4-周)
    - [🎓 专家路径 (持续学习)](#-专家路径-持续学习)
  - [🎯 适合人群](#-适合人群)
  - [✨ Rust 1.90 宏特性](#-rust-190-宏特性)
  - [📖 文档结构](#-文档结构)
  - [🔗 快速导航](#-快速导航)
  - [💡 学习建议](#-学习建议)

---

## 🎯 模块定位

本模块专注于 **Rust 宏系统**，涵盖声明宏、过程宏、宏卫生性、元编程等核心主题，帮助开发者掌握 Rust 的编译时元编程能力。

**核心目标**:

- 掌握声明宏（`macro_rules!`）的编写与使用
- 理解三种过程宏（Derive、Attribute、Function-like）
- 理解宏卫生性机制与作用域规则
- 学习元编程最佳实践与 DSL 构建

---

## 🌟 核心主题

### 1. 声明宏 (Declarative Macros)

- **`macro_rules!`**: 声明宏定义语法
- **模式匹配**: 宏参数的模式匹配
- **重复**: `$(...)*` 重复模式
- **卫生性**: 宏展开的标识符卫生性

**示例**:

```rust
macro_rules! vec_of_strings {
    ($($element:expr),*) => {
        vec![$(String::from($element)),*]
    };
}

let names = vec_of_strings!["Alice", "Bob", "Charlie"];
```

### 2. 过程宏 (Procedural Macros)

- **Derive 宏**: 自动实现 trait
- **属性宏**: 为代码添加属性
- **函数式宏**: 自定义语法

**Derive 宏示例**:

```rust
use my_macro::HelloMacro;

#[derive(HelloMacro)]
struct MyStruct;

// 自动实现 HelloMacro trait
```

**属性宏示例**:

```rust
#[route(GET, "/")]
fn index() -> String {
    "Hello, world!".to_string()
}
```

**函数式宏示例**:

```rust
let sql = sql!(SELECT * FROM users WHERE id = 1);
```

### 3. 宏卫生性 (Hygiene)

- **标识符卫生**: 宏内外标识符不冲突
- **作用域规则**: 宏展开的作用域行为
- **span 操作**: 控制错误消息位置

**示例**:

```rust
macro_rules! using_a {
    ($e:expr) => {
        {
            let a = 42; // 不会与外部的 a 冲突
            $e
        }
    }
}

let a = 13;
let result = using_a!(a + a); // result = 26，使用外部的 a
```

### 4. 元编程 (Metaprogramming)

- **代码生成**: 编译时生成代码
- **DSL 构建**: 创建领域特定语言
- **零成本抽象**: 宏展开后无运行时开销

**DSL 示例**:

```rust
html! {
    <div class="container">
        <h1>"Hello, World!"</h1>
        <p>"This is a DSL example"</p>
    </div>
}
```

---

## 📚 学习路径

### 🔰 初学者路径 (2-3 周)

**目标**: 掌握声明宏与简单过程宏

1. **Week 1**: 声明宏基础
   - `macro_rules!` 语法（2天）
   - 模式匹配与重复（2天）
   - 实战：自定义宏（3天）

2. **Week 2**: 过程宏入门
   - Derive 宏开发（3天）
   - TokenStream 处理（2天）
   - syn 与 quote 使用（2天）

3. **Week 3**: 宏调试与测试
   - 宏展开调试（2天）
   - 单元测试编写（2天）
   - 实战项目（3天）

### 🚀 进阶路径 (3-4 周)

**目标**: 掌握高级宏技术与 DSL 构建

1. **Week 1-2**: 高级过程宏
   - 属性宏开发（3天）
   - 函数式宏开发（3天）
   - 复杂 TokenStream 处理（2天）

2. **Week 3**: DSL 设计
   - DSL 语法设计（3天）
   - 解析与验证（2天）
   - 代码生成策略（2天）

3. **Week 4**: 宏工程实践
   - 宏项目架构（2天）
   - 测试覆盖策略（2天）
   - 文档与示例（1天）

### 🎓 专家路径 (持续学习)

**目标**: 深入元编程理论与生产级宏开发

- 宏的语义模型与形式化分析
- 零成本抽象验证（LLVM IR 分析）
- 生产级宏库开发与维护
- 编译期计算与优化

---

## 🎯 适合人群

| 人群 | 适合内容 | 推荐起点 |
|------|---------|---------|
| **Rust 初学者** | 声明宏基础 | Tier 1 + Tier 2 声明宏 |
| **库作者** | Derive 宏、属性宏 | Tier 2 全部 |
| **DSL 开发者** | 函数式宏、DSL 构建 | Tier 2 + Tier 4 |
| **编译器研究** | 元编程理论、形式化 | Tier 4 |

---

## ✨ Rust 1.90 宏特性

- ✅ **改进的宏错误消息**: 更清晰的展开错误提示
- ✅ **宏卫生性增强**: 更精确的作用域控制
- ✅ **过程宏性能优化**: 编译速度提升
- ✅ **cargo expand 改进**: 更好的宏展开查看体验

---

## 📖 文档结构

本模块采用 **4-Tier 文档架构**:

```text
Tier 1: 基础层 (本层)
├── 01_项目概览.md (本文档)
├── 02_主索引导航.md
├── 03_术语表.md
└── 04_常见问题.md

Tier 2: 实践层
├── 01_声明宏实践指南.md
├── 02_Derive宏开发指南.md
├── 03_属性宏开发指南.md
├── 04_函数宏开发指南.md
└── 05_宏调试与测试.md

Tier 3: 参考层
├── 01_声明宏完整参考.md
├── 02_过程宏API参考.md
├── 03_syn-quote参考.md
└── 04_宏卫生性参考.md

Tier 4: 高级层
├── 01_宏元编程.md
├── 02_DSL构建实践.md
├── 03_代码生成优化.md
├── 04_宏调试深化.md
└── 05_生产级宏开发.md
```

---

## 🔗 快速导航

**从这里开始**:

1. 📖 [主索引导航](./02_主索引导航.md) - 找到适合你的学习路径
2. 📝 [术语表](./03_术语表.md) - 理解核心概念
3. ❓ [常见问题](./04_常见问题.md) - 解决常见疑问

**深入学习**:

- 🚀 [Tier 2: 实践指南](../tier_02_guides/) - 动手实战
- 📚 [Tier 3: 技术参考](../tier_03_references/) - 查阅 API
- 🎓 [Tier 4: 高级主题](../tier_04_advanced/) - 理论深入

---

## 💡 学习建议

1. **先用后写**: 先使用现有宏，理解需求后再开发
2. **从声明宏开始**: 比过程宏简单，适合入门
3. **善用工具**: `cargo expand` 查看宏展开结果
4. **多写测试**: 宏的测试覆盖率要求更高
5. **参考优秀项目**: 学习 serde、tokio 等项目的宏实现

**预计学习时间**:

- 快速入门: 1-2 周
- 熟练掌握: 1-2 个月
- 精通深入: 3-6 个月

---

**下一步**: 阅读 [主索引导航](./02_主索引导航.md) 规划学习路径
