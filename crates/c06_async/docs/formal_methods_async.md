# 异步语义与形式化要点（Rust 1.90）

本节汇聚工程可用的“轻量形式化”与语义说明，帮助在评审/审计/安全需求下论证异步程序的正确性与可终止性。

## 目录

- [异步语义与形式化要点（Rust 1.90）](#异步语义与形式化要点rust-190)
  - [目录](#目录)
  - [1. 取消与超时的语义边界](#1-取消与超时的语义边界)
  - [2. 结构化并发与资源安全](#2-结构化并发与资源安全)
  - [3. 背压与无界风险证明草图](#3-背压与无界风险证明草图)
  - [4. 失败域与补偿](#4-失败域与补偿)
  - [5. 可观测性与不变式](#5-可观测性与不变式)
  - [6. 参考资料](#6-参考资料)

## 1. 取消与超时的语义边界

- 取消并非回滚：`abort`/`drop` 仅停止未来执行，不保证已提交副作用撤销；需设计幂等操作与补偿事务。
- 超时为外部界限：`timeout(d, f)` 的错误说明未在 d 内完成，不保证 f 已停止；应配合可取消点或显式任务管理。

## 2. 结构化并发与资源安全

- 任务集合拥有者负责回收：`JoinSet`/`FuturesUnordered` 持有任务，在作用域结束前应 drain 完毕或显式 abort。
- 资源线性化：异步持有 `&mut`/`Arc` 的共享资源时，遵循借用与生命周期边界，避免泄漏到未受控任务。

## 3. 背压与无界风险证明草图

- 有界通道 + 上游限速 ⇒ 内存上界；
- 无界通道 + 上游突发 ⇒ 存在内存无上界风险；
- 证明要点：界定生产/消费速率、容量 C、泄漏与丢弃策略，给出最坏情况估计。

## 4. 失败域与补偿

- 将系统划分为幂等域/可补偿域/不可恢复域；
- 在可补偿域提供重试+回滚/补偿；在不可恢复域触发熔断与隔离。

## 5. 可观测性与不变式

- 日志/指标/trace 作为“证据”：对关键不变式（单调性、容量上界、最大并发）进行运行时断言与指标校验。
- 采用采样/限频，避免观测本身干扰系统。

## 6. 参考资料

- Rust Async Book（Tokio/async-std 生态）
- Tokio 官方文档与 `tokio-console` 论文/介绍
- Ferrite / Multiparty Session Types / Koka & Effect systems（取消语义参考）
- Industrial Formal Methods for Async Systems（实践论文集合）
- 本仓：`docs/async_patterns_and_pitfalls.md`、`docs/tokio_best_practices_2025.md`
