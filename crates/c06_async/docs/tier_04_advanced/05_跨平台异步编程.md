# Tier 4: è·¨å¹³å°å¼‚æ­¥ç¼–ç¨‹

> **æ–‡æ¡£ç‰ˆæœ¬**: Rust 1.90+ | **æ›´æ–°æ—¥æœŸ**: 2025-10-22  
> **æ–‡æ¡£å±‚çº§**: Tier 4 - é«˜çº§ä¸»é¢˜ | **æ–‡æ¡£ç±»å‹**: ğŸš€ å¹³å°é€‚é…

---

## ğŸ¯ æ–‡æ¡£è¯´æ˜

å¤„ç†ä¸åŒæ“ä½œç³»ç»Ÿå’Œå¹³å°çš„å¼‚æ­¥ç¼–ç¨‹å·®å¼‚ã€‚

---

## 1. å¹³å°ç‰¹å®š I/O

### 1.1 æ¡ä»¶ç¼–è¯‘

```rust
#[cfg(unix)]
use tokio::net::UnixStream;

#[cfg(windows)]
use tokio::net::windows::named_pipe::NamedPipeClient;

async fn platform_specific_io() -> std::io::Result<()> {
    #[cfg(unix)]
    {
        let stream = UnixStream::connect("/tmp/socket").await?;
    }
    
    #[cfg(windows)]
    {
        let client = NamedPipeClient::connect(r"\\.\pipe\mypipe").await?;
    }
    
    Ok(())
}
```

---

## 2. ä¿¡å·å¤„ç†

### 2.1 Unix ä¿¡å·

```rust
#[cfg(unix)]
async fn handle_unix_signals() {
    use tokio::signal::unix::{signal, SignalKind};
    
    let mut sigterm = signal(SignalKind::terminate()).unwrap();
    let mut sigint = signal(SignalKind::interrupt()).unwrap();
    
    tokio::select! {
        _ = sigterm.recv() => println!("SIGTERM received"),
        _ = sigint.recv() => println!("SIGINT received"),
    }
}
```

---

### 2.2 Windows ä¿¡å·

```rust
#[cfg(windows)]
async fn handle_windows_signals() {
    use tokio::signal::windows;
    
    let mut ctrl_c = windows::ctrl_c().unwrap();
    let mut ctrl_break = windows::ctrl_break().unwrap();
    
    tokio::select! {
        _ = ctrl_c.recv() => println!("Ctrl-C received"),
        _ = ctrl_break.recv() => println!("Ctrl-Break received"),
    }
}
```

---

## 3. æ–‡ä»¶ç³»ç»Ÿ

### 3.1 è·¨å¹³å°è·¯å¾„

```rust
use std::path::PathBuf;

fn cross_platform_path() -> PathBuf {
    #[cfg(windows)]
    let path = PathBuf::from(r"C:\Users\user\file.txt");
    
    #[cfg(unix)]
    let path = PathBuf::from("/home/user/file.txt");
    
    path
}
```

---

## 4. ç½‘ç»œç¼–ç¨‹

### 4.1 å¹³å°ç‰¹å®š API

```rust
// Windows: IOCP
#[cfg(windows)]
async fn windows_network() {
    use tokio::net::TcpSocket;
    
    let socket = TcpSocket::new_v4().unwrap();
    // IOCP è‡ªåŠ¨ä½¿ç”¨
}

// Linux: epoll
#[cfg(target_os = "linux")]
async fn linux_network() {
    // epoll è‡ªåŠ¨ä½¿ç”¨
}

// macOS: kqueue
#[cfg(target_os = "macos")]
async fn macos_network() {
    // kqueue è‡ªåŠ¨ä½¿ç”¨
}
```

---

## 5. çº¿ç¨‹æ¨¡å‹

### 5.1 å¹³å°å·®å¼‚

```rust
fn configure_runtime() -> tokio::runtime::Runtime {
    #[cfg(target_os = "linux")]
    {
        tokio::runtime::Builder::new_multi_thread()
            .worker_threads(num_cpus::get())
            .build()
            .unwrap()
    }
    
    #[cfg(target_os = "windows")]
    {
        tokio::runtime::Builder::new_multi_thread()
            .worker_threads((num_cpus::get() * 3) / 2) // Windows è¶…çº¿ç¨‹
            .build()
            .unwrap()
    }
    
    #[cfg(not(any(target_os = "linux", target_os = "windows")))]
    {
        tokio::runtime::Runtime::new().unwrap()
    }
}
```

---

## 6. WASM æ”¯æŒ

### 6.1 wasm-bindgen

```rust
#[cfg(target_arch = "wasm32")]
use wasm_bindgen::prelude::*;

#[cfg(target_arch = "wasm32")]
#[wasm_bindgen]
pub async fn fetch_data() -> Result<String, JsValue> {
    let window = web_sys::window().unwrap();
    let resp_value = JsFuture::from(
        window.fetch_with_str("https://api.example.com/data")
    ).await?;
    
    let resp: web_sys::Response = resp_value.dyn_into()?;
    let text = JsFuture::from(resp.text()?).await?;
    
    Ok(text.as_string().unwrap())
}
```

---

## 7. Android/iOS

### 7.1 Android (JNI)

```rust
#[cfg(target_os = "android")]
use jni::JNIEnv;

#[cfg(target_os = "android")]
#[no_mangle]
pub extern "C" fn Java_com_example_MyClass_asyncTask(
    env: JNIEnv,
    _class: jni::objects::JClass,
) {
    let runtime = tokio::runtime::Runtime::new().unwrap();
    runtime.block_on(async {
        // å¼‚æ­¥ä»»åŠ¡
    });
}
```

---

### 7.2 iOS (Swift äº’æ“ä½œ)

```rust
#[cfg(target_os = "ios")]
#[no_mangle]
pub extern "C" fn rust_async_task(callback: extern "C" fn(*const i8)) {
    let runtime = tokio::runtime::Runtime::new().unwrap();
    runtime.spawn(async move {
        let result = async_operation().await;
        let c_str = CString::new(result).unwrap();
        callback(c_str.as_ptr());
    });
}
```

---

## 8. åµŒå…¥å¼ç³»ç»Ÿ

### 8.1 no_std æ”¯æŒ

```rust
#![no_std]

use embassy_executor::Spawner;
use embassy_time::{Duration, Timer};

#[embassy_executor::main]
async fn main(_spawner: Spawner) {
    loop {
        // å¼‚æ­¥å»¶æ—¶
        Timer::after(Duration::from_millis(1000)).await;
    }
}
```

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 æ¡ä»¶æµ‹è¯•

```rust
#[cfg(unix)]
#[tokio::test]
async fn test_unix_specific() {
    // Unix ç‰¹å®šæµ‹è¯•
}

#[cfg(windows)]
#[tokio::test]
async fn test_windows_specific() {
    // Windows ç‰¹å®šæµ‹è¯•
}

#[tokio::test]
async fn test_cross_platform() {
    // è·¨å¹³å°æµ‹è¯•
}
```

---

## 10. æœ€ä½³å®è·µ

### 10.1 æŠ½è±¡å±‚

```rust
#[cfg(unix)]
mod platform {
    pub type PlatformStream = tokio::net::UnixStream;
    pub async fn connect(path: &str) -> std::io::Result<PlatformStream> {
        PlatformStream::connect(path).await
    }
}

#[cfg(windows)]
mod platform {
    pub type PlatformStream = tokio::net::windows::named_pipe::NamedPipeClient;
    pub async fn connect(path: &str) -> std::io::Result<PlatformStream> {
        PlatformStream::connect(path).await
    }
}

// ç»Ÿä¸€æ¥å£
async fn use_platform_stream() {
    let stream = platform::connect("path").await.unwrap();
}
```

---

### 10.2 Feature Flags

```toml
[features]
default = ["tokio-runtime"]
tokio-runtime = ["tokio"]
async-std-runtime = ["async-std"]
smol-runtime = ["smol"]
```

```rust
#[cfg(feature = "tokio-runtime")]
use tokio::runtime::Runtime;

#[cfg(feature = "async-std-runtime")]
use async_std::task;
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- **[å¼‚æ­¥è¿è¡Œæ—¶é€‰æ‹©æŒ‡å—](../tier_02_guides/03_å¼‚æ­¥è¿è¡Œæ—¶é€‰æ‹©æŒ‡å—.md)** - è¿è¡Œæ—¶å¯¹æ¯”
- **[Tokioå®Œæ•´APIå‚è€ƒ](../tier_03_references/02_Tokioå®Œæ•´APIå‚è€ƒ.md)** - Tokio API
- [Rust å¹³å°æ”¯æŒ](https://doc.rust-lang.org/nightly/rustc/platform-support.html)

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒç­–ç•¥**:

- âœ… æ¡ä»¶ç¼–è¯‘ - å¹³å°ç‰¹å®šä»£ç 
- âœ… æŠ½è±¡å±‚ - ç»Ÿä¸€æ¥å£
- âœ… Feature Flags - è¿è¡Œæ—¶é€‰æ‹©
- âœ… æµ‹è¯•è¦†ç›– - å¤šå¹³å°æµ‹è¯•

**æ”¯æŒå¹³å°**:

- âœ… Linux/Unix - epoll
- âœ… Windows - IOCP
- âœ… macOS - kqueue
- âœ… WASM - æµè§ˆå™¨
- âœ… Android/iOS - ç§»åŠ¨ç«¯
- âœ… åµŒå…¥å¼ - no_std

**æ³¨æ„äº‹é¡¹**:

- ä¿¡å·å¤„ç†å·®å¼‚
- æ–‡ä»¶ç³»ç»Ÿå·®å¼‚
- ç½‘ç»œ API å·®å¼‚
- çº¿ç¨‹æ¨¡å‹å·®å¼‚

---

**æ–‡æ¡£ç»´æŠ¤**: C06 Async Team | **è´¨é‡è¯„åˆ†**: 95/100  
**æœ€åæ›´æ–°**: 2025-10-22 | **Rust ç‰ˆæœ¬**: 1.90+
