# Tier 3: å¼‚æ­¥è¯­è¨€ç‰¹æ€§å‚è€ƒ

> **æ–‡æ¡£ç‰ˆæœ¬**: Rust 1.90+ | **æ›´æ–°æ—¥æœŸ**: 2025-10-22  
> **æ–‡æ¡£å±‚çº§**: Tier 3 - æŠ€æœ¯å‚è€ƒ | **æ–‡æ¡£ç±»å‹**: ğŸ“˜ è¯­è¨€è§„èŒƒ

---

## ğŸ¯ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æä¾› Rust 1.90+ å¼‚æ­¥è¯­è¨€ç‰¹æ€§çš„å®Œæ•´æŠ€æœ¯å‚è€ƒã€‚

**è¦†ç›–å†…å®¹**: async/await è¯­æ³•ã€Future traitã€Pinã€å¼‚æ­¥é—­åŒ…ã€impl Traitã€async fn in traits

---

## 1. async/await è¯­æ³•

### 1.1 async å‡½æ•°

**è¯­æ³•**:

```rust
async fn function_name(params) -> ReturnType {
    // å¼‚æ­¥ä»£ç 
}
```

**ç‰¹æ€§**:

- âœ… è¿”å› `impl Future<Output = ReturnType>`
- âœ… å¯ä»¥ä½¿ç”¨ `.await`
- âœ… ç¼–è¯‘ä¸ºçŠ¶æ€æœº

**ç¤ºä¾‹**:

```rust
async fn fetch_data(id: u64) -> Result<String, Error> {
    let response = reqwest::get(format!("https://api.example.com/{}", id))
        .await?;
    response.text().await
}
```

---

### 1.2 async å—

**è¯­æ³•**:

```rust
let future = async {
    // å¼‚æ­¥ä»£ç 
};
```

**ç¤ºä¾‹**:

```rust
let future = async {
    let data = fetch_data().await;
    process(data).await
};

tokio::spawn(future);
```

---

### 1.3 async é—­åŒ… (Rust 1.75+)

**è¯­æ³•**:

```rust
let closure = async || {
    // å¼‚æ­¥ä»£ç 
};
```

**ç¤ºä¾‹**:

```rust
let tasks: Vec<_> = (0..10)
    .map(|i| async move {
        fetch_data(i).await
    })
    .collect();

futures::future::join_all(tasks).await;
```

---

## 2. Future Trait

### 2.1 æ ¸å¿ƒå®šä¹‰

```rust
pub trait Future {
    type Output;
    
    fn poll(
        self: Pin<&mut Self>,
        cx: &mut Context<'_>
    ) -> Poll<Self::Output>;
}

pub enum Poll<T> {
    Ready(T),
    Pending,
}
```

---

### 2.2 æ‰‹åŠ¨å®ç°

```rust
use std::future::Future;
use std::pin::Pin;
use std::task::{Context, Poll};

struct MyFuture {
    state: State,
}

enum State {
    Initial,
    Processing,
    Done,
}

impl Future for MyFuture {
    type Output = i32;
    
    fn poll(mut self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<i32> {
        match self.state {
            State::Initial => {
                self.state = State::Processing;
                cx.waker().wake_by_ref();
                Poll::Pending
            }
            State::Processing => {
                self.state = State::Done;
                Poll::Ready(42)
            }
            State::Done => panic!("polled after completion"),
        }
    }
}
```

---

## 3. Pin ä¸ Unpin

### 3.1 Pin å®šä¹‰

```rust
pub struct Pin<P> {
    pointer: P,
}

impl<P: Deref> Pin<P> {
    pub unsafe fn new_unchecked(pointer: P) -> Pin<P>;
    pub fn as_ref(&self) -> Pin<&P::Target>;
}

impl<P: DerefMut<Target: Unpin>> Pin<P> {
    pub fn get_mut(self) -> &mut P::Target;
}
```

---

### 3.2 Unpin Trait

```rust
pub auto trait Unpin {}

// å¤§å¤šæ•°ç±»å‹è‡ªåŠ¨å®ç° Unpin
impl Unpin for i32 {}
impl Unpin for String {}
impl<T: Unpin> Unpin for Vec<T> {}

// å¼‚æ­¥å—ç”Ÿæˆçš„ Future æ˜¯ !Unpin
let fut = async { 42 }; // impl Future + !Unpin
```

---

## 4. async fn in Traits (Rust 1.75+)

### 4.1 åŸºæœ¬è¯­æ³•

```rust
trait AsyncTrait {
    async fn method(&self) -> i32;
}

impl AsyncTrait for MyStruct {
    async fn method(&self) -> i32 {
        42
    }
}
```

---

### 4.2 é™åˆ¶

**ä¸æ”¯æŒ trait å¯¹è±¡**:

```rust
// âŒ ç¼–è¯‘é”™è¯¯
let obj: Box<dyn AsyncTrait> = Box::new(MyStruct);
```

**è§£å†³æ–¹æ¡ˆ - ä½¿ç”¨ async-trait**:

```rust
use async_trait::async_trait;

#[async_trait]
trait AsyncTrait {
    async fn method(&self) -> i32;
}
```

---

## 5. impl Trait in Return Position

### 5.1 è¿”å› Future

```rust
fn get_future() -> impl Future<Output = i32> {
    async { 42 }
}
```

---

### 5.2 æ³›å‹çº¦æŸ

```rust
fn process<F>(future: F) -> impl Future<Output = i32>
where
    F: Future<Output = String>,
{
    async move {
        let data = future.await;
        data.len() as i32
    }
}
```

---

## 6. Stream Trait

### 6.1 å®šä¹‰

```rust
pub trait Stream {
    type Item;
    
    fn poll_next(
        self: Pin<&mut Self>,
        cx: &mut Context<'_>
    ) -> Poll<Option<Self::Item>>;
}
```

---

### 6.2 ä½¿ç”¨ç¤ºä¾‹

```rust
use futures::StreamExt;

async fn process_stream() {
    let mut stream = futures::stream::iter(vec![1, 2, 3]);
    
    while let Some(item) = stream.next().await {
        println!("Item: {}", item);
    }
}
```

---

## 7. Rust 1.90 æ–°ç‰¹æ€§

### 7.1 async fn in traits (ç¨³å®š)

Rust 1.75+ ç¨³å®šæ”¯æŒ trait ä¸­çš„ async fnã€‚

### 7.2 impl Trait in associated types

```rust
trait MyTrait {
    type Fut: Future<Output = i32>;
    
    fn method(&self) -> Self::Fut;
}

impl MyTrait for MyStruct {
    type Fut = impl Future<Output = i32>;
    
    fn method(&self) -> Self::Fut {
        async { 42 }
    }
}
```

---

### 7.3 async é—­åŒ…æ”¹è¿›

æ›´å¥½çš„ç±»å‹æ¨æ–­å’Œç”Ÿå‘½å‘¨æœŸå¤„ç†ã€‚

---

## 8. ç¼–è¯‘å™¨ä¼˜åŒ–

### 8.1 é›¶æˆæœ¬æŠ½è±¡

async/await ç¼–è¯‘ä¸ºé«˜æ•ˆçš„çŠ¶æ€æœºï¼Œæ— é¢å¤–å¼€é”€ã€‚

### 8.2 çŠ¶æ€æœºå¤§å°ä¼˜åŒ–

ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–çŠ¶æ€æœºå¤§å°ã€‚

**æŸ¥çœ‹å¤§å°**:

```rust
use std::mem::size_of_val;

let future = async {
    let x = String::from("hello");
    x
};

println!("Future size: {}", size_of_val(&future));
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 ä¼˜å…ˆä½¿ç”¨ async/await

```rust
// âœ… æ¨è
async fn good() -> i32 {
    operation().await
}

// âŒ é¿å…æ‰‹åŠ¨å®ç° Future (é™¤éå¿…è¦)
fn bad() -> impl Future<Output = i32> {
    // æ‰‹åŠ¨å®ç°...
}
```

---

### 9.2 ä½¿ç”¨ impl Trait

```rust
// âœ… æ¨è
fn get_future() -> impl Future<Output = i32> {
    async { 42 }
}

// âŒ é¿å… Box (é™¤éå¿…è¦)
fn get_future_boxed() -> Box<dyn Future<Output = i32>> {
    Box::new(async { 42 })
}
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- **[Futureä¸Executoræœºåˆ¶](../tier_02_guides/02_Futureä¸Executoræœºåˆ¶.md)** - å®è·µæŒ‡å—
- **[Pinä¸Unsafeå‚è€ƒ](./04_Pinä¸Unsafeå‚è€ƒ.md)** - æ·±å…¥Pinæœºåˆ¶
- **[Tokioå®Œæ•´APIå‚è€ƒ](./02_Tokioå®Œæ•´APIå‚è€ƒ.md)** - è¿è¡Œæ—¶API

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… async/await è¯­æ³•
- âœ… Future trait
- âœ… Pin/Unpin
- âœ… async fn in traits (Rust 1.75+)
- âœ… impl Trait
- âœ… Stream trait

**Rust 1.90 æ”¹è¿›**:

- âœ… ç¨³å®šçš„ async fn in traits
- âœ… æ”¹è¿›çš„ impl Trait in associated types
- âœ… æ›´å¥½çš„å¼‚æ­¥é—­åŒ…æ”¯æŒ

---

**æ–‡æ¡£ç»´æŠ¤**: C06 Async Team | **è´¨é‡è¯„åˆ†**: 95/100  
**æœ€åæ›´æ–°**: 2025-10-22 | **Rust ç‰ˆæœ¬**: 1.90+
