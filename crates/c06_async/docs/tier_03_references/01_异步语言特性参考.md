# Tier 3: 异步语言特性参考

> **文档版本**: Rust 1.90+ | **更新日期**: 2025-10-22  
> **文档层级**: Tier 3 - 技术参考 | **文档类型**: 📘 语言规范

---

## 📊 目录

- [Tier 3: 异步语言特性参考](#tier-3-异步语言特性参考)
  - [📊 目录](#-目录)
  - [📋 目录](#-目录-1)
  - [🎯 文档说明](#-文档说明)
  - [1. async/await 语法](#1-asyncawait-语法)
    - [1.1 async 函数](#11-async-函数)
    - [1.2 async 块](#12-async-块)
    - [1.3 async 闭包 (Rust 1.75+)](#13-async-闭包-rust-175)
  - [2. Future Trait](#2-future-trait)
    - [2.1 核心定义](#21-核心定义)
    - [2.2 手动实现](#22-手动实现)
  - [3. Pin 与 Unpin](#3-pin-与-unpin)
    - [3.1 Pin 定义](#31-pin-定义)
    - [3.2 Unpin Trait](#32-unpin-trait)
  - [4. async fn in Traits (Rust 1.75+)](#4-async-fn-in-traits-rust-175)
    - [4.1 基本语法](#41-基本语法)
    - [4.2 限制](#42-限制)
  - [5. impl Trait in Return Position](#5-impl-trait-in-return-position)
    - [5.1 返回 Future](#51-返回-future)
    - [5.2 泛型约束](#52-泛型约束)
  - [6. Stream Trait](#6-stream-trait)
    - [6.1 定义](#61-定义)
    - [6.2 使用示例](#62-使用示例)
  - [7. Rust 1.90 新特性](#7-rust-190-新特性)
    - [7.1 async fn in traits (稳定)](#71-async-fn-in-traits-稳定)
    - [7.2 impl Trait in associated types](#72-impl-trait-in-associated-types)
    - [7.3 async 闭包改进](#73-async-闭包改进)
  - [8. 编译器优化](#8-编译器优化)
    - [8.1 零成本抽象](#81-零成本抽象)
    - [8.2 状态机大小优化](#82-状态机大小优化)
  - [9. 最佳实践](#9-最佳实践)
    - [9.1 优先使用 async/await](#91-优先使用-asyncawait)
    - [9.2 使用 impl Trait](#92-使用-impl-trait)
  - [📚 延伸阅读](#-延伸阅读)
  - [📝 总结](#-总结)

## 📋 目录

- [Tier 3: 异步语言特性参考](#tier-3-异步语言特性参考)
  - [� 目录](#-目录)
  - [📋 目录](#-目录-1)
  - [🎯 文档说明](#-文档说明)
  - [1. async/await 语法](#1-asyncawait-语法)
    - [1.1 async 函数](#11-async-函数)
    - [1.2 async 块](#12-async-块)
    - [1.3 async 闭包 (Rust 1.75+)](#13-async-闭包-rust-175)
  - [2. Future Trait](#2-future-trait)
    - [2.1 核心定义](#21-核心定义)
    - [2.2 手动实现](#22-手动实现)
  - [3. Pin 与 Unpin](#3-pin-与-unpin)
    - [3.1 Pin 定义](#31-pin-定义)
    - [3.2 Unpin Trait](#32-unpin-trait)
  - [4. async fn in Traits (Rust 1.75+)](#4-async-fn-in-traits-rust-175)
    - [4.1 基本语法](#41-基本语法)
    - [4.2 限制](#42-限制)
  - [5. impl Trait in Return Position](#5-impl-trait-in-return-position)
    - [5.1 返回 Future](#51-返回-future)
    - [5.2 泛型约束](#52-泛型约束)
  - [6. Stream Trait](#6-stream-trait)
    - [6.1 定义](#61-定义)
    - [6.2 使用示例](#62-使用示例)
  - [7. Rust 1.90 新特性](#7-rust-190-新特性)
    - [7.1 async fn in traits (稳定)](#71-async-fn-in-traits-稳定)
    - [7.2 impl Trait in associated types](#72-impl-trait-in-associated-types)
    - [7.3 async 闭包改进](#73-async-闭包改进)
  - [8. 编译器优化](#8-编译器优化)
    - [8.1 零成本抽象](#81-零成本抽象)
    - [8.2 状态机大小优化](#82-状态机大小优化)
  - [9. 最佳实践](#9-最佳实践)
    - [9.1 优先使用 async/await](#91-优先使用-asyncawait)
    - [9.2 使用 impl Trait](#92-使用-impl-trait)
  - [📚 延伸阅读](#-延伸阅读)
  - [📝 总结](#-总结)

## 🎯 文档说明

本文档提供 Rust 1.90+ 异步语言特性的完整技术参考。

**覆盖内容**: async/await 语法、Future trait、Pin、异步闭包、impl Trait、async fn in traits

---

## 1. async/await 语法

### 1.1 async 函数

**语法**:

```rust
async fn function_name(params) -> ReturnType {
    // 异步代码
}
```

**特性**:

- ✅ 返回 `impl Future<Output = ReturnType>`
- ✅ 可以使用 `.await`
- ✅ 编译为状态机

**示例**:

```rust
async fn fetch_data(id: u64) -> Result<String, Error> {
    let response = reqwest::get(format!("https://api.example.com/{}", id))
        .await?;
    response.text().await
}
```

---

### 1.2 async 块

**语法**:

```rust
let future = async {
    // 异步代码
};
```

**示例**:

```rust
let future = async {
    let data = fetch_data().await;
    process(data).await
};

tokio::spawn(future);
```

---

### 1.3 async 闭包 (Rust 1.75+)

**语法**:

```rust
let closure = async || {
    // 异步代码
};
```

**示例**:

```rust
let tasks: Vec<_> = (0..10)
    .map(|i| async move {
        fetch_data(i).await
    })
    .collect();

futures::future::join_all(tasks).await;
```

---

## 2. Future Trait

### 2.1 核心定义

```rust
pub trait Future {
    type Output;
    
    fn poll(
        self: Pin<&mut Self>,
        cx: &mut Context<'_>
    ) -> Poll<Self::Output>;
}

pub enum Poll<T> {
    Ready(T),
    Pending,
}
```

---

### 2.2 手动实现

```rust
use std::future::Future;
use std::pin::Pin;
use std::task::{Context, Poll};

struct MyFuture {
    state: State,
}

enum State {
    Initial,
    Processing,
    Done,
}

impl Future for MyFuture {
    type Output = i32;
    
    fn poll(mut self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<i32> {
        match self.state {
            State::Initial => {
                self.state = State::Processing;
                cx.waker().wake_by_ref();
                Poll::Pending
            }
            State::Processing => {
                self.state = State::Done;
                Poll::Ready(42)
            }
            State::Done => panic!("polled after completion"),
        }
    }
}
```

---

## 3. Pin 与 Unpin

### 3.1 Pin 定义

```rust
pub struct Pin<P> {
    pointer: P,
}

impl<P: Deref> Pin<P> {
    pub unsafe fn new_unchecked(pointer: P) -> Pin<P>;
    pub fn as_ref(&self) -> Pin<&P::Target>;
}

impl<P: DerefMut<Target: Unpin>> Pin<P> {
    pub fn get_mut(self) -> &mut P::Target;
}
```

---

### 3.2 Unpin Trait

```rust
pub auto trait Unpin {}

// 大多数类型自动实现 Unpin
impl Unpin for i32 {}
impl Unpin for String {}
impl<T: Unpin> Unpin for Vec<T> {}

// 异步块生成的 Future 是 !Unpin
let fut = async { 42 }; // impl Future + !Unpin
```

---

## 4. async fn in Traits (Rust 1.75+)

### 4.1 基本语法

```rust
trait AsyncTrait {
    async fn method(&self) -> i32;
}

impl AsyncTrait for MyStruct {
    async fn method(&self) -> i32 {
        42
    }
}
```

---

### 4.2 限制

**不支持 trait 对象**:

```rust
// ❌ 编译错误
let obj: Box<dyn AsyncTrait> = Box::new(MyStruct);
```

**解决方案 - 使用 async-trait**:

```rust
use async_trait::async_trait;

#[async_trait]
trait AsyncTrait {
    async fn method(&self) -> i32;
}
```

---

## 5. impl Trait in Return Position

### 5.1 返回 Future

```rust
fn get_future() -> impl Future<Output = i32> {
    async { 42 }
}
```

---

### 5.2 泛型约束

```rust
fn process<F>(future: F) -> impl Future<Output = i32>
where
    F: Future<Output = String>,
{
    async move {
        let data = future.await;
        data.len() as i32
    }
}
```

---

## 6. Stream Trait

### 6.1 定义

```rust
pub trait Stream {
    type Item;
    
    fn poll_next(
        self: Pin<&mut Self>,
        cx: &mut Context<'_>
    ) -> Poll<Option<Self::Item>>;
}
```

---

### 6.2 使用示例

```rust
use futures::StreamExt;

async fn process_stream() {
    let mut stream = futures::stream::iter(vec![1, 2, 3]);
    
    while let Some(item) = stream.next().await {
        println!("Item: {}", item);
    }
}
```

---

## 7. Rust 1.90 新特性

### 7.1 async fn in traits (稳定)

Rust 1.75+ 稳定支持 trait 中的 async fn。

### 7.2 impl Trait in associated types

```rust
trait MyTrait {
    type Fut: Future<Output = i32>;
    
    fn method(&self) -> Self::Fut;
}

impl MyTrait for MyStruct {
    type Fut = impl Future<Output = i32>;
    
    fn method(&self) -> Self::Fut {
        async { 42 }
    }
}
```

---

### 7.3 async 闭包改进

更好的类型推断和生命周期处理。

---

## 8. 编译器优化

### 8.1 零成本抽象

async/await 编译为高效的状态机，无额外开销。

### 8.2 状态机大小优化

编译器自动优化状态机大小。

**查看大小**:

```rust
use std::mem::size_of_val;

let future = async {
    let x = String::from("hello");
    x
};

println!("Future size: {}", size_of_val(&future));
```

---

## 9. 最佳实践

### 9.1 优先使用 async/await

```rust
// ✅ 推荐
async fn good() -> i32 {
    operation().await
}

// ❌ 避免手动实现 Future (除非必要)
fn bad() -> impl Future<Output = i32> {
    // 手动实现...
}
```

---

### 9.2 使用 impl Trait

```rust
// ✅ 推荐
fn get_future() -> impl Future<Output = i32> {
    async { 42 }
}

// ❌ 避免 Box (除非必要)
fn get_future_boxed() -> Box<dyn Future<Output = i32>> {
    Box::new(async { 42 })
}
```

---

## 📚 延伸阅读

- **[Future与Executor机制](../tier_02_guides/02_Future与Executor机制.md)** - 实践指南
- **[Pin与Unsafe参考](./04_Pin与Unsafe参考.md)** - 深入Pin机制
- **[Tokio完整API参考](./02_Tokio完整API参考.md)** - 运行时API

---

## 📝 总结

**核心特性**:

- ✅ async/await 语法
- ✅ Future trait
- ✅ Pin/Unpin
- ✅ async fn in traits (Rust 1.75+)
- ✅ impl Trait
- ✅ Stream trait

**Rust 1.90 改进**:

- ✅ 稳定的 async fn in traits
- ✅ 改进的 impl Trait in associated types
- ✅ 更好的异步闭包支持

---

**文档维护**: C06 Async Team | **质量评分**: 95/100  
**最后更新**: 2025-10-22 | **Rust 版本**: 1.90+
