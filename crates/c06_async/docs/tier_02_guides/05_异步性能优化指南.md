# Tier 2: å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: Rust 1.90+ | **æ›´æ–°æ—¥æœŸ**: 2025-10-22  
> **æ–‡æ¡£å±‚çº§**: Tier 2 - å®è·µæŒ‡å— | **é¢„è®¡é˜…è¯»**: 20 åˆ†é’Ÿ

---

## ğŸ“‹ ç›®å½•

- [Tier 2: å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–æŒ‡å—](#tier-2-å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æœ¬ç« ç›®æ ‡](#-æœ¬ç« ç›®æ ‡)
  - [1. æ€§èƒ½åˆ†æåŸºç¡€](#1-æ€§èƒ½åˆ†æåŸºç¡€)
    - [1.1 æ€§èƒ½æŒ‡æ ‡](#11-æ€§èƒ½æŒ‡æ ‡)
    - [1.2 æ€§èƒ½æµ‹è¯•å·¥å…·](#12-æ€§èƒ½æµ‹è¯•å·¥å…·)
  - [2. å¹¶å‘ä¼˜åŒ–](#2-å¹¶å‘ä¼˜åŒ–)
    - [2.1 ä½¿ç”¨ `join!` è€Œéé¡ºåº `.await`](#21-ä½¿ç”¨-join-è€Œéé¡ºåº-await)
    - [2.2 åˆç†ä½¿ç”¨ `spawn`](#22-åˆç†ä½¿ç”¨-spawn)
  - [3. å†…å­˜ä¼˜åŒ–](#3-å†…å­˜ä¼˜åŒ–)
    - [3.1 é¿å…ä¸å¿…è¦çš„ `Box`](#31-é¿å…ä¸å¿…è¦çš„-box)
    - [3.2 ä½¿ç”¨ `Bytes` é¿å…æ‹·è´](#32-ä½¿ç”¨-bytes-é¿å…æ‹·è´)
    - [3.3 å¯¹è±¡æ± ](#33-å¯¹è±¡æ± )
  - [4. CPU ä¼˜åŒ–](#4-cpu-ä¼˜åŒ–)
    - [4.1 ä½¿ç”¨ `spawn_blocking` å¤„ç† CPU å¯†é›†ä»»åŠ¡](#41-ä½¿ç”¨-spawn_blocking-å¤„ç†-cpu-å¯†é›†ä»»åŠ¡)
    - [4.2 è°ƒæ•´å·¥ä½œçº¿ç¨‹æ•°](#42-è°ƒæ•´å·¥ä½œçº¿ç¨‹æ•°)
  - [5. I/O ä¼˜åŒ–](#5-io-ä¼˜åŒ–)
    - [5.1 ç¼“å†²åŒºå¤§å°ä¼˜åŒ–](#51-ç¼“å†²åŒºå¤§å°ä¼˜åŒ–)
    - [5.2 æ‰¹é‡I/Oæ“ä½œ](#52-æ‰¹é‡ioæ“ä½œ)
  - [6. é”ä¼˜åŒ–](#6-é”ä¼˜åŒ–)
    - [6.1 å‡å°‘é”æŒæœ‰æ—¶é—´](#61-å‡å°‘é”æŒæœ‰æ—¶é—´)
    - [6.2 ä½¿ç”¨è¯»å†™é”](#62-ä½¿ç”¨è¯»å†™é”)
  - [7. æ€§èƒ½æµ‹é‡](#7-æ€§èƒ½æµ‹é‡)
    - [7.1 ä½¿ç”¨ `tokio-console`](#71-ä½¿ç”¨-tokio-console)
    - [7.2 ç«ç„°å›¾åˆ†æ](#72-ç«ç„°å›¾åˆ†æ)
  - [8. ä¼˜åŒ–æ¸…å•](#8-ä¼˜åŒ–æ¸…å•)
    - [8.1 å¼€å‘é˜¶æ®µ](#81-å¼€å‘é˜¶æ®µ)
    - [8.2 æµ‹è¯•é˜¶æ®µ](#82-æµ‹è¯•é˜¶æ®µ)
    - [8.3 ç”Ÿäº§é˜¶æ®µ](#83-ç”Ÿäº§é˜¶æ®µ)
  - [9. æ¡ˆä¾‹ç ”ç©¶](#9-æ¡ˆä¾‹ç ”ç©¶)
    - [9.1 HTTP æœåŠ¡å™¨ä¼˜åŒ–](#91-http-æœåŠ¡å™¨ä¼˜åŒ–)
  - [ğŸ“š å»¶ä¼¸é˜…è¯»](#-å»¶ä¼¸é˜…è¯»)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)

## ğŸ¯ æœ¬ç« ç›®æ ‡

æŒæ¡å¼‚æ­¥ç¨‹åºæ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€æœ¯å’Œæœ€ä½³å®è·µã€‚

**å­¦ä¹ æˆæœ**:

- âœ… è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
- âœ… æŒæ¡å¸¸è§ä¼˜åŒ–æŠ€æœ¯
- âœ… ç†è§£å†…å­˜å’ŒCPUä¼˜åŒ–
- âœ… å­¦ä¼šåŸºå‡†æµ‹è¯•å’Œæ€§èƒ½åˆ†æ

---

## 1. æ€§èƒ½åˆ†æåŸºç¡€

### 1.1 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | ç›®æ ‡ |
|------|------|------|
| **ååé‡** | æ¯ç§’å¤„ç†è¯·æ±‚æ•° | æœ€å¤§åŒ– |
| **å»¶è¿Ÿ** | å•ä¸ªè¯·æ±‚å“åº”æ—¶é—´ | æœ€å°åŒ– |
| **P99 å»¶è¿Ÿ** | 99% è¯·æ±‚çš„å“åº”æ—¶é—´ | ç¨³å®šä¸”ä½ |
| **å†…å­˜å ç”¨** | å³°å€¼å†…å­˜ä½¿ç”¨ | åˆç†èŒƒå›´ |
| **CPU ä½¿ç”¨ç‡** | å¤„ç†å™¨åˆ©ç”¨ç‡ | å¹³è¡¡ï¼ˆé¿å…è¿‡é«˜/è¿‡ä½ï¼‰ |

### 1.2 æ€§èƒ½æµ‹è¯•å·¥å…·

```toml
[dev-dependencies]
criterion = { version = "0.5", features = ["async_tokio"] }
tokio = { version = "1", features = ["full", "test-util"] }
```

**åŸºå‡†æµ‹è¯•ç¤ºä¾‹**:

```rust
use criterion::{criterion_group, criterion_main, Criterion};
use tokio::runtime::Runtime;

fn benchmark_async_task(c: &mut Criterion) {
    let rt = Runtime::new().unwrap();
    
    c.bench_function("async_task", |b| {
        b.to_async(&rt).iter(|| async {
            // è¢«æµ‹è¯•çš„å¼‚æ­¥ä»£ç 
            tokio::time::sleep(tokio::time::Duration::from_micros(1)).await;
        });
    });
}

criterion_group!(benches, benchmark_async_task);
criterion_main!(benches);
```

---

## 2. å¹¶å‘ä¼˜åŒ–

### 2.1 ä½¿ç”¨ `join!` è€Œéé¡ºåº `.await`

**âŒ æ…¢ - é¡ºåºæ‰§è¡Œ (3ç§’)**:

```rust
async fn slow() {
    let a = task1().await; // 1ç§’
    let b = task2().await; // 2ç§’
    // æ€»è®¡: 3ç§’
}
```

**âœ… å¿« - å¹¶å‘æ‰§è¡Œ (2ç§’)**:

```rust
async fn fast() {
    let (a, b) = tokio::join!(task1(), task2());
    // æ€»è®¡: max(1ç§’, 2ç§’) = 2ç§’
}
```

---

### 2.2 åˆç†ä½¿ç”¨ `spawn`

**âŒ è¿‡åº¦ spawn (å¼€é”€å¤§)**:

```rust
async fn bad() {
    for i in 0..1_000_000 {
        tokio::spawn(async move {
            println!("{}", i);
        });
    }
}
```

**âœ… æ‰¹é‡å¤„ç† (å¼€é”€å°)**:

```rust
async fn good() {
    let batch_size = 1000;
    for batch_start in (0..1_000_000).step_by(batch_size) {
        tokio::spawn(async move {
            for i in batch_start..(batch_start + batch_size) {
                println!("{}", i);
            }
        });
    }
}
```

---

## 3. å†…å­˜ä¼˜åŒ–

### 3.1 é¿å…ä¸å¿…è¦çš„ `Box`

**âŒ æ…¢ - å †åˆ†é…**:

```rust
fn slow() -> Pin<Box<dyn Future<Output = i32>>> {
    Box::pin(async { 42 })
}
```

**âœ… å¿« - æ ˆåˆ†é…**:

```rust
fn fast() -> impl Future<Output = i32> {
    async { 42 }
}
```

---

### 3.2 ä½¿ç”¨ `Bytes` é¿å…æ‹·è´

```rust
use bytes::Bytes;

// âŒ å¤šæ¬¡æ‹·è´
async fn slow(data: Vec<u8>) {
    let copy1 = data.clone();
    let copy2 = data.clone();
    // ...
}

// âœ… é›¶æ‹·è´ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰
async fn fast(data: Bytes) {
    let copy1 = data.clone(); // åªå¢åŠ å¼•ç”¨è®¡æ•°
    let copy2 = data.clone();
    // ...
}
```

---

### 3.3 å¯¹è±¡æ± 

```rust
use tokio::sync::Mutex;
use std::sync::Arc;

struct Pool<T> {
    objects: Arc<Mutex<Vec<T>>>,
}

impl<T> Pool<T> {
    fn new() -> Self {
        Self {
            objects: Arc::new(Mutex::new(Vec::new())),
        }
    }
    
    async fn acquire(&self) -> Option<T> {
        self.objects.lock().await.pop()
    }
    
    async fn release(&self, obj: T) {
        self.objects.lock().await.push(obj);
    }
}
```

---

## 4. CPU ä¼˜åŒ–

### 4.1 ä½¿ç”¨ `spawn_blocking` å¤„ç† CPU å¯†é›†ä»»åŠ¡

```rust
#[tokio::main]
async fn main() {
    // âŒ é”™è¯¯ï¼šé˜»å¡å¼‚æ­¥è¿è¡Œæ—¶
    let result = heavy_computation(); // 10ç§’ CPU è®¡ç®—
    
    // âœ… æ­£ç¡®ï¼šåœ¨ä¸“ç”¨çº¿ç¨‹æ± æ‰§è¡Œ
    let result = tokio::task::spawn_blocking(|| {
        heavy_computation()
    }).await.unwrap();
}

fn heavy_computation() -> i32 {
    (0..1_000_000_000).sum()
}
```

---

### 4.2 è°ƒæ•´å·¥ä½œçº¿ç¨‹æ•°

```rust
// é»˜è®¤ï¼šCPU æ ¸å¿ƒæ•°
#[tokio::main]
async fn main() {
    // ...
}

// è‡ªå®šä¹‰çº¿ç¨‹æ•°
#[tokio::main(worker_threads = 4)]
async fn main() {
    // ä½¿ç”¨ 4 ä¸ªå·¥ä½œçº¿ç¨‹
}
```

---

## 5. I/O ä¼˜åŒ–

### 5.1 ç¼“å†²åŒºå¤§å°ä¼˜åŒ–

```rust
use tokio::io::{AsyncReadExt, BufReader};
use tokio::fs::File;

#[tokio::main]
async fn main() -> std::io::Result<()> {
    // âŒ å°ç¼“å†²åŒºï¼ˆé¢‘ç¹ç³»ç»Ÿè°ƒç”¨ï¼‰
    let file = File::open("large_file.txt").await?;
    let mut reader = BufReader::with_capacity(1024, file);
    
    // âœ… å¤§ç¼“å†²åŒºï¼ˆå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼‰
    let file = File::open("large_file.txt").await?;
    let mut reader = BufReader::with_capacity(64 * 1024, file); // 64KB
    
    Ok(())
}
```

---

### 5.2 æ‰¹é‡I/Oæ“ä½œ

```rust
use tokio::io::{AsyncWriteExt, BufWriter};

// âŒ é€ä¸ªå†™å…¥
async fn slow_write(data: Vec<String>) -> std::io::Result<()> {
    let file = tokio::fs::File::create("output.txt").await?;
    let mut writer = BufWriter::new(file);
    
    for line in data {
        writer.write_all(line.as_bytes()).await?;
    }
    
    Ok(())
}

// âœ… æ‰¹é‡å†™å…¥
async fn fast_write(data: Vec<String>) -> std::io::Result<()> {
    let file = tokio::fs::File::create("output.txt").await?;
    let mut writer = BufWriter::new(file);
    
    let batch = data.join("\n");
    writer.write_all(batch.as_bytes()).await?;
    
    Ok(())
}
```

---

## 6. é”ä¼˜åŒ–

### 6.1 å‡å°‘é”æŒæœ‰æ—¶é—´

```rust
use tokio::sync::Mutex;
use std::sync::Arc;

// âŒ é”æŒæœ‰æ—¶é—´è¿‡é•¿
async fn slow(data: Arc<Mutex<Vec<i32>>>) {
    let mut guard = data.lock().await;
    // æ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆæŒæœ‰é”ï¼‰
    tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
    guard.push(42);
}

// âœ… æœ€å°åŒ–é”æŒæœ‰æ—¶é—´
async fn fast(data: Arc<Mutex<Vec<i32>>>) {
    // å…ˆæ‰§è¡Œè€—æ—¶æ“ä½œ
    tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
    
    // å¿«é€Ÿè·å–é”å¹¶ä¿®æ”¹
    data.lock().await.push(42);
}
```

---

### 6.2 ä½¿ç”¨è¯»å†™é”

```rust
use tokio::sync::RwLock;
use std::sync::Arc;

#[tokio::main]
async fn main() {
    let data = Arc::new(RwLock::new(vec![1, 2, 3]));
    
    // å¤šä¸ªè¯»è€…å¯ä»¥å¹¶å‘è®¿é—®
    let read1 = data.read().await;
    let read2 = data.read().await;
    
    // åªæœ‰ä¸€ä¸ªå†™è€…
    drop(read1);
    drop(read2);
    let mut write = data.write().await;
    write.push(4);
}
```

---

## 7. æ€§èƒ½æµ‹é‡

### 7.1 ä½¿ç”¨ `tokio-console`

**å®‰è£…**:

```bash
cargo install tokio-console
```

**é…ç½®** (`Cargo.toml`):

```toml
[dependencies]
tokio = { version = "1", features = ["full", "tracing"] }
console-subscriber = "0.2"
```

**ä»£ç **:

```rust
fn main() {
    console_subscriber::init();
    
    tokio::runtime::Builder::new_multi_thread()
        .enable_all()
        .build()
        .unwrap()
        .block_on(async {
            // å¼‚æ­¥ä»£ç 
        });
}
```

**è¿è¡Œ**:

```bash
# ç»ˆç«¯1: è¿è¡Œç¨‹åº
cargo run

# ç»ˆç«¯2: å¯åŠ¨ç›‘æ§
tokio-console
```

---

### 7.2 ç«ç„°å›¾åˆ†æ

```bash
# å®‰è£…å·¥å…·
cargo install flamegraph

# ç”Ÿæˆç«ç„°å›¾
cargo flamegraph --bin my_app
```

---

## 8. ä¼˜åŒ–æ¸…å•

### 8.1 å¼€å‘é˜¶æ®µ

- âœ… ä½¿ç”¨ `join!` å¹¶å‘æ‰§è¡Œç‹¬ç«‹ä»»åŠ¡
- âœ… é¿å…åœ¨ `async` ä¸­è°ƒç”¨é˜»å¡å‡½æ•°
- âœ… ä½¿ç”¨ `impl Trait` é¿å… `Box`
- âœ… åˆç†è®¾ç½®é€šé“ç¼“å†²åŒºå¤§å°
- âœ… æ‰¹é‡å¤„ç†å‡å°‘ `spawn` æ¬¡æ•°

### 8.2 æµ‹è¯•é˜¶æ®µ

- âœ… ç¼–å†™åŸºå‡†æµ‹è¯•
- âœ… ä½¿ç”¨ `criterion` å¯¹æ¯”æ€§èƒ½
- âœ… æµ‹è¯• P99/P999 å»¶è¿Ÿ
- âœ… å‹åŠ›æµ‹è¯•éªŒè¯ç¨³å®šæ€§

### 8.3 ç”Ÿäº§é˜¶æ®µ

- âœ… å¯ç”¨ `tokio-console` ç›‘æ§
- âœ… æ”¶é›† Prometheus æŒ‡æ ‡
- âœ… å®šæœŸç”Ÿæˆç«ç„°å›¾
- âœ… ç›‘æ§å†…å­˜å’Œ CPU ä½¿ç”¨

---

## 9. æ¡ˆä¾‹ç ”ç©¶

### 9.1 HTTP æœåŠ¡å™¨ä¼˜åŒ–

**ä¼˜åŒ–å‰** (1000 req/s):

```rust
async fn handle_request(req: Request) -> Response {
    let data = fetch_from_db().await; // 50ms
    let result = process_data(data).await; // 30ms
    Response::new(result)
}
```

**ä¼˜åŒ–å** (5000 req/s):

```rust
async fn handle_request(req: Request) -> Response {
    // 1. å¹¶å‘è·å–æ•°æ®
    let (data1, data2) = tokio::join!(
        fetch_from_db(),
        fetch_from_cache(),
    );
    
    // 2. CPU å¯†é›†å‹å¤„ç†ä½¿ç”¨ spawn_blocking
    let result = tokio::task::spawn_blocking(move || {
        process_data_cpu_intensive(data1, data2)
    }).await.unwrap();
    
    Response::new(result)
}
```

**ä¼˜åŒ–æ•ˆæœ**: 5x ååé‡æå‡

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- **[Futureä¸Executoræœºåˆ¶](./02_Futureä¸Executoræœºåˆ¶.md)** - ç†è§£åŸç†
- **[å¼‚æ­¥è®¾è®¡æ¨¡å¼å®è·µ](./04_å¼‚æ­¥è®¾è®¡æ¨¡å¼å®è·µ.md)** - è®¾è®¡æ¨¡å¼
- **[æ€§èƒ½åŸºå‡†å‚è€ƒ](../tier_03_references/05_æ€§èƒ½åŸºå‡†å‚è€ƒ.md)** - è¯¦ç»†æ•°æ®

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯**:

- âœ… **å¹¶å‘**: ä½¿ç”¨ `join!` è€Œéé¡ºåº `.await`
- âœ… **å†…å­˜**: é¿å… `Box`ï¼Œä½¿ç”¨ `Bytes`ï¼Œå¯¹è±¡æ± 
- âœ… **CPU**: `spawn_blocking` å¤„ç†å¯†é›†ä»»åŠ¡
- âœ… **I/O**: å¤§ç¼“å†²åŒºï¼Œæ‰¹é‡æ“ä½œ
- âœ… **é”**: æœ€å°åŒ–æŒæœ‰æ—¶é—´ï¼Œä½¿ç”¨ `RwLock`

**æ€§èƒ½åˆ†æ**:

- âœ… `criterion` åŸºå‡†æµ‹è¯•
- âœ… `tokio-console` å®æ—¶ç›‘æ§
- âœ… ç«ç„°å›¾åˆ†æçƒ­ç‚¹

---

**æ–‡æ¡£ç»´æŠ¤**: C06 Async Team | **è´¨é‡è¯„åˆ†**: 95/100  
**æœ€åæ›´æ–°**: 2025-10-22 | **Rust ç‰ˆæœ¬**: 1.90+
