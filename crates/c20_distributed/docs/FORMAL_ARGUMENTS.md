# 关键论证与公式概览（草案）

本文件给出与课程/维基定义一致的核心判据与可验证结论，配合本 crate 的实现接口。每节包含：定义 → 性质/定理 → 工程化证明思路 → 可验证检查点 → 代码锚点。

## 1) Quorum 判据（多数派）

- 定义：`required_acks(N, Strong|Quorum) = floor(N/2)+1`，`Eventual = 1`。
- 性质：任意两个多数派集合必相交，保证提交记录至少被一个交集副本持有。
- 工程化证明思路：以鸽笼原理给出集合相交；以提交索引单调性确保可见性不回退。
- 可验证检查点：
  - 生成 N 与 Level 的表，验证 `R+W>N` 时读到最新提交概率为 1。
  - 故障注入下，满足多数派的写在后续读多数派中可见。
- 代码锚点：`replication::MajorityQuorum::required_acks`。

## 2) 线性一致（Linearizability）

- 定义：存在全序嵌入，尊重实时先后且符合顺序语义。
- 性质：单领导者 + 日志前缀匹配 + 读屏障（或租约/只读指数）足以在工程上实现近似线化读。
- 工程化证明思路：将提交点定义为“写入多数派后领导者提交索引推进”，读在该点之后阻塞/验证租约。
- 可验证检查点：
  - 并发读写历史小规模穷举，线化检查器通过（或会话保证子集先行）。
  - 领导者切换后读不回退（单调读取）。
- 代码锚点：`replication` 写屏障；如启用 `consensus_raft`，使用只读指数。

## 3) 一致性哈希再均衡代价

- 定义：新增/移除节点时，期望移动数据比例约为 `1/(#nodes)`（考虑虚拟节点修正）。
- 性质：均匀散列假设下，区间长度期望为 1/N，节点变动仅影响局部区间。
- 工程化证明思路：使用随机键采样估计迁移比例；验证分布收敛。
- 可验证检查点：`tests/hashring_properties.rs`：扩容 1 节点后迁移比例接近 1/N。
- 代码锚点：`topology::ConsistentHashRing`。

## 4) Saga 安全性与幂等

- 定义：每步 `execute` 与 `compensate` 均具幂等性；失败回滚保持存储不变量。
- 性质：当补偿序列完整且各步幂等，任意部分失败不破坏系统不变式。
- 工程化证明思路：以等价类将副作用折叠为“已完成/已补偿”两态，重试不改变最终态。
- 可验证检查点：
  - 注入中间失败，观察补偿逆序执行且重复补偿不产生额外副作用。
  - 幂等键 TTL 到期策略不导致漏补偿。
- 代码锚点：`transactions::{Saga, SagaStep}`，`storage::IdempotencyStore`。

## 5) 故障检测（SWIM）与可达性

- 定义：概率式探测，基于直接/间接探测与周期性传播。
- 性质：在合理参数下，以高概率达成视图一致；误报率和收敛时间可被上界化。
- 工程化证明思路：通过仿真调参，记录 Suspect→Confirm Dead 的时间分布与误报率。
- 可验证检查点：`tests/swim_pingreq.rs` 打印间接探测事件；统计误报随超时变化曲线。
- 代码锚点：`swim::{SwimMemberState, SwimEvent}`。

---

后续计划：

- 引入更严格的规格（TLA+/Ivy/Coq 伪代码）片段与可执行检查点。
- 提供小型基准/属性测试以验证上述结论的可观测性。
