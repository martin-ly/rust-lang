# 03. æ‰€æœ‰æƒä¸æ§åˆ¶æµ (Ownership and Control Flow)

> **æ–‡æ¡£ç±»å‹**ï¼šç†è®º  
> **éš¾åº¦ç­‰çº§**ï¼šâ­â­â­â­  
> **é¢„è®¡é˜…è¯»æ—¶é—´**ï¼š3-4å°æ—¶  
> **å‰ç½®çŸ¥è¯†**ï¼šRust æ‰€æœ‰æƒç³»ç»ŸåŸºç¡€ã€å€Ÿç”¨è§„åˆ™ã€ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µ

## ç›®å½•

- [03. æ‰€æœ‰æƒä¸æ§åˆ¶æµ (Ownership and Control Flow)](#03-æ‰€æœ‰æƒä¸æ§åˆ¶æµ-ownership-and-control-flow)
  - [ç›®å½•](#ç›®å½•)
  - [ğŸ“– å†…å®¹æ¦‚è¿°](#-å†…å®¹æ¦‚è¿°)
  - [ğŸ¯ å­¦ä¹ ç›®æ ‡](#-å­¦ä¹ ç›®æ ‡)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. æ‰€æœ‰æƒç³»ç»Ÿå›é¡¾](#1-æ‰€æœ‰æƒç³»ç»Ÿå›é¡¾)
    - [1.1. æ‰€æœ‰æƒä¸‰åŸåˆ™](#11-æ‰€æœ‰æƒä¸‰åŸåˆ™)
      - [å½¢å¼åŒ–æè¿°](#å½¢å¼åŒ–æè¿°)
      - [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
    - [1.2. å€Ÿç”¨è§„åˆ™](#12-å€Ÿç”¨è§„åˆ™)
      - [1.2.1 å½¢å¼åŒ–çº¦æŸ](#121-å½¢å¼åŒ–çº¦æŸ)
      - [1.2.2 ä»£ç ç¤ºä¾‹](#122-ä»£ç ç¤ºä¾‹)
    - [1.3. ç”Ÿå‘½å‘¨æœŸ](#13-ç”Ÿå‘½å‘¨æœŸ)
      - [1.3.1 ç”Ÿå‘½å‘¨æœŸæ¨æ–­è§„åˆ™](#131-ç”Ÿå‘½å‘¨æœŸæ¨æ–­è§„åˆ™)
      - [1.3.2 ä»£ç ç¤ºä¾‹](#132-ä»£ç ç¤ºä¾‹)
  - [2. æ§åˆ¶æµä¸­çš„æ‰€æœ‰æƒè½¬ç§»](#2-æ§åˆ¶æµä¸­çš„æ‰€æœ‰æƒè½¬ç§»)
    - [2.1. æ¡ä»¶åˆ†æ”¯ä¸­çš„ç§»åŠ¨](#21-æ¡ä»¶åˆ†æ”¯ä¸­çš„ç§»åŠ¨)
      - [ç§»åŠ¨è¯­ä¹‰åˆ†æ](#ç§»åŠ¨è¯­ä¹‰åˆ†æ)
      - [å½¢å¼åŒ–åˆ†æ](#å½¢å¼åŒ–åˆ†æ)
    - [2.2. æ¨¡å¼åŒ¹é…ä¸­çš„æ‰€æœ‰æƒ](#22-æ¨¡å¼åŒ¹é…ä¸­çš„æ‰€æœ‰æƒ)
      - [é»˜è®¤ç§»åŠ¨æ¨¡å¼](#é»˜è®¤ç§»åŠ¨æ¨¡å¼)
      - [å¼•ç”¨æ¨¡å¼ï¼ˆé¿å…ç§»åŠ¨ï¼‰](#å¼•ç”¨æ¨¡å¼é¿å…ç§»åŠ¨)
      - [ref å’Œ ref mut æ¨¡å¼](#ref-å’Œ-ref-mut-æ¨¡å¼)
    - [2.3. å¾ªç¯ä¸­çš„æ‰€æœ‰æƒ](#23-å¾ªç¯ä¸­çš„æ‰€æœ‰æƒ)
      - [å¾ªç¯å˜é‡çš„æ‰€æœ‰æƒ](#å¾ªç¯å˜é‡çš„æ‰€æœ‰æƒ)
      - [å¾ªç¯ä¸­çš„å¯å˜å€Ÿç”¨](#å¾ªç¯ä¸­çš„å¯å˜å€Ÿç”¨)
  - [3. å€Ÿç”¨æ£€æŸ¥å™¨ä¸æ§åˆ¶æµ](#3-å€Ÿç”¨æ£€æŸ¥å™¨ä¸æ§åˆ¶æµ)
    - [3.1. è·¯å¾„æ•æ„Ÿåˆ†æ](#31-è·¯å¾„æ•æ„Ÿåˆ†æ)
      - [3.1.1 åˆ†æè¿‡ç¨‹](#311-åˆ†æè¿‡ç¨‹)
      - [3.1.2 ä»£ç ç¤ºä¾‹](#312-ä»£ç ç¤ºä¾‹)
      - [è·¯å¾„åˆå¹¶çš„å€Ÿç”¨å†²çª](#è·¯å¾„åˆå¹¶çš„å€Ÿç”¨å†²çª)
    - [3.2. å€Ÿç”¨ä½œç”¨åŸŸ](#32-å€Ÿç”¨ä½œç”¨åŸŸ)
      - [NLL ä¹‹å‰çš„å€Ÿç”¨è§„åˆ™](#nll-ä¹‹å‰çš„å€Ÿç”¨è§„åˆ™)
      - [NLL ä¹‹åçš„å€Ÿç”¨è§„åˆ™](#nll-ä¹‹åçš„å€Ÿç”¨è§„åˆ™)
    - [3.3. éè¯æ³•ç”Ÿå‘½å‘¨æœŸ (NLL)](#33-éè¯æ³•ç”Ÿå‘½å‘¨æœŸ-nll)
      - [NLL çš„ä¼˜åŠ¿](#nll-çš„ä¼˜åŠ¿)
      - [NLL ç¤ºä¾‹](#nll-ç¤ºä¾‹)
      - [NLL çš„å½¢å¼åŒ–](#nll-çš„å½¢å¼åŒ–)
  - [4. åˆ†æ”¯é—´çš„å€Ÿç”¨å†²çª](#4-åˆ†æ”¯é—´çš„å€Ÿç”¨å†²çª)
    - [4.1. å¯å˜å€Ÿç”¨å†²çª](#41-å¯å˜å€Ÿç”¨å†²çª)
      - [é—®é¢˜åœºæ™¯](#é—®é¢˜åœºæ™¯)
      - [è§£å†³æ–¹æ¡ˆ 1ï¼šé™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ](#è§£å†³æ–¹æ¡ˆ-1é™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ)
      - [è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ç´¢å¼•è€Œéå¼•ç”¨](#è§£å†³æ–¹æ¡ˆ-2ä½¿ç”¨ç´¢å¼•è€Œéå¼•ç”¨)
      - [è§£å†³æ–¹æ¡ˆ 3ï¼šåˆ†å‰²å€Ÿç”¨ (Split Borrowing)](#è§£å†³æ–¹æ¡ˆ-3åˆ†å‰²å€Ÿç”¨-split-borrowing)
    - [4.2. å¼•ç”¨ç”Ÿå‘½å‘¨æœŸå†²çª](#42-å¼•ç”¨ç”Ÿå‘½å‘¨æœŸå†²çª)
      - [4.2.1 é—®é¢˜åœºæ™¯](#421-é—®é¢˜åœºæ™¯)
      - [è§£å†³æ–¹æ¡ˆï¼šè¿”å›æ‰€æœ‰æƒ](#è§£å†³æ–¹æ¡ˆè¿”å›æ‰€æœ‰æƒ)
    - [4.3. è§£å†³ç­–ç•¥](#43-è§£å†³ç­–ç•¥)
  - [5. ç±»å‹çŠ¶æ€æ¨¡å¼](#5-ç±»å‹çŠ¶æ€æ¨¡å¼)
    - [5.1. æ ¸å¿ƒæ¦‚å¿µ](#51-æ ¸å¿ƒæ¦‚å¿µ)
      - [è®¾è®¡æ€æƒ³](#è®¾è®¡æ€æƒ³)
      - [å½¢å¼åŒ–è¡¨ç¤º](#å½¢å¼åŒ–è¡¨ç¤º)
    - [5.2. å®ç°æœºåˆ¶](#52-å®ç°æœºåˆ¶)
      - [åŸºæœ¬å®ç°](#åŸºæœ¬å®ç°)
    - [5.3. å®è·µåº”ç”¨](#53-å®è·µåº”ç”¨)
      - [åº”ç”¨ 1ï¼šæ•°æ®åº“è¿æ¥çŠ¶æ€](#åº”ç”¨-1æ•°æ®åº“è¿æ¥çŠ¶æ€)
      - [åº”ç”¨ 2ï¼šèµ„æºè®¿é—®æ§åˆ¶](#åº”ç”¨-2èµ„æºè®¿é—®æ§åˆ¶)
  - [6. é«˜çº§ä¸»é¢˜](#6-é«˜çº§ä¸»é¢˜)
    - [6.1. é—­åŒ…æ•è·ä¸æ‰€æœ‰æƒ](#61-é—­åŒ…æ•è·ä¸æ‰€æœ‰æƒ)
      - [æ•è·æ¨¡å¼](#æ•è·æ¨¡å¼)
    - [6.2. å¼‚æ­¥æ§åˆ¶æµä¸­çš„ç”Ÿå‘½å‘¨æœŸ](#62-å¼‚æ­¥æ§åˆ¶æµä¸­çš„ç”Ÿå‘½å‘¨æœŸ)
      - [å¼‚æ­¥å—ä¸­çš„å¼•ç”¨](#å¼‚æ­¥å—ä¸­çš„å¼•ç”¨)
    - [6.3. å†…éƒ¨å¯å˜æ€§æ¨¡å¼](#63-å†…éƒ¨å¯å˜æ€§æ¨¡å¼)
      - [RefCell çš„ä½¿ç”¨](#refcell-çš„ä½¿ç”¨)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
  - [8. æ€»ç»“](#8-æ€»ç»“)
    - [å…³é”®è¦ç‚¹](#å…³é”®è¦ç‚¹)
    - [æƒè¡¡åˆ†æ](#æƒè¡¡åˆ†æ)
  - [ğŸ“š ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [æ‰©å±•é˜…è¯»](#æ‰©å±•é˜…è¯»)
    - [å®˜æ–¹èµ„æº](#å®˜æ–¹èµ„æº)
  - [ğŸ“ å®è·µç»ƒä¹ ](#-å®è·µç»ƒä¹ )
    - [åŸºç¡€ç»ƒä¹ ](#åŸºç¡€ç»ƒä¹ )
    - [è¿›é˜¶ç»ƒä¹ ](#è¿›é˜¶ç»ƒä¹ )
    - [æŒ‘æˆ˜ç»ƒä¹ ](#æŒ‘æˆ˜ç»ƒä¹ )
  - [ğŸ’¬ å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)

## ğŸ“– å†…å®¹æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥æ¢è®¨ Rust æ‰€æœ‰æƒç³»ç»Ÿä¸æ§åˆ¶æµçš„é›†æˆæœºåˆ¶ï¼Œåˆ†æå€Ÿç”¨æ£€æŸ¥å™¨å¦‚ä½•åœ¨æ§åˆ¶æµä¸­å·¥ä½œï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ç±»å‹ç³»ç»Ÿå®ç°ç¼–è¯‘æ—¶çš„å†…å­˜å®‰å…¨ä¿è¯ã€‚æ–‡æ¡£æ¶µç›–æ‰€æœ‰æƒè½¬ç§»ã€å€Ÿç”¨ä¼ æ’­ã€ç”Ÿå‘½å‘¨æœŸæ¨æ–­ç­‰æ ¸å¿ƒä¸»é¢˜ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ–‡æ¡£å­¦ä¹ åï¼Œä½ å°†èƒ½å¤Ÿï¼š

- [ ] ç†è§£æ‰€æœ‰æƒåœ¨æ§åˆ¶æµä¸­çš„è½¬ç§»æœºåˆ¶
- [ ] æŒæ¡å€Ÿç”¨æ£€æŸ¥å™¨çš„è·¯å¾„æ•æ„Ÿåˆ†æ
- [ ] ç†è§£ç”Ÿå‘½å‘¨æœŸåœ¨æ§åˆ¶æµä¸­çš„æ¨æ–­è§„åˆ™
- [ ] æŒæ¡æ§åˆ¶æµä¸­çš„å€Ÿç”¨å†²çªè§£å†³æ–¹æ³•
- [ ] åº”ç”¨ç±»å‹çŠ¶æ€æ¨¡å¼å®ç°ç¼–è¯‘æ—¶è®¿é—®æ§åˆ¶

## ğŸ“š ç›®å½•

- [03. æ‰€æœ‰æƒä¸æ§åˆ¶æµ (Ownership and Control Flow)](#03-æ‰€æœ‰æƒä¸æ§åˆ¶æµ-ownership-and-control-flow)
  - [ç›®å½•](#ç›®å½•)
  - [ğŸ“– å†…å®¹æ¦‚è¿°](#-å†…å®¹æ¦‚è¿°)
  - [ğŸ¯ å­¦ä¹ ç›®æ ‡](#-å­¦ä¹ ç›®æ ‡)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. æ‰€æœ‰æƒç³»ç»Ÿå›é¡¾](#1-æ‰€æœ‰æƒç³»ç»Ÿå›é¡¾)
    - [1.1. æ‰€æœ‰æƒä¸‰åŸåˆ™](#11-æ‰€æœ‰æƒä¸‰åŸåˆ™)
      - [å½¢å¼åŒ–æè¿°](#å½¢å¼åŒ–æè¿°)
      - [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
    - [1.2. å€Ÿç”¨è§„åˆ™](#12-å€Ÿç”¨è§„åˆ™)
      - [1.2.1 å½¢å¼åŒ–çº¦æŸ](#121-å½¢å¼åŒ–çº¦æŸ)
      - [1.2.2 ä»£ç ç¤ºä¾‹](#122-ä»£ç ç¤ºä¾‹)
    - [1.3. ç”Ÿå‘½å‘¨æœŸ](#13-ç”Ÿå‘½å‘¨æœŸ)
      - [1.3.1 ç”Ÿå‘½å‘¨æœŸæ¨æ–­è§„åˆ™](#131-ç”Ÿå‘½å‘¨æœŸæ¨æ–­è§„åˆ™)
      - [1.3.2 ä»£ç ç¤ºä¾‹](#132-ä»£ç ç¤ºä¾‹)
  - [2. æ§åˆ¶æµä¸­çš„æ‰€æœ‰æƒè½¬ç§»](#2-æ§åˆ¶æµä¸­çš„æ‰€æœ‰æƒè½¬ç§»)
    - [2.1. æ¡ä»¶åˆ†æ”¯ä¸­çš„ç§»åŠ¨](#21-æ¡ä»¶åˆ†æ”¯ä¸­çš„ç§»åŠ¨)
      - [ç§»åŠ¨è¯­ä¹‰åˆ†æ](#ç§»åŠ¨è¯­ä¹‰åˆ†æ)
      - [å½¢å¼åŒ–åˆ†æ](#å½¢å¼åŒ–åˆ†æ)
    - [2.2. æ¨¡å¼åŒ¹é…ä¸­çš„æ‰€æœ‰æƒ](#22-æ¨¡å¼åŒ¹é…ä¸­çš„æ‰€æœ‰æƒ)
      - [é»˜è®¤ç§»åŠ¨æ¨¡å¼](#é»˜è®¤ç§»åŠ¨æ¨¡å¼)
      - [å¼•ç”¨æ¨¡å¼ï¼ˆé¿å…ç§»åŠ¨ï¼‰](#å¼•ç”¨æ¨¡å¼é¿å…ç§»åŠ¨)
      - [ref å’Œ ref mut æ¨¡å¼](#ref-å’Œ-ref-mut-æ¨¡å¼)
    - [2.3. å¾ªç¯ä¸­çš„æ‰€æœ‰æƒ](#23-å¾ªç¯ä¸­çš„æ‰€æœ‰æƒ)
      - [å¾ªç¯å˜é‡çš„æ‰€æœ‰æƒ](#å¾ªç¯å˜é‡çš„æ‰€æœ‰æƒ)
      - [å¾ªç¯ä¸­çš„å¯å˜å€Ÿç”¨](#å¾ªç¯ä¸­çš„å¯å˜å€Ÿç”¨)
  - [3. å€Ÿç”¨æ£€æŸ¥å™¨ä¸æ§åˆ¶æµ](#3-å€Ÿç”¨æ£€æŸ¥å™¨ä¸æ§åˆ¶æµ)
    - [3.1. è·¯å¾„æ•æ„Ÿåˆ†æ](#31-è·¯å¾„æ•æ„Ÿåˆ†æ)
      - [3.1.1 åˆ†æè¿‡ç¨‹](#311-åˆ†æè¿‡ç¨‹)
      - [3.1.2 ä»£ç ç¤ºä¾‹](#312-ä»£ç ç¤ºä¾‹)
      - [è·¯å¾„åˆå¹¶çš„å€Ÿç”¨å†²çª](#è·¯å¾„åˆå¹¶çš„å€Ÿç”¨å†²çª)
    - [3.2. å€Ÿç”¨ä½œç”¨åŸŸ](#32-å€Ÿç”¨ä½œç”¨åŸŸ)
      - [NLL ä¹‹å‰çš„å€Ÿç”¨è§„åˆ™](#nll-ä¹‹å‰çš„å€Ÿç”¨è§„åˆ™)
      - [NLL ä¹‹åçš„å€Ÿç”¨è§„åˆ™](#nll-ä¹‹åçš„å€Ÿç”¨è§„åˆ™)
    - [3.3. éè¯æ³•ç”Ÿå‘½å‘¨æœŸ (NLL)](#33-éè¯æ³•ç”Ÿå‘½å‘¨æœŸ-nll)
      - [NLL çš„ä¼˜åŠ¿](#nll-çš„ä¼˜åŠ¿)
      - [NLL ç¤ºä¾‹](#nll-ç¤ºä¾‹)
      - [NLL çš„å½¢å¼åŒ–](#nll-çš„å½¢å¼åŒ–)
  - [4. åˆ†æ”¯é—´çš„å€Ÿç”¨å†²çª](#4-åˆ†æ”¯é—´çš„å€Ÿç”¨å†²çª)
    - [4.1. å¯å˜å€Ÿç”¨å†²çª](#41-å¯å˜å€Ÿç”¨å†²çª)
      - [é—®é¢˜åœºæ™¯](#é—®é¢˜åœºæ™¯)
      - [è§£å†³æ–¹æ¡ˆ 1ï¼šé™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ](#è§£å†³æ–¹æ¡ˆ-1é™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ)
      - [è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ç´¢å¼•è€Œéå¼•ç”¨](#è§£å†³æ–¹æ¡ˆ-2ä½¿ç”¨ç´¢å¼•è€Œéå¼•ç”¨)
      - [è§£å†³æ–¹æ¡ˆ 3ï¼šåˆ†å‰²å€Ÿç”¨ (Split Borrowing)](#è§£å†³æ–¹æ¡ˆ-3åˆ†å‰²å€Ÿç”¨-split-borrowing)
    - [4.2. å¼•ç”¨ç”Ÿå‘½å‘¨æœŸå†²çª](#42-å¼•ç”¨ç”Ÿå‘½å‘¨æœŸå†²çª)
      - [4.2.1 é—®é¢˜åœºæ™¯](#421-é—®é¢˜åœºæ™¯)
      - [è§£å†³æ–¹æ¡ˆï¼šè¿”å›æ‰€æœ‰æƒ](#è§£å†³æ–¹æ¡ˆè¿”å›æ‰€æœ‰æƒ)
    - [4.3. è§£å†³ç­–ç•¥](#43-è§£å†³ç­–ç•¥)
  - [5. ç±»å‹çŠ¶æ€æ¨¡å¼](#5-ç±»å‹çŠ¶æ€æ¨¡å¼)
    - [5.1. æ ¸å¿ƒæ¦‚å¿µ](#51-æ ¸å¿ƒæ¦‚å¿µ)
      - [è®¾è®¡æ€æƒ³](#è®¾è®¡æ€æƒ³)
      - [å½¢å¼åŒ–è¡¨ç¤º](#å½¢å¼åŒ–è¡¨ç¤º)
    - [5.2. å®ç°æœºåˆ¶](#52-å®ç°æœºåˆ¶)
      - [åŸºæœ¬å®ç°](#åŸºæœ¬å®ç°)
    - [5.3. å®è·µåº”ç”¨](#53-å®è·µåº”ç”¨)
      - [åº”ç”¨ 1ï¼šæ•°æ®åº“è¿æ¥çŠ¶æ€](#åº”ç”¨-1æ•°æ®åº“è¿æ¥çŠ¶æ€)
      - [åº”ç”¨ 2ï¼šèµ„æºè®¿é—®æ§åˆ¶](#åº”ç”¨-2èµ„æºè®¿é—®æ§åˆ¶)
  - [6. é«˜çº§ä¸»é¢˜](#6-é«˜çº§ä¸»é¢˜)
    - [6.1. é—­åŒ…æ•è·ä¸æ‰€æœ‰æƒ](#61-é—­åŒ…æ•è·ä¸æ‰€æœ‰æƒ)
      - [æ•è·æ¨¡å¼](#æ•è·æ¨¡å¼)
    - [6.2. å¼‚æ­¥æ§åˆ¶æµä¸­çš„ç”Ÿå‘½å‘¨æœŸ](#62-å¼‚æ­¥æ§åˆ¶æµä¸­çš„ç”Ÿå‘½å‘¨æœŸ)
      - [å¼‚æ­¥å—ä¸­çš„å¼•ç”¨](#å¼‚æ­¥å—ä¸­çš„å¼•ç”¨)
    - [6.3. å†…éƒ¨å¯å˜æ€§æ¨¡å¼](#63-å†…éƒ¨å¯å˜æ€§æ¨¡å¼)
      - [RefCell çš„ä½¿ç”¨](#refcell-çš„ä½¿ç”¨)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
  - [8. æ€»ç»“](#8-æ€»ç»“)
    - [å…³é”®è¦ç‚¹](#å…³é”®è¦ç‚¹)
    - [æƒè¡¡åˆ†æ](#æƒè¡¡åˆ†æ)
  - [ğŸ“š ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [æ‰©å±•é˜…è¯»](#æ‰©å±•é˜…è¯»)
    - [å®˜æ–¹èµ„æº](#å®˜æ–¹èµ„æº)
  - [ğŸ“ å®è·µç»ƒä¹ ](#-å®è·µç»ƒä¹ )
    - [åŸºç¡€ç»ƒä¹ ](#åŸºç¡€ç»ƒä¹ )
    - [è¿›é˜¶ç»ƒä¹ ](#è¿›é˜¶ç»ƒä¹ )
    - [æŒ‘æˆ˜ç»ƒä¹ ](#æŒ‘æˆ˜ç»ƒä¹ )
  - [ğŸ’¬ å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)

---

## 1. æ‰€æœ‰æƒç³»ç»Ÿå›é¡¾

### 1.1. æ‰€æœ‰æƒä¸‰åŸåˆ™

Rust çš„æ‰€æœ‰æƒç³»ç»Ÿå»ºç«‹åœ¨ä¸‰ä¸ªæ ¸å¿ƒåŸåˆ™ä¹‹ä¸Šï¼š

1. **å”¯ä¸€æ‰€æœ‰è€…**ï¼šæ¯ä¸ªå€¼éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
2. **ä½œç”¨åŸŸè§„åˆ™**ï¼šå½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå€¼è¢«è‡ªåŠ¨é‡Šæ”¾
3. **ç§»åŠ¨è¯­ä¹‰**ï¼šèµ‹å€¼æˆ–ä¼ å‚ä¼šè½¬ç§»æ‰€æœ‰æƒï¼ˆå¯¹äºé Copy ç±»å‹ï¼‰

#### å½¢å¼åŒ–æè¿°

è®¾ \( v \) æ˜¯ä¸€ä¸ªå€¼ï¼Œ\( o \) æ˜¯å…¶æ‰€æœ‰è€…ï¼Œåˆ™æœ‰ï¼š

\[
\forall v : \exists! o : \text{owns}(o, v)
\]

> ğŸ“š **è§£é‡Š**ï¼šå¯¹äºä»»æ„å€¼ vï¼Œå­˜åœ¨å”¯ä¸€çš„æ‰€æœ‰è€… oã€‚

#### ä»£ç ç¤ºä¾‹

```rust
// æ‰€æœ‰æƒè½¬ç§»ç¤ºä¾‹
fn ownership_transfer() {
    let s1 = String::from("hello");  // s1 æ‹¥æœ‰å­—ç¬¦ä¸²
    let s2 = s1;                      // æ‰€æœ‰æƒè½¬ç§»ç»™ s2
    
    // println!("{}", s1);  // âŒ é”™è¯¯ï¼šs1 å·²å¤±å»æ‰€æœ‰æƒ
    println!("{}", s2);     // âœ… æ­£ç¡®ï¼šs2 æ˜¯å½“å‰æ‰€æœ‰è€…
}  // s2 ç¦»å¼€ä½œç”¨åŸŸï¼Œå­—ç¬¦ä¸²è¢«é‡Šæ”¾
```

### 1.2. å€Ÿç”¨è§„åˆ™

å€Ÿç”¨å…è®¸åœ¨ä¸è½¬ç§»æ‰€æœ‰æƒçš„æƒ…å†µä¸‹è®¿é—®æ•°æ®ï¼š

1. **å…±äº«å€Ÿç”¨ (`&T`)**ï¼šå¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨
2. **ç‹¬å å€Ÿç”¨ (`&mut T`)**ï¼šåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨
3. **äº’æ–¥è§„åˆ™**ï¼šå¯å˜å€Ÿç”¨ä¸ä¸å¯å˜å€Ÿç”¨ä¸èƒ½å…±å­˜

#### 1.2.1 å½¢å¼åŒ–çº¦æŸ

\[
\text{å€Ÿç”¨è§„åˆ™} =
\begin{cases}
\text{å¤šä¸ªä¸å¯å˜å€Ÿç”¨} &\lor \\
\text{ä¸€ä¸ªå¯å˜å€Ÿç”¨} &\land \\
\text{ä¸å¯å˜å€Ÿç”¨} \cap \text{å¯å˜å€Ÿç”¨} = \emptyset
\end{cases}
\]

#### 1.2.2 ä»£ç ç¤ºä¾‹

```rust
fn borrowing_rules() {
    let mut data = vec![1, 2, 3];
    
    // âœ… å¤šä¸ªä¸å¯å˜å€Ÿç”¨
    let r1 = &data;
    let r2 = &data;
    println!("{:?} {:?}", r1, r2);
    
    // âœ… ä¸€ä¸ªå¯å˜å€Ÿç”¨
    let r3 = &mut data;
    r3.push(4);
    
    // âŒ é”™è¯¯ï¼šå¯å˜å€Ÿç”¨å­˜åœ¨æ—¶ä¸èƒ½åˆ›å»ºä¸å¯å˜å€Ÿç”¨
    // let r4 = &data;
    // r3.push(5);
}
```

### 1.3. ç”Ÿå‘½å‘¨æœŸ

ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨äº†å¼•ç”¨çš„æœ‰æ•ˆèŒƒå›´ï¼Œç¡®ä¿å¼•ç”¨ä¸ä¼šè¶…è¿‡è¢«å¼•ç”¨æ•°æ®çš„ç”Ÿå­˜æœŸã€‚

#### 1.3.1 ç”Ÿå‘½å‘¨æœŸæ¨æ–­è§„åˆ™

ç¼–è¯‘å™¨ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¨æ–­ç”Ÿå‘½å‘¨æœŸï¼š

1. **è¾“å…¥ç”Ÿå‘½å‘¨æœŸ**ï¼šæ¯ä¸ªå¼•ç”¨å‚æ•°éƒ½æœ‰ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸ
2. **è¾“å‡ºç”Ÿå‘½å‘¨æœŸ**ï¼š
   - å•ä¸ªè¾“å…¥å¼•ç”¨ï¼šè¾“å‡ºç»§æ‰¿è¯¥ç”Ÿå‘½å‘¨æœŸ
   - å¤šä¸ªè¾“å…¥å¼•ç”¨ï¼šéœ€è¦æ˜¾å¼æ ‡æ³¨

#### 1.3.2 ä»£ç ç¤ºä¾‹

```rust
// ç”Ÿå‘½å‘¨æœŸæ¨æ–­
fn first_word(s: &str) -> &str {  // éšå¼ç”Ÿå‘½å‘¨æœŸï¼šfn first_word<'a>(s: &'a str) -> &'a str
    s.split_whitespace().next().unwrap_or("")
}

// æ˜¾å¼ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() {
        x
    } else {
        y
    }
}
```

## 2. æ§åˆ¶æµä¸­çš„æ‰€æœ‰æƒè½¬ç§»

### 2.1. æ¡ä»¶åˆ†æ”¯ä¸­çš„ç§»åŠ¨

#### ç§»åŠ¨è¯­ä¹‰åˆ†æ

åœ¨ if è¡¨è¾¾å¼ä¸­ï¼Œæ‰€æœ‰æƒå¯èƒ½åœ¨ä¸åŒåˆ†æ”¯ä¸­è½¬ç§»ï¼š

**æƒ…å†µ 1ï¼šå®Œå…¨ç§»åŠ¨**:

```rust
fn move_in_if(flag: bool) {
    let data = String::from("hello");
    
    let result = if flag {
        data  // æ‰€æœ‰æƒç§»åŠ¨åˆ° result
    } else {
        String::from("world")  // åˆ›å»ºæ–°å€¼
    };
    
    // âŒ é”™è¯¯ï¼šdata å·²è¢«ç§»åŠ¨ï¼ˆå¦‚æœ flag ä¸º trueï¼‰
    // println!("{}", data);
    
    println!("{}", result);  // âœ… æ­£ç¡®
}
```

**æƒ…å†µ 2ï¼šéƒ¨åˆ†ç§»åŠ¨**:

```rust
struct Container {
    value: String,
    count: i32,
}

fn partial_move(flag: bool, mut container: Container) {
    let extracted = if flag {
        container.value  // åªç§»åŠ¨ value å­—æ®µ
    } else {
        String::from("default")
    };
    
    // âœ… å¯ä»¥è®¿é—®æœªç§»åŠ¨çš„å­—æ®µ
    println!("Count: {}", container.count);
    
    // âŒ é”™è¯¯ï¼švalue å·²è¢«ç§»åŠ¨
    // println!("Value: {}", container.value);
}
```

#### å½¢å¼åŒ–åˆ†æ

å¯¹äº if è¡¨è¾¾å¼ \( E_{if} = \text{if } c \text{ then } e_t \text{ else } e_f \)ï¼š

\[
\text{moved}(E_{if}) =
\begin{cases}
\text{moved}(e_t) \cup \text{moved}(e_f) & \text{if both branches move} \\
\emptyset & \text{otherwise}
\end{cases}
\]

### 2.2. æ¨¡å¼åŒ¹é…ä¸­çš„æ‰€æœ‰æƒ

match è¡¨è¾¾å¼æä¾›äº†æ›´ç»†ç²’åº¦çš„æ‰€æœ‰æƒæ§åˆ¶ï¼š

#### é»˜è®¤ç§»åŠ¨æ¨¡å¼

```rust
enum Message {
    Quit,
    Move { x: i32, y: i32 },
    Write(String),
}

fn match_move(msg: Message) {
    match msg {
        Message::Quit => println!("é€€å‡º"),
        Message::Move { x, y } => println!("ç§»åŠ¨åˆ° ({}, {})", x, y),
        Message::Write(text) => {
            println!("å†™å…¥: {}", text);
            // text çš„æ‰€æœ‰æƒè¢«ç§»åŠ¨åˆ°è¿™é‡Œ
        }
    }
    
    // âŒ é”™è¯¯ï¼šmsg å·²è¢«æ¶ˆè€—
    // let _ = msg;
}
```

#### å¼•ç”¨æ¨¡å¼ï¼ˆé¿å…ç§»åŠ¨ï¼‰

```rust
fn match_borrow(msg: &Message) {
    match msg {
        Message::Quit => println!("é€€å‡º"),
        Message::Move { x, y } => println!("ç§»åŠ¨åˆ° ({}, {})", x, y),
        Message::Write(text) => {
            println!("å†™å…¥: {}", text);
            // text æ˜¯ &Stringï¼Œæ²¡æœ‰ç§»åŠ¨æ‰€æœ‰æƒ
        }
    }
    
    // âœ… æ­£ç¡®ï¼šmsg ä»ç„¶å¯ç”¨
    println!("å¤„ç†å®Œæˆ");
}
```

#### ref å’Œ ref mut æ¨¡å¼

```rust
fn match_ref_patterns(mut msg: Message) {
    match msg {
        // ref åˆ›å»ºä¸å¯å˜å¼•ç”¨ï¼Œé¿å…ç§»åŠ¨
        Message::Write(ref text) => {
            println!("å¼•ç”¨: {}", text);
            // text æ˜¯ &String
        }
        
        // ref mut åˆ›å»ºå¯å˜å¼•ç”¨
        Message::Move { ref mut x, ref mut y } => {
            *x += 10;
            *y += 10;
        }
        
        _ => {}
    }
    
    // âœ… msg ä»ç„¶æœ‰æ•ˆï¼ˆå› ä¸ºä½¿ç”¨äº† refï¼‰
}
```

### 2.3. å¾ªç¯ä¸­çš„æ‰€æœ‰æƒ

#### å¾ªç¯å˜é‡çš„æ‰€æœ‰æƒ

```rust
fn loop_ownership() {
    let data = vec![
        String::from("a"),
        String::from("b"),
        String::from("c"),
    ];
    
    // âŒ é”™è¯¯ï¼šç§»åŠ¨æ‰€æœ‰æƒ
    // for item in data {
    //     println!("{}", item);
    // }
    // println!("{:?}", data);  // data å·²è¢«ç§»åŠ¨
    
    // âœ… æ­£ç¡®ï¼šå€Ÿç”¨
    for item in &data {
        println!("{}", item);
    }
    println!("{:?}", data);  // data ä»ç„¶æœ‰æ•ˆ
}
```

#### å¾ªç¯ä¸­çš„å¯å˜å€Ÿç”¨

```rust
fn loop_mut_borrow() {
    let mut data = vec![1, 2, 3];
    
    // å¯å˜å€Ÿç”¨åœ¨å¾ªç¯ä¸­
    for item in &mut data {
        *item *= 2;
    }
    
    println!("{:?}", data);  // [2, 4, 6]
}
```

## 3. å€Ÿç”¨æ£€æŸ¥å™¨ä¸æ§åˆ¶æµ

### 3.1. è·¯å¾„æ•æ„Ÿåˆ†æ

å€Ÿç”¨æ£€æŸ¥å™¨æ‰§è¡Œ**è·¯å¾„æ•æ„Ÿåˆ†æ (Path-Sensitive Analysis)**ï¼Œè·Ÿè¸ªæ¯æ¡æ‰§è¡Œè·¯å¾„ä¸Šçš„å€Ÿç”¨çŠ¶æ€ã€‚

#### 3.1.1 åˆ†æè¿‡ç¨‹

1. **æ„å»ºæ§åˆ¶æµå›¾ (CFG)**

   ```text
   S0 (å¼€å§‹)
     |
     v
   [æ¡ä»¶åˆ¤æ–­]
     |
     â”œâ”€ true â†’ S1 â†’ S_merge
     |
     â””â”€ false â†’ S2 â†’ S_merge
                        |
                        v
                      S_end
   ```

2. **å€Ÿç”¨ä¼ æ’­**ï¼šè·Ÿè¸ªæ¯ä¸ªè·¯å¾„ä¸Šçš„å€Ÿç”¨åˆ›å»ºå’Œé”€æ¯

3. **åˆå¹¶ç‚¹åˆ†æ**ï¼šæ£€æŸ¥è·¯å¾„åˆå¹¶ç‚¹çš„å€Ÿç”¨çŠ¶æ€ä¸€è‡´æ€§

#### 3.1.2 ä»£ç ç¤ºä¾‹

```rust
fn path_sensitive_analysis(flag: bool, data: &mut Vec<i32>) {
    if flag {
        // è·¯å¾„ 1ï¼šåˆ›å»ºå€Ÿç”¨
        let r = &data[0];
        println!("{}", r);
        // r çš„å€Ÿç”¨åœ¨è¿™é‡Œç»“æŸ
    } else {
        // è·¯å¾„ 2ï¼šåˆ›å»ºå¦ä¸€ä¸ªå€Ÿç”¨
        let r = &data[1];
        println!("{}", r);
        // r çš„å€Ÿç”¨åœ¨è¿™é‡Œç»“æŸ
    }
    
    // åˆå¹¶ç‚¹ï¼šä¸¤ä¸ªè·¯å¾„çš„å€Ÿç”¨éƒ½å·²ç»“æŸ
    // âœ… å¯ä»¥ä¿®æ”¹ data
    data.push(100);
}
```

#### è·¯å¾„åˆå¹¶çš„å€Ÿç”¨å†²çª

```rust
fn path_merge_conflict(flag: bool, data: &mut Vec<i32>) -> &i32 {
    let r = if flag {
        &data[0]  // è·¯å¾„ 1ï¼šå€Ÿç”¨ data
    } else {
        &data[1]  // è·¯å¾„ 2ï¼šå€Ÿç”¨ data
    };
    
    // âŒ é”™è¯¯ï¼šåˆå¹¶ç‚¹å r ä»ç„¶æ´»è·ƒï¼Œdata è¢«å€Ÿç”¨
    // data.push(100);
    
    r  // è¿”å›å¼•ç”¨ï¼Œå€Ÿç”¨å»¶ç»­åˆ°å‡½æ•°å¤–
}
```

### 3.2. å€Ÿç”¨ä½œç”¨åŸŸ

Rust çš„å€Ÿç”¨ä½œç”¨åŸŸéµå¾ª**éè¯æ³•ç”Ÿå‘½å‘¨æœŸ (Non-Lexical Lifetimes, NLL)** è§„åˆ™ã€‚

#### NLL ä¹‹å‰çš„å€Ÿç”¨è§„åˆ™

```rust
fn old_borrow_scope() {
    let mut data = vec![1, 2, 3];
    
    // æ—§è§„åˆ™ï¼šå€Ÿç”¨æŒç»­åˆ°ä½œç”¨åŸŸç»“æŸ
    {
        let r = &data;
        println!("{}", r);
    }  // å¿…é¡»ç”¨èŠ±æ‹¬å·é™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ
    
    data.push(4);  // âœ… å€Ÿç”¨å·²ç»“æŸ
}
```

#### NLL ä¹‹åçš„å€Ÿç”¨è§„åˆ™

```rust
fn new_borrow_scope() {
    let mut data = vec![1, 2, 3];
    
    // æ–°è§„åˆ™ï¼šå€Ÿç”¨æŒç»­åˆ°æœ€åä¸€æ¬¡ä½¿ç”¨
    let r = &data;
    println!("{}", r);
    // r çš„å€Ÿç”¨åœ¨è¿™é‡Œç»“æŸï¼ˆæœ€åä¸€æ¬¡ä½¿ç”¨ï¼‰
    
    data.push(4);  // âœ… NLL è‡ªåŠ¨è¯†åˆ«å€Ÿç”¨å·²ç»“æŸ
}
```

### 3.3. éè¯æ³•ç”Ÿå‘½å‘¨æœŸ (NLL)

#### NLL çš„ä¼˜åŠ¿

1. **æ›´ç²¾ç¡®çš„å€Ÿç”¨åˆ†æ**ï¼šåŸºäºæ•°æ®æµè€Œéä½œç”¨åŸŸ
2. **å‡å°‘ä¸å¿…è¦çš„é”™è¯¯**ï¼šå…è®¸æ›´å¤šåˆæ³•çš„ä»£ç æ¨¡å¼
3. **æ”¹å–„å¼€å‘ä½“éªŒ**ï¼šå‡å°‘éœ€è¦æ‰‹åŠ¨è°ƒæ•´çš„æƒ…å†µ

#### NLL ç¤ºä¾‹

```rust
fn nll_example(flag: bool) {
    let mut data = vec![1, 2, 3];
    
    let r = &data;
    if flag {
        println!("{}", r);  // r çš„æœ€åä¸€æ¬¡ä½¿ç”¨
    }
    
    // âœ… NLLï¼šå¦‚æœ flag ä¸º falseï¼Œr ä»æœªä½¿ç”¨ï¼Œå€Ÿç”¨è§†ä¸ºæœªå‘ç”Ÿ
    data.push(4);
}
```

#### NLL çš„å½¢å¼åŒ–

NLL ä½¿ç”¨**æ´»è·ƒæ€§åˆ†æ (Liveness Analysis)**ï¼š

\[
\text{borrow\_active}(b, p) \iff \exists u \in \text{uses}(b) : p \prec u
\]

> ğŸ“š **è§£é‡Š**ï¼šå€Ÿç”¨ b åœ¨ç‚¹ p æ´»è·ƒï¼Œå½“ä¸”ä»…å½“å­˜åœ¨ b çš„ä½¿ç”¨ç‚¹ u åœ¨ p ä¹‹åã€‚

## 4. åˆ†æ”¯é—´çš„å€Ÿç”¨å†²çª

### 4.1. å¯å˜å€Ÿç”¨å†²çª

#### é—®é¢˜åœºæ™¯

```rust
// âŒ é”™è¯¯ç¤ºä¾‹
fn mutable_borrow_conflict(flag: bool, data: &mut Vec<i32>) {
    let r = if flag {
        &mut data[0]  // å¯å˜å€Ÿç”¨ data
    } else {
        &mut data[1]  // å¦ä¸€ä¸ªå¯å˜å€Ÿç”¨
    };
    
    *r = 42;
    data.push(100);  // âŒ é”™è¯¯ï¼šdata å·²è¢«å¯å˜å€Ÿç”¨
}
```

#### è§£å†³æ–¹æ¡ˆ 1ï¼šé™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ

```rust
fn solution1_scope(flag: bool, data: &mut Vec<i32>) {
    {
        let r = if flag {
            &mut data[0]
        } else {
            &mut data[1]
        };
        *r = 42;
    }  // å€Ÿç”¨åœ¨è¿™é‡Œç»“æŸ
    
    data.push(100);  // âœ… æ­£ç¡®
}
```

#### è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ç´¢å¼•è€Œéå¼•ç”¨

```rust
fn solution2_index(flag: bool, data: &mut Vec<i32>) {
    let index = if flag { 0 } else { 1 };
    data[index] = 42;
    data.push(100);  // âœ… æ­£ç¡®
}
```

#### è§£å†³æ–¹æ¡ˆ 3ï¼šåˆ†å‰²å€Ÿç”¨ (Split Borrowing)

```rust
fn solution3_split_borrow(flag: bool, data: &mut [i32]) {
    // ä½¿ç”¨ split_at_mut åˆ†å‰²åˆ‡ç‰‡
    let (left, right) = data.split_at_mut(1);
    
    let r = if flag {
        &mut left[0]
    } else {
        &mut right[0]
    };
    
    *r = 42;  // âœ… æ­£ç¡®ï¼šä¸åŒçš„å¯å˜å€Ÿç”¨
}
```

### 4.2. å¼•ç”¨ç”Ÿå‘½å‘¨æœŸå†²çª

#### 4.2.1 é—®é¢˜åœºæ™¯

```rust
// âŒ è¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨
fn lifetime_conflict<'a>(flag: bool) -> &'a str {
    let local = String::from("hello");
    
    if flag {
        local.as_str()  // âŒ é”™è¯¯ï¼šè¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨
    } else {
        "world"  // âœ… 'static ç”Ÿå‘½å‘¨æœŸ
    }
}
```

#### è§£å†³æ–¹æ¡ˆï¼šè¿”å›æ‰€æœ‰æƒ

```rust
// âœ… è¿”å›æ‰€æœ‰æƒè€Œéå¼•ç”¨
fn solution_ownership(flag: bool) -> String {
    if flag {
        String::from("hello")
    } else {
        String::from("world")
    }
}
```

### 4.3. è§£å†³ç­–ç•¥

**è¡¨ 3ï¼šå€Ÿç”¨å†²çªè§£å†³ç­–ç•¥**:

| é—®é¢˜ç±»å‹ | è§£å†³ç­–ç•¥ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| å¯å˜å€Ÿç”¨å†²çª | é™åˆ¶ä½œç”¨åŸŸ | å€Ÿç”¨ä¸éœ€è¦é•¿æœŸæŒæœ‰ |
| å¤šé‡å¯å˜å€Ÿç”¨ | ä½¿ç”¨ç´¢å¼• | ä¸éœ€è¦åŒæ—¶æŒæœ‰å¤šä¸ªå¼•ç”¨ |
| äº¤å‰å€Ÿç”¨ | åˆ†å‰²å€Ÿç”¨ | å¯ä»¥åˆ†å‰²æ•°æ®ç»“æ„ |
| ç”Ÿå‘½å‘¨æœŸå†²çª | è¿”å›æ‰€æœ‰æƒ | æ•°æ®å¯ä»¥ç§»åŠ¨ |
| å¤æ‚å€Ÿç”¨ | `Rc`/`Arc` | éœ€è¦å…±äº«æ‰€æœ‰æƒ |
| å†…éƒ¨å¯å˜æ€§ | `RefCell`/`Mutex` | éœ€è¦è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ |

## 5. ç±»å‹çŠ¶æ€æ¨¡å¼

### 5.1. æ ¸å¿ƒæ¦‚å¿µ

**ç±»å‹çŠ¶æ€æ¨¡å¼ (Typestate Pattern)** ä½¿ç”¨ç±»å‹ç³»ç»Ÿåœ¨ç¼–è¯‘æ—¶å¼ºåˆ¶æ‰§è¡ŒçŠ¶æ€è½¬æ¢è§„åˆ™ã€‚

#### è®¾è®¡æ€æƒ³

1. **çŠ¶æ€å³ç±»å‹**ï¼šæ¯ä¸ªçŠ¶æ€å¯¹åº”ä¸€ä¸ªç±»å‹
2. **è½¬æ¢å³æ–¹æ³•**ï¼šçŠ¶æ€è½¬æ¢é€šè¿‡æ¶ˆè€— `self` çš„æ–¹æ³•å®ç°
3. **ç¼–è¯‘æ—¶ä¿è¯**ï¼šéæ³•çŠ¶æ€è½¬æ¢å¯¼è‡´ç¼–è¯‘é”™è¯¯

#### å½¢å¼åŒ–è¡¨ç¤º

æœ‰é™çŠ¶æ€è‡ªåŠ¨æœº (FSA) åœ¨ç±»å‹ç³»ç»Ÿä¸­çš„ç¼–ç ï¼š

\[
\text{FSA} = (S, \Sigma, \delta, s_0, F)
\]

æ˜ å°„åˆ°ç±»å‹ç³»ç»Ÿï¼š

- çŠ¶æ€é›†åˆ \( S \) â†’ ç±»å‹å‚æ•°
- è½¬æ¢å‡½æ•° \( \delta \) â†’ æ¶ˆè€— `self` çš„æ–¹æ³•
- åˆå§‹çŠ¶æ€ \( s_0 \) â†’ æ„é€ å‡½æ•°
- ç»ˆæ­¢çŠ¶æ€ \( F \) â†’ ææ„å‡½æ•°æˆ–ç»ˆæ­¢æ–¹æ³•

### 5.2. å®ç°æœºåˆ¶

#### åŸºæœ¬å®ç°

```rust
// 1. å®šä¹‰çŠ¶æ€æ ‡è®°
struct Locked;
struct Unlocked;

// 2. ä½¿ç”¨ PhantomData æŒæœ‰çŠ¶æ€
use std::marker::PhantomData;

struct Door<State> {
    _state: PhantomData<State>,
}

// 3. åœ¨ç‰¹å®šçŠ¶æ€ä¸Šå®ç°æ–¹æ³•
impl Door<Locked> {
    // æ„é€ å™¨åˆ›å»º Locked çŠ¶æ€
    fn new() -> Door<Locked> {
        println!("é—¨å·²åˆ›å»ºå¹¶é”å®š");
        Door {
            _state: PhantomData,
        }
    }
    
    // åªæœ‰ Locked çŠ¶æ€å¯ä»¥è§£é”
    fn unlock(self) -> Door<Unlocked> {
        println!("é—¨å·²è§£é”");
        Door {
            _state: PhantomData,
        }
    }
}

impl Door<Unlocked> {
    // åªæœ‰ Unlocked çŠ¶æ€å¯ä»¥æ‰“å¼€
    fn open(&self) {
        println!("é—¨å·²æ‰“å¼€");
    }
    
    // é‡æ–°é”å®š
    fn lock(self) -> Door<Locked> {
        println!("é—¨å·²é”å®š");
        Door {
            _state: PhantomData,
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```rust
fn use_door() {
    let door = Door::<Locked>::new();
    
    // âŒ ç¼–è¯‘é”™è¯¯ï¼šLocked çŠ¶æ€æ²¡æœ‰ open æ–¹æ³•
    // door.open();
    
    let door = door.unlock();  // è½¬æ¢åˆ° Unlocked çŠ¶æ€
    door.open();               // âœ… æ­£ç¡®
    
    let door = door.lock();    // è½¬æ¢å› Locked çŠ¶æ€
    
    // âŒ ç¼–è¯‘é”™è¯¯ï¼šåˆå›åˆ° Locked çŠ¶æ€äº†
    // door.open();
}
```

### 5.3. å®è·µåº”ç”¨

#### åº”ç”¨ 1ï¼šæ•°æ®åº“è¿æ¥çŠ¶æ€

```rust
// çŠ¶æ€å®šä¹‰
struct Disconnected;
struct Connected;
struct InTransaction;

// è¿æ¥ç±»å‹
struct DbConnection<State> {
    connection_string: String,
    _state: PhantomData<State>,
}

// å„çŠ¶æ€çš„å®ç°
impl DbConnection<Disconnected> {
    fn new(connection_string: String) -> Self {
        DbConnection {
            connection_string,
            _state: PhantomData,
        }
    }
    
    fn connect(self) -> Result<DbConnection<Connected>, String> {
        println!("è¿æ¥åˆ°æ•°æ®åº“...");
        Ok(DbConnection {
            connection_string: self.connection_string,
            _state: PhantomData,
        })
    }
}

impl DbConnection<Connected> {
    fn begin_transaction(self) -> DbConnection<InTransaction> {
        println!("å¼€å§‹äº‹åŠ¡");
        DbConnection {
            connection_string: self.connection_string,
            _state: PhantomData,
        }
    }
    
    fn disconnect(self) -> DbConnection<Disconnected> {
        println!("æ–­å¼€è¿æ¥");
        DbConnection {
            connection_string: self.connection_string,
            _state: PhantomData,
        }
    }
}

impl DbConnection<InTransaction> {
    fn execute(&self, sql: &str) {
        println!("æ‰§è¡Œ SQL: {}", sql);
    }
    
    fn commit(self) -> DbConnection<Connected> {
        println!("æäº¤äº‹åŠ¡");
        DbConnection {
            connection_string: self.connection_string,
            _state: PhantomData,
        }
    }
    
    fn rollback(self) -> DbConnection<Connected> {
        println!("å›æ»šäº‹åŠ¡");
        DbConnection {
            connection_string: self.connection_string,
            _state: PhantomData,
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```rust
fn database_operations() -> Result<(), String> {
    let conn = DbConnection::<Disconnected>::new("localhost".to_string());
    let conn = conn.connect()?;
    
    // âŒ ç¼–è¯‘é”™è¯¯ï¼šå¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰èƒ½æ‰§è¡Œ SQL
    // conn.execute("SELECT * FROM users");
    
    let conn = conn.begin_transaction();
    conn.execute("INSERT INTO users VALUES (1, 'Alice')");
    conn.execute("UPDATE users SET name = 'Bob' WHERE id = 1");
    let conn = conn.commit();
    
    conn.disconnect();
    
    Ok(())
}
```

#### åº”ç”¨ 2ï¼šèµ„æºè®¿é—®æ§åˆ¶

```rust
// æƒé™æ ‡è®°
struct ReadOnly;
struct ReadWrite;

// èµ„æºåŒ…è£…å™¨
struct Resource<Permission> {
    data: Vec<u8>,
    _permission: PhantomData<Permission>,
}

// åªè¯»æƒé™
impl Resource<ReadOnly> {
    fn read(&self, index: usize) -> Option<u8> {
        self.data.get(index).copied()
    }
    
    // æ— æ³•æä¾›ä¿®æ”¹æ–¹æ³•
}

// è¯»å†™æƒé™
impl Resource<ReadWrite> {
    fn read(&self, index: usize) -> Option<u8> {
        self.data.get(index).copied()
    }
    
    fn write(&mut self, index: usize, value: u8) -> Result<(), &'static str> {
        if index < self.data.len() {
            self.data[index] = value;
            Ok(())
        } else {
            Err("ç´¢å¼•è¶Šç•Œ")
        }
    }
    
    // é™çº§ä¸ºåªè¯»
    fn downgrade(self) -> Resource<ReadOnly> {
        Resource {
            data: self.data,
            _permission: PhantomData,
        }
    }
}
```

## 6. é«˜çº§ä¸»é¢˜

### 6.1. é—­åŒ…æ•è·ä¸æ‰€æœ‰æƒ

#### æ•è·æ¨¡å¼

é—­åŒ…å¯ä»¥ä»¥ä¸‰ç§æ–¹å¼æ•è·ç¯å¢ƒï¼š

1. **ä¸å¯å˜å€Ÿç”¨** (`Fn`)
2. **å¯å˜å€Ÿç”¨** (`FnMut`)
3. **æ‰€æœ‰æƒè½¬ç§»** (`FnOnce`)

```rust
fn closure_capture() {
    let data = vec![1, 2, 3];
    
    // ä¸å¯å˜å€Ÿç”¨
    let print = || {
        println!("{:?}", data);
    };
    print();
    print();  // å¯ä»¥å¤šæ¬¡è°ƒç”¨
    
    // å¯å˜å€Ÿç”¨
    let mut counter = 0;
    let mut increment = || {
        counter += 1;
    };
    increment();
    increment();
    println!("Counter: {}", counter);
    
    // æ‰€æœ‰æƒè½¬ç§»
    let consume = move || {
        drop(data);
    };
    consume();
    // consume();  // âŒ é”™è¯¯ï¼šåªèƒ½è°ƒç”¨ä¸€æ¬¡
}
```

### 6.2. å¼‚æ­¥æ§åˆ¶æµä¸­çš„ç”Ÿå‘½å‘¨æœŸ

#### å¼‚æ­¥å—ä¸­çš„å¼•ç”¨

```rust
async fn async_lifetime<'a>(data: &'a str) -> &'a str {
    // å¼‚æ­¥å‡½æ•°ä¸­çš„ç”Ÿå‘½å‘¨æœŸ
    println!("Processing: {}", data);
    
    // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
    tokio::time::sleep(std::time::Duration::from_millis(100)).await;
    
    data  // è¿”å›å¼•ç”¨
}
```

### 6.3. å†…éƒ¨å¯å˜æ€§æ¨¡å¼

#### RefCell çš„ä½¿ç”¨

```rust
use std::cell::RefCell;

fn interior_mutability() {
    let data = RefCell::new(vec![1, 2, 3]);
    
    {
        let mut borrowed = data.borrow_mut();
        borrowed.push(4);
    }  // å¯å˜å€Ÿç”¨ç»“æŸ
    
    let borrowed = data.borrow();
    println!("{:?}", *borrowed);
}
```

## 7. æœ€ä½³å®è·µ

### è®¾è®¡åŸåˆ™

1. **é»˜è®¤ä¸å¯å˜**

   ```rust
   // âœ… æ¨è
   let data = vec![1, 2, 3];
   
   // âŒ é¿å…ä¸å¿…è¦çš„å¯å˜æ€§
   let mut data = vec![1, 2, 3];  // å¦‚æœä¸éœ€è¦ä¿®æ”¹
   ```

2. **æœ€å°æƒé™åŸåˆ™**

   ```rust
   // âœ… åªè¯·æ±‚éœ€è¦çš„æƒé™
   fn read_data(data: &[i32]) {  // ä¸å¯å˜å€Ÿç”¨
       // åªè¯»æ“ä½œ
   }
   
   // âŒ è¿‡åº¦æƒé™
   fn read_data_bad(data: &mut [i32]) {  // å¯å˜å€Ÿç”¨ï¼Œä½†å®é™…ä¸éœ€è¦
       // åªè¯»æ“ä½œ
   }
   ```

3. **é™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ**

   ```rust
   // âœ… åŠæ—©é‡Šæ”¾å€Ÿç”¨
   fn good_scope(data: &mut Vec<i32>) {
       {
           let r = &data[0];
           println!("{}", r);
       }  // r çš„å€Ÿç”¨åœ¨è¿™é‡Œç»“æŸ
       
       data.push(1);  // å¯ä»¥ä¿®æ”¹
   }
   ```

4. **ä½¿ç”¨ç±»å‹çŠ¶æ€æ¨¡å¼**

   ```rust
   // âœ… ç¼–è¯‘æ—¶ä¿è¯çŠ¶æ€æ­£ç¡®æ€§
   impl<State> Resource<State> {
       // é€šç”¨æ–¹æ³•
   }
   
   impl Resource<Initialized> {
       // åªåœ¨åˆå§‹åŒ–åå¯ç”¨çš„æ–¹æ³•
   }
   ```

## 8. æ€»ç»“

### å…³é”®è¦ç‚¹

1. **æ‰€æœ‰æƒä¸æ§åˆ¶æµé›†æˆ**
   - æ‰€æœ‰æƒåœ¨æ§åˆ¶æµä¸­è½¬ç§»
   - å€Ÿç”¨æ£€æŸ¥å™¨æ‰§è¡Œè·¯å¾„æ•æ„Ÿåˆ†æ
   - NLL æä¾›æ›´ç²¾ç¡®çš„å€Ÿç”¨åˆ†æ

2. **ç±»å‹çŠ¶æ€æ¨¡å¼**
   - å°†çŠ¶æ€ç¼–ç åˆ°ç±»å‹ç³»ç»Ÿ
   - ç¼–è¯‘æ—¶ä¿è¯çŠ¶æ€è½¬æ¢æ­£ç¡®æ€§
   - é›¶è¿è¡Œæ—¶å¼€é”€

3. **è§£å†³ç­–ç•¥**
   - é™åˆ¶å€Ÿç”¨ä½œç”¨åŸŸ
   - ä½¿ç”¨ç´¢å¼•è€Œéå¼•ç”¨
   - åˆ†å‰²å€Ÿç”¨
   - è¿”å›æ‰€æœ‰æƒ

### æƒè¡¡åˆ†æ

**ä¼˜åŠ¿**ï¼š

- ç¼–è¯‘æ—¶å†…å­˜å®‰å…¨
- æ— æ•°æ®ç«äº‰
- é›¶è¿è¡Œæ—¶å¼€é”€
- ç²¾ç¡®çš„æ§åˆ¶æµåˆ†æ

**æŒ‘æˆ˜**ï¼š

- å­¦ä¹ æ›²çº¿é™¡å³­
- éœ€è¦æ˜¾å¼ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- æŸäº›å®‰å…¨æ¨¡å¼éš¾ä»¥è¡¨è¾¾

> ğŸ’¡ **æç¤º**ï¼šç†è§£æ‰€æœ‰æƒç³»ç»Ÿä¸æ§åˆ¶æµçš„é›†æˆæ˜¯æŒæ¡ Rust çš„å…³é”®ï¼ŒæŠ•å…¥æ—¶é—´æ·±å…¥å­¦ä¹ ä¼šå¸¦æ¥é•¿æœŸå›æŠ¥ã€‚

---

## ğŸ“š ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [ä¸Šä¸€ç« ï¼šç±»å‹ç³»ç»Ÿä¸æ§åˆ¶æµ](./02_type_system_integration.md)
- [è¿”å›ç†è®ºåŸºç¡€ç›®å½•](./README.md)
- [å®è·µï¼šå¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ](../04_practice/05_common_pitfalls.md)

### æ‰©å±•é˜…è¯»

- [å€Ÿç”¨æ£€æŸ¥å™¨è¯¦è§£](../../c01_ownership_borrow_scope/docs/)
- [ç”Ÿå‘½å‘¨æœŸé«˜çº§ä¸»é¢˜](../03_advanced/README.md)
- [å†…éƒ¨å¯å˜æ€§æ¨¡å¼](../04_practice/README.md)

### å®˜æ–¹èµ„æº

- [Rust Book - Ownership](https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html)
- [Rustonomicon - Ownership](https://doc.rust-lang.org/nomicon/ownership.html)
- [Rust Reference - Lifetimes](https://doc.rust-lang.org/reference/lifetime-elision.html)

## ğŸ“ å®è·µç»ƒä¹ 

### åŸºç¡€ç»ƒä¹ 

1. **æ‰€æœ‰æƒè½¬ç§»**ï¼š
   ä¿®å¤ä»¥ä¸‹ä»£ç çš„æ‰€æœ‰æƒé”™è¯¯ï¼š

   ```rust
   fn exercise1() {
       let s = String::from("hello");
       let result = if true {
           s
       } else {
           String::from("world")
       };
       println!("{}", s);  // å¦‚ä½•ä¿®å¤ï¼Ÿ
   }
   ```

2. **å€Ÿç”¨å†²çª**ï¼š
   è§£å†³å€Ÿç”¨å†²çªï¼š

   ```rust
   fn exercise2(data: &mut Vec<i32>) {
       let r = &data[0];
       data.push(1);
       println!("{}", r);  // å¦‚ä½•ä¿®å¤ï¼Ÿ
   }
   ```

### è¿›é˜¶ç»ƒä¹ 

1. **ç±»å‹çŠ¶æ€æ¨¡å¼**ï¼š
   ä¸ºæ–‡ä»¶æ“ä½œå®ç°ç±»å‹çŠ¶æ€æ¨¡å¼ï¼ˆClosed, Open, Reading, Writingï¼‰ã€‚

2. **ç”Ÿå‘½å‘¨æœŸæ¨æ–­**ï¼š
   ä¸ºä»¥ä¸‹å‡½æ•°æ·»åŠ æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼š

   ```rust
   fn select(flag: bool, a: &str, b: &str) -> &str {
       if flag { a } else { b }
   }
   ```

### æŒ‘æˆ˜ç»ƒä¹ 

1. **å¤æ‚çŠ¶æ€æœº**ï¼š
   å®ç°ä¸€ä¸ªå¸¦æœ‰å¤šä¸ªçŠ¶æ€å’Œå¤æ‚è½¬æ¢è§„åˆ™çš„ç±»å‹çŠ¶æ€æœºã€‚

2. **é—­åŒ…æ•è·**ï¼š
   åˆ›å»ºä¸€ä¸ªé—­åŒ…ï¼Œæ¼”ç¤ºä¸‰ç§æ•è·æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯ã€‚

---

## ğŸ’¬ å¸¸è§é—®é¢˜

Q1ï¼šä¸ºä»€ä¹ˆ Rust è¦å°†æ‰€æœ‰æƒä¸æ§åˆ¶æµé›†æˆï¼Ÿ

Aï¼šé›†æˆçš„æ ¸å¿ƒåŸå› æ˜¯**å†…å­˜å®‰å…¨**ï¼š

1. **ç¼–è¯‘æ—¶ä¿è¯**ï¼šåœ¨æ‰€æœ‰å¯èƒ½çš„æ§åˆ¶æµè·¯å¾„ä¸ŠéªŒè¯å†…å­˜å®‰å…¨
2. **é˜²æ­¢æ•°æ®ç«äº‰**ï¼šç¡®ä¿ä¸ä¼šå‡ºç°åŒæ—¶çš„å¯å˜è®¿é—®
3. **é˜²æ­¢æ‚¬å‚æŒ‡é’ˆ**ï¼šå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡è¢«å¼•ç”¨æ•°æ®
4. **é›¶è¿è¡Œæ—¶å¼€é”€**ï¼šæ‰€æœ‰æ£€æŸ¥åœ¨ç¼–è¯‘æ—¶å®Œæˆ

è¿™æ˜¯ Rust å®ç°æ— GCå†…å­˜å®‰å…¨çš„å…³é”®è®¾è®¡ã€‚
</details>

Q2ï¼šNLL å¦‚ä½•æ”¹å–„å€Ÿç”¨æ£€æŸ¥ï¼Ÿ

Aï¼šéè¯æ³•ç”Ÿå‘½å‘¨æœŸ (NLL) çš„æ”¹è¿›ï¼š

1. **æ›´ç²¾ç¡®**ï¼šåŸºäºæ•°æ®æµåˆ†æè€Œéè¯æ³•ä½œç”¨åŸŸ
2. **æ›´çµæ´»**ï¼šå…è®¸æ›´å¤šåˆæ³•çš„å€Ÿç”¨æ¨¡å¼
3. **æ›´æ™ºèƒ½**ï¼šè‡ªåŠ¨è¯†åˆ«å€Ÿç”¨çš„å®é™…ä½¿ç”¨èŒƒå›´

ä¾‹å¦‚ï¼Œå€Ÿç”¨å¯ä»¥åœ¨æœ€åä¸€æ¬¡ä½¿ç”¨åç«‹å³ç»“æŸï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä½œç”¨åŸŸç»“æŸã€‚
</details>

Q3ï¼šç±»å‹çŠ¶æ€æ¨¡å¼çš„å¼€é”€æ˜¯ä»€ä¹ˆï¼Ÿ

Aï¼šç±»å‹çŠ¶æ€æ¨¡å¼çš„å¼€é”€åˆ†æï¼š

**ç¼–è¯‘æ—¶å¼€é”€**ï¼š

- å¢åŠ ç¼–è¯‘æ—¶é—´ï¼ˆå•æ€åŒ–ï¼‰
- å¢å¤§äºŒè¿›åˆ¶å¤§å°ï¼ˆæ¯ä¸ªçŠ¶æ€ç”Ÿæˆä»£ç ï¼‰

**è¿è¡Œæ—¶å¼€é”€**ï¼š

- é›¶å¼€é”€ï¼ˆçŠ¶æ€æ ‡è®°æ˜¯ PhantomDataï¼Œé›¶å¤§å°ï¼‰
- ä¸æ‰‹å†™çŠ¶æ€æ£€æŸ¥ç›¸åŒçš„æ€§èƒ½

**æƒè¡¡**ï¼šç¼–è¯‘æ—¶èµ„æºæ¢å–è¿è¡Œæ—¶å®‰å…¨å’Œæ€§èƒ½ã€‚
</details>

Q4ï¼šå¦‚ä½•åœ¨å¾ªç¯ä¸­å®‰å…¨åœ°ä½¿ç”¨å¯å˜å€Ÿç”¨ï¼Ÿ

Aï¼šå‡ ç§å®‰å…¨æ¨¡å¼ï¼š

1. **å€Ÿç”¨åˆ‡ç‰‡**ï¼š`for item in &mut vec`
2. **ä½¿ç”¨ç´¢å¼•**ï¼š`for i in 0..vec.len()`
3. **æ¶ˆè€—è¿­ä»£å™¨**ï¼š`for item in vec.into_iter()`
4. **åˆ†å‰²å€Ÿç”¨**ï¼š`split_at_mut()`

é€‰æ‹©å–å†³äºå…·ä½“éœ€æ±‚å’Œåç»­æ˜¯å¦éœ€è¦è®¿é—®åŸå§‹æ•°æ®ã€‚
</details>

---

**å¯¼èˆª**ï¼š

- ä¸Šä¸€ç« ï¼š[ç±»å‹ç³»ç»Ÿä¸æ§åˆ¶æµ](./02_type_system_integration.md)
- [è¿”å›ç†è®ºåŸºç¡€ç›®å½•](./README.md)
- [è¿”å›ä¸»æ–‡æ¡£](../README.md)

---

*æœ€åæ›´æ–°ï¼š2025å¹´1æœˆ*  
*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*Rust ç‰ˆæœ¬ï¼š1.90+*
