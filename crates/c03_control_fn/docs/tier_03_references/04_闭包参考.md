# 3.4 é—­åŒ…å‚è€ƒ

> **æ–‡æ¡£ç±»å‹**: Tier 3 - å‚è€ƒå±‚  
> **æ–‡æ¡£å®šä½**: Rusté—­åŒ…å®Œæ•´è¯­æ³•å’Œtraitå‚è€ƒ  
> **é€‚ç”¨å¯¹è±¡**: éœ€è¦æ·±å…¥äº†è§£é—­åŒ…æœºåˆ¶çš„å¼€å‘è€…  
> **ç›¸å…³æ–‡æ¡£**: [ä¸»ç´¢å¼•](../tier_01_foundations/02_ä¸»ç´¢å¼•å¯¼èˆª.md) | [å‡½æ•°ç³»ç»ŸæŒ‡å—](../tier_02_guides/03_å‡½æ•°ç³»ç»ŸæŒ‡å—.md)

**æœ€åæ›´æ–°**: 2025-10-22  
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.90+  
**æ–‡æ¡£ç‰ˆæœ¬**: v2025.1.0

---

## ğŸ“‹ ç›®å½•

- [3.4 é—­åŒ…å‚è€ƒ](#34-é—­åŒ…å‚è€ƒ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. é—­åŒ…è¯­æ³•](#1-é—­åŒ…è¯­æ³•)
  - [2. æ•è·æœºåˆ¶](#2-æ•è·æœºåˆ¶)
  - [3. é—­åŒ…trait](#3-é—­åŒ…trait)
  - [4. moveå…³é”®å­—](#4-moveå…³é”®å­—)
  - [5. ç”Ÿå‘½å‘¨æœŸ](#5-ç”Ÿå‘½å‘¨æœŸ)
  - [6. ç±»å‹æ¨æ–­](#6-ç±»å‹æ¨æ–­)
  - [7. å¼‚æ­¥é—­åŒ…](#7-å¼‚æ­¥é—­åŒ…)
    - [é—­åŒ…traitå¯¹æ¯”](#é—­åŒ…traitå¯¹æ¯”)
    - [æ•è·æ¨¡å¼](#æ•è·æ¨¡å¼)

---

## 1. é—­åŒ…è¯­æ³•

**å®Œæ•´è¯­æ³•**:

```bnf
closure_expression :=
    "move"? 
    "|" closure_parameters? "|" 
    (expression | "->" type_no_bounds block_expression)

closure_parameters :=
    closure_param ("," closure_param)* ","?

closure_param :=
    pattern (":" type)?
```

**åŸºæœ¬å½¢å¼**:

```rust
fn main() {
    // æœ€ç®€å½¢å¼
    let f1 = || 42;
    
    // å¸¦å‚æ•°
    let f2 = |x| x + 1;
    
    // å¤šä¸ªå‚æ•°
    let f3 = |x, y| x + y;
    
    // æŒ‡å®šå‚æ•°ç±»å‹
    let f4 = |x: i32| -> i32 { x * 2 };
    
    // å¤šè¡Œé—­åŒ…
    let f5 = |x: i32| {
        let doubled = x * 2;
        doubled + 1
    };
    
    // moveé—­åŒ…
    let s = String::from("hello");
    let f6 = move || println!("{}", s);
    
    println!("{}", f1());
    println!("{}", f2(5));
    println!("{}", f3(3, 4));
    println!("{}", f4(10));
    println!("{}", f5(5));
    f6();
}
```

---

## 2. æ•è·æœºåˆ¶

**æ•è·è§„åˆ™**:

```rust
fn main() {
    let x = 10;
    let mut y = 20;
    let z = String::from("hello");
    
    // 1. ä¸å¯å˜å€Ÿç”¨æ•è·
    let c1 = || {
        println!("x = {}", x);  // å€Ÿç”¨x
    };
    c1();
    println!("x = {}", x);  // xä»å¯ç”¨
    
    // 2. å¯å˜å€Ÿç”¨æ•è·
    let mut c2 = || {
        y += 1;  // å¯å˜å€Ÿç”¨y
        println!("y = {}", y);
    };
    c2();
    // println!("y = {}", y);  // é”™è¯¯ï¼šå¯å˜å€Ÿç”¨æœŸé—´ä¸èƒ½ä½¿ç”¨
    drop(c2);  // ç»“æŸå¯å˜å€Ÿç”¨
    println!("y = {}", y);  // ç°åœ¨å¯ä»¥ä½¿ç”¨
    
    // 3. æ‰€æœ‰æƒè½¬ç§»æ•è·
    let c3 = || {
        println!("z = {}", z);  // å€Ÿç”¨z
    };
    c3();
    println!("z = {}", z);  // zä»å¯ç”¨ï¼ˆå› ä¸ºåªæ˜¯å€Ÿç”¨ï¼‰
    
    // 4. moveå¼ºåˆ¶æ‰€æœ‰æƒè½¬ç§»
    let c4 = move || {
        println!("z = {}", z);  // è·å–zçš„æ‰€æœ‰æƒ
    };
    c4();
    // println!("z = {}", z);  // é”™è¯¯ï¼šzå·²è¢«ç§»åŠ¨
}
```

**æ•è·ç¯å¢ƒçš„æœ€å°åŒ–åŸåˆ™**:

```rust
fn main() {
    struct Point {
        x: i32,
        y: i32,
    }
    
    let point = Point { x: 10, y: 20 };
    
    // åªæ•è·ä½¿ç”¨çš„å­—æ®µ
    let c = || {
        println!("x = {}", point.x);  // åªå€Ÿç”¨point.x
    };
    c();
    
    // point.yä»å¯ä¿®æ”¹
    // ä½†point.xä¸å¯ä¿®æ”¹ï¼ˆè¢«å€Ÿç”¨ï¼‰
    println!("point.y = {}", point.y);
}
```

---

## 3. é—­åŒ…trait

**ä¸‰ä¸ªé—­åŒ…trait**:

```rust
// FnOnce: å¯ä»¥è°ƒç”¨ä¸€æ¬¡
pub trait FnOnce<Args> {
    type Output;
    fn call_once(self, args: Args) -> Self::Output;
}

// FnMut: å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œå¯ä»¥ä¿®æ”¹æ•è·çš„å˜é‡
pub trait FnMut<Args>: FnOnce<Args> {
    fn call_mut(&mut self, args: Args) -> Self::Output;
}

// Fn: å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œä¸ä¿®æ”¹æ•è·çš„å˜é‡
pub trait Fn<Args>: FnMut<Args> {
    fn call(&self, args: Args) -> Self::Output;
}
```

**traitç»§æ‰¿å±‚æ¬¡**:

```rust
fn main() {
    // Fn å®ç°äº† FnMut å’Œ FnOnce
    // FnMut å®ç°äº† FnOnce
    
    let x = 10;
    
    // Fné—­åŒ…ï¼ˆä¸å¯å˜å€Ÿç”¨ï¼‰
    let fn_closure = || {
        println!("x = {}", x);
    };
    fn_closure();
    fn_closure();  // å¯å¤šæ¬¡è°ƒç”¨
    
    // FnMuté—­åŒ…ï¼ˆå¯å˜å€Ÿç”¨ï¼‰
    let mut y = 20;
    let mut fnmut_closure = || {
        y += 1;
        println!("y = {}", y);
    };
    fnmut_closure();
    fnmut_closure();  // å¯å¤šæ¬¡è°ƒç”¨
    
    // FnOnceé—­åŒ…ï¼ˆè·å–æ‰€æœ‰æƒï¼‰
    let s = String::from("hello");
    let fnonce_closure = || {
        drop(s);  // æ¶ˆè´¹s
    };
    fnonce_closure();
    // fnonce_closure();  // é”™è¯¯ï¼šåªèƒ½è°ƒç”¨ä¸€æ¬¡
}
```

**ä½œä¸ºå‚æ•°**:

```rust
fn call_fn<F>(f: F) where F: Fn() {
    f();
    f();  // Fnå¯ä»¥å¤šæ¬¡è°ƒç”¨
}

fn call_fn_mut<F>(mut f: F) where F: FnMut() {
    f();
    f();  // FnMutå¯ä»¥å¤šæ¬¡è°ƒç”¨
}

fn call_fn_once<F>(f: F) where F: FnOnce() {
    f();
    // f();  // é”™è¯¯ï¼šFnOnceåªèƒ½è°ƒç”¨ä¸€æ¬¡
}

fn main() {
    let x = 10;
    call_fn(|| println!("{}", x));
    
    let mut y = 20;
    call_fn_mut(|| {
        y += 1;
        println!("{}", y);
    });
    
    let s = String::from("hello");
    call_fn_once(|| drop(s));
}
```

---

## 4. moveå…³é”®å­—

**moveè¯­ä¹‰**:

```rust
fn main() {
    // ä¸ä½¿ç”¨move
    let x = 10;
    let c1 = || println!("{}", x);  // å€Ÿç”¨x
    c1();
    println!("{}", x);  // xä»å¯ç”¨
    
    // ä½¿ç”¨move
    let y = 10;
    let c2 = move || println!("{}", y);  // ç§»åŠ¨yï¼ˆä½†yæ˜¯Copyï¼‰
    c2();
    println!("{}", y);  // yä»å¯ç”¨ï¼ˆå› ä¸ºæ˜¯Copyï¼‰
    
    // éCopyç±»å‹çš„move
    let s = String::from("hello");
    let c3 = move || println!("{}", s);  // ç§»åŠ¨s
    c3();
    // println!("{}", s);  // é”™è¯¯ï¼šså·²è¢«ç§»åŠ¨
}
```

**moveä¸çº¿ç¨‹**:

```rust
use std::thread;

fn main() {
    let s = String::from("hello");
    
    // å¿…é¡»ä½¿ç”¨moveå°†sç§»åŠ¨åˆ°çº¿ç¨‹
    let handle = thread::spawn(move || {
        println!("{}", s);
    });
    
    handle.join().unwrap();
    // println!("{}", s);  // é”™è¯¯ï¼šså·²è¢«ç§»åŠ¨
}
```

**moveä¸Clone**:

```rust
fn main() {
    let s = String::from("hello");
    
    // å…‹éš†åç§»åŠ¨
    let s_clone = s.clone();
    let c = move || {
        println!("{}", s_clone);  // ç§»åŠ¨å…‹éš†çš„å€¼
    };
    c();
    println!("{}", s);  // åŸå§‹å€¼ä»å¯ç”¨
}
```

---

## 5. ç”Ÿå‘½å‘¨æœŸ

**é—­åŒ…çš„ç”Ÿå‘½å‘¨æœŸ**:

```rust
fn main() {
    let x = 10;
    
    // é—­åŒ…çš„ç”Ÿå‘½å‘¨æœŸä¸æ•è·çš„å¼•ç”¨ç›¸å…³
    let c = || {
        println!("{}", x);
    };
    
    c();  // OK
    
    // é—­åŒ…ä¸èƒ½æ¯”æ•è·çš„å¼•ç”¨æ´»å¾—æ›´ä¹…
    /*
    let c;
    {
        let y = 20;
        c = || println!("{}", y);  // é”™è¯¯ï¼šyçš„ç”Ÿå‘½å‘¨æœŸä¸å¤Ÿé•¿
    }
    c();
    */
}
```

**è¿”å›é—­åŒ…çš„ç”Ÿå‘½å‘¨æœŸ**:

```rust
// è¿”å›é—­åŒ…éœ€è¦æŒ‡å®šç”Ÿå‘½å‘¨æœŸ
fn make_closure<'a>(x: &'a i32) -> impl Fn() + 'a {
    move || println!("{}", x)
}

// ä½¿ç”¨Boxé¿å…ç”Ÿå‘½å‘¨æœŸé—®é¢˜
fn make_boxed_closure<'a>(x: &'a i32) -> Box<dyn Fn() + 'a> {
    Box::new(move || println!("{}", x))
}

fn main() {
    let x = 10;
    let c = make_closure(&x);
    c();
    
    let c2 = make_boxed_closure(&x);
    c2();
}
```

---

## 6. ç±»å‹æ¨æ–­

**é—­åŒ…ç±»å‹æ¨æ–­**:

```rust
fn main() {
    // ç¼–è¯‘å™¨æ¨æ–­å‚æ•°å’Œè¿”å›ç±»å‹
    let add = |x, y| x + y;
    println!("{}", add(1, 2));      // i32
    println!("{}", add(1.0, 2.0));  // f64
    
    // æ˜¾å¼ç±»å‹æ³¨è§£
    let add_i32 = |x: i32, y: i32| -> i32 { x + y };
    println!("{}", add_i32(1, 2));
    
    // ä¸€æ—¦æ¨æ–­ï¼Œç±»å‹å›ºå®š
    let f = |x| x + 1;
    let _: i32 = f(10);  // æ¨æ–­ä¸ºi32
    // let _: f64 = f(10.0);  // é”™è¯¯ï¼šå·²æ¨æ–­ä¸ºi32
}
```

**traitå¯¹è±¡ç±»å‹**:

```rust
fn main() {
    // Box<dyn Fn>
    let f1: Box<dyn Fn(i32) -> i32> = Box::new(|x| x + 1);
    println!("{}", f1(10));
    
    // &dyn Fn
    let f2: &dyn Fn(i32) -> i32 = &|x| x * 2;
    println!("{}", f2(10));
    
    // impl Fn
    fn return_closure() -> impl Fn(i32) -> i32 {
        |x| x + 1
    }
    
    let f3 = return_closure();
    println!("{}", f3(10));
}
```

---

## 7. å¼‚æ­¥é—­åŒ…

**å¼‚æ­¥é—­åŒ…ï¼ˆRust 1.75+ï¼‰**:

```rust
// asyncé—­åŒ…
fn main() {
    let f = async || {
        println!("async closure");
        42
    };
    
    // éœ€è¦è¿è¡Œæ—¶æ‰§è¡Œ
    // let result = f().await;
    
    println!("å¼‚æ­¥é—­åŒ…éœ€è¦è¿è¡Œæ—¶æ”¯æŒ");
}
```

**async moveé—­åŒ…**:

```rust
fn main() {
    let s = String::from("hello");
    
    let f = async move || {
        println!("{}", s);
        42
    };
    
    // så·²è¢«ç§»åŠ¨
    // println!("{}", s);
    
    println!("å¼‚æ­¥moveé—­åŒ…");
}
```

---

**å‚è€ƒè¡¨**:

### é—­åŒ…traitå¯¹æ¯”

| Trait | è°ƒç”¨æ–¹å¼ | selfç±»å‹ | å¯è°ƒç”¨æ¬¡æ•° | ä½¿ç”¨åœºæ™¯ |
|-------|---------|---------|-----------|---------|
| Fn | call(&self, args) | &self | å¤šæ¬¡ | ä¸ä¿®æ”¹ç¯å¢ƒ |
| FnMut | call_mut(&mut self, args) | &mut self | å¤šæ¬¡ | ä¿®æ”¹ç¯å¢ƒ |
| FnOnce | call_once(self, args) | self | ä¸€æ¬¡ | æ¶ˆè´¹ç¯å¢ƒ |

### æ•è·æ¨¡å¼

| æ¨¡å¼ | è¯­æ³• | æ‰€æœ‰æƒ | ç¤ºä¾‹ |
|------|------|--------|------|
| ä¸å¯å˜å€Ÿç”¨ | `\|\| {...}` | å€Ÿç”¨ | `\|\| println!("{}", x)` |
| å¯å˜å€Ÿç”¨ | `\|\| {...}` | å¯å˜å€Ÿç”¨ | `\|\| x += 1` |
| æ‰€æœ‰æƒè½¬ç§» | `move \|\| {...}` | ç§»åŠ¨ | `move \|\| drop(x)` |

---

**æœ€åæ›´æ–°**: 2025-10-22  
**æ–‡æ¡£ç‰ˆæœ¬**: v2025.1.0  
**ç›¸å…³æ–‡æ¡£**: [ä¸»ç´¢å¼•](../tier_01_foundations/02_ä¸»ç´¢å¼•å¯¼èˆª.md) | [README](../../README.md)

---

**ğŸ“š å®Œæ•´çš„Rusté—­åŒ…å‚è€ƒ** ğŸ¦€âœ¨
