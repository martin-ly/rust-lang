# 03. 控制流性能与工程准则 (Control Flow Performance - Rust 1.90)

> **文档类型**：实践  
> **难度等级**：⭐⭐⭐⭐  
> **预计阅读时间**：1.5小时  
> **前置知识**：控制流基础、性能优化概念、编译器优化


## 📊 目录

- [📖 内容概述](#内容概述)
- [🎯 学习目标](#学习目标)
- [📚 目录](#目录)
- [3.1. 分支预测与布局](#31-分支预测与布局)
- [无分支技巧（仅在确有收益时）](#无分支技巧仅在确有收益时)
- [迭代器链 vs 手写循环](#迭代器链-vs-手写循环)
- [错误处理与早退](#错误处理与早退)


## 📖 内容概述

本文档总结控制流相关的性能优化经验，包括分支预测友好的代码组织、无分支技巧、迭代器链与手写循环的权衡、错误处理的早退路径布局等实战技巧。

## 🎯 学习目标

完成本文档学习后，你将能够：

- [ ] 编写对分支预测友好的代码
- [ ] 理解并应用无分支优化技巧
- [ ] 权衡迭代器链和手写循环
- [ ] 优化错误处理路径布局
- [ ] 使用性能分析工具
- [ ] 在性能和可读性间找到平衡

## 📚 目录

- [03. 控制流性能与工程准则 (Control Flow Performance - Rust 1.90)](#03-控制流性能与工程准则-control-flow-performance---rust-190)
  - [📖 内容概述](#-内容概述)
  - [🎯 学习目标](#-学习目标)
  - [📚 目录](#-目录)
  - [3.1. 分支预测与布局](#31-分支预测与布局)
  - [无分支技巧（仅在确有收益时）](#无分支技巧仅在确有收益时)
  - [迭代器链 vs 手写循环](#迭代器链-vs-手写循环)
  - [错误处理与早退](#错误处理与早退)

---

## 3.1. 分支预测与布局

- 将“常见路径”放在前面（早返回或直接走主干）；
- 对热点函数启用 `#[inline]` 建议，交由编译器决策。

```rust
#[inline]
fn classify(x: i32) -> i32 {
    if x == 0 { return 0; }
    if x > 0 { 1 } else { -1 }
}
```

## 无分支技巧（仅在确有收益时）

```rust
fn abs_i32(x: i32) -> i32 { if x >= 0 { x } else { -x } }
```

- 对现代编译器而言，清晰的分支往往更易优化；
- 使用 `select` 风格或位运算前先做基准。

## 迭代器链 vs 手写循环

- 迭代器链表达力强、易组合；
- 手写循环便于微调内层控制流与缓存局部性；
- 用基准来决定，两者性能常接近。

## 错误处理与早退

- 失败尽早返回（`let-else`、`?`、`try`）；
- 避免深层嵌套；
- 错误映射集中在边界层。

---

工程建议：

- 先写清晰可读的控制流，再用基准定位优化点；
- 对热路径减少分配与拷贝；
- 使用 `cargo bench`/`criterion` 进行对比评估。
