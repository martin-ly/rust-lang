# Rust 1.92.0 çº¿ç¨‹å¹¶å‘æ”¹è¿›æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-11
> **é€‚ç”¨ç‰ˆæœ¬**: Rust 1.92.0+
> **ç›¸å…³æ¨¡å—**: `c05_threads`

---

## ğŸ“Š ç›®å½•

- [Rust 1.92.0 çº¿ç¨‹å¹¶å‘æ”¹è¿›æ–‡æ¡£](#rust-1920-çº¿ç¨‹å¹¶å‘æ”¹è¿›æ–‡æ¡£)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [MaybeUninit åœ¨å¹¶å‘ç¼–ç¨‹ä¸­çš„åº”ç”¨](#maybeuninit-åœ¨å¹¶å‘ç¼–ç¨‹ä¸­çš„åº”ç”¨)
    - [Rust 1.92.0 æ”¹è¿›æ¦‚è¿°](#rust-1920-æ”¹è¿›æ¦‚è¿°)
  - [rotate\_right åœ¨çº¿ç¨‹æ± ç®¡ç†ä¸­çš„åº”ç”¨](#rotate_right-åœ¨çº¿ç¨‹æ± ç®¡ç†ä¸­çš„åº”ç”¨)
  - [NonZero::div\_ceil åœ¨çº¿ç¨‹æ•°é‡è®¡ç®—ä¸­çš„åº”ç”¨](#nonzerodiv_ceil-åœ¨çº¿ç¨‹æ•°é‡è®¡ç®—ä¸­çš„åº”ç”¨)
  - [å®é™…åº”ç”¨ç¤ºä¾‹](#å®é™…åº”ç”¨ç¤ºä¾‹)
  - [è¿ç§»æŒ‡å—](#è¿ç§»æŒ‡å—)
    - [ä» Rust 1.91 è¿ç§»åˆ° Rust 1.92.0](#ä»-rust-191-è¿ç§»åˆ°-rust-1920)
  - [RwLockWriteGuard::downgrade (Rust 1.92.0 æ–°å¢) â­](#rwlockwriteguarddowngrade-rust-1920-æ–°å¢-)
    - [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
    - [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
    - [æ€§èƒ½ä¼˜åŠ¿](#æ€§èƒ½ä¼˜åŠ¿)
  - [å±•å¼€è¡¨é»˜è®¤å¯ç”¨ (Rust 1.92.0 æ–°å¢) â­](#å±•å¼€è¡¨é»˜è®¤å¯ç”¨-rust-1920-æ–°å¢-)
    - [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
    - [ä¼˜åŠ¿](#ä¼˜åŠ¿)
  - [panic::catch\_unwind æ€§èƒ½ä¼˜åŒ– (Rust 1.92.0 æ–°å¢) â­](#paniccatch_unwind-æ€§èƒ½ä¼˜åŒ–-rust-1920-æ–°å¢-)
    - [æ€§èƒ½å½±å“](#æ€§èƒ½å½±å“)
    - [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
  - [æ€»ç»“](#æ€»ç»“)

---

## æ¦‚è¿°

Rust 1.92.0 åœ¨çº¿ç¨‹å’Œå¹¶å‘ç¼–ç¨‹æ–¹é¢å¸¦æ¥äº†é‡è¦çš„æ”¹è¿›ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

1. **MaybeUninit æ”¹è¿›** - æ›´å®‰å…¨çš„å¹¶å‘å†…å­˜ç®¡ç†
2. **rotate_right** - é«˜æ•ˆçš„ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
3. **NonZero::div_ceil** - ç²¾ç¡®çš„çº¿ç¨‹èµ„æºåˆ†é…è®¡ç®—
4. **RwLockWriteGuard::downgrade** â­ **æ–°å¢** - å†™é”é™çº§ä¸ºè¯»é”
5. **å±•å¼€è¡¨é»˜è®¤å¯ç”¨** â­ **æ–°å¢** - å³ä½¿ä½¿ç”¨ `-Cpanic=abort` ä¹Ÿèƒ½æ­£ç¡®å›æº¯
6. **panic::catch_unwind æ€§èƒ½ä¼˜åŒ–** â­ **æ–°å¢** - ä¸å†è®¿é—®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œæ€§èƒ½æå‡
7. **çº¿ç¨‹å®‰å…¨å¢å¼º** - æ›´å¥½çš„å¹¶å‘å®‰å…¨ä¿éšœ

---

## MaybeUninit åœ¨å¹¶å‘ç¼–ç¨‹ä¸­çš„åº”ç”¨

### Rust 1.92.0 æ”¹è¿›æ¦‚è¿°

Rust 1.92.0 æ­£å¼æ–‡æ¡£åŒ–äº† `MaybeUninit` çš„å†…éƒ¨è¡¨ç¤ºå’Œæœ‰æ•ˆæ€§çº¦æŸï¼Œè¿™ä½¿å¾—åœ¨å¹¶å‘ç¼–ç¨‹ä¸­è¿›è¡Œå†…å­˜ç®¡ç†æ›´åŠ å®‰å…¨ã€‚

```rust
// çº¿ç¨‹å®‰å…¨çš„æœªåˆå§‹åŒ–ç¼“å†²åŒº
pub struct ThreadSafeUninitBuffer<T> {
    buffer: Vec<MaybeUninit<T>>,
}

impl<T> ThreadSafeUninitBuffer<T> {
    pub fn new(size: usize) -> Self {
        // Rust 1.92.0: ä½¿ç”¨æ–‡æ¡£åŒ–çš„ MaybeUninit
        // ...
    }

    pub unsafe fn init_at(&mut self, index: usize, value: T) {
        // Rust 1.92.0: å®‰å…¨çš„åˆå§‹åŒ–æ¨¡å¼
        self.buffer[index].write(value);
    }
}
```

---

## rotate_right åœ¨çº¿ç¨‹æ± ç®¡ç†ä¸­çš„åº”ç”¨

Rust 1.92.0 ç¨³å®šåŒ–äº† `rotate_right` æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ä¸­å¯ä»¥é«˜æ•ˆåœ°æ—‹è½¬ä»»åŠ¡é¡ºåºã€‚

```rust
// çº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—
pub struct ThreadPoolTaskQueue {
    tasks: VecDeque<ThreadTask>,
}

impl ThreadPoolTaskQueue {
    pub fn rotate_tasks(&mut self, count: usize) {
        // Rust 1.92.0: ä½¿ç”¨ rotate_right é«˜æ•ˆæ—‹è½¬ä»»åŠ¡
        let tasks_vec: Vec<_> = self.tasks.drain(..).collect();
        let mut rotated = tasks_vec;
        rotated.rotate_right(count);
        self.tasks = rotated.into();
    }
}
```

---

## NonZero::div_ceil åœ¨çº¿ç¨‹æ•°é‡è®¡ç®—ä¸­çš„åº”ç”¨

Rust 1.92.0 ç¨³å®šåŒ–äº† `NonZero::div_ceil`ï¼Œåœ¨è®¡ç®—çº¿ç¨‹æ± å¤§å°å’Œèµ„æºåˆ†é…æ—¶éå¸¸æœ‰ç”¨ã€‚

```rust
use std::num::NonZeroUsize;

// è®¡ç®—çº¿ç¨‹æ± å¤§å°
pub fn calculate_thread_pool_size(
    total_work: usize,
    work_per_thread: NonZeroUsize,
) -> usize {
    // Rust 1.92.0: ä½¿ç”¨ NonZero::div_ceil ç²¾ç¡®è®¡ç®—
    let total = NonZeroUsize::new(total_work).unwrap();
    total.div_ceil(work_per_thread).get()
}
```

---

## å®é™…åº”ç”¨ç¤ºä¾‹

è¯¦ç»†ç¤ºä¾‹è¯·å‚è€ƒï¼š

- [æºä»£ç å®ç°](../../src/rust_192_features.rs)
- [ç¤ºä¾‹ä»£ç ](../../examples/rust_192_features_demo.rs)

---

## è¿ç§»æŒ‡å—

### ä» Rust 1.91 è¿ç§»åˆ° Rust 1.92.0

1. **æ›´æ–° Rust ç‰ˆæœ¬**: `rustup update stable`
2. **æ›´æ–° Cargo.toml**: `rust-version = "1.92"`
3. **åˆ©ç”¨æ–°ç‰¹æ€§**:
   - ä½¿ç”¨ `MaybeUninit` æ”¹è¿›å¹¶å‘å†…å­˜ç®¡ç†
   - ä½¿ç”¨ `rotate_right` ä¼˜åŒ–ä»»åŠ¡é˜Ÿåˆ—
   - ä½¿ç”¨ `NonZero::div_ceil` ç²¾ç¡®è®¡ç®—çº¿ç¨‹æ•°é‡

---

## RwLockWriteGuard::downgrade (Rust 1.92.0 æ–°å¢) â­

Rust 1.92.0 ç¨³å®šåŒ–äº† `RwLockWriteGuard::downgrade` æ–¹æ³•ï¼Œå…è®¸å°†å†™é”é™çº§ä¸ºè¯»é”ã€‚è¿™åœ¨éœ€è¦å…ˆå†™å…¥ç„¶åè¯»å–çš„åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚

### ä½¿ç”¨åœºæ™¯

- **é…ç½®æ›´æ–°åè¯»å–**: æ›´æ–°é…ç½®åç«‹å³è¯»å–ï¼Œå…è®¸å…¶ä»–è¯»è€…è®¿é—®
- **åŸå­æ›´æ–°è¯»å–**: å…ˆæ›´æ–°åè¯»å–ï¼Œé¿å…é‡æ–°è·å–é”çš„å¼€é”€
- **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘é”çš„è·å–å’Œé‡Šæ”¾æ¬¡æ•°

### ä»£ç ç¤ºä¾‹

```rust
use std::sync::{Arc, RwLock, RwLockWriteGuard};

// é…ç½®ç®¡ç†å™¨ç¤ºä¾‹
pub struct ConfigManager {
    config: Arc<RwLock<HashMap<String, String>>>,
}

impl ConfigManager {
    /// æ›´æ–°é…ç½®å¹¶ç«‹å³è¯»å–ï¼ˆä½¿ç”¨ downgrade ä¼˜åŒ–ï¼‰
    pub fn update_and_read(&self, key: String, value: String) -> Option<String> {
        // è·å–å†™é”è¿›è¡Œæ›´æ–°
        let mut write_guard = self.config.write().unwrap();
        write_guard.insert(key.clone(), value);

        // Rust 1.92.0: é™çº§ä¸ºè¯»é”ï¼Œå…è®¸å…¶ä»–è¯»è€…è®¿é—®
        let read_guard = RwLockWriteGuard::downgrade(write_guard);

        // è¯»å–åˆšå†™å…¥çš„å€¼ï¼ˆä¸éœ€è¦é‡æ–°è·å–é”ï¼‰
        read_guard.get(&key).cloned()
    }
}
```

### æ€§èƒ½ä¼˜åŠ¿

- **å‡å°‘é”æ“ä½œ**: é¿å…å†™é”é‡Šæ”¾åå†è·å–è¯»é”çš„å¼€é”€
- **æé«˜å¹¶å‘æ€§**: é™çº§åå…è®¸å…¶ä»–è¯»è€…åŒæ—¶è®¿é—®
- **åŸå­æ€§ä¿è¯**: æ›´æ–°å’Œè¯»å–åœ¨åŒä¸€ä¸ªé”ä¿æŠ¤ä¸‹å®Œæˆ

---

## å±•å¼€è¡¨é»˜è®¤å¯ç”¨ (Rust 1.92.0 æ–°å¢) â­

Rust 1.92.0 ä¸­ï¼Œå³ä½¿ä½¿ç”¨ `-Cpanic=abort` é€‰é¡¹ï¼Œå±•å¼€è¡¨ä¹Ÿä¼šé»˜è®¤å¯ç”¨ã€‚è¿™ç¡®ä¿äº†åœ¨è¿™äº›æ¡ä»¶ä¸‹å›æº¯åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚

### é…ç½®è¯´æ˜

åœ¨ `Cargo.toml` ä¸­ï¼š

```toml
[profile.release]
panic = "abort"  # å³ä½¿ä½¿ç”¨ abortï¼Œå±•å¼€è¡¨ä¹Ÿä¼šå¯ç”¨
```

### ä¼˜åŠ¿

- **æ›´å¥½çš„è°ƒè¯•ä½“éªŒ**: å³ä½¿ä½¿ç”¨ `panic = "abort"`ï¼Œä¹Ÿèƒ½è·å¾—å®Œæ•´çš„å›æº¯ä¿¡æ¯
- **ç”Ÿäº§ç¯å¢ƒå‹å¥½**: å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è·å¾—æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯
- **å¯é€‰æ‹©æ€§**: å¦‚æœä¸éœ€è¦å±•å¼€è¡¨ï¼Œå¯ä»¥ä½¿ç”¨ `-Cforce-unwind-tables=no` æ˜¾å¼ç¦ç”¨

---

## panic::catch_unwind æ€§èƒ½ä¼˜åŒ– (Rust 1.92.0 æ–°å¢) â­

Rust 1.92.0 ä¼˜åŒ–äº† `panic::catch_unwind` å‡½æ•°ï¼Œä¸å†åœ¨å…¥å£å¤„è®¿é—®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œæé«˜äº†æ€§èƒ½ã€‚

### æ€§èƒ½å½±å“

- **å‡å°‘å¼€é”€**: ä¸å†è®¿é—®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
- **æé«˜ååé‡**: åœ¨é«˜é¢‘è°ƒç”¨çš„åœºæ™¯ä¸­æ€§èƒ½æå‡æ˜æ˜¾
- **è‡ªåŠ¨å—ç›Š**: æ‰€æœ‰ä½¿ç”¨ `panic::catch_unwind` çš„ä»£ç è‡ªåŠ¨å—ç›Š

### ä½¿ç”¨ç¤ºä¾‹

```rust
use std::panic;

// Rust 1.92.0: ä¼˜åŒ–åçš„ catch_unwind æ€§èƒ½æ›´å¥½
let result = panic::catch_unwind(|| {
    // å¯èƒ½ panic çš„ä»£ç 
    risky_operation()
});

match result {
    Ok(value) => println!("æ“ä½œæˆåŠŸ: {:?}", value),
    Err(_) => println!("æ“ä½œå¤±è´¥ï¼Œä½†ç¨‹åºç»§ç»­è¿è¡Œ"),
}
```

---

## æ€»ç»“

Rust 1.92.0 çš„çº¿ç¨‹å¹¶å‘æ”¹è¿›ä½¿å¾—å¹¶å‘ç¼–ç¨‹æ›´åŠ å®‰å…¨å’Œé«˜æ•ˆï¼Œæä¾›äº†æ›´å¥½çš„å·¥å…·å’Œ APIã€‚

**æœ€åæ›´æ–°**: 2025-12-11
