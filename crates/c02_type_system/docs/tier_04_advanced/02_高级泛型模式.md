# 4.2 Rust ç±»å‹ç³»ç»Ÿ - é«˜çº§æ³›å‹æ¨¡å¼

> **æ–‡æ¡£ç±»å‹**: Tier 4 - é«˜çº§å±‚  
> **æ–‡æ¡£å®šä½**: é«˜çº§æ³›å‹ç¼–ç¨‹æ¨¡å¼  
> **é€‚ç”¨å¯¹è±¡**: é«˜çº§å¼€å‘è€…  
> **å‰ç½®çŸ¥è¯†**: [2.3 æ³›å‹ç¼–ç¨‹æŒ‡å—](../tier_02_guides/03_æ³›å‹ç¼–ç¨‹æŒ‡å—.md), [2.4 Traitç³»ç»ŸæŒ‡å—](../tier_02_guides/04_Traitç³»ç»ŸæŒ‡å—.md)  
> **æœ€åæ›´æ–°**: 2025-10-22

---

## ğŸ“‹ ç›®å½•

- [4.2 Rust ç±»å‹ç³»ç»Ÿ - é«˜çº§æ³›å‹æ¨¡å¼](#42-rust-ç±»å‹ç³»ç»Ÿ---é«˜çº§æ³›å‹æ¨¡å¼)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
  - [1. ç±»å‹çŠ¶æ€æ¨¡å¼](#1-ç±»å‹çŠ¶æ€æ¨¡å¼)
  - [2. ç±»å‹è§è¯æ¨¡å¼](#2-ç±»å‹è§è¯æ¨¡å¼)
  - [3. Newtype æ¨¡å¼](#3-newtype-æ¨¡å¼)
  - [4. Visitor æ¨¡å¼](#4-visitor-æ¨¡å¼)
  - [5. Extension Traits](#5-extension-traits)
  - [6. Sealed Traits](#6-sealed-traits)
  - [7. ç±»å‹æ“¦é™¤](#7-ç±»å‹æ“¦é™¤)
  - [8. æ€»ç»“](#8-æ€»ç»“)
  - [9. å‚è€ƒèµ„æº](#9-å‚è€ƒèµ„æº)

---

## ğŸ¯ æ¦‚è¿°

é«˜çº§æ³›å‹æ¨¡å¼ç”¨äºï¼š

- ğŸ”’ ç¼–è¯‘æ—¶çŠ¶æ€æ£€æŸ¥
- ğŸ¯ ç±»å‹å®‰å…¨çš„ API
- ğŸ”„ çµæ´»çš„ä»£ç å¤ç”¨
- âš¡ é›¶æˆæœ¬æŠ½è±¡

---

## 1. ç±»å‹çŠ¶æ€æ¨¡å¼

**ä½¿ç”¨ç±»å‹ç¼–ç çŠ¶æ€**:

```rust
use std::marker::PhantomData;

// çŠ¶æ€æ ‡è®°
struct New;
struct Initialized;
struct Configured;
struct Running;

// æ„å»ºå™¨ï¼Œä½¿ç”¨å¹»å½±ç±»å‹è·Ÿè¸ªçŠ¶æ€
struct Builder<State> {
    config: Option<String>,
    _state: PhantomData<State>,
}

impl Builder<New> {
    fn new() -> Self {
        Builder {
            config: None,
            _state: PhantomData,
        }
    }
    
    fn initialize(self) -> Builder<Initialized> {
        Builder {
            config: self.config,
            _state: PhantomData,
        }
    }
}

impl Builder<Initialized> {
    fn configure(mut self, config: String) -> Builder<Configured> {
        self.config = Some(config);
        Builder {
            config: self.config,
            _state: PhantomData,
        }
    }
}

impl Builder<Configured> {
    fn build(self) -> Builder<Running> {
        println!("Building with config: {:?}", self.config);
        Builder {
            config: self.config,
            _state: PhantomData,
        }
    }
}

impl Builder<Running> {
    fn run(&self) {
        println!("Running...");
    }
}

fn main() {
    let builder = Builder::<New>::new()
        .initialize()
        .configure(String::from("config.toml"))
        .build();
    
    builder.run();
    
    // âŒ ç¼–è¯‘é”™è¯¯ï¼šæ— æ³•è·³è¿‡çŠ¶æ€
    // let bad = Builder::<New>::new().build();
}
```

**å¤æ‚çŠ¶æ€æœº**:

```rust
use std::marker::PhantomData;

// TCP è¿æ¥çŠ¶æ€
struct Closed;
struct Listen;
struct SynRcvd;
struct Established;

struct TcpConnection<State> {
    socket: String,
    _state: PhantomData<State>,
}

impl TcpConnection<Closed> {
    fn new(socket: String) -> Self {
        TcpConnection {
            socket,
            _state: PhantomData,
        }
    }
    
    fn listen(self) -> TcpConnection<Listen> {
        println!("Listening on {}", self.socket);
        TcpConnection {
            socket: self.socket,
            _state: PhantomData,
        }
    }
}

impl TcpConnection<Listen> {
    fn accept(self) -> TcpConnection<SynRcvd> {
        println!("SYN received");
        TcpConnection {
            socket: self.socket,
            _state: PhantomData,
        }
    }
}

impl TcpConnection<SynRcvd> {
    fn acknowledge(self) -> TcpConnection<Established> {
        println!("Connection established");
        TcpConnection {
            socket: self.socket,
            _state: PhantomData,
        }
    }
}

impl TcpConnection<Established> {
    fn send(&self, data: &str) {
        println!("Sending: {}", data);
    }
    
    fn close(self) -> TcpConnection<Closed> {
        println!("Connection closed");
        TcpConnection {
            socket: self.socket,
            _state: PhantomData,
        }
    }
}

fn main() {
    let conn = TcpConnection::<Closed>::new(String::from("127.0.0.1:8080"))
        .listen()
        .accept()
        .acknowledge();
    
    conn.send("Hello");
    let _closed = conn.close();
}
```

---

## 2. ç±»å‹è§è¯æ¨¡å¼

**ä½¿ç”¨ç±»å‹è¯æ˜å±æ€§**:

```rust
use std::marker::PhantomData;

// ç©ºç±»å‹ä½œä¸ºè¯æ˜
struct NonEmpty;

struct Vec<T, Proof = ()> {
    inner: std::vec::Vec<T>,
    _proof: PhantomData<Proof>,
}

impl<T> Vec<T, ()> {
    fn new() -> Self {
        Vec {
            inner: std::vec::Vec::new(),
            _proof: PhantomData,
        }
    }
    
    fn push(mut self, item: T) -> Vec<T, NonEmpty> {
        self.inner.push(item);
        Vec {
            inner: self.inner,
            _proof: PhantomData,
        }
    }
}

impl<T> Vec<T, NonEmpty> {
    fn first(&self) -> &T {
        &self.inner[0]  // ä¿è¯éç©ºï¼Œä¸ä¼š panic
    }
    
    fn push(mut self, item: T) -> Self {
        self.inner.push(item);
        self
    }
}

fn main() {
    let empty = Vec::<i32>::new();
    // empty.first();  // âŒ ç¼–è¯‘é”™è¯¯ï¼šæ²¡æœ‰ first æ–¹æ³•
    
    let non_empty = empty.push(1);
    println!("First: {}", non_empty.first());  // âœ… å®‰å…¨
}
```

**æ’åºè§è¯**:

```rust
use std::marker::PhantomData;

struct Unsorted;
struct Sorted;

struct List<T, State = Unsorted> {
    items: Vec<T>,
    _state: PhantomData<State>,
}

impl<T> List<T, Unsorted> {
    fn new(items: Vec<T>) -> Self {
        List {
            items,
            _state: PhantomData,
        }
    }
    
    fn sort(mut self) -> List<T, Sorted>
    where
        T: Ord,
    {
        self.items.sort();
        List {
            items: self.items,
            _state: PhantomData,
        }
    }
}

impl<T: Ord> List<T, Sorted> {
    fn binary_search(&self, item: &T) -> Result<usize, usize> {
        self.items.binary_search(item)  // ä¿è¯å·²æ’åº
    }
}

fn main() {
    let unsorted = List::new(vec![3, 1, 4, 1, 5]);
    // unsorted.binary_search(&3);  // âŒ ç¼–è¯‘é”™è¯¯
    
    let sorted = unsorted.sort();
    println!("{:?}", sorted.binary_search(&3));  // âœ… å®‰å…¨
}
```

---

## 3. Newtype æ¨¡å¼

**ç±»å‹å®‰å…¨å°è£…**:

```rust
// å¼ºç±»å‹ ID
struct UserId(u64);
struct ProductId(u64);

fn get_user(id: UserId) -> String {
    format!("User {}", id.0)
}

fn get_product(id: ProductId) -> String {
    format!("Product {}", id.0)
}

fn main() {
    let user_id = UserId(123);
    let product_id = ProductId(456);
    
    println!("{}", get_user(user_id));
    // println!("{}", get_user(product_id));  // âŒ ç¼–è¯‘é”™è¯¯
}
```

**è®¡é‡å•ä½**:

```rust
use std::ops::{Add, Mul};

#[derive(Debug, Copy, Clone)]
struct Meters(f64);

#[derive(Debug, Copy, Clone)]
struct Seconds(f64);

#[derive(Debug, Copy, Clone)]
struct MetersPerSecond(f64);

impl Add for Meters {
    type Output = Meters;
    
    fn add(self, rhs: Self) -> Self::Output {
        Meters(self.0 + rhs.0)
    }
}

impl Mul<Seconds> for MetersPerSecond {
    type Output = Meters;
    
    fn mul(self, rhs: Seconds) -> Self::Output {
        Meters(self.0 * rhs.0)
    }
}

fn main() {
    let distance1 = Meters(100.0);
    let distance2 = Meters(50.0);
    let total = distance1 + distance2;
    println!("Total distance: {:?}", total);
    
    let velocity = MetersPerSecond(10.0);
    let time = Seconds(5.0);
    let distance = velocity * time;
    println!("Distance traveled: {:?}", distance);
    
    // let bad = distance1 + time;  // âŒ ç¼–è¯‘é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…
}
```

---

## 4. Visitor æ¨¡å¼

**ç±»å‹å®‰å…¨çš„ Visitor**:

```rust
trait Visitor {
    type Output;
    
    fn visit_int(&mut self, value: i32) -> Self::Output;
    fn visit_string(&mut self, value: &str) -> Self::Output;
    fn visit_bool(&mut self, value: bool) -> Self::Output;
}

enum Value {
    Int(i32),
    String(String),
    Bool(bool),
}

impl Value {
    fn accept<V: Visitor>(&self, visitor: &mut V) -> V::Output {
        match self {
            Value::Int(i) => visitor.visit_int(*i),
            Value::String(s) => visitor.visit_string(s),
            Value::Bool(b) => visitor.visit_bool(*b),
        }
    }
}

// å…·ä½“ Visitorï¼šæ‰“å°
struct PrintVisitor;

impl Visitor for PrintVisitor {
    type Output = ();
    
    fn visit_int(&mut self, value: i32) {
        println!("Int: {}", value);
    }
    
    fn visit_string(&mut self, value: &str) {
        println!("String: {}", value);
    }
    
    fn visit_bool(&mut self, value: bool) {
        println!("Bool: {}", value);
    }
}

// å…·ä½“ Visitorï¼šåºåˆ—åŒ–
struct JsonVisitor;

impl Visitor for JsonVisitor {
    type Output = String;
    
    fn visit_int(&mut self, value: i32) -> String {
        value.to_string()
    }
    
    fn visit_string(&mut self, value: &str) -> String {
        format!("\"{}\"", value)
    }
    
    fn visit_bool(&mut self, value: bool) -> String {
        value.to_string()
    }
}

fn main() {
    let values = vec![
        Value::Int(42),
        Value::String(String::from("hello")),
        Value::Bool(true),
    ];
    
    let mut print_visitor = PrintVisitor;
    let mut json_visitor = JsonVisitor;
    
    for value in &values {
        value.accept(&mut print_visitor);
        let json = value.accept(&mut json_visitor);
        println!("JSON: {}", json);
    }
}
```

---

## 5. Extension Traits

**ä¸ºå¤–éƒ¨ç±»å‹æ·»åŠ æ–¹æ³•**:

```rust
trait IntExt {
    fn is_even(self) -> bool;
    fn is_odd(self) -> bool;
}

impl IntExt for i32 {
    fn is_even(self) -> bool {
        self % 2 == 0
    }
    
    fn is_odd(self) -> bool {
        !self.is_even()
    }
}

fn main() {
    println!("4 is even: {}", 4.is_even());
    println!("5 is odd: {}", 5.is_odd());
}
```

**æ³›å‹æ‰©å±•**:

```rust
trait IteratorExt: Iterator {
    fn collect_vec(self) -> Vec<Self::Item>
    where
        Self: Sized,
    {
        self.collect()
    }
    
    fn sum_default(self) -> Self::Item
    where
        Self: Sized,
        Self::Item: Default + std::ops::Add<Output = Self::Item>,
    {
        self.fold(Self::Item::default(), |a, b| a + b)
    }
}

impl<T: Iterator> IteratorExt for T {}

fn main() {
    let vec = (1..=5).collect_vec();
    println!("Vec: {:?}", vec);
    
    let sum = (1..=10).sum_default();
    println!("Sum: {}", sum);
}
```

---

## 6. Sealed Traits

**é˜²æ­¢å¤–éƒ¨å®ç°**:

```rust
mod sealed {
    pub trait Sealed {}
    
    impl Sealed for i32 {}
    impl Sealed for f64 {}
    impl Sealed for String {}
}

pub trait Number: sealed::Sealed {
    fn double(&self) -> Self;
}

impl Number for i32 {
    fn double(&self) -> Self {
        self * 2
    }
}

impl Number for f64 {
    fn double(&self) -> Self {
        self * 2.0
    }
}

// å¤–éƒ¨æ— æ³•å®ç° Number trait
// impl Number for MyType {}  // âŒ ç¼–è¯‘é”™è¯¯ï¼šæœªå®ç° Sealed

fn main() {
    println!("Double 21: {}", 21.double());
    println!("Double 3.14: {}", 3.14.double());
}
```

---

## 7. ç±»å‹æ“¦é™¤

**åŠ¨æ€åˆ†å‘çš„ç±»å‹æ“¦é™¤**:

```rust
trait Draw {
    fn draw(&self);
}

struct Circle {
    radius: f64,
}

struct Rectangle {
    width: f64,
    height: f64,
}

impl Draw for Circle {
    fn draw(&self) {
        println!("Drawing circle with radius {}", self.radius);
    }
}

impl Draw for Rectangle {
    fn draw(&self) {
        println!("Drawing rectangle {}x{}", self.width, self.height);
    }
}

// ç±»å‹æ“¦é™¤å®¹å™¨
struct DrawBox {
    inner: Box<dyn Draw>,
}

impl DrawBox {
    fn new<T: Draw + 'static>(value: T) -> Self {
        DrawBox {
            inner: Box::new(value),
        }
    }
    
    fn draw(&self) {
        self.inner.draw();
    }
}

fn main() {
    let shapes: Vec<DrawBox> = vec![
        DrawBox::new(Circle { radius: 5.0 }),
        DrawBox::new(Rectangle { width: 10.0, height: 20.0 }),
    ];
    
    for shape in &shapes {
        shape.draw();
    }
}
```

---

## 8. æ€»ç»“

**é«˜çº§æ³›å‹æ¨¡å¼å¯¹æ¯”**:

| æ¨¡å¼ | ç”¨é€” | ç¼–è¯‘æ—¶ vs è¿è¡Œæ—¶ |
|------|------|-----------------|
| **ç±»å‹çŠ¶æ€** | çŠ¶æ€æœº | ç¼–è¯‘æ—¶ |
| **ç±»å‹è§è¯** | å±æ€§è¯æ˜ | ç¼–è¯‘æ—¶ |
| **Newtype** | ç±»å‹å®‰å…¨ | ç¼–è¯‘æ—¶ |
| **Visitor** | å¤šæ€æ“ä½œ | ç¼–è¯‘æ—¶ |
| **Extension** | æ·»åŠ æ–¹æ³• | ç¼–è¯‘æ—¶ |
| **Sealed** | å°é—­trait | ç¼–è¯‘æ—¶ |
| **ç±»å‹æ“¦é™¤** | å¼‚æ„é›†åˆ | è¿è¡Œæ—¶ |

**æ ¸å¿ƒåŸåˆ™**:

1. âœ… ç¼–è¯‘æ—¶éªŒè¯ä¼˜äºè¿è¡Œæ—¶
2. âœ… ç±»å‹å®‰å…¨ä¼˜äºä¾¿åˆ©
3. âœ… é›¶æˆæœ¬æŠ½è±¡
4. âœ… æ˜ç¡®çš„ API å¥‘çº¦

---

## 9. å‚è€ƒèµ„æº

**æ–‡ç« **:

- [The Typestate Pattern in Rust](https://cliffle.com/blog/rust-typestate/)
- [Rust Design Patterns](https://rust-unofficial.github.io/patterns/)

**ç›¸å…³æ–‡æ¡£**:

- [2.3 æ³›å‹ç¼–ç¨‹æŒ‡å—](../tier_02_guides/03_æ³›å‹ç¼–ç¨‹æŒ‡å—.md)
- [2.4 Traitç³»ç»ŸæŒ‡å—](../tier_02_guides/04_Traitç³»ç»ŸæŒ‡å—.md)
- [4.1 ç±»å‹ç†è®ºæ·±åº¦](./01_ç±»å‹ç†è®ºæ·±åº¦.md)

---

**æœ€åæ›´æ–°**: 2025-10-22  
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.90+  
**æ–‡æ¡£ç±»å‹**: Tier 4 - é«˜çº§å±‚

---

**ğŸ‰ å®Œæˆé«˜çº§æ³›å‹æ¨¡å¼å­¦ä¹ ï¼** ğŸ¦€
