# 3.2 Rust ç±»å‹ç³»ç»Ÿ - ç±»å‹å‹å˜å‚è€ƒ

> **æ–‡æ¡£ç±»å‹**: Tier 3 - å‚è€ƒå±‚  
> **æ–‡æ¡£å®šä½**: ç±»å‹å‹å˜ï¼ˆVarianceï¼‰å®Œæ•´å‚è€ƒ  
> **é€‚ç”¨å¯¹è±¡**: é«˜çº§å¼€å‘è€…  
> **å‰ç½®çŸ¥è¯†**: [2.3 æ³›å‹ç¼–ç¨‹æŒ‡å—](../tier_02_guides/03_æ³›å‹ç¼–ç¨‹æŒ‡å—.md), [2.5 ç”Ÿå‘½å‘¨æœŸæŒ‡å—](../tier_02_guides/05_ç”Ÿå‘½å‘¨æœŸæŒ‡å—.md)  
> **æœ€åæ›´æ–°**: 2025-10-22

---

## ğŸ“‹ ç›®å½•

- [3.2 Rust ç±»å‹ç³»ç»Ÿ - ç±»å‹å‹å˜å‚è€ƒ](#32-rust-ç±»å‹ç³»ç»Ÿ---ç±»å‹å‹å˜å‚è€ƒ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
  - [1. å‹å˜åŸºç¡€](#1-å‹å˜åŸºç¡€)
    - [1.1 ä»€ä¹ˆæ˜¯å‹å˜](#11-ä»€ä¹ˆæ˜¯å‹å˜)
    - [1.2 å­ç±»å‹å…³ç³»](#12-å­ç±»å‹å…³ç³»)
    - [1.3 å‹å˜çš„ä¸‰ç§ç±»å‹](#13-å‹å˜çš„ä¸‰ç§ç±»å‹)
  - [2. åå˜ (Covariance)](#2-åå˜-covariance)
    - [2.1 å®šä¹‰](#21-å®šä¹‰)
    - [2.2 ç¤ºä¾‹](#22-ç¤ºä¾‹)
    - [2.3 å¸¸è§åå˜ç±»å‹](#23-å¸¸è§åå˜ç±»å‹)
  - [3. é€†å˜ (Contravariance)](#3-é€†å˜-contravariance)
    - [3.1 å®šä¹‰](#31-å®šä¹‰)
    - [3.2 å‡½æ•°å‚æ•°](#32-å‡½æ•°å‚æ•°)
    - [3.3 å®é™…åº”ç”¨](#33-å®é™…åº”ç”¨)
  - [4. ä¸å˜ (Invariance)](#4-ä¸å˜-invariance)
    - [4.1 å®šä¹‰](#41-å®šä¹‰)
    - [4.2 å¯å˜å¼•ç”¨](#42-å¯å˜å¼•ç”¨)
    - [4.3 ä¸ºä»€ä¹ˆéœ€è¦ä¸å˜](#43-ä¸ºä»€ä¹ˆéœ€è¦ä¸å˜)
  - [5. ç”Ÿå‘½å‘¨æœŸçš„å‹å˜](#5-ç”Ÿå‘½å‘¨æœŸçš„å‹å˜)
    - [5.1 ç”Ÿå‘½å‘¨æœŸå­ç±»å‹](#51-ç”Ÿå‘½å‘¨æœŸå­ç±»å‹)
    - [5.2 å¼•ç”¨çš„å‹å˜](#52-å¼•ç”¨çš„å‹å˜)
    - [5.3 å¤åˆç±»å‹çš„å‹å˜](#53-å¤åˆç±»å‹çš„å‹å˜)
  - [6. PhantomData](#6-phantomdata)
    - [6.1 å‹å˜æ ‡è®°](#61-å‹å˜æ ‡è®°)
    - [6.2 Drop Check](#62-drop-check)
    - [6.3 å®é™…åº”ç”¨](#63-å®é™…åº”ç”¨)
  - [7. å‹å˜è§„åˆ™è¡¨](#7-å‹å˜è§„åˆ™è¡¨)
  - [8. å®æˆ˜æ¡ˆä¾‹](#8-å®æˆ˜æ¡ˆä¾‹)
    - [æ¡ˆä¾‹ 1: é›†åˆçš„å‹å˜](#æ¡ˆä¾‹-1-é›†åˆçš„å‹å˜)
    - [æ¡ˆä¾‹ 2: æ™ºèƒ½æŒ‡é’ˆ](#æ¡ˆä¾‹-2-æ™ºèƒ½æŒ‡é’ˆ)
    - [æ¡ˆä¾‹ 3: è¿­ä»£å™¨](#æ¡ˆä¾‹-3-è¿­ä»£å™¨)
  - [9. å¸¸è§é™·é˜±](#9-å¸¸è§é™·é˜±)
  - [10. æ€»ç»“](#10-æ€»ç»“)
  - [11. å‚è€ƒèµ„æº](#11-å‚è€ƒèµ„æº)

---

## ğŸ¯ æ¦‚è¿°

**å‹å˜** (Variance) æè¿°äº†æ³›å‹ç±»å‹å‚æ•°çš„å­ç±»å‹å…³ç³»å¦‚ä½•å½±å“åŒ…å«å®ƒä»¬çš„å¤åˆç±»å‹çš„å­ç±»å‹å…³ç³»ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**:

- ğŸ”„ **åå˜**: ä¿æŒå­ç±»å‹å…³ç³»
- â†”ï¸ **é€†å˜**: åè½¬å­ç±»å‹å…³ç³»  
- ğŸš« **ä¸å˜**: ä¸å…è®¸å­ç±»å‹æ›¿æ¢

---

## 1. å‹å˜åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯å‹å˜

å‹å˜å†³å®šäº†ï¼š**å½“ `A` æ˜¯ `B` çš„å­ç±»å‹æ—¶ï¼Œ`F<A>` å’Œ `F<B>` æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ**

```rust
// å¦‚æœ 'static æ˜¯ 'a çš„å­ç±»å‹
// é‚£ä¹ˆï¼š
// - &'static T æ˜¯ &'a T çš„å­ç±»å‹å—ï¼Ÿ (åå˜)
// - &'static mut T æ˜¯ &'a mut T çš„å­ç±»å‹å—ï¼Ÿ (ä¸å˜)
```

### 1.2 å­ç±»å‹å…³ç³»

**ç”Ÿå‘½å‘¨æœŸå­ç±»å‹**:

```rust
fn main() {
    // 'static æ˜¯æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸçš„å­ç±»å‹
    let s: &'static str = "hello";
    let _: &str = s;  // âœ… 'static <: 'a
    
    // æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ›´çŸ­ç”Ÿå‘½å‘¨æœŸçš„å­ç±»å‹
    let x = String::from("data");
    {
        let y = &x;  // 'long
        {
            let _z: &str = y;  // 'short, 'long <: 'short
        }
    }
}
```

### 1.3 å‹å˜çš„ä¸‰ç§ç±»å‹

| å‹å˜ç±»å‹ | ç¬¦å· | å«ä¹‰ | ç¤ºä¾‹ |
|---------|------|------|------|
| **åå˜** | `F<A> <: F<B>` if `A <: B` | ä¿æŒå…³ç³» | `&'a T` |
| **é€†å˜** | `F<B> <: F<A>` if `A <: B` | åè½¬å…³ç³» | `fn(T)` |
| **ä¸å˜** | æ— å…³ç³» | ä¸å…è®¸æ›¿æ¢ | `&'a mut T` |

---

## 2. åå˜ (Covariance)

### 2.1 å®šä¹‰

**åå˜**ï¼šå¦‚æœ `A <: B`ï¼Œåˆ™ `F<A> <: F<B>`ã€‚

```rust
// 'static <: 'a
// æ‰€ä»¥ &'static str <: &'a str (åå˜)
fn foo<'a>(_: &'a str) {}

fn main() {
    let s: &'static str = "hello";
    foo(s);  // âœ… å¯ä»¥ä¼ é€’æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸ
}
```

### 2.2 ç¤ºä¾‹

**ä¸å¯å˜å¼•ç”¨æ˜¯åå˜çš„**:

```rust
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() { x } else { y }
}

fn main() {
    let s1: &'static str = "hello";
    let s2 = String::from("world");
    
    // 'static <: 'a, æ‰€ä»¥å¯ä»¥æ··ç”¨
    let result = longest(s1, &s2);
    println!("{}", result);
}
```

### 2.3 å¸¸è§åå˜ç±»å‹

```rust
use std::rc::Rc;
use std::sync::Arc;

fn main() {
    // Box<T> åœ¨ T ä¸Šåå˜
    let b: Box<&'static str> = Box::new("hello");
    let _: Box<&str> = b;  // âœ…
    
    // Vec<T> åœ¨ T ä¸Šåå˜
    let v: Vec<&'static str> = vec!["a", "b"];
    let _: Vec<&str> = v;  // âœ…
    
    // Rc<T> åœ¨ T ä¸Šåå˜
    let rc: Rc<&'static str> = Rc::new("data");
    let _: Rc<&str> = rc;  // âœ…
}
```

---

## 3. é€†å˜ (Contravariance)

### 3.1 å®šä¹‰

**é€†å˜**ï¼šå¦‚æœ `A <: B`ï¼Œåˆ™ `F<B> <: F<A>`ï¼ˆå…³ç³»åè½¬ï¼‰ã€‚

### 3.2 å‡½æ•°å‚æ•°

**å‡½æ•°å‚æ•°æ˜¯é€†å˜çš„**:

```rust
// 'a <: 'static
// æ‰€ä»¥ fn(&'static str) <: fn(&'a str) (é€†å˜)

fn apply<F>(f: F, value: &'static str)
where
    F: Fn(&str),  // æ¥å—ä»»æ„ç”Ÿå‘½å‘¨æœŸ
{
    f(value);
}

fn main() {
    apply(|s| println!("{}", s), "hello");
}
```

### 3.3 å®é™…åº”ç”¨

**å›è°ƒå‡½æ•°**:

```rust
trait Callback {
    fn call(&self, data: &str);
}

struct Logger;

impl Callback for Logger {
    fn call(&self, data: &str) {
        println!("Log: {}", data);
    }
}

fn process<'a, C: Callback>(callback: &C, data: &'a str) {
    callback.call(data);
}

fn main() {
    let logger = Logger;
    let data = String::from("message");
    process(&logger, &data);
}
```

---

## 4. ä¸å˜ (Invariance)

### 4.1 å®šä¹‰

**ä¸å˜**ï¼šå³ä½¿ `A <: B`ï¼Œ`F<A>` å’Œ `F<B>` ä¹Ÿæ²¡æœ‰å­ç±»å‹å…³ç³»ã€‚

### 4.2 å¯å˜å¼•ç”¨

**`&mut T` æ˜¯ä¸å˜çš„**:

```rust
fn main() {
    let mut s: &'static str = "hello";
    
    // âŒ ç¼–è¯‘é”™è¯¯ï¼š&mut æ˜¯ä¸å˜çš„
    // let r: &mut &str = &mut s;
    
    // å¦‚æœå…è®¸ï¼Œå¯èƒ½å¯¼è‡´æ‚¬å‚å¼•ç”¨
}
```

**ä¸ºä»€ä¹ˆä¸å˜æ˜¯å¿…è¦çš„**:

```rust
// å‡è®¾ &mut æ˜¯åå˜çš„ï¼ˆå®é™…ä¸Šä¸æ˜¯ï¼‰
fn hypothetical_bad() {
    let mut x: &'static str = "hello";
    let mut y: &str;
    
    // å¦‚æœè¿™æ ·å¯ä»¥ï¼ˆå®é™…ä¸è¡Œï¼‰
    // let r: &mut &str = &mut x;
    // *r = &String::from("temporary");
    // ç°åœ¨ x æŒ‡å‘å·²è¢«é”€æ¯çš„ Stringï¼
}
```

### 4.3 ä¸ºä»€ä¹ˆéœ€è¦ä¸å˜

**ä¿è¯å†…å­˜å®‰å…¨**:

```rust
fn extend_lifetime<'a>(r: &mut &'a str, s: &'a str) {
    *r = s;
}

fn main() {
    let mut long: &'static str = "long";
    {
        let short = String::from("short");
        // extend_lifetime(&mut long, &short);  // âŒ ç¼–è¯‘é”™è¯¯
        // å¦‚æœå…è®¸ï¼Œlong ä¼šæŒ‡å‘å·²é‡Šæ”¾çš„å†…å­˜
    }
    // println!("{}", long);  // æ‚¬å‚å¼•ç”¨ï¼
}
```

---

## 5. ç”Ÿå‘½å‘¨æœŸçš„å‹å˜

### 5.1 ç”Ÿå‘½å‘¨æœŸå­ç±»å‹

```rust
// 'a: 'b è¡¨ç¤º 'a è‡³å°‘å’Œ 'b ä¸€æ ·é•¿
// å³ 'a æ˜¯ 'b çš„å­ç±»å‹
fn choose<'a: 'b, 'b>(first: &'a str, _second: &'b str) -> &'b str {
    first
}

fn main() {
    let s1: &'static str = "first";
    let s2 = String::from("second");
    let result = choose(s1, &s2);
    println!("{}", result);
}
```

### 5.2 å¼•ç”¨çš„å‹å˜

```rust
use std::marker::PhantomData;

// &'a T åœ¨ 'a å’Œ T ä¸Šéƒ½æ˜¯åå˜çš„
struct Ref<'a, T: 'a> {
    reference: &'a T,
}

// &'a mut T åœ¨ 'a ä¸Šåå˜ï¼Œåœ¨ T ä¸Šä¸å˜
struct RefMut<'a, T: 'a> {
    reference: &'a mut T,
}

fn main() {
    let x = 42;
    let r = Ref { reference: &x };
    println!("Value: {}", r.reference);
}
```

### 5.3 å¤åˆç±»å‹çš„å‹å˜

```rust
// ç»“æ„ä½“çš„å‹å˜ç”±å…¶å­—æ®µå†³å®š
struct Container<'a, T> {
    data: &'a T,  // åå˜
}

struct MutContainer<'a, T> {
    data: &'a mut T,  // åœ¨ 'a ä¸Šåå˜ï¼Œåœ¨ T ä¸Šä¸å˜
}

fn main() {
    let x = String::from("data");
    let c = Container { data: &x };
    println!("{}", c.data);
}
```

---

## 6. PhantomData

### 6.1 å‹å˜æ ‡è®°

**æ˜¾å¼æ ‡è®°å‹å˜**:

```rust
use std::marker::PhantomData;

// ä¸æŒæœ‰ Tï¼Œä½†è¡¨ç°å¾—åƒæŒæœ‰ T
struct MyType<T> {
    _marker: PhantomData<T>,
}

// åå˜æ ‡è®°
struct CovariantType<T> {
    _marker: PhantomData<fn() -> T>,
}

// é€†å˜æ ‡è®°
struct ContravariantType<T> {
    _marker: PhantomData<fn(T)>,
}

// ä¸å˜æ ‡è®°
struct InvariantType<T> {
    _marker: PhantomData<fn(T) -> T>,
}

fn main() {
    let _: MyType<i32> = MyType {
        _marker: PhantomData,
    };
}
```

### 6.2 Drop Check

**Drop Check å’Œå‹å˜**:

```rust
use std::marker::PhantomData;

struct Inspector<'a, T: 'a> {
    _data: PhantomData<&'a T>,
}

impl<'a, T> Drop for Inspector<'a, T> {
    fn drop(&mut self) {
        println!("Dropping inspector");
    }
}

fn main() {
    let _inspector = Inspector::<i32> {
        _data: PhantomData,
    };
}
```

### 6.3 å®é™…åº”ç”¨

**æ‰€æœ‰æƒæ ‡è®°**:

```rust
use std::marker::PhantomData;

struct Owned<T> {
    _marker: PhantomData<T>,
}

struct Borrowed<'a, T: 'a> {
    _marker: PhantomData<&'a T>,
}

fn main() {
    let _owned: Owned<String> = Owned {
        _marker: PhantomData,
    };
}
```

---

## 7. å‹å˜è§„åˆ™è¡¨

**Rust ç±»å‹çš„å‹å˜è§„åˆ™**:

| ç±»å‹ | 'a | T |
|------|----|----|
| `&'a T` | åå˜ | åå˜ |
| `&'a mut T` | åå˜ | **ä¸å˜** |
| `*const T` | - | åå˜ |
| `*mut T` | - | **ä¸å˜** |
| `Box<T>` | - | åå˜ |
| `Vec<T>` | - | åå˜ |
| `Rc<T>` | - | åå˜ |
| `Arc<T>` | - | åå˜ |
| `Cell<T>` | - | **ä¸å˜** |
| `RefCell<T>` | - | **ä¸å˜** |
| `UnsafeCell<T>` | - | **ä¸å˜** |
| `fn(T) -> U` | - | **é€†å˜**(T), åå˜(U) |

---

## 8. å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: é›†åˆçš„å‹å˜

```rust
fn main() {
    // Vec åœ¨ T ä¸Šåå˜
    let static_vec: Vec<&'static str> = vec!["a", "b", "c"];
    
    fn print_vec(v: Vec<&str>) {
        for item in v {
            println!("{}", item);
        }
    }
    
    // å¯ä»¥ä¼ é€’ Vec<&'static str> åˆ°æœŸæœ› Vec<&str> çš„åœ°æ–¹
    print_vec(static_vec);
}
```

### æ¡ˆä¾‹ 2: æ™ºèƒ½æŒ‡é’ˆ

```rust
use std::rc::Rc;

struct Node<'a> {
    value: &'a str,
}

fn main() {
    let static_node = Node {
        value: "static data",
    };
    
    // Rc åœ¨ T ä¸Šåå˜
    let rc_static: Rc<Node<'static>> = Rc::new(static_node);
    let _rc_any: Rc<Node> = rc_static.clone();
}
```

### æ¡ˆä¾‹ 3: è¿­ä»£å™¨

```rust
struct Iter<'a, T> {
    slice: &'a [T],
    index: usize,
}

impl<'a, T> Iter<'a, T> {
    fn new(slice: &'a [T]) -> Self {
        Iter { slice, index: 0 }
    }
}

impl<'a, T> Iterator for Iter<'a, T> {
    type Item = &'a T;
    
    fn next(&mut self) -> Option<Self::Item> {
        if self.index < self.slice.len() {
            let item = &self.slice[self.index];
            self.index += 1;
            Some(item)
        } else {
            None
        }
    }
}

fn main() {
    let data = vec![1, 2, 3, 4, 5];
    let iter = Iter::new(&data);
    
    for value in iter {
        println!("{}", value);
    }
}
```

---

## 9. å¸¸è§é™·é˜±

**é™·é˜± 1: è¯¯è§£å¯å˜å¼•ç”¨çš„å‹å˜**:

```rust
// âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸º &mut æ˜¯åå˜çš„
fn bad_example() {
    let mut s: &'static str = "hello";
    // let r: &mut &str = &mut s;  // ç¼–è¯‘é”™è¯¯ï¼
    // å¦‚æœå…è®¸ï¼Œå¯èƒ½å¯¼è‡´æ‚¬å‚å¼•ç”¨
}
```

**é™·é˜± 2: PhantomData ä½¿ç”¨ä¸å½“**:

```rust
use std::marker::PhantomData;

// âŒ é”™è¯¯ï¼šä½¿ç”¨äº†é”™è¯¯çš„å‹å˜æ ‡è®°
struct WrongVariance<T> {
    _marker: PhantomData<T>,  // åº”è¯¥ä½¿ç”¨ PhantomData<*const T>
}
```

**é™·é˜± 3: Drop å’Œå‹å˜å†²çª**:

```rust
// Drop å®ç°å¯èƒ½å½±å“å‹å˜è§„åˆ™
struct Wrapper<'a, T: 'a> {
    data: &'a T,
}

// Drop ä¼šå½±å“ borrow checker çš„æ¨æ–­
impl<'a, T> Drop for Wrapper<'a, T> {
    fn drop(&mut self) {
        println!("Dropping wrapper");
    }
}

fn main() {
    let x = 42;
    let _w = Wrapper { data: &x };
}
```

---

## 10. æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å‹å˜ç±»å‹**
   - åå˜ï¼šä¿æŒå­ç±»å‹å…³ç³»
   - é€†å˜ï¼šåè½¬å­ç±»å‹å…³ç³»
   - ä¸å˜ï¼šä¸å…è®¸æ›¿æ¢

2. **ç”Ÿå‘½å‘¨æœŸ**
   - `&'a T` åœ¨ä¸¤è€…ä¸Šåå˜
   - `&'a mut T` åœ¨ `'a` ä¸Šåå˜ï¼Œåœ¨ `T` ä¸Šä¸å˜

3. **å®‰å…¨æ€§**
   - ä¸å˜ä¿è¯å†…å­˜å®‰å…¨
   - é˜²æ­¢æ‚¬å‚å¼•ç”¨

4. **PhantomData**
   - æ ‡è®°å‹å˜è¡Œä¸º
   - å½±å“ Drop Check

**è®°å¿†æ³•åˆ™**:

- âœ… åªè¯» â†’ åå˜
- âš ï¸ å¯å†™ â†’ ä¸å˜
- ğŸ”„ å‡½æ•°å‚æ•° â†’ é€†å˜

---

## 11. å‚è€ƒèµ„æº

**å®˜æ–¹æ–‡æ¡£**:

- [Rustonomicon - Subtyping and Variance](https://doc.rust-lang.org/nomicon/subtyping.html)
- [Rust Reference - Variance](https://doc.rust-lang.org/reference/subtyping.html)

**ç›¸å…³æ–‡æ¡£**:

- [2.3 æ³›å‹ç¼–ç¨‹æŒ‡å—](../tier_02_guides/03_æ³›å‹ç¼–ç¨‹æŒ‡å—.md)
- [2.5 ç”Ÿå‘½å‘¨æœŸæŒ‡å—](../tier_02_guides/05_ç”Ÿå‘½å‘¨æœŸæŒ‡å—.md)
- [3.1 ç±»å‹è½¬æ¢å‚è€ƒ](./01_ç±»å‹è½¬æ¢å‚è€ƒ.md)

---

**æœ€åæ›´æ–°**: 2025-10-22  
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.90+  
**æ–‡æ¡£ç±»å‹**: Tier 3 - å‚è€ƒå±‚

---

**ğŸ‰ å®Œæˆç±»å‹å‹å˜å‚è€ƒå­¦ä¹ ï¼** ğŸ¦€
