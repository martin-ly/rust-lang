# 3.6 Rust ç±»å‹ç³»ç»Ÿ - äº’æ“ä½œå‚è€ƒ

> **æ–‡æ¡£ç±»å‹**: Tier 3 - å‚è€ƒå±‚
> **æ–‡æ¡£å®šä½**: Rust ä¸å…¶ä»–è¯­è¨€çš„ç±»å‹ç³»ç»Ÿäº’æ“ä½œå‚è€ƒ
> **é€‚ç”¨å¯¹è±¡**: é«˜çº§å¼€å‘è€…ã€ç³»ç»Ÿé›†æˆå¼€å‘è€…
> **å‰ç½®çŸ¥è¯†**: [ç±»å‹ç³»ç»Ÿè§„èŒƒ](./01_ç±»å‹ç³»ç»Ÿè§„èŒƒ.md)
> **æœ€åæ›´æ–°**: 2025-12-11
> **Rustç‰ˆæœ¬**: 1.92.0+

---

## ğŸ“‹ ç›®å½•

- [3.6 Rust ç±»å‹ç³»ç»Ÿ - äº’æ“ä½œå‚è€ƒ](#36-rust-ç±»å‹ç³»ç»Ÿ---äº’æ“ä½œå‚è€ƒ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
    - [äº’æ“ä½œèŒƒå›´](#äº’æ“ä½œèŒƒå›´)
  - [1. C è¯­è¨€äº’æ“ä½œ](#1-c-è¯­è¨€äº’æ“ä½œ)
    - [1.1 åŸºæœ¬ç±»å‹æ˜ å°„](#11-åŸºæœ¬ç±»å‹æ˜ å°„)
    - [1.2 è°ƒç”¨ C å‡½æ•°](#12-è°ƒç”¨-c-å‡½æ•°)
    - [1.3 æš´éœ² Rust å‡½æ•°ç»™ C](#13-æš´éœ²-rust-å‡½æ•°ç»™-c)
  - [2. C++ äº’æ“ä½œ](#2-c-äº’æ“ä½œ)
    - [2.1 ä½¿ç”¨ cxx åº“](#21-ä½¿ç”¨-cxx-åº“)
    - [2.2 ç±»å‹æ˜ å°„](#22-ç±»å‹æ˜ å°„)
  - [3. Python äº’æ“ä½œ](#3-python-äº’æ“ä½œ)
    - [3.1 ä½¿ç”¨ PyO3](#31-ä½¿ç”¨-pyo3)
    - [3.2 ç±»å‹è½¬æ¢](#32-ç±»å‹è½¬æ¢)
  - [4. JavaScript/WebAssembly äº’æ“ä½œ](#4-javascriptwebassembly-äº’æ“ä½œ)
    - [4.1 ä½¿ç”¨ wasm-bindgen](#41-ä½¿ç”¨-wasm-bindgen)
    - [4.2 ç±»å‹æ˜ å°„](#42-ç±»å‹æ˜ å°„)
  - [5. Java äº’æ“ä½œ](#5-java-äº’æ“ä½œ)
    - [5.1 ä½¿ç”¨ jni](#51-ä½¿ç”¨-jni)
  - [6. Go äº’æ“ä½œ](#6-go-äº’æ“ä½œ)
    - [6.1 CGO æ¥å£](#61-cgo-æ¥å£)
  - [7. ç±»å‹æ˜ å°„å‚è€ƒ](#7-ç±»å‹æ˜ å°„å‚è€ƒ)
    - [7.1 å®Œæ•´ç±»å‹æ˜ å°„è¡¨](#71-å®Œæ•´ç±»å‹æ˜ å°„è¡¨)
  - [8. FFI æœ€ä½³å®è·µ](#8-ffi-æœ€ä½³å®è·µ)
    - [8.1 å®‰å…¨æ€§](#81-å®‰å…¨æ€§)
    - [8.2 é”™è¯¯å¤„ç†](#82-é”™è¯¯å¤„ç†)
    - [8.3 å†…å­˜ç®¡ç†](#83-å†…å­˜ç®¡ç†)
  - [9. å¸¸è§é—®é¢˜](#9-å¸¸è§é—®é¢˜)
    - [é—®é¢˜1: ç±»å‹å¤§å°ä¸åŒ¹é…](#é—®é¢˜1-ç±»å‹å¤§å°ä¸åŒ¹é…)
    - [é—®é¢˜2: è°ƒç”¨çº¦å®šä¸åŒ¹é…](#é—®é¢˜2-è°ƒç”¨çº¦å®šä¸åŒ¹é…)
    - [é—®é¢˜3: å­—ç¬¦ä¸²ç¼–ç é—®é¢˜](#é—®é¢˜3-å­—ç¬¦ä¸²ç¼–ç é—®é¢˜)
  - [10. å‚è€ƒèµ„æº](#10-å‚è€ƒèµ„æº)
    - [10.1 å®˜æ–¹æ–‡æ¡£](#101-å®˜æ–¹æ–‡æ¡£)
    - [10.2 ç›¸å…³åº“](#102-ç›¸å…³åº“)

---

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾› Rust ç±»å‹ç³»ç»Ÿä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€äº’æ“ä½œçš„å®Œæ•´å‚è€ƒï¼ŒåŒ…æ‹¬ç±»å‹æ˜ å°„ã€FFI ä½¿ç”¨ã€æ•°æ®è½¬æ¢ç­‰ã€‚

### äº’æ“ä½œèŒƒå›´

- C/C++ FFI
- Python ç»‘å®š
- JavaScript/WebAssembly
- Java JNI
- Go cgo
- ç±»å‹ç³»ç»Ÿæ˜ å°„

---

## 1. C è¯­è¨€äº’æ“ä½œ

### 1.1 åŸºæœ¬ç±»å‹æ˜ å°„

Rust ä¸ C çš„åŸºæœ¬ç±»å‹å¯¹åº”ï¼š

| Rust ç±»å‹ | C ç±»å‹ | è¯´æ˜ |
|-----------|--------|------|
| `i8` | `int8_t` | 8ä½æœ‰ç¬¦å·æ•´æ•° |
| `u8` | `uint8_t` | 8ä½æ— ç¬¦å·æ•´æ•° |
| `i16` | `int16_t` | 16ä½æœ‰ç¬¦å·æ•´æ•° |
| `u16` | `uint16_t` | 16ä½æ— ç¬¦å·æ•´æ•° |
| `i32` | `int32_t` | 32ä½æœ‰ç¬¦å·æ•´æ•° |
| `u32` | `uint32_t` | 32ä½æ— ç¬¦å·æ•´æ•° |
| `i64` | `int64_t` | 64ä½æœ‰ç¬¦å·æ•´æ•° |
| `u64` | `uint64_t` | 64ä½æ— ç¬¦å·æ•´æ•° |
| `f32` | `float` | 32ä½æµ®ç‚¹æ•° |
| `f64` | `double` | 64ä½æµ®ç‚¹æ•° |
| `bool` | `bool` | å¸ƒå°”ç±»å‹ |
| `*const T` | `const T*` | å¸¸é‡æŒ‡é’ˆ |
| `*mut T` | `T*` | å¯å˜æŒ‡é’ˆ |

### 1.2 è°ƒç”¨ C å‡½æ•°

```rust
use std::os::raw::c_int;

#[link(name = "mylib")]
extern "C" {
    fn my_c_function(x: c_int, y: c_int) -> c_int;
}

fn main() {
    unsafe {
        let result = my_c_function(10, 20);
        println!("Result: {}", result);
    }
}
```

### 1.3 æš´éœ² Rust å‡½æ•°ç»™ C

```rust
#[no_mangle]
pub extern "C" fn rust_function(x: i32, y: i32) -> i32 {
    x + y
}
```

---

## 2. C++ äº’æ“ä½œ

### 2.1 ä½¿ç”¨ cxx åº“

```rust
use cxx::bridge;

#[bridge]
mod ffi {
    extern "C++" {
        include!("myheader.hpp");

        type MyClass;

        fn new_my_class() -> UniquePtr<MyClass>;
        fn process(&self, value: i32) -> i32;
    }
}
```

### 2.2 ç±»å‹æ˜ å°„

C++ ç±»å‹åˆ° Rust çš„æ˜ å°„ï¼š

| C++ ç±»å‹ | Rust ç±»å‹ | è¯´æ˜ |
|----------|-----------|------|
| `std::string` | `String` | å­—ç¬¦ä¸² |
| `std::vector<T>` | `Vec<T>` | å‘é‡ |
| `std::unique_ptr<T>` | `UniquePtr<T>` | å”¯ä¸€æŒ‡é’ˆ |
| `std::shared_ptr<T>` | `SharedPtr<T>` | å…±äº«æŒ‡é’ˆ |

---

## 3. Python äº’æ“ä½œ

### 3.1 ä½¿ç”¨ PyO3

```rust
use pyo3::prelude::*;

#[pyfunction]
fn add(x: i32, y: i32) -> i32 {
    x + y
}

#[pymodule]
fn my_module(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(add, m)?)?;
    Ok(())
}
```

### 3.2 ç±»å‹è½¬æ¢

```rust
use pyo3::types::PyDict;

fn process_dict(py: Python, dict: &PyDict) -> PyResult<()> {
    let value: i32 = dict.get_item("key")?.unwrap().extract()?;
    Ok(())
}
```

---

## 4. JavaScript/WebAssembly äº’æ“ä½œ

### 4.1 ä½¿ç”¨ wasm-bindgen

```rust
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub fn greet(name: &str) -> String {
    format!("Hello, {}!", name)
}

#[wasm_bindgen]
pub struct Person {
    name: String,
    age: u32,
}

#[wasm_bindgen]
impl Person {
    #[wasm_bindgen(constructor)]
    pub fn new(name: String, age: u32) -> Person {
        Person { name, age }
    }

    #[wasm_bindgen(getter)]
    pub fn name(&self) -> String {
        self.name.clone()
    }
}
```

### 4.2 ç±»å‹æ˜ å°„

| Rust ç±»å‹ | JavaScript ç±»å‹ |
|-----------|----------------|
| `i32` | `number` |
| `f64` | `number` |
| `String` | `string` |
| `Vec<T>` | `Array` |
| `Option<T>` | `T | null` |
| `Result<T, E>` | `T | Error` |

---

## 5. Java äº’æ“ä½œ

### 5.1 ä½¿ç”¨ jni

```rust
use jni::JNIEnv;
use jni::objects::JClass;
use jni::sys::jstring;

#[no_mangle]
pub extern "system" fn Java_HelloWorld_greet(
    env: JNIEnv,
    _class: JClass,
    input: jstring,
) -> jstring {
    let input: String = env
        .get_string(input)
        .expect("Couldn't get java string!")
        .into();

    let output = env
        .new_string(format!("Hello from Rust, {}!", input))
        .expect("Couldn't create java string!");

    output.into_inner()
}
```

---

## 6. Go äº’æ“ä½œ

### 6.1 CGO æ¥å£

é€šè¿‡ C æ¥å£ä¸ Go äº’æ“ä½œï¼š

```rust
// Rust ä¾§
#[no_mangle]
pub extern "C" fn rust_function(x: i32) -> i32 {
    x * 2
}
```

```go
// Go ä¾§
/*
#cgo LDFLAGS: -L. -lrustlib
#include <stdint.h>
int32_t rust_function(int32_t x);
*/
import "C"

func main() {
    result := C.rust_function(42)
    fmt.Println(result)
}
```

---

## 7. ç±»å‹æ˜ å°„å‚è€ƒ

### 7.1 å®Œæ•´ç±»å‹æ˜ å°„è¡¨

| Rust | C | C++ | Python | JavaScript | Java |
|------|---|-----|--------|------------|------|
| `i32` | `int32_t` | `int32_t` | `int` | `number` | `int` |
| `i64` | `int64_t` | `int64_t` | `int` | `number` | `long` |
| `f64` | `double` | `double` | `float` | `number` | `double` |
| `bool` | `bool` | `bool` | `bool` | `boolean` | `boolean` |
| `String` | `char*` | `std::string` | `str` | `string` | `String` |
| `Vec<T>` | `T*` | `std::vector<T>` | `list` | `Array` | `List<T>` |
| `Option<T>` | `T*` (nullable) | `std::optional<T>` | `T \| None` | `T \| null` | `Optional<T>` |

---

## 8. FFI æœ€ä½³å®è·µ

### 8.1 å®‰å…¨æ€§

```rust
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨å®‰å…¨çš„åŒ…è£…
pub fn safe_wrapper(x: i32) -> Result<i32, String> {
    unsafe {
        let result = unsafe_c_function(x);
        if result < 0 {
            Err("Function failed".to_string())
        } else {
            Ok(result)
        }
    }
}

// âŒ ä¸å¥½çš„åšæ³•ï¼šç›´æ¥æš´éœ² unsafe
pub unsafe fn unsafe_function(x: i32) -> i32 {
    unsafe_c_function(x)
}
```

### 8.2 é”™è¯¯å¤„ç†

```rust
use std::ffi::CStr;
use std::os::raw::c_char;

pub fn get_error_message(ptr: *const c_char) -> Result<String, String> {
    if ptr.is_null() {
        return Err("Null pointer".to_string());
    }

    unsafe {
        let c_str = CStr::from_ptr(ptr);
        c_str.to_str()
            .map(|s| s.to_string())
            .map_err(|e| format!("Invalid UTF-8: {}", e))
    }
}
```

### 8.3 å†…å­˜ç®¡ç†

```rust
// ä½¿ç”¨ Box ç®¡ç† C åˆ†é…çš„å†…å­˜
extern "C" {
    fn c_allocate() -> *mut c_void;
    fn c_free(ptr: *mut c_void);
}

struct CResource {
    ptr: *mut c_void,
}

impl Drop for CResource {
    fn drop(&mut self) {
        unsafe {
            c_free(self.ptr);
        }
    }
}
```

---

## 9. å¸¸è§é—®é¢˜

### é—®é¢˜1: ç±»å‹å¤§å°ä¸åŒ¹é…

**é”™è¯¯**: C å’Œ Rust ç±»å‹å¤§å°ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `std::mem::size_of` éªŒè¯

```rust
assert_eq!(std::mem::size_of::<i32>(), 4);
```

### é—®é¢˜2: è°ƒç”¨çº¦å®šä¸åŒ¹é…

**é”™è¯¯**: å‡½æ•°è°ƒç”¨çº¦å®šä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**: æ˜ç¡®æŒ‡å®šè°ƒç”¨çº¦å®š

```rust
#[no_mangle]
pub extern "C" fn function() {}  // C è°ƒç”¨çº¦å®š
```

### é—®é¢˜3: å­—ç¬¦ä¸²ç¼–ç é—®é¢˜

**é”™è¯¯**: UTF-8 å’Œ C å­—ç¬¦ä¸²è½¬æ¢é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `CString` å’Œ `CStr`

```rust
use std::ffi::{CString, CStr};

let c_str = CString::new("hello").unwrap();
let rust_str = CStr::from_ptr(c_str.as_ptr()).to_str().unwrap();
```

---

## 10. å‚è€ƒèµ„æº

### 10.1 å®˜æ–¹æ–‡æ¡£

- [Rust FFI Guide](https://doc.rust-lang.org/nomicon/ffi.html)
- [The Rust FFI Omnibus](http://jakegoulding.com/rust-ffi-omnibus/)

### 10.2 ç›¸å…³åº“

- [PyO3](https://pyo3.rs/) - Python ç»‘å®š
- [wasm-bindgen](https://rustwasm.github.io/wasm-bindgen/) - WebAssembly ç»‘å®š
- [cxx](https://cxx.rs/) - C++ äº’æ“ä½œ
- [jni](https://docs.rs/jni/) - Java äº’æ“ä½œ

---

**æœ€åæ›´æ–°**: 2025-12-11
**Rustç‰ˆæœ¬**: 1.92.0+
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
