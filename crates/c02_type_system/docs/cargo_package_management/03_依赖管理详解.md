# Cargo ä¾èµ–ç®¡ç†è¯¦è§£

## ğŸ“‹ ç›®å½•

- [Cargo ä¾èµ–ç®¡ç†è¯¦è§£](#cargo-ä¾èµ–ç®¡ç†è¯¦è§£)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ ä¾èµ–ç®¡ç†æ¦‚è§ˆ](#-ä¾èµ–ç®¡ç†æ¦‚è§ˆ)
  - [1. ä¾èµ–å£°æ˜](#1-ä¾èµ–å£°æ˜)
    - [1.1 åŸºæœ¬ä¾èµ–](#11-åŸºæœ¬ä¾èµ–)
    - [1.2 ä¾èµ–ç±»å‹](#12-ä¾èµ–ç±»å‹)
    - [1.3 ä¾èµ–æ¥æº](#13-ä¾èµ–æ¥æº)
  - [2. ç‰ˆæœ¬è§„èŒƒ](#2-ç‰ˆæœ¬è§„èŒƒ)
    - [2.1 è„±å­—ç¬¦ç‰ˆæœ¬ï¼ˆCaretï¼‰](#21-è„±å­—ç¬¦ç‰ˆæœ¬caret)
    - [2.2 æ³¢æµªå·ç‰ˆæœ¬ï¼ˆTildeï¼‰](#22-æ³¢æµªå·ç‰ˆæœ¬tilde)
    - [2.3 é€šé…ç¬¦ç‰ˆæœ¬](#23-é€šé…ç¬¦ç‰ˆæœ¬)
    - [2.4 æ¯”è¾ƒè¿ç®—ç¬¦](#24-æ¯”è¾ƒè¿ç®—ç¬¦)
    - [2.5 ç²¾ç¡®ç‰ˆæœ¬](#25-ç²¾ç¡®ç‰ˆæœ¬)
  - [3. Resolver 3 ä¾èµ–è§£æ](#3-resolver-3-ä¾èµ–è§£æ)
    - [3.1 ä»€ä¹ˆæ˜¯ Resolver](#31-ä»€ä¹ˆæ˜¯-resolver)
    - [3.2 Resolver 3 æ–°ç‰¹æ€§](#32-resolver-3-æ–°ç‰¹æ€§)
    - [3.3 ç‰¹æ€§ç»Ÿä¸€](#33-ç‰¹æ€§ç»Ÿä¸€)
    - [3.4 è§£æç®—æ³•](#34-è§£æç®—æ³•)
  - [4. ä¾èµ–å†²çªå¤„ç†](#4-ä¾èµ–å†²çªå¤„ç†)
    - [4.1 ç‰ˆæœ¬å†²çª](#41-ç‰ˆæœ¬å†²çª)
    - [4.2 ç‰¹æ€§å†²çª](#42-ç‰¹æ€§å†²çª)
    - [4.3 è§£å†³ç­–ç•¥](#43-è§£å†³ç­–ç•¥)
  - [5. Cargo.lock é”å®šæ–‡ä»¶](#5-cargolock-é”å®šæ–‡ä»¶)
    - [5.1 ä½œç”¨å’ŒåŸç†](#51-ä½œç”¨å’ŒåŸç†)
    - [5.2 æäº¤ç­–ç•¥](#52-æäº¤ç­–ç•¥)
    - [5.3 æ›´æ–°ä¾èµ–](#53-æ›´æ–°ä¾èµ–)
  - [6. ä¾èµ–ç‰¹æ€§ç®¡ç†](#6-ä¾èµ–ç‰¹æ€§ç®¡ç†)
    - [6.1 å¯ç”¨ç‰¹æ€§](#61-å¯ç”¨ç‰¹æ€§)
    - [6.2 å¯é€‰ä¾èµ–](#62-å¯é€‰ä¾èµ–)
    - [6.3 ç‰¹æ€§ä¼ æ’­](#63-ç‰¹æ€§ä¼ æ’­)
  - [7. å·¥ä½œç©ºé—´ä¾èµ–ç»§æ‰¿](#7-å·¥ä½œç©ºé—´ä¾èµ–ç»§æ‰¿)
    - [7.1 å£°æ˜å…±äº«ä¾èµ–](#71-å£°æ˜å…±äº«ä¾èµ–)
    - [7.2 æˆå‘˜ç»§æ‰¿](#72-æˆå‘˜ç»§æ‰¿)
    - [7.3 ç‰ˆæœ¬è¦†ç›–](#73-ç‰ˆæœ¬è¦†ç›–)
  - [8. å¹³å°ç‰¹å®šä¾èµ–](#8-å¹³å°ç‰¹å®šä¾èµ–)
    - [8.1 ç›®æ ‡å¹³å°æ¡ä»¶](#81-ç›®æ ‡å¹³å°æ¡ä»¶)
    - [8.2 å¸¸è§å¹³å°é…ç½®](#82-å¸¸è§å¹³å°é…ç½®)
  - [9. ä¾èµ–ä¼˜åŒ–](#9-ä¾èµ–ä¼˜åŒ–)
    - [9.1 ä¾èµ–è£å‰ª](#91-ä¾èµ–è£å‰ª)
    - [9.2 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–](#92-ç¼–è¯‘æ—¶é—´ä¼˜åŒ–)
    - [9.3 äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–](#93-äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–)
  - [10. ä¾èµ–å®‰å…¨](#10-ä¾èµ–å®‰å…¨)
    - [10.1 æ¼æ´æ£€æµ‹](#101-æ¼æ´æ£€æµ‹)
    - [10.2 ä¾èµ–å®¡è®¡](#102-ä¾èµ–å®¡è®¡)
    - [10.3 ä¾›åº”é“¾å®‰å…¨](#103-ä¾›åº”é“¾å®‰å…¨)
  - [ğŸ“Š æœ€ä½³å®è·µæ€»ç»“](#-æœ€ä½³å®è·µæ€»ç»“)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [ğŸ” å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)
  - [ğŸ“– å»¶ä¼¸é˜…è¯»](#-å»¶ä¼¸é˜…è¯»)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [å·¥å…·](#å·¥å…·)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ğŸ¯ ä¾èµ–ç®¡ç†æ¦‚è§ˆ

Cargo çš„ä¾èµ–ç®¡ç†ç³»ç»Ÿæ˜¯å…¶æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œæä¾›ï¼š

```mermaid
graph TD
    A[ä¾èµ–ç®¡ç†] --> B[ç‰ˆæœ¬è§„èŒƒ]
    A --> C[Resolver 3]
    A --> D[ç‰¹æ€§ç®¡ç†]
    A --> E[å†²çªè§£å†³]
    A --> F[å®‰å…¨å®¡è®¡]

    B --> B1[è¯­ä¹‰åŒ–ç‰ˆæœ¬]
    C --> C1[æ™ºèƒ½è§£æ]
    D --> D1[æ¡ä»¶ç¼–è¯‘]
    E --> E1[è‡ªåŠ¨ç»Ÿä¸€]
    F --> F1[æ¼æ´æ£€æµ‹]
```

---

## 1. ä¾èµ–å£°æ˜

### 1.1 åŸºæœ¬ä¾èµ–

```toml
[dependencies]
# æœ€ç®€å½¢å¼ï¼šä½¿ç”¨æœ€æ–°å…¼å®¹ç‰ˆæœ¬
serde = "1.0"

# å®Œæ•´å½¢å¼ï¼šæŒ‡å®šç‰ˆæœ¬å’Œç‰¹æ€§
tokio = { version = "1.48", features = ["full"] }

# ç¦ç”¨é»˜è®¤ç‰¹æ€§
regex = { version = "1.10", default-features = false }

# é‡å‘½åä¾èµ–
rand_core = { package = "rand", version = "0.8" }
```

### 1.2 ä¾èµ–ç±»å‹

```toml
# è¿è¡Œæ—¶ä¾èµ–ï¼ˆé»˜è®¤ï¼‰
[dependencies]
serde = "1.0"
tokio = "1.48"

# å¼€å‘ä¾èµ–ï¼ˆä»…ç”¨äºæµ‹è¯•å’Œå¼€å‘ï¼‰
[dev-dependencies]
proptest = "1.0"
criterion = "0.5"
tempfile = "3.10"

# æ„å»ºä¾èµ–ï¼ˆæ„å»ºè„šæœ¬éœ€è¦ï¼‰
[build-dependencies]
cc = "1.0"
protobuf-codegen = "3.0"
```

**åŒºåˆ«**ï¼š

| ç±»å‹                 | ç”¨é€”   | ç¼–è¯‘åˆ°äº§ç‰© | åœºæ™¯                 |
| -------------------- | ------ | ---------- | -------------------- |
| `dependencies`       | è¿è¡Œæ—¶ | âœ… æ˜¯      | åº“ä»£ç ã€åº”ç”¨é€»è¾‘     |
| `dev-dependencies`   | å¼€å‘æ—¶ | âŒ å¦      | æµ‹è¯•ã€åŸºå‡†æµ‹è¯•ã€ç¤ºä¾‹ |
| `build-dependencies` | æ„å»ºæ—¶ | âŒ å¦      | build.rs è„šæœ¬        |

### 1.3 ä¾èµ–æ¥æº

```toml
[dependencies]
# 1. crates.ioï¼ˆé»˜è®¤ï¼‰
serde = "1.0"

# 2. æœ¬åœ°è·¯å¾„
my-local-lib = { path = "../my-local-lib" }

# 3. Git ä»“åº“
# é»˜è®¤åˆ†æ”¯
my-git-lib = { git = "https://github.com/user/repo" }

# æŒ‡å®šåˆ†æ”¯
experimental = { git = "https://github.com/user/repo", branch = "develop" }

# æŒ‡å®šæ ‡ç­¾
stable = { git = "https://github.com/user/repo", tag = "v1.0.0" }

# æŒ‡å®šæäº¤
pinned = { git = "https://github.com/user/repo", rev = "abc123def456" }

# æŒ‡å®šå­ç›®å½•
sub-crate = { git = "https://github.com/user/mono-repo", path = "crates/sub" }

# 4. æ›¿ä»£æ³¨å†Œè¡¨
private = { version = "1.0", registry = "my-registry" }
```

---

## 2. ç‰ˆæœ¬è§„èŒƒ

### 2.1 è„±å­—ç¬¦ç‰ˆæœ¬ï¼ˆCaretï¼‰

**è¯­æ³•**: `^X.Y.Z` æˆ–ç®€å†™ `X.Y.Z`ï¼ˆé»˜è®¤ï¼‰

```toml
[dependencies]
# ä»¥ä¸‹ä¸¤ç§å†™æ³•ç­‰ä»·
serde = "1.0.0"
serde = "^1.0.0"

# å…è®¸èŒƒå›´ï¼š1.0.0 <= version < 2.0.0
# å®é™…å¯èƒ½è§£æä¸ºï¼š1.0.198ï¼ˆå½“å‰æœ€æ–°ï¼‰
```

**è§„åˆ™**ï¼š

```text
^1.2.3  â†’ 1.2.3 <= version < 2.0.0
^1.2    â†’ 1.2.0 <= version < 2.0.0
^1      â†’ 1.0.0 <= version < 2.0.0
^0.2.3  â†’ 0.2.3 <= version < 0.3.0  # 0.x ç‰¹æ®Šå¤„ç†
^0.0.3  â†’ 0.0.3 <= version < 0.0.4  # 0.0.x æ›´ä¸¥æ ¼
^0.0    â†’ 0.0.0 <= version < 0.1.0
```

### 2.2 æ³¢æµªå·ç‰ˆæœ¬ï¼ˆTildeï¼‰

**è¯­æ³•**: `~X.Y.Z`

```toml
[dependencies]
# åªå…è®¸ PATCH ç‰ˆæœ¬æ›´æ–°
tokio = "~1.48.0"
# å…è®¸èŒƒå›´ï¼š1.48.0 <= version < 1.49.0
```

**è§„åˆ™**ï¼š

```text
~1.2.3  â†’ 1.2.3 <= version < 1.3.0
~1.2    â†’ 1.2.0 <= version < 1.3.0
~1      â†’ 1.0.0 <= version < 2.0.0
```

### 2.3 é€šé…ç¬¦ç‰ˆæœ¬

```toml
[dependencies]
# é€šé…ç¬¦å…è®¸ä»»ä½•åŒ¹é…å€¼
any-patch = "1.0.*"   # 1.0.0 <= version < 1.1.0
any-minor = "1.*"     # 1.0.0 <= version < 2.0.0
any-major = "*"       # ä»»ä½•ç‰ˆæœ¬ï¼ˆä¸æ¨èï¼‰
```

### 2.4 æ¯”è¾ƒè¿ç®—ç¬¦

```toml
[dependencies]
# å¤§äºç­‰äº
at-least = ">= 1.0.0"

# å°äº
below = "< 2.0.0"

# èŒƒå›´ç»„åˆ
range = ">= 1.0.0, < 2.0.0"

# å¤æ‚èŒƒå›´
complex = ">= 1.0, < 1.3, != 1.1.5"
```

### 2.5 ç²¾ç¡®ç‰ˆæœ¬

```toml
[dependencies]
# åªå…è®¸ç²¾ç¡®è¿™ä¸ªç‰ˆæœ¬
critical = "=1.0.0"

# ä½¿ç”¨åœºæ™¯ï¼š
# - å·²çŸ¥å…¶ä»–ç‰ˆæœ¬æœ‰ bug
# - éœ€è¦ç‰¹å®šç‰ˆæœ¬çš„è¡Œä¸º
# - å®‰å…¨å…³é”®ä¾èµ–
```

**ç‰ˆæœ¬é€‰æ‹©å»ºè®®**ï¼š

| åœºæ™¯     | æ¨èè§„èŒƒ       | ç¤ºä¾‹       |
| -------- | -------------- | ---------- |
| ä¸€èˆ¬ä¾èµ– | è„±å­—ç¬¦ï¼ˆé»˜è®¤ï¼‰ | `"1.0"`    |
| ç¨³å®š API | æ³¢æµªå·         | `"~1.0.0"` |
| å…³é”®ä¾èµ– | ç²¾ç¡®ç‰ˆæœ¬       | `"=1.0.0"` |
| å¼€å‘ä¾èµ– | å®½æ¾èŒƒå›´       | `">= 1.0"` |

---

## 3. Resolver 3 ä¾èµ–è§£æ

### 3.1 ä»€ä¹ˆæ˜¯ Resolver

**Resolver** æ˜¯ Cargo çš„ä¾èµ–è§£æç®—æ³•ï¼Œè´Ÿè´£ï¼š

1. åˆ†æä¾èµ–æ ‘
2. é€‰æ‹©å…¼å®¹çš„ç‰ˆæœ¬
3. ç»Ÿä¸€ç‰¹æ€§
4. è§£å†³å†²çª

### 3.2 Resolver 3 æ–°ç‰¹æ€§

**Rust 1.92.0 æ”¯æŒçš„ Resolver 3**ï¼ˆè‡ª Rust 1.90 å¼•å…¥ï¼‰ï¼š

```toml
[package]
name = "my-package"
edition = "2024"
resolver = "3"      # ä½¿ç”¨ Resolver 3
```

**ä¸»è¦æ”¹è¿›**ï¼š

```mermaid
graph LR
    A[Resolver 3] --> B[æ›´ç²¾ç¡®çš„ç‰¹æ€§ç»Ÿä¸€]
    A --> C[æ›´å¥½çš„æ€§èƒ½]
    A --> D[å‡å°‘ä¸å¿…è¦çš„ç¼–è¯‘]
    A --> E[æ”¹è¿›çš„é”™è¯¯ä¿¡æ¯]
```

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§     | Resolver 2 | Resolver 3  |
| -------- | ---------- | ----------- |
| ç‰¹æ€§ä¼ æ’­ | å…¨å±€ç»Ÿä¸€   | æ™ºèƒ½ç»Ÿä¸€    |
| æ€§èƒ½     | åŸºå‡†       | æå‡ 15-20% |
| é”™è¯¯ä¿¡æ¯ | ç®€å•       | è¯¦ç»†æŒ‡å¼•    |
| å¹³å°ç‰¹å®š | åŸºç¡€æ”¯æŒ   | ä¼˜åŒ–æ”¯æŒ    |

### 3.3 ç‰¹æ€§ç»Ÿä¸€

**é—®é¢˜åœºæ™¯**ï¼š

```text
ä½ çš„é¡¹ç›®
  â”œâ”€â”€ dep-a (features = ["feature-x"])
  â””â”€â”€ dep-b
        â””â”€â”€ dep-a (features = ["feature-y"])
```

**Resolver 2 è¡Œä¸º**ï¼š

```toml
# ç»“æœï¼šdep-a åŒæ—¶å¯ç”¨ feature-x å’Œ feature-y
# å³ä½¿ä½ åªæƒ³åœ¨æŸäº›åœ°æ–¹å¯ç”¨ feature-x
```

**Resolver 3 æ”¹è¿›**ï¼š

```rust
// Resolver 3 æ›´æ™ºèƒ½åœ°å¤„ç†ç‰¹æ€§ä¼ æ’­
// - åŒºåˆ† build ä¾èµ–å’Œ è¿è¡Œæ—¶ä¾èµ–
// - é¿å…ä¸å¿…è¦çš„ç‰¹æ€§æ¿€æ´»
// - å‡å°‘ç¼–è¯‘æ—¶é—´å’ŒäºŒè¿›åˆ¶å¤§å°
```

### 3.4 è§£æç®—æ³•

**è§£ææ­¥éª¤**ï¼š

```mermaid
graph TD
    A[å¼€å§‹è§£æ] --> B[è¯»å– Cargo.toml]
    B --> C[æ”¶é›†æ‰€æœ‰ä¾èµ–]
    C --> D[æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§]
    D --> E{æœ‰å†²çª?}
    E -->|æ˜¯| F[å°è¯•å›æº¯]
    E -->|å¦| G[ç»Ÿä¸€ç‰¹æ€§]
    F --> D
    G --> H[ç”Ÿæˆ Cargo.lock]
    H --> I[å®Œæˆ]
```

**ç¤ºä¾‹**ï¼š

```toml
# ä½ çš„é¡¹ç›®
[dependencies]
serde = "1.0"
serde_json = "1.0"

# serde_json ä¹Ÿä¾èµ– serde = "1.0"
# Resolver ä¼šç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ª serde ç‰ˆæœ¬
```

**æŸ¥çœ‹è§£æç»“æœ**ï¼š

```bash
# æŸ¥çœ‹ä¾èµ–æ ‘
cargo tree

# æŸ¥çœ‹ç‰¹å®šä¾èµ–
cargo tree -p serde

# æŸ¥çœ‹é‡å¤ä¾èµ–
cargo tree --duplicates

# è¯¦ç»†è§£æä¿¡æ¯
cargo tree -e features
```

---

## 4. ä¾èµ–å†²çªå¤„ç†

### 4.1 ç‰ˆæœ¬å†²çª

**åœºæ™¯**ï¼š

```text
ä½ çš„é¡¹ç›®
  â”œâ”€â”€ lib-a ä¾èµ– common = "1.0"
  â””â”€â”€ lib-b ä¾èµ– common = "2.0"
```

**Cargo å¤„ç†**ï¼š

```toml
# Cargo å…è®¸åŒæ—¶å­˜åœ¨å¤šä¸ªç‰ˆæœ¬
# ç»“æœï¼šcommon 1.0 å’Œ common 2.0 éƒ½ä¼šè¢«ç¼–è¯‘
```

**æ£€æµ‹å†²çª**ï¼š

```bash
cargo tree --duplicates

# è¾“å‡ºç¤ºä¾‹ï¼š
# common v1.0.0
# â””â”€â”€ lib-a v1.0.0
# common v2.0.0
# â””â”€â”€ lib-b v1.0.0
```

### 4.2 ç‰¹æ€§å†²çª

**é—®é¢˜**ï¼š

```toml
# Package A éœ€è¦ serde ä¸å¸¦é»˜è®¤ç‰¹æ€§
serde = { version = "1.0", default-features = false }

# Package B éœ€è¦ serde å¸¦é»˜è®¤ç‰¹æ€§
serde = "1.0"  # é»˜è®¤å¯ç”¨æ‰€æœ‰ç‰¹æ€§
```

**è§£å†³**ï¼š

```toml
# Resolver ä¼šåˆå¹¶ç‰¹æ€§ï¼š
# ç»“æœï¼šserde ä¼šå¯ç”¨é»˜è®¤ç‰¹æ€§
# ï¼ˆç‰¹æ€§æ˜¯ç´¯åŠ çš„ï¼Œä¸èƒ½ç¦ç”¨ï¼‰
```

### 4.3 è§£å†³ç­–ç•¥

**ç­–ç•¥ 1: ç»Ÿä¸€ç‰ˆæœ¬**:

```toml
[dependencies]
# ä½¿ç”¨ workspace ç»Ÿä¸€ç‰ˆæœ¬
[workspace.dependencies]
common = "1.0"

# æˆå‘˜åŒ…éƒ½ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬
[dependencies]
common = { workspace = true }
```

**ç­–ç•¥ 2: ç‰ˆæœ¬è¡¥ä¸**:

```toml
[patch.crates-io]
# å°†æ‰€æœ‰å¯¹ common çš„å¼•ç”¨æ›¿æ¢ä¸ºæœ¬åœ°ç‰ˆæœ¬
common = { path = "../common" }

# æˆ–æ›¿æ¢ä¸ºç‰¹å®šç‰ˆæœ¬
common = { git = "https://github.com/user/common", branch = "fix" }
```

**ç­–ç•¥ 3: ä¾èµ–è¦†ç›–ï¼ˆæ…ç”¨ï¼‰**:

```toml
# å¼ºåˆ¶æ‰€æœ‰ä¾èµ–ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬
[patch.crates-io]
old-version = { package = "new-version", version = "2.0" }
```

---

## 5. Cargo.lock é”å®šæ–‡ä»¶

### 5.1 ä½œç”¨å’ŒåŸç†

**Cargo.toml** vs **Cargo.lock**ï¼š

```toml
# Cargo.toml - å£°æ˜ä¾èµ–èŒƒå›´
[dependencies]
serde = "1.0"  # å…è®¸ 1.0.0 <= version < 2.0.0

# Cargo.lock - è®°å½•ç²¾ç¡®ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
[[package]]
name = "serde"
version = "1.0.198"  # ç²¾ç¡®ç‰ˆæœ¬
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "abc123..."
dependencies = [...]
```

**ä½œç”¨**ï¼š

1. **å¯é‡ç°æ„å»º**: ç¡®ä¿æ‰€æœ‰äººä½¿ç”¨ç›¸åŒç‰ˆæœ¬
2. **ç‰ˆæœ¬é”å®š**: é˜²æ­¢æ„å¤–å‡çº§
3. **ä¾èµ–å®Œæ•´æ€§**: åŒ…å« checksum éªŒè¯

### 5.2 æäº¤ç­–ç•¥

```bash
# âœ… åº”ç”¨é¡¹ç›®ï¼ˆbinaryï¼‰ï¼šæäº¤ Cargo.lock
git add Cargo.lock
git commit -m "Lock dependencies"

# âŒ åº“é¡¹ç›®ï¼ˆlibraryï¼‰ï¼šä¸æäº¤ Cargo.lock
echo "Cargo.lock" >> .gitignore
```

**åŸå› **ï¼š

| é¡¹ç›®ç±»å‹   | æ˜¯å¦æäº¤ | åŸå›              |
| ---------- | -------- | ---------------- |
| åº”ç”¨ (bin) | âœ… æ˜¯    | ç¡®ä¿éƒ¨ç½²ä¸€è‡´æ€§   |
| åº“ (lib)   | âŒ å¦    | å…è®¸ç”¨æˆ·é€‰æ‹©ç‰ˆæœ¬ |
| å·¥ä½œç©ºé—´   | âœ… æ˜¯    | ç»Ÿä¸€æ‰€æœ‰æˆå‘˜ç‰ˆæœ¬ |

### 5.3 æ›´æ–°ä¾èµ–

```bash
# æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°å…¼å®¹ç‰ˆæœ¬
cargo update

# æ›´æ–°ç‰¹å®šä¾èµ–
cargo update -p serde

# ç²¾ç¡®æ›´æ–°åˆ°ç‰¹å®šç‰ˆæœ¬
cargo update -p serde --precise 1.0.195

# æŸ¥çœ‹å¯æ›´æ–°çš„ä¾èµ–
cargo outdated

# æ¿€è¿›æ›´æ–°ï¼ˆè·¨ MAJOR ç‰ˆæœ¬ï¼‰
cargo upgrade  # éœ€è¦ cargo-edit
```

**æ›´æ–°ç­–ç•¥**ï¼š

```bash
# å®šæœŸæ›´æ–°ï¼ˆæ¯æœˆï¼‰
cargo update

# å®‰å…¨æ›´æ–°ï¼ˆç«‹å³ï¼‰
cargo audit
cargo audit fix

# ä¸»ç‰ˆæœ¬å‡çº§ï¼ˆè¯„ä¼°åï¼‰
cargo outdated
# æ‰‹åŠ¨ä¿®æ”¹ Cargo.toml
cargo update
```

---

## 6. ä¾èµ–ç‰¹æ€§ç®¡ç†

### 6.1 å¯ç”¨ç‰¹æ€§

```toml
[dependencies]
# å¯ç”¨ç‰¹å®šç‰¹æ€§
tokio = { version = "1.48", features = ["rt", "macros"] }

# å¯ç”¨æ‰€æœ‰ç‰¹æ€§ï¼ˆä¸æ¨èï¼‰
tokio = { version = "1.48", features = ["full"] }

# ç¦ç”¨é»˜è®¤ç‰¹æ€§
serde = { version = "1.0", default-features = false }

# ç¦ç”¨é»˜è®¤ + å¯ç”¨ç‰¹å®šç‰¹æ€§
serde = { version = "1.0", default-features = false, features = ["derive"] }
```

### 6.2 å¯é€‰ä¾èµ–

```toml
[dependencies]
# å¿…éœ€ä¾èµ–
serde = "1.0"

# å¯é€‰ä¾èµ–
serde_json = { version = "1.0", optional = true }
tokio = { version = "1.48", optional = true }

[features]
# ç‰¹æ€§æ¿€æ´»å¯é€‰ä¾èµ–
json = ["dep:serde_json"]
async = ["dep:tokio"]
full = ["json", "async"]
```

**ä½¿ç”¨**ï¼š

```bash
# æ„å»ºæ—¶å¯ç”¨ç‰¹æ€§
cargo build --features json
cargo build --features "json,async"
cargo build --all-features
cargo build --no-default-features
```

### 6.3 ç‰¹æ€§ä¼ æ’­

**ç¤ºä¾‹**ï¼š

```toml
# ä½ çš„åº“
[features]
default = ["std"]
std = ["serde/std"]  # ä¼ æ’­åˆ° serde

[dependencies]
serde = { version = "1.0", default-features = false }
```

**ä¼ æ’­è§„åˆ™**ï¼š

```text
ä½ çš„ç‰¹æ€§ â†’ ä¾èµ–ç‰¹æ€§
  std    â†’  serde/std
  alloc  â†’  serde/alloc
```

**æŸ¥çœ‹ç‰¹æ€§ä¼ æ’­**ï¼š

```bash
cargo tree -e features
```

---

## 7. å·¥ä½œç©ºé—´ä¾èµ–ç»§æ‰¿

### 7.1 å£°æ˜å…±äº«ä¾èµ–

```toml
# å·¥ä½œç©ºé—´æ ¹ Cargo.toml
[workspace]
members = ["crate-a", "crate-b"]

[workspace.dependencies]
serde = { version = "1.0", features = ["derive"] }
tokio = { version = "1.48", features = ["full"] }
anyhow = "1.0"

[workspace.package]
version = "0.1.0"
edition = "2024"
license = "MIT"
```

### 7.2 æˆå‘˜ç»§æ‰¿

```toml
# crate-a/Cargo.toml
[package]
name = "crate-a"
version.workspace = true
edition.workspace = true
license.workspace = true

[dependencies]
# ç»§æ‰¿å·¥ä½œç©ºé—´ä¾èµ–
serde.workspace = true
tokio.workspace = true

# æ·»åŠ é¢å¤–ç‰¹æ€§
tokio = { workspace = true, features = ["rt"] }
```

### 7.3 ç‰ˆæœ¬è¦†ç›–

```toml
# crate-b/Cargo.toml
[dependencies]
# è¦†ç›–å·¥ä½œç©ºé—´ç‰ˆæœ¬
serde = "1.0.195"  # ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬è€Œéå·¥ä½œç©ºé—´ç‰ˆæœ¬

# æˆ–æ·»åŠ é¢å¤–ä¾èµ–
local-only = "1.0"
```

---

## 8. å¹³å°ç‰¹å®šä¾èµ–

### 8.1 ç›®æ ‡å¹³å°æ¡ä»¶

```toml
[target.'cfg(unix)'.dependencies]
libc = "0.2"

[target.'cfg(windows)'.dependencies]
winapi = { version = "0.3", features = ["winuser"] }

[target.'cfg(target_os = "macos")'.dependencies]
core-foundation = "0.9"

[target.'cfg(target_arch = "wasm32")'.dependencies]
wasm-bindgen = "0.2"
```

### 8.2 å¸¸è§å¹³å°é…ç½®

```toml
# Linux ç‰¹å®š
[target.'cfg(target_os = "linux")'.dependencies]
nix = "0.27"

# Windows ç‰¹å®š
[target.'cfg(target_os = "windows")'.dependencies]
windows-sys = "0.52"

# WASM ç‰¹å®š
[target.'cfg(target_family = "wasm")'.dependencies]
wasm-bindgen = "0.2"
web-sys = "0.3"

# é MSVC å·¥å…·é“¾
[target.'cfg(not(target_env = "msvc"))'.dependencies]
jemallocator = "0.5"

# ç‰¹å®šæ¶æ„
[target.'cfg(target_arch = "x86_64")'.dependencies]
intel-mkl = "0.6"
```

---

## 9. ä¾èµ–ä¼˜åŒ–

### 9.1 ä¾èµ–è£å‰ª

```toml
[dependencies]
# âœ… å¥½ï¼šåªå¯ç”¨éœ€è¦çš„ç‰¹æ€§
tokio = { version = "1.48", features = ["rt", "sync"] }

# âŒ å·®ï¼šå¯ç”¨æ‰€æœ‰ç‰¹æ€§
tokio = { version = "1.48", features = ["full"] }
```

**å½±å“**ï¼š

```bash
# å¯¹æ¯”ç¼–è¯‘æ—¶é—´å’ŒäºŒè¿›åˆ¶å¤§å°
# full: ç¼–è¯‘æ—¶é—´ +50%, äºŒè¿›åˆ¶ +30%
# ç²¾ç®€: ç¼–è¯‘æ—¶é—´ åŸºå‡†, äºŒè¿›åˆ¶ åŸºå‡†
```

### 9.2 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–

```toml
[profile.dev]
# ä¼˜åŒ–ä¾èµ–ç¼–è¯‘
[profile.dev.package."*"]
opt-level = 2

# ä½¿ç”¨é¢„ç¼–è¯‘ä¾èµ–
[dependencies]
heavy-dep = { version = "1.0", features = ["precompiled"] }
```

**æŠ€å·§**ï¼š

```bash
# ä½¿ç”¨ sccache ç¼“å­˜
export RUSTC_WRAPPER=sccache

# ä½¿ç”¨ mold é“¾æ¥å™¨ï¼ˆLinuxï¼‰
export RUSTFLAGS="-C link-arg=-fuse-ld=mold"

# åˆ†æç¼–è¯‘æ—¶é—´
cargo build --timings
```

### 9.3 äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–

```toml
[profile.release]
opt-level = "z"     # ä¼˜åŒ–å¤§å°
lto = true          # é“¾æ¥æ—¶ä¼˜åŒ–
codegen-units = 1   # å•ä»£ç ç”Ÿæˆå•å…ƒ
strip = true        # å»é™¤ç¬¦å·

[dependencies]
# ä½¿ç”¨ç²¾ç®€ç‰ˆä¾èµ–
serde = { version = "1.0", default-features = false, features = ["derive"] }
```

**åˆ†æå·¥å…·**ï¼š

```bash
# åˆ†æäºŒè¿›åˆ¶å¤§å°
cargo bloat --release

# æŒ‰ crate åˆ†æ
cargo bloat --release --crates

# æŸ¥çœ‹ä¾èµ–è´¡çŒ®
cargo tree --edges normal --prefix depth
```

---

## 10. ä¾èµ–å®‰å…¨

### 10.1 æ¼æ´æ£€æµ‹

```bash
# å®‰è£… cargo-audit
cargo install cargo-audit

# æ£€æŸ¥å·²çŸ¥æ¼æ´
cargo audit

# è‡ªåŠ¨ä¿®å¤
cargo audit fix

# JSON è¾“å‡º
cargo audit --json
```

### 10.2 ä¾èµ–å®¡è®¡

```toml
# deny.toml é…ç½®
[advisories]
vulnerability = "deny"
unmaintained = "warn"
unsound = "warn"
notice = "warn"

[licenses]
unlicensed = "deny"
allow = ["MIT", "Apache-2.0", "BSD-3-Clause"]
deny = ["GPL-3.0"]

[bans]
multiple-versions = "warn"
wildcards = "deny"
```

```bash
# å®‰è£… cargo-deny
cargo install cargo-deny

# è¿è¡Œæ£€æŸ¥
cargo deny check
cargo deny check advisories
cargo deny check licenses
cargo deny check bans
```

### 10.3 ä¾›åº”é“¾å®‰å…¨

```bash
# é”å®šå…³é”®ä¾èµ–
[dependencies]
security-critical = "=1.0.0"

# ä½¿ç”¨ cargo-vetï¼ˆMozillaï¼‰
cargo install cargo-vet
cargo vet init
cargo vet certify

# æ£€æŸ¥ä¾èµ–æ¥æº
cargo tree --format "{p} {r}"
```

---

## ğŸ“Š æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èåšæ³•

1. **ç‰ˆæœ¬ç®¡ç†**

   ```toml
   # ä½¿ç”¨è„±å­—ç¬¦ç‰ˆæœ¬ï¼ˆé»˜è®¤ï¼‰
   serde = "1.0"
   ```

2. **ç‰¹æ€§æœ€å°åŒ–**

   ```toml
   # åªå¯ç”¨éœ€è¦çš„ç‰¹æ€§
   tokio = { version = "1.48", features = ["rt", "sync"] }
   ```

3. **å®šæœŸå®¡è®¡**

   ```bash
   cargo audit
   cargo outdated
   cargo tree --duplicates
   ```

4. **å·¥ä½œç©ºé—´ç»§æ‰¿**

   ```toml
   [workspace.dependencies]
   serde = "1.0"
   ```

### âŒ é¿å…åšæ³•

1. **é€šé…ç¬¦ç‰ˆæœ¬**

   ```toml
   # âŒ ä¸å¯é¢„æµ‹
   dep = "*"
   ```

2. **è¿‡åº¦ä¾èµ–**

   ```toml
   # âŒ 100+ ä¸ªä¾èµ–
   [dependencies]
   # ...
   ```

3. **å¿½ç•¥ Cargo.lock**

   ```bash
   # âŒ åº”ç”¨é¡¹ç›®ä¸æäº¤é”æ–‡ä»¶
   ```

4. **å¯ç”¨æ‰€æœ‰ç‰¹æ€§**

   ```toml
   # âŒ å¢åŠ ç¼–è¯‘æ—¶é—´å’ŒäºŒè¿›åˆ¶å¤§å°
   tokio = { version = "1.48", features = ["full"] }
   ```

---

## ğŸ” å¸¸è§é—®é¢˜

**Q1: å¦‚ä½•è§£å†³ä¾èµ–ç‰ˆæœ¬å†²çªï¼Ÿ**

```bash
# 1. æŸ¥çœ‹å†²çª
cargo tree --duplicates

# 2. ä½¿ç”¨ workspace ç»Ÿä¸€ç‰ˆæœ¬
[workspace.dependencies]
common = "1.0"

# 3. æˆ–ä½¿ç”¨ patch
[patch.crates-io]
old-dep = { git = "...", branch = "fix" }
```

**Q2: å¦‚ä½•å‡å°‘ç¼–è¯‘æ—¶é—´ï¼Ÿ**

```toml
# 1. ä¼˜åŒ–ä¾èµ–ç¼–è¯‘
[profile.dev.package."*"]
opt-level = 2

# 2. ç²¾ç®€ç‰¹æ€§
tokio = { version = "1.48", features = ["rt"] }
```

```bash
# 3. ä½¿ç”¨ç¼“å­˜
export RUSTC_WRAPPER=sccache
```

**Q3: åº“é¡¹ç›®æ˜¯å¦æäº¤ Cargo.lockï¼Ÿ**

```text
âŒ åº“ï¼ˆlibraryï¼‰ï¼šä¸æäº¤
âœ… åº”ç”¨ï¼ˆbinaryï¼‰ï¼šæäº¤
âœ… å·¥ä½œç©ºé—´ï¼šæäº¤
```

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [Specifying Dependencies](https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html)
- [Resolver](https://doc.rust-lang.org/cargo/reference/resolver.html)
- [Cargo.lock](https://doc.rust-lang.org/cargo/guide/cargo-toml-vs-cargo-lock.html)

### å·¥å…·

- [cargo-audit](https://github.com/RustSec/rustsec/tree/main/cargo-audit)
- [cargo-deny](https://github.com/EmbarkStudios/cargo-deny)
- [cargo-outdated](https://github.com/kbknapp/cargo-outdated)
- [cargo-edit](https://github.com/killercup/cargo-edit)

### ç›¸å…³æ–‡æ¡£

- [04\_ç‰¹æ€§ç³»ç»Ÿè¯¦è§£.md](./04_ç‰¹æ€§ç³»ç»Ÿè¯¦è§£.md)
- [05\_å·¥ä½œç©ºé—´ç®¡ç†.md](./05_å·¥ä½œç©ºé—´ç®¡ç†.md)
- [08\_æœ€ä½³å®è·µæŒ‡å—.md](./08_æœ€ä½³å®è·µæŒ‡å—.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-26
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.93.0+

_ä¾èµ–ç®¡ç†æ˜¯é¡¹ç›®æˆåŠŸçš„åŸºçŸ³ã€‚_ ğŸ¦€ğŸ“¦
