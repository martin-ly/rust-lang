# Cargo 最佳实践指南

**版本**: Rust 1.90  
**最后更新**: 2025-10-19

---

## 📋 目录

- [Cargo 最佳实践指南](#cargo-最佳实践指南)
  - [📋 目录](#-目录)
  - [🎯 最佳实践原则](#-最佳实践原则)
  - [1. 项目组织最佳实践](#1-项目组织最佳实践)
    - [目录结构](#目录结构)
    - [命名规范](#命名规范)
    - [模块组织](#模块组织)
  - [2. 依赖管理最佳实践](#2-依赖管理最佳实践)
    - [版本选择](#版本选择)
    - [依赖最小化](#依赖最小化)
    - [定期审计](#定期审计)
  - [3. 特性设计最佳实践](#3-特性设计最佳实践)
    - [特性命名](#特性命名)
    - [特性组合](#特性组合)
    - [默认特性](#默认特性)
  - [4. 构建优化最佳实践](#4-构建优化最佳实践)
    - [开发构建](#开发构建)
    - [发布构建](#发布构建)
    - [缓存利用](#缓存利用)
  - [5. 测试最佳实践](#5-测试最佳实践)
    - [测试组织](#测试组织)
    - [测试覆盖](#测试覆盖)
    - [性能测试](#性能测试)
  - [6. 文档最佳实践](#6-文档最佳实践)
    - [代码文档](#代码文档)
    - [README 编写](#readme-编写)
    - [示例代码](#示例代码)
  - [7. 发布最佳实践](#7-发布最佳实践)
    - [版本管理](#版本管理)
    - [CHANGELOG](#changelog)
    - [发布检查](#发布检查)
  - [8. 安全最佳实践](#8-安全最佳实践)
    - [依赖安全](#依赖安全)
    - [代码安全](#代码安全)
    - [供应链安全](#供应链安全)
  - [9. 性能最佳实践](#9-性能最佳实践)
    - [编译时优化](#编译时优化)
    - [运行时优化](#运行时优化)
    - [分析工具](#分析工具)
  - [10. CI/CD 最佳实践](#10-cicd-最佳实践)
    - [GitHub Actions](#github-actions)
    - [测试矩阵](#测试矩阵)
    - [自动发布](#自动发布)
  - [📚 实践清单](#-实践清单)
    - [项目启动清单](#项目启动清单)
    - [开发过程清单](#开发过程清单)
    - [发布前清单](#发布前清单)
  - [🔍 反模式警示](#-反模式警示)
    - [❌ 不要这样做](#-不要这样做)
  - [📖 延伸阅读](#-延伸阅读)
    - [官方资源](#官方资源)
    - [社区资源](#社区资源)

---

## 🎯 最佳实践原则

**核心原则**:

1. **简单优先** (Simplicity First): 从最简单的解决方案开始
2. **遵循约定** (Follow Conventions): 遵循 Rust 社区约定
3. **显式优于隐式** (Explicit Over Implicit): 明确表达意图
4. **安全第一** (Safety First): 优先考虑安全性
5. **性能平衡** (Performance Balance): 在可维护性和性能间平衡
6. **持续改进** (Continuous Improvement): 定期审查和优化

---

## 1. 项目组织最佳实践

### 目录结构

**✅ 推荐结构**:

```text
my-project/
├── Cargo.toml              # 项目清单
├── Cargo.lock              # 依赖锁定（提交到 Git）
├── README.md               # 项目说明
├── LICENSE                 # 许可证
├── CHANGELOG.md            # 变更日志
├── .gitignore              # Git 忽略文件
├── src/                    # 源代码
│   ├── lib.rs              # 库根（如果是库）
│   ├── main.rs             # 二进制根（如果是应用）
│   ├── bin/                # 额外二进制
│   ├── config/             # 配置模块
│   ├── models/             # 数据模型
│   └── utils/              # 工具函数
├── tests/                  # 集成测试
│   ├── common/             # 测试公共代码
│   │   └── mod.rs
│   └── integration_test.rs
├── benches/                # 性能测试
│   └── benchmarks.rs
├── examples/               # 示例代码
│   └── basic.rs
└── docs/                   # 额外文档
    └── architecture.md
```

### 命名规范

```toml
[package]
# ✅ 好：使用 kebab-case
name = "my-awesome-lib"

# ❌ 差：使用其他命名风格
name = "MyAwesomeLib"       # PascalCase
name = "my_awesome_lib"     # snake_case
```

```rust
// ✅ 好：模块使用 snake_case
mod user_service;
mod data_store;

// ✅ 好：类型使用 PascalCase
struct UserData;
enum RequestType;

// ✅ 好：函数使用 snake_case
fn calculate_total() {}
fn get_user_by_id() {}

// ✅ 好：常量使用 SCREAMING_SNAKE_CASE
const MAX_CONNECTIONS: usize = 100;
```

### 模块组织

```rust
// src/lib.rs

//! # My Awesome Library
//!
//! 库的顶层文档

// 公开 API
pub mod api;
pub mod models;

// 内部模块
mod internal;
mod utils;

// 重导出常用类型
pub use api::{Client, Config};
pub use models::{User, Post};
```

---

## 2. 依赖管理最佳实践

### 版本选择

```toml
[dependencies]
# ✅ 好：使用脱字符版本（默认）
serde = "1.0"               # ^1.0.0

# ✅ 好：关键依赖使用波浪号版本
critical = "~1.0.0"         # 1.0.x

# ⚠️ 谨慎：只在必要时使用精确版本
exact = "=1.0.0"

# ❌ 避免：使用通配符
wildcard = "*"              # 不可预测
```

### 依赖最小化

```toml
[dependencies]
# ✅ 好：只启用需要的特性
tokio = { version = "1.48", features = ["rt", "sync"] }

# ❌ 差：启用所有特性
tokio = { version = "1.48", features = ["full"] }

# ✅ 好：禁用不需要的默认特性
serde = { version = "1.0", default-features = false, features = ["derive"] }
```

### 定期审计

```bash
# ✅ 每周运行一次
cargo audit

# ✅ 检查过时依赖
cargo outdated

# ✅ 更新依赖
cargo update

# ✅ 查看依赖树
cargo tree

# ✅ 检查重复依赖
cargo tree --duplicates
```

---

## 3. 特性设计最佳实践

### 特性命名

```toml
[features]
# ✅ 好：清晰的特性名称
default = ["std"]
std = []                    # 标准库支持
alloc = []                  # 堆分配支持
async = ["tokio"]           # 异步支持
json = ["serde_json"]       # JSON 序列化

# ❌ 差：模糊的特性名称
feature1 = []
stuff = []
```

### 特性组合

```toml
[features]
# ✅ 好：提供合理的特性组合
default = ["std"]
std = ["alloc"]             # std 依赖 alloc
full = ["std", "async", "json"]  # 完整特性集
minimal = []                # 最小特性集

# ✅ 好：可选依赖
async = ["dep:tokio"]
json = ["dep:serde_json"]
```

### 默认特性

```toml
[features]
# ✅ 好：默认特性应该是最常用的
default = ["std"]

# ❌ 差：默认特性包含太多内容
default = ["full"]          # 可能包含不需要的功能
```

---

## 4. 构建优化最佳实践

### 开发构建

```toml
[profile.dev]
# ✅ 推荐：适度优化，加快构建
opt-level = 1               # 轻度优化
incremental = true          # 增量编译
debug = true                # 调试信息

# ✅ 优化依赖的构建
[profile.dev.package."*"]
opt-level = 2               # 依赖使用更高优化
```

### 发布构建

```toml
[profile.release]
# ✅ 推荐：最大化性能
opt-level = 3               # 最大优化
lto = "fat"                 # 全局链接时优化
codegen-units = 1           # 单代码生成单元
strip = true                # 去除符号
panic = "abort"             # panic 时中止
```

### 缓存利用

```bash
# ✅ 使用 sccache 加速
export RUSTC_WRAPPER=sccache

# ✅ 使用 mold 链接器（Linux）
export RUSTFLAGS="-C link-arg=-fuse-ld=mold"

# ✅ CI 中缓存 target 目录
# .github/workflows/ci.yml
- uses: actions/cache@v3
  with:
    path: |
      ~/.cargo/bin/
      ~/.cargo/registry/index/
      ~/.cargo/registry/cache/
      ~/.cargo/git/db/
      target/
```

---

## 5. 测试最佳实践

### 测试组织

```rust
// src/lib.rs

pub fn add(a: i32, b: i32) -> i32 {
    a + b
}

// ✅ 好：单元测试与代码在一起
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_add() {
        assert_eq!(add(1, 2), 3);
    }
    
    #[test]
    #[should_panic]
    fn test_overflow() {
        add(i32::MAX, 1);
    }
}
```

```rust
// tests/integration_test.rs

// ✅ 好：集成测试在独立文件
use my_lib::add;

#[test]
fn test_public_api() {
    assert_eq!(add(2, 3), 5);
}
```

### 测试覆盖

```bash
# ✅ 使用 tarpaulin 检查覆盖率
cargo install cargo-tarpaulin
cargo tarpaulin --out Html

# ✅ 目标：至少 80% 覆盖率
```

### 性能测试

```rust
// benches/benchmarks.rs

use criterion::{black_box, criterion_group, criterion_main, Criterion};
use my_lib::add;

// ✅ 好：使用 criterion 进行基准测试
fn bench_add(c: &mut Criterion) {
    c.bench_function("add", |b| {
        b.iter(|| add(black_box(1), black_box(2)))
    });
}

criterion_group!(benches, bench_add);
criterion_main!(benches);
```

---

## 6. 文档最佳实践

### 代码文档

```rust
//! # My Library
//!
//! 这是库的顶层文档。
//!
//! ## 快速开始
//!
//! ```
//! use my_lib::add;
//!
//! let result = add(1, 2);
//! assert_eq!(result, 3);
//! ```

/// ✅ 好：完整的函数文档
///
/// 添加两个数字。
///
/// # 参数
///
/// * `a` - 第一个数字
/// * `b` - 第二个数字
///
/// # 返回值
///
/// 两数之和
///
/// # 示例
///
/// ```
/// use my_lib::add;
///
/// let result = add(2, 3);
/// assert_eq!(result, 5);
/// ```
///
/// # Panics
///
/// 当结果溢出时 panic
pub fn add(a: i32, b: i32) -> i32 {
    a.checked_add(b).expect("overflow")
}
```

### README 编写

````markdown
# My Project

[![Crates.io](https://img.shields.io/crates/v/my-project.svg)](https://crates.io/crates/my-project)
[![Documentation](https://docs.rs/my-project/badge.svg)](https://docs.rs/my-project)
[![License](https://img.shields.io/crates/l/my-project.svg)](LICENSE)

一句话描述项目。

## 特性

- 特性 1
- 特性 2
- 特性 3

## 快速开始

```toml
[dependencies]
my-project = "0.1"
```

```rust
use my_project::*;

fn main() {
    // 示例代码
}
```

## 文档

查看 [完整文档](https://docs.rs/my-project)

## 许可证

MIT
````

### 示例代码

```rust
// examples/basic.rs

//! ✅ 好：示例应该完整可运行
//!
//! 运行此示例：
//! ```bash
//! cargo run --example basic
//! ```

use my_lib::add;

fn main() {
    // 简单示例
    let result = add(1, 2);
    println!("1 + 2 = {}", result);
    
    // 复杂示例
    let numbers = vec![1, 2, 3, 4, 5];
    let sum = numbers.iter()
        .fold(0, |acc, &x| add(acc, x));
    println!("Sum: {}", sum);
}
```

---

## 7. 发布最佳实践

### 版本管理

```toml
[package]
# ✅ 遵循语义化版本
version = "1.2.3"
#         │ │ │
#         │ │ └─ PATCH: 向后兼容的修复
#         │ └─── MINOR: 向后兼容的新功能
#         └───── MAJOR: 不兼容的变更
```

### CHANGELOG

````markdown
# Changelog

## [Unreleased]

### Added
- 新功能

### Changed
- 变更

### Fixed
- 修复

## [1.0.0] - 2025-01-15

### Added
- 初始发布
````

### 发布检查

```bash
# ✅ 发布前检查清单

# 1. 运行所有测试
cargo test --all-features

# 2. 检查代码格式
cargo fmt -- --check

# 3. 运行 Clippy
cargo clippy -- -D warnings

# 4. 检查文档
cargo doc --no-deps --open

# 5. 试运行发布
cargo publish --dry-run

# 6. 检查包内容
cargo package --list

# 7. 实际发布
cargo publish
```

---

## 8. 安全最佳实践

### 依赖安全

```bash
# ✅ 定期审计
cargo audit

# ✅ 使用 deny 检查策略
cargo install cargo-deny
cargo deny check
```

```toml
# deny.toml

[advisories]
vulnerability = "deny"
unmaintained = "warn"
unsound = "warn"

[licenses]
unlicensed = "deny"
allow = [
    "MIT",
    "Apache-2.0",
]

[bans]
multiple-versions = "warn"
```

### 代码安全

```rust
// ✅ 好：避免 unsafe
pub fn safe_function(data: &[u8]) -> Vec<u8> {
    data.to_vec()
}

// ⚠️ 必要时使用 unsafe，并添加安全说明
/// # Safety
///
/// 调用者必须确保 ptr 指向有效的内存
pub unsafe fn unsafe_function(ptr: *const u8, len: usize) -> Vec<u8> {
    std::slice::from_raw_parts(ptr, len).to_vec()
}
```

### 供应链安全

```toml
# ✅ 锁定关键依赖版本
[dependencies]
security-critical = "=1.0.0"

# ✅ 使用 cargo-vet
# https://github.com/mozilla/cargo-vet
```

---

## 9. 性能最佳实践

### 编译时优化

```toml
[profile.release]
opt-level = 3
lto = "fat"
codegen-units = 1

# ✅ 针对 CPU 优化
[profile.release.package."*"]
opt-level = 3

# ✅ 使用编译时特性检查
```

```rust
// ✅ 使用 const 计算
const fn calculate_size() -> usize {
    100 * std::mem::size_of::<u64>()
}
```

### 运行时优化

```rust
// ✅ 好：预分配容量
let mut vec = Vec::with_capacity(1000);

// ❌ 差：动态增长
let mut vec = Vec::new();

// ✅ 好：使用迭代器
let sum: i32 = numbers.iter().sum();

// ❌ 差：手动循环
let mut sum = 0;
for &n in &numbers {
    sum += n;
}
```

### 分析工具

```bash
# ✅ 使用 flamegraph
cargo install flamegraph
cargo flamegraph

# ✅ 使用 criterion 基准测试
cargo bench

# ✅ 使用 cargo-bloat 检查二进制大小
cargo install cargo-bloat
cargo bloat --release
```

---

## 10. CI/CD 最佳实践

### GitHub Actions

```yaml
# .github/workflows/ci.yml

name: CI

on: [push, pull_request]

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, beta, nightly]
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
      
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build
        run: cargo build --verbose
      
      - name: Test
        run: cargo test --verbose
      
      - name: Clippy
        run: cargo clippy -- -D warnings
      
      - name: Format
        run: cargo fmt -- --check
```

### 测试矩阵

```yaml
strategy:
  matrix:
    os: [ubuntu-latest, windows-latest, macos-latest]
    rust: [stable, beta]
    features: [default, full, minimal]
```

### 自动发布

```yaml
# .github/workflows/release.yml

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - run: cargo publish --token ${{ secrets.CARGO_TOKEN }}
```

---

## 📚 实践清单

### 项目启动清单

- [ ] 使用 `cargo new` 创建项目
- [ ] 添加 LICENSE 文件
- [ ] 编写 README.md
- [ ] 设置 .gitignore
- [ ] 配置 Cargo.toml 元数据
- [ ] 设置 CI/CD

### 开发过程清单

- [ ] 编写单元测试
- [ ] 编写集成测试
- [ ] 添加文档注释
- [ ] 运行 `cargo clippy`
- [ ] 运行 `cargo fmt`
- [ ] 检查测试覆盖率

### 发布前清单

- [ ] 更新版本号
- [ ] 更新 CHANGELOG.md
- [ ] 运行所有测试
- [ ] 检查文档
- [ ] 运行 `cargo audit`
- [ ] `cargo publish --dry-run`
- [ ] 创建 Git tag
- [ ] 发布到 crates.io

---

## 🔍 反模式警示

### ❌ 不要这样做

1. **过度使用 `unsafe`**

    ```rust
    // ❌ 不必要的 unsafe
    unsafe {
        let x = 42;
    }
    ```

2. **忽略错误**

    ```rust
    // ❌ 忽略 Result
    file.read_to_string(&mut contents).unwrap();

    // ✅ 正确处理错误
    file.read_to_string(&mut contents)?;
    ```

3. **过度依赖**

    ```toml
    # ❌ 依赖太多
    [dependencies]
    # 50+ 个依赖

    # ✅ 最小化依赖
    [dependencies]
    # 只添加必要的依赖
    ```

4. **不锁定版本**

    ```bash
    # ❌ 不提交 Cargo.lock（应用项目）
    echo "Cargo.lock" >> .gitignore

    # ✅ 提交 Cargo.lock（应用项目）
    git add Cargo.lock
    ```

---

## 📖 延伸阅读

### 官方资源

- [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/)
- [The Cargo Book](https://doc.rust-lang.org/cargo/)
- [Rust Performance Book](https://nnethercote.github.io/perf-book/)

### 社区资源

- [blessed.rs](https://blessed.rs/) - 推荐的 crate
- [lib.rs](https://lib.rs/) - Crate 搜索
- [This Week in Rust](https://this-week-in-rust.org/)

---

**文档版本**: 1.0  
**最后更新**: 2025-10-19  
**适用版本**: Rust 1.90+

*最佳实践是经验的结晶。* 🦀✨
