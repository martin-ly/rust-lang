# Cargo æ„å»ºç³»ç»Ÿè¯¦è§£

## ğŸ“‹ ç›®å½•

- [Cargo æ„å»ºç³»ç»Ÿè¯¦è§£](#cargo-æ„å»ºç³»ç»Ÿè¯¦è§£)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ„å»ºç³»ç»Ÿæ¦‚è§ˆ](#-æ„å»ºç³»ç»Ÿæ¦‚è§ˆ)
  - [1. æ„å»ºåŸºç¡€](#1-æ„å»ºåŸºç¡€)
    - [1.1 æ„å»ºæµç¨‹](#11-æ„å»ºæµç¨‹)
    - [1.2 æ„å»ºå‘½ä»¤](#12-æ„å»ºå‘½ä»¤)
    - [1.3 æ„å»ºäº§ç‰©](#13-æ„å»ºäº§ç‰©)
  - [2. Profile é…ç½®](#2-profile-é…ç½®)
    - [2.1 å†…ç½® Profile](#21-å†…ç½®-profile)
    - [2.2 è‡ªå®šä¹‰ Profile](#22-è‡ªå®šä¹‰-profile)
    - [2.3 Profile ç»§æ‰¿](#23-profile-ç»§æ‰¿)
  - [3. ç¼–è¯‘ä¼˜åŒ–](#3-ç¼–è¯‘ä¼˜åŒ–)
    - [3.1 ä¼˜åŒ–çº§åˆ«](#31-ä¼˜åŒ–çº§åˆ«)
    - [3.2 LTO (é“¾æ¥æ—¶ä¼˜åŒ–)](#32-lto-é“¾æ¥æ—¶ä¼˜åŒ–)
    - [3.3 ä»£ç ç”Ÿæˆå•å…ƒ](#33-ä»£ç ç”Ÿæˆå•å…ƒ)
  - [4. è°ƒè¯•ä¿¡æ¯](#4-è°ƒè¯•ä¿¡æ¯)
    - [4.1 è°ƒè¯•çº§åˆ«](#41-è°ƒè¯•çº§åˆ«)
    - [4.2 ç¬¦å·å‰¥ç¦»](#42-ç¬¦å·å‰¥ç¦»)
    - [4.3 æºç æ˜ å°„](#43-æºç æ˜ å°„)
  - [5. å¢é‡ç¼–è¯‘](#5-å¢é‡ç¼–è¯‘)
    - [5.1 å¯ç”¨å¢é‡ç¼–è¯‘](#51-å¯ç”¨å¢é‡ç¼–è¯‘)
    - [5.2 ç¼“å­˜ç®¡ç†](#52-ç¼“å­˜ç®¡ç†)
    - [5.3 æ€§èƒ½å½±å“](#53-æ€§èƒ½å½±å“)
  - [6. äº¤å‰ç¼–è¯‘](#6-äº¤å‰ç¼–è¯‘)
    - [6.1 ç›®æ ‡å¹³å°](#61-ç›®æ ‡å¹³å°)
    - [6.2 é…ç½®äº¤å‰ç¼–è¯‘](#62-é…ç½®äº¤å‰ç¼–è¯‘)
    - [6.3 å¸¸è§å¹³å°](#63-å¸¸è§å¹³å°)
  - [7. æ„å»ºè„šæœ¬](#7-æ„å»ºè„šæœ¬)
    - [7.1 build.rs åŸºç¡€](#71-buildrs-åŸºç¡€)
    - [7.2 å¸¸è§ç”¨ä¾‹](#72-å¸¸è§ç”¨ä¾‹)
    - [7.3 é«˜çº§æŠ€å·§](#73-é«˜çº§æŠ€å·§)
  - [8. å¹¶è¡Œæ„å»º](#8-å¹¶è¡Œæ„å»º)
    - [8.1 å¹¶è¡Œçº§åˆ«](#81-å¹¶è¡Œçº§åˆ«)
    - [8.2 èµ„æºæ§åˆ¶](#82-èµ„æºæ§åˆ¶)
    - [8.3 æ„å»ºç¼“å­˜](#83-æ„å»ºç¼“å­˜)
  - [9. æ„å»ºæ€§èƒ½ä¼˜åŒ–](#9-æ„å»ºæ€§èƒ½ä¼˜åŒ–)
    - [9.1 ç¼–è¯‘æ—¶é—´åˆ†æ](#91-ç¼–è¯‘æ—¶é—´åˆ†æ)
    - [9.2 ä¾èµ–ä¼˜åŒ–](#92-ä¾èµ–ä¼˜åŒ–)
    - [9.3 å·¥å…·é“¾ä¼˜åŒ–](#93-å·¥å…·é“¾ä¼˜åŒ–)
  - [10. äºŒè¿›åˆ¶ä¼˜åŒ–](#10-äºŒè¿›åˆ¶ä¼˜åŒ–)
    - [10.1 å¤§å°ä¼˜åŒ–](#101-å¤§å°ä¼˜åŒ–)
    - [10.2 æ€§èƒ½ä¼˜åŒ–](#102-æ€§èƒ½ä¼˜åŒ–)
    - [10.3 åˆ†æå·¥å…·](#103-åˆ†æå·¥å…·)
  - [ğŸ“Š Profile å¯¹æ¯”è¡¨](#-profile-å¯¹æ¯”è¡¨)
  - [ğŸ” å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)
  - [ğŸ“– å»¶ä¼¸é˜…è¯»](#-å»¶ä¼¸é˜…è¯»)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [å·¥å…·](#å·¥å…·)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ğŸ¯ æ„å»ºç³»ç»Ÿæ¦‚è§ˆ

Cargo çš„æ„å»ºç³»ç»Ÿæä¾›å¼ºå¤§çš„é…ç½®å’Œä¼˜åŒ–èƒ½åŠ›ï¼š

```mermaid
graph TD
    A[æ„å»ºç³»ç»Ÿ] --> B[Profile é…ç½®]
    A --> C[ç¼–è¯‘ä¼˜åŒ–]
    A --> D[äº¤å‰ç¼–è¯‘]
    A --> E[æ„å»ºè„šæœ¬]

    B --> B1[dev/release]
    C --> C1[LTO/ä¼˜åŒ–çº§åˆ«]
    D --> D1[å¤šå¹³å°æ”¯æŒ]
    E --> E1[è‡ªå®šä¹‰æ„å»º]
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

- **Profile**: ç¼–è¯‘é…ç½®é¢„è®¾
- **ä¼˜åŒ–**: LTOã€ä¼˜åŒ–çº§åˆ«ã€ä»£ç ç”Ÿæˆ
- **äº¤å‰ç¼–è¯‘**: å¤šå¹³å°æ”¯æŒ
- **æ„å»ºè„šæœ¬**: è‡ªå®šä¹‰æ„å»ºé€»è¾‘

---

## 1. æ„å»ºåŸºç¡€

### 1.1 æ„å»ºæµç¨‹

**æ ‡å‡†æµç¨‹**ï¼š

```text
1. è§£æ Cargo.toml
2. ä¸‹è½½ä¾èµ–
3. ç¼–è¯‘ä¾èµ–
4. ç¼–è¯‘é¡¹ç›®ä»£ç 
5. é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶/åº“
```

```mermaid
graph LR
    A[æºä»£ç ] --> B[rustc ç¼–è¯‘]
    B --> C[LLVM ä¼˜åŒ–]
    C --> D[ä»£ç ç”Ÿæˆ]
    D --> E[é“¾æ¥å™¨]
    E --> F[å¯æ‰§è¡Œæ–‡ä»¶]
```

### 1.2 æ„å»ºå‘½ä»¤

```bash
# å¼€å‘æ„å»º
cargo build

# å‘å¸ƒæ„å»º
cargo build --release

# æ£€æŸ¥ï¼ˆä¸ç”Ÿæˆä»£ç ï¼‰
cargo check

# ä»…ç¼–è¯‘ï¼Œä¸é“¾æ¥
cargo rustc -- --emit=llvm-ir

# æŒ‡å®šç›®æ ‡
cargo build --target x86_64-unknown-linux-gnu

# è¯¦ç»†è¾“å‡º
cargo build -v
cargo build -vv  # æ›´è¯¦ç»†

# æ„å»ºæ—¶é—´åˆ†æ
cargo build --timings
```

### 1.3 æ„å»ºäº§ç‰©

**ç›®å½•ç»“æ„**ï¼š

```text
target/
â”œâ”€â”€ debug/              # dev profile
â”‚   â”œâ”€â”€ deps/          # ä¾èµ–
â”‚   â”œâ”€â”€ examples/      # ç¤ºä¾‹
â”‚   â”œâ”€â”€ build/         # æ„å»ºè„šæœ¬è¾“å‡º
â”‚   â””â”€â”€ my-app         # å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ release/           # release profile
â”‚   â””â”€â”€ my-app
â”œâ”€â”€ x86_64-pc-windows-gnu/  # äº¤å‰ç¼–è¯‘ç›®æ ‡
â””â”€â”€ doc/               # æ–‡æ¡£
```

---

## 2. Profile é…ç½®

### 2.1 å†…ç½® Profile

**dev (å¼€å‘)**ï¼š

```toml
[profile.dev]
opt-level = 0          # ä¸ä¼˜åŒ–
debug = true           # å®Œæ•´è°ƒè¯•ä¿¡æ¯
split-debuginfo = "unpacked"  # è°ƒè¯•ä¿¡æ¯åˆ†ç¦»
overflow-checks = true # æº¢å‡ºæ£€æŸ¥
lto = false            # æ—  LTO
panic = "unwind"       # å¯å±•å¼€çš„ panic
incremental = true     # å¢é‡ç¼–è¯‘
codegen-units = 256    # å¹¶è¡Œä»£ç ç”Ÿæˆ
```

**release (å‘å¸ƒ)**ï¼š

```toml
[profile.release]
opt-level = 3          # æœ€å¤§ä¼˜åŒ–
debug = false          # æ— è°ƒè¯•ä¿¡æ¯
split-debuginfo = "packed"
overflow-checks = false
lto = false            # é»˜è®¤ä¸å¯ç”¨
panic = "unwind"
incremental = false
codegen-units = 16
strip = false          # ä¸å‰¥ç¦»ç¬¦å·
```

**test (æµ‹è¯•)**ï¼š

```toml
[profile.test]
# ç»§æ‰¿ dev profile
opt-level = 0
```

**bench (åŸºå‡†æµ‹è¯•)**ï¼š

```toml
[profile.bench]
# ç»§æ‰¿ release profile
opt-level = 3
```

### 2.2 è‡ªå®šä¹‰ Profile

**åˆ›å»ºè‡ªå®šä¹‰ Profile**ï¼š

```toml
# Cargo.toml
[profile.production]
inherits = "release"
lto = "fat"
codegen-units = 1
opt-level = 3
strip = true
panic = "abort"
```

**ä½¿ç”¨è‡ªå®šä¹‰ Profile**ï¼š

```bash
cargo build --profile production
```

### 2.3 Profile ç»§æ‰¿

```toml
[profile.dev]
opt-level = 0

# ç»§æ‰¿ devï¼Œä½†è¦†ç›–éƒ¨åˆ†è®¾ç½®
[profile.dev-opt]
inherits = "dev"
opt-level = 1

[profile.release-lto]
inherits = "release"
lto = "fat"
codegen-units = 1
```

---

## 3. ç¼–è¯‘ä¼˜åŒ–

### 3.1 ä¼˜åŒ–çº§åˆ«

```toml
[profile.release]
# ä¼˜åŒ–çº§åˆ«
opt-level = 0  # æ— ä¼˜åŒ–ï¼ˆå¼€å‘ï¼‰
opt-level = 1  # åŸºæœ¬ä¼˜åŒ–
opt-level = 2  # ä¸€äº›ä¼˜åŒ–
opt-level = 3  # æœ€å¤§ä¼˜åŒ–ï¼ˆé»˜è®¤ releaseï¼‰
opt-level = "s"  # ä¼˜åŒ–å¤§å°
opt-level = "z"  # æ¿€è¿›ä¼˜åŒ–å¤§å°
```

**å¯¹æ¯”**ï¼š

| çº§åˆ« | ç¼–è¯‘æ—¶é—´ | è¿è¡Œé€Ÿåº¦ | äºŒè¿›åˆ¶å¤§å° | ä½¿ç”¨åœºæ™¯ |
| ---- | -------- | -------- | ---------- | -------- |
| 0    | æœ€å¿«     | æœ€æ…¢     | æœ€å¤§       | å¼€å‘è°ƒè¯• |
| 1    | å¿«       | è¾ƒæ…¢     | å¤§         | å¿«é€Ÿæµ‹è¯• |
| 2    | ä¸­ç­‰     | è¾ƒå¿«     | ä¸­ç­‰       | å¹³è¡¡     |
| 3    | æ…¢       | æœ€å¿«     | å¤§         | æ€§èƒ½å…³é”® |
| "s"  | æ…¢       | å¿«       | å°         | åµŒå…¥å¼   |
| "z"  | æœ€æ…¢     | è¾ƒå¿«     | æœ€å°       | ç©ºé—´å—é™ |

### 3.2 LTO (é“¾æ¥æ—¶ä¼˜åŒ–)

**ç±»å‹**ï¼š

```toml
[profile.release]
# ç¦ç”¨ LTO
lto = false

# å¯ç”¨"thin" LTOï¼ˆæ¨èï¼‰
lto = "thin"

# å¯ç”¨"fat" LTOï¼ˆå…¨å±€ä¼˜åŒ–ï¼‰
lto = "fat"
# æˆ–
lto = true  # ç­‰åŒäº "fat"
```

**å¯¹æ¯”**ï¼š

| LTO ç±»å‹ | ç¼–è¯‘æ—¶é—´ | ä¼˜åŒ–æ•ˆæœ | å†…å­˜å ç”¨ | æ¨èåœºæ™¯ |
| -------- | -------- | -------- | -------- | -------- |
| false    | å¿«       | æ—        | ä½       | å¼€å‘     |
| thin     | ä¸­ç­‰     | å¥½       | ä¸­ç­‰     | ç”Ÿäº§ç¯å¢ƒ |
| fat      | æ…¢       | æœ€å¥½     | é«˜       | æœ€ç»ˆå‘å¸ƒ |

**ç¤ºä¾‹**ï¼š

```toml
[profile.release]
lto = "fat"
codegen-units = 1  # é…åˆ LTO ä½¿ç”¨

# æ•ˆæœï¼š
# - äºŒè¿›åˆ¶å¤§å°: -10% ~ -20%
# - è¿è¡Œé€Ÿåº¦: +5% ~ +15%
# - ç¼–è¯‘æ—¶é—´: +50% ~ +200%
```

### 3.3 ä»£ç ç”Ÿæˆå•å…ƒ

```toml
[profile.dev]
codegen-units = 256  # æœ€å¤§å¹¶è¡Œï¼ˆå¿«é€Ÿç¼–è¯‘ï¼‰

[profile.release]
codegen-units = 16   # é»˜è®¤å€¼ï¼ˆå¹³è¡¡ï¼‰

[profile.release-opt]
codegen-units = 1    # æœ€ä½³ä¼˜åŒ–ï¼ˆæ…¢ç¼–è¯‘ï¼‰
```

**æƒè¡¡**ï¼š

```text
codegen-units â†‘ â†’ ç¼–è¯‘é€Ÿåº¦ â†‘, è¿è¡Œé€Ÿåº¦ â†“
codegen-units â†“ â†’ ç¼–è¯‘é€Ÿåº¦ â†“, è¿è¡Œé€Ÿåº¦ â†‘
```

---

## 4. è°ƒè¯•ä¿¡æ¯

### 4.1 è°ƒè¯•çº§åˆ«

```toml
[profile.dev]
debug = true   # æˆ– debug = 2ï¼ˆå®Œæ•´ä¿¡æ¯ï¼‰

[profile.release]
debug = false  # æˆ– debug = 0ï¼ˆæ— ä¿¡æ¯ï¼‰

# éƒ¨åˆ†è°ƒè¯•ä¿¡æ¯
[profile.release-debug]
debug = 1      # ä»…è¡Œå·ä¿¡æ¯
```

**çº§åˆ«è¯´æ˜**ï¼š

| çº§åˆ«    | è°ƒè¯•ä¿¡æ¯ | äºŒè¿›åˆ¶å¤§å° | ä½¿ç”¨åœºæ™¯ |
| ------- | -------- | ---------- | -------- |
| 0/false | æ—        | æœ€å°       | æœ€ç»ˆå‘å¸ƒ |
| 1       | è¡Œå·     | å°         | ç”Ÿäº§è°ƒè¯• |
| 2/true  | å®Œæ•´     | å¤§         | å¼€å‘è°ƒè¯• |

### 4.2 ç¬¦å·å‰¥ç¦»

**Rust 1.92.0 æ–°ç‰¹æ€§**ï¼ˆè‡ª Rust 1.90 å¼•å…¥ï¼‰ï¼š

```toml
[profile.release]
strip = false          # ä¿ç•™ç¬¦å·ï¼ˆé»˜è®¤ï¼‰
strip = "debuginfo"    # å‰¥ç¦»è°ƒè¯•ä¿¡æ¯
strip = "symbols"      # å‰¥ç¦»æ‰€æœ‰ç¬¦å·
strip = true           # ç­‰åŒäº "symbols"
```

**æ•ˆæœ**ï¼š

```bash
# ä¸å‰¥ç¦»
cargo build --release
ls -lh target/release/my-app  # 10 MB

# å‰¥ç¦»ç¬¦å·
[profile.release]
strip = true

cargo build --release
ls -lh target/release/my-app  # 2 MB (-80%)
```

### 4.3 æºç æ˜ å°„

```toml
[profile.release]
# è°ƒè¯•ä¿¡æ¯åˆ†ç¦»ï¼ˆå‡å°ä¸»äºŒè¿›åˆ¶å¤§å°ï¼‰
split-debuginfo = "packed"    # macOS/Windows
split-debuginfo = "unpacked"  # Linuxï¼ˆé»˜è®¤ï¼‰
split-debuginfo = "off"       # ä¸åˆ†ç¦»
```

---

## 5. å¢é‡ç¼–è¯‘

### 5.1 å¯ç”¨å¢é‡ç¼–è¯‘

```toml
[profile.dev]
incremental = true   # é»˜è®¤å¯ç”¨

[profile.release]
incremental = false  # é»˜è®¤ç¦ç”¨ï¼ˆæœ€ç»ˆå‘å¸ƒï¼‰

# å¼€å‘æ—¶å¯ç”¨ release å¢é‡ç¼–è¯‘
[profile.release-dev]
inherits = "release"
incremental = true
```

**ç¯å¢ƒå˜é‡**ï¼š

```bash
# å¼ºåˆ¶å¯ç”¨
export CARGO_INCREMENTAL=1

# å¼ºåˆ¶ç¦ç”¨
export CARGO_INCREMENTAL=0
```

### 5.2 ç¼“å­˜ç®¡ç†

```bash
# æŸ¥çœ‹ç¼“å­˜å¤§å°
du -sh target/debug/incremental

# æ¸…ç†ç¼“å­˜
cargo clean -p my-crate
cargo clean --release

# å®Œå…¨æ¸…ç†
cargo clean

# æ¸…ç†å¢é‡ç¼“å­˜
rm -rf target/debug/incremental
```

### 5.3 æ€§èƒ½å½±å“

**é¦–æ¬¡ç¼–è¯‘**ï¼š

```text
å¢é‡: OFF  100%  (åŸºå‡†)
å¢é‡: ON   105%  (+5% å¼€é”€)
```

**é‡æ–°ç¼–è¯‘ï¼ˆå°æ”¹åŠ¨ï¼‰**ï¼š

```text
å¢é‡: OFF  100%  (å®Œæ•´é‡ç¼–è¯‘)
å¢é‡: ON   20%   (-80% æ—¶é—´)
```

---

## 6. äº¤å‰ç¼–è¯‘

### 6.1 ç›®æ ‡å¹³å°

**æŸ¥çœ‹æ”¯æŒçš„ç›®æ ‡**ï¼š

```bash
# åˆ—å‡ºæ‰€æœ‰ç›®æ ‡
rustc --print target-list

# å¸¸è§ç›®æ ‡
x86_64-unknown-linux-gnu      # Linux (glibc)
x86_64-unknown-linux-musl     # Linux (musl)
x86_64-pc-windows-gnu         # Windows (GNU)
x86_64-pc-windows-msvc        # Windows (MSVC)
x86_64-apple-darwin           # macOS
aarch64-unknown-linux-gnu     # ARM64 Linux
wasm32-unknown-unknown        # WebAssembly
```

**å®‰è£…ç›®æ ‡**ï¼š

```bash
# æ·»åŠ ç›®æ ‡
rustup target add x86_64-pc-windows-gnu
rustup target add aarch64-unknown-linux-gnu

# åˆ—å‡ºå·²å®‰è£…ç›®æ ‡
rustup target list --installed
```

### 6.2 é…ç½®äº¤å‰ç¼–è¯‘

**åŸºæœ¬äº¤å‰ç¼–è¯‘**ï¼š

```bash
# ç¼–è¯‘åˆ° Windows
cargo build --target x86_64-pc-windows-gnu

# ç¼–è¯‘åˆ° ARM
cargo build --target aarch64-unknown-linux-gnu
```

**é…ç½®é“¾æ¥å™¨**ï¼š

```toml
# .cargo/config.toml
[target.aarch64-unknown-linux-gnu]
linker = "aarch64-linux-gnu-gcc"

[target.x86_64-pc-windows-gnu]
linker = "x86_64-w64-mingw32-gcc"
```

**ç¯å¢ƒå˜é‡**ï¼š

```bash
# è®¾ç½®é“¾æ¥å™¨
export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc

# è®¾ç½® sysroot
export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUSTFLAGS="-C link-arg=--sysroot=/path/to/sysroot"
```

### 6.3 å¸¸è§å¹³å°

**Linux â†’ Windows**ï¼š

```bash
# å®‰è£…å·¥å…·é“¾
sudo apt install mingw-w64

# æ·»åŠ ç›®æ ‡
rustup target add x86_64-pc-windows-gnu

# ç¼–è¯‘
cargo build --target x86_64-pc-windows-gnu --release
```

**Linux â†’ macOS**ï¼š

```bash
# ä½¿ç”¨ osxcross
git clone https://github.com/tpoechtrager/osxcross
# ... è®¾ç½® SDK

# é…ç½®
[target.x86_64-apple-darwin]
linker = "x86_64-apple-darwin-clang"

# ç¼–è¯‘
cargo build --target x86_64-apple-darwin
```

**ä»»æ„å¹³å° â†’ WebAssembly**ï¼š

```bash
# æ·»åŠ ç›®æ ‡
rustup target add wasm32-unknown-unknown

# ç¼–è¯‘
cargo build --target wasm32-unknown-unknown --release

# ä½¿ç”¨ wasm-pack
cargo install wasm-pack
wasm-pack build --target web
```

---

## 7. æ„å»ºè„šæœ¬

### 7.1 build.rs åŸºç¡€

**åˆ›å»ºæ„å»ºè„šæœ¬**ï¼š

```toml
# Cargo.toml
[package]
name = "my-package"
build = "build.rs"  # é»˜è®¤è·¯å¾„

[build-dependencies]
cc = "1.0"
```

```rust
// build.rs
fn main() {
    println!("cargo:rerun-if-changed=build.rs");

    // ç¼–è¯‘ C ä»£ç 
    cc::Build::new()
        .file("src/native.c")
        .compile("native");

    // è®¾ç½®ç¯å¢ƒå˜é‡
    println!("cargo:rustc-env=BUILD_TIME={}",
             std::time::SystemTime::now()
                 .duration_since(std::time::UNIX_EPOCH)
                 .unwrap()
                 .as_secs());
}
```

### 7.2 å¸¸è§ç”¨ä¾‹

**1. ç¼–è¯‘ C/C++ ä»£ç **ï¼š

```rust
// build.rs
fn main() {
    cc::Build::new()
        .file("src/wrapper.c")
        .include("include")
        .compile("wrapper");
}
```

**2. ä»£ç ç”Ÿæˆ**ï¼š

```rust
// build.rs
use std::env;
use std::fs;
use std::path::Path;

fn main() {
    let out_dir = env::var("OUT_DIR").unwrap();
    let dest_path = Path::new(&out_dir).join("generated.rs");

    fs::write(
        dest_path,
        "pub const GENERATED: &str = \"Hello\";"
    ).unwrap();
}
```

```rust
// src/lib.rs
include!(concat!(env!("OUT_DIR"), "/generated.rs"));
```

**3. æ¡ä»¶ç¼–è¯‘é…ç½®**ï¼š

```rust
// build.rs
fn main() {
    if cfg!(target_os = "linux") {
        println!("cargo:rustc-cfg=linux_platform");
    }

    // è‡ªå®šä¹‰ cfg
    println!("cargo:rustc-cfg=custom_feature");
}
```

```rust
// src/lib.rs
#[cfg(linux_platform)]
fn platform_specific() {
    println!("Linux!");
}

#[cfg(custom_feature)]
fn custom_code() {}
```

### 7.3 é«˜çº§æŠ€å·§

**é‡æ–°è¿è¡Œæ¡ä»¶**ï¼š

```rust
fn main() {
    // ä»…åœ¨ç‰¹å®šæ–‡ä»¶æ”¹å˜æ—¶é‡æ–°è¿è¡Œ
    println!("cargo:rerun-if-changed=src/native.c");
    println!("cargo:rerun-if-changed=include/header.h");

    // ä»…åœ¨ç¯å¢ƒå˜é‡æ”¹å˜æ—¶
    println!("cargo:rerun-if-env-changed=CC");

    // è­¦å‘Š
    println!("cargo:warning=This is a build warning");
}
```

**é“¾æ¥åº“**ï¼š

```rust
fn main() {
    // é“¾æ¥ç³»ç»Ÿåº“
    println!("cargo:rustc-link-lib=static=mylib");
    println!("cargo:rustc-link-lib=dylib=ssl");

    // é“¾æ¥æœç´¢è·¯å¾„
    println!("cargo:rustc-link-search=native=/usr/local/lib");
}
```

---

## 8. å¹¶è¡Œæ„å»º

### 8.1 å¹¶è¡Œçº§åˆ«

```bash
# é»˜è®¤ï¼šä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
cargo build

# é™åˆ¶å¹¶è¡Œä»»åŠ¡æ•°
cargo build -j 4

# ä¸²è¡Œæ„å»º
cargo build -j 1

# ç¯å¢ƒå˜é‡
export CARGO_BUILD_JOBS=4
```

### 8.2 èµ„æºæ§åˆ¶

```bash
# é™åˆ¶å†…å­˜ä½¿ç”¨ï¼ˆé€šè¿‡å‡å°‘å¹¶è¡Œï¼‰
cargo build -j 2

# ç›‘æ§èµ„æºä½¿ç”¨
cargo build --timings

# CI ç¯å¢ƒä¼˜åŒ–
export CARGO_BUILD_JOBS=2  # é¿å… OOM
cargo build --release
```

### 8.3 æ„å»ºç¼“å­˜

**sccache (å…±äº«ç¼“å­˜)**ï¼š

```bash
# å®‰è£…
cargo install sccache

# é…ç½®
export RUSTC_WRAPPER=sccache

# ä½¿ç”¨
cargo build  # è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜

# ç»Ÿè®¡
sccache --show-stats
```

**æ•ˆæœ**ï¼š

```text
é¦–æ¬¡æ„å»º: 100%
åç»­æ„å»º: 20% (-80%)
```

---

## 9. æ„å»ºæ€§èƒ½ä¼˜åŒ–

### 9.1 ç¼–è¯‘æ—¶é—´åˆ†æ

```bash
# æ—¶é—´çº¿åˆ†æ
cargo build --timings

# ç”Ÿæˆ HTML æŠ¥å‘Š
# æŸ¥çœ‹ target/cargo-timings/cargo-timing.html

# è¯¦ç»†è¾“å‡º
cargo build -vv

# ä½¿ç”¨ cargo-llvm-linesï¼ˆåˆ†æå•æ€åŒ–ï¼‰
cargo install cargo-llvm-lines
cargo llvm-lines | head -20
```

### 9.2 ä¾èµ–ä¼˜åŒ–

```toml
[profile.dev]
# ä¼˜åŒ–ä¾èµ–ï¼Œä½†ä¸ä¼˜åŒ–è‡ªå·±çš„ä»£ç 
[profile.dev.package."*"]
opt-level = 2
```

**å‡å°‘ä¾èµ–**ï¼š

```toml
# âŒ é¿å…é‡å‹ä¾èµ–
[dependencies]
tokio = { version = "1.48", features = ["full"] }

# âœ… åªå¯ç”¨éœ€è¦çš„ç‰¹æ€§
[dependencies]
tokio = { version = "1.48", features = ["rt", "sync"] }
```

### 9.3 å·¥å…·é“¾ä¼˜åŒ–

**ä½¿ç”¨æ›´å¿«çš„é“¾æ¥å™¨**ï¼š

```toml
# .cargo/config.toml

# Linux: mold
[target.x86_64-unknown-linux-gnu]
rustflags = ["-C", "link-arg=-fuse-ld=mold"]

# macOS: zld
[target.x86_64-apple-darwin]
rustflags = ["-C", "link-arg=-fuse-ld=/usr/local/bin/zld"]

# Windows: lld
[target.x86_64-pc-windows-msvc]
rustflags = ["-C", "link-arg=/fuse-ld=lld"]
```

**æ•ˆæœ**ï¼š

```text
é»˜è®¤é“¾æ¥å™¨:  100% (åŸºå‡†)
lld:        70%  (-30%)
mold:       40%  (-60%)
```

---

## 10. äºŒè¿›åˆ¶ä¼˜åŒ–

### 10.1 å¤§å°ä¼˜åŒ–

**æ¿€è¿›å¤§å°ä¼˜åŒ–**ï¼š

```toml
[profile.release]
opt-level = "z"     # ä¼˜åŒ–å¤§å°
lto = "fat"         # å…¨å±€ä¼˜åŒ–
codegen-units = 1   # å•ä»£ç ç”Ÿæˆå•å…ƒ
strip = true        # å‰¥ç¦»ç¬¦å·
panic = "abort"     # ä¸å±•å¼€ panic

[dependencies]
# ç¦ç”¨é»˜è®¤ç‰¹æ€§
serde = { version = "1.0", default-features = false, features = ["derive"] }
```

**æ›´å¤šæŠ€å·§**ï¼š

```bash
# ä½¿ç”¨ UPX å‹ç¼©
upx --best --lzma target/release/my-app

# æ•ˆæœå¯¹æ¯”
ls -lh target/release/my-app
# Before: 5 MB
# After:  1.5 MB (-70%)
```

### 10.2 æ€§èƒ½ä¼˜åŒ–

**æœ€å¤§æ€§èƒ½é…ç½®**ï¼š

```toml
[profile.release]
opt-level = 3
lto = "fat"
codegen-units = 1
panic = "abort"

# CPU ç‰¹å®šä¼˜åŒ–
[target.x86_64-unknown-linux-gnu]
rustflags = ["-C", "target-cpu=native"]
```

**PGO (Profile-Guided Optimization)**ï¼š

```bash
# 1. æ„å»ºå¸¦æ’æ¡©çš„ç‰ˆæœ¬
RUSTFLAGS="-Cprofile-generate=/tmp/pgo-data" \
    cargo build --release

# 2. è¿è¡Œç¨‹åºæ”¶é›†æ•°æ®
./target/release/my-app

# 3. ä½¿ç”¨æ•°æ®é‡æ–°æ„å»º
rustup run nightly cargo build --release \
    -- -Cprofile-use=/tmp/pgo-data
```

### 10.3 åˆ†æå·¥å…·

**cargo-bloat (å¤§å°åˆ†æ)**ï¼š

```bash
cargo install cargo-bloat

# åˆ†æäºŒè¿›åˆ¶
cargo bloat --release

# æŒ‰ crate åˆ†æ
cargo bloat --release --crates

# æŸ¥çœ‹å‰ 20 ä¸ªå‡½æ•°
cargo bloat --release -n 20
```

**perf (æ€§èƒ½åˆ†æ)**ï¼š

```bash
# Linux: perf
cargo build --release
perf record target/release/my-app
perf report

# macOS: Instruments
cargo build --release
instruments -t "Time Profiler" target/release/my-app
```

**flamegraph**ï¼š

```bash
cargo install flamegraph

# ç”Ÿæˆç«ç„°å›¾
cargo flamegraph

# è¾“å‡º: flamegraph.svg
```

---

## ğŸ“Š Profile å¯¹æ¯”è¡¨

| é…ç½®é¡¹         | dev    | release | è‡ªå®šä¹‰ä¼˜åŒ– |
| -------------- | ------ | ------- | ---------- |
| opt-level      | 0      | 3       | 3/"z"      |
| debug          | true   | false   | 1          |
| lto            | false  | false   | "fat"      |
| codegen-units  | 256    | 16      | 1          |
| incremental    | true   | false   | false      |
| strip          | false  | false   | true       |
| panic          | unwind | unwind  | abort      |
| **ç¼–è¯‘æ—¶é—´**   | âš¡ å¿«  | ğŸŒ æ…¢   | ğŸŒğŸŒ å¾ˆæ…¢  |
| **è¿è¡Œé€Ÿåº¦**   | ğŸŒ æ…¢  | âš¡ å¿«   | âš¡âš¡ å¾ˆå¿«  |
| **äºŒè¿›åˆ¶å¤§å°** | ğŸ“¦ å¤§  | ğŸ“¦ å¤§   | ğŸ“¦ å°      |

---

## ğŸ” å¸¸è§é—®é¢˜

**Q1: å¦‚ä½•åŠ é€Ÿå¼€å‘æ„å»ºï¼Ÿ**

```toml
[profile.dev]
opt-level = 1  # é€‚åº¦ä¼˜åŒ–

[profile.dev.package."*"]
opt-level = 2  # ä¼˜åŒ–ä¾èµ–
```

```bash
# ä½¿ç”¨ sccache
export RUSTC_WRAPPER=sccache
```

**Q2: å¦‚ä½•æœ€å°åŒ–äºŒè¿›åˆ¶å¤§å°ï¼Ÿ**

```toml
[profile.release]
opt-level = "z"
lto = "fat"
codegen-units = 1
strip = true
panic = "abort"
```

**Q3: äº¤å‰ç¼–è¯‘å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**

```bash
# æ£€æŸ¥é“¾æ¥å™¨
which aarch64-linux-gnu-gcc

# æ£€æŸ¥é…ç½®
cat .cargo/config.toml

# è¯¦ç»†é”™è¯¯ä¿¡æ¯
cargo build --target aarch64-unknown-linux-gnu -vv
```

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [Profiles](https://doc.rust-lang.org/cargo/reference/profiles.html)
- [Build Scripts](https://doc.rust-lang.org/cargo/reference/build-scripts.html)
- [Cross Compilation](https://rust-lang.github.io/rustup/cross-compilation.html)

### å·¥å…·

- [cargo-bloat](https://github.com/RazrFalcon/cargo-bloat) - äºŒè¿›åˆ¶å¤§å°åˆ†æ
- [cargo-llvm-lines](https://github.com/dtolnay/cargo-llvm-lines) - ä»£ç è†¨èƒ€åˆ†æ
- [sccache](https://github.com/mozilla/sccache) - ç¼–è¯‘ç¼“å­˜
- [mold](https://github.com/rui314/mold) - å¿«é€Ÿé“¾æ¥å™¨

### ç›¸å…³æ–‡æ¡£

- [03\_ä¾èµ–ç®¡ç†è¯¦è§£.md](./03_ä¾èµ–ç®¡ç†è¯¦è§£.md)
- [08\_æœ€ä½³å®è·µæŒ‡å—.md](./08_æœ€ä½³å®è·µæŒ‡å—.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-26
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.93.0+

_ä¼˜åŒ–æ„å»ºï¼Œæå‡æ•ˆç‡ã€‚_ ğŸ¦€âš™ï¸
