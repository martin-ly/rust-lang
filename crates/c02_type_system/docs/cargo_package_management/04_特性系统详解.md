# Cargo ç‰¹æ€§ç³»ç»Ÿè¯¦è§£

## ğŸ“‹ ç›®å½•

- [Cargo ç‰¹æ€§ç³»ç»Ÿè¯¦è§£](#cargo-ç‰¹æ€§ç³»ç»Ÿè¯¦è§£)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ ç‰¹æ€§ç³»ç»Ÿæ¦‚è§ˆ](#-ç‰¹æ€§ç³»ç»Ÿæ¦‚è§ˆ)
  - [1. ç‰¹æ€§åŸºç¡€](#1-ç‰¹æ€§åŸºç¡€)
    - [1.1 ä»€ä¹ˆæ˜¯ç‰¹æ€§](#11-ä»€ä¹ˆæ˜¯ç‰¹æ€§)
    - [1.2 ç‰¹æ€§å£°æ˜](#12-ç‰¹æ€§å£°æ˜)
    - [1.3 ç‰¹æ€§ä½¿ç”¨](#13-ç‰¹æ€§ä½¿ç”¨)
  - [2. ç‰¹æ€§ç±»å‹](#2-ç‰¹æ€§ç±»å‹)
    - [2.1 ç®€å•ç‰¹æ€§](#21-ç®€å•ç‰¹æ€§)
    - [2.2 ä¾èµ–ç‰¹æ€§](#22-ä¾èµ–ç‰¹æ€§)
    - [2.3 å¯é€‰ä¾èµ–ç‰¹æ€§](#23-å¯é€‰ä¾èµ–ç‰¹æ€§)
    - [2.4 ç‰¹æ€§ç»„åˆ](#24-ç‰¹æ€§ç»„åˆ)
  - [3. é»˜è®¤ç‰¹æ€§](#3-é»˜è®¤ç‰¹æ€§)
    - [3.1 å®šä¹‰é»˜è®¤ç‰¹æ€§](#31-å®šä¹‰é»˜è®¤ç‰¹æ€§)
    - [3.2 ç¦ç”¨é»˜è®¤ç‰¹æ€§](#32-ç¦ç”¨é»˜è®¤ç‰¹æ€§)
    - [3.3 æœ€ä½³å®è·µ](#33-æœ€ä½³å®è·µ)
  - [4. ç‰¹æ€§ä¼ æ’­](#4-ç‰¹æ€§ä¼ æ’­)
    - [4.1 ä¼ æ’­æœºåˆ¶](#41-ä¼ æ’­æœºåˆ¶)
    - [4.2 ä¼ æ’­è§„åˆ™](#42-ä¼ æ’­è§„åˆ™)
    - [4.3 ä¼ æ’­ç¤ºä¾‹](#43-ä¼ æ’­ç¤ºä¾‹)
  - [5. æ¡ä»¶ç¼–è¯‘](#5-æ¡ä»¶ç¼–è¯‘)
    - [5.1 cfg å±æ€§](#51-cfg-å±æ€§)
    - [5.2 cfg! å®](#52-cfg-å®)
    - [5.3 æ¡ä»¶æ¨¡å—](#53-æ¡ä»¶æ¨¡å—)
  - [6. ç‰¹æ€§ç»Ÿä¸€](#6-ç‰¹æ€§ç»Ÿä¸€)
    - [6.1 ç»Ÿä¸€è§„åˆ™](#61-ç»Ÿä¸€è§„åˆ™)
    - [6.2 Resolver 3 æ”¹è¿›](#62-resolver-3-æ”¹è¿›)
    - [6.3 é¿å…ç‰¹æ€§æ±¡æŸ“](#63-é¿å…ç‰¹æ€§æ±¡æŸ“)
  - [7. é«˜çº§ç‰¹æ€§æ¨¡å¼](#7-é«˜çº§ç‰¹æ€§æ¨¡å¼)
    - [7.1 äº’æ–¥ç‰¹æ€§](#71-äº’æ–¥ç‰¹æ€§)
    - [7.2 å¹³å°ç‰¹å®šç‰¹æ€§](#72-å¹³å°ç‰¹å®šç‰¹æ€§)
    - [7.3 ç‰¹æ€§é—¨æ§](#73-ç‰¹æ€§é—¨æ§)
  - [8. ç‰¹æ€§æ–‡æ¡£](#8-ç‰¹æ€§æ–‡æ¡£)
    - [8.1 æ–‡æ¡£æ³¨é‡Š](#81-æ–‡æ¡£æ³¨é‡Š)
    - [8.2 ç‰¹æ€§æ ‡æ³¨](#82-ç‰¹æ€§æ ‡æ³¨)
    - [8.3 ç¤ºä¾‹ä»£ç ](#83-ç¤ºä¾‹ä»£ç )
  - [9. ç‰¹æ€§æµ‹è¯•](#9-ç‰¹æ€§æµ‹è¯•)
    - [9.1 æµ‹è¯•ç­–ç•¥](#91-æµ‹è¯•ç­–ç•¥)
    - [9.2 CI é…ç½®](#92-ci-é…ç½®)
    - [9.3 ç‰¹æ€§ç»„åˆæµ‹è¯•](#93-ç‰¹æ€§ç»„åˆæµ‹è¯•)
  - [10. ç‰¹æ€§ä¼˜åŒ–](#10-ç‰¹æ€§ä¼˜åŒ–)
    - [10.1 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–](#101-ç¼–è¯‘æ—¶é—´ä¼˜åŒ–)
    - [10.2 äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–](#102-äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–)
    - [10.3 ç‰¹æ€§åˆ†æ](#103-ç‰¹æ€§åˆ†æ)
  - [ğŸ“Š ç‰¹æ€§è®¾è®¡æ¨¡å¼](#-ç‰¹æ€§è®¾è®¡æ¨¡å¼)
    - [æ¨¡å¼ 1: æ ‡å‡†åº“æŠ½è±¡](#æ¨¡å¼-1-æ ‡å‡†åº“æŠ½è±¡)
    - [æ¨¡å¼ 2: åºåˆ—åŒ–æ”¯æŒ](#æ¨¡å¼-2-åºåˆ—åŒ–æ”¯æŒ)
    - [æ¨¡å¼ 3: åç«¯é€‰æ‹©](#æ¨¡å¼-3-åç«¯é€‰æ‹©)
    - [æ¨¡å¼ 4: åŠŸèƒ½åˆ†çº§](#æ¨¡å¼-4-åŠŸèƒ½åˆ†çº§)
  - [ğŸ” å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)
  - [ğŸ“– å»¶ä¼¸é˜…è¯»](#-å»¶ä¼¸é˜…è¯»)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ğŸ¯ ç‰¹æ€§ç³»ç»Ÿæ¦‚è§ˆ

Cargo çš„ç‰¹æ€§ï¼ˆFeaturesï¼‰ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„æ¡ä»¶ç¼–è¯‘èƒ½åŠ›ï¼š

```mermaid
graph TD
    A[ç‰¹æ€§ç³»ç»Ÿ] --> B[æ¡ä»¶ç¼–è¯‘]
    A --> C[å¯é€‰ä¾èµ–]
    A --> D[ç‰¹æ€§ç»„åˆ]
    A --> E[å¹³å°é€‚é…]

    B --> B1[å‡å°‘ä»£ç ]
    C --> C1[æŒ‰éœ€å¼•å…¥]
    D --> D1[çµæ´»é…ç½®]
    E --> E1[è·¨å¹³å°]
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

- **ç‰¹æ€§ï¼ˆFeatureï¼‰**: å‘½åçš„ç¼–è¯‘æ—¶å¼€å…³
- **æ¡ä»¶ç¼–è¯‘**: æ ¹æ®ç‰¹æ€§é€‰æ‹©æ€§ç¼–è¯‘ä»£ç 
- **ç‰¹æ€§ç»Ÿä¸€**: ä¾èµ–æ ‘ä¸­ç‰¹æ€§çš„åˆå¹¶è§„åˆ™
- **å¯é€‰ä¾èµ–**: é€šè¿‡ç‰¹æ€§æ§åˆ¶çš„ä¾èµ–

---

## 1. ç‰¹æ€§åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯ç‰¹æ€§

**ç‰¹æ€§**æ˜¯ Cargo æä¾›çš„æ¡ä»¶ç¼–è¯‘æœºåˆ¶ï¼Œå…è®¸ï¼š

- åœ¨ç¼–è¯‘æ—¶åŒ…å«æˆ–æ’é™¤ä»£ç 
- æ§åˆ¶å¯é€‰ä¾èµ–çš„å¼•å…¥
- æä¾›ä¸åŒçš„åŠŸèƒ½ç»„åˆ
- ä¼˜åŒ–ç¼–è¯‘æ—¶é—´å’ŒäºŒè¿›åˆ¶å¤§å°

### 1.2 ç‰¹æ€§å£°æ˜

```toml
[package]
name = "my-lib"
version = "0.1.0"

[features]
# é»˜è®¤å¯ç”¨çš„ç‰¹æ€§
default = ["std"]

# åŸºç¡€ç‰¹æ€§ï¼ˆç©ºç‰¹æ€§ï¼‰
std = []
alloc = []

# ä¾èµ–å…¶ä»–ç‰¹æ€§
full = ["std", "alloc", "json", "async"]

# å¯ç”¨å¯é€‰ä¾èµ–
json = ["dep:serde_json"]
async = ["dep:tokio"]

# ä¼ æ’­åˆ°ä¾èµ–
serde-support = ["dep:serde", "serde/derive"]
```

### 1.3 ç‰¹æ€§ä½¿ç”¨

**æ„å»ºæ—¶å¯ç”¨**ï¼š

```bash
# ä½¿ç”¨é»˜è®¤ç‰¹æ€§
cargo build

# ç¦ç”¨é»˜è®¤ç‰¹æ€§
cargo build --no-default-features

# å¯ç”¨ç‰¹å®šç‰¹æ€§
cargo build --features json
cargo build --features "json,async"

# å¯ç”¨æ‰€æœ‰ç‰¹æ€§
cargo build --all-features

# ç»„åˆä½¿ç”¨
cargo build --no-default-features --features json
```

**ä¾èµ–ä¸­å¯ç”¨**ï¼š

```toml
[dependencies]
# ä½¿ç”¨é»˜è®¤ç‰¹æ€§
my-lib = "0.1"

# ç¦ç”¨é»˜è®¤ç‰¹æ€§
my-lib = { version = "0.1", default-features = false }

# å¯ç”¨ç‰¹å®šç‰¹æ€§
my-lib = { version = "0.1", features = ["json", "async"] }

# ç¦ç”¨é»˜è®¤ + å¯ç”¨ç‰¹å®š
my-lib = {
    version = "0.1",
    default-features = false,
    features = ["std", "json"]
}
```

---

## 2. ç‰¹æ€§ç±»å‹

### 2.1 ç®€å•ç‰¹æ€§

**å®šä¹‰**ï¼š

```toml
[features]
# ç©ºç‰¹æ€§ï¼ˆä»…ä½œä¸ºæ ‡è®°ï¼‰
feature-a = []
feature-b = []
```

**ä½¿ç”¨**ï¼š

```rust
// æ¡ä»¶ç¼–è¯‘
#[cfg(feature = "feature-a")]
pub mod module_a {
    pub fn function() {
        println!("Feature A enabled");
    }
}

#[cfg(feature = "feature-b")]
pub mod module_b {
    pub fn function() {
        println!("Feature B enabled");
    }
}
```

### 2.2 ä¾èµ–ç‰¹æ€§

**å®šä¹‰**ï¼š

```toml
[features]
# feature-a ä¾èµ– feature-b
feature-a = ["feature-b"]
feature-b = []

# å¤šé‡ä¾èµ–
full = ["feature-a", "feature-b", "feature-c"]
```

**æ•ˆæœ**ï¼š

```bash
# å¯ç”¨ feature-a ä¼šè‡ªåŠ¨å¯ç”¨ feature-b
cargo build --features feature-a
```

### 2.3 å¯é€‰ä¾èµ–ç‰¹æ€§

**Rust 1.92.0 è¯­æ³•**ï¼ˆå…¼å®¹ Rust 1.90+ ç‰¹æ€§ï¼‰ï¼š

```toml
[dependencies]
serde = { version = "1.0", optional = true }
serde_json = { version = "1.0", optional = true }
tokio = { version = "1.48", optional = true }

[features]
# æ–°è¯­æ³•ï¼šdep: å‰ç¼€
json = ["dep:serde", "dep:serde_json"]
async = ["dep:tokio"]

# å¯ç”¨ä¾èµ–çš„ç‰¹æ€§
json-with-derive = ["json", "serde/derive"]
async-full = ["async", "tokio/full"]
```

**æ—§è¯­æ³•ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰**ï¼š

```toml
[dependencies]
serde = { version = "1.0", optional = true }

[features]
# å¯é€‰ä¾èµ–è‡ªåŠ¨åˆ›å»ºåŒåç‰¹æ€§
# serde = ["dep:serde"]  # è‡ªåŠ¨åˆ›å»º
```

### 2.4 ç‰¹æ€§ç»„åˆ

```toml
[features]
default = ["std"]

# åŸºç¡€ç‰¹æ€§
std = []
alloc = []

# åŠŸèƒ½ç‰¹æ€§
json = ["dep:serde_json"]
yaml = ["dep:serde_yaml"]
toml = ["dep:toml"]

# ç»„åˆç‰¹æ€§
serialization = ["json", "yaml", "toml"]
full = ["std", "serialization", "async"]
minimal = ["alloc"]
```

**ä½¿ç”¨åœºæ™¯**ï¼š

```bash
# æœ€å°åŠŸèƒ½
cargo build --no-default-features --features minimal

# åºåˆ—åŒ–æ”¯æŒ
cargo build --features serialization

# å®Œæ•´åŠŸèƒ½
cargo build --features full
```

---

## 3. é»˜è®¤ç‰¹æ€§

### 3.1 å®šä¹‰é»˜è®¤ç‰¹æ€§

```toml
[features]
# é»˜è®¤å¯ç”¨ std
default = ["std"]

std = []
alloc = []
```

**å«ä¹‰**ï¼š

```bash
# è¿™ä¸¤ä¸ªå‘½ä»¤ç­‰ä»·
cargo build
cargo build --features std
```

### 3.2 ç¦ç”¨é»˜è®¤ç‰¹æ€§

```toml
[dependencies]
# åº“ä½œè€…å®šä¹‰
my-lib = { version = "0.1", default-features = false }

# å¯ç”¨å…¶ä»–ç‰¹æ€§
my-lib = {
    version = "0.1",
    default-features = false,
    features = ["alloc"]
}
```

### 3.3 æœ€ä½³å®è·µ

**æ¨èæ¨¡å¼**ï¼š

```toml
[features]
# 1. é»˜è®¤ç‰¹æ€§åº”è¯¥æ˜¯æœ€å¸¸ç”¨çš„é…ç½®
default = ["std"]

# 2. æä¾› no_std é€‰é¡¹
std = ["alloc"]
alloc = []

# 3. æä¾›å®Œæ•´ç‰¹æ€§é›†
full = ["std", "all-formats", "async"]

# 4. æä¾›æœ€å°ç‰¹æ€§é›†
minimal = []
```

**ç¤ºä¾‹åœºæ™¯**ï¼š

```toml
# serde é£æ ¼
[features]
default = ["std"]
std = []
alloc = []
derive = ["serde_derive"]
```

---

## 4. ç‰¹æ€§ä¼ æ’­

### 4.1 ä¼ æ’­æœºåˆ¶

**å®šä¹‰**ï¼š

```toml
# ä½ çš„åº“ my-lib
[dependencies]
serde = { version = "1.0", default-features = false }

[features]
std = ["serde/std"]  # ä¼ æ’­ std ç‰¹æ€§åˆ° serde
derive = ["serde/derive"]
```

**ä½¿ç”¨**ï¼š

```toml
# ç”¨æˆ·é¡¹ç›®
[dependencies]
my-lib = { version = "0.1", features = ["std"] }

# æ•ˆæœï¼š
# 1. my-lib å¯ç”¨ std ç‰¹æ€§
# 2. serde ä¹Ÿå¯ç”¨ std ç‰¹æ€§
```

### 4.2 ä¼ æ’­è§„åˆ™

```toml
[features]
# è¯­æ³•ï¼šç‰¹æ€§å = ["ä¾èµ–å/ç‰¹æ€§å"]
my-feature = ["dep-a/feature-x", "dep-b/feature-y"]

# ç¤ºä¾‹
std = [
    "serde/std",      # ä¼ æ’­åˆ° serde
    "tokio/std",      # ä¼ æ’­åˆ° tokio
    "dep:log",        # å¯ç”¨å¯é€‰ä¾èµ–
]
```

**ä¼ æ’­é“¾**ï¼š

```text
ä½ çš„ç‰¹æ€§ â†’ ä¾èµ–ç‰¹æ€§ â†’ ä¾èµ–çš„ä¾èµ–ç‰¹æ€§
  std    â†’ serde/std  â†’ serde_derive/std
```

### 4.3 ä¼ æ’­ç¤ºä¾‹

**å®Œæ•´ç¤ºä¾‹**ï¼š

```toml
# Cargo.toml
[dependencies]
serde = { version = "1.0", default-features = false, optional = true }
serde_json = { version = "1.0", default-features = false, optional = true }

[features]
default = []

# no_std å…¼å®¹
std = ["serde?/std", "serde_json?/std"]
alloc = ["serde?/alloc"]

# åºåˆ—åŒ–æ”¯æŒ
serde-support = ["dep:serde"]
json = ["serde-support", "dep:serde_json"]

# å®Œæ•´åŠŸèƒ½
full = ["std", "json"]
```

**æ³¨æ„ `?` è¯­æ³•**ï¼š

```toml
# Rust 1.92.0+ å¼±ä¾èµ–è¯­æ³•ï¼ˆå…¼å®¹ Rust 1.90+ ç‰¹æ€§ï¼‰
std = ["serde?/std"]  # åªåœ¨ serde å¯ç”¨æ—¶ä¼ æ’­

# ç­‰ä»·äºæ—§å†™æ³•
std = []
# å¦‚æœå¯ç”¨äº† serdeï¼Œstd ä¼šè‡ªåŠ¨ä¼ æ’­
```

---

## 5. æ¡ä»¶ç¼–è¯‘

### 5.1 cfg å±æ€§

```rust
// åŸºäºç‰¹æ€§çš„æ¡ä»¶ç¼–è¯‘
#[cfg(feature = "std")]
use std::collections::HashMap;

#[cfg(not(feature = "std"))]
use alloc::collections::BTreeMap;

// å‡½æ•°çº§åˆ«
#[cfg(feature = "json")]
pub fn from_json(data: &str) -> Result<Self, Error> {
    serde_json::from_str(data)
}

// æ¨¡å—çº§åˆ«
#[cfg(feature = "async")]
pub mod async_impl {
    pub async fn process() {
        // async å®ç°
    }
}

// å¤šæ¡ä»¶
#[cfg(all(feature = "std", feature = "json"))]
pub fn std_json_function() {}

#[cfg(any(feature = "json", feature = "yaml"))]
pub fn any_format_function() {}
```

### 5.2 cfg! å®

```rust
pub fn setup() {
    // è¿è¡Œæ—¶æ£€æŸ¥ï¼ˆç¼–è¯‘æ—¶å†³å®šï¼‰
    if cfg!(feature = "debug") {
        println!("Debug mode enabled");
    }

    // ç»„åˆæ¡ä»¶
    if cfg!(all(feature = "std", feature = "json")) {
        println!("Both std and json enabled");
    }

    // å¹³å° + ç‰¹æ€§
    if cfg!(all(target_os = "linux", feature = "native")) {
        println!("Linux native mode");
    }
}
```

### 5.3 æ¡ä»¶æ¨¡å—

```rust
// src/lib.rs
#[cfg(feature = "std")]
pub mod std_impl;

#[cfg(not(feature = "std"))]
pub mod no_std_impl;

// é‡å¯¼å‡º
#[cfg(feature = "std")]
pub use std_impl::*;

#[cfg(not(feature = "std"))]
pub use no_std_impl::*;
```

**æ–‡ä»¶ç»„ç»‡**ï¼š

```text
src/
â”œâ”€â”€ lib.rs
â”œâ”€â”€ std_impl.rs      # std å®ç°
â””â”€â”€ no_std_impl.rs   # no_std å®ç°
```

---

## 6. ç‰¹æ€§ç»Ÿä¸€

### 6.1 ç»Ÿä¸€è§„åˆ™

**åŸºæœ¬è§„åˆ™**ï¼šç‰¹æ€§æ˜¯ç´¯åŠ çš„ï¼Œä¸èƒ½ç¦ç”¨

```text
ä½ çš„é¡¹ç›®
  â”œâ”€â”€ dep-a (features = ["feature-x"])
  â””â”€â”€ dep-b
        â””â”€â”€ dep-a (features = ["feature-y"])

ç»“æœï¼šdep-a å¯ç”¨ feature-x å’Œ feature-y
```

**ç¤ºä¾‹**ï¼š

```toml
# Package A
[dependencies]
serde = { version = "1.0", default-features = false }

# Package B
[dependencies]
serde = "1.0"  # å¯ç”¨é»˜è®¤ç‰¹æ€§

# ç»“æœï¼šserde ä¼šå¯ç”¨é»˜è®¤ç‰¹æ€§
# ï¼ˆç‰¹æ€§ç»Ÿä¸€ï¼šå–å¹¶é›†ï¼‰
```

### 6.2 Resolver 3 æ”¹è¿›

```toml
[package]
edition = "2024"
resolver = "3"
```

**æ”¹è¿›**ï¼š

1. **åŒºåˆ† build å’Œè¿è¡Œæ—¶ä¾èµ–**

    ```toml
    [dependencies]
    serde = { version = "1.0", default-features = false }

    [build-dependencies]
    serde = "1.0"  # å¯ç”¨é»˜è®¤ç‰¹æ€§

    # Resolver 3ï¼š
    # - è¿è¡Œæ—¶ï¼šserde ä¸å¯ç”¨é»˜è®¤ç‰¹æ€§
    # - æ„å»ºæ—¶ï¼šserde å¯ç”¨é»˜è®¤ç‰¹æ€§
    ```

2. **å¹³å°ç‰¹å®šç‰¹æ€§**

    ```toml
    [target.'cfg(unix)'.dependencies]
    libc = { version = "0.2", features = ["extra"] }

    # Resolver 3ï¼š
    # - Windowsï¼šä¸ä¼šå› ä¸º Unix ç‰¹æ€§è€Œå¯ç”¨
    ```

### 6.3 é¿å…ç‰¹æ€§æ±¡æŸ“

**é—®é¢˜**ï¼š

```toml
# åº“ Aï¼šno_std
[dependencies]
core-lib = { version = "1.0", default-features = false }

# åº“ Bï¼šstd
[dependencies]
core-lib = "1.0"

# ç”¨æˆ·åŒæ—¶ä¾èµ– A å’Œ B
# ç»“æœï¼šcore-lib å¯ç”¨ stdï¼ˆç‰¹æ€§æ±¡æŸ“ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```toml
# 1. æ–‡æ¡£è¯´æ˜
# å‘ŠçŸ¥ç”¨æˆ· no_std å…¼å®¹æ€§è¦æ±‚

# 2. ä½¿ç”¨å¼±ä¾èµ–
[features]
std = ["core-lib?/std"]

# 3. æä¾›ç‹¬ç«‹çš„ no_std åŒ…
# core-lib-nostd = "1.0"
```

---

## 7. é«˜çº§ç‰¹æ€§æ¨¡å¼

### 7.1 äº’æ–¥ç‰¹æ€§

```toml
[features]
backend-a = []
backend-b = []

# æ„å»ºè„šæœ¬æ£€æŸ¥
# build.rs
```

```rust
// build.rs
fn main() {
    let a = cfg!(feature = "backend-a");
    let b = cfg!(feature = "backend-b");

    if a && b {
        panic!("Cannot enable both backend-a and backend-b");
    }
    if !a && !b {
        panic!("Must enable either backend-a or backend-b");
    }
}
```

### 7.2 å¹³å°ç‰¹å®šç‰¹æ€§

```toml
[features]
# å¹³å°ç‰¹å®šç‰¹æ€§
linux-native = []
windows-native = []

# è‡ªåŠ¨é€‰æ‹©
[target.'cfg(target_os = "linux")'.features]
default = ["linux-native"]

[target.'cfg(target_os = "windows")'.features]
default = ["windows-native"]
```

### 7.3 ç‰¹æ€§é—¨æ§

```rust
// ç¡®ä¿ç‰¹æ€§æ­£ç¡®ç»„åˆ
#[cfg(all(feature = "async", not(feature = "std")))]
compile_error!("async feature requires std");

#[cfg(all(not(feature = "backend-a"), not(feature = "backend-b")))]
compile_error!("Must enable at least one backend");
```

---

## 8. ç‰¹æ€§æ–‡æ¡£

### 8.1 æ–‡æ¡£æ³¨é‡Š

```rust
//! # ç‰¹æ€§æ–‡æ¡£
//!
//! ## å¯ç”¨ç‰¹æ€§
//!
//! - `std` (é»˜è®¤): æ ‡å‡†åº“æ”¯æŒ
//! - `alloc`: å †åˆ†é…æ”¯æŒï¼ˆéœ€è¦ alloc crateï¼‰
//! - `json`: JSON åºåˆ—åŒ–æ”¯æŒ
//! - `async`: å¼‚æ­¥è¿è¡Œæ—¶æ”¯æŒ
//! - `full`: å¯ç”¨æ‰€æœ‰ç‰¹æ€§

/// è¿™ä¸ªå‡½æ•°éœ€è¦ `json` ç‰¹æ€§
#[cfg_attr(feature = "json", doc = "Available with feature `json`")]
#[cfg(feature = "json")]
pub fn from_json(data: &str) -> Result<Self, Error> {
    // å®ç°
}
```

### 8.2 ç‰¹æ€§æ ‡æ³¨

```rust
// ä½¿ç”¨ cfg_attr æ ‡æ³¨
#[cfg_attr(docsrs, doc(cfg(feature = "json")))]
#[cfg(feature = "json")]
pub mod json_support {
    //! JSON æ”¯æŒæ¨¡å—
}
```

**Cargo.toml é…ç½®**ï¼š

```toml
[package.metadata.docs.rs]
all-features = true
rustdoc-args = ["--cfg", "docsrs"]
```

### 8.3 ç¤ºä¾‹ä»£ç 

````rust
/// # Examples
///
/// ä½¿ç”¨ `json` ç‰¹æ€§ï¼š
///
/// ```
/// # #[cfg(feature = "json")]
/// # {
/// use my_lib::from_json;
///
/// let data = r#"{"name": "John"}"#;
/// let obj = from_json(data)?;
/// # }
/// # Ok::<(), Box<dyn std::error::Error>>(())
/// ```
pub fn example() {}
````

---

## 9. ç‰¹æ€§æµ‹è¯•

### 9.1 æµ‹è¯•ç­–ç•¥

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_default() {
        // æµ‹è¯•é»˜è®¤ç‰¹æ€§
    }

    #[test]
    #[cfg(feature = "std")]
    fn test_std_feature() {
        // æµ‹è¯• std ç‰¹æ€§
    }

    #[test]
    #[cfg(all(feature = "json", feature = "std"))]
    fn test_json_std() {
        // æµ‹è¯•ç‰¹æ€§ç»„åˆ
    }
}
```

### 9.2 CI é…ç½®

```yaml
# .github/workflows/test.yml
name: Test Features

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features:
          - ""                    # é»˜è®¤
          - "--no-default-features"
          - "--features std"
          - "--features json"
          - "--features full"
          - "--all-features"

    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Test
        run: cargo test ${{ matrix.features }}
```

### 9.3 ç‰¹æ€§ç»„åˆæµ‹è¯•

```bash
# æµ‹è¯•è„šæœ¬
#!/bin/bash

# æµ‹è¯•æ‰€æœ‰ç‰¹æ€§ç»„åˆ
cargo test --no-default-features
cargo test --features std
cargo test --features alloc
cargo test --features json
cargo test --features "std,json"
cargo test --all-features

# ä½¿ç”¨ cargo-hack
cargo install cargo-hack
cargo hack test --feature-powerset
```

---

## 10. ç‰¹æ€§ä¼˜åŒ–

### 10.1 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–

```toml
[features]
# æŒ‰éœ€å¯ç”¨é‡å‹ä¾èµ–
heavy-feature = ["dep:heavy-dep"]

# é»˜è®¤ä¸å¯ç”¨
default = []
```

**æ•ˆæœ**ï¼š

```bash
# å¿«é€Ÿæ„å»ºï¼ˆä¸å¯ç”¨ heavy-featureï¼‰
cargo build  # -50% ç¼–è¯‘æ—¶é—´

# å®Œæ•´æ„å»º
cargo build --features heavy-feature
```

### 10.2 äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–

```toml
[features]
# ç²¾ç®€ç‰¹æ€§é›†
minimal = []
default = ["std"]
full = ["std", "all-formats", "compression"]
```

```bash
# æœ€å°äºŒè¿›åˆ¶
cargo build --release --no-default-features --features minimal
# ç»“æœï¼š-30% å¤§å°

# å®Œæ•´åŠŸèƒ½
cargo build --release --features full
```

### 10.3 ç‰¹æ€§åˆ†æ

```bash
# æŸ¥çœ‹ç‰¹æ€§å¯¹ç¼–è¯‘çš„å½±å“
cargo build --timings

# åˆ†æäºŒè¿›åˆ¶å¤§å°è´¡çŒ®
cargo bloat --release --features full
cargo bloat --release --no-default-features

# å¯¹æ¯”ä¸åŒç‰¹æ€§
cargo build --release --features minimal
du -h target/release/my-app
cargo build --release --features full
du -h target/release/my-app
```

---

## ğŸ“Š ç‰¹æ€§è®¾è®¡æ¨¡å¼

### æ¨¡å¼ 1: æ ‡å‡†åº“æŠ½è±¡

```toml
[features]
default = ["std"]
std = ["alloc"]
alloc = []
```

```rust
#[cfg(feature = "std")]
use std::vec::Vec;

#[cfg(all(not(feature = "std"), feature = "alloc"))]
use alloc::vec::Vec;
```

### æ¨¡å¼ 2: åºåˆ—åŒ–æ”¯æŒ

```toml
[dependencies]
serde = { version = "1.0", optional = true }

[features]
serde-support = ["dep:serde", "serde/derive"]
```

### æ¨¡å¼ 3: åç«¯é€‰æ‹©

```toml
[features]
default = ["backend-native"]
backend-native = ["dep:native-lib"]
backend-wasm = ["dep:wasm-lib"]
```

### æ¨¡å¼ 4: åŠŸèƒ½åˆ†çº§

```toml
[features]
default = ["basic"]
basic = []
advanced = ["basic", "extra-algorithms"]
full = ["advanced", "all-formats"]
```

---

## ğŸ” å¸¸è§é—®é¢˜

**Q1: å¦‚ä½•è®¾è®¡å¥½çš„é»˜è®¤ç‰¹æ€§ï¼Ÿ**

```toml
[features]
# âœ… å¥½ï¼šæœ€å¸¸ç”¨çš„é…ç½®
default = ["std"]

# âŒ å·®ï¼šåŒ…å«å¤ªå¤šåŠŸèƒ½
default = ["full"]  # å¯èƒ½å¾ˆæ…¢
```

**Q2: å¦‚ä½•é¿å…ç‰¹æ€§å†²çªï¼Ÿ**

```rust
// ä½¿ç”¨ç¼–è¯‘æ—¶æ£€æŸ¥
#[cfg(all(feature = "backend-a", feature = "backend-b"))]
compile_error!("Cannot enable both backends");
```

**Q3: å¦‚ä½•æµ‹è¯•æ‰€æœ‰ç‰¹æ€§ç»„åˆï¼Ÿ**

```bash
# ä½¿ç”¨ cargo-hack
cargo hack test --feature-powerset --depth 2
```

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [Features](https://doc.rust-lang.org/cargo/reference/features.html)
- [Conditional Compilation](https://doc.rust-lang.org/reference/conditional-compilation.html)
- [Resolver Version 3](https://doc.rust-lang.org/cargo/reference/resolver.html#feature-resolver-version-3)

### ç›¸å…³æ–‡æ¡£

- [03_ä¾èµ–ç®¡ç†è¯¦è§£.md](./03_ä¾èµ–ç®¡ç†è¯¦è§£.md)
- [05_å·¥ä½œç©ºé—´ç®¡ç†.md](./05_å·¥ä½œç©ºé—´ç®¡ç†.md)
- [08_æœ€ä½³å®è·µæŒ‡å—.md](./08_æœ€ä½³å®è·µæŒ‡å—.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-26
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.93.0+

*ç‰¹æ€§ç³»ç»Ÿè®©ä½ çš„ä»£ç æ—¢çµæ´»åˆé«˜æ•ˆã€‚* ğŸ¦€âš™ï¸
