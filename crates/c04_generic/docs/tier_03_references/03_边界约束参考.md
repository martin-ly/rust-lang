# C04 æ³›å‹ç¼–ç¨‹ - è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒ

## ğŸ“Š ç›®å½•

- [C04 æ³›å‹ç¼–ç¨‹ - è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒ](#c04-æ³›å‹ç¼–ç¨‹---è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒ)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [ğŸ“ çŸ¥è¯†ç»“æ„](#-çŸ¥è¯†ç»“æ„)
    - [æ¦‚å¿µå®šä¹‰](#æ¦‚å¿µå®šä¹‰)
    - [å±æ€§ç‰¹å¾](#å±æ€§ç‰¹å¾)
    - [å…³ç³»è¿æ¥](#å…³ç³»è¿æ¥)
    - [æ€ç»´å¯¼å›¾](#æ€ç»´å¯¼å›¾)
  - [1. Trait Bounds è¯­æ³•](#1-trait-bounds-è¯­æ³•)
    - [1.1 å®Œæ•´ BNF è¯­æ³•](#11-å®Œæ•´-bnf-è¯­æ³•)
    - [1.2 åŸºç¡€çº¦æŸè¯­æ³•](#12-åŸºç¡€çº¦æŸè¯­æ³•)
    - [1.3 çº¦æŸä½ç½®](#13-çº¦æŸä½ç½®)
  - [2. Where å­å¥å®Œæ•´è¯­æ³•](#2-where-å­å¥å®Œæ•´è¯­æ³•)
    - [2.1 BNF è¯­æ³•å®šä¹‰](#21-bnf-è¯­æ³•å®šä¹‰)
    - [2.2 åŸºç¡€ Where å­å¥](#22-åŸºç¡€-where-å­å¥)
    - [2.3 å…³è”ç±»å‹çº¦æŸ](#23-å…³è”ç±»å‹çº¦æŸ)
    - [2.4 å¤æ‚ Where å­å¥](#24-å¤æ‚-where-å­å¥)
  - [3. é«˜é˜¶ Trait Bounds (HRTB)](#3-é«˜é˜¶-trait-bounds-hrtb)
    - [3.1 HRTB è¯­æ³•](#31-hrtb-è¯­æ³•)
    - [3.2 å¸¸è§ HRTB æ¨¡å¼](#32-å¸¸è§-hrtb-æ¨¡å¼)
    - [3.3 HRTB ä¸ç”Ÿå‘½å‘¨æœŸçš„å…³ç³»](#33-hrtb-ä¸ç”Ÿå‘½å‘¨æœŸçš„å…³ç³»)
  - [4. ç”Ÿå‘½å‘¨æœŸçº¦æŸ](#4-ç”Ÿå‘½å‘¨æœŸçº¦æŸ)
    - [4.1 ç”Ÿå‘½å‘¨æœŸçº¦æŸè¯­æ³•](#41-ç”Ÿå‘½å‘¨æœŸçº¦æŸè¯­æ³•)
    - [4.2 é™æ€ç”Ÿå‘½å‘¨æœŸçº¦æŸ](#42-é™æ€ç”Ÿå‘½å‘¨æœŸçº¦æŸ)
  - [5. çº¦æŸä¼ æ’­è§„åˆ™](#5-çº¦æŸä¼ æ’­è§„åˆ™)
    - [5.1 è‡ªåŠ¨ä¼ æ’­](#51-è‡ªåŠ¨ä¼ æ’­)
    - [5.2 é¢å¤–çº¦æŸ](#52-é¢å¤–çº¦æŸ)
    - [5.3 çº¦æŸç»„åˆ](#53-çº¦æŸç»„åˆ)
  - [6. å¤æ‚çº¦æŸç¤ºä¾‹](#6-å¤æ‚çº¦æŸç¤ºä¾‹)
    - [6.1 åµŒå¥—æ³›å‹çº¦æŸ](#61-åµŒå¥—æ³›å‹çº¦æŸ)
    - [6.2 å¤šå±‚å…³è”ç±»å‹çº¦æŸ](#62-å¤šå±‚å…³è”ç±»å‹çº¦æŸ)
    - [6.3 æ¡ä»¶çº¦æŸ](#63-æ¡ä»¶çº¦æŸ)
    - [6.4 é€’å½’çº¦æŸ](#64-é€’å½’çº¦æŸ)
  - [7. çº¦æŸé€ŸæŸ¥è¡¨](#7-çº¦æŸé€ŸæŸ¥è¡¨)
    - [7.1 å¸¸è§çº¦æŸæ¨¡å¼](#71-å¸¸è§çº¦æŸæ¨¡å¼)
    - [7.2 çº¦æŸç­‰ä»·è¡¨](#72-çº¦æŸç­‰ä»·è¡¨)
    - [7.3 çº¦æŸæ£€æŸ¥æ¸…å•](#73-çº¦æŸæ£€æŸ¥æ¸…å•)
  - [ğŸ“š ç›¸å…³å‚è€ƒ](#-ç›¸å…³å‚è€ƒ)

**æ–‡æ¡£ç±»å‹**: Tier 3 å®Œæ•´å‚è€ƒ
**æœ€åæ›´æ–°**: 2025-12-11
**Rust ç‰ˆæœ¬**: 1.92.0+
**å‚è€ƒç±»å‹**: ğŸ” çº¦æŸè¯­æ³•é€ŸæŸ¥

---

## ğŸ“ çŸ¥è¯†ç»“æ„

### æ¦‚å¿µå®šä¹‰

**è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒ (Bound Constraints Complete Reference)**:

- **å®šä¹‰**: è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒæ‰‹å†Œï¼ŒåŒ…æ‹¬ Trait Boundsã€Where å­å¥ã€HRTBã€ç”Ÿå‘½å‘¨æœŸçº¦æŸç­‰
- **ç±»å‹**: è¯­æ³•å‚è€ƒæ–‡æ¡£
- **èŒƒç•´**: æ³›å‹ç¼–ç¨‹ã€ç±»å‹ç³»ç»Ÿ
- **ç‰ˆæœ¬**: Rust 1.92.0+
- **ç›¸å…³æ¦‚å¿µ**: Trait Boundsã€Where å­å¥ã€HRTBã€ç”Ÿå‘½å‘¨æœŸçº¦æŸã€çº¦æŸä¼ æ’­

### å±æ€§ç‰¹å¾

**æ ¸å¿ƒå±æ€§**:

- **Trait Bounds è¯­æ³•**: å®Œæ•´ BNF è¯­æ³•ã€åŸºç¡€çº¦æŸè¯­æ³•ã€çº¦æŸä½ç½®
- **Where å­å¥å®Œæ•´è¯­æ³•**: BNF è¯­æ³•å®šä¹‰ã€åŸºç¡€ Where å­å¥ã€å…³è”ç±»å‹çº¦æŸã€å¤æ‚ Where å­å¥
- **é«˜é˜¶ Trait Bounds (HRTB)**: HRTB è¯­æ³•ã€å¸¸è§ HRTB æ¨¡å¼ã€HRTB ä¸ç”Ÿå‘½å‘¨æœŸçš„å…³ç³»
- **ç”Ÿå‘½å‘¨æœŸçº¦æŸ**: ç”Ÿå‘½å‘¨æœŸçº¦æŸè¯­æ³•ã€é™æ€ç”Ÿå‘½å‘¨æœŸçº¦æŸ

**æ€§èƒ½ç‰¹å¾**:

- **ç¼–è¯‘æ—¶å¤„ç†**: è¾¹ç•Œçº¦æŸåœ¨ç¼–è¯‘æ—¶å¤„ç†
- **é›¶è¿è¡Œæ—¶å¼€é”€**: è¾¹ç•Œçº¦æŸé›¶è¿è¡Œæ—¶å¼€é”€
- **é€‚ç”¨åœºæ™¯**: ç±»å‹çº¦æŸã€æ³›å‹ç¼–ç¨‹ã€ç±»å‹å®‰å…¨

### å…³ç³»è¿æ¥

**ç»„åˆå…³ç³»**:

- è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒ --[covers]--> è¾¹ç•Œçº¦æŸå®Œæ•´å†…å®¹
- æ³›å‹ç¨‹åº --[uses]--> è¾¹ç•Œçº¦æŸ

**ä¾èµ–å…³ç³»**:

- è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒ --[depends-on]--> è¯­è¨€è§„èŒƒ
- æ³›å‹ç¼–ç¨‹ --[depends-on]--> è¾¹ç•Œçº¦æŸ

### æ€ç»´å¯¼å›¾

```text
è¾¹ç•Œçº¦æŸå®Œæ•´å‚è€ƒ
â”‚
â”œâ”€â”€ Trait Bounds è¯­æ³•
â”‚   â””â”€â”€ BNF è¯­æ³•
â”œâ”€â”€ Where å­å¥å®Œæ•´è¯­æ³•
â”‚   â””â”€â”€ å…³è”ç±»å‹çº¦æŸ
â”œâ”€â”€ HRTB
â”‚   â””â”€â”€ é«˜é˜¶ Trait Bounds
â””â”€â”€ ç”Ÿå‘½å‘¨æœŸçº¦æŸ
    â””â”€â”€ é™æ€ç”Ÿå‘½å‘¨æœŸçº¦æŸ
```

---

## 1. Trait Bounds è¯­æ³•

### 1.1 å®Œæ•´ BNF è¯­æ³•

```bnf
TypeParamBounds ::= TypeParamBound ('+' TypeParamBound)* '+'?

TypeParamBound ::= Lifetime | TraitBound

TraitBound ::= '?'? 'for'<'LifetimeParams'>'? TypePath

LifetimeParams ::= LIFETIME_OR_LABEL (',' LIFETIME_OR_LABEL)* ','?
```

### 1.2 åŸºç¡€çº¦æŸè¯­æ³•

```rust
// å•ä¸ªçº¦æŸ
fn print<T: Display>(value: T) {
    println!("{}", value);
}

// å¤šä¸ªçº¦æŸ
fn process<T: Clone + Debug>(value: T) {
    let copy = value.clone();
    println!("{:?}", copy);
}

// ä½¿ç”¨ + è¯­æ³•
fn compare<T: PartialEq + Display>(a: T, b: T) {
    if a == b {
        println!("{} equals {}", a, b);
    }
}
```

### 1.3 çº¦æŸä½ç½®

```rust
// 1. ç±»å‹å‚æ•°ä½ç½®
fn func1<T: Display>(value: T) { }

// 2. impl å—
impl<T: Clone> MyStruct<T> { }

// 3. trait å®šä¹‰
trait MyTrait<T: Display> { }

// 4. ç»“æ„ä½“å®šä¹‰
struct MyStruct<T: Clone> { }

// 5. ç±»å‹åˆ«å
type MyType<T: Display> = Vec<T>;
```

---

## 2. Where å­å¥å®Œæ•´è¯­æ³•

### 2.1 BNF è¯­æ³•å®šä¹‰

```bnf
WhereClause ::= 'where' WhereClauseItem (',' WhereClauseItem)* ','?

WhereClauseItem ::= LifetimeWhereClauseItem | TypeBoundWhereClauseItem

LifetimeWhereClauseItem ::= Lifetime ':' LifetimeBounds

TypeBoundWhereClauseItem ::= 'for'<LifetimeParams>? Type ':' TypeParamBounds?
```

### 2.2 åŸºç¡€ Where å­å¥

```rust
// ç®€å• where å­å¥
fn print<T>(value: T)
where
    T: Display,
{
    println!("{}", value);
}

// å¤šä¸ªçº¦æŸ
fn process<T, U>(t: T, u: U)
where
    T: Clone + Debug,
    U: Display,
{
    println!("{:?}, {}", t, u);
}
```

### 2.3 å…³è”ç±»å‹çº¦æŸ

```rust
fn sum<I>(iter: I) -> i32
where
    I: Iterator,
    I::Item: Into<i32>,
{
    iter.map(|x| x.into()).sum()
}

// å¤šä¸ªå…³è”ç±»å‹çº¦æŸ
fn convert<T>(value: T) -> String
where
    T: IntoIterator,
    T::Item: Display,
    T::IntoIter: ExactSizeIterator,
{
    format!("{}", value.into_iter().len())
}
```

### 2.4 å¤æ‚ Where å­å¥

```rust
fn complex<T, U, V>(t: T, u: U) -> V
where
    T: Clone + Debug + PartialEq,
    U: IntoIterator,
    U::Item: Display,
    V: From<T> + Default,
{
    V::from(t)
}
```

---

## 3. é«˜é˜¶ Trait Bounds (HRTB)

### 3.1 HRTB è¯­æ³•

```bnf
ForLifetimes ::= 'for' '<' LifetimeParams '>'

HRTBound ::= ForLifetimes TraitBound
```

**ç¤ºä¾‹**:

```rust
// for<'a> è¯­æ³•
fn call_with_ref<F>(f: F)
where
    F: for<'a> Fn(&'a str),
{
    f("hello");
}

// ç­‰ä»·äºæ¥å—ä»»æ„ç”Ÿå‘½å‘¨æœŸçš„é—­åŒ…
fn example() {
    call_with_ref(|s| println!("{}", s));
}
```

### 3.2 å¸¸è§ HRTB æ¨¡å¼

**æ¨¡å¼ 1: å‡½æ•°æŒ‡é’ˆ**:

```rust
// æ¥å—ä»»æ„ç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°
type StringProcessor = for<'a> fn(&'a str) -> &'a str;

fn process(f: StringProcessor, s: &str) -> &str {
    f(s)
}
```

**æ¨¡å¼ 2: Fn Traits**:

```rust
// Fn trait çš„ HRTB
fn apply<F>(f: F, s: &str)
where
    F: for<'a> Fn(&'a str) -> &'a str,
{
    let result = f(s);
    println!("{}", result);
}

// FnMut trait çš„ HRTB
fn apply_mut<F>(mut f: F, s: &str)
where
    F: for<'a> FnMut(&'a str) -> String,
{
    let result = f(s);
    println!("{}", result);
}
```

**æ¨¡å¼ 3: æ³›å‹å…³è”ç±»å‹**:

```rust
trait Processor {
    type Output<'a> where Self: 'a;
    fn process<'a>(&'a self, input: &'a str) -> Self::Output<'a>;
}

fn use_processor<P>(processor: &P)
where
    P: Processor,
    for<'a> P::Output<'a>: Display,
{
    println!("{}", processor.process("test"));
}
```

### 3.3 HRTB ä¸ç”Ÿå‘½å‘¨æœŸçš„å…³ç³»

```rust
// ä¸ä½¿ç”¨ HRTB (é™åˆ¶äº†ç”Ÿå‘½å‘¨æœŸ)
fn example1<'a, F>(f: F)
where
    F: Fn(&'a str),
{
    // f åªèƒ½æ¥å—ç”Ÿå‘½å‘¨æœŸä¸º 'a çš„å­—ç¬¦ä¸²
}

// ä½¿ç”¨ HRTB (æ›´çµæ´»)
fn example2<F>(f: F)
where
    F: for<'a> Fn(&'a str),
{
    // f å¯ä»¥æ¥å—ä»»æ„ç”Ÿå‘½å‘¨æœŸçš„å­—ç¬¦ä¸²
    f("short");
    f("a very long string");
}
```

---

## 4. ç”Ÿå‘½å‘¨æœŸçº¦æŸ

### 4.1 ç”Ÿå‘½å‘¨æœŸçº¦æŸè¯­æ³•

```rust
// 'a: 'b è¡¨ç¤º 'a è‡³å°‘å’Œ 'b ä¸€æ ·é•¿
fn example<'a, 'b>(x: &'a str, y: &'b str) -> &'a str
where
    'a: 'b,  // 'a æ¯” 'b é•¿
{
    x
}

// ç±»å‹çš„ç”Ÿå‘½å‘¨æœŸçº¦æŸ
fn process<'a, T>(value: &'a T)
where
    T: 'a,  // T å¿…é¡»è‡³å°‘æ´»åˆ° 'a
{
    // ...
}

// å¤šä¸ªç”Ÿå‘½å‘¨æœŸçº¦æŸ
fn complex<'a, 'b, 'c, T>(x: &'a T, y: &'b T, z: &'c T)
where
    'a: 'b + 'c,  // 'a æ¯” 'b å’Œ 'c éƒ½é•¿
    T: 'a,
{
    // ...
}
```

### 4.2 é™æ€ç”Ÿå‘½å‘¨æœŸçº¦æŸ

```rust
// T: 'static è¡¨ç¤º T ä¸åŒ…å«éé™æ€å¼•ç”¨
fn spawn_thread<T: Send + 'static>(value: T) {
    std::thread::spawn(move || {
        // value å¯ä»¥å®‰å…¨åœ°åœ¨æ–°çº¿ç¨‹ä¸­ä½¿ç”¨
    });
}

// å‡½æ•°è¿”å›é™æ€å¼•ç”¨
fn get_static<T>() -> &'static str
where
    T: 'static,
{
    "static string"
}
```

---

## 5. çº¦æŸä¼ æ’­è§„åˆ™

### 5.1 è‡ªåŠ¨ä¼ æ’­

```rust
// çº¦æŸè‡ªåŠ¨ä¼ æ’­åˆ°æ–¹æ³•
struct Container<T: Clone> {
    value: T,
}

impl<T: Clone> Container<T> {
    fn duplicate(&self) -> T {
        // Clone çº¦æŸè‡ªåŠ¨å¯ç”¨
        self.value.clone()
    }
}
```

### 5.2 é¢å¤–çº¦æŸ

```rust
// ä¸ºç‰¹å®šæ–¹æ³•æ·»åŠ é¢å¤–çº¦æŸ
struct Container<T> {
    value: T,
}

impl<T> Container<T> {
    fn new(value: T) -> Self {
        Container { value }
    }
}

impl<T: Clone> Container<T> {
    fn duplicate(&self) -> T {
        self.value.clone()
    }
}

impl<T: Display> Container<T> {
    fn print(&self) {
        println!("{}", self.value);
    }
}
```

### 5.3 çº¦æŸç»„åˆ

```rust
// å¤šä¸ª impl å—çš„çº¦æŸç»„åˆ
impl<T: Clone + Display> Container<T> {
    fn print_duplicate(&self) {
        // å¯ä»¥åŒæ—¶ä½¿ç”¨ Clone å’Œ Display
        println!("{}", self.value.clone());
    }
}
```

---

## 6. å¤æ‚çº¦æŸç¤ºä¾‹

### 6.1 åµŒå¥—æ³›å‹çº¦æŸ

```rust
fn process<T, U>(items: Vec<T>) -> Vec<U>
where
    T: IntoIterator,
    T::Item: Clone + Into<U>,
    U: Default,
{
    items
        .into_iter()
        .flat_map(|item| item.into_iter())
        .map(|x| x.clone().into())
        .collect()
}
```

### 6.2 å¤šå±‚å…³è”ç±»å‹çº¦æŸ

```rust
fn convert<I>(iter: I)
where
    I: IntoIterator,
    I::Item: IntoIterator,
    <I::Item as IntoIterator>::Item: Display,
{
    for item in iter {
        for inner in item {
            println!("{}", inner);
        }
    }
}
```

### 6.3 æ¡ä»¶çº¦æŸ

```rust
trait Processor {
    type Output;
    fn process(&self) -> Self::Output;
}

fn handle<T>(processor: T)
where
    T: Processor,
    T::Output: Clone + Debug,
{
    let result = processor.process();
    println!("{:?}", result.clone());
}
```

### 6.4 é€’å½’çº¦æŸ

```rust
trait Recursive {
    type Next: Recursive;
    fn next(&self) -> Self::Next;
}

fn iterate<T>(value: T, depth: usize)
where
    T: Recursive,
{
    if depth > 0 {
        iterate(value.next(), depth - 1);
    }
}
```

---

## 7. çº¦æŸé€ŸæŸ¥è¡¨

### 7.1 å¸¸è§çº¦æŸæ¨¡å¼

| æ¨¡å¼         | è¯­æ³•                   | ç”¨é€”       |
| :--- | :--- | :--- |
| å•ä¸ªçº¦æŸ     | `T: Trait`             | åŸºç¡€çº¦æŸ   |
| å¤šé‡çº¦æŸ     | `T: Trait1 + Trait2`   | å¤šä¸ª trait |
| ç”Ÿå‘½å‘¨æœŸçº¦æŸ | `T: 'a`                | ç”Ÿå‘½å‘¨æœŸ   |
| å…³è”ç±»å‹çº¦æŸ | `T::Item: Trait`       | å…³è”ç±»å‹   |
| HRTB         | `F: for<'a> Fn(&'a T)` | é«˜é˜¶çº¦æŸ   |
| å¯é€‰çº¦æŸ     | `T: ?Sized`            | ä¸å®šå¤§å°   |
| where å­å¥   | `where T: Trait`       | å¤æ‚çº¦æŸ   |

### 7.2 çº¦æŸç­‰ä»·è¡¨

| ç®€å†™è¯­æ³•               | where å­å¥                     | è¯´æ˜         |
| :--- | :--- | :--- |
| `<T: Display>`         | `<T> where T: Display`         | ç­‰ä»·         |
| `<T: Display + Debug>` | `<T> where T: Display + Debug` | ç­‰ä»·         |
| `impl Trait`           | æ³›å‹ + trait bound             | ç±»ä¼¼ä½†æœ‰åŒºåˆ« |

### 7.3 çº¦æŸæ£€æŸ¥æ¸…å•

**å®šä¹‰æ³›å‹æ—¶**:

- âœ… æ˜¯å¦éœ€è¦ Clone?
- âœ… æ˜¯å¦éœ€è¦ Display/Debug?
- âœ… æ˜¯å¦éœ€è¦ Default?
- âœ… æ˜¯å¦éœ€è¦ PartialEq/Eq?
- âœ… æ˜¯å¦éœ€è¦ PartialOrd/Ord?
- âœ… æ˜¯å¦éœ€è¦ Send/Sync?

**ä½¿ç”¨ where å­å¥æ—¶**:

- âœ… çº¦æŸæ˜¯å¦å¿…è¦?
- âœ… æ˜¯å¦å¯ä»¥ç®€åŒ–?
- âœ… æ˜¯å¦æœ‰é—æ¼çš„çº¦æŸ?
- âœ… ç”Ÿå‘½å‘¨æœŸå…³ç³»æ˜¯å¦æ­£ç¡®?

**é‡åˆ°ç¼–è¯‘é”™è¯¯æ—¶**:

- âœ… æ£€æŸ¥çº¦æŸæ˜¯å¦å……åˆ†
- âœ… æ£€æŸ¥ç”Ÿå‘½å‘¨æœŸå…³ç³»
- âœ… æ£€æŸ¥å…³è”ç±»å‹çº¦æŸ
- âœ… è€ƒè™‘ä½¿ç”¨ HRTB

---

## ğŸ“š ç›¸å…³å‚è€ƒ

- [01\_æ³›å‹è¯­æ³•å‚è€ƒ.md](./01_æ³›å‹è¯­æ³•å‚è€ƒ.md) - æ³›å‹è¯­æ³•
- [02_Traitç³»ç»Ÿå‚è€ƒ.md](./02_Traitç³»ç»Ÿå‚è€ƒ.md) - Trait ç³»ç»Ÿ
- [04\_å…³è”ç±»å‹å‚è€ƒ.md](./04_å…³è”ç±»å‹å‚è€ƒ.md) - å…³è”ç±»å‹
- [../tier_02_guides/01_æ³›å‹åŸºç¡€æŒ‡å—.md](../tier_02_guides/01_æ³›å‹åŸºç¡€æŒ‡å—.md) - æ³›å‹åŸºç¡€

---

**æ–‡æ¡£å…ƒä¿¡æ¯**:

- åˆ›å»ºæ—¥æœŸ: 2025-10-22
- ä½œè€…: Rust-Lang Project
- è®¸å¯: MIT OR Apache-2.0
- Rust ç‰ˆæœ¬: 1.92.0+
