# C04 泛型编程 - 边界约束完整参考

## 📊 目录

- [C04 泛型编程 - 边界约束完整参考](#c04-泛型编程---边界约束完整参考)
  - [📊 目录](#-目录)
  - [1. Trait Bounds 语法](#1-trait-bounds-语法)
    - [1.1 完整 BNF 语法](#11-完整-bnf-语法)
    - [1.2 基础约束语法](#12-基础约束语法)
    - [1.3 约束位置](#13-约束位置)
  - [2. Where 子句完整语法](#2-where-子句完整语法)
    - [2.1 BNF 语法定义](#21-bnf-语法定义)
    - [2.2 基础 Where 子句](#22-基础-where-子句)
    - [2.3 关联类型约束](#23-关联类型约束)
    - [2.4 复杂 Where 子句](#24-复杂-where-子句)
  - [3. 高阶 Trait Bounds (HRTB)](#3-高阶-trait-bounds-hrtb)
    - [3.1 HRTB 语法](#31-hrtb-语法)
    - [3.2 常见 HRTB 模式](#32-常见-hrtb-模式)
    - [3.3 HRTB 与生命周期的关系](#33-hrtb-与生命周期的关系)
  - [4. 生命周期约束](#4-生命周期约束)
    - [4.1 生命周期约束语法](#41-生命周期约束语法)
    - [4.2 静态生命周期约束](#42-静态生命周期约束)
  - [5. 约束传播规则](#5-约束传播规则)
    - [5.1 自动传播](#51-自动传播)
    - [5.2 额外约束](#52-额外约束)
    - [5.3 约束组合](#53-约束组合)
  - [6. 复杂约束示例](#6-复杂约束示例)
    - [6.1 嵌套泛型约束](#61-嵌套泛型约束)
    - [6.2 多层关联类型约束](#62-多层关联类型约束)
    - [6.3 条件约束](#63-条件约束)
    - [6.4 递归约束](#64-递归约束)
  - [7. 约束速查表](#7-约束速查表)
    - [7.1 常见约束模式](#71-常见约束模式)
    - [7.2 约束等价表](#72-约束等价表)
    - [7.3 约束检查清单](#73-约束检查清单)
  - [📚 相关参考](#-相关参考)

**文档类型**: Tier 3 完整参考
**最后更新**: 2025-12-11
**Rust 版本**: 1.92.0+
**参考类型**: 🔍 约束语法速查

---

## 1. Trait Bounds 语法

### 1.1 完整 BNF 语法

```bnf
TypeParamBounds ::= TypeParamBound ('+' TypeParamBound)* '+'?

TypeParamBound ::= Lifetime | TraitBound

TraitBound ::= '?'? 'for'<'LifetimeParams'>'? TypePath

LifetimeParams ::= LIFETIME_OR_LABEL (',' LIFETIME_OR_LABEL)* ','?
```

### 1.2 基础约束语法

```rust
// 单个约束
fn print<T: Display>(value: T) {
    println!("{}", value);
}

// 多个约束
fn process<T: Clone + Debug>(value: T) {
    let copy = value.clone();
    println!("{:?}", copy);
}

// 使用 + 语法
fn compare<T: PartialEq + Display>(a: T, b: T) {
    if a == b {
        println!("{} equals {}", a, b);
    }
}
```

### 1.3 约束位置

```rust
// 1. 类型参数位置
fn func1<T: Display>(value: T) { }

// 2. impl 块
impl<T: Clone> MyStruct<T> { }

// 3. trait 定义
trait MyTrait<T: Display> { }

// 4. 结构体定义
struct MyStruct<T: Clone> { }

// 5. 类型别名
type MyType<T: Display> = Vec<T>;
```

---

## 2. Where 子句完整语法

### 2.1 BNF 语法定义

```bnf
WhereClause ::= 'where' WhereClauseItem (',' WhereClauseItem)* ','?

WhereClauseItem ::= LifetimeWhereClauseItem | TypeBoundWhereClauseItem

LifetimeWhereClauseItem ::= Lifetime ':' LifetimeBounds

TypeBoundWhereClauseItem ::= 'for'<LifetimeParams>? Type ':' TypeParamBounds?
```

### 2.2 基础 Where 子句

```rust
// 简单 where 子句
fn print<T>(value: T)
where
    T: Display,
{
    println!("{}", value);
}

// 多个约束
fn process<T, U>(t: T, u: U)
where
    T: Clone + Debug,
    U: Display,
{
    println!("{:?}, {}", t, u);
}
```

### 2.3 关联类型约束

```rust
fn sum<I>(iter: I) -> i32
where
    I: Iterator,
    I::Item: Into<i32>,
{
    iter.map(|x| x.into()).sum()
}

// 多个关联类型约束
fn convert<T>(value: T) -> String
where
    T: IntoIterator,
    T::Item: Display,
    T::IntoIter: ExactSizeIterator,
{
    format!("{}", value.into_iter().len())
}
```

### 2.4 复杂 Where 子句

```rust
fn complex<T, U, V>(t: T, u: U) -> V
where
    T: Clone + Debug + PartialEq,
    U: IntoIterator,
    U::Item: Display,
    V: From<T> + Default,
{
    V::from(t)
}
```

---

## 3. 高阶 Trait Bounds (HRTB)

### 3.1 HRTB 语法

```bnf
ForLifetimes ::= 'for' '<' LifetimeParams '>'

HRTBound ::= ForLifetimes TraitBound
```

**示例**:

```rust
// for<'a> 语法
fn call_with_ref<F>(f: F)
where
    F: for<'a> Fn(&'a str),
{
    f("hello");
}

// 等价于接受任意生命周期的闭包
fn example() {
    call_with_ref(|s| println!("{}", s));
}
```

### 3.2 常见 HRTB 模式

**模式 1: 函数指针**:

```rust
// 接受任意生命周期的函数
type StringProcessor = for<'a> fn(&'a str) -> &'a str;

fn process(f: StringProcessor, s: &str) -> &str {
    f(s)
}
```

**模式 2: Fn Traits**:

```rust
// Fn trait 的 HRTB
fn apply<F>(f: F, s: &str)
where
    F: for<'a> Fn(&'a str) -> &'a str,
{
    let result = f(s);
    println!("{}", result);
}

// FnMut trait 的 HRTB
fn apply_mut<F>(mut f: F, s: &str)
where
    F: for<'a> FnMut(&'a str) -> String,
{
    let result = f(s);
    println!("{}", result);
}
```

**模式 3: 泛型关联类型**:

```rust
trait Processor {
    type Output<'a> where Self: 'a;
    fn process<'a>(&'a self, input: &'a str) -> Self::Output<'a>;
}

fn use_processor<P>(processor: &P)
where
    P: Processor,
    for<'a> P::Output<'a>: Display,
{
    println!("{}", processor.process("test"));
}
```

### 3.3 HRTB 与生命周期的关系

```rust
// 不使用 HRTB (限制了生命周期)
fn example1<'a, F>(f: F)
where
    F: Fn(&'a str),
{
    // f 只能接受生命周期为 'a 的字符串
}

// 使用 HRTB (更灵活)
fn example2<F>(f: F)
where
    F: for<'a> Fn(&'a str),
{
    // f 可以接受任意生命周期的字符串
    f("short");
    f("a very long string");
}
```

---

## 4. 生命周期约束

### 4.1 生命周期约束语法

```rust
// 'a: 'b 表示 'a 至少和 'b 一样长
fn example<'a, 'b>(x: &'a str, y: &'b str) -> &'a str
where
    'a: 'b,  // 'a 比 'b 长
{
    x
}

// 类型的生命周期约束
fn process<'a, T>(value: &'a T)
where
    T: 'a,  // T 必须至少活到 'a
{
    // ...
}

// 多个生命周期约束
fn complex<'a, 'b, 'c, T>(x: &'a T, y: &'b T, z: &'c T)
where
    'a: 'b + 'c,  // 'a 比 'b 和 'c 都长
    T: 'a,
{
    // ...
}
```

### 4.2 静态生命周期约束

```rust
// T: 'static 表示 T 不包含非静态引用
fn spawn_thread<T: Send + 'static>(value: T) {
    std::thread::spawn(move || {
        // value 可以安全地在新线程中使用
    });
}

// 函数返回静态引用
fn get_static<T>() -> &'static str
where
    T: 'static,
{
    "static string"
}
```

---

## 5. 约束传播规则

### 5.1 自动传播

```rust
// 约束自动传播到方法
struct Container<T: Clone> {
    value: T,
}

impl<T: Clone> Container<T> {
    fn duplicate(&self) -> T {
        // Clone 约束自动可用
        self.value.clone()
    }
}
```

### 5.2 额外约束

```rust
// 为特定方法添加额外约束
struct Container<T> {
    value: T,
}

impl<T> Container<T> {
    fn new(value: T) -> Self {
        Container { value }
    }
}

impl<T: Clone> Container<T> {
    fn duplicate(&self) -> T {
        self.value.clone()
    }
}

impl<T: Display> Container<T> {
    fn print(&self) {
        println!("{}", self.value);
    }
}
```

### 5.3 约束组合

```rust
// 多个 impl 块的约束组合
impl<T: Clone + Display> Container<T> {
    fn print_duplicate(&self) {
        // 可以同时使用 Clone 和 Display
        println!("{}", self.value.clone());
    }
}
```

---

## 6. 复杂约束示例

### 6.1 嵌套泛型约束

```rust
fn process<T, U>(items: Vec<T>) -> Vec<U>
where
    T: IntoIterator,
    T::Item: Clone + Into<U>,
    U: Default,
{
    items
        .into_iter()
        .flat_map(|item| item.into_iter())
        .map(|x| x.clone().into())
        .collect()
}
```

### 6.2 多层关联类型约束

```rust
fn convert<I>(iter: I)
where
    I: IntoIterator,
    I::Item: IntoIterator,
    <I::Item as IntoIterator>::Item: Display,
{
    for item in iter {
        for inner in item {
            println!("{}", inner);
        }
    }
}
```

### 6.3 条件约束

```rust
trait Processor {
    type Output;
    fn process(&self) -> Self::Output;
}

fn handle<T>(processor: T)
where
    T: Processor,
    T::Output: Clone + Debug,
{
    let result = processor.process();
    println!("{:?}", result.clone());
}
```

### 6.4 递归约束

```rust
trait Recursive {
    type Next: Recursive;
    fn next(&self) -> Self::Next;
}

fn iterate<T>(value: T, depth: usize)
where
    T: Recursive,
{
    if depth > 0 {
        iterate(value.next(), depth - 1);
    }
}
```

---

## 7. 约束速查表

### 7.1 常见约束模式

| 模式 | 语法 | 用途 |
|------|------|------|
| 单个约束 | `T: Trait` | 基础约束 |
| 多重约束 | `T: Trait1 + Trait2` | 多个 trait |
| 生命周期约束 | `T: 'a` | 生命周期 |
| 关联类型约束 | `T::Item: Trait` | 关联类型 |
| HRTB | `F: for<'a> Fn(&'a T)` | 高阶约束 |
| 可选约束 | `T: ?Sized` | 不定大小 |
| where 子句 | `where T: Trait` | 复杂约束 |

### 7.2 约束等价表

| 简写语法 | where 子句 | 说明 |
|---------|-----------|------|
| `<T: Display>` | `<T> where T: Display` | 等价 |
| `<T: Display + Debug>` | `<T> where T: Display + Debug` | 等价 |
| `impl Trait` | 泛型 + trait bound | 类似但有区别 |

### 7.3 约束检查清单

**定义泛型时**:

- ✅ 是否需要 Clone?
- ✅ 是否需要 Display/Debug?
- ✅ 是否需要 Default?
- ✅ 是否需要 PartialEq/Eq?
- ✅ 是否需要 PartialOrd/Ord?
- ✅ 是否需要 Send/Sync?

**使用 where 子句时**:

- ✅ 约束是否必要?
- ✅ 是否可以简化?
- ✅ 是否有遗漏的约束?
- ✅ 生命周期关系是否正确?

**遇到编译错误时**:

- ✅ 检查约束是否充分
- ✅ 检查生命周期关系
- ✅ 检查关联类型约束
- ✅ 考虑使用 HRTB

---

## 📚 相关参考

- [01_泛型语法参考.md](./01_泛型语法参考.md) - 泛型语法
- [02_Trait系统参考.md](./02_Trait系统参考.md) - Trait 系统
- [04_关联类型参考.md](./04_关联类型参考.md) - 关联类型
- [../tier_02_guides/01_泛型基础指南.md](../tier_02_guides/01_泛型基础指南.md) - 泛型基础

---

**文档元信息**:

- 创建日期: 2025-10-22
- 作者: Rust-Lang Project
- 许可: MIT OR Apache-2.0
- Rust 版本: 1.92.0+
