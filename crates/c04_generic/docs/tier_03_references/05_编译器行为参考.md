# C04 æ³›å‹ç¼–ç¨‹ - ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒ

## ğŸ“Š ç›®å½•

- [C04 æ³›å‹ç¼–ç¨‹ - ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒ](#c04-æ³›å‹ç¼–ç¨‹---ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒ)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [ğŸ“ çŸ¥è¯†ç»“æ„](#-çŸ¥è¯†ç»“æ„)
    - [æ¦‚å¿µå®šä¹‰](#æ¦‚å¿µå®šä¹‰)
    - [å±æ€§ç‰¹å¾](#å±æ€§ç‰¹å¾)
    - [å…³ç³»è¿æ¥](#å…³ç³»è¿æ¥)
    - [æ€ç»´å¯¼å›¾](#æ€ç»´å¯¼å›¾)
  - [1. Monomorphization (å•æ€åŒ–)](#1-monomorphization-å•æ€åŒ–)
    - [1.1 å®šä¹‰](#11-å®šä¹‰)
    - [1.2 å·¥ä½œåŸç†](#12-å·¥ä½œåŸç†)
    - [1.3 ä¼˜åŠ¿ä¸ä»£ä»·](#13-ä¼˜åŠ¿ä¸ä»£ä»·)
    - [1.4 ä»£ç è†¨èƒ€ç¤ºä¾‹](#14-ä»£ç è†¨èƒ€ç¤ºä¾‹)
    - [1.5 æŸ¥çœ‹å•æ€åŒ–ç»“æœ](#15-æŸ¥çœ‹å•æ€åŒ–ç»“æœ)
  - [2. é™æ€åˆ†å‘ vs åŠ¨æ€åˆ†å‘](#2-é™æ€åˆ†å‘-vs-åŠ¨æ€åˆ†å‘)
    - [2.1 é™æ€åˆ†å‘ (Static Dispatch)](#21-é™æ€åˆ†å‘-static-dispatch)
    - [2.2 åŠ¨æ€åˆ†å‘ (Dynamic Dispatch)](#22-åŠ¨æ€åˆ†å‘-dynamic-dispatch)
    - [2.3 æ€§èƒ½å¯¹æ¯”](#23-æ€§èƒ½å¯¹æ¯”)
  - [3. Type Erasure (ç±»å‹æ“¦é™¤)](#3-type-erasure-ç±»å‹æ“¦é™¤)
    - [3.1 å®šä¹‰](#31-å®šä¹‰)
    - [3.2 ç±»å‹æ“¦é™¤è¿‡ç¨‹](#32-ç±»å‹æ“¦é™¤è¿‡ç¨‹)
    - [3.3 ç±»å‹æ“¦é™¤çš„é™åˆ¶](#33-ç±»å‹æ“¦é™¤çš„é™åˆ¶)
  - [4. Fat Pointer ç»“æ„](#4-fat-pointer-ç»“æ„)
    - [4.1 å®šä¹‰](#41-å®šä¹‰)
    - [4.2 å†…å­˜å¸ƒå±€](#42-å†…å­˜å¸ƒå±€)
    - [4.3 VTable ç»“æ„](#43-vtable-ç»“æ„)
    - [4.4 å¤šä¸ª Trait çš„ Fat Pointer](#44-å¤šä¸ª-trait-çš„-fat-pointer)
  - [5. ç¼–è¯‘å™¨ä¼˜åŒ–](#5-ç¼–è¯‘å™¨ä¼˜åŒ–)
    - [5.1 å†…è”ä¼˜åŒ–](#51-å†…è”ä¼˜åŒ–)
    - [5.2 å¸¸é‡æŠ˜å ](#52-å¸¸é‡æŠ˜å )
    - [5.3 æ­»ä»£ç æ¶ˆé™¤](#53-æ­»ä»£ç æ¶ˆé™¤)
  - [6. æ€§èƒ½ç‰¹æ€§](#6-æ€§èƒ½ç‰¹æ€§)
    - [6.1 é›¶æˆæœ¬æŠ½è±¡](#61-é›¶æˆæœ¬æŠ½è±¡)
    - [6.2 æ€§èƒ½åŸºå‡†æµ‹è¯•](#62-æ€§èƒ½åŸºå‡†æµ‹è¯•)
    - [6.3 æ€§èƒ½å¯¹æ¯”è¡¨](#63-æ€§èƒ½å¯¹æ¯”è¡¨)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 ä½•æ—¶ä½¿ç”¨é™æ€åˆ†å‘](#71-ä½•æ—¶ä½¿ç”¨é™æ€åˆ†å‘)
    - [7.2 ä½•æ—¶ä½¿ç”¨åŠ¨æ€åˆ†å‘](#72-ä½•æ—¶ä½¿ç”¨åŠ¨æ€åˆ†å‘)
    - [7.3 ä»£ç å¤§å°ä¼˜åŒ–](#73-ä»£ç å¤§å°ä¼˜åŒ–)
    - [7.4 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–](#74-ç¼–è¯‘æ—¶é—´ä¼˜åŒ–)
  - [ğŸ“š ç›¸å…³å‚è€ƒ](#-ç›¸å…³å‚è€ƒ)

**æ–‡æ¡£ç±»å‹**: Tier 3 å®Œæ•´å‚è€ƒ
**æœ€åæ›´æ–°**: 2025-12-11
**Rust ç‰ˆæœ¬**: 1.92.0+
**å‚è€ƒç±»å‹**: ğŸ” ç¼–è¯‘å™¨è¡Œä¸ºé€ŸæŸ¥

---

## ğŸ“ çŸ¥è¯†ç»“æ„

### æ¦‚å¿µå®šä¹‰

**ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒ (Compiler Behavior Complete Reference)**:

- **å®šä¹‰**: ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒæ‰‹å†Œï¼ŒåŒ…æ‹¬å•æ€åŒ–ã€é™æ€åˆ†å‘ã€åŠ¨æ€åˆ†å‘ã€ç±»å‹æ“¦é™¤ç­‰
- **ç±»å‹**: æŠ€æœ¯å‚è€ƒæ–‡æ¡£
- **èŒƒç•´**: ç¼–è¯‘å™¨æœºåˆ¶ã€æ€§èƒ½ä¼˜åŒ–
- **ç‰ˆæœ¬**: Rust 1.92.0+
- **ç›¸å…³æ¦‚å¿µ**: å•æ€åŒ–ã€é™æ€åˆ†å‘ã€åŠ¨æ€åˆ†å‘ã€ç±»å‹æ“¦é™¤ã€Fat Pointerã€ç¼–è¯‘å™¨ä¼˜åŒ–

### å±æ€§ç‰¹å¾

**æ ¸å¿ƒå±æ€§**:

- **Monomorphization (å•æ€åŒ–)**: å®šä¹‰ã€å·¥ä½œåŸç†ã€ä¼˜åŠ¿ä¸ä»£ä»·ã€ä»£ç è†¨èƒ€ç¤ºä¾‹
- **é™æ€åˆ†å‘ vs åŠ¨æ€åˆ†å‘**: é™æ€åˆ†å‘ã€åŠ¨æ€åˆ†å‘ã€æ€§èƒ½å¯¹æ¯”
- **Type Erasure (ç±»å‹æ“¦é™¤)**: å®šä¹‰ã€ç±»å‹æ“¦é™¤è¿‡ç¨‹ã€ç±»å‹æ“¦é™¤çš„é™åˆ¶
- **Fat Pointer ç»“æ„**: å®šä¹‰ã€å†…å­˜å¸ƒå±€ã€VTable ç»“æ„

**æ€§èƒ½ç‰¹å¾**:

- **å•æ€åŒ–**: æ€§èƒ½ä¼˜åŠ¿ã€ä»£ç è†¨èƒ€
- **é™æ€åˆ†å‘**: å¿«ï¼ˆå¯å†…è”ï¼‰
- **åŠ¨æ€åˆ†å‘**: æ…¢ï¼ˆé—´æ¥è°ƒç”¨ï¼‰
- **é€‚ç”¨åœºæ™¯**: æ€§èƒ½ä¼˜åŒ–ã€ä»£ç å¤§å°ä¼˜åŒ–ã€ç¼–è¯‘æ—¶é—´ä¼˜åŒ–

### å…³ç³»è¿æ¥

**ç»„åˆå…³ç³»**:

- ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒ --[covers]--> ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å†…å®¹
- æ€§èƒ½ä¼˜åŒ–ç¨‹åº --[uses]--> ç¼–è¯‘å™¨è¡Œä¸º

**ä¾èµ–å…³ç³»**:

- ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒ --[depends-on]--> ç¼–è¯‘å™¨æœºåˆ¶
- æ€§èƒ½ä¼˜åŒ– --[depends-on]--> ç¼–è¯‘å™¨è¡Œä¸º

### æ€ç»´å¯¼å›¾

```text
ç¼–è¯‘å™¨è¡Œä¸ºå®Œæ•´å‚è€ƒ
â”‚
â”œâ”€â”€ Monomorphization
â”‚   â””â”€â”€ å•æ€åŒ–
â”œâ”€â”€ é™æ€åˆ†å‘ vs åŠ¨æ€åˆ†å‘
â”‚   â”œâ”€â”€ é™æ€åˆ†å‘
â”‚   â””â”€â”€ åŠ¨æ€åˆ†å‘
â”œâ”€â”€ Type Erasure
â”‚   â””â”€â”€ ç±»å‹æ“¦é™¤
â””â”€â”€ Fat Pointer
    â””â”€â”€ VTable ç»“æ„
```

---

## 1. Monomorphization (å•æ€åŒ–)

### 1.1 å®šä¹‰

**Monomorphization** æ˜¯ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªå…·ä½“ç±»å‹ç”Ÿæˆæ³›å‹ä»£ç çš„ä¸“é—¨ç‰ˆæœ¬çš„è¿‡ç¨‹ã€‚

### 1.2 å·¥ä½œåŸç†

```rust
// æºä»£ç 
fn print<T: Display>(value: T) {
    println!("{}", value);
}

fn main() {
    print(42);
    print("hello");
    print(3.14);
}

// ç¼–è¯‘åç”Ÿæˆï¼ˆæ¦‚å¿µä¸Šï¼‰
fn print_i32(value: i32) {
    println!("{}", value);
}

fn print_str(value: &str) {
    println!("{}", value);
}

fn print_f64(value: f64) {
    println!("{}", value);
}

fn main() {
    print_i32(42);
    print_str("hello");
    print_f64(3.14);
}
```

### 1.3 ä¼˜åŠ¿ä¸ä»£ä»·

**ä¼˜åŠ¿**:

- âœ… é›¶è¿è¡Œæ—¶å¼€é”€
- âœ… å®Œå…¨å†…è”ä¼˜åŒ–
- âœ… ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- âœ… æ— è™šå‡½æ•°è°ƒç”¨å¼€é”€

**ä»£ä»·**:

- âŒ ä»£ç è†¨èƒ€ (Code Bloat)
- âŒ ç¼–è¯‘æ—¶é—´å¢åŠ 
- âŒ äºŒè¿›åˆ¶æ–‡ä»¶å¢å¤§
- âŒ æŒ‡ä»¤ç¼“å­˜å‹åŠ›

### 1.4 ä»£ç è†¨èƒ€ç¤ºä¾‹

```rust
// æ¯ä¸ªå…·ä½“ç±»å‹éƒ½ç”Ÿæˆä¸€ä»½ä»£ç 
fn process<T: Clone>(value: T) -> T {
    value.clone()
}

// ä½¿ç”¨
process(42);              // ç”Ÿæˆ process_i32
process("hello");         // ç”Ÿæˆ process_str
process(vec![1, 2, 3]);   // ç”Ÿæˆ process_vec_i32
process(Some(42));        // ç”Ÿæˆ process_option_i32

// ç»“æœï¼šäºŒè¿›åˆ¶ä¸­æœ‰4ä¸ª process å‡½æ•°çš„å‰¯æœ¬
```

### 1.5 æŸ¥çœ‹å•æ€åŒ–ç»“æœ

```bash
# ä½¿ç”¨ cargo-bloat æŸ¥çœ‹ä»£ç å¤§å°
cargo install cargo-bloat
cargo bloat --release

# æŸ¥çœ‹ç”Ÿæˆçš„ç¬¦å·
rustc --emit=asm example.rs
```

---

## 2. é™æ€åˆ†å‘ vs åŠ¨æ€åˆ†å‘

### 2.1 é™æ€åˆ†å‘ (Static Dispatch)

**å®šä¹‰**: åœ¨ç¼–è¯‘æ—¶ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚

```rust
// é™æ€åˆ†å‘ï¼šä½¿ç”¨æ³›å‹
fn print_static<T: Display>(value: &T) {
    println!("{}", value);
}

// ç¼–è¯‘æ—¶ç¡®å®š
print_static(&42);      // è°ƒç”¨ print_static::<i32>
print_static(&"hello"); // è°ƒç”¨ print_static::<&str>
```

**ä¼˜åŠ¿**:

- é›¶è¿è¡Œæ—¶å¼€é”€
- å¯ä»¥å®Œå…¨å†…è”
- ç¼–è¯‘æ—¶ä¼˜åŒ–

**ä»£ä»·**:

- ä»£ç è†¨èƒ€
- ç¼–è¯‘æ—¶é—´é•¿

### 2.2 åŠ¨æ€åˆ†å‘ (Dynamic Dispatch)

**å®šä¹‰**: åœ¨è¿è¡Œæ—¶é€šè¿‡ vtable ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚

```rust
// åŠ¨æ€åˆ†å‘ï¼šä½¿ç”¨ trait object
fn print_dynamic(value: &dyn Display) {
    println!("{}", value);
}

// è¿è¡Œæ—¶ç¡®å®š
print_dynamic(&42);      // é€šè¿‡ vtable è°ƒç”¨
print_dynamic(&"hello"); // é€šè¿‡ vtable è°ƒç”¨
```

**ä¼˜åŠ¿**:

- ä»£ç å¤§å°å°
- ç¼–è¯‘æ—¶é—´çŸ­
- çµæ´»æ€§é«˜

**ä»£ä»·**:

- è¿è¡Œæ—¶å¼€é”€ (è™šå‡½æ•°è°ƒç”¨)
- æ— æ³•å†…è”
- éœ€è¦é¢å¤–å†…å­˜ (vtable)

### 2.3 æ€§èƒ½å¯¹æ¯”

```rust
use std::time::Instant;

trait Compute {
    fn compute(&self) -> i32;
}

struct Value(i32);

impl Compute for Value {
    fn compute(&self) -> i32 {
        self.0 * 2
    }
}

// é™æ€åˆ†å‘
fn static_dispatch<T: Compute>(value: &T) -> i32 {
    value.compute()
}

// åŠ¨æ€åˆ†å‘
fn dynamic_dispatch(value: &dyn Compute) -> i32 {
    value.compute()
}

fn benchmark() {
    let value = Value(42);
    let iterations = 100_000_000;

    // é™æ€åˆ†å‘
    let start = Instant::now();
    for _ in 0..iterations {
        static_dispatch(&value);
    }
    println!("Static: {:?}", start.elapsed());

    // åŠ¨æ€åˆ†å‘
    let start = Instant::now();
    for _ in 0..iterations {
        dynamic_dispatch(&value);
    }
    println!("Dynamic: {:?}", start.elapsed());
}

// å…¸å‹ç»“æœï¼š
// Static: 0ms (å®Œå…¨ä¼˜åŒ–æ‰)
// Dynamic: ~100ms (è™šå‡½æ•°è°ƒç”¨å¼€é”€)
```

---

## 3. Type Erasure (ç±»å‹æ“¦é™¤)

### 3.1 å®šä¹‰

**ç±»å‹æ“¦é™¤** æ˜¯åœ¨ä½¿ç”¨ trait object æ—¶ï¼Œå…·ä½“ç±»å‹ä¿¡æ¯è¢«"æ“¦é™¤"ï¼Œåªä¿ç•™ trait çš„æ¥å£ä¿¡æ¯ã€‚

### 3.2 ç±»å‹æ“¦é™¤è¿‡ç¨‹

```rust
trait Animal {
    fn make_sound(&self);
}

struct Dog;
struct Cat;

impl Animal for Dog {
    fn make_sound(&self) {
        println!("Woof!");
    }
}

impl Animal for Cat {
    fn make_sound(&self) {
        println!("Meow!");
    }
}

// ç±»å‹æ“¦é™¤å‰
fn specific_dog(dog: &Dog) {
    dog.make_sound();
}

// ç±»å‹æ“¦é™¤å
fn any_animal(animal: &dyn Animal) {
    // ä¸çŸ¥é“å…·ä½“æ˜¯ Dog è¿˜æ˜¯ Cat
    animal.make_sound();
}
```

### 3.3 ç±»å‹æ“¦é™¤çš„é™åˆ¶

```rust
trait Shape {
    fn area(&self) -> f64;
    fn clone(&self) -> Self;  // âŒ è¿”å› Self ä¸å¯¹è±¡å®‰å…¨
}

// è§£å†³æ–¹æ¡ˆï¼šç±»å‹æ“¦é™¤å‹å¥½çš„è®¾è®¡
trait Shape {
    fn area(&self) -> f64;
    fn clone_box(&self) -> Box<dyn Shape>;  // âœ… è¿”å› trait object
}
```

---

## 4. Fat Pointer ç»“æ„

### 4.1 å®šä¹‰

**Fat Pointer** (èƒ–æŒ‡é’ˆ) æ˜¯æŒ‡å‘ trait object çš„æŒ‡é’ˆï¼ŒåŒ…å«ä¸¤éƒ¨åˆ†ï¼š

1. æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ
2. æŒ‡å‘ vtable çš„æŒ‡é’ˆ

### 4.2 å†…å­˜å¸ƒå±€

```rust
trait Animal {
    fn make_sound(&self);
}

struct Dog {
    name: String,
}

impl Animal for Dog {
    fn make_sound(&self) {
        println!("Woof!");
    }
}

let dog = Dog {
    name: String::from("Buddy"),
};

let animal: &dyn Animal = &dog;

// animal æ˜¯ä¸€ä¸ª fat pointer:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Data Pointer     â”‚ â”€â†’ Dog { name: "Buddy" }
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ VTable Pointer   â”‚ â”€â†’ VTable for Dog: Animal
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// å¤§å°å¯¹æ¯”
assert_eq!(std::mem::size_of::<&Dog>(), 8);       // æ™®é€šå¼•ç”¨ï¼š8 å­—èŠ‚
assert_eq!(std::mem::size_of::<&dyn Animal>(), 16); // Fat pointerï¼š16 å­—èŠ‚
```

### 4.3 VTable ç»“æ„

```text
VTable for Dog: Animal
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Drop Fn              â”‚ â”€â†’ dog çš„ drop å‡½æ•°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Size                 â”‚ â”€â†’ Dog çš„å¤§å°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Alignment            â”‚ â”€â†’ Dog çš„å¯¹é½
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ make_sound Fn        â”‚ â”€â†’ Dog::make_sound å®ç°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 å¤šä¸ª Trait çš„ Fat Pointer

```rust
trait Animal {
    fn make_sound(&self);
}

trait Pet {
    fn play(&self);
}

// å•ä¸ª trait
let a: &dyn Animal = &dog;  // 16 å­—èŠ‚ (data + vtable)

// å¤šä¸ª trait (trait object ä¸æ”¯æŒ)
// let ap: &(dyn Animal + Pet) = &dog;  // âŒ ä¸æ”¯æŒ

// è§£å†³æ–¹æ¡ˆï¼šç»„åˆ trait
trait AnimalPet: Animal + Pet {}
let ap: &dyn AnimalPet = &dog;  // 16 å­—èŠ‚
```

---

## 5. ç¼–è¯‘å™¨ä¼˜åŒ–

### 5.1 å†…è”ä¼˜åŒ–

```rust
// å°å‡½æ•°é€šå¸¸ä¼šè¢«å†…è”
#[inline]
fn add<T: std::ops::Add<Output = T>>(a: T, b: T) -> T {
    a + b
}

// æ³›å‹å‡½æ•°æ›´å®¹æ˜“è¢«å†…è”
let result = add(1, 2);  // ç¼–è¯‘åå¯èƒ½å®Œå…¨ä¼˜åŒ–æ‰

// ä½¿ç”¨æ³›å‹é¿å…å‡½æ•°è°ƒç”¨å¼€é”€
fn process_vec<T, F>(vec: Vec<T>, f: F)
where
    F: Fn(T) -> T,
{
    // f å¯èƒ½è¢«å®Œå…¨å†…è”
    vec.into_iter().map(f).collect()
}
```

### 5.2 å¸¸é‡æŠ˜å 

```rust
// const æ³›å‹æ”¯æŒç¼–è¯‘æ—¶è®¡ç®—
fn create_array<const N: usize>() -> [i32; N] {
    [0; N]
}

// ç¼–è¯‘æ—¶å®Œå…¨ç¡®å®š
let arr = create_array::<5>();  // ç›´æ¥ç”Ÿæˆ [0, 0, 0, 0, 0]
```

### 5.3 æ­»ä»£ç æ¶ˆé™¤

```rust
fn maybe_use<T>(use_it: bool, value: T) {
    if use_it {
        // ä½¿ç”¨ value
    }
    // å¦‚æœ use_it æ˜¯å¸¸é‡ falseï¼Œæ•´ä¸ªå‡½æ•°å¯èƒ½è¢«ä¼˜åŒ–æ‰
}

maybe_use(false, expensive_computation());  // å¯èƒ½å®Œå…¨ä¼˜åŒ–æ‰
```

---

## 6. æ€§èƒ½ç‰¹æ€§

### 6.1 é›¶æˆæœ¬æŠ½è±¡

```rust
// æŠ½è±¡å‰
let mut sum = 0;
for i in 0..100 {
    sum += i;
}

// ä½¿ç”¨æ³›å‹æŠ½è±¡
let sum: i32 = (0..100).sum();

// ä¸¤è€…ç”Ÿæˆç›¸åŒçš„æœºå™¨ç  - é›¶æˆæœ¬æŠ½è±¡
```

### 6.2 æ€§èƒ½åŸºå‡†æµ‹è¯•

```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn fibonacci(n: u64) -> u64 {
    match n {
        0 => 1,
        1 => 1,
        n => fibonacci(n-1) + fibonacci(n-2),
    }
}

fn criterion_benchmark(c: &mut Criterion) {
    c.bench_function("fib 20", |b| b.iter(|| fibonacci(black_box(20))));
}

criterion_group!(benches, criterion_benchmark);
criterion_main!(benches);
```

### 6.3 æ€§èƒ½å¯¹æ¯”è¡¨

| ç‰¹æ€§     | é™æ€åˆ†å‘   | åŠ¨æ€åˆ†å‘    | å¼€é”€   |
| :--- | :--- | :--- | :--- || å‡½æ•°è°ƒç”¨ | ç›´æ¥       | é€šè¿‡ vtable | ~1-2ns |
| å†…è”     | å¯èƒ½       | ä¸å¯èƒ½      | -      |
| ä»£ç å¤§å° | å¤§         | å°          | -      |
| ç¼“å­˜å‹å¥½ | å¯èƒ½ä¸å‹å¥½ | å‹å¥½        | -      |

---

## 7. æœ€ä½³å®è·µ

### 7.1 ä½•æ—¶ä½¿ç”¨é™æ€åˆ†å‘

```rust
// âœ… æ€§èƒ½å…³é”®è·¯å¾„
fn hot_path<T: Compute>(value: &T) -> i32 {
    value.compute()
}

// âœ… åº“ API (è®©ç”¨æˆ·å†³å®š)
pub fn sort<T: Ord>(slice: &mut [T]) {
    // æ¯ä¸ªç±»å‹ç”Ÿæˆä¸“é—¨ç‰ˆæœ¬
}

// âœ… ç¼–è¯‘æ—¶å·²çŸ¥ç±»å‹
fn process_known(value: i32) {
    // ...
}
```

### 7.2 ä½•æ—¶ä½¿ç”¨åŠ¨æ€åˆ†å‘

```rust
// âœ… å¼‚æ„é›†åˆ
let shapes: Vec<Box<dyn Shape>> = vec![
    Box::new(Circle { radius: 5.0 }),
    Box::new(Rectangle { width: 10.0, height: 5.0 }),
];

// âœ… æ’ä»¶ç³»ç»Ÿ
trait Plugin {
    fn execute(&self);
}

struct PluginManager {
    plugins: Vec<Box<dyn Plugin>>,
}

// âœ… å‡å°‘ä»£ç è†¨èƒ€
fn print(values: &[&dyn Display]) {
    for value in values {
        println!("{}", value);
    }
}
```

### 7.3 ä»£ç å¤§å°ä¼˜åŒ–

```rust
// æå–å…¬å…±ä»£ç 
fn common_logic(data: &[u8]) {
    // ä¸ä¾èµ–ç±»å‹çš„é€»è¾‘
}

fn process<T>(value: T)
where
    T: AsRef<[u8]>,
{
    common_logic(value.as_ref());
    // ç±»å‹ç‰¹å®šçš„é€»è¾‘
}

// å‡å°‘æ³›å‹å®ä¾‹åŒ–
fn process_impl(data: &[u8]) {
    // å®é™…é€»è¾‘
}

#[inline]
fn process<T: AsRef<[u8]>>(value: T) {
    process_impl(value.as_ref());
}
```

### 7.4 ç¼–è¯‘æ—¶é—´ä¼˜åŒ–

```rust
// å‡å°‘æ³›å‹å±‚æ•°
// âŒ ä¸å¥½ï¼šå¤šå±‚æ³›å‹
fn level3<A, B, C>(a: A, b: B, c: C) -> impl Fn()
where
    A: Fn() -> B,
    B: Fn() -> C,
    C: Display,
{
    // ...
}

// âœ… å¥½ï¼šç®€åŒ–æ³›å‹
fn level1<T: Display>(value: T) {
    // ...
}
```

---

## ğŸ“š ç›¸å…³å‚è€ƒ

- [01\_æ³›å‹è¯­æ³•å‚è€ƒ.md](./01_æ³›å‹è¯­æ³•å‚è€ƒ.md) - æ³›å‹è¯­æ³•
- [../tier_04_advanced/03_é›¶æˆæœ¬æŠ½è±¡.md](../tier_04_advanced/03_é›¶æˆæœ¬æŠ½è±¡.md) - é›¶æˆæœ¬æŠ½è±¡è¯¦è§£
- [../tier_02_guides/05_å®æˆ˜æ¨¡å¼æŒ‡å—.md](../tier_02_guides/05_å®æˆ˜æ¨¡å¼æŒ‡å—.md) - å®æˆ˜æ¨¡å¼

---

**æ–‡æ¡£å…ƒä¿¡æ¯**:

- åˆ›å»ºæ—¥æœŸ: 2025-10-22
- ä½œè€…: Rust-Lang Project
- è®¸å¯: MIT OR Apache-2.0
- Rust ç‰ˆæœ¬: 1.92.0+
