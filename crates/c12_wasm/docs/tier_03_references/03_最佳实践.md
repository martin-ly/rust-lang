# C12 WASM - 最佳实践

> **文档类型**: Tier 3 - 参考层
> **文档定位**: WASM 开发规范和最佳实践
> **项目状态**: ✅ 完整完成
> **相关文档**: [性能优化指南](../tier_02_guides/04_性能优化指南.md) | [API 参考](./01_api_参考.md)

**最后更新**: 2025-10-30
**适用版本**: Rust 1.90+ / Edition 2024, WASM 2.0 + WASI 0.2

---

## 📋 目录

- [C12 WASM - 最佳实践](#c12-wasm---最佳实践)
  - [📊 目录](#-目录)
  - [🎯 概述](#-概述)
  - [💻 代码实践](#-代码实践)
  - [⚡ 性能优化](#-性能优化)
  - [🔐 安全实践](#-安全实践)
  - [📦 项目管理](#-项目管理)
  - [📚 相关资源](#-相关资源)

---

## 🎯 概述

本文档提供 WASM 开发的最佳实践和规范。

---

## 💻 代码实践

### 1. 使用合适的数据类型

```rust
// ✅ 好：使用原始类型
#[wasm_bindgen]
pub fn add(a: i32, b: i32) -> i32 {
    a + b
}

// ❌ 避免：过度使用 String
#[wasm_bindgen]
pub fn add_bad(a: String, b: String) -> String {
    format!("{}", a.parse::<i32>().unwrap() + b.parse::<i32>().unwrap())
}
```

### 2. 减少内存分配

```rust
// ✅ 好：重用缓冲区
thread_local! {
    static BUFFER: RefCell<Vec<u8>> = RefCell::new(Vec::new());
}

// ❌ 避免：频繁分配
pub fn process(data: &[u8]) -> Vec<u8> {
    // 每次都分配新 Vec
    data.to_vec()
}
```

### 3. 错误处理

```rust
// ✅ 好：使用 Result
#[wasm_bindgen]
pub fn divide(a: f64, b: f64) -> Result<f64, String> {
    if b == 0.0 {
        Err("Division by zero".to_string())
    } else {
        Ok(a / b)
    }
}
```

---

## ⚡ 性能优化

### 1. 编译优化

```toml
[profile.release]
opt-level = "z"      # 优化大小
lto = true           # 链接时优化
codegen-units = 1    # 单一代码生成单元
```

### 2. 使用 wasm-opt

```bash
wasm-opt -Oz -o output.wasm input.wasm
```

### 3. 减少依赖

```toml
[dependencies]
some-crate = { version = "1.0", default-features = false }
```

---

## 🔐 安全实践

### 1. 输入验证

```rust
#[wasm_bindgen]
pub fn process_input(input: &str) -> Result<String, String> {
    if input.len() > 1000 {
        return Err("Input too long".to_string());
    }
    // 处理输入
    Ok(input.to_uppercase())
}
```

### 2. 避免内存泄漏

```rust
// ✅ 好：及时释放资源
{
    let data = expensive_operation();
    // 使用 data
} // data 在这里自动释放
```

---

## 📦 项目管理

### 1. 项目结构

```text
project/
├── Cargo.toml
├── src/
│   └── lib.rs
├── pkg/          # wasm-pack 输出
├── www/          # Web 前端
└── tests/        # 测试
```

### 2. 版本管理

```toml
[package]
version = "0.1.0"
```

### 3. 测试

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_add() {
        assert_eq!(add(2, 3), 5);
    }
}
```

---

## 📚 相关资源

- [性能优化指南](../tier_02_guides/04_性能优化指南.md) - 深入学习优化
- [API 参考](./01_api_参考.md) - API 文档
- [常见问题](../tier_01_foundations/04_常见问题.md) - FAQ

---

**文档维护**: Documentation Team
**创建日期**: 2025-10-30
**适用版本**: Rust 1.90+ / Edition 2024, WASM 2.0 + WASI 0.2
