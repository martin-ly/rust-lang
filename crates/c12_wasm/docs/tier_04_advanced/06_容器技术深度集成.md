# WasmEdge å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆæŒ‡å—

> **æ–‡æ¡£ç±»å‹**: Tier 4 - é«˜çº§å±‚
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-30
> **é€‚ç”¨ç‰ˆæœ¬**: WasmEdge 0.13+, Docker 24.0+, Kubernetes 1.28+
> **æŠ€æœ¯å‰æ²¿**: å¯¹æ ‡ 2025 å¹´å®¹å™¨æŠ€æœ¯æœ€æ–°å‘å±•

---

## ğŸ“‹ ç›®å½•

- [WasmEdge å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆæŒ‡å—](#wasmedge-å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆæŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“ çŸ¥è¯†ç»“æ„](#-çŸ¥è¯†ç»“æ„)
    - [æ¦‚å¿µå®šä¹‰](#æ¦‚å¿µå®šä¹‰)
    - [å±æ€§ç‰¹å¾](#å±æ€§ç‰¹å¾)
    - [å…³ç³»è¿æ¥](#å…³ç³»è¿æ¥)
    - [æ€ç»´å¯¼å›¾](#æ€ç»´å¯¼å›¾)
    - [å¤šç»´æ¦‚å¿µå¯¹æ¯”çŸ©é˜µ](#å¤šç»´æ¦‚å¿µå¯¹æ¯”çŸ©é˜µ)
    - [å†³ç­–æ ‘å›¾](#å†³ç­–æ ‘å›¾)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ³ Docker é›†æˆ](#-docker-é›†æˆ)
    - [Docker Desktop é›†æˆ](#docker-desktop-é›†æˆ)
      - [1. å¯ç”¨ WasmEdge æ”¯æŒ](#1-å¯ç”¨-wasmedge-æ”¯æŒ)
      - [2. æ„å»º Wasm å®¹å™¨é•œåƒ](#2-æ„å»º-wasm-å®¹å™¨é•œåƒ)
    - [Docker CLI ä¸ WasmEdge](#docker-cli-ä¸-wasmedge)
      - [è¿è¡Œé€‰é¡¹è¯¦è§£](#è¿è¡Œé€‰é¡¹è¯¦è§£)
    - [å¤šæ¶æ„é•œåƒæ„å»º](#å¤šæ¶æ„é•œåƒæ„å»º)
  - [â˜¸ï¸ Kubernetes æ·±åº¦é›†æˆ](#ï¸-kubernetes-æ·±åº¦é›†æˆ)
    - [RuntimeClass é…ç½®](#runtimeclass-é…ç½®)
      - [1. å®‰è£… containerd-shim-wasmedge](#1-å®‰è£…-containerd-shim-wasmedge)
      - [2. é…ç½® containerd](#2-é…ç½®-containerd)
      - [3. åˆ›å»º RuntimeClass](#3-åˆ›å»º-runtimeclass)
    - [CRI æ’ä»¶é›†æˆ](#cri-æ’ä»¶é›†æˆ)
    - [Workload éƒ¨ç½²ç­–ç•¥](#workload-éƒ¨ç½²ç­–ç•¥)
      - [Deployment ç¤ºä¾‹](#deployment-ç¤ºä¾‹)
      - [Service é…ç½®](#service-é…ç½®)
      - [HorizontalPodAutoscaler (HPA)](#horizontalpodautoscaler-hpa)
      - [Ingress é…ç½®](#ingress-é…ç½®)
  - [ğŸ”§ containerd é›†æˆ](#-containerd-é›†æˆ)
    - [containerd shim æœºåˆ¶](#containerd-shim-æœºåˆ¶)
    - [runwasi é¡¹ç›®](#runwasi-é¡¹ç›®)
  - [ğŸ“ å®¹å™¨ç¼–æ’æœ€ä½³å®è·µ](#-å®¹å™¨ç¼–æ’æœ€ä½³å®è·µ)
    - [1. èµ„æºé…é¢è®¾ç½®](#1-èµ„æºé…é¢è®¾ç½®)
    - [2. èŠ‚ç‚¹äº²å’Œæ€§ä¸æ±¡ç‚¹](#2-èŠ‚ç‚¹äº²å’Œæ€§ä¸æ±¡ç‚¹)
    - [3. é…ç½®ç®¡ç†](#3-é…ç½®ç®¡ç†)
    - [4. ç§˜å¯†ç®¡ç†](#4-ç§˜å¯†ç®¡ç†)
  - [ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
    - [å®Œæ•´éƒ¨ç½²æµç¨‹](#å®Œæ•´éƒ¨ç½²æµç¨‹)
    - [æ»šåŠ¨æ›´æ–°ç­–ç•¥](#æ»šåŠ¨æ›´æ–°ç­–ç•¥)
  - [ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§](#-ç›‘æ§ä¸å¯è§‚æµ‹æ€§)
    - [Prometheus é›†æˆ](#prometheus-é›†æˆ)
    - [Grafana ä»ªè¡¨æ¿](#grafana-ä»ªè¡¨æ¿)
    - [æ—¥å¿—èšåˆ](#æ—¥å¿—èšåˆ)
  - [ğŸ”’ å®‰å…¨ä¸éš”ç¦»](#-å®‰å…¨ä¸éš”ç¦»)
    - [1. Pod Security Standards](#1-pod-security-standards)
    - [2. NetworkPolicy](#2-networkpolicy)
    - [3. SecurityContext](#3-securitycontext)
  - [âš¡ æ€§èƒ½è°ƒä¼˜](#-æ€§èƒ½è°ƒä¼˜)
    - [1. èµ„æºè¯·æ±‚å’Œé™åˆ¶ä¼˜åŒ–](#1-èµ„æºè¯·æ±‚å’Œé™åˆ¶ä¼˜åŒ–)
    - [2. äº²å’Œæ€§è°ƒä¼˜](#2-äº²å’Œæ€§è°ƒä¼˜)
    - [3. HPA è°ƒä¼˜](#3-hpa-è°ƒä¼˜)
  - [ğŸ¯ å®æˆ˜æ¡ˆä¾‹](#-å®æˆ˜æ¡ˆä¾‹)
    - [æ¡ˆä¾‹ 1: å¾®æœåŠ¡ API Gateway (Wasm)](#æ¡ˆä¾‹-1-å¾®æœåŠ¡-api-gateway-wasm)
    - [æ¡ˆä¾‹ 2: è¾¹ç¼˜ AI æ¨ç†æœåŠ¡](#æ¡ˆä¾‹-2-è¾¹ç¼˜-ai-æ¨ç†æœåŠ¡)
    - [æ¡ˆä¾‹ 3: Serverless å‡½æ•°å¹³å°](#æ¡ˆä¾‹-3-serverless-å‡½æ•°å¹³å°)
  - [ğŸ“š æ€»ç»“](#-æ€»ç»“)
    - [å…³é”®ä¼˜åŠ¿](#å…³é”®ä¼˜åŠ¿)
    - [æœ€ä½³å®è·µæ¸…å•](#æœ€ä½³å®è·µæ¸…å•)
    - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## ğŸ“ çŸ¥è¯†ç»“æ„

### æ¦‚å¿µå®šä¹‰

**å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ (Container Technology Deep Integration)**:

- **å®šä¹‰**: Rust 1.92.0 WasmEdge å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆï¼ŒåŒ…æ‹¬ Docker é›†æˆã€Kubernetes æ·±åº¦é›†æˆã€containerd é›†æˆã€å®¹å™¨ç¼–æ’æœ€ä½³å®è·µã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§ã€å®‰å…¨ä¸éš”ç¦»ç­‰
- **ç±»å‹**: é«˜çº§ä¸»é¢˜æ–‡æ¡£
- **èŒƒç•´**: WASMã€å®¹å™¨æŠ€æœ¯
- **ç‰ˆæœ¬**: Rust 1.92.0+ / Edition 2024, WasmEdge 0.13+, Docker 24.0+, Kubernetes 1.28+
- **ç›¸å…³æ¦‚å¿µ**: Dockerã€Kubernetesã€containerdã€å®¹å™¨ç¼–æ’ã€äº‘åŸç”Ÿ

### å±æ€§ç‰¹å¾

**æ ¸å¿ƒå±æ€§**:

- **Docker é›†æˆ**: Docker Desktop é›†æˆã€Docker CLI ä¸ WasmEdgeã€å¤šæ¶æ„é•œåƒæ„å»º
- **Kubernetes æ·±åº¦é›†æˆ**: RuntimeClass é…ç½®ã€CRI æ’ä»¶é›†æˆã€Workload éƒ¨ç½²ç­–ç•¥
- **containerd é›†æˆ**: containerd shim æœºåˆ¶ã€runwasi é¡¹ç›®
- **å®¹å™¨ç¼–æ’æœ€ä½³å®è·µ**: èµ„æºé…é¢è®¾ç½®ã€èŠ‚ç‚¹äº²å’Œæ€§ä¸æ±¡ç‚¹ã€é…ç½®ç®¡ç†ã€ç§˜å¯†ç®¡ç†
- **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**: å®Œæ•´éƒ¨ç½²æµç¨‹ã€æ»šåŠ¨æ›´æ–°ç­–ç•¥
- **ç›‘æ§ä¸å¯è§‚æµ‹æ€§**: Prometheus é›†æˆã€Grafana ä»ªè¡¨æ¿ã€æ—¥å¿—èšåˆ
- **å®‰å…¨ä¸éš”ç¦»**: Pod Security Standardsã€NetworkPolicy

**Rust 1.92.0 æ–°ç‰¹æ€§**:

- **æ”¹è¿›çš„å®¹å™¨æ”¯æŒ**: æ›´å¥½çš„å®¹å™¨æ”¯æŒ
- **å¢å¼ºçš„ Kubernetes**: æ›´å¥½çš„ Kubernetes æ”¯æŒ
- **ä¼˜åŒ–çš„æ€§èƒ½**: æ›´é«˜æ•ˆçš„å®¹å™¨æ€§èƒ½

**æ€§èƒ½ç‰¹å¾**:

- **é«˜æ€§èƒ½**: é«˜æ•ˆçš„å®¹å™¨æ€§èƒ½
- **å¯æ‰©å±•æ€§**: è‰¯å¥½çš„å¯æ‰©å±•æ€§
- **é€‚ç”¨åœºæ™¯**: äº‘åŸç”Ÿåº”ç”¨ã€å®¹å™¨åŒ–åº”ç”¨ã€Kubernetes éƒ¨ç½²

### å…³ç³»è¿æ¥

**ç»„åˆå…³ç³»**:

- å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ --[covers]--> å®¹å™¨æŠ€æœ¯å®Œæ•´å†…å®¹
- äº‘åŸç”Ÿåº”ç”¨ --[uses]--> å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ

**ä¾èµ–å…³ç³»**:

- å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ --[depends-on]--> WASM åŸºç¡€
- å®¹å™¨åº”ç”¨ --[depends-on]--> å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ

### æ€ç»´å¯¼å›¾

```text
å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ
â”‚
â”œâ”€â”€ Docker é›†æˆ
â”‚   â”œâ”€â”€ Docker Desktop
â”‚   â””â”€â”€ Docker CLI
â”œâ”€â”€ Kubernetes æ·±åº¦é›†æˆ
â”‚   â”œâ”€â”€ RuntimeClass
â”‚   â””â”€â”€ CRI æ’ä»¶
â”œâ”€â”€ containerd é›†æˆ
â”‚   â””â”€â”€ containerd shim
â”œâ”€â”€ å®¹å™¨ç¼–æ’æœ€ä½³å®è·µ
â”‚   â”œâ”€â”€ èµ„æºé…é¢è®¾ç½®
â”‚   â””â”€â”€ é…ç½®ç®¡ç†
â”œâ”€â”€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
â”‚   â””â”€â”€ æ»šåŠ¨æ›´æ–°ç­–ç•¥
â”œâ”€â”€ ç›‘æ§ä¸å¯è§‚æµ‹æ€§
â”‚   â”œâ”€â”€ Prometheus
â”‚   â””â”€â”€ Grafana
â””â”€â”€ å®‰å…¨ä¸éš”ç¦»
    â””â”€â”€ Pod Security Standards
```

### å¤šç»´æ¦‚å¿µå¯¹æ¯”çŸ©é˜µ

| å®¹å™¨æŠ€æœ¯         | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯   | Rust 1.92.0 |
| :--- | :--- | :--- | :--- | :--- |
| **Docker**       | ä¸­   | ä½     | å®¹å™¨åŒ–     | âœ…          |
| **Kubernetes**   | ä¸­   | é«˜     | å®¹å™¨ç¼–æ’   | âœ…          |
| **containerd**   | é«˜   | ä¸­     | å®¹å™¨è¿è¡Œæ—¶ | âœ…          |
| **RuntimeClass** | ä¸­   | ä¸­     | è¿è¡Œæ—¶é€‰æ‹© | âœ…          |
| **CRI æ’ä»¶**     | é«˜   | é«˜     | å®¹å™¨æ¥å£   | âœ…          |

### å†³ç­–æ ‘å›¾

```text
é€‰æ‹©å®¹å™¨æŠ€æœ¯
â”‚
â”œâ”€â”€ éœ€è¦ä»€ä¹ˆèƒ½åŠ›ï¼Ÿ
â”‚   â”œâ”€â”€ å®¹å™¨åŒ– â†’ Docker
â”‚   â”œâ”€â”€ å®¹å™¨ç¼–æ’ â†’ Kubernetes
â”‚   â”œâ”€â”€ å®¹å™¨è¿è¡Œæ—¶ â†’ containerd
â”‚   â”œâ”€â”€ è¿è¡Œæ—¶é€‰æ‹© â†’ RuntimeClass
â”‚   â””â”€â”€ å®¹å™¨æ¥å£ â†’ CRI æ’ä»¶
```

---

## ğŸ¯ æ¦‚è¿°

WebAssembly å®¹å™¨åŒ–æ˜¯ 2025 å¹´äº‘åŸç”Ÿé¢†åŸŸçš„é‡è¦è¶‹åŠ¿ã€‚ç›¸æ¯”ä¼ ç»Ÿ Linux å®¹å™¨ï¼š

| ç‰¹æ€§         | Linux å®¹å™¨       | Wasm å®¹å™¨ (WasmEdge) | ä¼˜åŠ¿              |
| :--- | :--- | :--- | :--- |
| **å¯åŠ¨æ—¶é—´** | 100-1000ms       | 1-10ms               | **100å€æå‡** âœ¨  |
| **å†…å­˜å ç”¨** | 100MB-1GB        | 5-50MB               | **20å€å‡å°‘** âœ¨   |
| **é•œåƒå¤§å°** | 50MB-500MB       | 1-10MB               | **50å€ç¼©å°** âœ¨   |
| **å®‰å…¨æ€§**   | Namespace/cgroup | Wasm æ²™ç®±            | **æ›´å¼ºéš”ç¦»** âœ¨   |
| **å¯ç§»æ¤æ€§** | ä¾èµ– OS          | å®Œå…¨è·¨å¹³å°           | **çœŸæ­£å¯ç§»æ¤** âœ¨ |
| **æ€§èƒ½**     | åŸç”Ÿ             | 95-100% åŸç”Ÿ         | **æ¥è¿‘åŸç”Ÿ** âœ¨   |

---

## ğŸ³ Docker é›†æˆ

### Docker Desktop é›†æˆ

**æ”¯æŒå¹³å°**: macOS (Intel/Apple Silicon), Windows (WSL2), Linux

#### 1. å¯ç”¨ WasmEdge æ”¯æŒ

**Docker Desktop è®¾ç½®**:

```bash
# æ£€æŸ¥ Docker Desktop ç‰ˆæœ¬ (éœ€è¦ 24.0+)
docker version

# åœ¨ Docker Desktop è®¾ç½®ä¸­å¯ç”¨ containerd å’Œ Wasm
# Settings â†’ Features in Development â†’
#   âœ… Use containerd for pulling and storing images
#   âœ… Enable Wasm
```

**æˆ–é€šè¿‡å‘½ä»¤è¡Œé…ç½®** (`~/.docker/daemon.json`):

```json
{
  "features": {
    "containerd-snapshotter": true
  },
  "runtimes": {
    "wasmedge": {
      "path": "/usr/local/bin/containerd-shim-wasmedge-v1"
    }
  }
}
```

#### 2. æ„å»º Wasm å®¹å™¨é•œåƒ

**é¡¹ç›®ç»“æ„**:

```text
wasm-app/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main.rs
â””â”€â”€ Dockerfile
```

**Dockerfile**:

```dockerfile
# å¤šé˜¶æ®µæ„å»º - Stage 1: æ„å»º Wasm
FROM rust:1.90-slim AS builder

# å®‰è£… wasm32-wasi ç›®æ ‡
RUN rustup target add wasm32-wasi

WORKDIR /app
COPY . .

# ç¼–è¯‘ä¸º wasm32-wasi
RUN cargo build --target wasm32-wasi --release

# Stage 2: è¿è¡Œæ—¶é•œåƒ
FROM scratch

# ä» builder å¤åˆ¶ wasm æ–‡ä»¶
COPY --from=builder /app/target/wasm32-wasi/release/app.wasm /app.wasm

# æŒ‡å®š wasm è¿è¡Œæ—¶
LABEL "module.wasm.image/variant" = "compat-smart"

# å…¥å£ç‚¹
ENTRYPOINT [ "/app.wasm" ]
```

**æ„å»ºå’Œè¿è¡Œ**:

```bash
# æ„å»ºé•œåƒ
docker build --platform wasi/wasm -t my-wasm-app:latest .

# è¿è¡Œå®¹å™¨ï¼ˆä½¿ç”¨ WasmEdgeï¼‰
docker run --rm \
  --runtime=io.containerd.wasmedge.v1 \
  --platform=wasi/wasm \
  my-wasm-app:latest

# æŸ¥çœ‹å®¹å™¨ä¿¡æ¯
docker inspect my-wasm-app | grep -A 5 "Runtime"
```

### Docker CLI ä¸ WasmEdge

#### è¿è¡Œé€‰é¡¹è¯¦è§£

```bash
# åŸºæœ¬è¿è¡Œ
docker run --runtime=io.containerd.wasmedge.v1 \
  --platform=wasi/wasm \
  my-app:latest

# æŒ‚è½½å·ï¼ˆè®¿é—®ä¸»æœºæ–‡ä»¶ï¼‰
docker run --runtime=io.containerd.wasmedge.v1 \
  --platform=wasi/wasm \
  -v $(pwd)/data:/data:ro \
  my-app:latest /data/input.txt

# ç«¯å£æ˜ å°„ï¼ˆHTTP æœåŠ¡ï¼‰
docker run --runtime=io.containerd.wasmedge.v1 \
  --platform=wasi/wasm \
  -p 8080:8080 \
  my-http-server:latest

# ç¯å¢ƒå˜é‡
docker run --runtime=io.containerd.wasmedge.v1 \
  --platform=wasi/wasm \
  -e LOG_LEVEL=debug \
  -e DATABASE_URL=postgres://... \
  my-app:latest

# èµ„æºé™åˆ¶
docker run --runtime=io.containerd.wasmedge.v1 \
  --platform=wasi/wasm \
  --memory=64m \
  --cpus=0.5 \
  my-app:latest
```

### å¤šæ¶æ„é•œåƒæ„å»º

**ä½¿ç”¨ Docker Buildx æ„å»ºå¤šå¹³å°é•œåƒ**:

```bash
# åˆ›å»º buildx builder
docker buildx create --name wasm-builder --use

# æ„å»ºå¤šæ¶æ„é•œåƒ
docker buildx build \
  --platform linux/amd64,linux/arm64,wasi/wasm \
  -t my-registry/my-app:latest \
  --push \
  .

# æŸ¥çœ‹é•œåƒæ¸…å•
docker buildx imagetools inspect my-registry/my-app:latest
```

**Dockerfile å¤šå¹³å°ä¼˜åŒ–**:

```dockerfile
# ä½¿ç”¨æ„å»ºå‚æ•°æ”¯æŒå¤šå¹³å°
ARG TARGETPLATFORM
ARG BUILDPLATFORM

FROM --platform=$BUILDPLATFORM rust:1.90-slim AS builder

# æ ¹æ®ç›®æ ‡å¹³å°é€‰æ‹©ç¼–è¯‘ç›®æ ‡
RUN case "$TARGETPLATFORM" in \
      "linux/amd64") RUST_TARGET=x86_64-unknown-linux-musl ;; \
      "linux/arm64") RUST_TARGET=aarch64-unknown-linux-musl ;; \
      "wasi/wasm") RUST_TARGET=wasm32-wasi ;; \
      *) echo "Unsupported platform: $TARGETPLATFORM" && exit 1 ;; \
    esac && \
    rustup target add $RUST_TARGET && \
    echo "RUST_TARGET=$RUST_TARGET" > /tmp/target

WORKDIR /app
COPY . .

RUN . /tmp/target && \
    cargo build --target $RUST_TARGET --release

# è¿è¡Œæ—¶é˜¶æ®µ
FROM scratch
COPY --from=builder /app/target/*/release/app* /app
ENTRYPOINT ["/app"]
```

---

## â˜¸ï¸ Kubernetes æ·±åº¦é›†æˆ

### RuntimeClass é…ç½®

**ä¸ºä»€ä¹ˆä½¿ç”¨ RuntimeClassï¼Ÿ**

- åŒä¸€é›†ç¾¤æ”¯æŒå¤šç§è¿è¡Œæ—¶ï¼ˆLinux å®¹å™¨ã€Wasm å®¹å™¨ï¼‰
- Pod çº§åˆ«çš„è¿è¡Œæ—¶é€‰æ‹©
- é€æ˜çš„èµ„æºè°ƒåº¦

#### 1. å®‰è£… containerd-shim-wasmedge

**åœ¨æ¯ä¸ª Kubernetes èŠ‚ç‚¹ä¸Šå®‰è£…**:

```bash
# ä¸‹è½½ containerd-shim-wasmedge
curl -LO https://github.com/containerd/runwasi/releases/download/containerd-shim-wasmedge/v0.3.0/containerd-shim-wasmedge-v1-linux-x86_64.tar.gz

# è§£å‹å¹¶å®‰è£…
sudo tar -C /usr/local/bin -xzf containerd-shim-wasmedge-v1-linux-x86_64.tar.gz

# éªŒè¯å®‰è£…
containerd-shim-wasmedge-v1 --version
```

#### 2. é…ç½® containerd

**ç¼–è¾‘ `/etc/containerd/config.toml`**:

```toml
version = 2

[plugins."io.containerd.grpc.v1.cri"]
  [plugins."io.containerd.grpc.v1.cri".containerd]
    default_runtime_name = "runc"

    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
      # æ ‡å‡† runc è¿è¡Œæ—¶
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
        runtime_type = "io.containerd.runc.v2"

      # WasmEdge è¿è¡Œæ—¶
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.wasmedge]
        runtime_type = "io.containerd.wasmedge.v1"

        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.wasmedge.options]
          BinaryName = "/usr/local/bin/containerd-shim-wasmedge-v1"
```

**é‡å¯ containerd**:

```bash
sudo systemctl restart containerd
sudo systemctl status containerd
```

#### 3. åˆ›å»º RuntimeClass

**runtimeclass.yaml**:

```yaml
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: wasmedge
handler: wasmedge # å¯¹åº” containerd é…ç½®ä¸­çš„è¿è¡Œæ—¶åç§°

---
# å¯é€‰ï¼šä¸ºç‰¹å®šåœºæ™¯åˆ›å»ºå¤šä¸ª RuntimeClass
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: wasmedge-ai # AI æ¨ç†ä¸“ç”¨
handler: wasmedge
scheduling:
  nodeSelector:
    wasm.capable: "true"
    gpu.available: "true"
  tolerations:
    - key: "workload"
      operator: "Equal"
      value: "ai-inference"
      effect: "NoSchedule"
```

**åº”ç”¨é…ç½®**:

```bash
kubectl apply -f runtimeclass.yaml

# éªŒè¯
kubectl get runtimeclass
```

### CRI æ’ä»¶é›†æˆ

**containerd ä¸ kubelet çš„é›†æˆæ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           kubelet                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ CRI gRPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        containerd (CRI Plugin)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Runtime Manager                â”‚  â”‚
â”‚  â”‚  â”œâ”€ runc (Linux containers)     â”‚  â”‚
â”‚  â”‚  â””â”€ wasmedge (Wasm containers)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ containerd-   â”‚  â”‚ containerd-shim- â”‚
â”‚ shim-runc-v2  â”‚  â”‚ wasmedge-v1      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                â”‚
        â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Linux Process â”‚  â”‚ WasmEdge Runtime â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Workload éƒ¨ç½²ç­–ç•¥

#### Deployment ç¤ºä¾‹

**wasm-deployment.yaml**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wasm-http-server
  labels:
    app: wasm-server
    runtime: wasmedge
spec:
  replicas: 5
  selector:
    matchLabels:
      app: wasm-server
  template:
    metadata:
      labels:
        app: wasm-server
        runtime: wasmedge
      annotations:
        # å¯é€‰ï¼šæ³¨å…¥æ€§èƒ½æŒ‡æ ‡
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
    spec:
      # æŒ‡å®šä½¿ç”¨ WasmEdge è¿è¡Œæ—¶
      runtimeClassName: wasmedge

      containers:
        - name: wasm-server
          image: my-registry/wasm-http-server:latest

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP

          # Wasm å®¹å™¨çš„èµ„æºé™åˆ¶é€šå¸¸å¾ˆå°
          resources:
            requests:
              memory: "16Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "200m"

          # å¥åº·æ£€æŸ¥
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 1
            periodSeconds: 10
            timeoutSeconds: 2

          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 1
            periodSeconds: 5

          # ç¯å¢ƒå˜é‡
          env:
            - name: LOG_LEVEL
              value: "info"
            - name: PORT
              value: "8080"

          # æŒ‚è½½é…ç½®
          volumeMounts:
            - name: config
              mountPath: /etc/config
              readOnly: true

      volumes:
        - name: config
          configMap:
            name: wasm-server-config

      # èŠ‚ç‚¹é€‰æ‹©ï¼ˆå¯é€‰ï¼‰
      nodeSelector:
        wasm.capable: "true"

      # å®¹å¿åº¦ï¼ˆå¯é€‰ï¼‰
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "wasm"
          effect: "NoSchedule"
```

#### Service é…ç½®

**wasm-service.yaml**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: wasm-http-server
  labels:
    app: wasm-server
spec:
  type: ClusterIP
  selector:
    app: wasm-server
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP

  # ä¼šè¯äº²å’Œæ€§ï¼ˆå¯é€‰ï¼‰
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600

---
# Headless Serviceï¼ˆç”¨äº StatefulSetï¼‰
apiVersion: v1
kind: Service
metadata:
  name: wasm-server-headless
spec:
  clusterIP: None
  selector:
    app: wasm-server
  ports:
    - port: 8080
```

#### HorizontalPodAutoscaler (HPA)

**wasm-hpa.yaml**:

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: wasm-server-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: wasm-http-server

  minReplicas: 2
  maxReplicas: 50 # Wasm å®¹å™¨è½»é‡ï¼Œå¯ä»¥å¤§è§„æ¨¡æ‰©å±•

  metrics:
    # CPU åˆ©ç”¨ç‡
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

    # å†…å­˜åˆ©ç”¨ç‡
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

    # è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆéœ€è¦ Prometheus Adapterï¼‰
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "1000"

  # æ‰©ç¼©å®¹è¡Œä¸º
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 15
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 10
          periodSeconds: 15
      selectPolicy: Max
```

#### Ingress é…ç½®

**wasm-ingress.yaml**:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: wasm-server-ingress
  annotations:
    # NGINX Ingress Controller é…ç½®
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"

    # è¿æ¥è¶…æ—¶ï¼ˆWasm å“åº”å¿«ï¼‰
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "5"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "10"
spec:
  ingressClassName: nginx
  rules:
    - host: wasm-app.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: wasm-http-server
                port:
                  number: 80

  tls:
    - hosts:
        - wasm-app.example.com
      secretName: wasm-app-tls
```

---

## ğŸ”§ containerd é›†æˆ

### containerd shim æœºåˆ¶

**shim çš„ä½œç”¨**:

1. ä½œä¸º containerd å’Œå®¹å™¨è¿è¡Œæ—¶ä¹‹é—´çš„æ¡¥æ¢
2. ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼ˆå¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ï¼‰
3. å¤„ç† stdio æµ
4. æŠ¥å‘Šå®¹å™¨çŠ¶æ€

**WasmEdge shim æ¶æ„**:

```text
containerd
    â†“ (create container)
containerd-shim-wasmedge-v1
    â†“ (load and execute)
WasmEdge Runtime
    â†“ (run)
WebAssembly Module
```

### runwasi é¡¹ç›®

**runwasi** æ˜¯ä¸€ä¸ªé€šç”¨çš„ WASM è¿è¡Œæ—¶å®¹å™¨åŒ–æ¡†æ¶ï¼Œæ”¯æŒå¤šç§ WASM è¿è¡Œæ—¶ã€‚

**æ”¯æŒçš„è¿è¡Œæ—¶**:

- âœ… WasmEdge
- âœ… wasmtime
- âœ… wasmer

**ä»æºç æ„å»º shim**:

```bash
# å…‹éš† runwasi ä»“åº“
git clone https://github.com/containerd/runwasi.git
cd runwasi

# æ„å»º WasmEdge shim
cargo build --release -p containerd-shim-wasmedge

# å®‰è£…
sudo install -D -m 755 target/release/containerd-shim-wasmedge-v1 \
  /usr/local/bin/containerd-shim-wasmedge-v1

# éªŒè¯
containerd-shim-wasmedge-v1 --version
```

**è‡ªå®šä¹‰ shim é…ç½®**:

```rust
// ç¤ºä¾‹ï¼šè‡ªå®šä¹‰ WasmEdge é…ç½®
use containerd_shim_wasm::sandbox::ShimCli;

fn main() {
    // è‡ªå®šä¹‰ WasmEdge å¯åŠ¨å‚æ•°
    let options = wasmedge::WasmEdgeOptions {
        enable_wasi: true,
        enable_nn: true,
        enable_crypto: true,
        max_memory_pages: 256, // 16MB
    };

    ShimCli::run("containerd-shim-wasmedge-v1", options);
}
```

---

## ğŸ“ å®¹å™¨ç¼–æ’æœ€ä½³å®è·µ

### 1. èµ„æºé…é¢è®¾ç½®

**ä¸º Wasm workload åˆ›å»ºä¸“ç”¨ Namespace å’Œ ResourceQuota**:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: wasm-workloads
  labels:
    runtime: wasmedge

---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: wasm-quota
  namespace: wasm-workloads
spec:
  hard:
    # Wasm å®¹å™¨èµ„æºå ç”¨å°ï¼Œå¯ä»¥è¿è¡Œæ›´å¤šå®ä¾‹
    requests.cpu: "10"
    requests.memory: 2Gi
    limits.cpu: "20"
    limits.memory: 4Gi
    pods: "200" # å…è®¸å¤§é‡ Pod
```

### 2. èŠ‚ç‚¹äº²å’Œæ€§ä¸æ±¡ç‚¹

**æ ‡è®°æ”¯æŒ Wasm çš„èŠ‚ç‚¹**:

```bash
# æ·»åŠ æ ‡ç­¾
kubectl label nodes node-1 node-2 node-3 \
  wasm.capable=true \
  wasm.runtime=wasmedge

# æ·»åŠ æ±¡ç‚¹ï¼ˆå¯é€‰ï¼Œç¡®ä¿åªæœ‰ Wasm workload è°ƒåº¦åˆ°è¿™äº›èŠ‚ç‚¹ï¼‰
kubectl taint nodes node-1 node-2 node-3 \
  workload=wasm:NoSchedule
```

**Pod é…ç½®ç¤ºä¾‹**:

```yaml
spec:
  # äº²å’Œæ€§
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: wasm.capable
                operator: In
                values:
                  - "true"

    # Pod åäº²å’Œæ€§ï¼ˆåˆ†æ•£éƒ¨ç½²ï¼‰
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - wasm-server
            topologyKey: kubernetes.io/hostname

  # å®¹å¿åº¦
  tolerations:
    - key: "workload"
      operator: "Equal"
      value: "wasm"
      effect: "NoSchedule"
```

### 3. é…ç½®ç®¡ç†

**ConfigMap ç¤ºä¾‹**:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: wasm-server-config
  namespace: wasm-workloads
data:
  config.toml: |
    [server]
    host = "0.0.0.0"
    port = 8080
    workers = 4

    [logging]
    level = "info"
    format = "json"

  app.json: |
    {
      "features": {
        "ai_enabled": true,
        "cache_enabled": true
      }
    }
```

### 4. ç§˜å¯†ç®¡ç†

**Secret ç¤ºä¾‹**:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: wasm-app-secrets
  namespace: wasm-workloads
type: Opaque
stringData:
  DATABASE_URL: "postgres://user:pass@db:5432/mydb"
  API_KEY: "your-secret-api-key"

---
# åœ¨ Pod ä¸­ä½¿ç”¨
spec:
  containers:
    - name: wasm-app
      envFrom:
        - secretRef:
            name: wasm-app-secrets
```

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### å®Œæ•´éƒ¨ç½²æµç¨‹

**1. å‡†å¤‡é›†ç¾¤**:

```bash
# æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ”¯æŒ Wasm
kubectl get nodes -o wide

# å®‰è£… containerd-shim-wasmedge
# (åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ DaemonSet è‡ªåŠ¨åŒ–)
```

**2. éƒ¨ç½² DaemonSet å®‰è£… shim**:

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: wasmedge-installer
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: wasmedge-installer
  template:
    metadata:
      labels:
        name: wasmedge-installer
    spec:
      hostPID: true
      hostNetwork: true
      initContainers:
        - name: install-shim
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache curl tar
              cd /host/usr/local/bin
              curl -LO https://github.com/containerd/runwasi/releases/download/containerd-shim-wasmedge/v0.3.0/containerd-shim-wasmedge-v1-linux-x86_64.tar.gz
              tar -xzf containerd-shim-wasmedge-v1-linux-x86_64.tar.gz
              chmod +x containerd-shim-wasmedge-v1
              echo "WasmEdge shim installed successfully"
          volumeMounts:
            - name: host-bin
              mountPath: /host/usr/local/bin
          securityContext:
            privileged: true

      containers:
        - name: pause
          image: gcr.io/google_containers/pause:3.9

      volumes:
        - name: host-bin
          hostPath:
            path: /usr/local/bin
            type: Directory
```

**3. åº”ç”¨å®Œæ•´é…ç½®**:

```bash
# åˆ›å»º namespace
kubectl create namespace wasm-prod

# åº”ç”¨ RuntimeClass
kubectl apply -f runtimeclass.yaml

# åº”ç”¨åº”ç”¨é…ç½®
kubectl apply -f wasm-deployment.yaml -n wasm-prod
kubectl apply -f wasm-service.yaml -n wasm-prod
kubectl apply -f wasm-hpa.yaml -n wasm-prod
kubectl apply -f wasm-ingress.yaml -n wasm-prod

# æ£€æŸ¥çŠ¶æ€
kubectl get all -n wasm-prod
kubectl get runtimeclass
```

### æ»šåŠ¨æ›´æ–°ç­–ç•¥

**wasm-deployment.yaml** (æ›´æ–°ç­–ç•¥éƒ¨åˆ†):

```yaml
spec:
  replicas: 10

  # æ»šåŠ¨æ›´æ–°ç­–ç•¥
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 5 # Wasm å¯åŠ¨å¿«ï¼Œå¯ä»¥æ›´æ¿€è¿›
      maxUnavailable: 2

  # ä¿®è®¢å†å²é™åˆ¶
  revisionHistoryLimit: 5
```

**æ‰§è¡Œæ»šåŠ¨æ›´æ–°**:

```bash
# æ›´æ–°é•œåƒ
kubectl set image deployment/wasm-http-server \
  wasm-server=my-registry/wasm-http-server:v2.0 \
  -n wasm-prod

# ç›‘æ§æ›´æ–°è¿›åº¦
kubectl rollout status deployment/wasm-http-server -n wasm-prod

# å¦‚æœå‡ºç°é—®é¢˜ï¼Œå›æ»š
kubectl rollout undo deployment/wasm-http-server -n wasm-prod
```

---

## ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### Prometheus é›†æˆ

**ServiceMonitor é…ç½®**:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: wasm-server-monitor
  namespace: wasm-prod
  labels:
    app: wasm-server
spec:
  selector:
    matchLabels:
      app: wasm-server
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
```

**åœ¨ Wasm åº”ç”¨ä¸­æš´éœ² Prometheus æŒ‡æ ‡** (Rust ç¤ºä¾‹):

```rust
// Cargo.toml æ·»åŠ ä¾èµ–
// prometheus = "0.13"
// lazy_static = "1.4"

use prometheus::{Encoder, TextEncoder, Counter, Histogram, Registry};
use lazy_static::lazy_static;

lazy_static! {
    static ref REGISTRY: Registry = Registry::new();

    static ref HTTP_REQUESTS: Counter = Counter::new(
        "http_requests_total",
        "Total HTTP requests"
    ).unwrap();

    static ref HTTP_DURATION: Histogram = Histogram::new(
        "http_request_duration_seconds",
        "HTTP request duration"
    ).unwrap();
}

// åˆå§‹åŒ–æŒ‡æ ‡
pub fn init_metrics() {
    REGISTRY.register(Box::new(HTTP_REQUESTS.clone())).unwrap();
    REGISTRY.register(Box::new(HTTP_DURATION.clone())).unwrap();
}

// æš´éœ² /metrics ç«¯ç‚¹
pub fn metrics_handler() -> String {
    let encoder = TextEncoder::new();
    let metric_families = REGISTRY.gather();
    let mut buffer = vec![];
    encoder.encode(&metric_families, &mut buffer).unwrap();
    String::from_utf8(buffer).unwrap()
}
```

### Grafana ä»ªè¡¨æ¿

**ç¤ºä¾‹æŒ‡æ ‡æŸ¥è¯¢**:

```promql
# Wasm å®¹å™¨æ•°é‡
count(kube_pod_info{runtime="wasmedge"})

# å¹³å‡å¯åŠ¨æ—¶é—´
histogram_quantile(0.99,
  rate(container_start_duration_seconds_bucket{runtime="wasmedge"}[5m])
)

# å†…å­˜ä½¿ç”¨ç‡
sum(container_memory_usage_bytes{runtime="wasmedge"}) /
sum(container_spec_memory_limit_bytes{runtime="wasmedge"}) * 100

# æ¯ç§’è¯·æ±‚æ•°
rate(http_requests_total{app="wasm-server"}[1m])

# P99 å»¶è¿Ÿ
histogram_quantile(0.99,
  rate(http_request_duration_seconds_bucket{app="wasm-server"}[5m])
)
```

### æ—¥å¿—èšåˆ

**Fluent Bit é…ç½®** (é‡‡é›† Wasm å®¹å™¨æ—¥å¿—):

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: logging
data:
  fluent-bit.conf: |
    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*wasm*.log
        Parser            docker
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On
        Refresh_Interval  10

    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Labels              On
        Annotations         On

    [FILTER]
        Name                grep
        Match               kube.*
        Regex               kubernetes_labels_runtime wasmedge

    [OUTPUT]
        Name                elasticsearch
        Match               kube.*
        Host                elasticsearch.logging.svc
        Port                9200
        Index               wasm-logs
        Type                _doc
```

---

## ğŸ”’ å®‰å…¨ä¸éš”ç¦»

### 1. Pod Security Standards

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: wasm-prod
  labels:
    # åº”ç”¨ restricted å®‰å…¨æ ‡å‡†
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

### 2. NetworkPolicy

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: wasm-server-netpol
  namespace: wasm-prod
spec:
  podSelector:
    matchLabels:
      app: wasm-server
  policyTypes:
    - Ingress
    - Egress

  # å…¥ç«™è§„åˆ™
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - podSelector:
            matchLabels:
              app: monitoring
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 9090 # Prometheus metrics

  # å‡ºç«™è§„åˆ™
  egress:
    # å…è®¸è®¿é—® DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

    # å…è®¸è®¿é—®å¤–éƒ¨ API
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 443
```

### 3. SecurityContext

```yaml
spec:
  securityContext:
    # Pod çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault

  containers:
    - name: wasm-server
      securityContext:
        # å®¹å™¨çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
```

---

## âš¡ æ€§èƒ½è°ƒä¼˜

### 1. èµ„æºè¯·æ±‚å’Œé™åˆ¶ä¼˜åŒ–

**é’ˆå¯¹ä¸åŒè´Ÿè½½çš„å»ºè®®**:

```yaml
# è½»é‡çº§ API æœåŠ¡
resources:
  requests:
    memory: "8Mi"
    cpu: "25m"
  limits:
    memory: "32Mi"
    cpu: "100m"

---
# æ•°æ®å¤„ç†æœåŠ¡
resources:
  requests:
    memory: "32Mi"
    cpu: "100m"
  limits:
    memory: "128Mi"
    cpu: "500m"

---
# AI æ¨ç†æœåŠ¡
resources:
  requests:
    memory: "128Mi"
    cpu: "500m"
  limits:
    memory: "512Mi"
    cpu: "2000m"
```

### 2. äº²å’Œæ€§è°ƒä¼˜

```yaml
spec:
  # æ‹“æ‰‘åˆ†å¸ƒçº¦æŸï¼ˆç¡®ä¿å‡åŒ€åˆ†å¸ƒï¼‰
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app: wasm-server
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app: wasm-server
```

### 3. HPA è°ƒä¼˜

```yaml
spec:
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60 # Wasm æ•ˆç‡é«˜ï¼Œé™ä½é˜ˆå€¼

  # è¡Œä¸ºè°ƒä¼˜
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 10 # å¿«é€Ÿæ‰©å®¹
      policies:
        - type: Percent
          value: 200
          periodSeconds: 15
    scaleDown:
      stabilizationWindowSeconds: 120 # ä¿å®ˆç¼©å®¹
```

---

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: å¾®æœåŠ¡ API Gateway (Wasm)

**æ¶æ„**:

```text
Internet â†’ Ingress â†’ Wasm API Gateway â†’ Backend Services
                          â†“
                    (AI æ¨ç†ã€é‰´æƒã€é™æµ)
```

**å®Œæ•´éƒ¨ç½²**:

```yaml
# 1. Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wasm-api-gateway
spec:
  replicas: 10
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      runtimeClassName: wasmedge
      containers:
        - name: gateway
          image: my-registry/wasm-api-gateway:latest
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: "16Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "200m"
          env:
            - name: BACKEND_URLS
              value: "http://service-a:8080,http://service-b:8080"
            - name: RATE_LIMIT
              value: "1000"

---
# 2. Service
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
spec:
  selector:
    app: api-gateway
  ports:
    - port: 80
      targetPort: 8080

---
# 3. HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-gateway-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: wasm-api-gateway
  minReplicas: 5
  maxReplicas: 100
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
```

### æ¡ˆä¾‹ 2: è¾¹ç¼˜ AI æ¨ç†æœåŠ¡

**åœºæ™¯**: åœ¨è¾¹ç¼˜èŠ‚ç‚¹è¿è¡Œ AI æ¨¡å‹æ¨ç†

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: edge-ai-inference
spec:
  selector:
    matchLabels:
      app: edge-ai
  template:
    metadata:
      labels:
        app: edge-ai
    spec:
      runtimeClassName: wasmedge
      nodeSelector:
        node-role.kubernetes.io/edge: "true"

      containers:
        - name: ai-inference
          image: my-registry/wasm-ai-inference:latest
          command:
            - /ai-inference.wasm
          args:
            - --model=/models/model.tflite

          resources:
            requests:
              memory: "128Mi"
              cpu: "500m"
            limits:
              memory: "512Mi"
              cpu: "2000m"

          volumeMounts:
            - name: models
              mountPath: /models
              readOnly: true

          env:
            - name: WASM_ENABLE_NN
              value: "true"

      volumes:
        - name: models
          hostPath:
            path: /opt/ai-models
            type: Directory
```

### æ¡ˆä¾‹ 3: Serverless å‡½æ•°å¹³å°

**ä½¿ç”¨ Knative + WasmEdge æ„å»º Serverless**:

```yaml
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: wasm-function
spec:
  template:
    metadata:
      annotations:
        # æŒ‡å®šè¿è¡Œæ—¶
        run.googleapis.com/execution-environment: wasm
    spec:
      runtimeClassName: wasmedge

      containers:
        - image: my-registry/wasm-function:latest
          ports:
            - containerPort: 8080

          # Wasm å†·å¯åŠ¨æå¿«ï¼Œå¯ä»¥è®¾ç½®æ›´æ¿€è¿›çš„ç¼©å®¹
          resources:
            requests:
              memory: "8Mi"
              cpu: "25m"
            limits:
              memory: "32Mi"
              cpu: "100m"

      # ç¼©å®¹åˆ° 0
      containerConcurrency: 100
      timeoutSeconds: 60

  traffic:
    - percent: 100
      latestRevision: true
```

---

## ğŸ“š æ€»ç»“

### å…³é”®ä¼˜åŠ¿

| æ–¹é¢         | ä¼˜åŠ¿            | é‡åŒ–æŒ‡æ ‡               |
| :--- | :--- | :--- |
| **å¯åŠ¨é€Ÿåº¦** | å†·å¯åŠ¨æå¿«      | 1-10ms (vs 100-1000ms) |
| **èµ„æºå ç”¨** | å†…å­˜/CPU å ç”¨å° | 5-50MB (vs 100MB-1GB)  |
| **å¯†åº¦**     | æ›´é«˜çš„å®¹å™¨å¯†åº¦  | 10-50å€                |
| **å®‰å…¨æ€§**   | Wasm æ²™ç®±éš”ç¦»   | æ›´å¼ºçš„éš”ç¦»ä¿è¯         |
| **å¯ç§»æ¤æ€§** | çœŸæ­£çš„è·¨å¹³å°    | ä¸€æ¬¡æ„å»ºï¼Œåˆ°å¤„è¿è¡Œ     |

### æœ€ä½³å®è·µæ¸…å•

- âœ… ä½¿ç”¨ RuntimeClass ç®¡ç†å¤šè¿è¡Œæ—¶
- âœ… ä¸º Wasm å·¥ä½œè´Ÿè½½åˆ›å»ºä¸“ç”¨èŠ‚ç‚¹æ± 
- âœ… è®¾ç½®åˆç†çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶
- âœ… åˆ©ç”¨ HPA å®ç°è‡ªåŠ¨æ‰©ç¼©å®¹
- âœ… é…ç½®ç›‘æ§å’Œæ—¥å¿—èšåˆ
- âœ… åº”ç”¨ç½‘ç»œç­–ç•¥å’Œå®‰å…¨ä¸Šä¸‹æ–‡
- âœ… ä½¿ç”¨æ‹“æ‰‘åˆ†å¸ƒçº¦æŸç¡®ä¿é«˜å¯ç”¨
- âœ… å®šæœŸæ›´æ–° WasmEdge è¿è¡Œæ—¶å’Œ shim

### å‚è€ƒèµ„æº

- [WasmEdge å®˜æ–¹æ–‡æ¡£](https://wasmedge.org/docs/)
- [containerd runwasi é¡¹ç›®](https://github.com/containerd/runwasi)
- [Kubernetes RuntimeClass æ–‡æ¡£](https://kubernetes.io/docs/concepts/containers/runtime-class/)
- [Docker + Wasm æŠ€æœ¯é¢„è§ˆ](https://www.docker.com/blog/docker-wasm-technical-preview/)
- [CNCF Wasm å·¥ä½œç»„](https://github.com/cncf/tag-runtime/blob/main/wasm/README.md)

---

**æ–‡æ¡£ç»´æŠ¤**: Documentation Team
**æœ€åæ›´æ–°**: 2025-12-11
**é€‚ç”¨ç‰ˆæœ¬**: WasmEdge 0.13+, Docker 24.0+, Kubernetes 1.28+
