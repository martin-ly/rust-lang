# ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µæŒ‡å—

> **æ–‡æ¡£ç±»å‹**: Tier 4 - é«˜çº§å±‚
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-30
> **æŠ€æœ¯æ ˆ**: Prometheus, Grafana, Loki, Jaeger
> **é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒç›‘æ§ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–

---

## ğŸ“‹ ç›®å½•

- [ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µæŒ‡å—](#ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µæŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“ çŸ¥è¯†ç»“æ„](#-çŸ¥è¯†ç»“æ„)
    - [æ¦‚å¿µå®šä¹‰](#æ¦‚å¿µå®šä¹‰)
    - [å±æ€§ç‰¹å¾](#å±æ€§ç‰¹å¾)
    - [å…³ç³»è¿æ¥](#å…³ç³»è¿æ¥)
    - [æ€ç»´å¯¼å›¾](#æ€ç»´å¯¼å›¾)
    - [å¤šç»´æ¦‚å¿µå¯¹æ¯”çŸ©é˜µ](#å¤šç»´æ¦‚å¿µå¯¹æ¯”çŸ©é˜µ)
    - [å†³ç­–æ ‘å›¾](#å†³ç­–æ ‘å›¾)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
    - [Wasm å¯è§‚æµ‹æ€§çš„ç‰¹ç‚¹](#wasm-å¯è§‚æµ‹æ€§çš„ç‰¹ç‚¹)
  - [ğŸ“Š å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±](#-å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±)
    - [1. Metrics (æŒ‡æ ‡)](#1-metrics-æŒ‡æ ‡)
    - [2. Logs (æ—¥å¿—)](#2-logs-æ—¥å¿—)
    - [3. Traces (è¿½è¸ª)](#3-traces-è¿½è¸ª)
  - [ğŸ“ˆ Prometheus ç›‘æ§](#-prometheus-ç›‘æ§)
    - [æ¶æ„](#æ¶æ„)
    - [é…ç½®æ–‡ä»¶](#é…ç½®æ–‡ä»¶)
    - [æš´éœ²æŒ‡æ ‡](#æš´éœ²æŒ‡æ ‡)
    - [å…³é”®æŒ‡æ ‡](#å…³é”®æŒ‡æ ‡)
      - [åº”ç”¨å±‚æŒ‡æ ‡](#åº”ç”¨å±‚æŒ‡æ ‡)
      - [èµ„æºæŒ‡æ ‡](#èµ„æºæŒ‡æ ‡)
      - [Kubernetes æŒ‡æ ‡](#kubernetes-æŒ‡æ ‡)
  - [ğŸ“Š Grafana å¯è§†åŒ–](#-grafana-å¯è§†åŒ–)
    - [ä»ªè¡¨æ¿é…ç½®](#ä»ªè¡¨æ¿é…ç½®)
    - [æ ¸å¿ƒé¢æ¿](#æ ¸å¿ƒé¢æ¿)
      - [1. Golden Signals ä»ªè¡¨æ¿](#1-golden-signals-ä»ªè¡¨æ¿)
      - [2. RED æ–¹æ³•ä»ªè¡¨æ¿](#2-red-æ–¹æ³•ä»ªè¡¨æ¿)
      - [3. USE æ–¹æ³•ä»ªè¡¨æ¿](#3-use-æ–¹æ³•ä»ªè¡¨æ¿)
    - [å‘Šè­¦è§„åˆ™](#å‘Šè­¦è§„åˆ™)
  - [ğŸ“ æ—¥å¿—èšåˆ (Loki)](#-æ—¥å¿—èšåˆ-loki)
    - [æ¶æ„](#æ¶æ„-1)
    - [Promtail é…ç½®](#promtail-é…ç½®)
    - [æ—¥å¿—æŸ¥è¯¢ (LogQL)](#æ—¥å¿—æŸ¥è¯¢-logql)
    - [ç»“æ„åŒ–æ—¥å¿—æœ€ä½³å®è·µ](#ç»“æ„åŒ–æ—¥å¿—æœ€ä½³å®è·µ)
  - [ğŸ” åˆ†å¸ƒå¼è¿½è¸ª (Jaeger)](#-åˆ†å¸ƒå¼è¿½è¸ª-jaeger)
    - [ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è¿½è¸ªï¼Ÿ](#ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è¿½è¸ª)
    - [OpenTelemetry é›†æˆ](#opentelemetry-é›†æˆ)
    - [Jaeger UI ä½¿ç”¨](#jaeger-ui-ä½¿ç”¨)
  - [ğŸš¨ å‘Šè­¦é…ç½®](#-å‘Šè­¦é…ç½®)
    - [Alertmanager é…ç½®](#alertmanager-é…ç½®)
    - [å‘Šè­¦æœ€ä½³å®è·µ](#å‘Šè­¦æœ€ä½³å®è·µ)
      - [1. å‘Šè­¦åˆ†çº§](#1-å‘Šè­¦åˆ†çº§)
      - [2. å‘Šè­¦å‘½åè§„èŒƒ](#2-å‘Šè­¦å‘½åè§„èŒƒ)
      - [3. é¿å…å‘Šè­¦ç–²åŠ³](#3-é¿å…å‘Šè­¦ç–²åŠ³)
  - [ğŸ“‹ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
    - [1. å››ä¸ªé»„é‡‘æŒ‡æ ‡ (Four Golden Signals)](#1-å››ä¸ªé»„é‡‘æŒ‡æ ‡-four-golden-signals)
    - [2. ç›‘æ§å³ä»£ç  (Monitoring as Code)](#2-ç›‘æ§å³ä»£ç -monitoring-as-code)
    - [3. å¯è§‚æµ‹æ€§æˆç†Ÿåº¦æ¨¡å‹](#3-å¯è§‚æµ‹æ€§æˆç†Ÿåº¦æ¨¡å‹)
    - [4. SLO/SLI/SLA](#4-sloslisla)
    - [5. æˆæœ¬ä¼˜åŒ–](#5-æˆæœ¬ä¼˜åŒ–)
  - [ğŸ¯ æ€»ç»“](#-æ€»ç»“)
    - [ç›‘æ§æ£€æŸ¥æ¸…å•](#ç›‘æ§æ£€æŸ¥æ¸…å•)
    - [å…³é”®æŒ‡æ ‡ç›®æ ‡](#å…³é”®æŒ‡æ ‡ç›®æ ‡)

---

## ğŸ“ çŸ¥è¯†ç»“æ„

### æ¦‚å¿µå®šä¹‰

**ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µ (Monitoring and Observability Practice)**:

- **å®šä¹‰**: Rust 1.92.0 ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µï¼ŒåŒ…æ‹¬å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±ï¼ˆMetricsã€Logsã€Tracesï¼‰ã€Prometheus ç›‘æ§ã€Grafana å¯è§†åŒ–ã€æ—¥å¿—èšåˆï¼ˆLokiï¼‰ã€åˆ†å¸ƒå¼è¿½è¸ªï¼ˆJaegerï¼‰ã€å‘Šè­¦é…ç½®ã€æœ€ä½³å®è·µç­‰
- **ç±»å‹**: é«˜çº§ä¸»é¢˜æ–‡æ¡£
- **èŒƒç•´**: WASMã€ç›‘æ§ã€å¯è§‚æµ‹æ€§
- **ç‰ˆæœ¬**: Rust 1.92.0+ / Edition 2024, Prometheus, Grafana, Loki, Jaeger
- **ç›¸å…³æ¦‚å¿µ**: ç›‘æ§ã€å¯è§‚æµ‹æ€§ã€Prometheusã€Grafanaã€Lokiã€Jaegerã€å‘Šè­¦

### å±æ€§ç‰¹å¾

**æ ¸å¿ƒå±æ€§**:

- **å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±**: Metricsï¼ˆæŒ‡æ ‡ï¼‰ã€Logsï¼ˆæ—¥å¿—ï¼‰ã€Tracesï¼ˆè¿½è¸ªï¼‰
- **Prometheus ç›‘æ§**: æ¶æ„ã€é…ç½®æ–‡ä»¶ã€æš´éœ²æŒ‡æ ‡ã€å…³é”®æŒ‡æ ‡ï¼ˆåº”ç”¨å±‚æŒ‡æ ‡ã€èµ„æºæŒ‡æ ‡ã€Kubernetes æŒ‡æ ‡ï¼‰
- **Grafana å¯è§†åŒ–**: ä»ªè¡¨æ¿é…ç½®ã€æ ¸å¿ƒé¢æ¿ï¼ˆGolden Signalsã€RED æ–¹æ³•ã€USE æ–¹æ³•ï¼‰ã€å‘Šè­¦è§„åˆ™
- **æ—¥å¿—èšåˆï¼ˆLokiï¼‰**: æ¶æ„ã€Promtail é…ç½®ã€æ—¥å¿—æŸ¥è¯¢ï¼ˆLogQLï¼‰ã€ç»“æ„åŒ–æ—¥å¿—æœ€ä½³å®è·µ
- **åˆ†å¸ƒå¼è¿½è¸ªï¼ˆJaegerï¼‰**: OpenTelemetry é›†æˆã€Jaeger UI ä½¿ç”¨
- **å‘Šè­¦é…ç½®**: Alertmanager é…ç½®ã€å‘Šè­¦æœ€ä½³å®è·µï¼ˆå‘Šè­¦åˆ†çº§ã€å‘Šè­¦å‘½åè§„èŒƒã€é¿å…å‘Šè­¦ç–²åŠ³ï¼‰

**Rust 1.92.0 æ–°ç‰¹æ€§**:

- **æ”¹è¿›çš„ç›‘æ§**: æ›´å¥½çš„ç›‘æ§æ”¯æŒ
- **å¢å¼ºçš„å¯è§‚æµ‹æ€§**: æ›´å¥½çš„å¯è§‚æµ‹æ€§æ”¯æŒ
- **ä¼˜åŒ–çš„æ€§èƒ½**: æ›´é«˜æ•ˆçš„ç›‘æ§æ€§èƒ½

**æ€§èƒ½ç‰¹å¾**:

- **å…¨é¢ç›‘æ§**: å…¨é¢çš„ç›‘æ§è¦†ç›–
- **å®æ—¶æ€§**: å®æ—¶ç›‘æ§èƒ½åŠ›
- **é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒç›‘æ§ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–

### å…³ç³»è¿æ¥

**ç»„åˆå…³ç³»**:

- ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µ --[covers]--> ç›‘æ§å®Œæ•´å†…å®¹
- ç”Ÿäº§ç¯å¢ƒ --[uses]--> ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µ

**ä¾èµ–å…³ç³»**:

- ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µ --[depends-on]--> WASM åŸºç¡€
- ç›‘æ§ç³»ç»Ÿ --[depends-on]--> ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µ

### æ€ç»´å¯¼å›¾

```text
ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®è·µ
â”‚
â”œâ”€â”€ å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±
â”‚   â”œâ”€â”€ Metrics
â”‚   â”œâ”€â”€ Logs
â”‚   â””â”€â”€ Traces
â”œâ”€â”€ Prometheus ç›‘æ§
â”‚   â”œâ”€â”€ æ¶æ„
â”‚   â””â”€â”€ å…³é”®æŒ‡æ ‡
â”œâ”€â”€ Grafana å¯è§†åŒ–
â”‚   â”œâ”€â”€ ä»ªè¡¨æ¿é…ç½®
â”‚   â””â”€â”€ å‘Šè­¦è§„åˆ™
â”œâ”€â”€ æ—¥å¿—èšåˆï¼ˆLokiï¼‰
â”‚   â”œâ”€â”€ Promtail é…ç½®
â”‚   â””â”€â”€ LogQL
â”œâ”€â”€ åˆ†å¸ƒå¼è¿½è¸ªï¼ˆJaegerï¼‰
â”‚   â””â”€â”€ OpenTelemetry é›†æˆ
â””â”€â”€ å‘Šè­¦é…ç½®
    â””â”€â”€ Alertmanager
```

### å¤šç»´æ¦‚å¿µå¯¹æ¯”çŸ©é˜µ

| ç›‘æ§æŠ€æœ¯         | åŠŸèƒ½ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯   | Rust 1.92.0 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Prometheus**   | é«˜   | é«˜   | ä¸­     | æŒ‡æ ‡ç›‘æ§   | âœ…          |
| **Grafana**      | é«˜   | ä¸­   | ä¸­     | å¯è§†åŒ–     | âœ…          |
| **Loki**         | é«˜   | ä¸­   | ä¸­     | æ—¥å¿—èšåˆ   | âœ…          |
| **Jaeger**       | é«˜   | ä¸­   | ä¸­     | åˆ†å¸ƒå¼è¿½è¸ª | âœ…          |
| **Alertmanager** | ä¸­   | ä¸­   | ä½     | å‘Šè­¦ç®¡ç†   | âœ…          |

### å†³ç­–æ ‘å›¾

```text
é€‰æ‹©ç›‘æ§æŠ€æœ¯
â”‚
â”œâ”€â”€ éœ€è¦ç›‘æ§ä»€ä¹ˆï¼Ÿ
â”‚   â”œâ”€â”€ æŒ‡æ ‡ â†’ Prometheus
â”‚   â”œâ”€â”€ å¯è§†åŒ– â†’ Grafana
â”‚   â”œâ”€â”€ æ—¥å¿— â†’ Loki
â”‚   â”œâ”€â”€ åˆ†å¸ƒå¼è¿½è¸ª â†’ Jaeger
â”‚   â””â”€â”€ å‘Šè­¦ â†’ Alertmanager
```

---

## ğŸ¯ æ¦‚è¿°

**å¯è§‚æµ‹æ€§ (Observability)** æ˜¯äº†è§£ç³»ç»Ÿå†…éƒ¨çŠ¶æ€çš„èƒ½åŠ›ã€‚å¯¹äº Wasm å¾®æœåŠ¡ï¼Œè‰¯å¥½çš„å¯è§‚æµ‹æ€§å¯ä»¥ï¼š

- âœ… å¿«é€Ÿå®šä½é—®é¢˜
- âœ… æ€§èƒ½ä¼˜åŒ–
- âœ… å®¹é‡è§„åˆ’
- âœ… SLA ä¿è¯

### Wasm å¯è§‚æµ‹æ€§çš„ç‰¹ç‚¹

| ç»´åº¦         | ä¼ ç»Ÿå®¹å™¨     | Wasm å®¹å™¨          | å·®å¼‚      |
| :--- | :--- | :--- | :--- |
| **å¯åŠ¨ç›‘æ§** | æ…¢å¯åŠ¨éœ€ç›‘æ§ | æ¯«ç§’çº§ï¼Œå‡ ä¹ä¸éœ€è¦ | âœ¨ æ›´ç®€å• |
| **å†…å­˜ç›‘æ§** | å¤æ‚ï¼ˆå¤šå±‚ï¼‰ | å•ä¸€çº¿æ€§å†…å­˜       | âœ¨ æ›´ç›´æ¥ |
| **æ€§èƒ½å¼€é”€** | 5-10%        | 1-2%               | âœ¨ æ›´ä½   |
| **æŒ‡æ ‡ç²’åº¦** | å®¹å™¨çº§       | æ¨¡å—çº§             | âœ¨ æ›´ç»†   |

---

## ğŸ“Š å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Observability                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Metrics    â”‚      Logs        â”‚      Traces         â”‚
â”‚              â”‚                  â”‚                     â”‚
â”‚ - æ•°å€¼æŒ‡æ ‡    â”‚ - äº‹ä»¶è®°å½•        â”‚ - è¯·æ±‚è¿½è¸ª          â”‚
â”‚ - æ—¶åºæ•°æ®    â”‚ - é”™è¯¯æ—¥å¿—        â”‚ - è°ƒç”¨é“¾            â”‚
â”‚ - èšåˆç»Ÿè®¡    â”‚ - å®¡è®¡æ—¥å¿—        â”‚ - æ€§èƒ½åˆ†æ          â”‚
â”‚              â”‚                  â”‚                     â”‚
â”‚ Prometheus   â”‚  Loki/ELK        â”‚  Jaeger/Zipkin      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. Metrics (æŒ‡æ ‡)

**ç”¨é€”**: äº†è§£ç³»ç»Ÿ**æ•´ä½“**çŠ¶æ€

- CPU/å†…å­˜ä½¿ç”¨ç‡
- è¯·æ±‚é€Ÿç‡
- é”™è¯¯ç‡
- å»¶è¿Ÿåˆ†å¸ƒ

### 2. Logs (æ—¥å¿—)

**ç”¨é€”**: äº†è§£**å…·ä½“**äº‹ä»¶

- é”™è¯¯è¯¦æƒ…
- ç”¨æˆ·è¡Œä¸º
- ç³»ç»Ÿäº‹ä»¶
- å®¡è®¡è¿½è¸ª

### 3. Traces (è¿½è¸ª)

**ç”¨é€”**: äº†è§£**è¯·æ±‚æµç¨‹**

- æœåŠ¡è°ƒç”¨é“¾
- æ€§èƒ½ç“¶é¢ˆ
- ä¾èµ–å…³ç³»
- é”™è¯¯ä¼ æ’­

---

## ğŸ“ˆ Prometheus ç›‘æ§

### æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wasm åº”ç”¨        â”‚
â”‚  /metrics ç«¯ç‚¹    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTP Pull
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Prometheus      â”‚â”€â”€â”€â–¶â”‚ Alertmanagerâ”‚
â”‚   (æ—¶åºæ•°æ®åº“)     â”‚     â”‚  (å‘Šè­¦)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Grafana        â”‚
â”‚    (å¯è§†åŒ–)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®æ–‡ä»¶

è¯¦è§ï¼š[`deployment/monitoring/prometheus.yml`](../../deployment/monitoring/prometheus.yml)

### æš´éœ²æŒ‡æ ‡

**åœ¨ Rust ä¸­æ·»åŠ  Prometheus æ”¯æŒ**:

```rust
// Cargo.toml
// prometheus = "0.13"
// lazy_static = "1.4"

use prometheus::{
    Counter, Histogram, Registry, Encoder, TextEncoder,
    HistogramOpts, Opts,
};
use lazy_static::lazy_static;
use std::time::Instant;

lazy_static! {
    // å…¨å±€æ³¨å†Œè¡¨
    static ref REGISTRY: Registry = Registry::new();

    // HTTP è¯·æ±‚è®¡æ•°å™¨
    static ref HTTP_REQUESTS_TOTAL: Counter = {
        let opts = Opts::new("http_requests_total", "Total HTTP requests");
        let counter = Counter::with_opts(opts).unwrap();
        REGISTRY.register(Box::new(counter.clone())).unwrap();
        counter
    };

    // HTTP è¯·æ±‚å»¶è¿Ÿç›´æ–¹å›¾
    static ref HTTP_REQUEST_DURATION: Histogram = {
        let opts = HistogramOpts::new(
            "http_request_duration_seconds",
            "HTTP request duration in seconds"
        )
        .buckets(vec![0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1.0, 5.0]);
        let histogram = Histogram::with_opts(opts).unwrap();
        REGISTRY.register(Box::new(histogram.clone())).unwrap();
        histogram
    };
}

// è¯·æ±‚å¤„ç†å™¨
fn handle_request(req: Request) -> Response {
    let start = Instant::now();

    // å¢åŠ è¯·æ±‚è®¡æ•°
    HTTP_REQUESTS_TOTAL.inc();

    // å¤„ç†è¯·æ±‚
    let response = process_request(req);

    // è®°å½•å»¶è¿Ÿ
    let duration = start.elapsed().as_secs_f64();
    HTTP_REQUEST_DURATION.observe(duration);

    response
}

// /metrics ç«¯ç‚¹
fn metrics_handler() -> String {
    let encoder = TextEncoder::new();
    let metric_families = REGISTRY.gather();
    let mut buffer = vec![];
    encoder.encode(&metric_families, &mut buffer).unwrap();
    String::from_utf8(buffer).unwrap()
}
```

### å…³é”®æŒ‡æ ‡

#### åº”ç”¨å±‚æŒ‡æ ‡

```promql
# è¯·æ±‚é€Ÿç‡ (QPS)
rate(http_requests_total[1m])

# é”™è¯¯ç‡
rate(http_requests_failed_total[5m]) / rate(http_requests_total[5m]) * 100

# P50, P95, P99 å»¶è¿Ÿ
histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

# Apdex Score (åº”ç”¨æ€§èƒ½æŒ‡æ•°)
(
  sum(rate(http_request_duration_seconds_bucket{le="0.1"}[5m]))
  + sum(rate(http_request_duration_seconds_bucket{le="0.4"}[5m])) / 2
) / sum(rate(http_request_duration_seconds_count[5m]))
```

#### èµ„æºæŒ‡æ ‡

```promql
# å†…å­˜ä½¿ç”¨
container_memory_usage_bytes{pod=~"wasm-.*"}

# å†…å­˜ä½¿ç”¨ç‡
container_memory_usage_bytes / container_spec_memory_limit_bytes * 100

# CPU ä½¿ç”¨ç‡
rate(container_cpu_usage_seconds_total{pod=~"wasm-.*"}[5m]) * 100

# ç½‘ç»œ I/O
rate(container_network_receive_bytes_total[5m])
rate(container_network_transmit_bytes_total[5m])
```

#### Kubernetes æŒ‡æ ‡

```promql
# å¯ç”¨ Pod æ•°é‡
kube_deployment_status_replicas_available{deployment="wasm-microservice"}

# Pod é‡å¯æ¬¡æ•°
increase(kube_pod_container_status_restarts_total[1h])

# Pod çŠ¶æ€
kube_pod_status_phase{pod=~"wasm-.*", phase="Running"}

# HPA çŠ¶æ€
kube_horizontalpodautoscaler_status_current_replicas
kube_horizontalpodautoscaler_spec_max_replicas
```

---

## ğŸ“Š Grafana å¯è§†åŒ–

### ä»ªè¡¨æ¿é…ç½®

è¯¦è§ï¼š[`deployment/monitoring/grafana-dashboard.json`](../../deployment/monitoring/grafana-dashboard.json)

### æ ¸å¿ƒé¢æ¿

#### 1. Golden Signals ä»ªè¡¨æ¿

**å››ä¸ªé»„é‡‘æŒ‡æ ‡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Golden Signals                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Latency   â”‚  Traffic   â”‚   Errors   â”‚  Saturation     â”‚
â”‚            â”‚            â”‚            â”‚                 â”‚
â”‚  P99: 50ms â”‚  1000 rps  â”‚  0.1%      â”‚  CPU: 30%       â”‚
â”‚  P95: 30ms â”‚            â”‚            â”‚  Mem: 45%       â”‚
â”‚  P50: 10ms â”‚            â”‚            â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. RED æ–¹æ³•ä»ªè¡¨æ¿

**Rate, Errors, Duration**:

- **Rate**: è¯·æ±‚é€Ÿç‡
- **Errors**: é”™è¯¯æ•°/é”™è¯¯ç‡
- **Duration**: è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ

#### 3. USE æ–¹æ³•ä»ªè¡¨æ¿

**Utilization, Saturation, Errors**:

- **Utilization**: èµ„æºä½¿ç”¨ç‡ï¼ˆCPUã€å†…å­˜ï¼‰
- **Saturation**: èµ„æºé¥±å’Œåº¦ï¼ˆé˜Ÿåˆ—é•¿åº¦ï¼‰
- **Errors**: é”™è¯¯æ•°é‡

### å‘Šè­¦è§„åˆ™

è¯¦è§ï¼š[`deployment/monitoring/alerts/wasm-alerts.yml`](../../deployment/monitoring/alerts/wasm-alerts.yml)

---

## ğŸ“ æ—¥å¿—èšåˆ (Loki)

### æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wasm Pod 1  â”‚â”€â”€â”€â”€â–¶â”‚   Promtail   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  (æ—¥å¿—é‡‡é›†)   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚              â”‚
â”‚  Wasm Pod 2  â”‚â”€â”€â”€â”€â–¶â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  Wasm Pod 3  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Loki     â”‚
                    â”‚  (æ—¥å¿—å­˜å‚¨)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Grafana    â”‚
                    â”‚  (æ—¥å¿—æŸ¥è¯¢)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Promtail é…ç½®

```yaml
# promtail-config.yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Kubernetes Pod æ—¥å¿—
  - job_name: kubernetes-pods
    kubernetes_sd_configs:
      - role: pod

    relabel_configs:
      # åªé‡‡é›† Wasm Pod
      - source_labels: [__meta_kubernetes_pod_label_runtime]
        action: keep
        regex: wasmedge

      # æ·»åŠ æ ‡ç­¾
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_label_app]
        target_label: app

    pipeline_stages:
      # è§£æ JSON æ—¥å¿—
      - json:
          expressions:
            level: level
            timestamp: timestamp
            message: message

      # æå–æ ‡ç­¾
      - labels:
          level:

      # æ—¶é—´æˆ³è§£æ
      - timestamp:
          source: timestamp
          format: RFC3339
```

### æ—¥å¿—æŸ¥è¯¢ (LogQL)

```logql
# æŸ¥çœ‹æ‰€æœ‰ Wasm åº”ç”¨æ—¥å¿—
{app="wasm-microservice"}

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
{app="wasm-microservice"} |= "error"

# æŸ¥çœ‹ç‰¹å®š Pod çš„æ—¥å¿—
{pod="wasm-microservice-abc123"}

# ç»Ÿè®¡é”™è¯¯æ•°é‡
sum(count_over_time({app="wasm-microservice"} |= "error" [5m]))

# æ…¢è¯·æ±‚æ—¥å¿—
{app="wasm-microservice"} | json | duration > 1s

# æŒ‰é”™è¯¯ç±»å‹èšåˆ
sum by (error_type) (
  count_over_time({app="wasm-microservice"} | json | level="error" [1h])
)
```

### ç»“æ„åŒ–æ—¥å¿—æœ€ä½³å®è·µ

```rust
// ä½¿ç”¨ serde_json è¾“å‡ºç»“æ„åŒ–æ—¥å¿—
use serde_json::json;

fn log_request(method: &str, path: &str, status: u16, duration_ms: u64) {
    let log = json!({
        "timestamp": chrono::Utc::now().to_rfc3339(),
        "level": "info",
        "message": "HTTP request",
        "method": method,
        "path": path,
        "status": status,
        "duration_ms": duration_ms,
        "service": "wasm-microservice",
        "version": env!("CARGO_PKG_VERSION")
    });

    println!("{}", log);
}

// ä½¿ç”¨
log_request("GET", "/api/users", 200, 15);
// è¾“å‡ºï¼š{"timestamp":"2025-10-30T12:00:00Z","level":"info","message":"HTTP request",...}
```

---

## ğŸ” åˆ†å¸ƒå¼è¿½è¸ª (Jaeger)

### ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è¿½è¸ªï¼Ÿ

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½ç»è¿‡å¤šä¸ªæœåŠ¡ï¼š

```text
Client â†’ Gateway â†’ Wasm Service A â†’ Wasm Service B â†’ Database
```

åˆ†å¸ƒå¼è¿½è¸ªå¯ä»¥ï¼š

- å¯è§†åŒ–è¯·æ±‚æµç¨‹
- å®šä½æ€§èƒ½ç“¶é¢ˆ
- åˆ†ææœåŠ¡ä¾èµ–

### OpenTelemetry é›†æˆ

```rust
// Cargo.toml
// opentelemetry = "0.21"
// opentelemetry-jaeger = "0.20"
// tracing = "0.1"
// tracing-opentelemetry = "0.22"

use opentelemetry::global;
use opentelemetry::sdk::trace::Tracer;
use opentelemetry_jaeger::JaegerTraceRuntime;
use tracing::{info, span, Level};
use tracing_subscriber::layer::SubscriberExt;

// åˆå§‹åŒ– Jaeger
fn init_tracer() -> Tracer {
    opentelemetry_jaeger::new_agent_pipeline()
        .with_service_name("wasm-microservice")
        .with_endpoint("jaeger-agent:6831")
        .install_batch(JaegerTraceRuntime::default())
        .expect("Failed to install tracer")
}

// ä½¿ç”¨ç¤ºä¾‹
fn handle_request(req: Request) -> Response {
    // åˆ›å»º span
    let span = span!(Level::INFO, "handle_request", method = %req.method(), path = %req.path());
    let _enter = span.enter();

    info!("Processing request");

    // è°ƒç”¨ä¸‹æ¸¸æœåŠ¡ï¼ˆè‡ªåŠ¨ä¼ æ’­ trace contextï¼‰
    let response = call_downstream_service(&req);

    info!(status = %response.status(), "Request completed");

    response
}

fn call_downstream_service(req: &Request) -> Response {
    let span = span!(Level::INFO, "call_downstream", service = "service-b");
    let _enter = span.enter();

    // HTTP è¯·æ±‚ä¼šè‡ªåŠ¨æ³¨å…¥ trace headers
    // ä¾‹å¦‚ï¼štraceparent, tracestate
    http_client.post("http://service-b/api").send()
}
```

### Jaeger UI ä½¿ç”¨

**æŸ¥çœ‹ Trace**:

1. æ‰“å¼€ Jaeger UI: <http://localhost:16686>
2. é€‰æ‹©æœåŠ¡: wasm-microservice
3. æŸ¥çœ‹ Trace åˆ—è¡¨
4. ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è°ƒç”¨é“¾

**åˆ†ææ€§èƒ½**:

- Span Duration: æ¯ä¸ªæ“ä½œçš„è€—æ—¶
- Critical Path: å…³é”®è·¯å¾„åˆ†æ
- Service Dependencies: æœåŠ¡ä¾èµ–å›¾

---

## ğŸš¨ å‘Šè­¦é…ç½®

### Alertmanager é…ç½®

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m
  slack_api_url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

route:
  group_by: ["alertname", "cluster", "service"]
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: "default"

  routes:
    # å…³é”®å‘Šè­¦ â†’ Pager Duty
    - match:
        severity: critical
      receiver: "pagerduty"
      continue: true

    # è­¦å‘Š â†’ Slack
    - match:
        severity: warning
      receiver: "slack"

    # ä¿¡æ¯ â†’ Email
    - match:
        severity: info
      receiver: "email"

receivers:
  - name: "default"
    slack_configs:
      - channel: "#alerts"
        title: "{{ .GroupLabels.alertname }}"
        text: "{{ range .Alerts }}{{ .Annotations.description }}{{ end }}"

  - name: "slack"
    slack_configs:
      - channel: "#wasm-alerts"
        send_resolved: true

  - name: "pagerduty"
    pagerduty_configs:
      - service_key: "YOUR_PAGERDUTY_KEY"

  - name: "email"
    email_configs:
      - to: "team@example.com"
        from: "alertmanager@example.com"
        smarthost: "smtp.example.com:587"
        auth_username: "alertmanager"
        auth_password: "password"
```

### å‘Šè­¦æœ€ä½³å®è·µ

#### 1. å‘Šè­¦åˆ†çº§

| çº§åˆ«         | å«ä¹‰       | å“åº”æ—¶é—´   | é€šçŸ¥æ–¹å¼                 |
| :--- | :--- | :--- | :--- |
| **Critical** | æœåŠ¡ä¸å¯ç”¨ | ç«‹å³       | PagerDuty + Slack + ç”µè¯ |
| **Warning**  | æ€§èƒ½ä¸‹é™   | 30åˆ†é’Ÿå†…   | Slack                    |
| **Info**     | ä¸€èˆ¬é€šçŸ¥   | å·¥ä½œæ—¶é—´å†… | Email                    |

#### 2. å‘Šè­¦å‘½åè§„èŒƒ

```text
<Component><Issue><Severity>

ç¤ºä¾‹ï¼š
- WasmServiceDown          (Critical)
- WasmHighErrorRate        (Warning)
- WasmDeploymentCompleted  (Info)
```

#### 3. é¿å…å‘Šè­¦ç–²åŠ³

- âœ… è®¾ç½®åˆç†çš„é˜ˆå€¼
- âœ… ä½¿ç”¨å‘Šè­¦æŠ‘åˆ¶ï¼ˆinhibit_rulesï¼‰
- âœ… è®¾ç½®å‘Šè­¦é™é»˜æ—¶é—´
- âœ… å®šæœŸå®¡æŸ¥å‘Šè­¦è§„åˆ™

---

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. å››ä¸ªé»„é‡‘æŒ‡æ ‡ (Four Golden Signals)

**Google SRE æ¨èçš„æ ¸å¿ƒæŒ‡æ ‡**:

```text
1. Latency (å»¶è¿Ÿ)
   - P50, P95, P99 å“åº”æ—¶é—´

2. Traffic (æµé‡)
   - æ¯ç§’è¯·æ±‚æ•° (RPS)

3. Errors (é”™è¯¯)
   - é”™è¯¯ç‡ %

4. Saturation (é¥±å’Œåº¦)
   - CPU/å†…å­˜ä½¿ç”¨ç‡
```

### 2. ç›‘æ§å³ä»£ç  (Monitoring as Code)

- âœ… å‘Šè­¦è§„åˆ™ç‰ˆæœ¬åŒ–
- âœ… ä»ªè¡¨æ¿ä»£ç åŒ–
- âœ… CI/CD é›†æˆ
- âœ… ä»£ç å®¡æŸ¥

### 3. å¯è§‚æµ‹æ€§æˆç†Ÿåº¦æ¨¡å‹

```text
Level 1 (åŸºç¡€):
  âœ… åŸºæœ¬æŒ‡æ ‡é‡‡é›†
  âœ… ç®€å•å‘Šè­¦

Level 2 (ä¸­çº§):
  âœ… ç»“æ„åŒ–æ—¥å¿—
  âœ… è‡ªå®šä¹‰æŒ‡æ ‡
  âœ… å‘Šè­¦åˆ†çº§

Level 3 (é«˜çº§):
  âœ… åˆ†å¸ƒå¼è¿½è¸ª
  âœ… SLO/SLI å®šä¹‰
  âœ… å¼‚å¸¸æ£€æµ‹

Level 4 (ä¸“å®¶):
  âœ… AI å¼‚å¸¸æ£€æµ‹
  âœ… è‡ªåŠ¨åŒ–æ ¹å› åˆ†æ
  âœ… è‡ªæ„ˆç³»ç»Ÿ
```

### 4. SLO/SLI/SLA

**å®šä¹‰**:

- **SLI (Service Level Indicator)**: æœåŠ¡æ°´å¹³æŒ‡æ ‡
  - ä¾‹å¦‚ï¼šP99 å»¶è¿Ÿ < 100ms

- **SLO (Service Level Objective)**: æœåŠ¡æ°´å¹³ç›®æ ‡
  - ä¾‹å¦‚ï¼š99.9% çš„è¯·æ±‚ P99 < 100ms

- **SLA (Service Level Agreement)**: æœåŠ¡æ°´å¹³åè®®
  - ä¾‹å¦‚ï¼šå¯ç”¨æ€§ 99.95%

**ç¤ºä¾‹é…ç½®**:

```yaml
# SLO å®šä¹‰
slos:
  - name: wasm-api-availability
    sli:
      metric: up{job="wasm-microservice"}
    objective: 99.9 # 99.9% å¯ç”¨æ€§

  - name: wasm-api-latency
    sli:
      metric: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))
      threshold: 0.1 # 100ms
    objective: 99.0 # 99% çš„è¯·æ±‚ < 100ms
```

### 5. æˆæœ¬ä¼˜åŒ–

**ç›‘æ§æ•°æ®å­˜å‚¨æˆæœ¬**:

- âœ… è®¾ç½®æ•°æ®ä¿ç•™æœŸé™ï¼ˆé€šå¸¸ 15-30 å¤©ï¼‰
- âœ… ä½¿ç”¨é‡‡æ ·ï¼ˆé«˜åŸºæ•°æŒ‡æ ‡ï¼‰
- âœ… å‹ç¼©å†å²æ•°æ®
- âœ… åˆ†å±‚å­˜å‚¨ï¼ˆçƒ­/å†·æ•°æ®ï¼‰

---

## ğŸ¯ æ€»ç»“

### ç›‘æ§æ£€æŸ¥æ¸…å•

- [ ] Prometheus éƒ¨ç½²å’Œé…ç½®
- [ ] åº”ç”¨æš´éœ² /metrics ç«¯ç‚¹
- [ ] Grafana ä»ªè¡¨æ¿åˆ›å»º
- [ ] å…³é”®å‘Šè­¦è§„åˆ™é…ç½®
- [ ] Alertmanager é€šçŸ¥é…ç½®
- [ ] æ—¥å¿—èšåˆ (Loki) é…ç½®
- [ ] åˆ†å¸ƒå¼è¿½è¸ª (Jaeger) é›†æˆ
- [ ] SLO/SLI å®šä¹‰
- [ ] On-call è½®æ¢æœºåˆ¶
- [ ] è¿ç»´æ‰‹å†Œ (Runbook)

### å…³é”®æŒ‡æ ‡ç›®æ ‡

| æŒ‡æ ‡     | ç›®æ ‡å€¼  | å½“å‰å€¼    |
| :--- | :--- | :--- |
| å¯ç”¨æ€§   | 99.9%   | âœ… 99.95% |
| P99 å»¶è¿Ÿ | < 100ms | âœ… 45ms   |
| é”™è¯¯ç‡   | < 0.1%  | âœ… 0.05%  |
| MTTR     | < 5min  | âœ… 3min   |
| MTTD     | < 1min  | âœ… 30s    |

---

**æ–‡æ¡£ç»´æŠ¤**: Documentation Team
**æœ€åæ›´æ–°**: 2025-12-11
**ç›¸å…³æ–‡æ¡£**: [å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ](./06_å®¹å™¨æŠ€æœ¯æ·±åº¦é›†æˆ.md) | [äº‘åŸç”ŸCI/CDå®è·µ](./07_äº‘åŸç”ŸCI_CDå®è·µ.md)
