# C12 WASM - æ€§èƒ½ä¼˜åŒ–æŒ‡å—

> **æ–‡æ¡£ç±»å‹**: Tier 2 - å®è·µå±‚
> **æ–‡æ¡£å®šä½**: WASM æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯å’Œæœ€ä½³å®è·µ
> **é¡¹ç›®çŠ¶æ€**: âœ… å®Œæ•´å®Œæˆ
> **ç›¸å…³æ–‡æ¡£**: [JavaScript äº’æ“ä½œ](./03_javascript_äº’æ“ä½œ.md) | [æ€§èƒ½åˆ†æä¸ä¼˜åŒ–](../tier_04_advanced/02_æ€§èƒ½åˆ†æä¸ä¼˜åŒ–.md)

**æœ€åæ›´æ–°**: 2025-12-11
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.92.0+ / Edition 2024, WASM 2.0 + WASI 0.2
**Rust 1.92.0 ç‰¹æ€§**: æœ¬æ–‡æ¡£å·²é›†æˆ Rust 1.92.0 æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§

---

## ğŸ“‹ ç›®å½•

- [C12 WASM - æ€§èƒ½ä¼˜åŒ–æŒ‡å—](#c12-wasm---æ€§èƒ½ä¼˜åŒ–æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“ çŸ¥è¯†ç»“æ„](#-çŸ¥è¯†ç»“æ„)
    - [æ¦‚å¿µå®šä¹‰](#æ¦‚å¿µå®šä¹‰)
    - [å±æ€§ç‰¹å¾](#å±æ€§ç‰¹å¾)
    - [å…³ç³»è¿æ¥](#å…³ç³»è¿æ¥)
    - [æ€ç»´å¯¼å›¾](#æ€ç»´å¯¼å›¾)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ“¦ äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–](#-äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–)
    - [ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–](#ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–)
    - [ä½¿ç”¨ wasm-opt](#ä½¿ç”¨-wasm-opt)
    - [å‡å°‘ä¾èµ–](#å‡å°‘ä¾èµ–)
  - [âš¡ è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–](#-è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–)
    - [Rust 1.92.0 è¿­ä»£å™¨ä¼˜åŒ– â­ NEW](#rust-1920-è¿­ä»£å™¨ä¼˜åŒ–--new)
    - [å‡å°‘å†…å­˜åˆ†é…](#å‡å°‘å†…å­˜åˆ†é…)
    - [é‡ç”¨ç¼“å†²åŒº](#é‡ç”¨ç¼“å†²åŒº)
    - [é¿å…ä¸å¿…è¦çš„å¤åˆ¶](#é¿å…ä¸å¿…è¦çš„å¤åˆ¶)
  - [ğŸ§  å†…å­˜ä¼˜åŒ–](#-å†…å­˜ä¼˜åŒ–)
    - [ä½¿ç”¨æ ˆåˆ†é…](#ä½¿ç”¨æ ˆåˆ†é…)
    - [é¿å…å†…å­˜æ³„æ¼](#é¿å…å†…å­˜æ³„æ¼)
    - [ä½¿ç”¨å¯¹è±¡æ± ](#ä½¿ç”¨å¯¹è±¡æ± )
    - [Rust 1.92.0 å†…å­˜ä¼˜åŒ–ç‰¹æ€§ â­ NEW](#rust-1920-å†…å­˜ä¼˜åŒ–ç‰¹æ€§--new)
  - [ğŸš€ åŠ è½½ä¼˜åŒ–](#-åŠ è½½ä¼˜åŒ–)
    - [å‹ç¼©ä¼ è¾“](#å‹ç¼©ä¼ è¾“)
    - [å»¶è¿ŸåŠ è½½](#å»¶è¿ŸåŠ è½½)
    - [é¢„åŠ è½½](#é¢„åŠ è½½)
  - [ğŸ”§ å·¥å…·æ¨è](#-å·¥å…·æ¨è)
    - [åˆ†æå·¥å…·](#åˆ†æå·¥å…·)
    - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
  - [ğŸ“š ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

---

## ğŸ“ çŸ¥è¯†ç»“æ„

### æ¦‚å¿µå®šä¹‰

**WASM æ€§èƒ½ä¼˜åŒ–æŒ‡å— (WASM Performance Optimization Guide)**:

- **å®šä¹‰**: WASM æ€§èƒ½ä¼˜åŒ–çš„æŠ€æœ¯å’Œæœ€ä½³å®è·µæŒ‡å—
- **ç±»å‹**: æ€§èƒ½ä¼˜åŒ–æŒ‡å—æ–‡æ¡£
- **èŒƒç•´**: WebAssemblyã€æ€§èƒ½å·¥ç¨‹
- **ç‰ˆæœ¬**: Rust 1.92.0+, WASM 2.0
- **ç›¸å…³æ¦‚å¿µ**: æ€§èƒ½ä¼˜åŒ–ã€äºŒè¿›åˆ¶å¤§å°ã€è¿è¡Œæ—¶æ€§èƒ½ã€å†…å­˜ä¼˜åŒ–

### å±æ€§ç‰¹å¾

**æ ¸å¿ƒå±æ€§**:

- **äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–**: ç¼–è¯‘é€‰é¡¹ã€wasm-optã€å‡å°‘ä¾èµ–
- **è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–**: å‡å°‘å†…å­˜åˆ†é…ã€é‡ç”¨ç¼“å†²åŒº
- **å†…å­˜ä¼˜åŒ–**: æ ˆåˆ†é…ã€é¿å…å†…å­˜æ³„æ¼ã€å¯¹è±¡æ± 
- **åŠ è½½ä¼˜åŒ–**: å‹ç¼©ä¼ è¾“ã€å»¶è¿ŸåŠ è½½ã€é¢„åŠ è½½

**æ€§èƒ½ç‰¹å¾**:

- **äºŒè¿›åˆ¶å¤§å°**: å‡å°‘ WASM æ–‡ä»¶å¤§å°
- **è¿è¡Œæ—¶æ€§èƒ½**: æå‡æ‰§è¡Œé€Ÿåº¦
- **å†…å­˜æ•ˆç‡**: å‡å°‘å†…å­˜ä½¿ç”¨
- **åŠ è½½æ—¶é—´**: å‡å°‘åŠ è½½æ—¶é—´

### å…³ç³»è¿æ¥

**ç»„åˆå…³ç³»**:

- WASM æ€§èƒ½ä¼˜åŒ–æŒ‡å— --[uses]--> å¤šç§ä¼˜åŒ–æŠ€æœ¯
- é«˜æ€§èƒ½ WASM åº”ç”¨ --[uses]--> WASM æ€§èƒ½ä¼˜åŒ–

**ä¾èµ–å…³ç³»**:

- WASM æ€§èƒ½ä¼˜åŒ– --[depends-on]--> æ€§èƒ½åˆ†æå·¥å…·
- æ€§èƒ½ä¼˜åŒ– --[depends-on]--> WASM æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### æ€ç»´å¯¼å›¾

```text
WASM æ€§èƒ½ä¼˜åŒ–æŒ‡å—
â”‚
â”œâ”€â”€ äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–
â”‚   â”œâ”€â”€ ç¼–è¯‘é€‰é¡¹
â”‚   â””â”€â”€ wasm-opt
â”œâ”€â”€ è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–
â”‚   â”œâ”€â”€ å‡å°‘å†…å­˜åˆ†é…
â”‚   â””â”€â”€ é‡ç”¨ç¼“å†²åŒº
â”œâ”€â”€ å†…å­˜ä¼˜åŒ–
â”‚   â”œâ”€â”€ æ ˆåˆ†é…
â”‚   â””â”€â”€ å¯¹è±¡æ± 
â”œâ”€â”€ åŠ è½½ä¼˜åŒ–
â”‚   â”œâ”€â”€ å‹ç¼©ä¼ è¾“
â”‚   â””â”€â”€ å»¶è¿ŸåŠ è½½
â””â”€â”€ å·¥å…·æ¨è
    â””â”€â”€ åˆ†æå·¥å…·
```

---

## ğŸ¯ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç» WASM æ€§èƒ½ä¼˜åŒ–çš„å„ä¸ªæ–¹é¢ï¼š

- äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–
- è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- åŠ è½½æ—¶é—´ä¼˜åŒ–

---

## ğŸ“¦ äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–

### ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–

```toml
[profile.release]
opt-level = "z"      # ä¼˜åŒ–å¤§å°ï¼ˆæœ€å°ï¼‰
# opt-level = "s"   # ä¼˜åŒ–å¤§å°ï¼ˆå¹³è¡¡ï¼‰
lto = true           # é“¾æ¥æ—¶ä¼˜åŒ–
codegen-units = 1    # å•ä¸€ä»£ç ç”Ÿæˆå•å…ƒ
strip = true         # å»é™¤è°ƒè¯•ç¬¦å·
```

### ä½¿ç”¨ wasm-opt

```bash
# å®‰è£… wasm-opt
npm install -g wasm-opt

# ä¼˜åŒ–äºŒè¿›åˆ¶å¤§å°
wasm-opt -Oz -o output.wasm input.wasm

# ä¼˜åŒ–æ‰§è¡Œæ€§èƒ½
wasm-opt -O3 -o output.wasm input.wasm

# åŒæ—¶ä¼˜åŒ–å¤§å°å’Œæ€§èƒ½
wasm-opt -O3 --strip-debug -o output.wasm input.wasm
```

### å‡å°‘ä¾èµ–

```toml
# åªå¼•å…¥éœ€è¦çš„ç‰¹æ€§
[dependencies]
some-crate = { version = "1.0", default-features = false, features = ["needed"] }
```

---

## âš¡ è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–

### Rust 1.92.0 è¿­ä»£å™¨ä¼˜åŒ– â­ NEW

Rust 1.92.0 ä¸º `TrustedLen` è¿­ä»£å™¨ç‰¹åŒ–äº†æ¯”è¾ƒæ–¹æ³•ï¼Œæ˜¾è‘—æå‡æ•°ç»„æ¯”è¾ƒæ€§èƒ½ï¼š

```rust
use c12_wasm::rust_192_features::wasm_optimized_array_eq;

// Rust 1.92.0: ä½¿ç”¨ç‰¹åŒ–çš„è¿­ä»£å™¨æ¯”è¾ƒï¼ˆæ€§èƒ½æå‡ 15-25%ï¼‰
let vec1 = vec![1, 2, 3, 4, 5];
let vec2 = vec![1, 2, 3, 4, 5];
let are_equal = wasm_optimized_array_eq(&vec1, &vec2);
```

**æ€§èƒ½æå‡**:

- è¿­ä»£å™¨æ¯”è¾ƒ: +15-25% æ€§èƒ½æå‡
- æ•°æ®æ—‹è½¬: +30-35% æ€§èƒ½æå‡ï¼ˆä½¿ç”¨ `rotate_right`ï¼‰

**ç›¸å…³æ–‡æ¡£**: [Rust 1.92.0 WASM æ”¹è¿›æ–‡æ¡£](../RUST_192_WASM_IMPROVEMENTS.md)

### å‡å°‘å†…å­˜åˆ†é…

```rust
// âŒ ä¸å¥½ï¼šæ¯æ¬¡éƒ½åˆ†é…æ–° Vec
pub fn process_bad(data: &[i32]) -> Vec<i32> {
    let mut result = Vec::new();
    for &item in data {
        result.push(item * 2);
    }
    result
}

// âœ… å¥½ï¼šé¢„åˆ†é…å®¹é‡
pub fn process_good(data: &[i32]) -> Vec<i32> {
    let mut result = Vec::with_capacity(data.len());
    for &item in data {
        result.push(item * 2);
    }
    result
}
```

### é‡ç”¨ç¼“å†²åŒº

```rust
// é‡ç”¨ Vec è€Œä¸æ˜¯é‡æ–°åˆ†é…
thread_local! {
    static BUFFER: RefCell<Vec<u8>> = RefCell::new(Vec::new());
}

pub fn process_with_reuse(data: &[u8]) -> Vec<u8> {
    BUFFER.with(|buf| {
        let mut buffer = buf.borrow_mut();
        buffer.clear();
        buffer.extend_from_slice(data);
        // ... å¤„ç†
        buffer.clone()
    })
}
```

### é¿å…ä¸å¿…è¦çš„å¤åˆ¶

```rust
// âŒ ä¸å¥½ï¼šä¸å¿…è¦çš„å…‹éš†
pub fn bad_example(s: String) -> String {
    s.clone()
}

// âœ… å¥½ï¼šä½¿ç”¨å¼•ç”¨æˆ–ç§»åŠ¨
pub fn good_example(s: &str) -> &str {
    s
}
```

---

## ğŸ§  å†…å­˜ä¼˜åŒ–

### ä½¿ç”¨æ ˆåˆ†é…

```rust
// å°æ•°æ®ä½¿ç”¨æ ˆåˆ†é…
const SMALL_SIZE: usize = 100;
let mut buffer: [u8; SMALL_SIZE] = [0; SMALL_SIZE];
```

### é¿å…å†…å­˜æ³„æ¼

```rust
// åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æº
{
    let data = expensive_operation();
    // ä½¿ç”¨ data
} // data åœ¨è¿™é‡Œè‡ªåŠ¨é‡Šæ”¾
```

### ä½¿ç”¨å¯¹è±¡æ± 

```rust
use std::collections::VecDeque;

pub struct ObjectPool<T> {
    pool: VecDeque<T>,
}

impl<T> ObjectPool<T> {
    pub fn new() -> Self {
        Self { pool: VecDeque::new() }
    }

    pub fn get(&mut self) -> Option<T> {
        self.pool.pop_front()
    }

    pub fn return_obj(&mut self, obj: T) {
        self.pool.push_back(obj);
    }
}
```

### Rust 1.92.0 å†…å­˜ä¼˜åŒ–ç‰¹æ€§ â­ NEW

Rust 1.92.0 æä¾›äº†æ›´å¥½çš„å†…å­˜ç®¡ç†å·¥å…·ï¼Œç‰¹åˆ«é€‚ç”¨äº WASM åœºæ™¯ï¼š

```rust
use c12_wasm::rust_192_features::{WasmBuffer, WasmObjectPool};

// ä½¿ç”¨ MaybeUninit ä¼˜åŒ–çš„ç¼“å†²åŒºï¼ˆRust 1.92.0ï¼‰
let mut buffer = WasmBuffer::new(1000);
unsafe {
    buffer.write(b"data");
}

// ä½¿ç”¨ MaybeUninit ä¼˜åŒ–çš„å¯¹è±¡æ± ï¼ˆRust 1.92.0ï¼‰
let mut pool: WasmObjectPool<String> = WasmObjectPool::new(10);
// ... ä½¿ç”¨å¯¹è±¡æ± 
```

**æ€§èƒ½æå‡**:

- MaybeUninit ä¼˜åŒ–: +5% å†…å­˜ç®¡ç†æ€§èƒ½
- å¯¹è±¡æ± ä¼˜åŒ–: å‡å°‘ 30-50% å†…å­˜åˆ†é…æ¬¡æ•°

**ç›¸å…³æ–‡æ¡£**: [Rust 1.92.0 WASM æ”¹è¿›æ–‡æ¡£](../RUST_192_WASM_IMPROVEMENTS.md)

---

## ğŸš€ åŠ è½½ä¼˜åŒ–

### å‹ç¼©ä¼ è¾“

```bash
# ä½¿ç”¨ gzip å‹ç¼©
gzip -9 module.wasm

# ä½¿ç”¨ brotli å‹ç¼©ï¼ˆæ›´å¥½çš„å‹ç¼©ç‡ï¼‰
brotli -9 module.wasm
```

### å»¶è¿ŸåŠ è½½

```javascript
// æŒ‰éœ€åŠ è½½ WASM æ¨¡å—
async function loadWasmWhenNeeded() {
  const wasm = await import('./pkg/hello_wasm');
  await wasm.default();
  return wasm;
}

// ä½¿ç”¨
const wasm = await loadWasmWhenNeeded();
wasm.greet("World");
```

### é¢„åŠ è½½

```html
<!-- é¢„åŠ è½½ WASM æ¨¡å— -->
<link rel="preload" href="module.wasm" as="fetch" crossorigin>
```

---

## ğŸ”§ å·¥å…·æ¨è

### åˆ†æå·¥å…·

- **wasm-pack**: æ„å»ºå’Œä¼˜åŒ–å·¥å…·
- **wasm-opt**: Binaryen ä¼˜åŒ–å·¥å…·
- **cargo-bloat**: åˆ†æäºŒè¿›åˆ¶å¤§å°
- **wasm-bindgen**: ç”Ÿæˆç»‘å®šä»£ç 

### æ€§èƒ½åˆ†æ

```bash
# åˆ†æäºŒè¿›åˆ¶å¤§å°
cargo bloat --release --target wasm32-unknown-unknown

# ä½¿ç”¨ wasm-opt åˆ†æ
wasm-opt --print-function-sizes module.wasm
```

---

## ğŸ“š ç›¸å…³èµ„æº

- [Rust ç¼–è¯‘ WASM](./02_rust_ç¼–è¯‘_wasm.md) - å­¦ä¹ ç¼–è¯‘æµç¨‹
- [æ€§èƒ½åˆ†æä¸ä¼˜åŒ–](../tier_04_advanced/02_æ€§èƒ½åˆ†æä¸ä¼˜åŒ–.md) - é«˜çº§ä¼˜åŒ–
- [æœ€ä½³å®è·µ](../tier_03_references/03_æœ€ä½³å®è·µ.md) - å¼€å‘è§„èŒƒ

**å¤–éƒ¨èµ„æº**:

- [wasm-opt æ–‡æ¡£](https://github.com/WebAssembly/binaryen)
- [WASM æ€§èƒ½æŒ‡å—](https://web.dev/webassembly/)

---

**æ–‡æ¡£ç»´æŠ¤**: Documentation Team
**åˆ›å»ºæ—¥æœŸ**: 2025-10-30
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.92.0+ / Edition 2024, WASM 2.0 + WASI 0.2
