# C12 WASM - æ€§èƒ½ä¼˜åŒ–æŒ‡å—

> **æ–‡æ¡£ç±»å‹**: Tier 2 - å®è·µå±‚
> **æ–‡æ¡£å®šä½**: WASM æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯å’Œæœ€ä½³å®è·µ
> **é¡¹ç›®çŠ¶æ€**: âœ… å®Œæ•´å®Œæˆ
> **ç›¸å…³æ–‡æ¡£**: [JavaScript äº’æ“ä½œ](./03_javascript_äº’æ“ä½œ.md) | [æ€§èƒ½åˆ†æä¸ä¼˜åŒ–](../tier_04_advanced/02_æ€§èƒ½åˆ†æä¸ä¼˜åŒ–.md)

**æœ€åæ›´æ–°**: 2025-12-11
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.92.0+ / Edition 2024, WASM 2.0 + WASI 0.2

---

## ğŸ“‹ ç›®å½•

- [C12 WASM - æ€§èƒ½ä¼˜åŒ–æŒ‡å—](#c12-wasm---æ€§èƒ½ä¼˜åŒ–æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ“¦ äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–](#-äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–)
    - [ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–](#ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–)
    - [ä½¿ç”¨ wasm-opt](#ä½¿ç”¨-wasm-opt)
    - [å‡å°‘ä¾èµ–](#å‡å°‘ä¾èµ–)
  - [âš¡ è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–](#-è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–)
    - [å‡å°‘å†…å­˜åˆ†é…](#å‡å°‘å†…å­˜åˆ†é…)
    - [é‡ç”¨ç¼“å†²åŒº](#é‡ç”¨ç¼“å†²åŒº)
    - [é¿å…ä¸å¿…è¦çš„å¤åˆ¶](#é¿å…ä¸å¿…è¦çš„å¤åˆ¶)
  - [ğŸ§  å†…å­˜ä¼˜åŒ–](#-å†…å­˜ä¼˜åŒ–)
    - [ä½¿ç”¨æ ˆåˆ†é…](#ä½¿ç”¨æ ˆåˆ†é…)
    - [é¿å…å†…å­˜æ³„æ¼](#é¿å…å†…å­˜æ³„æ¼)
    - [ä½¿ç”¨å¯¹è±¡æ± ](#ä½¿ç”¨å¯¹è±¡æ± )
  - [ğŸš€ åŠ è½½ä¼˜åŒ–](#-åŠ è½½ä¼˜åŒ–)
    - [å‹ç¼©ä¼ è¾“](#å‹ç¼©ä¼ è¾“)
    - [å»¶è¿ŸåŠ è½½](#å»¶è¿ŸåŠ è½½)
    - [é¢„åŠ è½½](#é¢„åŠ è½½)
  - [ğŸ”§ å·¥å…·æ¨è](#-å·¥å…·æ¨è)
    - [åˆ†æå·¥å…·](#åˆ†æå·¥å…·)
    - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
  - [ğŸ“š ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

---

## ğŸ¯ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç» WASM æ€§èƒ½ä¼˜åŒ–çš„å„ä¸ªæ–¹é¢ï¼š

- äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–
- è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- åŠ è½½æ—¶é—´ä¼˜åŒ–

---

## ğŸ“¦ äºŒè¿›åˆ¶å¤§å°ä¼˜åŒ–

### ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–

```toml
[profile.release]
opt-level = "z"      # ä¼˜åŒ–å¤§å°ï¼ˆæœ€å°ï¼‰
# opt-level = "s"   # ä¼˜åŒ–å¤§å°ï¼ˆå¹³è¡¡ï¼‰
lto = true           # é“¾æ¥æ—¶ä¼˜åŒ–
codegen-units = 1    # å•ä¸€ä»£ç ç”Ÿæˆå•å…ƒ
strip = true         # å»é™¤è°ƒè¯•ç¬¦å·
```

### ä½¿ç”¨ wasm-opt

```bash
# å®‰è£… wasm-opt
npm install -g wasm-opt

# ä¼˜åŒ–äºŒè¿›åˆ¶å¤§å°
wasm-opt -Oz -o output.wasm input.wasm

# ä¼˜åŒ–æ‰§è¡Œæ€§èƒ½
wasm-opt -O3 -o output.wasm input.wasm

# åŒæ—¶ä¼˜åŒ–å¤§å°å’Œæ€§èƒ½
wasm-opt -O3 --strip-debug -o output.wasm input.wasm
```

### å‡å°‘ä¾èµ–

```toml
# åªå¼•å…¥éœ€è¦çš„ç‰¹æ€§
[dependencies]
some-crate = { version = "1.0", default-features = false, features = ["needed"] }
```

---

## âš¡ è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–

### å‡å°‘å†…å­˜åˆ†é…

```rust
// âŒ ä¸å¥½ï¼šæ¯æ¬¡éƒ½åˆ†é…æ–° Vec
pub fn process_bad(data: &[i32]) -> Vec<i32> {
    let mut result = Vec::new();
    for &item in data {
        result.push(item * 2);
    }
    result
}

// âœ… å¥½ï¼šé¢„åˆ†é…å®¹é‡
pub fn process_good(data: &[i32]) -> Vec<i32> {
    let mut result = Vec::with_capacity(data.len());
    for &item in data {
        result.push(item * 2);
    }
    result
}
```

### é‡ç”¨ç¼“å†²åŒº

```rust
// é‡ç”¨ Vec è€Œä¸æ˜¯é‡æ–°åˆ†é…
thread_local! {
    static BUFFER: RefCell<Vec<u8>> = RefCell::new(Vec::new());
}

pub fn process_with_reuse(data: &[u8]) -> Vec<u8> {
    BUFFER.with(|buf| {
        let mut buffer = buf.borrow_mut();
        buffer.clear();
        buffer.extend_from_slice(data);
        // ... å¤„ç†
        buffer.clone()
    })
}
```

### é¿å…ä¸å¿…è¦çš„å¤åˆ¶

```rust
// âŒ ä¸å¥½ï¼šä¸å¿…è¦çš„å…‹éš†
pub fn bad_example(s: String) -> String {
    s.clone()
}

// âœ… å¥½ï¼šä½¿ç”¨å¼•ç”¨æˆ–ç§»åŠ¨
pub fn good_example(s: &str) -> &str {
    s
}
```

---

## ğŸ§  å†…å­˜ä¼˜åŒ–

### ä½¿ç”¨æ ˆåˆ†é…

```rust
// å°æ•°æ®ä½¿ç”¨æ ˆåˆ†é…
const SMALL_SIZE: usize = 100;
let mut buffer: [u8; SMALL_SIZE] = [0; SMALL_SIZE];
```

### é¿å…å†…å­˜æ³„æ¼

```rust
// åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æº
{
    let data = expensive_operation();
    // ä½¿ç”¨ data
} // data åœ¨è¿™é‡Œè‡ªåŠ¨é‡Šæ”¾
```

### ä½¿ç”¨å¯¹è±¡æ± 

```rust
use std::collections::VecDeque;

pub struct ObjectPool<T> {
    pool: VecDeque<T>,
}

impl<T> ObjectPool<T> {
    pub fn new() -> Self {
        Self { pool: VecDeque::new() }
    }

    pub fn get(&mut self) -> Option<T> {
        self.pool.pop_front()
    }

    pub fn return_obj(&mut self, obj: T) {
        self.pool.push_back(obj);
    }
}
```

---

## ğŸš€ åŠ è½½ä¼˜åŒ–

### å‹ç¼©ä¼ è¾“

```bash
# ä½¿ç”¨ gzip å‹ç¼©
gzip -9 module.wasm

# ä½¿ç”¨ brotli å‹ç¼©ï¼ˆæ›´å¥½çš„å‹ç¼©ç‡ï¼‰
brotli -9 module.wasm
```

### å»¶è¿ŸåŠ è½½

```javascript
// æŒ‰éœ€åŠ è½½ WASM æ¨¡å—
async function loadWasmWhenNeeded() {
  const wasm = await import('./pkg/hello_wasm');
  await wasm.default();
  return wasm;
}

// ä½¿ç”¨
const wasm = await loadWasmWhenNeeded();
wasm.greet("World");
```

### é¢„åŠ è½½

```html
<!-- é¢„åŠ è½½ WASM æ¨¡å— -->
<link rel="preload" href="module.wasm" as="fetch" crossorigin>
```

---

## ğŸ”§ å·¥å…·æ¨è

### åˆ†æå·¥å…·

- **wasm-pack**: æ„å»ºå’Œä¼˜åŒ–å·¥å…·
- **wasm-opt**: Binaryen ä¼˜åŒ–å·¥å…·
- **cargo-bloat**: åˆ†æäºŒè¿›åˆ¶å¤§å°
- **wasm-bindgen**: ç”Ÿæˆç»‘å®šä»£ç 

### æ€§èƒ½åˆ†æ

```bash
# åˆ†æäºŒè¿›åˆ¶å¤§å°
cargo bloat --release --target wasm32-unknown-unknown

# ä½¿ç”¨ wasm-opt åˆ†æ
wasm-opt --print-function-sizes module.wasm
```

---

## ğŸ“š ç›¸å…³èµ„æº

- [Rust ç¼–è¯‘ WASM](./02_rust_ç¼–è¯‘_wasm.md) - å­¦ä¹ ç¼–è¯‘æµç¨‹
- [æ€§èƒ½åˆ†æä¸ä¼˜åŒ–](../tier_04_advanced/02_æ€§èƒ½åˆ†æä¸ä¼˜åŒ–.md) - é«˜çº§ä¼˜åŒ–
- [æœ€ä½³å®è·µ](../tier_03_references/03_æœ€ä½³å®è·µ.md) - å¼€å‘è§„èŒƒ

**å¤–éƒ¨èµ„æº**:

- [wasm-opt æ–‡æ¡£](https://github.com/WebAssembly/binaryen)
- [WASM æ€§èƒ½æŒ‡å—](https://web.dev/webassembly/)

---

**æ–‡æ¡£ç»´æŠ¤**: Documentation Team
**åˆ›å»ºæ—¥æœŸ**: 2025-10-30
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.92.0+ / Edition 2024, WASM 2.0 + WASI 0.2
