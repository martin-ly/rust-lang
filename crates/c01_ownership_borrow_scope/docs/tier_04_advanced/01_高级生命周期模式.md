# Tier 4: 高级生命周期模式

> **文档类型**: 高级主题
> **难度**: ⭐⭐⭐⭐⭐
> **适用版本**: Rust 1.92.0+

---

## 📊 目录

- [Tier 4: 高级生命周期模式](#tier-4-高级生命周期模式)
  - [📊 目录](#-目录)
  - [1. 高阶生命周期](#1-高阶生命周期)
    - [Higher-Rank Trait Bounds (HRTB)](#higher-rank-trait-bounds-hrtb)
  - [2. 生命周期子类型](#2-生命周期子类型)
  - [3. 协变与逆变](#3-协变与逆变)
    - [协变 (Covariance)](#协变-covariance)
    - [逆变 (Contravariance)](#逆变-contravariance)
  - [4. 生命周期约束](#4-生命周期约束)
  - [5. GAT (Generic Associated Types)](#5-gat-generic-associated-types)

## 1. 高阶生命周期

从引用一致性视角看，高阶生命周期（HRTB）是**类型层面的逻辑量化**，用于表达对任意生命周期的约束关系，而非内存地址的量化。

### Higher-Rank Trait Bounds (HRTB)

```rust
// for<'a> 语法
fn apply<F>(f: F)
where
    F: for<'a> Fn(&'a str) -> &'a str,
{
    let s = "hello";
    println!("{}", f(s));
}

// 使用
apply(|s| s);
```

---

## 2. 生命周期子类型

从引用一致性视角看，生命周期子类型表示的是**能力范围的逻辑关系**，而非物理内存的有效时间段。如果 `'a: 'b`，表示 `'a` 的能力范围包含 `'b` 的能力范围。

```rust
// 'static 是所有生命周期的子类型
fn longest<'a>(x: &'a str, y: &'static str) -> &'a str {
    if x.len() > y.len() { x } else { y }
}
```

---

## 3. 协变与逆变

从引用一致性视角看，协变和逆变表示的是**能力范围的逻辑关系**，而非物理内存地址的关系。

### 协变 (Covariance)

```rust
// 如果 'a: 'b，则 &'a T 可以转换为 &'b T
fn covariant<'a, 'b: 'a>(x: &'a str) -> &'b str {
    x
}
```

### 逆变 (Contravariance)

```rust
// 函数参数是逆变的
trait Trait<'a> {
    fn method(&self, x: &'a str);
}
```

---

## 4. 生命周期约束

```rust
// where 子句中的生命周期约束
fn complex<'a, 'b, T>(x: &'a T, y: &'b T) -> &'a T
where
    T: 'a + 'b,
{
    x
}
```

---

## 5. GAT (Generic Associated Types)

```rust
trait StreamingIterator {
    type Item<'a>
    where
        Self: 'a;

    fn next(&mut self) -> Option<Self::Item<'_>>;
}
```

---

**相关文档**:

- [Tier 3: 03_生命周期参考](../tier_03_references/03_生命周期参考.md)

---

**文档维护**: Documentation Team
**创建日期**: 2025-10-22
