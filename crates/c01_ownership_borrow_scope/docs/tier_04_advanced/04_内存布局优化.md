# Tier 4: å†…å­˜å¸ƒå±€ä¼˜åŒ–

> **æ–‡æ¡£ç±»å‹**: é«˜çº§ä¸»é¢˜
> **éš¾åº¦**: â­â­â­â­â­
> **é€‚ç”¨ç‰ˆæœ¬**: Rust 1.92.0+
> **å¯¹é½çŸ¥è¯†ç»¼åˆ**: [docs/02_reference/ALIGNMENT_GUIDE.md](../../../../docs/02_reference/ALIGNMENT_GUIDE.md)

---

## ğŸ“Š ç›®å½•

- [Tier 4: å†…å­˜å¸ƒå±€ä¼˜åŒ–](#tier-4-å†…å­˜å¸ƒå±€ä¼˜åŒ–)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [1. å†…å­˜å¯¹é½](#1-å†…å­˜å¯¹é½)
  - [2. #\[repr(packed)\]](#2-reprpacked)
  - [3. #\[repr(align(N))\]](#3-repralignn)
  - [4. å­—æ®µé‡æ’åº](#4-å­—æ®µé‡æ’åº)
  - [5. é›¶å¤§å°ç±»å‹ (ZST)](#5-é›¶å¤§å°ç±»å‹-zst)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)

## 1. å†…å­˜å¯¹é½

**å¯¹é½**ï¼šç±»å‹å®ä¾‹çš„åœ°å€å¿…é¡»æ˜¯ `align_of::<T>()` çš„æ•´æ•°å€ã€‚æ ‡é‡ç±»å‹é€šå¸¸ã€Œè‡ªç„¶å¯¹é½ã€ï¼ˆå¯¹é½ = å¤§å°ï¼‰ã€‚

```rust
use std::mem;

#[repr(C)]
struct Aligned {
    a: u8,
    _padding: [u8; 7],
    b: u64,
}

assert_eq!(mem::align_of::<Aligned>(), 8);
assert_eq!(mem::size_of::<Aligned>(), 16);
```

**å¸¸ç”¨ API**ï¼š`mem::align_of::<T>()`ã€`mem::size_of::<T>()`ã€`mem::align_of_val(v)`ã€‚

---

## 2. #[repr(packed)]

æ— å¡«å……ï¼Œå­—æ®µå¯èƒ½æœªå¯¹é½ï¼Œè®¿é—®è¾ƒæ…¢ï¼›FFI æ…ç”¨ã€‚

```rust
#[repr(packed)]
struct Packed {
    a: u8,
    b: u64,
    c: u8,
}

// size = 10 å­—èŠ‚ (æ— å¡«å……)
```

---

## 3. #[repr(align(N))]

å¼ºåˆ¶ N å­—èŠ‚å¯¹é½ï¼Œå¸¸ç”¨äºç¼“å­˜è¡Œï¼ˆ64 å­—èŠ‚ï¼‰é¿å…ä¼ªå…±äº«ã€‚

```rust
#[repr(align(64))] // ç¼“å­˜è¡Œå¯¹é½
struct CacheAligned {
    data: [u8; 64],
}
```

---

## 4. å­—æ®µé‡æ’åº

`#[repr(Rust)]`ï¼ˆé»˜è®¤ï¼‰å…è®¸ç¼–è¯‘å™¨é‡æ’å­—æ®µä»¥å‡å°‘å¡«å……ã€‚

```rust
// è‡ªåŠ¨ä¼˜åŒ–
#[repr(Rust)] // é»˜è®¤
struct Optimized {
    b: u64, // ç¼–è¯‘å™¨ä¼šé‡æ’
    a: u8,
    c: u8,
}
```

**å»ºè®®**ï¼šå¤§å­—æ®µå‰ç½®ï¼ˆu64 â†’ u32 â†’ u16 â†’ u8ï¼‰å¯å‡å°‘å¡«å……ã€‚

---

## 5. é›¶å¤§å°ç±»å‹ (ZST)

```rust
struct ZeroSized; // size = 0

let v = vec![ZeroSized; 1000]; // æ— å†…å­˜å¼€é”€
```

---

## 6. ç›¸å…³æ–‡æ¡£

- [Tier 4: 03\_æ‰€æœ‰æƒæ€§èƒ½ä¼˜åŒ–](./03_æ‰€æœ‰æƒæ€§èƒ½ä¼˜åŒ–.md)
- [09\_æ€§èƒ½ä¼˜åŒ–å‚è€ƒ](../tier_03_references/09_æ€§èƒ½ä¼˜åŒ–å‚è€ƒ.md) - æ•°æ®å¯¹é½å’Œå¡«å……ã€ç¼“å­˜å‹å¥½è®¾è®¡
- [08\_å†…å­˜å®‰å…¨å‚è€ƒ](../tier_03_references/08_å†…å­˜å®‰å…¨å‚è€ƒ.md) - å¯¹é½å’Œå¤§å°ã€FFI
- [ALIGNMENT_GUIDE](../../../../docs/02_reference/ALIGNMENT_GUIDE.md) - å¯¹é½çŸ¥è¯†ç»¼åˆæŒ‡å—ï¼ˆå†…å­˜/æ ¼å¼åŒ–/unsafe/ç¼“å­˜è¡Œï¼‰
- [type_system é€ŸæŸ¥å¡](../../../../docs/02_reference/quick_reference/type_system.md) - å†…å­˜å¯¹é½å°èŠ‚
- [c05 ç¼“å­˜è¡Œå¯¹é½](../../../c05_threads/docs/tier_04_advanced/02_ç³»ç»Ÿç¼–ç¨‹ä¼˜åŒ–.md#51-ç¼“å­˜è¡Œå¯¹é½) - å¹¶å‘åœºæ™¯

---

**æ–‡æ¡£ç»´æŠ¤**: Documentation Team
**åˆ›å»ºæ—¥æœŸ**: 2025-10-22
**æœ€åæ›´æ–°**: 2026-02-13ï¼ˆå¯¹é½çŸ¥è¯†æ‰©å±•ä¸äº¤å‰å¼•ç”¨ï¼‰
