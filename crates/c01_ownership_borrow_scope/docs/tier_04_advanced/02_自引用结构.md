# Tier 4: 自引用结构

> **文档类型**: 高级主题  
> **难度**: ⭐⭐⭐⭐⭐  
> **适用版本**: Rust 1.90+

---

## 1. 自引用问题

```rust
// ❌ 无法编译 - 自引用
// struct SelfRef {
//     data: String,
//     ptr: &str, // 指向 data 的引用
// }
```

---

## 2. Pin 和 Unpin

### Pin 的基本概念

```rust
use std::pin::Pin;
use std::marker::PhantomPinned;

struct SelfReferential {
    data: String,
    ptr: *const String,
    _pin: PhantomPinned,
}

impl SelfReferential {
    fn new(data: String) -> Pin<Box<Self>> {
        let mut boxed = Box::pin(SelfReferential {
            data,
            ptr: std::ptr::null(),
            _pin: PhantomPinned,
        });

        unsafe {
            let ptr = &boxed.data as *const String;
            let mut_ref = Pin::as_mut(&mut boxed);
            let inner = Pin::get_unchecked_mut(mut_ref);
            inner.ptr = ptr;
        }

        boxed
    }

    fn data(&self) -> &str {
        &self.data
    }

    fn ptr_data(&self) -> &str {
        unsafe { &*self.ptr }
    }
}
```

---

## 3. 使用 ouroboros 库

```rust
use ouroboros::self_referencing;

#[self_referencing]
struct MyStruct {
    data: String,
    #[borrows(data)]
    data_ref: &'this str,
}

let my_struct = MyStructBuilder {
    data: "Hello, world!".to_string(),
    data_ref_builder: |data| data.as_str(),
}.build();
```

---

## 4. Async 中的自引用

```rust
async fn async_self_ref() {
    let data = String::from("hello");
    let data_ref = &data;
    
    some_await().await; // Pin 确保安全
    
    println!("{}", data_ref);
}
```

---

**相关文档**:

- [C06 Async](../../../c06_async/)

---

**文档维护**: Documentation Team  
**创建日期**: 2025-10-22
