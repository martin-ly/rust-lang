# Tier 3: 借用检查器详解

> **文档类型**: 技术参考  
> **适用版本**: Rust 1.90+  
> **主题**: 借用检查器工作原理和规则

---

## 目录

- [1. 借用检查器概述](#1-借用检查器概述)
- [2. 借用规则](#2-借用规则)
- [3. NLL (Non-Lexical Lifetimes)](#3-nll-non-lexical-lifetimes)
- [4. 借用检查算法](#4-借用检查算法)
- [5. 常见错误解析](#5-常见错误解析)

---

## 1. 借用检查器概述

借用检查器 (Borrow Checker) 是 Rust 编译器的核心组件，负责在编译时验证所有权和借用规则。

**主要职责**:

- ✅ 检查借用规则
- ✅ 防止数据竞争
- ✅ 确保内存安全
- ✅ 验证生命周期

---

## 2. 借用规则

**核心规则**:

1. **不可变借用规则**: 可以有多个不可变引用

   ```rust
   let s = String::from("hello");
   let r1 = &s; // ✅
   let r2 = &s; // ✅
   ```

2. **可变借用规则**: 只能有一个可变引用

   ```rust
   let mut s = String::from("hello");
   let r1 = &mut s; // ✅
   // let r2 = &mut s; // ❌ 编译错误
   ```

3. **混合借用规则**: 不能同时有可变和不可变引用

   ```rust
   let mut s = String::from("hello");
   let r1 = &s; // ✅
   // let r2 = &mut s; // ❌ 编译错误
   ```

---

## 3. NLL (Non-Lexical Lifetimes)

**NLL 优化** (Rust 2018+):

借用的生命周期不再严格基于作用域，而是基于**最后一次使用**。

```rust
let mut s = String::from("hello");

let r1 = &s;
let r2 = &s;
println!("{} and {}", r1, r2);
// r1 和 r2 在此之后不再使用

let r3 = &mut s; // ✅ NLL 允许
println!("{}", r3);
```

**传统作用域 vs NLL**:

```text
传统 (Lexical):
let r1 = &s;      ├── r1 生命周期开始
let r2 = &s;      │   ├── r2 生命周期开始
...               │   │
}                 ┴── r1, r2 生命周期结束

NLL:
let r1 = &s;      ├── r1 生命周期开始
println!("{}", r1); ┴── r1 最后一次使用，生命周期结束
let r2 = &mut s;  ✅ 可以可变借用
```

---

## 4. 借用检查算法

**检查流程**:

1. **建立借用图**: 分析所有借用关系
2. **生命周期推断**: 计算引用的生命周期
3. **冲突检测**: 检查是否违反借用规则
4. **错误报告**: 生成友好的错误信息

**示例**:

```rust
fn main() {
    let mut x = 5;
    let y = &mut x;   // 可变借用开始
    *y += 1;          // 使用可变借用
    println!("{}", x); // ❌ 借用冲突
    //              ^
    //              y 的借用仍在此处活跃
}
```

---

## 5. 常见错误解析

### 错误 1: Cannot borrow as mutable

```rust
let s = String::from("hello");
// s.push_str(", world"); // ❌ cannot borrow as mutable

let mut s = String::from("hello");
s.push_str(", world"); // ✅
```

---

### 错误 2: Cannot borrow as mutable more than once

```rust
let mut s = String::from("hello");
let r1 = &mut s;
// let r2 = &mut s; // ❌ cannot borrow as mutable more than once
```

---

### 错误 3: Cannot borrow as mutable because it is also borrowed as immutable

```rust
let mut s = String::from("hello");
let r1 = &s;
// let r2 = &mut s; // ❌ cannot borrow
println!("{}", r1);
```

---

**相关文档**:

- [Tier 2: 02_借用实践指南](../tier_02_guides/02_借用实践指南.md)
- [Tier 4: 01_高级生命周期模式](../tier_04_advanced/01_高级生命周期模式.md)

---

**文档维护**: Documentation Team  
**创建日期**: 2025-10-22  
**适用版本**: Rust 1.90+
