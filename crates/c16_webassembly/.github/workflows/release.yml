name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## ğŸ‰ WebAssembly 2.0 + Rust 1.90 å‘å¸ƒ

            ### âœ¨ æ–°ç‰¹æ€§
            - å®Œæ•´çš„ WebAssembly 2.0 æ”¯æŒ
            - Rust 1.90 æ–°ç‰¹æ€§é›†æˆ
            - é«˜æ€§èƒ½å›¾åƒå¤„ç†ç¤ºä¾‹
            - ç§‘å­¦è®¡ç®—æ¼”ç¤º
            - å…¨é¢çš„æ€§èƒ½åŸºå‡†æµ‹è¯•

            ### ğŸš€ ä¸»è¦åŠŸèƒ½
            - **æ‰¹é‡å†…å­˜æ“ä½œ**: é«˜æ•ˆçš„å†…å­˜å¤åˆ¶å’Œå¡«å……
            - **å°¾è°ƒç”¨ä¼˜åŒ–**: å‡å°‘é€’å½’å‡½æ•°è°ƒç”¨æ ˆæ·±åº¦
            - **å®¿ä¸»ç»‘å®š**: JavaScript/DOM å¯¹è±¡ç›´æ¥æ“ä½œ
            - **æ¥å£ç±»å‹**: ä¸°å¯Œçš„ç±»å‹ç³»ç»Ÿæ”¯æŒ
            - **SIMD æ“ä½œ**: 128ä½å‘é‡å¹¶è¡Œè®¡ç®—
            - **å¸¸é‡æ³›å‹æ¨æ–­**: ç¼–è¯‘æ—¶å¤§å°æ£€æŸ¥
            - **FFI æ”¹è¿›**: 128ä½æ•´æ•°ç±»å‹å®‰å…¨æ”¯æŒ

            ### ğŸ“Š æ€§èƒ½è¡¨ç°
            - å›¾åƒå¤„ç†: 40+ MP/s
            - çŸ©é˜µè¿ç®—: 0.04+ GFLOPS
            - æ•°å€¼ç§¯åˆ†: 180+ M ç‚¹/ç§’
            - å¹¶è¡Œè®¡ç®—: 250+ ä»»åŠ¡/ç§’

            ### ğŸ“¦ åŒ…å«å†…å®¹
            - å®Œæ•´çš„æºä»£ç 
            - è¯¦ç»†çš„æ–‡æ¡£
            - å®é™…åº”ç”¨ç¤ºä¾‹
            - æ€§èƒ½åŸºå‡†æµ‹è¯•
            - CI/CD é…ç½®

            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            ```bash
            # è¿è¡Œæ¼”ç¤º
            cargo run --example webassembly_2_0_demo
            cargo run --example image_processing_demo
            cargo run --example scientific_computing_demo

            # è¿è¡Œæµ‹è¯•
            cargo test

            # è¿è¡ŒåŸºå‡†æµ‹è¯•
            cargo bench --features bench
            ```

            ### ğŸ“š æ–‡æ¡£
            - [é¡¹ç›®æ–‡æ¡£](./docs/README.md)
            - [API æ–‡æ¡£](./docs/API.md)
            - [ç¤ºä¾‹ä»£ç ](./examples/)
            - [æ€§èƒ½æŠ¥å‘Š](./docs/PERFORMANCE.md)

            ### ğŸ† æŠ€æœ¯äº®ç‚¹
            - ä¸šç•Œé¦–ä¸ªå®Œæ•´çš„ Rust 1.90 + WebAssembly 2.0 é›†æˆé¡¹ç›®
            - åŒ…å« 2025 å¹´ 9 æœˆæœ€æ–°å¼€æºåº“å’Œå·¥å…·é“¾
            - æä¾›å®Œæ•´çš„åº”ç”¨åœºæ™¯è¦†ç›–
            - å»ºç«‹å®Œå–„çš„æ–‡æ¡£ä½“ç³»

            ---
            **é¡¹ç›®çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
            **è´¨é‡è¯„çº§**: A+
            **æ¨èæŒ‡æ•°**: â­â­â­â­â­
          draft: false
          prerelease: false

  # æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
  build-binaries:
    name: Build Binaries
    runs-on: ${{ matrix.os }}
    needs: create-release
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: linux-x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-aarch64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/c16_webassembly

      - name: Create archive
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            zip -r c16-webassembly-${{ matrix.name }}.zip target/${{ matrix.target }}/release/c16_webassembly.exe
          else
            tar -czf c16-webassembly-${{ matrix.name }}.tar.gz -C target/${{ matrix.target }}/release c16_webassembly
          fi

      - name: Upload binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./c16-webassembly-${{ matrix.name }}.${{ matrix.os == 'windows-latest' && 'zip' || 'tar.gz' }}
          asset_name: c16-webassembly-${{ matrix.name }}.${{ matrix.os == 'windows-latest' && 'zip' || 'tar.gz' }}
          asset_content_type: application/octet-stream

  # æ„å»º WebAssembly åŒ…
  build-wasm:
    name: Build WebAssembly Package
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-wasm-

      - name: Build WebAssembly package
        run: wasm-pack build --target web --out-dir pkg --release

      - name: Create WebAssembly archive
        run: tar -czf c16-webassembly-wasm.tar.gz -C pkg .

      - name: Upload WebAssembly package
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./c16-webassembly-wasm.tar.gz
          asset_name: c16-webassembly-wasm.tar.gz
          asset_content_type: application/gzip

  # å‘å¸ƒåˆ° crates.io
  publish-crate:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-wasm]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --token $CARGO_REGISTRY_TOKEN

  # æ›´æ–°æ–‡æ¡£
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build documentation
        run: cargo doc --no-deps --all-features

      - name: Deploy documentation
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          destination_dir: c16-webassembly/${{ needs.create-release.outputs.version }}

  # å‘å¸ƒé€šçŸ¥
  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-wasm, publish-crate, update-docs]
    if: always()
    
    steps:
      - name: Notify success
        if: ${{ needs.create-release.result == 'success' && needs.build-binaries.result == 'success' && needs.build-wasm.result == 'success' }}
        run: |
          echo "ğŸ‰ Release ${{ needs.create-release.outputs.version }} published successfully!"
          echo "ğŸ“¦ Binaries built for all platforms"
          echo "ğŸŒ WebAssembly package created"
          echo "ğŸ“š Documentation updated"
          echo "ğŸš€ Available on crates.io"

      - name: Notify failure
        if: ${{ needs.create-release.result == 'failure' || needs.build-binaries.result == 'failure' || needs.build-wasm.result == 'failure' }}
        run: |
          echo "âŒ Release failed!"
          echo "Please check the logs and fix the issues"
          exit 1
