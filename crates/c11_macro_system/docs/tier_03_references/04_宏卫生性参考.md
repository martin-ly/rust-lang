# å®å«ç”Ÿæ€§å®Œæ•´å‚è€ƒ

**æœ€åæ›´æ–°**: 2025-12-11
**é€‚ç”¨ç‰ˆæœ¬**: Rust 1.92.0+

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Rust å®çš„å«ç”Ÿæ€§(Hygiene)æœºåˆ¶ã€ä½œç”¨åŸŸè§„åˆ™å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“‹ ç›®å½•

- [å®å«ç”Ÿæ€§å®Œæ•´å‚è€ƒ](#å®å«ç”Ÿæ€§å®Œæ•´å‚è€ƒ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. å«ç”Ÿæ€§åŸºç¡€](#1-å«ç”Ÿæ€§åŸºç¡€)
    - [1.1 ä»€ä¹ˆæ˜¯å«ç”Ÿæ€§](#11-ä»€ä¹ˆæ˜¯å«ç”Ÿæ€§)
    - [1.2 ä¸ºä»€ä¹ˆéœ€è¦å«ç”Ÿæ€§](#12-ä¸ºä»€ä¹ˆéœ€è¦å«ç”Ÿæ€§)
    - [1.3 Rust çš„å«ç”Ÿæ€§æ¨¡å‹](#13-rust-çš„å«ç”Ÿæ€§æ¨¡å‹)
  - [2. å£°æ˜å®å«ç”Ÿæ€§](#2-å£°æ˜å®å«ç”Ÿæ€§)
    - [2.1 å±€éƒ¨å˜é‡](#21-å±€éƒ¨å˜é‡)
    - [2.2 å‡½æ•°å’Œç±»å‹](#22-å‡½æ•°å’Œç±»å‹)
    - [2.3 æ¨¡å—å’Œå¯¼å…¥](#23-æ¨¡å—å’Œå¯¼å…¥)
  - [3. è¿‡ç¨‹å® Span](#3-è¿‡ç¨‹å®-span)
    - [3.1 call\_site()](#31-call_site)
    - [3.2 def\_site()](#32-def_site)
    - [3.3 mixed\_site()](#33-mixed_site)
  - [4. ä½œç”¨åŸŸè§„åˆ™](#4-ä½œç”¨åŸŸè§„åˆ™)
    - [4.1 å£°æ˜å®ä½œç”¨åŸŸ](#41-å£°æ˜å®ä½œç”¨åŸŸ)
    - [4.2 è¿‡ç¨‹å®ä½œç”¨åŸŸ](#42-è¿‡ç¨‹å®ä½œç”¨åŸŸ)
    - [4.3 è·¨ crate ä½œç”¨åŸŸ](#43-è·¨-crate-ä½œç”¨åŸŸ)
  - [5. æ‰“ç ´å«ç”Ÿæ€§](#5-æ‰“ç ´å«ç”Ÿæ€§)
    - [5.1 ä½•æ—¶éœ€è¦](#51-ä½•æ—¶éœ€è¦)
    - [5.2 å£°æ˜å®æŠ€å·§](#52-å£°æ˜å®æŠ€å·§)
    - [5.3 è¿‡ç¨‹å®æŠ€å·§](#53-è¿‡ç¨‹å®æŠ€å·§)
  - [6. å¸¸è§é—®é¢˜](#6-å¸¸è§é—®é¢˜)
    - [6.1 å˜é‡æ•è·](#61-å˜é‡æ•è·)
    - [6.2 ç±»å‹è§£æ](#62-ç±»å‹è§£æ)
    - [6.3 trait è§£æ](#63-trait-è§£æ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 è®¾è®¡åŸåˆ™](#71-è®¾è®¡åŸåˆ™)
    - [7.2 è°ƒè¯•æŠ€å·§](#72-è°ƒè¯•æŠ€å·§)
  - [8. é«˜çº§ä¸»é¢˜](#8-é«˜çº§ä¸»é¢˜)
    - [8.1 å® 2.0 (æœªç¨³å®š)](#81-å®-20-æœªç¨³å®š)
    - [8.2 ä¸å…¶ä»–è¯­è¨€å¯¹æ¯”](#82-ä¸å…¶ä»–è¯­è¨€å¯¹æ¯”)

---

## 1. å«ç”Ÿæ€§åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯å«ç”Ÿæ€§

**å«ç”Ÿæ€§ (Hygiene)** æ˜¯æŒ‡å®å±•å¼€åï¼Œå®å†…å¤–çš„æ ‡è¯†ç¬¦ä¸ä¼šæ„å¤–å†²çªçš„ç‰¹æ€§ã€‚

**å«ç”Ÿå®**:

- å®å†…å®šä¹‰çš„å˜é‡ä¸æ³„éœ²åˆ°å¤–éƒ¨
- å®å¤–çš„å˜é‡ä¸è¢«å®æ„å¤–æ•è·

**éå«ç”Ÿå®** (C/C++):

```c
#define SWAP(a, b) { int temp = a; a = b; b = temp; }

int temp = 1;
int x = 2, y = 3;
SWAP(x, y);  // âŒ temp è¢«è¦†ç›–ï¼
```

---

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å«ç”Ÿæ€§

**é—®é¢˜åœºæ™¯**:

```rust
// å‡è®¾å®ä¸å«ç”Ÿ
macro_rules! bad_macro {
    ($e:expr) => {
        {
            let result = $e;  // å¦‚æœä¸å«ç”Ÿï¼Œå¯èƒ½å†²çª
            result * 2
        }
    };
}

let result = 10;
let x = bad_macro!(result + 1);  // å¦‚æœä¸å«ç”Ÿä¼šæœ‰é—®é¢˜
```

**å«ç”Ÿæ€§çš„å¥½å¤„**:

1. é¿å…æ„å¤–çš„åç§°å†²çª
2. æé«˜å®çš„å¯ç»„åˆæ€§
3. ä½¿å®è¡Œä¸ºå¯é¢„æµ‹

---

### 1.3 Rust çš„å«ç”Ÿæ€§æ¨¡å‹

Rust ä½¿ç”¨ **è¯­æ³•ä¸Šä¸‹æ–‡ (Syntax Context)** è¿½è¸ªæ ‡è¯†ç¬¦æ¥æºï¼š

```rust
macro_rules! demo {
    () => {
        let x = 1;  // x æœ‰ "å®å®šä¹‰" ä¸Šä¸‹æ–‡
    };
}

let x = 0;      // x æœ‰ "è°ƒç”¨ç‚¹" ä¸Šä¸‹æ–‡
demo!();
println!("{}", x);  // 0ï¼Œä½¿ç”¨è°ƒç”¨ç‚¹çš„ x
```

**å…³é”®æ¦‚å¿µ**:

- æ¯ä¸ªæ ‡è¯†ç¬¦éƒ½æœ‰å…³è”çš„ **Span**
- Span åŒ…å« **Syntax Context**
- ä¸åŒä¸Šä¸‹æ–‡çš„åŒåæ ‡è¯†ç¬¦è¢«è§†ä¸ºä¸åŒ

---

## 2. å£°æ˜å®å«ç”Ÿæ€§

### 2.1 å±€éƒ¨å˜é‡

```rust
macro_rules! with_temp {
    ($e:expr) => {
        {
            let temp = $e;  // å®å®šä¹‰çš„ temp
            temp * 2
        }
    };
}

let temp = 10;
let result = with_temp!(5);  // 15
println!("temp = {}", temp); // 10ï¼Œä¸å—å½±å“
```

**è§„åˆ™**:

- å®å†…å®šä¹‰çš„å±€éƒ¨å˜é‡ **ä¸ä¼š** æ³„éœ²åˆ°å¤–éƒ¨
- å®å¤–çš„å±€éƒ¨å˜é‡ **ä¸ä¼š** è¢«å®å†…å¼•ç”¨ï¼ˆé™¤éé€šè¿‡ `$var`ï¼‰

---

### 2.2 å‡½æ•°å’Œç±»å‹

```rust
macro_rules! call_helper {
    () => {
        helper_function()
    };
}

fn helper_function() -> i32 {
    42
}

// âœ… å¦‚æœ helper_function åœ¨è°ƒç”¨ç‚¹ä½œç”¨åŸŸå†…å¯è§
let result = call_helper!();  // OK

// âŒ å¦‚æœ helper_function ä¸åœ¨ä½œç”¨åŸŸå†…
mod inner {
    // let result = call_helper!();  // é”™è¯¯ï¼
}
```

**è§„åˆ™**:

- å®å†…å¼•ç”¨çš„å‡½æ•°/ç±»å‹ï¼Œåœ¨ **è°ƒç”¨ç‚¹** è§£æ
- ä½¿ç”¨å®Œæ•´è·¯å¾„é¿å…æ­§ä¹‰ï¼š`::std::vec::Vec`

---

### 2.3 æ¨¡å—å’Œå¯¼å…¥

```rust
macro_rules! use_hashmap {
    () => {
        {
            use std::collections::HashMap;  // å¯¼å…¥åœ¨å®å†…
            let mut map = HashMap::new();
            map.insert("key", "value");
            map
        }
    };
}

// HashMap ä¸åœ¨å¤–éƒ¨ä½œç”¨åŸŸ
let map = use_hashmap!();
// let another = HashMap::new();  // é”™è¯¯ï¼HashMap æœªå¯¼å…¥
```

**è§„åˆ™**:

- `use` è¯­å¥åœ¨å®å†…ç”Ÿæ•ˆ
- ä¸ä¼šå½±å“å¤–éƒ¨ä½œç”¨åŸŸ

---

## 3. è¿‡ç¨‹å® Span

### 3.1 call_site()

**æœ€å«ç”Ÿçš„é€‰æ‹©**ï¼Œæ ‡è¯†ç¬¦ä½¿ç”¨è°ƒç”¨ç‚¹çš„ä½œç”¨åŸŸï¼š

```rust
use proc_macro::Span;
use quote::quote;

let ident = syn::Ident::new("result", Span::call_site());

quote! {
    let #ident = 42;  // ä½¿ç”¨è°ƒç”¨ç‚¹ä½œç”¨åŸŸ
}
```

**æ•ˆæœ**:

```rust
// è°ƒç”¨
my_macro!();

// å±•å¼€ä¸ºï¼ˆæ¦‚å¿µä¸Šï¼‰
let result = 42;  // result åœ¨è°ƒç”¨ç‚¹ä½œç”¨åŸŸ
```

---

### 3.2 def_site()

**ä¸å«ç”Ÿ**ï¼Œæ ‡è¯†ç¬¦ä½¿ç”¨å®å®šä¹‰ç‚¹çš„ä½œç”¨åŸŸï¼ˆéœ€è¦ nightlyï¼‰ï¼š

```rust
#![feature(proc_macro_def_site)]

use proc_macro::Span;

let ident = syn::Ident::new("internal_var", Span::def_site());

quote! {
    let #ident = 42;  // internal_var åœ¨å®å®šä¹‰ä½œç”¨åŸŸ
}
```

**ç”¨é€”**:

- å®å†…éƒ¨è¾…åŠ©å˜é‡
- é¿å…ä¸ç”¨æˆ·ä»£ç å†²çª

---

### 3.3 mixed_site()

**æŠ˜ä¸­æ–¹æ¡ˆ**ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼ˆRust 1.45+ï¼‰ï¼š

```rust
use proc_macro::Span;

let ident = syn::Ident::new("helper", Span::mixed_site());

quote! {
    fn #ident() {  // helper ä½¿ç”¨æ··åˆä¸Šä¸‹æ–‡
        // ...
    }
}
```

**ç‰¹ç‚¹**:

- å¯¹ `macro_rules!` æ‰©å±•æ›´å‹å¥½
- å¹³è¡¡å«ç”Ÿæ€§å’Œçµæ´»æ€§

---

## 4. ä½œç”¨åŸŸè§„åˆ™

### 4.1 å£°æ˜å®ä½œç”¨åŸŸ

```rust
macro_rules! outer {
    () => {
        macro_rules! inner {  // å†…éƒ¨å®
            () => { 42 };
        }
        inner!()  // âœ… å¯ä»¥è°ƒç”¨
    };
}

let x = outer!();  // 42
// inner!();  // âŒ inner ä¸åœ¨ä½œç”¨åŸŸ
```

**è§„åˆ™**:

- å®å¯ä»¥å®šä¹‰å®
- å†…éƒ¨å®ä½œç”¨åŸŸé™äºå¤–éƒ¨å®å±•å¼€çš„ä»£ç å—

---

### 4.2 è¿‡ç¨‹å®ä½œç”¨åŸŸ

```rust
use quote::quote;

#[proc_macro]
pub fn gen_code(_input: TokenStream) -> TokenStream {
    quote! {
        mod internal {
            pub fn helper() -> i32 { 42 }
        }

        internal::helper()  // å¯è®¿é—®
    }.into()
}

// ä½¿ç”¨
let x = gen_code!();
// internal::helper();  // âŒ internal ä¸åœ¨å¤–éƒ¨ä½œç”¨åŸŸ
```

**è§„åˆ™**:

- å®ç”Ÿæˆçš„é¡¹ï¼ˆå‡½æ•°ã€ç»“æ„ä½“ã€æ¨¡å—ï¼‰åœ¨å±•å¼€ä½ç½®å¯è§
- é™¤éæ˜ç¡®æ ‡è®° `pub`ï¼Œå¦åˆ™ä¸ä¼šæ³„éœ²åˆ°å¤–éƒ¨

---

### 4.3 è·¨ crate ä½œç”¨åŸŸ

```rust
// åº“ crate
#[macro_export]
macro_rules! my_macro {
    () => {
        // ä½¿ç”¨å®Œæ•´è·¯å¾„
        ::std::vec::Vec::<i32>::new()
    };
}

// ç”¨æˆ· crate
use my_crate::my_macro;

let v = my_macro!();  // âœ… å³ä½¿æœªå¯¼å…¥ Vec
```

**æœ€ä½³å®è·µ**:

- è·¨ crate å®ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼š`::std::...`
- é¿å…ä¾èµ–è°ƒç”¨ç‚¹çš„å¯¼å…¥

---

## 5. æ‰“ç ´å«ç”Ÿæ€§

### 5.1 ä½•æ—¶éœ€è¦

**åˆç†åœºæ™¯**:

1. DSL å®éœ€è¦è®¿é—®å¤–éƒ¨å˜é‡
2. æµ‹è¯•æ¡†æ¶éœ€è¦æ³¨å…¥å˜é‡
3. ç‰¹å®šé¢†åŸŸçº¦å®š

**ç¤ºä¾‹**:

```rust
// æµ‹è¯•æ¡†æ¶
macro_rules! assert_eq_with_context {
    ($left:expr, $right:expr) => {
        {
            let left_val = $left;
            let right_val = $right;
            assert_eq!(left_val, right_val,
                "Assertion failed in test");
        }
    };
}
```

---

### 5.2 å£°æ˜å®æŠ€å·§

**æŠ€å·§ 1: çº¦å®šçš„å˜é‡å**:

```rust
macro_rules! with_context {
    ($body:expr) => {
        {
            let ctx = Context::new();  // çº¦å®šåç§°
            $body  // ç”¨æˆ·ä»£ç å¯è®¿é—® ctx
        }
    };
}

// ä½¿ç”¨
with_context!({
    ctx.do_something();  // âŒ å®é™…ä¸è¡Œï¼Œå› ä¸ºå«ç”Ÿæ€§
});
```

**æŠ€å·§ 2: æ˜¾å¼å‚æ•°**:

```rust
macro_rules! with_context {
    ($ctx:ident, $body:expr) => {
        {
            let $ctx = Context::new();  // ç”¨æˆ·æŒ‡å®šåç§°
            $body
        }
    };
}

// ä½¿ç”¨
with_context!(ctx, {
    ctx.do_something();  // âœ… å¯ä»¥è®¿é—®
});
```

---

### 5.3 è¿‡ç¨‹å®æŠ€å·§

**ä½¿ç”¨ `Span::call_site()` + çº¦å®š**:

```rust
use proc_macro::Span;
use quote::quote;

#[proc_macro_attribute]
pub fn inject_var(_attr: TokenStream, item: TokenStream) -> TokenStream {
    let item: syn::ItemFn = syn::parse(item).unwrap();

    // ä½¿ç”¨ call_siteï¼Œè®©æ ‡è¯†ç¬¦åœ¨ç”¨æˆ·ä½œç”¨åŸŸ
    let injected = syn::Ident::new("injected_var", Span::call_site());

    quote! {
        #item

        // ç”¨æˆ·å‡½æ•°å¯ä»¥è®¿é—® injected_var
        let #injected = 42;
    }.into()
}
```

---

## 6. å¸¸è§é—®é¢˜

### 6.1 å˜é‡æ•è·

**é—®é¢˜**:

```rust
macro_rules! double {
    ($x:ident) => {
        $x * 2  // âœ… æ•è·ç”¨æˆ·çš„ $x
    };
}

let value = 10;
let result = double!(value);  // 20
```

**æ³¨æ„**:

- `$x:ident` æ•è·æ ‡è¯†ç¬¦ï¼Œä¿ç•™å…¶ä¸Šä¸‹æ–‡
- `$x:expr` æ•è·è¡¨è¾¾å¼ï¼Œåœ¨å®å†…æ±‚å€¼

---

### 6.2 ç±»å‹è§£æ

**é—®é¢˜**:

```rust
macro_rules! use_vec {
    () => {
        Vec::new()  // âŒ å¦‚æœ Vec æœªå¯¼å…¥
    };
}

// è§£å†³ï¼šä½¿ç”¨å®Œæ•´è·¯å¾„
macro_rules! use_vec {
    () => {
        ::std::vec::Vec::new()  // âœ…
    };
}
```

---

### 6.3 trait è§£æ

**é—®é¢˜**:

```rust
macro_rules! default_value {
    ($t:ty) => {
        <$t>::default()  // âŒ å¦‚æœ Default æœªå¯¼å…¥
    };
}

// è§£å†³
macro_rules! default_value {
    ($t:ty) => {
        <$t as ::std::default::Default>::default()  // âœ…
    };
}
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 è®¾è®¡åŸåˆ™

1. **é»˜è®¤ä½¿ç”¨å«ç”Ÿå®**

   ```rust
   macro_rules! good {
       ($e:expr) => {
           {
               let _temp = $e;  // ä½¿ç”¨ _ å‰ç¼€é¿å…å†²çª
               _temp
           }
       };
   }
   ```

2. **ä½¿ç”¨å®Œæ•´è·¯å¾„**

   ```rust
   macro_rules! safe {
       () => {
           ::std::vec::Vec::<i32>::new()
       };
   }
   ```

3. **æ˜ç¡®æ–‡æ¡£åŒ–éå«ç”Ÿè¡Œä¸º**

   ```rust
   /// âš ï¸ æ­¤å®ä¼šåœ¨å½“å‰ä½œç”¨åŸŸå®šä¹‰ `result` å˜é‡
   macro_rules! defines_result {
       ($e:expr) => {
           let result = $e;
       };
   }
   ```

---

### 7.2 è°ƒè¯•æŠ€å·§

**æŠ€å·§ 1: ä½¿ç”¨ cargo expand**:

```bash
cargo expand my_module::my_function
```

**æŠ€å·§ 2: æ·»åŠ è¯Šæ–­**:

```rust
macro_rules! debug_hygiene {
    ($x:ident) => {
        {
            let local = 42;
            println!("Macro local: {}", local);
            println!("User var: {}", $x);
        }
    };
}
```

**æŠ€å·§ 3: å•å…ƒæµ‹è¯•**:

```rust
#[test]
fn test_hygiene() {
    let local = 10;
    my_macro!(local);
    assert_eq!(local, 10);  // ç¡®ä¿æœªè¢«ä¿®æ”¹
}
```

---

## 8. é«˜çº§ä¸»é¢˜

### 8.1 å® 2.0 (æœªç¨³å®š)

```rust
#![feature(decl_macro)]

pub macro my_macro($e:expr) {
    $e * 2
}
```

**ç‰¹æ€§**:

- æ›´å¥½çš„å«ç”Ÿæ€§æ§åˆ¶
- æ›´çµæ´»çš„å¯¼å‡º
- æ”¹è¿›çš„ä½œç”¨åŸŸè§„åˆ™

---

### 8.2 ä¸å…¶ä»–è¯­è¨€å¯¹æ¯”

| è¯­è¨€     | å«ç”Ÿæ€§  | æœºåˆ¶           |
| :--- | :--- | :--- || **Rust** | âœ… æ˜¯   | Syntax Context |
| C/C++    | âŒ å¦   | æ–‡æœ¬æ›¿æ¢       |
| Scheme   | âœ… æ˜¯   | Syntax Objects |
| Lisp     | âš ï¸ éƒ¨åˆ† | ä¾èµ–å®ç°       |
| Scala    | âš ï¸ éƒ¨åˆ† | å‡†å¼•ç”¨         |

---

**ç›¸å…³æ–‡æ¡£**:

- [å£°æ˜å®å®Œæ•´å‚è€ƒ](./01_å£°æ˜å®å®Œæ•´å‚è€ƒ.md)
- [è¿‡ç¨‹å®APIå‚è€ƒ](./02_è¿‡ç¨‹å®APIå‚è€ƒ.md)
- [syn-quoteå‚è€ƒ](./03_syn-quoteå‚è€ƒ.md)
