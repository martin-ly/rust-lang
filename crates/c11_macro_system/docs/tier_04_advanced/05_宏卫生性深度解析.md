# å®å«ç”Ÿæ€§æ·±åº¦è§£æ

> **æ–‡æ¡£ç±»å‹**: Tier 4 - é«˜çº§ä¸»é¢˜
> **éš¾åº¦**: â­â­â­â­â­ ä¸“å®¶
> **æœ€åæ›´æ–°**: 2026-02-28

---

## ğŸ“‹ ç›®å½•

- [å®å«ç”Ÿæ€§æ·±åº¦è§£æ](#å®å«ç”Ÿæ€§æ·±åº¦è§£æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ä»€ä¹ˆæ˜¯å®å«ç”Ÿæ€§](#1-ä»€ä¹ˆæ˜¯å®å«ç”Ÿæ€§)
  - [2. è¯­æ³•ä¸Šä¸‹æ–‡ (Syntax Context)](#2-è¯­æ³•ä¸Šä¸‹æ–‡-syntax-context)
    - [2.1 æ ¸å¿ƒæ¦‚å¿µ](#21-æ ¸å¿ƒæ¦‚å¿µ)
    - [2.2 ä¸Šä¸‹æ–‡æ ‡è®°](#22-ä¸Šä¸‹æ–‡æ ‡è®°)
  - [3. æ ‡è¯†ç¬¦åˆ†ç±»](#3-æ ‡è¯†ç¬¦åˆ†ç±»)
    - [3.1 ç»‘å®š (Binding)](#31-ç»‘å®š-binding)
    - [3.2 å¼•ç”¨ (Reference)](#32-å¼•ç”¨-reference)
    - [3.3 æ ‡ç­¾ (Label)](#33-æ ‡ç­¾-label)
  - [4. è·¨ Crate å«ç”Ÿæ€§](#4-è·¨-crate-å«ç”Ÿæ€§)
    - [4.1 å¯¼å‡ºå®çš„å«ç”Ÿæ€§](#41-å¯¼å‡ºå®çš„å«ç”Ÿæ€§)
  - [5. æ‰“ç ´å«ç”Ÿæ€§ (æ•…æ„)](#5-æ‰“ç ´å«ç”Ÿæ€§-æ•…æ„)
    - [5.1 ä½¿ç”¨ `Span::mixed_site()`](#51-ä½¿ç”¨-spanmixed_site)
    - [5.2 ä½¿ç”¨ `Span::call_site()`](#52-ä½¿ç”¨-spancall_site)
  - [6. å®ç°ç»†èŠ‚](#6-å®ç°ç»†èŠ‚)
    - [6.1 Span ID ç³»ç»Ÿ](#61-span-id-ç³»ç»Ÿ)
    - [6.2 æ ‡è®° (Mark)](#62-æ ‡è®°-mark)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 ä¿æŒå«ç”Ÿæ€§](#71-ä¿æŒå«ç”Ÿæ€§)
    - [7.2 æ–‡æ¡£è¯´æ˜](#72-æ–‡æ¡£è¯´æ˜)

## 1. ä»€ä¹ˆæ˜¯å®å«ç”Ÿæ€§

å®å«ç”Ÿæ€§ï¼ˆHygieneï¼‰ç¡®ä¿å®ç”Ÿæˆçš„ä»£ç ä¸ä¼šæ„å¤–æ•è·æˆ–å¹²æ‰°å¤–éƒ¨ä½œç”¨åŸŸçš„æ ‡è¯†ç¬¦ã€‚

```rust
// å«ç”Ÿçš„å® - ä¸ä¼šæ±¡æŸ“å¤–éƒ¨ä½œç”¨åŸŸ
macro_rules! define_var {
    ($name:ident, $value:expr) => {
        let $name = $value;
    };
}

fn main() {
    define_var!(x, 42);  // åˆ›å»ºä¸€ä¸ªå±€éƒ¨çš„ x
    println!("{}", x);    // âœ… æ­£å¸¸ç¼–è¯‘

    let x = 10;          // âœ… å¯ä»¥é‡æ–°å®šä¹‰ï¼Œä¸å†²çª
}
```

---

## 2. è¯­æ³•ä¸Šä¸‹æ–‡ (Syntax Context)

### 2.1 æ ¸å¿ƒæ¦‚å¿µ

```
æ ‡è¯†ç¬¦ = ç¬¦å·å + è¯­æ³•ä¸Šä¸‹æ–‡ ID

è¯­æ³•ä¸Šä¸‹æ–‡ ID å†³å®šæ ‡è¯†ç¬¦æ¥è‡ªå“ªä¸ªä½œç”¨åŸŸï¼š
- è°ƒç”¨ site's ä¸Šä¸‹æ–‡
- å®å®šä¹‰å¤„çš„ä¸Šä¸‹æ–‡
- æ··åˆä¸Šä¸‹æ–‡
```

### 2.2 ä¸Šä¸‹æ–‡æ ‡è®°

```rust
// å®å®šä¹‰æ—¶çš„ä¸Šä¸‹æ–‡
macro_rules! hygienic {
    () => {
        let x = 1;  // æ ‡è®°ä¸º "å®å®šä¹‰ä¸Šä¸‹æ–‡"
    };
}

fn main() {
    hygienic!();   // è°ƒç”¨ site's ä¸Šä¸‹æ–‡ä¸å®å®šä¹‰ä¸Šä¸‹æ–‡åˆ†ç¦»
    let x = 2;     // ä¸åŒçš„è¯­æ³•ä¸Šä¸‹æ–‡ï¼Œä¸ä¼šå†²çª
}
```

---

## 3. æ ‡è¯†ç¬¦åˆ†ç±»

### 3.1 ç»‘å®š (Binding)

```rust
macro_rules! bind {
    ($name:ident) => {
        let $name = 42;  // $name æ˜¯ç»‘å®šä½ç½®
    };
}

fn main() {
    bind!(x);          // x ç»‘å®šåˆ°å®å†…éƒ¨çš„ let
    println!("{}", x); // âœ… ä½¿ç”¨ç»‘å®šçš„ x
}
```

### 3.2 å¼•ç”¨ (Reference)

```rust
macro_rules! reference {
    ($name:ident) => {
        println!("{}", $name);  // $name æ˜¯å¼•ç”¨ä½ç½®
    };
}

fn main() {
    let y = 42;
    reference!(y);     // y å¼•ç”¨å¤–éƒ¨çš„ç»‘å®š
}
```

### 3.3 æ ‡ç­¾ (Label)

```rust
macro_rules! with_label {
    ($label:lifetime) => {
        $label: loop { break $label; }
    };
}

fn main() {
    with_label!('outer);  // æ ‡ç­¾ä¹Ÿæ˜¯å«ç”Ÿçš„
}
```

---

## 4. è·¨ Crate å«ç”Ÿæ€§

### 4.1 å¯¼å‡ºå®çš„å«ç”Ÿæ€§

```rust
// crate A: my_macros/src/lib.rs
#[macro_export]
macro_rules! export_hygienic {
    ($name:ident) => {
        let $name = "from macro";
    };
}

// crate B: user/Cargo.toml
// [dependencies]
// my_macros = "1.0"

// crate B: user/src/main.rs
use my_macros::export_hygienic;

fn main() {
    export_hygienic!(x);
    let x = "from main";  // âœ… ä¸å†²çªï¼Œå«ç”Ÿæ€§è·¨ crate ä¿æŒ
}
```

---

## 5. æ‰“ç ´å«ç”Ÿæ€§ (æ•…æ„)

### 5.1 ä½¿ç”¨ `Span::mixed_site()`

```rust
use proc_macro::Span;

#[proc_macro]
pub fn unhygienic(input: TokenStream) -> TokenStream {
    let mixed = Span::mixed_site();  // æ··åˆä¸Šä¸‹æ–‡
    // ... ä½¿ç”¨ mixed åˆ›å»ºæ ‡è¯†ç¬¦
    input
}
```

### 5.2 ä½¿ç”¨ `Span::call_site()`

```rust
use proc_macro::Span;

#[proc_macro]
pub fn call_site_example(input: TokenStream) -> TokenStream {
    let call_site = Span::call_site();  // è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡
    // ... ä½¿ç”¨ call_site åˆ›å»ºæ ‡è¯†ç¬¦
    input
}
```

---

## 6. å®ç°ç»†èŠ‚

### 6.1 Span ID ç³»ç»Ÿ

```
Span ç»“æ„:
- lo: BytePos (èµ·å§‹ä½ç½®)
- hi: BytePos (ç»“æŸä½ç½®)
- ctxt: SyntaxContext (è¯­æ³•ä¸Šä¸‹æ–‡ ID)

SyntaxContext ç»“æ„:
- opaque: u32 (ä¸é€æ˜ä¸Šä¸‹æ–‡ ID)
- transparent: Vec<Mark> (é€æ˜æ ‡è®°é“¾)
```

### 6.2 æ ‡è®° (Mark)

```
Mark è¡¨ç¤ºå®å±•å¼€å±‚çº§:
- Mark 0: é¡¶å±‚ï¼ˆæ— å®ï¼‰
- Mark 1: ç¬¬ä¸€æ¬¡å®å±•å¼€
- Mark 2: ç¬¬äºŒæ¬¡å®å±•å¼€ï¼ˆåµŒå¥—å®ï¼‰
...
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 ä¿æŒå«ç”Ÿæ€§

```rust
// âœ… å¥½çš„åšæ³•ï¼šè®©æ ‡è¯†ç¬¦ç”±è°ƒç”¨è€…æä¾›
macro_rules! with_callback {
    ($callback:ident) => {
        $callback(42);
    };
}

// âŒ é¿å…ï¼šå®å†…éƒ¨ç¡¬ç¼–ç æ ‡è¯†ç¬¦
macro_rules! bad_example {
    () => {
        let result = 42;  // å¯èƒ½æ•è·å¤–éƒ¨ result
    };
}
```

### 7.2 æ–‡æ¡£è¯´æ˜

```rust
/// æ­¤å®åœ¨å†…éƒ¨åˆ›å»ºå˜é‡ï¼Œä½†ä¿æŒå«ç”Ÿæ€§
///
/// ç”Ÿæˆçš„å˜é‡ä¸ä¼šä¸å¤–éƒ¨ä½œç”¨åŸŸå†²çª
macro_rules! hygienic_macro {
    ($name:ident) => {
        let $name = /* ... */;
    };
}
```

---

**ç»´æŠ¤è€…**: Rust å­¦ä¹ é¡¹ç›®å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2026-02-28
