# Rust 所有权、借用与生命周期惯用法 {#rust特有惯用法}

## 📊 目录

- [Rust 所有权、借用与生命周期惯用法 {#rust特有惯用法}](#rust-所有权借用与生命周期惯用法-rust特有惯用法)
  - [📊 目录](#-目录)
  - [章节导航](#章节导航)
  - [所有权惯用法与工程意义](#所有权惯用法与工程意义)
  - [借用与可变性惯用法](#借用与可变性惯用法)
  - [生命周期标注与推断](#生命周期标注与推断)
  - [常见易错点与最佳实践](#常见易错点与最佳实践)
  - [工程案例与代码示例](#工程案例与代码示例)
    - [1. Option::take()安全移动所有权](#1-optiontake安全移动所有权)
    - [2. 借用与可变性](#2-借用与可变性)
    - [3. 生命周期标注](#3-生命周期标注)
    - [4. RefCell运行时可变性](#4-refcell运行时可变性)
  - [形式化分析与定理](#形式化分析与定理)
  - [交叉引用](#交叉引用)

**章节编号**: 06-05  
**主题**: 所有权、借用、生命周期惯用法、工程实践  
**最后更新**: 2024-12-30  
**维护者**: Rust形式化团队

---

## 章节导航

- [Rust 所有权、借用与生命周期惯用法 {#rust特有惯用法}](#rust-所有权借用与生命周期惯用法-rust特有惯用法)
  - [📊 目录](#-目录)
  - [章节导航](#章节导航)
  - [所有权惯用法与工程意义](#所有权惯用法与工程意义)
  - [借用与可变性惯用法](#借用与可变性惯用法)
  - [生命周期标注与推断](#生命周期标注与推断)
  - [常见易错点与最佳实践](#常见易错点与最佳实践)
  - [工程案例与代码示例](#工程案例与代码示例)
    - [1. Option::take()安全移动所有权](#1-optiontake安全移动所有权)
    - [2. 借用与可变性](#2-借用与可变性)
    - [3. 生命周期标注](#3-生命周期标注)
    - [4. RefCell运行时可变性](#4-refcell运行时可变性)
  - [形式化分析与定理](#形式化分析与定理)
  - [交叉引用](#交叉引用)

---

## 所有权惯用法与工程意义

- **move语义**：资源所有权移动，防止二次释放。
- **Clone/Copy**：显式复制资源，避免隐式副本。
- **`Option<T>`与所有权移动**：take()/replace()安全移动所有权。
- **Drop与RAII**：自动资源释放，防止泄漏。

---

## 借用与可变性惯用法

- **不可变借用/可变借用**：同一时刻要么多个不可变借用，要么一个可变借用。
- **as_ref()/as_mut()**：Option/Result等容器类型的借用访问。
- **RefCell/Cell**：运行时可变性，突破编译期借用规则（需谨慎）。
- **slice/str借用**：高效访问部分数据，无需复制。

---

## 生命周期标注与推断

- **生命周期参数**：<'a>标注引用有效期，防止悬垂指针。
- **省略规则**：常见场景可省略生命周期，复杂结构体体体需显式标注。
- **静态生命周期**：'static用于全局常量、线程、异步等场景。

---

## 常见易错点与最佳实践

- **悬垂引用**：返回局部变量引用，编译器报错。
- **借用冲突**：同时存在可变与不可变借用，编译器拒绝。
- **提前释放**：Option::take()后原值为None，防止悬垂。
- **闭包捕获**：move闭包移动所有权，非move闭包借用外部变量。
- **最佳实践**：优先借用，必要时移动所有权，避免RefCell滥用。

---

## 工程案例与代码示例

### 1. Option::take()安全移动所有权

```rust
fn main() {
    let mut x = Some(String::from("hi"));
    let y = x.take(); // x变为None，y获得所有权
}
```

### 2. 借用与可变性

```rust
fn print_len(s: &String) {
    println!("len={}", s.len());
}
fn main() {
    let s = String::from("hello");
    print_len(&s);
}
```

### 3. 生命周期标注

```rust
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() { x } else { y }
}
```

### 4. RefCell运行时可变性

```rust
use std::cell::RefCell;
fn main() {
    let data = RefCell::new(1);
    *data.borrow_mut() += 1;
}
```

---

## 形式化分析与定理

- **定理 5.1 (所有权安全)**

  ```text
  Rust所有权惯用法 ⊢ 无二次释放/悬垂指针/数据竞争
  ```

- **定理 5.2 (借用规则一致性)**

  ```text
  编译期借用检查 ⊢ 不可变/可变借用互斥
  ```

- **定理 5.3 (生命周期安全)**

  ```text
  生命周期参数保证引用安全，防止悬垂
  ```

---

## 交叉引用

- [资源管理模型](./01_resource_management.md)
- [RAII模式应用](./02_raii_patterns.md)
- [线性类型实践](./03_linear_types_practice.md)
- [设计模式与所有权](./04_design_patterns.md)
- [所有权与借用](../01_ownership_borrowing/)
- [类型系统核心](../03_type_system_core/)
- [并发与性能优化](../05_concurrency/)

---

> 本文档为Rust所有权、借用、生命周期惯用法的理论与工程索引，后续章节将递归细化各子主题。

"

---
