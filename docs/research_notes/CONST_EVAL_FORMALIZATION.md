# å¸¸é‡æ±‚å€¼å½¢å¼åŒ–

> **åˆ›å»ºæ—¥æœŸ**: 2026-02-28
> **æ–‡æ¡£ç±»å‹**: å½¢å¼åŒ–ç ”ç©¶
> **Rust ç‰ˆæœ¬**: 1.93.1+

---

## ğŸ“‹ ç›®å½•

- [å¸¸é‡æ±‚å€¼å½¢å¼åŒ–](#å¸¸é‡æ±‚å€¼å½¢å¼åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. å¸¸é‡æ±‚å€¼æ¦‚è¿°](#1-å¸¸é‡æ±‚å€¼æ¦‚è¿°)
  - [2. å½¢å¼åŒ–å®šä¹‰](#2-å½¢å¼åŒ–å®šä¹‰)
    - [Def CE-1: å¸¸é‡ä¸Šä¸‹æ–‡](#def-ce-1-å¸¸é‡ä¸Šä¸‹æ–‡)
    - [Def CE-2: å¸¸é‡æ±‚å€¼å™¨](#def-ce-2-å¸¸é‡æ±‚å€¼å™¨)
  - [3. å¸¸é‡å‡½æ•° (const fn)](#3-å¸¸é‡å‡½æ•°-const-fn)
    - [Def CE-3: const fn çº¦æŸ](#def-ce-3-const-fn-çº¦æŸ)
    - [Def CE-4: ç¦æ­¢çš„ const fn æ“ä½œ](#def-ce-4-ç¦æ­¢çš„-const-fn-æ“ä½œ)
  - [4. å®šç†](#4-å®šç†)
    - [Thm CE-1: å¸¸é‡æ±‚å€¼ç»ˆæ­¢æ€§](#thm-ce-1-å¸¸é‡æ±‚å€¼ç»ˆæ­¢æ€§)
    - [Thm CE-2: å¸¸é‡æ±‚å€¼ç¡®å®šæ€§](#thm-ce-2-å¸¸é‡æ±‚å€¼ç¡®å®šæ€§)
  - [5. MIR å¸¸é‡æ±‚å€¼](#5-mir-å¸¸é‡æ±‚å€¼)
  - [6. é«˜çº§ç‰¹æ€§](#6-é«˜çº§ç‰¹æ€§)
    - [const\_eval\_select (ä¸ç¨³å®š)](#const_eval_select-ä¸ç¨³å®š)

## 1. å¸¸é‡æ±‚å€¼æ¦‚è¿°

Rust çš„å¸¸é‡æ±‚å€¼åœ¨ç¼–è¯‘æœŸæ‰§è¡Œï¼Œå…è®¸åœ¨ç±»å‹ç³»ç»Ÿå’Œå¸¸é‡å®šä¹‰ä¸­ä½¿ç”¨è®¡ç®—ã€‚

---

## 2. å½¢å¼åŒ–å®šä¹‰

### Def CE-1: å¸¸é‡ä¸Šä¸‹æ–‡

```text
å¸¸é‡ä¸Šä¸‹æ–‡ := é™æ€é¡¹ | å¸¸é‡é¡¹ | æšä¸¾åˆ¤åˆ«å¼ | æ•°ç»„é•¿åº¦ | ç±»å‹åˆ«å
```

### Def CE-2: å¸¸é‡æ±‚å€¼å™¨

```text
Eval_const: Expr Ã— Env â†’ Value + Error

Eval_const(e, env) =
  è‹¥ e æ˜¯çº¯è¡¨è¾¾å¼ â†’ æ±‚å€¼ç»“æœ
  è‹¥ e å«å‰¯ä½œç”¨ â†’ ç¼–è¯‘é”™è¯¯
```

---

## 3. å¸¸é‡å‡½æ•° (const fn)

### Def CE-3: const fn çº¦æŸ

```rust
// å…è®¸çš„ const fn æ“ä½œ
const fn allowed() {
    // âœ… ç®—æœ¯è¿ç®—
    let x = 1 + 2;

    // âœ… æ§åˆ¶æµ
    if x > 0 { }

    // âœ… åŒ¹é…
    match x { _ => () }

    // âœ… å¾ªç¯
    loop { break; }

    // âœ… è°ƒç”¨å…¶ä»– const fn
    const_fn_call();
}
```

### Def CE-4: ç¦æ­¢çš„ const fn æ“ä½œ

```rust
const fn forbidden() {
    // âŒ å †åˆ†é…
    // let x = Box::new(42);

    // âŒ å¯å˜é™æ€å˜é‡
    // unsafe { STATIC_VAR = 42; }

    // âŒ é const fn è°ƒç”¨
    // non_const_fn();

    // âŒ ç±»å‹è½¬æ¢åˆ°è£¸æŒ‡é’ˆï¼ˆæŸäº›æƒ…å†µï¼‰
    // &x as *const i32
}
```

---

## 4. å®šç†

### Thm CE-1: å¸¸é‡æ±‚å€¼ç»ˆæ­¢æ€§

**é™ˆè¿°**: æ‰€æœ‰å¸¸é‡æ±‚å€¼åœ¨æœ‰é™æ­¥å†…ç»ˆæ­¢æˆ–æŠ¥å‘Šé”™è¯¯ã€‚

**è¯æ˜**:

- å¸¸é‡æ±‚å€¼å™¨é™åˆ¶å¾ªç¯è¿­ä»£æ¬¡æ•°ï¼ˆé»˜è®¤ 1_000_000ï¼‰
- é€’å½’æ·±åº¦æœ‰é™åˆ¶
- æ— æ— é™é€’å½’ç±»å‹

### Thm CE-2: å¸¸é‡æ±‚å€¼ç¡®å®šæ€§

**é™ˆè¿°**: ç»™å®šç›¸åŒè¾“å…¥ï¼Œå¸¸é‡æ±‚å€¼äº§ç”Ÿç›¸åŒç»“æœã€‚

**è¯æ˜**:

- æ— å‰¯ä½œç”¨
- æ— å¤–éƒ¨è¾“å…¥
- çº¯å‡½æ•°è¯­ä¹‰

---

## 5. MIR å¸¸é‡æ±‚å€¼

```text
ç¼–è¯‘æœŸæ±‚å€¼æµç¨‹:

Rust æºç 
    â†“
HIR (é«˜çº§ä¸­é—´è¡¨ç¤º)
    â†“
MIR (ä¸­çº§ä¸­é—´è¡¨ç¤º)
    â†“
å¸¸é‡æ±‚å€¼å™¨ (MIRI æ ¸å¿ƒ)
    â†“
ç¼–è¯‘æ—¶å¸¸é‡å€¼
```

---

## 6. é«˜çº§ç‰¹æ€§

### const_eval_select (ä¸ç¨³å®š)

```rust
#![feature(const_eval_select)]

const fn with_const_eval_select<T>(x: T) -> T {
    const_eval_select!(
        @capture { x: T }
        @target: fn(T) -> T,
        @const_fallback: const_fn_impl,
        @runtime_fallback: runtime_fn_impl,
    )
}
```

---

**ç»´æŠ¤è€…**: Rust å½¢å¼åŒ–ç ”ç©¶å›¢é˜Ÿ
