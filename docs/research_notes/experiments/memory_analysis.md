# å†…å­˜åˆ†æ

> **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
> **æœ€åæ›´æ–°**: 2025-01-27
> **Rust ç‰ˆæœ¬**: 1.91.0 (Edition 2024) âœ…
> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­

---

## ğŸ“Š ç›®å½•

- [å†…å­˜åˆ†æ](#å†…å­˜åˆ†æ)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ ç ”ç©¶ç›®æ ‡](#-ç ”ç©¶ç›®æ ‡)
    - [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
    - [é¢„æœŸæˆæœ](#é¢„æœŸæˆæœ)
  - [ğŸ“š ç†è®ºåŸºç¡€](#-ç†è®ºåŸºç¡€)
    - [å†…å­˜ç®¡ç†](#å†…å­˜ç®¡ç†)
    - [å†…å­˜åˆ†ææŒ‡æ ‡](#å†…å­˜åˆ†ææŒ‡æ ‡)
  - [ğŸ”¬ å®éªŒè®¾è®¡](#-å®éªŒè®¾è®¡)
    - [1. å†…å­˜åˆ†æå·¥å…·](#1-å†…å­˜åˆ†æå·¥å…·)
    - [2. æµ‹è¯•åœºæ™¯](#2-æµ‹è¯•åœºæ™¯)
    - [3. æ•°æ®æ”¶é›†](#3-æ•°æ®æ”¶é›†)
  - [ğŸ“Š å®éªŒç»“æœ](#-å®éªŒç»“æœ)
    - [å¾…æµ‹è¯•çš„åœºæ™¯](#å¾…æµ‹è¯•çš„åœºæ™¯)
    - [ç»“æœåˆ†æ](#ç»“æœåˆ†æ)
  - [ğŸ’» ä»£ç ç¤ºä¾‹](#-ä»£ç ç¤ºä¾‹)
    - [ç¤ºä¾‹ 1: å†…å­˜ä½¿ç”¨ç»Ÿè®¡](#ç¤ºä¾‹-1-å†…å­˜ä½¿ç”¨ç»Ÿè®¡)
    - [ç¤ºä¾‹ 2: å†…å­˜æ³„æ¼æ£€æµ‹](#ç¤ºä¾‹-2-å†…å­˜æ³„æ¼æ£€æµ‹)
    - [ç¤ºä¾‹ 3: å†…å­˜ä¼˜åŒ–](#ç¤ºä¾‹-3-å†…å­˜ä¼˜åŒ–)
  - [ğŸ“– å‚è€ƒæ–‡çŒ®](#-å‚è€ƒæ–‡çŒ®)
    - [å·¥å…·æ–‡æ¡£](#å·¥å…·æ–‡æ¡£)
    - [ç›¸å…³ä»£ç ](#ç›¸å…³ä»£ç )
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [ğŸ”„ ç ”ç©¶è¿›å±•](#-ç ”ç©¶è¿›å±•)
    - [å·²å®Œæˆ âœ…](#å·²å®Œæˆ-)
    - [è¿›è¡Œä¸­ ğŸ”„](#è¿›è¡Œä¸­-)
    - [è®¡åˆ’ä¸­ ğŸ“‹](#è®¡åˆ’ä¸­-)

---

## ğŸ¯ ç ”ç©¶ç›®æ ‡

æœ¬ç ”ç©¶çš„ç›®çš„æ˜¯åˆ†æ Rust ç¨‹åºçš„å†…å­˜ä½¿ç”¨æ¨¡å¼ï¼Œè¯†åˆ«å†…å­˜ä¼˜åŒ–æœºä¼šã€‚

### æ ¸å¿ƒé—®é¢˜

1. **å†…å­˜ä½¿ç”¨æ¨¡å¼**: ä¸åŒæ•°æ®ç»“æ„çš„å†…å­˜ä½¿ç”¨æ¨¡å¼å¦‚ä½•ï¼Ÿ
2. **å†…å­˜åˆ†é…**: å¦‚ä½•ä¼˜åŒ–å†…å­˜åˆ†é…ï¼Ÿ
3. **å†…å­˜æ³„æ¼**: å¦‚ä½•æ£€æµ‹å’Œä¿®å¤å†…å­˜æ³„æ¼ï¼Ÿ

### é¢„æœŸæˆæœ

- å†…å­˜ä½¿ç”¨åˆ†ææŠ¥å‘Š
- å†…å­˜ä¼˜åŒ–å»ºè®®
- å†…å­˜æ³„æ¼æ£€æµ‹æ–¹æ³•

---

## ğŸ“š ç†è®ºåŸºç¡€

### å†…å­˜ç®¡ç†

1. **æ ˆå†…å­˜**: è‡ªåŠ¨ç®¡ç†ï¼Œé€Ÿåº¦å¿«
2. **å †å†…å­˜**: æ‰‹åŠ¨ç®¡ç†ï¼Œçµæ´»ä½†æ…¢
3. **å†…å­˜åˆ†é…å™¨**: ç®¡ç†å †å†…å­˜åˆ†é…
4. **å†…å­˜å¯¹é½**: æ•°æ®åœ¨å†…å­˜ä¸­çš„å¯¹é½æ–¹å¼

### å†…å­˜åˆ†ææŒ‡æ ‡

- **å†…å­˜ä½¿ç”¨é‡**: ç¨‹åºä½¿ç”¨çš„å†…å­˜æ€»é‡
- **å†…å­˜åˆ†é…æ¬¡æ•°**: å†…å­˜åˆ†é…çš„æ¬¡æ•°
- **å†…å­˜ç¢ç‰‡**: å†…å­˜ç¢ç‰‡åŒ–ç¨‹åº¦
- **å†…å­˜æ³„æ¼**: æœªé‡Šæ”¾çš„å†…å­˜

---

## ğŸ”¬ å®éªŒè®¾è®¡

### 1. å†…å­˜åˆ†æå·¥å…·

ä½¿ç”¨ä»¥ä¸‹å·¥å…·è¿›è¡Œå†…å­˜åˆ†æï¼š

- **Valgrind**: å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·
- **heaptrack**: å †å†…å­˜åˆ†æå·¥å…·
- **memory-stats**: Rust å†…å­˜ç»Ÿè®¡åº“
- **dhat**: å †åˆ†æå·¥å…·

### 2. æµ‹è¯•åœºæ™¯

- **æ•°æ®ç»“æ„å†…å­˜**: æµ‹è¯•ä¸åŒæ•°æ®ç»“æ„çš„å†…å­˜ä½¿ç”¨
- **åˆ†é…ç­–ç•¥**: æµ‹è¯•ä¸åŒå†…å­˜åˆ†é…ç­–ç•¥
- **å†…å­˜æ³„æ¼**: æµ‹è¯•å†…å­˜æ³„æ¼æ£€æµ‹
- **å†…å­˜ä¼˜åŒ–**: æµ‹è¯•å†…å­˜ä¼˜åŒ–æ•ˆæœ

### 3. æ•°æ®æ”¶é›†

- **å†…å­˜ä½¿ç”¨é‡**: æ”¶é›†å†…å­˜ä½¿ç”¨é‡æ•°æ®
- **åˆ†é…æ¨¡å¼**: æ”¶é›†å†…å­˜åˆ†é…æ¨¡å¼
- **æ€§èƒ½å½±å“**: æ”¶é›†å†…å­˜å¯¹æ€§èƒ½çš„å½±å“

---

## ğŸ“Š å®éªŒç»“æœ

### å¾…æµ‹è¯•çš„åœºæ™¯

1. **æ•°æ®ç»“æ„å†…å­˜**: ä¸åŒæ•°æ®ç»“æ„çš„å†…å­˜ä½¿ç”¨æ¯”è¾ƒ
2. **åˆ†é…å™¨æ€§èƒ½**: ä¸åŒåˆ†é…å™¨çš„æ€§èƒ½æ¯”è¾ƒ
3. **å†…å­˜ä¼˜åŒ–**: å†…å­˜ä¼˜åŒ–çš„æ•ˆæœè¯„ä¼°
4. **å†…å­˜æ³„æ¼**: å†…å­˜æ³„æ¼çš„æ£€æµ‹å’Œä¿®å¤

### ç»“æœåˆ†æ

- **å†…å­˜ä½¿ç”¨å¯¹æ¯”**: å¯¹æ¯”ä¸åŒå®ç°çš„å†…å­˜ä½¿ç”¨
- **ä¼˜åŒ–æœºä¼š**: è¯†åˆ«å†…å­˜ä¼˜åŒ–æœºä¼š
- **ä¼˜åŒ–å»ºè®®**: æä¾›å†…å­˜ä¼˜åŒ–å»ºè®®

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1: å†…å­˜ä½¿ç”¨ç»Ÿè®¡

```rust
use std::alloc::{GlobalAlloc, Layout, System};

struct MemoryStats {
    allocations: usize,
    total_bytes: usize,
}

static mut STATS: MemoryStats = MemoryStats {
    allocations: 0,
    total_bytes: 0,
};

struct TrackingAllocator;

unsafe impl GlobalAlloc for TrackingAllocator {
    unsafe fn alloc(&self, layout: Layout) -> *mut u8 {
        let ptr = System.alloc(layout);
        if !ptr.is_null() {
            unsafe {
                STATS.allocations += 1;
                STATS.total_bytes += layout.size();
            }
        }
        ptr
    }

    unsafe fn dealloc(&self, ptr: *mut u8, layout: Layout) {
        System.dealloc(ptr, layout);
        unsafe {
            STATS.total_bytes -= layout.size();
        }
    }
}

#[global_allocator]
static GLOBAL: TrackingAllocator = TrackingAllocator;

fn main() {
    let vec: Vec<i32> = (0..1000).collect();

    unsafe {
        println!("åˆ†é…æ¬¡æ•°: {}", STATS.allocations);
        println!("æ€»å­—èŠ‚æ•°: {}", STATS.total_bytes);
    }
}
```

### ç¤ºä¾‹ 2: å†…å­˜æ³„æ¼æ£€æµ‹

```rust
use std::cell::RefCell;

thread_local! {
    static ALLOCATIONS: RefCell<Vec<*const u8>> = RefCell::new(Vec::new());
}

fn track_allocation(ptr: *const u8) {
    ALLOCATIONS.with(|allocations| {
        allocations.borrow_mut().push(ptr);
    });
}

fn check_leaks() {
    ALLOCATIONS.with(|allocations| {
        let count = allocations.borrow().len();
        if count > 0 {
            println!("æ£€æµ‹åˆ° {} ä¸ªæ½œåœ¨å†…å­˜æ³„æ¼", count);
        }
    });
}

fn main() {
    let ptr = Box::into_raw(Box::new(42));
    track_allocation(ptr);

    // å¿˜è®°é‡Šæ”¾
    // unsafe { Box::from_raw(ptr); }

    check_leaks();
}
```

### ç¤ºä¾‹ 3: å†…å­˜ä¼˜åŒ–

```rust
// ä¼˜åŒ–å‰ï¼šä½¿ç”¨ Vec
fn process_data_naive(data: &[i32]) -> Vec<i32> {
    data.iter().map(|x| x * 2).collect()
}

// ä¼˜åŒ–åï¼šä½¿ç”¨è¿­ä»£å™¨ï¼Œå»¶è¿Ÿåˆ†é…
fn process_data_optimized(data: &[i32]) -> impl Iterator<Item = i32> + '_ {
    data.iter().map(|x| x * 2)
}

fn main() {
    let data: Vec<i32> = (0..1000).collect();

    // ä¼˜åŒ–å‰ï¼šç«‹å³åˆ†é…å†…å­˜
    let result1 = process_data_naive(&data);

    // ä¼˜åŒ–åï¼šå»¶è¿Ÿåˆ†é…ï¼ŒæŒ‰éœ€è®¡ç®—
    let result2: Vec<i32> = process_data_optimized(&data).collect();
}
```

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

### å·¥å…·æ–‡æ¡£

- [Valgrind æ–‡æ¡£](https://valgrind.org/docs/manual/manual.html)
- [heaptrack æ–‡æ¡£](https://github.com/KDE/heaptrack)
- [dhat æ–‡æ¡£](https://github.com/nnethercote/dhat-rs)

### ç›¸å…³ä»£ç 

- [å†…å­˜åˆ†æå·¥å…·](../../../crates/c05_threads/benches/)
- [å†…å­˜ä¼˜åŒ–å®ç°](../../../crates/c01_ownership_borrow_scope/src/)

### æœ€ä½³å®è·µ

- [Rust å†…å­˜ä¼˜åŒ–æŒ‡å—](https://nnethercote.github.io/perf-book/heap-allocations.html)
- [å†…å­˜æ³„æ¼æ£€æµ‹](https://doc.rust-lang.org/book/ch15-06-reference-cycles.html)

---

## ğŸ”„ ç ”ç©¶è¿›å±•

### å·²å®Œæˆ âœ…

- [x] ç ”ç©¶ç›®æ ‡å®šä¹‰
- [x] ç†è®ºåŸºç¡€æ•´ç†
- [x] å®éªŒè®¾è®¡æ¡†æ¶

### è¿›è¡Œä¸­ ğŸ”„

- [ ] å…·ä½“å®éªŒè®¾è®¡
- [ ] æ•°æ®æ”¶é›†
- [ ] ç»“æœåˆ†æ

### è®¡åˆ’ä¸­ ğŸ“‹

- [ ] å†…å­˜ä¼˜åŒ–å»ºè®®
- [ ] å®é™…åº”ç”¨æ¡ˆä¾‹
- [ ] å·¥å…·æ”¹è¿›

---

**ç»´æŠ¤è€…**: Rust Performance Research Group
**æœ€åæ›´æ–°**: 2025-01-27
**çŠ¶æ€**: ğŸ“‹ **è§„åˆ’ä¸­**
