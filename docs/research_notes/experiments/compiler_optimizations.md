# ç¼–è¯‘å™¨ä¼˜åŒ–

> **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
> **æœ€åæ›´æ–°**: 2025-01-27
> **Rust ç‰ˆæœ¬**: 1.91.0 (Edition 2024) âœ…
> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­

---

## ğŸ“Š ç›®å½•

- [ç¼–è¯‘å™¨ä¼˜åŒ–](#ç¼–è¯‘å™¨ä¼˜åŒ–)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ ç ”ç©¶ç›®æ ‡](#-ç ”ç©¶ç›®æ ‡)
    - [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
    - [é¢„æœŸæˆæœ](#é¢„æœŸæˆæœ)
  - [ğŸ“š ç†è®ºåŸºç¡€](#-ç†è®ºåŸºç¡€)
    - [ç¼–è¯‘å™¨ä¼˜åŒ–](#ç¼–è¯‘å™¨ä¼˜åŒ–-1)
    - [ä¼˜åŒ–çº§åˆ«](#ä¼˜åŒ–çº§åˆ«)
    - [ç›¸å…³æ¦‚å¿µ](#ç›¸å…³æ¦‚å¿µ)
    - [ç†è®ºèƒŒæ™¯](#ç†è®ºèƒŒæ™¯)
  - [ğŸ”¬ å®éªŒè®¾è®¡](#-å®éªŒè®¾è®¡)
    - [1. ä¼˜åŒ–æ•ˆæœæµ‹è¯•](#1-ä¼˜åŒ–æ•ˆæœæµ‹è¯•)
    - [2. ä¼˜åŒ–ç±»å‹æµ‹è¯•](#2-ä¼˜åŒ–ç±»å‹æµ‹è¯•)
    - [3. ä»£ç æ¨¡å¼æµ‹è¯•](#3-ä»£ç æ¨¡å¼æµ‹è¯•)
  - [ğŸ“Š å®éªŒç»“æœ](#-å®éªŒç»“æœ)
    - [å¾…æµ‹è¯•çš„åœºæ™¯](#å¾…æµ‹è¯•çš„åœºæ™¯)
    - [ç»“æœåˆ†æ](#ç»“æœåˆ†æ)
  - [ğŸ’» ä»£ç ç¤ºä¾‹](#-ä»£ç ç¤ºä¾‹)
    - [ç¤ºä¾‹ 1: å†…è”ä¼˜åŒ–](#ç¤ºä¾‹-1-å†…è”ä¼˜åŒ–)
    - [ç¤ºä¾‹ 2: å¾ªç¯ä¼˜åŒ–](#ç¤ºä¾‹-2-å¾ªç¯ä¼˜åŒ–)
    - [ç¤ºä¾‹ 3: å¸¸é‡æŠ˜å ](#ç¤ºä¾‹-3-å¸¸é‡æŠ˜å )
    - [ç¤ºä¾‹ 4: æŸ¥çœ‹ä¼˜åŒ–åçš„æ±‡ç¼–](#ç¤ºä¾‹-4-æŸ¥çœ‹ä¼˜åŒ–åçš„æ±‡ç¼–)
  - [ğŸ“– å‚è€ƒæ–‡çŒ®](#-å‚è€ƒæ–‡çŒ®)
    - [å·¥å…·æ–‡æ¡£](#å·¥å…·æ–‡æ¡£)
    - [ç›¸å…³ä»£ç ](#ç›¸å…³ä»£ç )
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [ğŸ”„ ç ”ç©¶è¿›å±•](#-ç ”ç©¶è¿›å±•)
    - [å·²å®Œæˆ âœ…](#å·²å®Œæˆ-)
    - [è¿›è¡Œä¸­ ğŸ”„](#è¿›è¡Œä¸­-)
    - [è®¡åˆ’ä¸­ ğŸ“‹](#è®¡åˆ’ä¸­-)

---

## ğŸ¯ ç ”ç©¶ç›®æ ‡

æœ¬ç ”ç©¶çš„ç›®çš„æ˜¯è¯„ä¼° Rust ç¼–è¯‘å™¨çš„ä¼˜åŒ–æ•ˆæœï¼Œäº†è§£å¦‚ä½•ç¼–å†™ç¼–è¯‘å™¨å‹å¥½çš„ä»£ç ã€‚

### æ ¸å¿ƒé—®é¢˜

1. **ä¼˜åŒ–æ•ˆæœ**: ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ•ˆæœå¦‚ä½•ï¼Ÿ
2. **ä¼˜åŒ–ç±»å‹**: æœ‰å“ªäº›ç±»å‹çš„ä¼˜åŒ–ï¼Ÿ
3. **ç¼–å†™å»ºè®®**: å¦‚ä½•ç¼–å†™ç¼–è¯‘å™¨å‹å¥½çš„ä»£ç ï¼Ÿ

### é¢„æœŸæˆæœ

- ç¼–è¯‘å™¨ä¼˜åŒ–æ•ˆæœè¯„ä¼°
- ç¼–å†™ç¼–è¯‘å™¨å‹å¥½ä»£ç çš„æŒ‡å—
- ä¼˜åŒ–å®è·µå»ºè®®

---

## ğŸ“š ç†è®ºåŸºç¡€

### ç¼–è¯‘å™¨ä¼˜åŒ–

**å†…è”ä¼˜åŒ– (Inlining)**: å°†å‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºå‡½æ•°ä½“ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ã€‚å†…è”ä¼˜åŒ–å¯ä»¥æé«˜æ€§èƒ½ï¼Œä½†ä¼šå¢åŠ ä»£ç å¤§å°ã€‚

**æ­»ä»£ç æ¶ˆé™¤ (Dead Code Elimination)**: ç§»é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œå‡å°‘ä»£ç å¤§å°å’Œæ‰§è¡Œæ—¶é—´ã€‚æ­»ä»£ç æ¶ˆé™¤åŸºäºæ§åˆ¶æµåˆ†æã€‚

**å¸¸é‡æŠ˜å  (Constant Folding)**: åœ¨ç¼–è¯‘æ—¶è®¡ç®—å¸¸é‡è¡¨è¾¾å¼ï¼Œå‡å°‘è¿è¡Œæ—¶è®¡ç®—ã€‚å¸¸é‡æŠ˜å å¯ä»¥æé«˜æ€§èƒ½ã€‚

**å¾ªç¯ä¼˜åŒ– (Loop Optimization)**: ä¼˜åŒ–å¾ªç¯ç»“æ„ï¼ŒåŒ…æ‹¬å¾ªç¯å±•å¼€ã€å¾ªç¯å‘é‡åŒ–ã€å¾ªç¯ä¸å˜å¼å¤–æç­‰ã€‚

### ä¼˜åŒ–çº§åˆ«

**O0 (æ— ä¼˜åŒ–)**: ä¸è¿›è¡Œä»»ä½•ä¼˜åŒ–ï¼Œç¼–è¯‘é€Ÿåº¦å¿«ï¼Œä½†ç”Ÿæˆçš„ä»£ç æ€§èƒ½è¾ƒä½ã€‚

**O1 (åŸºæœ¬ä¼˜åŒ–)**: è¿›è¡ŒåŸºæœ¬çš„ä¼˜åŒ–ï¼Œå¦‚æ­»ä»£ç æ¶ˆé™¤ã€å¸¸é‡æŠ˜å ç­‰ã€‚

**O2 (æ ‡å‡†ä¼˜åŒ–)**: è¿›è¡Œæ ‡å‡†ä¼˜åŒ–ï¼Œæ˜¯é»˜è®¤çš„ä¼˜åŒ–çº§åˆ«ï¼Œå¹³è¡¡äº†æ€§èƒ½å’Œç¼–è¯‘æ—¶é—´ã€‚

**O3 (æ¿€è¿›ä¼˜åŒ–)**: è¿›è¡Œæ¿€è¿›çš„ä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ›´å¤šçš„å†…è”å’Œå¾ªç¯ä¼˜åŒ–ï¼Œå¯èƒ½å¢åŠ ç¼–è¯‘æ—¶é—´ã€‚

**Os (ä¼˜åŒ–ä»£ç å¤§å°)**: ä¼˜åŒ–ä»£ç å¤§å°ï¼Œå‡å°‘äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ã€‚

**Oz (æœ€å¤§åŒ–ä»£ç å¤§å°ä¼˜åŒ–)**: æœ€å¤§åŒ–ä»£ç å¤§å°ä¼˜åŒ–ï¼Œè¿›ä¸€æ­¥å‡å°‘äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ã€‚

### ç›¸å…³æ¦‚å¿µ

**ä¼˜åŒ–é€šé“ (Optimization Pass)**: ç¼–è¯‘å™¨ä¼˜åŒ–è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé€šé“æ‰§è¡Œç‰¹å®šçš„ä¼˜åŒ–ã€‚

**ä¸­é—´è¡¨ç¤º (Intermediate Representation, IR)**: ç¼–è¯‘å™¨ä½¿ç”¨çš„ä¸­é—´ä»£ç è¡¨ç¤ºï¼Œä¼˜åŒ–åœ¨ IR ä¸Šè¿›è¡Œã€‚

**æ§åˆ¶æµå›¾ (Control Flow Graph, CFG)**: è¡¨ç¤ºç¨‹åºæ§åˆ¶æµçš„å›¾ç»“æ„ï¼Œç”¨äºæ§åˆ¶æµåˆ†æã€‚

**æ•°æ®æµåˆ†æ (Data Flow Analysis)**: åˆ†æç¨‹åºä¸­æ•°æ®çš„æµåŠ¨ï¼Œç”¨äºä¼˜åŒ–å’Œé”™è¯¯æ£€æµ‹ã€‚

**åˆ«ååˆ†æ (Alias Analysis)**: åˆ†æå†…å­˜åˆ«åå…³ç³»ï¼Œç”¨äºä¼˜åŒ–å†…å­˜è®¿é—®ã€‚

**å¯„å­˜å™¨åˆ†é… (Register Allocation)**: å°†å˜é‡åˆ†é…åˆ°å¯„å­˜å™¨ï¼Œå‡å°‘å†…å­˜è®¿é—®ã€‚

**æŒ‡ä»¤è°ƒåº¦ (Instruction Scheduling)**: é‡æ–°æ’åˆ—æŒ‡ä»¤é¡ºåºï¼Œæé«˜æŒ‡ä»¤çº§å¹¶è¡Œæ€§ã€‚

### ç†è®ºèƒŒæ™¯

**ç¼–è¯‘å™¨ä¼˜åŒ–ç†è®º (Compiler Optimization Theory)**: ç ”ç©¶ç¼–è¯‘å™¨ä¼˜åŒ–çš„ç†è®ºï¼ŒåŒ…æ‹¬ä¼˜åŒ–ç®—æ³•ã€ä¼˜åŒ–æ•ˆæœåˆ†æç­‰ã€‚

**ç¨‹åºåˆ†æç†è®º (Program Analysis Theory)**: ç ”ç©¶ç¨‹åºåˆ†æçš„ç†è®ºï¼ŒåŒ…æ‹¬æ§åˆ¶æµåˆ†æã€æ•°æ®æµåˆ†æç­‰ã€‚

**ä»£ç ç”Ÿæˆç†è®º (Code Generation Theory)**: ç ”ç©¶ä»£ç ç”Ÿæˆçš„ç†è®ºï¼ŒåŒ…æ‹¬å¯„å­˜å™¨åˆ†é…ã€æŒ‡ä»¤é€‰æ‹©ç­‰ã€‚

**æ€§èƒ½ä¼˜åŒ–ç†è®º (Performance Optimization Theory)**: ç ”ç©¶æ€§èƒ½ä¼˜åŒ–çš„ç†è®ºï¼ŒåŒ…æ‹¬ä¼˜åŒ–ç­–ç•¥ã€ä¼˜åŒ–æ•ˆæœè¯„ä¼°ç­‰ã€‚

---

## ğŸ”¬ å®éªŒè®¾è®¡

### 1. ä¼˜åŒ–æ•ˆæœæµ‹è¯•

ä½¿ç”¨ä¸åŒä¼˜åŒ–çº§åˆ«ç¼–è¯‘ä»£ç ï¼Œæ¯”è¾ƒæ€§èƒ½ï¼š

```bash
# æ— ä¼˜åŒ–
cargo build --release -- -C opt-level=0

# æ ‡å‡†ä¼˜åŒ–
cargo build --release -- -C opt-level=2

# æ¿€è¿›ä¼˜åŒ–
cargo build --release -- -C opt-level=3
```

### 2. ä¼˜åŒ–ç±»å‹æµ‹è¯•

æµ‹è¯•ä¸åŒç±»å‹çš„ä¼˜åŒ–æ•ˆæœï¼š

- **å†…è”ä¼˜åŒ–**: æµ‹è¯•å‡½æ•°å†…è”çš„æ•ˆæœ
- **å¾ªç¯ä¼˜åŒ–**: æµ‹è¯•å¾ªç¯ä¼˜åŒ–çš„æ•ˆæœ
- **å¸¸é‡æŠ˜å **: æµ‹è¯•å¸¸é‡æŠ˜å çš„æ•ˆæœ

### 3. ä»£ç æ¨¡å¼æµ‹è¯•

æµ‹è¯•ä¸åŒä»£ç æ¨¡å¼çš„ä¼˜åŒ–æ•ˆæœï¼š

- **å‡½æ•°å¼é£æ ¼**: æµ‹è¯•å‡½æ•°å¼ä»£ç çš„ä¼˜åŒ–
- **å‘½ä»¤å¼é£æ ¼**: æµ‹è¯•å‘½ä»¤å¼ä»£ç çš„ä¼˜åŒ–
- **è¿­ä»£å™¨**: æµ‹è¯•è¿­ä»£å™¨çš„ä¼˜åŒ–

---

## ğŸ“Š å®éªŒç»“æœ

### å¾…æµ‹è¯•çš„åœºæ™¯

1. **ä¼˜åŒ–çº§åˆ«**: ä¸åŒä¼˜åŒ–çº§åˆ«çš„æ€§èƒ½æ¯”è¾ƒ
2. **ä¼˜åŒ–ç±»å‹**: ä¸åŒç±»å‹ä¼˜åŒ–çš„æ•ˆæœ
3. **ä»£ç æ¨¡å¼**: ä¸åŒä»£ç æ¨¡å¼çš„ä¼˜åŒ–æ•ˆæœ

### ç»“æœåˆ†æ

- **ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**: å¯¹æ¯”ä¸åŒä¼˜åŒ–çš„æ•ˆæœ
- **ç¼–å†™å»ºè®®**: æä¾›ç¼–å†™ç¼–è¯‘å™¨å‹å¥½ä»£ç çš„å»ºè®®
- **æœ€ä½³å®è·µ**: æ€»ç»“æœ€ä½³å®è·µ

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1: å†…è”ä¼˜åŒ–

```rust
#[inline(never)]  // ç¦æ­¢å†…è”
fn add_no_inline(a: i32, b: i32) -> i32 {
    a + b
}

#[inline(always)]  // å¼ºåˆ¶å†…è”
fn add_always_inline(a: i32, b: i32) -> i32 {
    a + b
}

fn main() {
    let result1 = add_no_inline(10, 20);
    let result2 = add_always_inline(10, 20);
    println!("{} {}", result1, result2);
}
```

### ç¤ºä¾‹ 2: å¾ªç¯ä¼˜åŒ–

```rust
// ä¼˜åŒ–å‰ï¼šå¯èƒ½æ— æ³•ä¼˜åŒ–
fn sum_naive(data: &[i32]) -> i32 {
    let mut sum = 0;
    for i in 0..data.len() {
        sum += data[i];
    }
    sum
}

// ä¼˜åŒ–åï¼šç¼–è¯‘å™¨å‹å¥½
fn sum_optimized(data: &[i32]) -> i32 {
    data.iter().sum()
}

fn main() {
    let data: Vec<i32> = (0..1000).collect();
    let result1 = sum_naive(&data);
    let result2 = sum_optimized(&data);
    println!("{} {}", result1, result2);
}
```

### ç¤ºä¾‹ 3: å¸¸é‡æŠ˜å 

```rust
// ç¼–è¯‘æ—¶è®¡ç®—
const CONSTANT_VALUE: i32 = 10 * 20 + 5;

// è¿è¡Œæ—¶è®¡ç®—ï¼ˆå¯èƒ½è¢«ä¼˜åŒ–ä¸ºå¸¸é‡ï¼‰
fn compute_value() -> i32 {
    10 * 20 + 5
}

fn main() {
    let value1 = CONSTANT_VALUE;
    let value2 = compute_value();
    println!("{} {}", value1, value2);
}
```

### ç¤ºä¾‹ 4: æŸ¥çœ‹ä¼˜åŒ–åçš„æ±‡ç¼–

```rust
// ä½¿ç”¨ #[no_mangle] å’Œ extern "C" æŸ¥çœ‹æ±‡ç¼–
#[no_mangle]
pub extern "C" fn optimized_function(x: i32) -> i32 {
    x * 2 + 1
}

// ç¼–è¯‘åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ±‡ç¼–ï¼š
// cargo build --release
// objdump -d target/release/libname.so | grep optimized_function
```

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

### å·¥å…·æ–‡æ¡£

- [Rust ç¼–è¯‘å™¨ä¼˜åŒ–](https://doc.rust-lang.org/rustc/codegen-options/index.html)
- [LLVM ä¼˜åŒ–](https://llvm.org/docs/Passes.html)
- [Godbolt ç¼–è¯‘å™¨èµ„æºç®¡ç†å™¨](https://godbolt.org/)

### ç›¸å…³ä»£ç 

- [ä¼˜åŒ–ç¤ºä¾‹](../../../crates/c08_algorithms/benches/)
- [æ€§èƒ½æµ‹è¯•](../../../crates/c06_async/benches/)

### æœ€ä½³å®è·µ

- [Rust æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://nnethercote.github.io/perf-book/)
- [ç¼–å†™ç¼–è¯‘å™¨å‹å¥½ä»£ç ](https://doc.rust-lang.org/book/ch14-06-performance.html)

---

## ğŸ”„ ç ”ç©¶è¿›å±•

### å·²å®Œæˆ âœ…

- [x] ç ”ç©¶ç›®æ ‡å®šä¹‰
- [x] ç†è®ºåŸºç¡€æ•´ç†ï¼ˆåŒ…æ‹¬ç†è®ºèƒŒæ™¯å’Œç›¸å…³æ¦‚å¿µï¼‰
- [x] å®éªŒè®¾è®¡æ¡†æ¶
- [x] åŸºæœ¬ä»£ç ç¤ºä¾‹

### è¿›è¡Œä¸­ ğŸ”„

- [ ] å…·ä½“å®éªŒè®¾è®¡
- [ ] æ•°æ®æ”¶é›†
- [ ] ç»“æœåˆ†æ

### è®¡åˆ’ä¸­ ğŸ“‹

- [ ] ä¼˜åŒ–æ•ˆæœè¯„ä¼°
- [ ] ç¼–å†™å»ºè®®æŒ‡å—
- [ ] å®é™…åº”ç”¨æ¡ˆä¾‹

---

**ç»´æŠ¤è€…**: Rust Performance Research Group
**æœ€åæ›´æ–°**: 2025-01-27
**çŠ¶æ€**: ğŸ”„ **è¿›è¡Œä¸­**
