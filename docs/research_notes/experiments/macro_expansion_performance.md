# å®å±•å¼€æ€§èƒ½åˆ†æ

> **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
> **æœ€åæ›´æ–°**: 2025-01-27
> **Rust ç‰ˆæœ¬**: 1.91.0 (Edition 2024) âœ…
> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­

---

## ğŸ“Š ç›®å½•

- [å®å±•å¼€æ€§èƒ½åˆ†æ](#å®å±•å¼€æ€§èƒ½åˆ†æ)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ ç ”ç©¶ç›®æ ‡](#-ç ”ç©¶ç›®æ ‡)
    - [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
    - [é¢„æœŸæˆæœ](#é¢„æœŸæˆæœ)
  - [ğŸ“š ç†è®ºåŸºç¡€](#-ç†è®ºåŸºç¡€)
    - [å®ç³»ç»Ÿ](#å®ç³»ç»Ÿ)
    - [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
    - [ç›¸å…³æ¦‚å¿µ](#ç›¸å…³æ¦‚å¿µ)
    - [ç†è®ºèƒŒæ™¯](#ç†è®ºèƒŒæ™¯)
  - [ğŸ”¬ å®éªŒè®¾è®¡](#-å®éªŒè®¾è®¡)
    - [1. æµ‹è¯•æ¡†æ¶](#1-æµ‹è¯•æ¡†æ¶)
    - [2. æµ‹è¯•åœºæ™¯](#2-æµ‹è¯•åœºæ™¯)
    - [3. æ•°æ®æ”¶é›†](#3-æ•°æ®æ”¶é›†)
  - [ğŸ“Š å®éªŒç»“æœ](#-å®éªŒç»“æœ)
    - [å¾…æµ‹è¯•çš„åœºæ™¯](#å¾…æµ‹è¯•çš„åœºæ™¯)
    - [ç»“æœåˆ†æ](#ç»“æœåˆ†æ)
  - [ğŸ’» ä»£ç ç¤ºä¾‹](#-ä»£ç ç¤ºä¾‹)
    - [ç¤ºä¾‹ 1: å£°æ˜å®æ€§èƒ½](#ç¤ºä¾‹-1-å£°æ˜å®æ€§èƒ½)
    - [ç¤ºä¾‹ 2: è¿‡ç¨‹å®æ€§èƒ½](#ç¤ºä¾‹-2-è¿‡ç¨‹å®æ€§èƒ½)
    - [ç¤ºä¾‹ 3: å®å±•å¼€æ—¶é—´æµ‹é‡](#ç¤ºä¾‹-3-å®å±•å¼€æ—¶é—´æµ‹é‡)
  - [ğŸ“– å‚è€ƒæ–‡çŒ®](#-å‚è€ƒæ–‡çŒ®)
    - [å·¥å…·æ–‡æ¡£](#å·¥å…·æ–‡æ¡£)
    - [ç›¸å…³ä»£ç ](#ç›¸å…³ä»£ç )
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [ğŸ”„ ç ”ç©¶è¿›å±•](#-ç ”ç©¶è¿›å±•)
    - [å·²å®Œæˆ âœ…](#å·²å®Œæˆ-)
    - [è¿›è¡Œä¸­ ğŸ”„](#è¿›è¡Œä¸­-)
    - [è®¡åˆ’ä¸­ ğŸ“‹](#è®¡åˆ’ä¸­-)

---

## ğŸ¯ ç ”ç©¶ç›®æ ‡

æœ¬ç ”ç©¶çš„ç›®çš„æ˜¯åˆ†æ Rust å®ç³»ç»Ÿçš„æ€§èƒ½ç‰¹å¾ï¼Œè¯†åˆ«å®å±•å¼€çš„æ€§èƒ½ç“¶é¢ˆã€‚

### æ ¸å¿ƒé—®é¢˜

1. **å®å±•å¼€æ€§èƒ½**: ä¸åŒå®çš„å±•å¼€æ€§èƒ½å¦‚ä½•ï¼Ÿ
2. **ç¼–è¯‘æ—¶é—´å½±å“**: å®å¯¹ç¼–è¯‘æ—¶é—´çš„å½±å“å¦‚ä½•ï¼Ÿ
3. **ä¼˜åŒ–ç­–ç•¥**: å¦‚ä½•ä¼˜åŒ–å®å±•å¼€æ€§èƒ½ï¼Ÿ

### é¢„æœŸæˆæœ

- å®å±•å¼€æ€§èƒ½åˆ†ææŠ¥å‘Š
- ç¼–è¯‘æ—¶é—´ä¼˜åŒ–å»ºè®®
- å®ä½¿ç”¨æœ€ä½³å®è·µæŒ‡å—

---

## ğŸ“š ç†è®ºåŸºç¡€

### å®ç³»ç»Ÿ

**å£°æ˜å® (Declarative Macros)**: ä½¿ç”¨ `macro_rules!` å®šä¹‰çš„å®ã€‚å£°æ˜å®é€šè¿‡æ¨¡å¼åŒ¹é…è¿›è¡Œå±•å¼€ï¼Œé€‚åˆç®€å•çš„ä»£ç ç”Ÿæˆã€‚

**è¿‡ç¨‹å® (Procedural Macros)**: ä½¿ç”¨å‡½æ•°å¼å®ã€æ´¾ç”Ÿå®ã€å±æ€§å®å®šä¹‰çš„å®ã€‚è¿‡ç¨‹å®åœ¨ç¼–è¯‘æ—¶æ‰§è¡Œ Rust ä»£ç ï¼Œæä¾›æ›´å¼ºå¤§çš„ä»£ç ç”Ÿæˆèƒ½åŠ›ã€‚

**å®å±•å¼€ (Macro Expansion)**: ç¼–è¯‘æ—¶å°†å®å±•å¼€ä¸ºä»£ç çš„è¿‡ç¨‹ã€‚å®å±•å¼€æ˜¯ç¼–è¯‘è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå½±å“ç¼–è¯‘æ—¶é—´å’Œä»£ç ç”Ÿæˆã€‚

### æ€§èƒ½æŒ‡æ ‡

**å±•å¼€æ—¶é—´ (Expansion Time)**: å®å±•å¼€æ‰€éœ€çš„æ—¶é—´ï¼Œå½±å“ç¼–è¯‘æ—¶é—´ã€‚å±•å¼€æ—¶é—´å–å†³äºå®çš„å¤æ‚åº¦å’Œè¾“å…¥å¤§å°ã€‚

**ç¼–è¯‘æ—¶é—´ (Compilation Time)**: å®å¯¹ç¼–è¯‘æ—¶é—´çš„å½±å“ã€‚å®å±•å¼€ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´ï¼Œéœ€è¦ä¼˜åŒ–å®å±•å¼€æ€§èƒ½ã€‚

**ä»£ç å¤§å° (Code Size)**: å®å±•å¼€åçš„ä»£ç å¤§å°ï¼Œå½±å“äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ã€‚å®å±•å¼€å¯èƒ½ç”Ÿæˆå¤§é‡ä»£ç ã€‚

**å†…å­˜ä½¿ç”¨ (Memory Usage)**: å®å±•å¼€è¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨ï¼Œå½±å“ç¼–è¯‘å™¨çš„å†…å­˜æ¶ˆè€—ã€‚

### ç›¸å…³æ¦‚å¿µ

**å®å±•å¼€å™¨ (Macro Expander)**: è´Ÿè´£å®å±•å¼€çš„ç¼–è¯‘å™¨ç»„ä»¶ã€‚å®å±•å¼€å™¨è§£æå®è°ƒç”¨å¹¶ç”Ÿæˆå±•å¼€åçš„ä»£ç ã€‚

**å«ç”Ÿå® (Hygienic Macros)**: ä¿è¯å®å±•å¼€ä¸ä¼šå¼•å…¥å‘½åå†²çªçš„å®ã€‚Rust çš„å®ç³»ç»Ÿæ˜¯å«ç”Ÿçš„ã€‚

**å®é€’å½’ (Macro Recursion)**: å®å¯ä»¥é€’å½’è°ƒç”¨è‡ªèº«ï¼Œç”¨äºç”Ÿæˆå¤æ‚çš„æ•°æ®ç»“æ„ã€‚

**Token æ ‘ (Token Tree)**: å®å±•å¼€è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸­é—´è¡¨ç¤ºï¼Œè¡¨ç¤ºæºä»£ç çš„è¯­æ³•ç»“æ„ã€‚

**ç¼–è¯‘æ—¶è®¡ç®— (Compile-Time Computation)**: åœ¨ç¼–è¯‘æ—¶æ‰§è¡Œçš„è®¡ç®—ï¼Œå®å±•å¼€æ˜¯ç¼–è¯‘æ—¶è®¡ç®—çš„ä¸€ç§å½¢å¼ã€‚

**ä»£ç ç”Ÿæˆ (Code Generation)**: é€šè¿‡å®ç”Ÿæˆä»£ç çš„è¿‡ç¨‹ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚

### ç†è®ºèƒŒæ™¯

**å®ç³»ç»Ÿç†è®º (Macro System Theory)**: ç ”ç©¶å®ç³»ç»Ÿçš„ç†è®ºï¼ŒåŒ…æ‹¬å®å±•å¼€ç®—æ³•ã€å«ç”Ÿæ€§ä¿è¯ç­‰ã€‚

**ç¼–è¯‘æ—¶è®¡ç®—ç†è®º (Compile-Time Computation Theory)**: ç ”ç©¶ç¼–è¯‘æ—¶è®¡ç®—çš„ç†è®ºï¼ŒåŒ…æ‹¬å¸¸é‡æ±‚å€¼ã€ä»£ç ç”Ÿæˆç­‰ã€‚

**ä»£ç ç”Ÿæˆç†è®º (Code Generation Theory)**: ç ”ç©¶ä»£ç ç”Ÿæˆçš„ç†è®ºï¼ŒåŒ…æ‹¬æ¨¡æ¿ç³»ç»Ÿã€å®ç³»ç»Ÿç­‰ã€‚

**æ€§èƒ½ä¼˜åŒ–ç†è®º (Performance Optimization Theory)**: ç ”ç©¶å®å±•å¼€æ€§èƒ½ä¼˜åŒ–çš„ç†è®ºï¼ŒåŒ…æ‹¬å±•å¼€ç®—æ³•ä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥ç­‰ã€‚

---

## ğŸ”¬ å®éªŒè®¾è®¡

### 1. æµ‹è¯•æ¡†æ¶

ä½¿ç”¨ç¼–è¯‘æ—¶é—´æµ‹é‡å·¥å…·å’Œè‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶ï¼š

```rust
use std::time::Instant;

fn measure_macro_expansion() {
    let start = Instant::now();

    // ä½¿ç”¨å®
    my_macro! {
        // å®å†…å®¹
    }

    let duration = start.elapsed();
    println!("å®å±•å¼€æ—¶é—´: {:?}", duration);
}
```

### 2. æµ‹è¯•åœºæ™¯

- **ç®€å•å®**: æµ‹è¯•ç®€å•å®çš„å±•å¼€æ€§èƒ½
- **å¤æ‚å®**: æµ‹è¯•å¤æ‚å®çš„å±•å¼€æ€§èƒ½
- **é€’å½’å®**: æµ‹è¯•é€’å½’å®çš„å±•å¼€æ€§èƒ½
- **è¿‡ç¨‹å®**: æµ‹è¯•è¿‡ç¨‹å®çš„æ€§èƒ½

### 3. æ•°æ®æ”¶é›†

- **å±•å¼€æ—¶é—´**: æ”¶é›†ä¸åŒå®çš„å±•å¼€æ—¶é—´
- **ç¼–è¯‘æ—¶é—´**: æ”¶é›†å®å¯¹ç¼–è¯‘æ—¶é—´çš„å½±å“
- **ä»£ç å¤§å°**: æ”¶é›†å®å±•å¼€åçš„ä»£ç å¤§å°

---

## ğŸ“Š å®éªŒç»“æœ

### å¾…æµ‹è¯•çš„åœºæ™¯

1. **å£°æ˜å®æ€§èƒ½**: æµ‹è¯•å£°æ˜å®çš„å±•å¼€æ€§èƒ½
2. **è¿‡ç¨‹å®æ€§èƒ½**: æµ‹è¯•è¿‡ç¨‹å®çš„æ€§èƒ½
3. **å®ç¼“å­˜æ•ˆæœ**: æµ‹è¯•å®å±•å¼€ç¼“å­˜çš„æ•ˆæœ
4. **ç¼–è¯‘æ—¶é—´å½±å“**: æµ‹è¯•å®å¯¹ç¼–è¯‘æ—¶é—´çš„å½±å“

### ç»“æœåˆ†æ

- **æ€§èƒ½å¯¹æ¯”**: å¯¹æ¯”ä¸åŒå®çš„æ€§èƒ½
- **ç“¶é¢ˆè¯†åˆ«**: è¯†åˆ«å®å±•å¼€æ€§èƒ½ç“¶é¢ˆ
- **ä¼˜åŒ–å»ºè®®**: æä¾›å®ä¼˜åŒ–å»ºè®®

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1: å£°æ˜å®æ€§èƒ½

```rust
macro_rules! simple_macro {
    ($x:expr) => {
        $x * 2
    };
}

macro_rules! complex_macro {
    ($($x:expr),*) => {
        {
            let mut sum = 0;
            $(sum += $x;)*
            sum
        }
    };
}

fn main() {
    // ç®€å•å®
    let result1 = simple_macro!(10);

    // å¤æ‚å®
    let result2 = complex_macro!(1, 2, 3, 4, 5);

    println!("{} {}", result1, result2);
}
```

### ç¤ºä¾‹ 2: è¿‡ç¨‹å®æ€§èƒ½

```rust
use proc_macro::TokenStream;

#[proc_macro]
pub fn my_proc_macro(input: TokenStream) -> TokenStream {
    // è¿‡ç¨‹å®å®ç°
    input
}

// ä½¿ç”¨
my_proc_macro! {
    // ä»£ç 
}
```

### ç¤ºä¾‹ 3: å®å±•å¼€æ—¶é—´æµ‹é‡

```rust
use std::time::Instant;

macro_rules! timed_macro {
    ($name:expr, $body:block) => {
        {
            let start = Instant::now();
            let result = $body;
            let duration = start.elapsed();
            println!("{} è€—æ—¶: {:?}", $name, duration);
            result
        }
    };
}

fn main() {
    timed_macro!("è®¡ç®—", {
        let mut sum = 0;
        for i in 0..1000000 {
            sum += i;
        }
        sum
    });
}
```

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

### å·¥å…·æ–‡æ¡£

- [cargo-expand](https://github.com/dtolnay/cargo-expand): å®å±•å¼€å·¥å…·
- [Rust å®æ–‡æ¡£](https://doc.rust-lang.org/book/ch19-06-macros.html)
- [è¿‡ç¨‹å®æ–‡æ¡£](https://doc.rust-lang.org/reference/procedural-macros.html)

### ç›¸å…³ä»£ç 

- [å®ç³»ç»Ÿå®ç°](../../../crates/c11_macro_system/src/)
- [å®ç³»ç»Ÿç¤ºä¾‹](../../../crates/c11_macro_system/examples/)

### æœ€ä½³å®è·µ

- [å®ä½¿ç”¨æœ€ä½³å®è·µ](https://doc.rust-lang.org/book/ch19-06-macros.html)
- [ç¼–è¯‘æ—¶é—´ä¼˜åŒ–](https://nnethercote.github.io/perf-book/compile-times.html)

---

## ğŸ”„ ç ”ç©¶è¿›å±•

### å·²å®Œæˆ âœ…

- [x] ç ”ç©¶ç›®æ ‡å®šä¹‰
- [x] ç†è®ºåŸºç¡€æ•´ç†ï¼ˆåŒ…æ‹¬ç†è®ºèƒŒæ™¯å’Œç›¸å…³æ¦‚å¿µï¼‰
- [x] å®éªŒè®¾è®¡æ¡†æ¶
- [x] åŸºæœ¬ä»£ç ç¤ºä¾‹

### è¿›è¡Œä¸­ ğŸ”„

- [ ] å…·ä½“å®éªŒè®¾è®¡
- [ ] æ•°æ®æ”¶é›†
- [ ] ç»“æœåˆ†æ

### è®¡åˆ’ä¸­ ğŸ“‹

- [ ] æ€§èƒ½ä¼˜åŒ–å»ºè®®
- [ ] å®é™…åº”ç”¨æ¡ˆä¾‹
- [ ] å·¥å…·æ”¹è¿›

---

**ç»´æŠ¤è€…**: Rust Performance Research Group
**æœ€åæ›´æ–°**: 2025-01-27
**çŠ¶æ€**: ğŸ”„ **è¿›è¡Œä¸­**
