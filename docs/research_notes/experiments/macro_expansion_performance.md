# å®å±•å¼€æ€§èƒ½åˆ†æ

> **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
> **æœ€åæ›´æ–°**: 2025-01-27
> **Rust ç‰ˆæœ¬**: 1.91.0 (Edition 2024) âœ…
> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­

---

## ğŸ“Š ç›®å½•

- [å®å±•å¼€æ€§èƒ½åˆ†æ](#å®å±•å¼€æ€§èƒ½åˆ†æ)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ ç ”ç©¶ç›®æ ‡](#-ç ”ç©¶ç›®æ ‡)
    - [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
    - [é¢„æœŸæˆæœ](#é¢„æœŸæˆæœ)
  - [ğŸ“š ç†è®ºåŸºç¡€](#-ç†è®ºåŸºç¡€)
    - [å®ç³»ç»Ÿ](#å®ç³»ç»Ÿ)
    - [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
    - [ä¼˜åŒ–ç­–ç•¥](#ä¼˜åŒ–ç­–ç•¥)
  - [ğŸ”¬ å®éªŒè®¾è®¡](#-å®éªŒè®¾è®¡)
    - [1. æµ‹è¯•æ¡†æ¶](#1-æµ‹è¯•æ¡†æ¶)
    - [2. æµ‹è¯•åœºæ™¯](#2-æµ‹è¯•åœºæ™¯)
    - [3. æ•°æ®æ”¶é›†](#3-æ•°æ®æ”¶é›†)
  - [ğŸ“Š å®éªŒç»“æœ](#-å®éªŒç»“æœ)
    - [å¾…æµ‹è¯•çš„åœºæ™¯](#å¾…æµ‹è¯•çš„åœºæ™¯)
    - [ç»“æœåˆ†æ](#ç»“æœåˆ†æ)
  - [ğŸ’» ä»£ç ç¤ºä¾‹](#-ä»£ç ç¤ºä¾‹)
    - [ç¤ºä¾‹ 1: å£°æ˜å®æ€§èƒ½](#ç¤ºä¾‹-1-å£°æ˜å®æ€§èƒ½)
    - [ç¤ºä¾‹ 2: è¿‡ç¨‹å®æ€§èƒ½](#ç¤ºä¾‹-2-è¿‡ç¨‹å®æ€§èƒ½)
    - [ç¤ºä¾‹ 3: å®å±•å¼€æ—¶é—´æµ‹é‡](#ç¤ºä¾‹-3-å®å±•å¼€æ—¶é—´æµ‹é‡)
  - [ğŸ“– å‚è€ƒæ–‡çŒ®](#-å‚è€ƒæ–‡çŒ®)
    - [å·¥å…·æ–‡æ¡£](#å·¥å…·æ–‡æ¡£)
    - [ç›¸å…³ä»£ç ](#ç›¸å…³ä»£ç )
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [ğŸ”„ ç ”ç©¶è¿›å±•](#-ç ”ç©¶è¿›å±•)
    - [å·²å®Œæˆ âœ…](#å·²å®Œæˆ-)
    - [è¿›è¡Œä¸­ ğŸ”„](#è¿›è¡Œä¸­-)
    - [è®¡åˆ’ä¸­ ğŸ“‹](#è®¡åˆ’ä¸­-)

---

## ğŸ¯ ç ”ç©¶ç›®æ ‡

æœ¬ç ”ç©¶çš„ç›®çš„æ˜¯åˆ†æ Rust å®ç³»ç»Ÿçš„æ€§èƒ½ç‰¹å¾ï¼Œè¯†åˆ«å®å±•å¼€çš„æ€§èƒ½ç“¶é¢ˆã€‚

### æ ¸å¿ƒé—®é¢˜

1. **å®å±•å¼€æ€§èƒ½**: ä¸åŒå®çš„å±•å¼€æ€§èƒ½å¦‚ä½•ï¼Ÿ
2. **ç¼–è¯‘æ—¶é—´å½±å“**: å®å¯¹ç¼–è¯‘æ—¶é—´çš„å½±å“å¦‚ä½•ï¼Ÿ
3. **ä¼˜åŒ–ç­–ç•¥**: å¦‚ä½•ä¼˜åŒ–å®å±•å¼€æ€§èƒ½ï¼Ÿ

### é¢„æœŸæˆæœ

- å®å±•å¼€æ€§èƒ½åˆ†ææŠ¥å‘Š
- ç¼–è¯‘æ—¶é—´ä¼˜åŒ–å»ºè®®
- å®ä½¿ç”¨æœ€ä½³å®è·µæŒ‡å—

---

## ğŸ“š ç†è®ºåŸºç¡€

### å®ç³»ç»Ÿ

1. **å£°æ˜å® (macro_rules!)**: åŸºäºæ¨¡å¼åŒ¹é…çš„å®
2. **è¿‡ç¨‹å®**: åŸºäºä»£ç ç”Ÿæˆçš„å®
3. **å±æ€§å®**: åŸºäºå±æ€§çš„å®
4. **æ´¾ç”Ÿå®**: è‡ªåŠ¨å®ç°çš„å®

### æ€§èƒ½æŒ‡æ ‡

- **å±•å¼€æ—¶é—´**: å®å±•å¼€æ‰€éœ€çš„æ—¶é—´
- **ç¼–è¯‘æ—¶é—´**: å®å¯¹æ•´ä½“ç¼–è¯‘æ—¶é—´çš„å½±å“
- **ä»£ç å¤§å°**: å®å±•å¼€åçš„ä»£ç å¤§å°
- **ç¼“å­˜æ•ˆæœ**: å®å±•å¼€ç¼“å­˜çš„æ•ˆæœ

### ä¼˜åŒ–ç­–ç•¥

- **å®å±•å¼€ç¼“å­˜**: ç¼“å­˜å·²å±•å¼€çš„å®
- **å¢é‡ç¼–è¯‘**: åˆ©ç”¨å¢é‡ç¼–è¯‘ä¼˜åŒ–
- **å®ç®€åŒ–**: ç®€åŒ–å®å®šä¹‰å‡å°‘å±•å¼€æ—¶é—´

---

## ğŸ”¬ å®éªŒè®¾è®¡

### 1. æµ‹è¯•æ¡†æ¶

ä½¿ç”¨ç¼–è¯‘æ—¶é—´æµ‹é‡å·¥å…·å’Œè‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶ï¼š

```rust
use std::time::Instant;

fn measure_macro_expansion() {
    let start = Instant::now();

    // ä½¿ç”¨å®
    my_macro! {
        // å®å†…å®¹
    }

    let duration = start.elapsed();
    println!("å®å±•å¼€æ—¶é—´: {:?}", duration);
}
```

### 2. æµ‹è¯•åœºæ™¯

- **ç®€å•å®**: æµ‹è¯•ç®€å•å®çš„å±•å¼€æ€§èƒ½
- **å¤æ‚å®**: æµ‹è¯•å¤æ‚å®çš„å±•å¼€æ€§èƒ½
- **é€’å½’å®**: æµ‹è¯•é€’å½’å®çš„å±•å¼€æ€§èƒ½
- **è¿‡ç¨‹å®**: æµ‹è¯•è¿‡ç¨‹å®çš„æ€§èƒ½

### 3. æ•°æ®æ”¶é›†

- **å±•å¼€æ—¶é—´**: æ”¶é›†ä¸åŒå®çš„å±•å¼€æ—¶é—´
- **ç¼–è¯‘æ—¶é—´**: æ”¶é›†å®å¯¹ç¼–è¯‘æ—¶é—´çš„å½±å“
- **ä»£ç å¤§å°**: æ”¶é›†å®å±•å¼€åçš„ä»£ç å¤§å°

---

## ğŸ“Š å®éªŒç»“æœ

### å¾…æµ‹è¯•çš„åœºæ™¯

1. **å£°æ˜å®æ€§èƒ½**: æµ‹è¯•å£°æ˜å®çš„å±•å¼€æ€§èƒ½
2. **è¿‡ç¨‹å®æ€§èƒ½**: æµ‹è¯•è¿‡ç¨‹å®çš„æ€§èƒ½
3. **å®ç¼“å­˜æ•ˆæœ**: æµ‹è¯•å®å±•å¼€ç¼“å­˜çš„æ•ˆæœ
4. **ç¼–è¯‘æ—¶é—´å½±å“**: æµ‹è¯•å®å¯¹ç¼–è¯‘æ—¶é—´çš„å½±å“

### ç»“æœåˆ†æ

- **æ€§èƒ½å¯¹æ¯”**: å¯¹æ¯”ä¸åŒå®çš„æ€§èƒ½
- **ç“¶é¢ˆè¯†åˆ«**: è¯†åˆ«å®å±•å¼€æ€§èƒ½ç“¶é¢ˆ
- **ä¼˜åŒ–å»ºè®®**: æä¾›å®ä¼˜åŒ–å»ºè®®

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1: å£°æ˜å®æ€§èƒ½

```rust
macro_rules! simple_macro {
    ($x:expr) => {
        $x * 2
    };
}

macro_rules! complex_macro {
    ($($x:expr),*) => {
        {
            let mut sum = 0;
            $(sum += $x;)*
            sum
        }
    };
}

fn main() {
    // ç®€å•å®
    let result1 = simple_macro!(10);

    // å¤æ‚å®
    let result2 = complex_macro!(1, 2, 3, 4, 5);

    println!("{} {}", result1, result2);
}
```

### ç¤ºä¾‹ 2: è¿‡ç¨‹å®æ€§èƒ½

```rust
use proc_macro::TokenStream;

#[proc_macro]
pub fn my_proc_macro(input: TokenStream) -> TokenStream {
    // è¿‡ç¨‹å®å®ç°
    input
}

// ä½¿ç”¨
my_proc_macro! {
    // ä»£ç 
}
```

### ç¤ºä¾‹ 3: å®å±•å¼€æ—¶é—´æµ‹é‡

```rust
use std::time::Instant;

macro_rules! timed_macro {
    ($name:expr, $body:block) => {
        {
            let start = Instant::now();
            let result = $body;
            let duration = start.elapsed();
            println!("{} è€—æ—¶: {:?}", $name, duration);
            result
        }
    };
}

fn main() {
    timed_macro!("è®¡ç®—", {
        let mut sum = 0;
        for i in 0..1000000 {
            sum += i;
        }
        sum
    });
}
```

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

### å·¥å…·æ–‡æ¡£

- [cargo-expand](https://github.com/dtolnay/cargo-expand): å®å±•å¼€å·¥å…·
- [Rust å®æ–‡æ¡£](https://doc.rust-lang.org/book/ch19-06-macros.html)
- [è¿‡ç¨‹å®æ–‡æ¡£](https://doc.rust-lang.org/reference/procedural-macros.html)

### ç›¸å…³ä»£ç 

- [å®ç³»ç»Ÿå®ç°](../../../crates/c11_macro_system/src/)
- [å®ç³»ç»Ÿç¤ºä¾‹](../../../crates/c11_macro_system/examples/)

### æœ€ä½³å®è·µ

- [å®ä½¿ç”¨æœ€ä½³å®è·µ](https://doc.rust-lang.org/book/ch19-06-macros.html)
- [ç¼–è¯‘æ—¶é—´ä¼˜åŒ–](https://nnethercote.github.io/perf-book/compile-times.html)

---

## ğŸ”„ ç ”ç©¶è¿›å±•

### å·²å®Œæˆ âœ…

- [x] ç ”ç©¶ç›®æ ‡å®šä¹‰
- [x] ç†è®ºåŸºç¡€æ•´ç†
- [x] å®éªŒè®¾è®¡æ¡†æ¶

### è¿›è¡Œä¸­ ğŸ”„

- [ ] å…·ä½“å®éªŒè®¾è®¡
- [ ] æ•°æ®æ”¶é›†
- [ ] ç»“æœåˆ†æ

### è®¡åˆ’ä¸­ ğŸ“‹

- [ ] æ€§èƒ½ä¼˜åŒ–å»ºè®®
- [ ] å®é™…åº”ç”¨æ¡ˆä¾‹
- [ ] å·¥å…·æ”¹è¿›

---

**ç»´æŠ¤è€…**: Rust Performance Research Group
**æœ€åæ›´æ–°**: 2025-01-27
**çŠ¶æ€**: ğŸ”„ **è¿›è¡Œä¸­**
