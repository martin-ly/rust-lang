# 宏系统概念思维导图

> **创建日期**: 2026-02-24
> **级别**: L1/L2
> **类型**: 思维导图

---

## 宏系统层次

```
                            Rust宏系统
                                 │
            ┌────────────────────┼────────────────────┐
            │                    │                    │
       【声明宏】            【过程宏】          【编译器插件】
            │                    │                    │
    ┌───────┴───────┐    ┌───────┴───────┐    ┌───────┴───────┐
    │               │    │               │    │               │
 macro_rules!   自定义派生   属性宏         函数宏   编译器API    Lint
    │               │      │               │      │               │
 模式匹配         derive   #[]           !调用   内部接口        自定义检查
```

---

## 声明宏 (macro_rules!)

```
声明宏结构
│
├── 匹配规则
│   ├── 模式: $( )*
│   ├── 重复: + * ?
│   └── 分隔: $( ),*
│
├── 捕获类型
│   ├── $x:expr (表达式)
│   ├── $t:ty (类型)
│   ├── $i:ident (标识符)
│   └── $l:lifetime (生命周期)
│
└── 卫生性
    └── 避免命名冲突
```

| 捕获 | 用途 | 示例 |
| :--- | :--- | :--- |
| `expr` | 任意表达式 | `1 + 2` |
| `ty` | 类型 | `Vec<i32>` |
| `ident` | 标识符 | `foo` |
| `path` | 路径 | `std::vec::Vec` |

---

## 过程宏

```
过程宏类型
│
├── 派生宏 (Derive)
│   └── #[derive(Debug)]
│
├── 属性宏 (Attribute)
│   └── #[test]
│
└── 函数宏 (Function-like)
    └── sql!(SELECT * FROM table)
```

---

## Token处理

```
Token流程
│
├── 解析
│   └── TokenStream
│
├── 转换
│   └── proc_macro2
│
└── 生成
    └── quote!宏
```

---

## 常见应用

```
宏应用
│
├── 代码生成
│   ├── Builder模式
│   └── 序列化
│
├── DSL
│   ├── vec![1, 2, 3]
│   └── format!("{}", x)
│
└── 测试
    └── assert_eq!
```

---

## 与其他概念的关系

```
宏系统
├── 编译过程 → 语法扩展阶段
├── 卫生性 → 避免作用域污染
└── 元编程 → 代码生成代码
```

---

**维护者**: Rust Formal Methods Research Team
**最后更新**: 2026-02-24
**状态**: ✅ 已完成 - 思维导图 13/15
