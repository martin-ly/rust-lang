# Unsafe Rust 概念思维导图

> **创建日期**: 2026-02-24
> **级别**: L1/L2
> **类型**: 思维导图

---

## 概念层次结构

```text
                            Unsafe Rust
                                 │
            ┌────────────────────┼────────────────────┐
            │                    │                    │
       【unsafe关键字】      【原始指针】          【FFI交互】
            │                    │                    │
    ┌───────┴───────┐    ┌───────┴───────┐    ┌───────┴───────┐
    │               │    │               │    │               │
unsafe fn    unsafe block *const T     *mut T  extern        #[no_mangle]
    │               │      │               │      │               │
unsafe trait  unsafe impl  不可变原始指针 可变原始指针 C接口         符号导出
```

---

## unsafe的五种能力

```text
unsafe赋予的额外能力
│
├── 解引用原始指针
│   ├── *const T
│   └── *mut T
│
├── 调用unsafe函数
│   ├── std::str::from_utf8_unchecked
│   └── 自定义unsafe API
│
├── 实现unsafe trait
│   ├── Send
│   ├── Sync
│   └── GlobalAlloc
│
├── 访问union字段
│   └── 联合体内存复用
│
└── 修改可变静态变量
    └── static mut
```

---

## 安全抽象原则

```text
安全抽象层次
│
├── 公开API (safe)
│   └── 保证unsafe内部安全
│
└── 内部实现 (unsafe)
    ├── 原始指针操作
    ├── 内存布局控制
    └── 性能优化
```

| 层次 | 责任 | 保证 |
| :--- | :--- | :--- |
| 公开API | 维护不变式 | 调用者无需unsafe |
| 内部实现 | 正确使用unsafe | 不违反内存安全 |

---

## 常见使用场景

```text
应用场景
│
├── 与C库交互 (FFI)
│   └── bindgen生成的代码
│
├── 性能关键路径
│   └── 避免边界检查
│
├── 内存布局控制
│   └── 自定义数据结构
│
├── 并发原语
│   └── Atomic操作底层
│
└── 自引用结构
    └── Pin的内部实现
```

---

## 不变式维护

```text
unsafe代码的不变式
│
├── 内存安全
│   ├── 无悬垂指针
│   ├── 无双重释放
│   └── 无数据竞争
│
├── 类型安全
│   ├── 正确初始化
│   └── 合法transmute
│
└── 逻辑正确
    ├── 前置条件检查
    └── 后置条件保证
```

---

## 学习路径

1. **L1**: 理解unsafe边界
2. **L2**: 掌握安全抽象封装
3. **L3**: 熟练FFI与原始指针

---

**维护者**: Rust Formal Methods Research Team
**最后更新**: 2026-02-24
**状态**: ✅ 已完成 - 思维导图 10/15
