# 所有权概念族谱

> **创建日期**: 2026-02-24
> **更新状态**: 完善 (Phase 1 Week 5)
> **任务ID**: P1-W5-T1

---

## 所有权概念全景

```text
                        所有权概念族
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
   【核心概念】            【派生概念】            【相关概念】
        │                      │                      │
    ├─所有权              ├─Move语义            ├─Send
    │  ├─唯一性           │  ├─转移所有权        │  └─跨线程转移
    │  ├─排他性           │  ├─原变量失效        │
    │  └─生命周期绑定     │  └─Copy trait        ├─Sync
    │                     │     ├─标量类型       │  └─跨线程共享
    ├─借用                │     ├─元组           │
    │  ├─&T (共享)        │     └─数组           ├─Pin
    │  │  ├─只读          │                      │  └─固定位置
    │  │  ├─多个共存      └─Drop trait           │
    │  │  └─不可变        └─析构资源              └─Unpin
    │  │                                         └─可移动
    │  └─&mut T (独占)
    │     ├─读写
    │     ├─唯一
    │     └─排他
    │
    └─生命周期
       ├─'static
       ├─'a (泛型)
       └─省略规则
```

---

## 一、核心概念详解

### 1.1 所有权 (Ownership)

```text
所有权
├── 唯一性 (Uniqueness)
│   └── 定理T-OW2: ∀v, ∃!x, owns(x, v)
│
├── 排他性 (Exclusivity)
│   └── 所有者拥有完全控制权
│
└── 生命周期绑定 (Lifetime Binding)
    └── 值的生命周期与所有者作用域绑定
```

**理解要点**:

- 就像一本书只能在一个人的书架上
- 书的位置始终明确，不会丢失或重复

### 1.2 借用 (Borrowing)

```text
借用
├── &T (不可变借用)
│   ├── 只读访问
│   ├── 多个共存
│   │   └── 可以同时存在多个& T
│   └── 不转移所有权
│       └── 原变量仍然有效
│
└── &mut T (可变借用)
    ├── 读写访问
    ├── 唯一性
    │   └── 只能有一个&mut T
    ├── 排他性
    │   └── 不能有其他借用
    └── 暂时转移
        └── 借用期间原变量不能访问
```

**借用规则**:

```
Rule 1: 要么多个&，要么一个&mut
Rule 2: 引用必须始终有效
```

### 1.3 生命周期 (Lifetime)

```text
生命周期
├── 'static
│   └── 整个程序运行期间有效
│       ├── 字符串字面量
│       ├── 全局常量
│       └── 拥有所有权的类型
│
├── 'a (泛型生命周期)
│   └── 任意生命周期参数
│
└── 生命周期关系
    ├── 'a: 'b ('a至少和'b一样长)
    └── 子类型关系: 'static <: 'a
```

---

## 二、派生概念

### 2.1 Move语义

```text
Move语义
├── 所有权转移
│   ├── 原变量失去所有权
│   └── 新变量获得所有权
│
├── 原变量失效
│   └── 不能再使用
│
└── Copy trait (例外)
    ├── 标量类型: i32, f64, bool, char
    ├── 元组: (i32, i32)
    └── 数组: [i32; 5]
```

**对比**:

| 特性 | Move | Copy |
|:---|:---|:---|
| 所有权 | 转移 | 复制 |
| 原变量 | 失效 | 仍有效 |
| 性能 | O(1) | 视大小 |

### 2.2 Drop trait

```text
Drop trait
├── 析构函数
│   └── 所有者离开作用域时调用
│
├── 资源释放
│   ├── 内存释放
│   ├── 文件关闭
│   └── 网络连接关闭
│
└── 自动调用
    └── 无需手动管理
```

---

## 三、相关概念

### 3.1 Send与Sync

```text
Send与Sync
├── Send
│   ├── 定义: 可安全跨线程转移所有权
│   ├── T: Send
│   └── 示例: i32, String, Arc<T>
│
└── Sync
    ├── 定义: 可安全跨线程共享(&T: Send)
    ├── T: Sync ⇔ &T: Send
    └── 示例: i32, String, Mutex<T>
```

**Send/Sync矩阵**:

| 类型 | Send | Sync |
|:---|:---:|:---:|
| i32 | ✅ | ✅ |
| String | ✅ | ✅ |
| Rc<T> | ❌ | ❌ |
| Arc<T> | ✅ | ✅(若T:Sync) |
| Cell<T> | ✅ | ❌ |
| RefCell<T> | ✅ | ❌ |
| Mutex<T> | ✅ | ✅ |

### 3.2 Pin与Unpin

```text
Pin与Unpin
├── Pin<P>
│   ├── 保证指向的值不会被移动
│   └── 用于自引用结构
│       └── async/await状态机
│
└── Unpin
    ├── 标记可以安全移动的类型
    ├── 大多数类型自动实现
    └── 非Unpin: async Future
```

---

## 四、概念关系图

```text
所有权系统保证
        │
        ├──→ 内存安全
        │       ├── 无悬垂指针
        │       ├── 无双重释放
        │       └── 无内存泄漏(基本)
        │
        ├──→ 并发安全
        │       └── 借用规则阻止数据竞争
        │
        └──→ 零成本抽象
                └── 编译时检查，运行时无开销
```

---

## 五、学习路径

```text
学习所有权概念
        │
        ├──→ 基础
        │       ├── 理解Move/Copy
        │       ├── 理解&/&mut
        │       └── 实践编译器错误
        │
        ├──→ 进阶
        │       ├── 生命周期标注
        │       ├── Send/Sync边界
        │       └── 内部可变性
        │
        └──→ 专家
                ├── 自引用结构
                ├── Pin/Unpin
                └── 形式化证明
```

---

## 六、与其他概念族的关系

```text
所有权概念族
        │
        ├──→ 类型系统概念族
        │       └── 所有权是类型系统的基础
        │
        ├──→ 生命周期概念族
        │       └── 所有权与生命周期绑定
        │
        ├──→ 并发概念族
        │       └── Send/Sync基于所有权
        │
        └──→ 异步概念族
                └── Pin基于所有权保证
```

---

## 七、反例索引

### 所有权相关反例

| 反例ID | 描述 | 编译器错误 |
|:---|:---|:---|
| CE-1.1 | 使用已移动值 | E0382 |
| CE-1.2 | 部分移动后使用 | E0382 |
| CE-2.1 | 借用冲突 | E0502 |
| CE-2.2 | 多重可变借用 | E0499 |
| CE-2.3 | 悬垂引用 | E0106 |

详见: [反例汇编](../COUNTER_EXAMPLES_COMPENDIUM.md)

---

## 八、形式化链接

### 相关定理

| 定理 | 描述 | 位置 |
|:---|:---|:---|
| T-OW2 | 所有权唯一性 | [定理汇编](../THEOREMS_AND_PROOF_STRATEGIES.md) §1 |
| T-OW3 | 内存安全 | [定理汇编](../THEOREMS_AND_PROOF_STRATEGIES.md) §1 |

### 相关证明

- L-OW1: 初始唯一性
- L-OW2: Move保持唯一性
- L-OW3: Copy保持唯一性
- L-OW4: Drop保持唯一性

---

**维护者**: Rust Formal Methods Research Team
**最后更新**: 2026-02-24
**状态**: ✅ 已完成 - 所有权概念族谱
