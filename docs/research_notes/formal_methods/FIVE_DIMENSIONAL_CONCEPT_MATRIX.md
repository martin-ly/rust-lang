# 五维概念矩阵

> **创建日期**: 2026-02-24
> **最后更新**: 2026-02-28
> **状态**: ✅ 已扩展
> **版本**: Rust 1.93.1+ (Edition 2024)

---

## 概述

五维概念矩阵是 Rust 形式化方法的核心概念组织框架，从五个正交维度系统化梳理 Rust 的所有权、借用、生命周期、类型系统和并发模型。

---

## 维度一：所有权维度 (Ownership)

| 概念 | 定义 | 形式化表示 | Rust语法 |
| :--- | :--- | :--- | :--- |
| **所有权** | 值有唯一所有者 | `own(x) = o` | `let x = v;` |
| **移动** | 所有权转移 | `move(x) = (x', o')` | `let y = x;` |
| **复制** | 值级复制 | `copy(x) = x'` | `let y = x;` (实现Copy) |
| **克隆** | 显式深度复制 | `clone(x) = x'` | `let y = x.clone();` |
| **借用** | 临时访问权 | `borrow(x, mode) = &x` | `&x` / `&mut x` |
| **生命周期** | 引用的有效范围 | `'a: 'b` | 显式标注或推断 |
| **Drop** | 资源释放 | `drop(x)` | 自动调用 |

### 所有权状态转移

```text
┌─────────┐    移动   ┌─────────┐    借用    ┌─────────┐
│  Owned  │ ────────> │ Moved   │ ────────> │ Borrowed│
└─────────┘           └─────────┘           └─────────┘
      │                                    │
      │ 复制(Clone)                         │ 归还
      ▼                                    ▼
┌─────────┐                           ┌─────────┐
│ Copied  │                           │  Owned  │
└─────────┘                           └─────────┘
```

---

## 维度二：借用维度 (Borrowing)

| 借用类型 | 数量限制 | 可变性 | 形式化 | 典型使用 |
| :--- | :--- | :--- | :--- | :--- |
| `&T` | 多 | 不可变 | `&'a T` | 只读访问 |
| `&mut T` | 唯一 | 可变 | `&'a mut T` | 修改数据 |
| `Box<T>` | 唯一 | 可变 | `Box<T>` | 堆分配所有权 |
| `Rc<T>` | 多 | 不可变 | `Rc<T>` | 共享所有权 |
| `Arc<T>` | 多(线程安全) | 不可变 | `Arc<T>` | 跨线程共享 |
| `RefCell<T>` | 运行时检查 | 内部可变 | `RefCell<T>` | 内部可变性 |
| `Mutex<T>` | 线程互斥 | 内部可变 | `Mutex<T>` | 线程安全修改 |

### 借用规则矩阵

| 场景 | `&T` | `&mut T` | 允许? |
| :--- | :--- | :--- | :--- |
| 同时多个`&T` | ✅ | - | ✅ |
| 同时`&T`和`&mut T` | ✅ | ✅ | ❌ |
| 同时多个`&mut T` | - | ✅✅ | ❌ |
| 嵌套`&&T` | ✅ | - | ✅ |
| 从`&mut T`获取`&T` | - | ✅→& | ✅ |

---

## 维度三：生命周期维度 (Lifetime)

| 生命周期类型 | 语法 | 约束 | 示例 |
| :--- | :--- | :--- | :--- |
| **显式** | `'a` | 用户标注 | `fn foo<'a>(x: &'a T)` |
| **省略** | 无 | 编译器推断 | `fn foo(x: &T) -> &T` |
| **'static** | `'static` | 程序生命周期 | `&'static str` |
| **高阶** | `for<'a>` | 任意生命周期 | `for<'a> Fn(&'a T)` |
| **约束** | `'a: 'b` | outlives关系 | `'a: 'b` (a至少和b一样长) |

### 生命周期关系图

```text
'static  ────────────────────────────────▶  最长
   │
   ├─── 'a (函数参数) ───┐
   │                      ├─── 引用有效范围
   └─── 'b (局部变量) ────┘

'a: 'b  表示 'a 至少和 'b 一样长
```

---

## 维度四：类型系统维度 (Type System)

| 类型类别 | 描述 | 示例 | 特性 |
| :--- | :--- | :--- | :--- |
| **原始类型** | 基础值类型 | `i32`, `bool`, `char` | Copy |
| **复合类型** | 组合类型 | `struct`, `enum`, `tuple` | 自定义 |
| **引用类型** | 借用引用 | `&T`, `&mut T` | 生命周期 |
| **指针类型** | 裸指针 | `*const T`, `*mut T` | unsafe |
| **函数类型** | 闭包/函数 | `fn()`, `Fn()`, `FnMut()` | 调用trait |
| **泛型** | 参数化类型 | `Vec<T>`, `Option<T>` | 单态化 |
| **Trait类型** | 抽象接口 | `dyn Trait`, `impl Trait` | 动态/静态分发 |
| **类型别名** | 同义词 | `type MyInt = i32;` | 无新类型 |

### 型变矩阵 (Variance)

| 类型构造器 | 参数T的型变 | 示例 |
| :--- | :--- | :--- |
| `&'a T` | 协变(Covariant) | `&'static str` <: `&'a str` |
| `&'a mut T` | 对T不变(Invariant) | 不能替换子类型 |
| `Box<T>` | 协变 | `Box<Cat>` <: `Box<Animal>` |
| `Vec<T>` | 协变 | `Vec<Cat>` <: `Vec<Animal>` |
| `Cell<T>` | 不变 | `Cell<Cat>` ≮ `Cell<Animal>` |
| `fn(T) -> U` | T逆变,U协变 | `fn(Animal)` <: `fn(Cat)` |
| `*const T` | 协变 | 裸指针协变 |
| `*mut T` | 不变 | 可变裸指针不变 |

---

## 维度五：并发维度 (Concurrency)

| 概念 | 标记trait | 保证 | 形式化 |
| :--- | :--- | :--- | :--- |
| **Send** | `T: Send` | 可跨线程转移 | `Send: T → thread_safe_transfer` |
| **Sync** | `T: Sync` | 可跨线程共享 | `Sync: &T → thread_safe_share` |
| **'static** | 生命周期 | 无借用约束 | 不持有非'static引用 |
| **Mutex** | 同步原语 | 互斥访问 | `Mutex<T>: Send` 如果 `T: Send` |
| **RwLock** | 同步原语 | 读写锁 | 多读单写 |
| **Channel** | 通信 | 所有权传递 | `mpsc`: 多生产者单消费者 |
| **Arc** | 原子计数 | 共享所有权 | `Arc<T>: Send/Sync` 如果 `T: Send/Sync` |

### Send/Sync 推导矩阵

| 类型 | `T: Send` | `T: Sync` | 结果 |
| :--- | :--- | :--- | :--- |
| `Vec<T>` | ✅ | ✅ | `Vec<T>: Send+Sync` |
| `Rc<T>` | ❌ | ❌ | `Rc<T>` 非Send非Sync |
| `Arc<T>` | ✅(T:Send) | ✅(T:Sync) | 线程安全共享 |
| `RefCell<T>` | ✅(T) | ❌ | 非Sync(内部可变) |
| `Mutex<T>` | ✅(T:Send) | ✅(T) | 提供Sync |
| `*const T` | ❌ | ❌ | 裸指针非Send非Sync |
| `Cell<T>` | ✅(T) | ❌ | 非Sync |

---

## 五维交叉分析

### 所有权 × 借用

| 所有权状态 | 可变借用 | 不可变借用 | 释放 |
| :--- | :--- | :--- | :--- |
| Owned | ❌(已拥有) | ❌ | ✅ |
| &mut T | ✅(重新借用) | ❌ | ❌ |
| &T | ❌ | ✅ | ❌ |
| Moved | - | - | - |

### 生命周期 × 类型系统

| 类型 | 默认生命周期 | 显式约束 |
| :--- | :--- | :--- |
| `&T` | 推断 | `'a` |
| `&'static T` | 程序生命期 | 无 |
| `struct S<'a>` | 声明参数 | `'a: 'b` |
| `dyn Trait + 'a` | 对象生命期 | `+ 'static` |

### 并发 × 所有权

| 场景 | 所有权策略 | 同步机制 |
| :--- | :--- | :--- |
| 线程spawn | move所有权 | `thread::spawn` |
| 共享状态 | Arc共享 | `Mutex/RwLock` |
| 消息传递 | 所有权转移 | `channel` |
| 线程局部 | 每线程独立 | `thread_local!` |

---

## 综合决策矩阵

```text
数据需要修改?
├── 是 → 需要 &mut T 或 Mutex
│       ├── 单线程 → &mut T
│       └── 多线程 → Mutex<T> 或 RwLock<T>
└── 否 → 只读访问
        ├── 单线程 → &T
        └── 多线程 → Arc<T> 或 &T('static)

数据需要跨线程?
├── 是 → 需要 T: Send
│       ├── 转移所有权 → 直接move
│       └── 共享 → 需要 T: Sync → Arc<T>
└── 否 → 单线程约束
```

---

## 五维与核心定理对应

| 维度 | 核心定理 | 证明文件 |
| :--- | :--- | :--- |
| 所有权 | T-OW2: 所有权唯一性 | ownership_model.md |
| 借用 | T-BR1: 数据竞争自由 | borrow_checker_proof.md |
| 生命周期 | LF-T1: 生命周期推断正确性 | lifetime_formalization.md |
| 类型系统 | T-TY3: 类型安全 | type_system_foundations.md |
| 并发 | T-ASYNC: 并发安全 | async_state_machine.md |

---

## 与Rust 1.93对应

| 1.93特性 | 五维影响 |
| :--- | :--- |
| `offset_of!`稳定 | 类型系统: 字段偏移计算 |
| `Cell::update` | 并发×所有权: 内部可变性增强 |
| `io::read_to_end`优化 | 借用: 更高效读取 |
| `const_trait_impl`进展 | 类型系统: 编译期计算 |

---

## 扩展阅读

- [CONCEPT_AXIOM_THEOREM_MATRIX](./CONCEPT_AXIOM_THEOREM_MATRIX.md) - 概念-公理-定理映射
- [PROOF_COMPLETION_MATRIX](./PROOF_COMPLETION_MATRIX.md) - 证明完成度矩阵
- [type_system_foundations](../type_theory/type_system_foundations.md) - 类型系统基础
- [ownership_model](./ownership_model.md) - 所有权模型

---

## 矩阵结构

| 概念 | 公理 | 定理 | 证明策略 | 反例 |
| :--- | :--- | :--- | :--- | :--- |
| **所有权** | 唯一性 | 无悬垂指针 | 归纳法 | 双重释放 |
| **借用** | 排他性 | 无数据竞争 | 不变式 | 读写并发 |
| **生命周期** | outlives | 引用有效性 | 约束求解 | 过早释放 |
| **类型安全** | 完备性 | 进展与保持 | 逻辑关系 | 类型混淆 |
| **并发安全** | Send/Sync | 线程安全 | 霍尔逻辑 | 竞争条件 |

---

## 概念-公理对应

| 概念域 | 核心公理 | 数学表达 |
| :--- | :--- | :--- |
| 所有权 | 唯一所有权 | ∀x. owns(x) → ¬∃y≠x. owns(y, x) |
| 借用 | 借用排他 | borrow_mut(x) → ¬borrow(x) |
| 生命周期 | 生命期包含 | 'a: 'b ↔ lifetime('a) ⊇ lifetime('b) |
| 类型系统 | 类型唯一 | Γ ⊢ e : T ∧ Γ ⊢ e : T' → T = T' |
| 并发 | 线程安全 | T: Send ↔ safe_to_move(T) |

---

## 定理-证明映射

| 定理 | 难度 | 证明方法 | 状态 |
| :--- | :--- | :--- | :--- |
| 所有权唯一性 | L2 | 反证法 | ✅ |
| 借用无竞争 | L2 | 不变式保持 | ✅ |
| 生命周期正确性 | L2 | 偏序约束 | ✅ |
| 类型安全 | L3 | 进展+保持 | 🔄 |
| 并发安全性 | L3 | 霍尔逻辑 | 🔄 |

---

## 反例汇编

| 概念 | 错误模式 | 后果 | 检测 |
| :--- | :--- | :--- | :--- |
| 所有权 | 重复释放 | UAF | 编译器 |
| 借用 | 读写并发 | 数据竞争 | Miri |
| 生命周期 | 过早释放 | 悬垂引用 | Borrowck |
| 类型 | 错误转换 | 内存损坏 | 类型检查 |
| 并发 | 非Send跨线程 | 竞争条件 | 编译器 |

---

## 学习路径

```text
概念理解 (L1)
    ↓
公理掌握 (L1/L2)
    ↓
定理证明 (L2/L3)
    ↓
反例分析 (L2)
    ↓
综合应用 (L3)
```

**维护者**: Rust Formal Methods Research Team
**最后更新**: 2026-02-28
**状态**: ✅ 已扩展 - 五维概念矩阵完整版
