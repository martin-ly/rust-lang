# Rust ç¼–è¯‘å™¨ç‰¹æ€§ä¸ä¼˜åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: Rust 1.93+ | **æ›´æ–°æ—¥æœŸ**: 2026-01-26
> **æ–‡æ¡£ç±»å‹**: ğŸ“˜ å·¥å…·é“¾å‚è€ƒ | **é€‚ç”¨å¯¹è±¡**: ä¸­çº§åˆ°é«˜çº§å¼€å‘è€…

---

## ğŸ“Š ç›®å½•

- [Rust ç¼–è¯‘å™¨ç‰¹æ€§ä¸ä¼˜åŒ–](#rust-ç¼–è¯‘å™¨ç‰¹æ€§ä¸ä¼˜åŒ–)
  - [ğŸ“Š ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ–‡æ¡£è¯´æ˜](#-æ–‡æ¡£è¯´æ˜)
  - [1. ç¼–è¯‘å™¨æ¦‚è§ˆ](#1-ç¼–è¯‘å™¨æ¦‚è§ˆ)
    - [1.1 ç¼–è¯‘æµç¨‹](#11-ç¼–è¯‘æµç¨‹)
    - [1.2 ç¼–è¯‘å™¨ç‰ˆæœ¬](#12-ç¼–è¯‘å™¨ç‰ˆæœ¬)
  - [2. å¢é‡ç¼–è¯‘ (Rust 1.54+)](#2-å¢é‡ç¼–è¯‘-rust-154)
    - [2.1 å¢é‡ç¼–è¯‘åŸç†](#21-å¢é‡ç¼–è¯‘åŸç†)
    - [2.2 é…ç½®å¢é‡ç¼–è¯‘](#22-é…ç½®å¢é‡ç¼–è¯‘)
    - [2.3 æ€§èƒ½å½±å“](#23-æ€§èƒ½å½±å“)
  - [3. ä¼˜åŒ–çº§åˆ«](#3-ä¼˜åŒ–çº§åˆ«)
    - [3.1 åŸºç¡€ä¼˜åŒ–çº§åˆ«](#31-åŸºç¡€ä¼˜åŒ–çº§åˆ«)
    - [3.2 é«˜çº§ä¼˜åŒ–é€‰é¡¹](#32-é«˜çº§ä¼˜åŒ–é€‰é¡¹)
  - [4. Link-Time Optimization (LTO)](#4-link-time-optimization-lto)
    - [4.1 LTO ç±»å‹](#41-lto-ç±»å‹)
    - [4.2 é…ç½® LTO](#42-é…ç½®-lto)
    - [4.3 æ€§èƒ½æƒè¡¡](#43-æ€§èƒ½æƒè¡¡)
  - [5. Profile-Guided Optimization (PGO)](#5-profile-guided-optimization-pgo)
    - [5.1 PGO å·¥ä½œæµç¨‹](#51-pgo-å·¥ä½œæµç¨‹)
    - [5.2 å®æ–½ PGO](#52-å®æ–½-pgo)
    - [5.3 æ€§èƒ½æå‡](#53-æ€§èƒ½æå‡)
  - [6. ä»£ç ç”Ÿæˆé€‰é¡¹](#6-ä»£ç ç”Ÿæˆé€‰é¡¹)
    - [6.1 ç›®æ ‡ CPU å’Œç‰¹æ€§](#61-ç›®æ ‡-cpu-å’Œç‰¹æ€§)
    - [6.2 ä»£ç æ¨¡å‹](#62-ä»£ç æ¨¡å‹)
  - [7. è°ƒè¯•ä¿¡æ¯](#7-è°ƒè¯•ä¿¡æ¯)
    - [7.1 è°ƒè¯•ä¿¡æ¯çº§åˆ«](#71-è°ƒè¯•ä¿¡æ¯çº§åˆ«)
    - [7.2 åˆ†å‰²è°ƒè¯•ä¿¡æ¯](#72-åˆ†å‰²è°ƒè¯•ä¿¡æ¯)
    - [7.3 DWARF ç‰ˆæœ¬](#73-dwarf-ç‰ˆæœ¬)
  - [8. ç¼–è¯‘ç¼“å­˜](#8-ç¼–è¯‘ç¼“å­˜)
    - [8.1 Sccache](#81-sccache)
    - [8.2 é…ç½®ç¼“å­˜](#82-é…ç½®ç¼“å­˜)
  - [9. ç¼–è¯‘æ—¶é—´ä¼˜åŒ–](#9-ç¼–è¯‘æ—¶é—´ä¼˜åŒ–)
    - [9.1 å¹¶è¡Œç¼–è¯‘](#91-å¹¶è¡Œç¼–è¯‘)
    - [9.2 ä¾èµ–ä¼˜åŒ–](#92-ä¾èµ–ä¼˜åŒ–)
    - [9.3 ä»£ç ç»„ç»‡](#93-ä»£ç ç»„ç»‡)
  - [10. ç¼–è¯‘å™¨æ’ä»¶ä¸æ‰©å±•](#10-ç¼–è¯‘å™¨æ’ä»¶ä¸æ‰©å±•)
    - [10.1 Procedural Macros](#101-procedural-macros)
    - [10.2 ç¼–è¯‘å™¨å†…ç½®å·¥å…·](#102-ç¼–è¯‘å™¨å†…ç½®å·¥å…·)
  - [11. é«˜çº§ç¼–è¯‘æŠ€æœ¯](#11-é«˜çº§ç¼–è¯‘æŠ€æœ¯)
    - [11.1 Polly (LLVM ä¼˜åŒ–å™¨)](#111-polly-llvm-ä¼˜åŒ–å™¨)
    - [11.2 è‡ªå®šä¹‰æ„å»ºè„šæœ¬](#112-è‡ªå®šä¹‰æ„å»ºè„šæœ¬)
  - [12. å®æˆ˜æ¡ˆä¾‹](#12-å®æˆ˜æ¡ˆä¾‹)
    - [12.1 ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®](#121-ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®)
    - [12.2 å¼€å‘ç¯å¢ƒä¼˜åŒ–é…ç½®](#122-å¼€å‘ç¯å¢ƒä¼˜åŒ–é…ç½®)
  - [13. æ€§èƒ½åŸºå‡†](#13-æ€§èƒ½åŸºå‡†)
  - [14. æ•…éšœæ’æŸ¥](#14-æ•…éšœæ’æŸ¥)
    - [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
  - [15. ç›¸å…³èµ„æº](#15-ç›¸å…³èµ„æº)
    - [ğŸ“š å®˜æ–¹æ–‡æ¡£](#-å®˜æ–¹æ–‡æ¡£)
    - [ğŸ”— ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)
    - [ğŸ“¦ æ¨èå·¥å…·](#-æ¨èå·¥å…·)

## ğŸ¯ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ¶µç›– Rust ç¼–è¯‘å™¨ (`rustc`) çš„æ ¸å¿ƒç‰¹æ€§ã€ä¼˜åŒ–æŠ€æœ¯å’Œæœ€æ–°æ”¹è¿›ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£å’Œåˆ©ç”¨ç¼–è¯‘å™¨åŠŸèƒ½ã€‚

**è¦†ç›–å†…å®¹**: ç¼–è¯‘è¿‡ç¨‹ã€ä¼˜åŒ–æŠ€æœ¯ã€è°ƒè¯•ä¿¡æ¯ã€å¢é‡ç¼–è¯‘ã€Profile-Guided Optimization (PGO)ã€Link-Time Optimization (LTO)

---

## 1. ç¼–è¯‘å™¨æ¦‚è§ˆ

### 1.1 ç¼–è¯‘æµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æºä»£ç  (.rs) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯æ³•åˆ†æ    â”‚ â†’ Tokens
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯­æ³•åˆ†æ    â”‚ â†’ AST (Abstract Syntax Tree)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯­ä¹‰åˆ†æ    â”‚ â†’ HIR (High-level IR)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç±»å‹æ£€æŸ¥    â”‚ â†’ ç±»å‹ä¿¡æ¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Borrow æ£€æŸ¥ â”‚ â†’ MIR (Mid-level IR)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼˜åŒ– (MIR)  â”‚ â†’ ä¼˜åŒ–åçš„ MIR
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLVM IR ç”Ÿæˆ â”‚ â†’ LLVM IR
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLVM ä¼˜åŒ–    â”‚ â†’ ä¼˜åŒ–åçš„ LLVM IR
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»£ç ç”Ÿæˆ    â”‚ â†’ ç›®æ ‡æœºå™¨ç 
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é“¾æ¥å™¨     â”‚ â†’ å¯æ‰§è¡Œæ–‡ä»¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 1.2 ç¼–è¯‘å™¨ç‰ˆæœ¬

```bash
# æŸ¥çœ‹ç¼–è¯‘å™¨ç‰ˆæœ¬
rustc --version

# æŸ¥çœ‹è¯¦ç»†ç‰ˆæœ¬ä¿¡æ¯
rustc --version --verbose

# è¾“å‡ºç¤ºä¾‹:
# rustc 1.90.0 (2024-10-22)
# binary: rustc
# commit-hash: abc123...
# commit-date: 2024-10-22
# host: x86_64-unknown-linux-gnu
# release: 1.90.0
# LLVM version: 18.1.0
```

**æŸ¥çœ‹ç¼–è¯‘å™¨æ”¯æŒçš„ç›®æ ‡å¹³å°**:

```bash
rustc --print target-list

# å¸¸è§ç›®æ ‡:
# x86_64-unknown-linux-gnu
# x86_64-pc-windows-msvc
# x86_64-apple-darwin
# aarch64-unknown-linux-gnu
# wasm32-unknown-unknown
```

---

## 2. å¢é‡ç¼–è¯‘ (Rust 1.54+)

### 2.1 å¢é‡ç¼–è¯‘åŸç†

**ç‰¹æ€§**: Rust 1.54 é»˜è®¤é‡æ–°å¯ç”¨å¢é‡ç¼–è¯‘

**å·¥ä½œåŸç†**:

1. å°†ä»£ç åˆ†è§£ä¸ºå¤šä¸ª**ç¼–è¯‘å•å…ƒ** (crate)
2. è·Ÿè¸ªæ¯ä¸ªç¼–è¯‘å•å…ƒçš„**ä¾èµ–å…³ç³»**
3. ä»…é‡æ–°ç¼–è¯‘**ä¿®æ”¹è¿‡çš„**ç¼–è¯‘å•å…ƒåŠå…¶ä¾èµ–è€…
4. ç¼“å­˜ç¼–è¯‘ä¸­é—´ç»“æœ

---

### 2.2 é…ç½®å¢é‡ç¼–è¯‘

**Cargo.toml é…ç½®**:

```toml
[profile.dev]
incremental = true  # é»˜è®¤å¼€å¯

[profile.release]
incremental = false  # ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­
```

**ç¯å¢ƒå˜é‡**:

```bash
# å¯ç”¨å¢é‡ç¼–è¯‘
export CARGO_INCREMENTAL=1

# ç¦ç”¨å¢é‡ç¼–è¯‘
export CARGO_INCREMENTAL=0

# æŒ‡å®šå¢é‡ç¼–è¯‘ç¼“å­˜ç›®å½•
export CARGO_INCREMENTAL_DIR=/custom/cache/path
```

**æ¸…ç†å¢é‡ç¼–è¯‘ç¼“å­˜**:

```bash
# æ¸…ç†æ‰€æœ‰ç¼“å­˜
cargo clean

# æ¸…ç†å¢é‡ç¼–è¯‘ç¼“å­˜
rm -rf target/debug/incremental
rm -rf target/release/incremental
```

---

### 2.3 æ€§èƒ½å½±å“

**é¦–æ¬¡ç¼–è¯‘**: æ— æ˜æ˜¾å·®å¼‚

**å¢é‡ç¼–è¯‘**:

- **å°ä¿®æ”¹**: ç¼–è¯‘æ—¶é—´å‡å°‘ **50-90%**
- **ä¸­ç­‰ä¿®æ”¹**: ç¼–è¯‘æ—¶é—´å‡å°‘ **30-50%**
- **å¤§ä¿®æ”¹**: ç¼–è¯‘æ—¶é—´å‡å°‘ **10-30%**

**æƒè¡¡**:

- âœ… **å¼€å‘ç¯å¢ƒ**: æ˜¾è‘—åŠ é€Ÿè¿­ä»£
- âš ï¸ **ç”Ÿäº§ç¯å¢ƒ**: å¯èƒ½ç•¥å¾®å¢åŠ äºŒè¿›åˆ¶ä½“ç§¯

---

## 3. ä¼˜åŒ–çº§åˆ«

### 3.1 åŸºç¡€ä¼˜åŒ–çº§åˆ«

```toml
[profile.dev]
opt-level = 0  # æ— ä¼˜åŒ– (å¿«é€Ÿç¼–è¯‘)

[profile.release]
opt-level = 3  # æœ€å¤§ä¼˜åŒ– (æœ€å¿«è¿è¡Œ)
```

**ä¼˜åŒ–çº§åˆ«è¯´æ˜**:

| çº§åˆ«  | è¯´æ˜         | ç¼–è¯‘æ—¶é—´ | è¿è¡Œæ€§èƒ½ | äºŒè¿›åˆ¶å¤§å° |
| ----- | ------------ | -------- | -------- | ---------- |
| `0`   | æ— ä¼˜åŒ–       | æœ€å¿«     | æœ€æ…¢     | æœ€å¤§       |
| `1`   | åŸºç¡€ä¼˜åŒ–     | å¿«       | è¾ƒå¿«     | å¤§         |
| `2`   | æ ‡å‡†ä¼˜åŒ–     | ä¸­ç­‰     | å¿«       | ä¸­ç­‰       |
| `3`   | æœ€å¤§ä¼˜åŒ–     | æ…¢       | æœ€å¿«     | å°         |
| `"s"` | ä¼˜åŒ–å¤§å°     | ä¸­ç­‰     | å¿«       | æœ€å°       |
| `"z"` | æè‡´ä¼˜åŒ–å¤§å° | ä¸­ç­‰     | è¾ƒå¿«     | æå°       |

---

### 3.2 é«˜çº§ä¼˜åŒ–é€‰é¡¹

```toml
[profile.release]
opt-level = 3
lto = "fat"                # Link-Time Optimization
codegen-units = 1          # å•ä¸€ä»£ç ç”Ÿæˆå•å…ƒ (æœ€å¤§ä¼˜åŒ–)
panic = "abort"            # panic æ—¶ä¸­æ­¢ (å‡å°ä½“ç§¯)
strip = true               # ç§»é™¤ç¬¦å·è¡¨ (Rust 1.59+)
overflow-checks = false    # ç¦ç”¨æº¢å‡ºæ£€æŸ¥
debug = false              # ä¸ç”Ÿæˆè°ƒè¯•ä¿¡æ¯
debug-assertions = false   # ç¦ç”¨æ–­è¨€
```

**é’ˆå¯¹ç‰¹å®šåŒ…çš„ä¼˜åŒ–**:

```toml
[profile.dev.package."*"]
opt-level = 2  # ä¾èµ–åŒ…ä½¿ç”¨ O2 ä¼˜åŒ–

[profile.dev.package.my-crate]
opt-level = 0  # è‡ªå·±çš„ crate ä¿æŒæ— ä¼˜åŒ–
```

---

## 4. Link-Time Optimization (LTO)

### 4.1 LTO ç±»å‹

**Thin LTO** (æ¨è):

```toml
[profile.release]
lto = "thin"
```

- å¹³è¡¡ç¼–è¯‘æ—¶é—´å’Œä¼˜åŒ–æ•ˆæœ
- å¹¶è¡Œåº¦é«˜
- å¢åŠ ç¼–è¯‘æ—¶é—´ ~20-40%
- æ€§èƒ½æå‡ ~5-15%

**Fat LTO** (æœ€å¤§ä¼˜åŒ–):

```toml
[profile.release]
lto = "fat"
# æˆ–
lto = true
```

- å…¨ç¨‹åºä¼˜åŒ–
- ç¼–è¯‘æ—¶é—´æ˜¾è‘—å¢åŠ 
- å¢åŠ ç¼–è¯‘æ—¶é—´ ~50-200%
- æ€§èƒ½æå‡ ~10-25%

---

### 4.2 é…ç½® LTO

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```toml
[profile.release]
lto = "fat"
codegen-units = 1  # LTO éœ€è¦å•ä¸€ä»£ç ç”Ÿæˆå•å…ƒä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœ
```

**é’ˆå¯¹åº“çš„ LTO**:

```toml
[profile.release]
lto = true

[profile.release.package."*"]
lto = true  # æ‰€æœ‰ä¾èµ–åŒ…ä¹Ÿå¯ç”¨ LTO
```

---

### 4.3 æ€§èƒ½æƒè¡¡

**åŸºå‡†æµ‹è¯•ç»“æœ**:

| é…ç½®     | ç¼–è¯‘æ—¶é—´ | è¿è¡Œæ€§èƒ½ | äºŒè¿›åˆ¶å¤§å° |
| -------- | -------- | -------- | ---------- |
| æ—  LTO   | 1x       | 1x       | 1x         |
| Thin LTO | 1.3x     | 1.08x    | 0.92x      |
| Fat LTO  | 2.5x     | 1.18x    | 0.85x      |

**å»ºè®®**:

- **å¼€å‘ç¯å¢ƒ**: ç¦ç”¨ LTO
- **CI æµ‹è¯•**: Thin LTO
- **ç”Ÿäº§å‘å¸ƒ**: Fat LTO

---

## 5. Profile-Guided Optimization (PGO)

### 5.1 PGO å·¥ä½œæµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: ä½¿ç”¨ instrumented æ„å»ºç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: è¿è¡Œç¨‹åºï¼Œæ”¶é›†æ€§èƒ½æ•°æ® (*.profraw)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: åˆå¹¶æ€§èƒ½æ•°æ® (*.profdata)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: ä½¿ç”¨æ€§èƒ½æ•°æ®é‡æ–°æ„å»ºï¼Œç”Ÿæˆä¼˜åŒ–çš„å¯æ‰§è¡Œæ–‡ä»¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.2 å®æ–½ PGO

**æ­¥éª¤ 1: Instrumented æ„å»º**:

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export RUSTFLAGS="-Cprofile-generate=/tmp/pgo-data"

# æ„å»º
cargo build --release
```

**æ­¥éª¤ 2: è¿è¡Œå¹¶æ”¶é›†æ•°æ®**:

```bash
# è¿è¡Œç¨‹åº (ä½¿ç”¨å…¸å‹å·¥ä½œè´Ÿè½½)
./target/release/my-app

# è¿™å°†ç”Ÿæˆ /tmp/pgo-data/*.profraw æ–‡ä»¶
```

**æ­¥éª¤ 3: åˆå¹¶æ€§èƒ½æ•°æ®**:

```bash
# ä½¿ç”¨ llvm-profdata åˆå¹¶
llvm-profdata merge \
    -o /tmp/pgo-data/merged.profdata \
    /tmp/pgo-data/*.profraw
```

**æ­¥éª¤ 4: ä½¿ç”¨ PGO æ•°æ®é‡æ–°æ„å»º**:

```bash
# æ¸…ç†ä¹‹å‰çš„æ„å»º
cargo clean

# è®¾ç½®ä½¿ç”¨ PGO æ•°æ®
export RUSTFLAGS="-Cprofile-use=/tmp/pgo-data/merged.profdata"

# é‡æ–°æ„å»º
cargo build --release
```

---

### 5.3 æ€§èƒ½æå‡

**å…¸å‹æå‡**:

- **çƒ­ç‚¹è·¯å¾„ä¼˜åŒ–**: 10-30%
- **åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–**: 5-15%
- **å†…è”å†³ç­–ä¼˜åŒ–**: 5-10%
- **æ€»ä½“æ€§èƒ½**: **15-35%**

**é€‚ç”¨åœºæ™¯**:

- âœ… CPU å¯†é›†å‹åº”ç”¨
- âœ… æœ‰æ˜ç¡®å…¸å‹å·¥ä½œè´Ÿè½½çš„åº”ç”¨
- âœ… æ€§èƒ½å…³é”®çš„ç”Ÿäº§ç¯å¢ƒ
- âš ï¸ ä¸é€‚åˆå·¥ä½œè´Ÿè½½å˜åŒ–å¤§çš„åº”ç”¨

---

## 6. ä»£ç ç”Ÿæˆé€‰é¡¹

### 6.1 ç›®æ ‡ CPU å’Œç‰¹æ€§

**æŒ‡å®šç›®æ ‡ CPU**:

```bash
# é’ˆå¯¹æœ¬æœº CPU ä¼˜åŒ–
RUSTFLAGS="-C target-cpu=native" cargo build --release

# é’ˆå¯¹ç‰¹å®š CPU
RUSTFLAGS="-C target-cpu=haswell" cargo build --release

# æŸ¥çœ‹æ”¯æŒçš„ CPU
rustc --print target-cpus
```

**å¯ç”¨ç‰¹å®š CPU ç‰¹æ€§**:

```bash
# å¯ç”¨ AVX2
RUSTFLAGS="-C target-feature=+avx2" cargo build --release

# å¯ç”¨å¤šä¸ªç‰¹æ€§
RUSTFLAGS="-C target-feature=+avx2,+fma,+bmi2" cargo build --release

# æŸ¥çœ‹æ”¯æŒçš„ç‰¹æ€§
rustc --print target-features
```

**Cargo.toml é…ç½®**:

```toml
[profile.release]
[profile.release.build-override]
rustflags = ["-C", "target-cpu=native"]
```

---

### 6.2 ä»£ç æ¨¡å‹

```bash
# å°ä»£ç æ¨¡å‹ (é»˜è®¤, < 2GB)
RUSTFLAGS="-C code-model=small" cargo build --release

# ä¸­ç­‰ä»£ç æ¨¡å‹ (2-4GB)
RUSTFLAGS="-C code-model=medium" cargo build --release

# å¤§ä»£ç æ¨¡å‹ (> 4GB)
RUSTFLAGS="-C code-model=large" cargo build --release
```

---

## 7. è°ƒè¯•ä¿¡æ¯

### 7.1 è°ƒè¯•ä¿¡æ¯çº§åˆ«

```toml
[profile.dev]
debug = 2  # å®Œæ•´è°ƒè¯•ä¿¡æ¯ (é»˜è®¤)

[profile.release]
debug = 0  # æ— è°ƒè¯•ä¿¡æ¯
# æˆ–ä¿ç•™éƒ¨åˆ†è°ƒè¯•ä¿¡æ¯ç”¨äº profiling
debug = 1  # ä»…è¡Œå·ä¿¡æ¯
```

**çº§åˆ«è¯´æ˜**:

| çº§åˆ« | è¯´æ˜       | äºŒè¿›åˆ¶å¢åŠ  | ç¼–è¯‘æ—¶é—´ |
| ---- | ---------- | ---------- | -------- |
| `0`  | æ— è°ƒè¯•ä¿¡æ¯ | 0%         | æœ€å¿«     |
| `1`  | ä»…è¡Œå·     | +5-10%     | å¿«       |
| `2`  | å®Œæ•´ä¿¡æ¯   | +20-50%    | æ…¢       |

---

### 7.2 åˆ†å‰²è°ƒè¯•ä¿¡æ¯

```toml
[profile.release]
split-debuginfo = "packed"  # macOS/Windows: æ‰“åŒ…åˆ°å•ç‹¬æ–‡ä»¶
# split-debuginfo = "unpacked"  # Linux: åˆ†æ•£åˆ°å¤šä¸ªæ–‡ä»¶
```

**å¹³å°å·®å¼‚**:

| å¹³å°    | é»˜è®¤å€¼     | æ¨èå€¼                             |
| ------- | ---------- | ---------------------------------- |
| Linux   | `unpacked` | `unpacked` (å¼€å‘), `packed` (å‘å¸ƒ) |
| macOS   | `packed`   | `packed`                           |
| Windows | `packed`   | `packed`                           |

---

### 7.3 DWARF ç‰ˆæœ¬

```bash
# ä½¿ç”¨ DWARF 5 (æœ€æ–°, æ›´å°)
RUSTFLAGS="-C debuginfo=2 -C dwarf-version=5" cargo build

# ä½¿ç”¨ DWARF 4 (å…¼å®¹æ€§æ›´å¥½)
RUSTFLAGS="-C debuginfo=2 -C dwarf-version=4" cargo build
```

**Rust 1.88**: DWARF 5 ç¨³å®šåŒ–

---

## 8. ç¼–è¯‘ç¼“å­˜

### 8.1 Sccache

**å®‰è£…**:

```bash
cargo install sccache
```

**é…ç½®**:

```bash
# è®¾ç½®ä¸ºé»˜è®¤ç¼–è¯‘å™¨åŒ…è£…å™¨
export RUSTC_WRAPPER=sccache

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
sccache --show-stats

# æ¸…ç†ç¼“å­˜
sccache --stop-server
```

**Cargo é…ç½®** (`.cargo/config.toml`):

```toml
[build]
rustc-wrapper = "/path/to/sccache"
```

---

### 8.2 é…ç½®ç¼“å­˜

**æœ¬åœ°ç¼“å­˜**:

```bash
export SCCACHE_DIR=~/.cache/sccache
export SCCACHE_CACHE_SIZE="10G"
```

**Redis ç¼“å­˜** (å›¢é˜Ÿå…±äº«):

```bash
export SCCACHE_REDIS="redis://localhost:6379"
```

**S3 ç¼“å­˜** (CI/CD):

```bash
export SCCACHE_BUCKET="my-build-cache"
export SCCACHE_REGION="us-west-2"
```

---

## 9. ç¼–è¯‘æ—¶é—´ä¼˜åŒ–

### 9.1 å¹¶è¡Œç¼–è¯‘

```bash
# è®¾ç½®å¹¶è¡Œä»»åŠ¡æ•°
cargo build -j 8

# æˆ–é€šè¿‡ç¯å¢ƒå˜é‡
export CARGO_BUILD_JOBS=8
```

**Cargo.toml é…ç½®**:

```toml
[build]
jobs = 8  # é»˜è®¤ä¸º CPU æ ¸å¿ƒæ•°
```

---

### 9.2 ä¾èµ–ä¼˜åŒ–

**å‡å°‘ä¾èµ–**:

```toml
[dependencies]
# ä»…ä½¿ç”¨éœ€è¦çš„ feature
serde = { version = "1.0", features = ["derive"] }
tokio = { version = "1.0", features = ["rt-multi-thread", "macros"] }

# é¿å…ä¸å¿…è¦çš„ä¾èµ–
# âŒ regex = "1.0"
```

**ä½¿ç”¨ workspace**:

```toml
[workspace]
members = ["crate1", "crate2", "crate3"]

# å…±äº«ä¾èµ–ç‰ˆæœ¬
[workspace.dependencies]
tokio = { version = "1.0", features = ["full"] }
```

---

### 9.3 ä»£ç ç»„ç»‡

**æœ€ä½³å®è·µ**:

1. **å‡å° crate å¤§å°**: å°†å¤§ crate æ‹†åˆ†ä¸ºå¤šä¸ªå° crate
2. **é¿å…å¤§å‹æ³›å‹**: æ³›å‹ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´
3. **ä½¿ç”¨åŠ¨æ€åˆ†å‘**: åœ¨é€‚å½“åœºæ™¯ä½¿ç”¨ `dyn Trait`
4. **å‡å°‘å®ä½¿ç”¨**: å®å±•å¼€å¢åŠ ç¼–è¯‘æ—¶é—´

**ç¤ºä¾‹**:

```rust
// âœ… æ¨è: å°è€Œä¸“æ³¨çš„ crate
// lib.rs
pub mod core;
pub mod utils;
pub mod api;

// âŒ é¿å…: å•ä¸€å·¨å¤§ crate
// lib.rs
pub mod everything_in_one_file; // 10000+ lines
```

---

## 10. ç¼–è¯‘å™¨æ’ä»¶ä¸æ‰©å±•

### 10.1 Procedural Macros

**æ€§èƒ½å½±å“**:

- è¿‡ç¨‹å®åœ¨ç¼–è¯‘æ—¶è¿è¡Œï¼Œä¼šå¢åŠ ç¼–è¯‘æ—¶é—´
- å»ºè®®ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨

**ä¼˜åŒ–å»ºè®®**:

```rust
// âœ… ä½¿ç”¨ derive å®
#[derive(Debug, Clone, Serialize, Deserialize)]
struct Data { /* ... */ }

// âš ï¸ é¿å…å¤æ‚çš„ attribute å®
// #[complex_macro_that_generates_thousands_of_lines]
```

---

### 10.2 ç¼–è¯‘å™¨å†…ç½®å·¥å…·

**Clippy** (Linter):

```bash
cargo clippy --all-targets --all-features
```

**Rustfmt** (ä»£ç æ ¼å¼åŒ–):

```bash
cargo fmt --all
```

**Miri** (å†…å­˜å®‰å…¨æ£€æŸ¥):

```bash
cargo +nightly miri test
```

---

## 11. é«˜çº§ç¼–è¯‘æŠ€æœ¯

### 11.1 Polly (LLVM ä¼˜åŒ–å™¨)

```bash
# å¯ç”¨ Polly (å®éªŒæ€§)
RUSTFLAGS="-C passes=polly" cargo build --release
```

---

### 11.2 è‡ªå®šä¹‰æ„å»ºè„šæœ¬

**build.rs**:

```rust
// build.rs
fn main() {
    // è®¾ç½®ç¼–è¯‘é€‰é¡¹
    println!("cargo:rustc-link-lib=static=mylib");
    println!("cargo:rustc-link-search=native=/usr/local/lib");

    // æ¡ä»¶ç¼–è¯‘
    if cfg!(target_os = "linux") {
        println!("cargo:rustc-cfg=linux_optimizations");
    }
}
```

---

## 12. å®æˆ˜æ¡ˆä¾‹

### 12.1 ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®

```toml
[profile.release]
opt-level = 3
lto = "fat"
codegen-units = 1
panic = "abort"
strip = true
overflow-checks = false
debug = false

[profile.release.build-override]
opt-level = 0  # æ„å»ºè„šæœ¬æ— éœ€ä¼˜åŒ–
```

**æ„å»ºå‘½ä»¤**:

```bash
# ä½¿ç”¨ PGO
export RUSTFLAGS="-C target-cpu=native -C profile-use=merged.profdata"
cargo build --release
```

---

### 12.2 å¼€å‘ç¯å¢ƒä¼˜åŒ–é…ç½®

```toml
[profile.dev]
opt-level = 1          # è½»åº¦ä¼˜åŒ–
incremental = true     # å¢é‡ç¼–è¯‘
debug = 2              # å®Œæ•´è°ƒè¯•ä¿¡æ¯
split-debuginfo = "unpacked"

[profile.dev.package."*"]
opt-level = 2          # ä¾èµ–åŒ…ä½¿ç”¨ O2
```

---

## 13. æ€§èƒ½åŸºå‡†

**ç¼–è¯‘æ—¶é—´å¯¹æ¯”** (1000 LOC é¡¹ç›®):

| é…ç½®           | æ¸…æ´æ„å»º | å¢é‡æ„å»º | äºŒè¿›åˆ¶å¤§å° | è¿è¡Œæ€§èƒ½ |
| -------------- | -------- | -------- | ---------- | -------- |
| Dev (é»˜è®¤)     | 5s       | 1s       | 10 MB      | 1x       |
| Release (é»˜è®¤) | 30s      | 15s      | 3 MB       | 8x       |
| Release + LTO  | 60s      | 30s      | 2.5 MB     | 10x      |
| Release + PGO  | 80s      | -        | 2.3 MB     | 12x      |

---

## 14. æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. ç¼–è¯‘é”™è¯¯: out of memory**:

```bash
# å‡å°‘å¹¶è¡Œä»»åŠ¡
export CARGO_BUILD_JOBS=2

# æˆ–å¢åŠ  swap ç©ºé—´
```

**2. å¢é‡ç¼–è¯‘æŸå**:

```bash
# æ¸…ç†ç¼“å­˜
cargo clean
rm -rf ~/.cargo/registry/cache
```

**3. LTO å¤±è´¥**:

```toml
# å°è¯• thin LTO
[profile.release]
lto = "thin"
codegen-units = 16  # å¢åŠ ä»£ç ç”Ÿæˆå•å…ƒ
```

---

## 15. ç›¸å…³èµ„æº

### ğŸ“š å®˜æ–¹æ–‡æ¡£

- [Rustc Book](https://doc.rust-lang.org/rustc/)
- [Cargo Book - Profiles](https://doc.rust-lang.org/cargo/reference/profiles.html)
- [LLVM Documentation](https://llvm.org/docs/)

### ğŸ”— ç›¸å…³æ–‡æ¡£

- [02_cargo_workspace_guide.md](./02_cargo_workspace_guide.md)
- [03_rustdoc_advanced.md](./03_rustdoc_advanced.md)

### ğŸ“¦ æ¨èå·¥å…·

- **sccache**: ç¼–è¯‘ç¼“å­˜
- **cargo-bloat**: åˆ†æäºŒè¿›åˆ¶å¤§å°
- **cargo-llvm-lines**: åˆ†æ LLVM IR
- **cargo-asm**: æŸ¥çœ‹ç”Ÿæˆçš„æ±‡ç¼–ä»£ç 

---

**æ–‡æ¡£ç»´æŠ¤**: Documentation Team
**æœ€åæ›´æ–°**: 2026-01-26
**ä¸‹æ¬¡å®¡æŸ¥**: 2026-01-22
**æœ€åå¯¹ç…§ releases.rs**: 2026-02-14
