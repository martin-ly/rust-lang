# ğŸ”§ Rustç¼–è¯‘å™¨å†…éƒ¨æœºåˆ¶å®Œæ•´æŒ‡å—ï¼ˆ2025ç‰ˆï¼‰

> **ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-20  
> **é€‚ç”¨rustcç‰ˆæœ¬**: 1.90+  
> **éš¾åº¦**: ğŸ”´ é«˜çº§åˆ°ä¸“å®¶çº§

---

## ğŸ“‹ ç›®å½•

- [ğŸ”§ Rustç¼–è¯‘å™¨å†…éƒ¨æœºåˆ¶å®Œæ•´æŒ‡å—ï¼ˆ2025ç‰ˆï¼‰](#-rustç¼–è¯‘å™¨å†…éƒ¨æœºåˆ¶å®Œæ•´æŒ‡å—2025ç‰ˆ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç®€ä»‹](#ç®€ä»‹)
  - [1. ç¼–è¯‘å™¨æ•´ä½“æ¶æ„](#1-ç¼–è¯‘å™¨æ•´ä½“æ¶æ„)
    - [1.1 å®è§‚æ¶æ„å›¾](#11-å®è§‚æ¶æ„å›¾)
    - [1.2 æ ¸å¿ƒæ•°æ®ç»“æ„](#12-æ ¸å¿ƒæ•°æ®ç»“æ„)
    - [1.3 ç¼–è¯‘æµç¨‹æ—¶é—´çº¿](#13-ç¼–è¯‘æµç¨‹æ—¶é—´çº¿)
  - [2. å‰ç«¯ï¼šä»æºç åˆ°HIR](#2-å‰ç«¯ä»æºç åˆ°hir)
    - [2.1 è¯æ³•åˆ†æï¼ˆLexingï¼‰](#21-è¯æ³•åˆ†ælexing)
      - [å®ç°ä½ç½®](#å®ç°ä½ç½®)
      - [Tokenç±»å‹](#tokenç±»å‹)
      - [ç¤ºä¾‹ï¼šè¯æ³•åˆ†æè¿‡ç¨‹](#ç¤ºä¾‹è¯æ³•åˆ†æè¿‡ç¨‹)
    - [2.2 è¯­æ³•åˆ†æï¼ˆParsingï¼‰](#22-è¯­æ³•åˆ†æparsing)
      - [2.2.1 å®ç°ä½ç½®](#221-å®ç°ä½ç½®)
      - [ASTèŠ‚ç‚¹ç¤ºä¾‹](#astèŠ‚ç‚¹ç¤ºä¾‹)
      - [è§£æç¤ºä¾‹](#è§£æç¤ºä¾‹)
    - [2.3 å®å±•å¼€](#23-å®å±•å¼€)
      - [å®ç±»å‹](#å®ç±»å‹)
      - [å±•å¼€è¿‡ç¨‹](#å±•å¼€è¿‡ç¨‹)
    - [2.4 HIRé™çº§](#24-hiré™çº§)
      - [HIR vs AST](#hir-vs-ast)
      - [HIRç¤ºä¾‹](#hirç¤ºä¾‹)
      - [å®Œæ•´ç¤ºä¾‹ï¼šä»æºç åˆ°HIR](#å®Œæ•´ç¤ºä¾‹ä»æºç åˆ°hir)
  - [3. ç±»å‹ç³»ç»Ÿä¸Traitæ±‚è§£](#3-ç±»å‹ç³»ç»Ÿä¸traitæ±‚è§£)
    - [3.1 ç±»å‹æ£€æŸ¥æµç¨‹](#31-ç±»å‹æ£€æŸ¥æµç¨‹)
    - [3.2 ç±»å‹æ¨æ–­ç®—æ³•](#32-ç±»å‹æ¨æ–­ç®—æ³•)
      - [ç±»å‹å˜é‡å’Œçº¦æŸ](#ç±»å‹å˜é‡å’Œçº¦æŸ)
      - [ç»Ÿä¸€ç®—æ³•ï¼ˆUnificationï¼‰](#ç»Ÿä¸€ç®—æ³•unification)
    - [3.3 Traitæ±‚è§£](#33-traitæ±‚è§£)
      - [Traitæ±‚è§£å™¨æ¶æ„](#traitæ±‚è§£å™¨æ¶æ„)
      - [Traitæ±‚è§£ç¤ºä¾‹](#traitæ±‚è§£ç¤ºä¾‹)
      - [å¤æ‚Traitæ±‚è§£](#å¤æ‚traitæ±‚è§£)
  - [4. å€Ÿç”¨æ£€æŸ¥å™¨æ·±åº¦è§£æ](#4-å€Ÿç”¨æ£€æŸ¥å™¨æ·±åº¦è§£æ)
    - [4.1 å€Ÿç”¨æ£€æŸ¥å™¨çš„ä¸‰å¤§æ”¯æŸ±](#41-å€Ÿç”¨æ£€æŸ¥å™¨çš„ä¸‰å¤§æ”¯æŸ±)
    - [4.2 NLLï¼ˆNon-Lexical Lifetimesï¼‰](#42-nllnon-lexical-lifetimes)
      - [NLLä¹‹å‰ vs NLLä¹‹å](#nllä¹‹å‰-vs-nllä¹‹å)
    - [4.3 å€Ÿç”¨æ£€æŸ¥ç®—æ³•](#43-å€Ÿç”¨æ£€æŸ¥ç®—æ³•)
      - [æ•°æ®æµåˆ†æ](#æ•°æ®æµåˆ†æ)
      - [ä¸‰åœ°è§„åˆ™ï¼ˆTwo-Phase Borrowsï¼‰](#ä¸‰åœ°è§„åˆ™two-phase-borrows)
    - [4.4 å€Ÿç”¨æ£€æŸ¥å™¨MIRåˆ†æ](#44-å€Ÿç”¨æ£€æŸ¥å™¨miråˆ†æ)
      - [MIRè¡¨ç¤º](#mirè¡¨ç¤º)
      - [å€Ÿç”¨æ£€æŸ¥åˆ†æ](#å€Ÿç”¨æ£€æŸ¥åˆ†æ)
  - [5. MIRï¼šä¸­é—´è¡¨ç¤ºè¯¦è§£](#5-mirä¸­é—´è¡¨ç¤ºè¯¦è§£)
    - [5.1 MIRæ¦‚è¿°](#51-miræ¦‚è¿°)
    - [5.2 MIRç»“æ„](#52-mirç»“æ„)
      - [MIRç»„æˆè¦ç´ ](#mirç»„æˆè¦ç´ )
    - [5.3 MIRç¤ºä¾‹](#53-mirç¤ºä¾‹)
      - [ç®€å•å‡½æ•°](#ç®€å•å‡½æ•°)
      - [æ§åˆ¶æµ](#æ§åˆ¶æµ)
      - [å¾ªç¯](#å¾ªç¯)
    - [5.4 æŸ¥çœ‹MIRçš„æ–¹æ³•](#54-æŸ¥çœ‹mirçš„æ–¹æ³•)
      - [å‘½ä»¤è¡Œæ ‡å¿—](#å‘½ä»¤è¡Œæ ‡å¿—)
      - [cargo-show-mirå·¥å…·](#cargo-show-mirå·¥å…·)
  - [6. ä¼˜åŒ–Passè¯¦è§£](#6-ä¼˜åŒ–passè¯¦è§£)
    - [6.1 MIRä¼˜åŒ–Passåˆ—è¡¨](#61-mirä¼˜åŒ–passåˆ—è¡¨)
    - [6.2 å¸¸é‡ä¼ æ’­ç¤ºä¾‹](#62-å¸¸é‡ä¼ æ’­ç¤ºä¾‹)
    - [6.3 å†…è”ä¼˜åŒ–](#63-å†…è”ä¼˜åŒ–)
    - [6.4 æ­»ä»£ç æ¶ˆé™¤](#64-æ­»ä»£ç æ¶ˆé™¤)
  - [7. LLVMåç«¯é›†æˆ](#7-llvmåç«¯é›†æˆ)
    - [7.1 LLVMæ¶æ„](#71-llvmæ¶æ„)
    - [7.2 MIRåˆ°LLVM IRçš„è½¬æ¢](#72-miråˆ°llvm-irçš„è½¬æ¢)
    - [7.3 å¤æ‚ç¤ºä¾‹](#73-å¤æ‚ç¤ºä¾‹)
    - [7.4 æŸ¥çœ‹LLVM IR](#74-æŸ¥çœ‹llvm-ir)
  - [8. ä»£ç ç”Ÿæˆä¸ABI](#8-ä»£ç ç”Ÿæˆä¸abi)
    - [8.1 è°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰](#81-è°ƒç”¨çº¦å®šcalling-convention)
    - [8.2 ABIå¸ƒå±€](#82-abiå¸ƒå±€)
    - [8.3 é›¶æˆæœ¬æŠ½è±¡å®ç°](#83-é›¶æˆæœ¬æŠ½è±¡å®ç°)
  - [9. å¢é‡ç¼–è¯‘æœºåˆ¶](#9-å¢é‡ç¼–è¯‘æœºåˆ¶)
    - [9.1 å¢é‡ç¼–è¯‘åŸç†](#91-å¢é‡ç¼–è¯‘åŸç†)
    - [9.2 æŸ¥è¯¢ç³»ç»Ÿ](#92-æŸ¥è¯¢ç³»ç»Ÿ)
  - [10. å®è·µï¼šæ¢ç´¢ç¼–è¯‘å™¨å†…éƒ¨](#10-å®è·µæ¢ç´¢ç¼–è¯‘å™¨å†…éƒ¨)
    - [10.1 æŸ¥çœ‹ç¼–è¯‘å™¨è¾“å‡º](#101-æŸ¥çœ‹ç¼–è¯‘å™¨è¾“å‡º)
    - [10.2 æŸ¥çœ‹MIR](#102-æŸ¥çœ‹mir)
    - [10.3 æŸ¥çœ‹LLVM IR](#103-æŸ¥çœ‹llvm-ir)
    - [10.4 æŸ¥çœ‹æ±‡ç¼–](#104-æŸ¥çœ‹æ±‡ç¼–)
    - [10.5 æ€§èƒ½åˆ†æ](#105-æ€§èƒ½åˆ†æ)
    - [10.6 è°ƒè¯•ç¼–è¯‘å™¨](#106-è°ƒè¯•ç¼–è¯‘å™¨)
  - [é™„å½•](#é™„å½•)
    - [A. å¸¸ç”¨rustcæ ‡å¿—](#a-å¸¸ç”¨rustcæ ‡å¿—)
    - [B. ç¼–è¯‘å™¨ç»„ä»¶ç´¢å¼•](#b-ç¼–è¯‘å™¨ç»„ä»¶ç´¢å¼•)
    - [C. å­¦ä¹ èµ„æº](#c-å­¦ä¹ èµ„æº)
    - [D. ç»ƒä¹ é¢˜](#d-ç»ƒä¹ é¢˜)
      - [åˆçº§ç»ƒä¹ ](#åˆçº§ç»ƒä¹ )
      - [ä¸­çº§ç»ƒä¹ ](#ä¸­çº§ç»ƒä¹ )
      - [é«˜çº§ç»ƒä¹ ](#é«˜çº§ç»ƒä¹ )

---

## ç®€ä»‹

Rustç¼–è¯‘å™¨ï¼ˆrustcï¼‰æ˜¯ä¸€ä¸ªé«˜åº¦å¤æ‚çš„å·¥ç¨‹ç³»ç»Ÿï¼Œè´Ÿè´£å°†Rustæºä»£ç è½¬æ¢ä¸ºé«˜æ•ˆçš„æœºå™¨ç ã€‚
æœ¬æŒ‡å—æ·±å…¥å‰–ærustcçš„å†…éƒ¨æœºåˆ¶ï¼Œå¸®åŠ©ä½ ç†è§£ï¼š

- ğŸ—ï¸ **ç¼–è¯‘å™¨æ¶æ„**ï¼šå¤šé˜¶æ®µç¼–è¯‘æµæ°´çº¿
- ğŸ” **é™æ€åˆ†æ**ï¼šç±»å‹æ£€æŸ¥ã€å€Ÿç”¨æ£€æŸ¥
- ğŸ¯ **ä¸­é—´è¡¨ç¤º**ï¼šAST â†’ HIR â†’ MIR â†’ LLVM IR
- âš¡ **ä¼˜åŒ–ç­–ç•¥**ï¼šæ­»ä»£ç æ¶ˆé™¤ã€å†…è”ã€å¾ªç¯ä¼˜åŒ–
- ğŸ”§ **ä»£ç ç”Ÿæˆ**ï¼šLLVMé›†æˆã€ABIçº¦å®š

**ä¸ºä»€ä¹ˆè¦å­¦ä¹ ç¼–è¯‘å™¨å†…éƒ¨ï¼Ÿ**

1. ğŸ’¡ **ç†è§£é”™è¯¯æ¶ˆæ¯**ï¼šçŸ¥é“ç¼–è¯‘å™¨åœ¨æ£€æŸ¥ä»€ä¹ˆ
2. ğŸš€ **æ€§èƒ½ä¼˜åŒ–**ï¼šäº†è§£ç¼–è¯‘å™¨å¦‚ä½•ä¼˜åŒ–ä»£ç 
3. ğŸ› ï¸ **å·¥å…·å¼€å‘**ï¼šå¼€å‘linterã€å®ã€IDEæ’ä»¶
4. ğŸ“š **æ·±å…¥ç†è§£Rust**ï¼šä»å®ç°å±‚é¢ç†è§£è¯­è¨€ç‰¹æ€§
5. ğŸ”¬ **ç¼–è¯‘å™¨è´¡çŒ®**ï¼šä¸ºrustcåšè´¡çŒ®

---

## 1. ç¼–è¯‘å™¨æ•´ä½“æ¶æ„

### 1.1 å®è§‚æ¶æ„å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Rustç¼–è¯‘å™¨æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  æºç  (.rs)                                                    â”‚
â”‚      â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  è¯æ³•åˆ†æå™¨    â”‚  Tokenæµ                                    â”‚
â”‚  â”‚  (Lexer)      â”‚  ---â†’  [fn, main, (, ), {, ...}             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚      â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  è¯­æ³•åˆ†æå™¨    â”‚  æŠ½è±¡è¯­æ³•æ ‘ (AST)                            â”‚
â”‚  â”‚  (Parser)     â”‚  ---â†’  Fn(main) { Block {...} }             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚      â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  å®å±•å¼€        â”‚  å±•å¼€åçš„AST                                â”‚
â”‚  â”‚  (Macro Exp)  â”‚  ---â†’  æ‰©å±•çš„è¯­æ³•æ ‘                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚      â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  HIRé™çº§       â”‚  é«˜çº§ä¸­é—´è¡¨ç¤º (HIR)                         â”‚
â”‚  â”‚  (HIR Lower)  â”‚  ---â†’  å»ç³–åçš„è¡¨ç¤º                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚      â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  ç±»å‹æ£€æŸ¥      â”‚  æ·»åŠ ç±»å‹ä¿¡æ¯                               â”‚
â”‚  â”‚  (Type Check) â”‚  ---â†’  ç±»å‹æ ‡æ³¨çš„HIR                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚      â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  å€Ÿç”¨æ£€æŸ¥      â”‚  éªŒè¯æ‰€æœ‰æƒè§„åˆ™                             â”‚
â”‚  â”‚  (Borrow Checkâ”‚  ---â†’  å®‰å…¨éªŒè¯                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚      â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  MIRæ„å»º       â”‚  ä¸­çº§ä¸­é—´è¡¨ç¤º (MIR)                        â”‚
â”‚  â”‚  (MIR Build)  â”‚  ---â†’  åŸºäºCFGçš„è¡¨ç¤º                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚      â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  MIRä¼˜åŒ–       â”‚  ä¼˜åŒ–çš„MIR                                 â”‚
â”‚  â”‚  (MIR Opt)    â”‚  ---â†’  å¸¸é‡ä¼ æ’­ã€å†…è”ç­‰                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚      â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  ä»£ç ç”Ÿæˆ      â”‚  LLVM IR                                   â”‚
â”‚  â”‚  (Codegen)    â”‚  ---â†’  LLVMä¸­é—´è¡¨ç¤º                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚      â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  LLVMåç«¯      â”‚  æœºå™¨ç                                     â”‚
â”‚  â”‚  (LLVM)       â”‚  ---â†’  ç›®æ ‡å¹³å°å¯æ‰§è¡Œæ–‡ä»¶                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚      â†“                                                         â”‚
â”‚  å¯æ‰§è¡Œæ–‡ä»¶ / åº“                                                â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ•°æ®ç»“æ„

```rust
// rustc_driver/src/lib.rs (ç®€åŒ–ç‰ˆ)
pub struct Compiler {
    pub session: Session,              // ç¼–è¯‘ä¼šè¯
    pub global_ctxt: GlobalCtxt,       // å…¨å±€ä¸Šä¸‹æ–‡
    pub queries: Queries,              // æŸ¥è¯¢ç³»ç»Ÿ
}

// ç¼–è¯‘ä¼šè¯
pub struct Session {
    pub target: Target,                // ç›®æ ‡å¹³å°
    pub opts: Options,                 // ç¼–è¯‘é€‰é¡¹
    pub parse_sess: ParseSess,         // è§£æä¼šè¯
    pub source_map: SourceMap,         // æºæ–‡ä»¶æ˜ å°„
}

// å…¨å±€ä¸Šä¸‹æ–‡ (åŒ…å«æ‰€æœ‰ç±»å‹ä¿¡æ¯)
pub struct GlobalCtxt<'tcx> {
    pub hir: Hir<'tcx>,               // HIRæ•°æ®
    pub types: Types<'tcx>,           // ç±»å‹ä¿¡æ¯
    pub arena: Arena<'tcx>,           // å†…å­˜arena
}
```

### 1.3 ç¼–è¯‘æµç¨‹æ—¶é—´çº¿

```text
ç¼–è¯‘æ—¶é—´åˆ†å¸ƒï¼ˆå…¸å‹1000è¡Œé¡¹ç›®ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯æ³•&è¯­æ³•åˆ†æ:  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10%  (~50ms)      â”‚
â”‚ å®å±•å¼€:        â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   5%  (~25ms)      â”‚
â”‚ HIRæ„å»º:       â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   8%  (~40ms)      â”‚
â”‚ ç±»å‹æ£€æŸ¥:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  20%  (~100ms)     â”‚
â”‚ å€Ÿç”¨æ£€æŸ¥:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  15%  (~75ms)      â”‚
â”‚ MIRä¼˜åŒ–:       â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10%  (~50ms)      â”‚
â”‚ LLVMä¼˜åŒ–:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  25%  (~125ms)     â”‚
â”‚ ä»£ç ç”Ÿæˆ:      â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   7%  (~35ms)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»è®¡: ~500ms (debugæ¨¡å¼)
```

---

## 2. å‰ç«¯ï¼šä»æºç åˆ°HIR

### 2.1 è¯æ³•åˆ†æï¼ˆLexingï¼‰

**ç›®æ ‡**ï¼šå°†å­—ç¬¦æµè½¬æ¢ä¸ºTokenæµ

#### å®ç°ä½ç½®

- `rustc_lexer` crate
- ä½¿ç”¨æ‰‹å†™çš„DFAï¼ˆç¡®å®šæ€§æœ‰é™è‡ªåŠ¨æœºï¼‰

#### Tokenç±»å‹

```rust
// rustc_lexer/src/lib.rs
pub enum TokenKind {
    // å­—é¢é‡
    Literal { kind: LiteralKind },
    
    // æ ‡è¯†ç¬¦å’Œå…³é”®å­—
    Ident,
    
    // æ“ä½œç¬¦å’Œç¬¦å·
    Semi,           // ;
    Comma,          // ,
    Dot,            // .
    OpenParen,      // (
    CloseParen,     // )
    OpenBrace,      // {
    CloseBrace,     // }
    
    // æ³¨é‡Šå’Œç©ºç™½
    LineComment,
    BlockComment { terminated: bool },
    Whitespace,
    
    // ç”Ÿå‘½å‘¨æœŸå’Œæ ‡ç­¾
    Lifetime { starts_with_number: bool },
}

pub enum LiteralKind {
    Int { base: Base, empty_int: bool },
    Float { base: Base, empty_exponent: bool },
    Char { terminated: bool },
    Byte { terminated: bool },
    Str { terminated: bool },
    RawStr { n_hashes: u16 },
    // ...
}
```

#### ç¤ºä¾‹ï¼šè¯æ³•åˆ†æè¿‡ç¨‹

```rust
// è¾“å…¥æºç 
let x = 42;

// Tokenæµ
[
    Token { kind: Ident("let"), span: 0..3 },
    Token { kind: Whitespace, span: 3..4 },
    Token { kind: Ident("x"), span: 4..5 },
    Token { kind: Whitespace, span: 5..6 },
    Token { kind: Eq, span: 6..7 },
    Token { kind: Whitespace, span: 7..8 },
    Token { kind: Literal(Int { base: Dec }), span: 8..10 },
    Token { kind: Semi, span: 10..11 },
]
```

### 2.2 è¯­æ³•åˆ†æï¼ˆParsingï¼‰

**ç›®æ ‡**ï¼šå°†Tokenæµè½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰

#### 2.2.1 å®ç°ä½ç½®

- `rustc_parse` crate
- é€’å½’ä¸‹é™è§£æå™¨

#### ASTèŠ‚ç‚¹ç¤ºä¾‹

```rust
// rustc_ast/src/ast.rs (ç®€åŒ–)
pub struct Crate {
    pub module: Mod,
    pub attrs: Vec<Attribute>,
    pub span: Span,
}

pub struct Item {
    pub ident: Ident,
    pub kind: ItemKind,
    pub span: Span,
    pub attrs: Vec<Attribute>,
}

pub enum ItemKind {
    Fn(Box<Fn>),
    Struct(Variant),
    Enum(EnumDef),
    Impl(Box<Impl>),
    Trait(Box<Trait>),
    // ...
}

pub struct Fn {
    pub defaultness: Defaultness,
    pub generics: Generics,
    pub sig: FnSig,
    pub body: Option<Block>,
}
```

#### è§£æç¤ºä¾‹

```rust
// è¾“å…¥
fn add(a: i32, b: i32) -> i32 {
    a + b
}

// ASTè¡¨ç¤º
Item {
    ident: "add",
    kind: Fn(Box<Fn> {
        sig: FnSig {
            decl: FnDecl {
                inputs: [
                    Param { ident: "a", ty: Path("i32") },
                    Param { ident: "b", ty: Path("i32") },
                ],
                output: Ty::Path("i32"),
            },
        },
        body: Some(Block {
            stmts: [
                Stmt::Expr(
                    Expr::Binary {
                        op: Add,
                        left: Expr::Path("a"),
                        right: Expr::Path("b"),
                    }
                ),
            ],
        }),
    }),
}
```

### 2.3 å®å±•å¼€

**ç›®æ ‡**ï¼šå±•å¼€å®è°ƒç”¨ï¼Œç”Ÿæˆæ–°çš„ASTèŠ‚ç‚¹

#### å®ç±»å‹

```rust
// å£°æ˜å¼å® (macro_rules!)
macro_rules! vec {
    ( $( $x:expr ),* ) => {
        {
            let mut temp_vec = Vec::new();
            $(
                temp_vec.push($x);
            )*
            temp_vec
        }
    };
}

// è¿‡ç¨‹å® (Procedural Macros)
// 1. å‡½æ•°å¼è¿‡ç¨‹å®
#[proc_macro]
pub fn my_macro(input: TokenStream) -> TokenStream { }

// 2. æ´¾ç”Ÿå®
#[proc_macro_derive(MyDerive)]
pub fn my_derive(input: TokenStream) -> TokenStream { }

// 3. å±æ€§å®
#[proc_macro_attribute]
pub fn my_attr(attr: TokenStream, item: TokenStream) -> TokenStream { }
```

#### å±•å¼€è¿‡ç¨‹

```text
å±•å¼€å‰:
vec![1, 2, 3]

å±•å¼€å:
{
    let mut temp_vec = Vec::new();
    temp_vec.push(1);
    temp_vec.push(2);
    temp_vec.push(3);
    temp_vec
}
```

### 2.4 HIRé™çº§

**ç›®æ ‡**ï¼šå°†ASTè½¬æ¢ä¸ºHIRï¼ˆå»ç³–ã€è§„èŒƒåŒ–ï¼‰

#### HIR vs AST

| ç‰¹æ€§ | AST | HIR |
|------|-----|-----|
| **è¯­æ³•ç³–** | ä¿ç•™ | å»é™¤ |
| **forå¾ªç¯** | è¯­æ³•ç³– | è½¬æ¢ä¸ºloop+match |
| **if let** | è¯­æ³•ç³– | è½¬æ¢ä¸ºmatch |
| **?æ“ä½œç¬¦** | è¯­æ³•ç³– | è½¬æ¢ä¸ºmatch |
| **ä½œç”¨åŸŸ** | è¯æ³• | è§„èŒƒåŒ– |
| **ç”Ÿå‘½å‘¨æœŸ** | æ˜¾å¼+æ¨æ–­ | å®Œå…¨æ˜¾å¼ |

#### HIRç¤ºä¾‹

```rust
// æºç 
for item in vec {
    println!("{}", item);
}

// HIR (ä¼ªä»£ç )
{
    let mut iter = IntoIterator::into_iter(vec);
    loop {
        match Iterator::next(&mut iter) {
            Some(item) => {
                println!("{}", item);
            }
            None => break,
        }
    }
}
```

#### å®Œæ•´ç¤ºä¾‹ï¼šä»æºç åˆ°HIR

```rust
// æºç 
fn example() -> Result<i32, Error> {
    let x = read_number()?;
    Ok(x + 1)
}

// AST (ç®€åŒ–)
Fn {
    sig: "() -> Result<i32, Error>",
    body: Block {
        stmts: [
            Let { pat: "x", init: Try(Call("read_number")) },
            Expr(Call("Ok", [Binary(Add, "x", 1)])),
        ],
    },
}

// HIR (ä¼ªä»£ç ï¼Œå±•å¼€?å’ŒOk)
Fn {
    sig: "() -> Result<i32, Error>",
    body: Block {
        stmts: [
            Let { 
                pat: "x", 
                init: Match(Call("read_number")) {
                    Ok(val) => val,
                    Err(e) => return Err(From::from(e)),
                },
            },
            Return(
                Call("Result::Ok", [Binary(Add, "x", 1)])
            ),
        ],
    },
}
```

---

## 3. ç±»å‹ç³»ç»Ÿä¸Traitæ±‚è§£

### 3.1 ç±»å‹æ£€æŸ¥æµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç±»å‹æ£€æŸ¥æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. æ”¶é›†é¡¹å®šä¹‰                                          â”‚
â”‚     â”œâ”€ æ”¶é›†æ‰€æœ‰fnã€structã€enumã€traitå®šä¹‰            â”‚
â”‚     â””â”€ å»ºç«‹def_idåˆ°ç±»å‹çš„æ˜ å°„                          â”‚
â”‚                                                         â”‚
â”‚  2. ç±»å‹æ¨æ–­                                            â”‚
â”‚     â”œâ”€ è‡ªåº•å‘ä¸Šæ¨æ–­è¡¨è¾¾å¼ç±»å‹                          â”‚
â”‚     â”œâ”€ ç”Ÿæˆç±»å‹çº¦æŸ                                    â”‚
â”‚     â””â”€ ç»Ÿä¸€ï¼ˆUnificationï¼‰è§£å†³çº¦æŸ                     â”‚
â”‚                                                         â”‚
â”‚  3. Traitæ±‚è§£                                           â”‚
â”‚     â”œâ”€ æ”¶é›†trait bounds                                â”‚
â”‚     â”œâ”€ æ£€æŸ¥implå—                                      â”‚
â”‚     â””â”€ è§£å†³traitå¯¹è±¡å’Œdynè°ƒç”¨                         â”‚
â”‚                                                         â”‚
â”‚  4. ç”Ÿå‘½å‘¨æœŸæ¨æ–­                                        â”‚
â”‚     â”œâ”€ æ”¶é›†ç”Ÿå‘½å‘¨æœŸçº¦æŸ                                â”‚
â”‚     â”œâ”€ ç”Ÿå‘½å‘¨æœŸå­ç±»å‹å…³ç³»                              â”‚
â”‚     â””â”€ æ£€æŸ¥ç”Ÿå‘½å‘¨æœŸæœ‰æ•ˆæ€§                              â”‚
â”‚                                                         â”‚
â”‚  5. å®Œæ•´æ€§æ£€æŸ¥                                          â”‚
â”‚     â”œâ”€ æ£€æŸ¥å­¤å„¿è§„åˆ™                                    â”‚
â”‚     â”œâ”€ æ£€æŸ¥ä¸€è‡´æ€§                                      â”‚
â”‚     â””â”€ æ£€æŸ¥ç‰¹åŒ–è§„åˆ™                                    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç±»å‹æ¨æ–­ç®—æ³•

Rustä½¿ç”¨**Hindley-Milnerç±»å‹æ¨æ–­**çš„æ‰©å±•ç‰ˆæœ¬ã€‚

#### ç±»å‹å˜é‡å’Œçº¦æŸ

```rust
// æºç 
fn example() {
    let x = vec![];    // xçš„ç±»å‹æœªçŸ¥
    x.push(42);        // æ¨æ–­å‡ºx: Vec<i32>
}

// ç±»å‹æ¨æ–­è¿‡ç¨‹
// 1. åˆå§‹çŠ¶æ€
x: ?T0              // xæ˜¯ç±»å‹å˜é‡T0
vec![]: Vec<?T1>    // vec![]è¿”å›Vec<T1>

// 2. ç”Ÿæˆçº¦æŸ
?T0 = Vec<?T1>      // let x = vec![]

// 3. pushè°ƒç”¨ç”Ÿæˆçº¦æŸ
Vec<?T1>::push(&mut Vec<?T1>, ?T2)
?T2 = i32           // å­—é¢é‡42

// 4. ç»Ÿä¸€çº¦æŸ
?T1 = i32
?T0 = Vec<i32>
```

#### ç»Ÿä¸€ç®—æ³•ï¼ˆUnificationï¼‰

```rust
// rustc_infer/src/infer/unify.rs (ç®€åŒ–)
impl<'tcx> TypeUnifier<'tcx> {
    fn unify(&mut self, a: Ty<'tcx>, b: Ty<'tcx>) -> Result<(), TypeError> {
        match (a.kind(), b.kind()) {
            // ä¸¤ä¸ªç±»å‹å˜é‡
            (TyKind::Infer(a_var), TyKind::Infer(b_var)) => {
                self.unify_vars(a_var, b_var)
            }
            
            // ä¸€ä¸ªç±»å‹å˜é‡ï¼Œä¸€ä¸ªå…·ä½“ç±»å‹
            (TyKind::Infer(var), ty) | (ty, TyKind::Infer(var)) => {
                self.instantiate(var, ty)
            }
            
            // ä¸¤ä¸ªå…·ä½“ç±»å‹
            (TyKind::Adt(a_def, a_substs), TyKind::Adt(b_def, b_substs)) => {
                if a_def == b_def {
                    self.unify_substs(a_substs, b_substs)
                } else {
                    Err(TypeError::Mismatch)
                }
            }
            
            _ => Err(TypeError::Mismatch),
        }
    }
}
```

### 3.3 Traitæ±‚è§£

#### Traitæ±‚è§£å™¨æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Traitæ±‚è§£å™¨ï¼ˆChalkï¼‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  æŸ¥è¯¢: T: Display                                  â”‚
â”‚     â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  æœç´¢implå—          â”‚                         â”‚
â”‚  â”‚  impl Display for T  â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚     â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  æ£€æŸ¥çº¦æŸ            â”‚                         â”‚
â”‚  â”‚  where T: Debug      â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚     â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  é€’å½’æ±‚è§£            â”‚                         â”‚
â”‚  â”‚  solve(T: Debug)     â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚     â†“                                              â”‚
â”‚  æˆåŠŸ / å¤±è´¥ / æ¨¡ç³Š                                â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Traitæ±‚è§£ç¤ºä¾‹

```rust
// æºç 
fn print_vec<T: Display>(vec: Vec<T>) {
    for item in vec {
        println!("{}", item);
    }
}

// Traitçº¦æŸ
T: Display

// Traitæ±‚è§£è¿‡ç¨‹
1. æŸ¥æ‰¾: impl Display for T?
2. æ£€æŸ¥æ³›å‹çº¦æŸ: T: Display âœ“
3. éªŒè¯: println!å®éœ€è¦Display âœ“
4. ç»“æœ: æ»¡è¶³çº¦æŸ
```

#### å¤æ‚Traitæ±‚è§£

```rust
// æºç 
fn complex<T>(x: T)
where
    T: Iterator,
    T::Item: Display + Clone,
{
    // ...
}

// çº¦æŸæ±‚è§£
1. T: Iterator
2. <T as Iterator>::Item: Display
3. <T as Iterator>::Item: Clone

// æ±‚è§£æ­¥éª¤
Step 1: æŸ¥æ‰¾Tå®ç°Iterator
Step 2: è·å–å…³è”ç±»å‹Item
Step 3: éªŒè¯Itemå®ç°Displayå’ŒClone
Step 4: å…¨éƒ¨æ»¡è¶³ â†’ é€šè¿‡
```

---

## 4. å€Ÿç”¨æ£€æŸ¥å™¨æ·±åº¦è§£æ

### 4.1 å€Ÿç”¨æ£€æŸ¥å™¨çš„ä¸‰å¤§æ”¯æŸ±

1. **æ‰€æœ‰æƒè¿½è¸ª**ï¼šè°æ‹¥æœ‰å€¼
2. **å€Ÿç”¨è¿½è¸ª**ï¼šè°åœ¨å€Ÿç”¨å€¼
3. **ç”Ÿå‘½å‘¨æœŸéªŒè¯**ï¼šå€Ÿç”¨æ˜¯å¦æœ‰æ•ˆ

### 4.2 NLLï¼ˆNon-Lexical Lifetimesï¼‰

#### NLLä¹‹å‰ vs NLLä¹‹å

```rust
// ç¤ºä¾‹ä»£ç 
fn example() {
    let mut x = 5;
    let y = &x;        // ä¸å¯å˜å€Ÿç”¨å¼€å§‹
    
    if false {
        println!("{}", y);
    }
    // æ—§ç‰ˆ: yçš„ç”Ÿå‘½å‘¨æœŸå»¶ç»­åˆ°ä½œç”¨åŸŸç»“æŸ
    // NLL: yçš„ç”Ÿå‘½å‘¨æœŸåœ¨è¿™é‡Œç»“æŸï¼ˆæœ€åä½¿ç”¨ç‚¹ï¼‰
    
    x = 10;            // æ—§ç‰ˆ: âŒ é”™è¯¯
                       // NLL:  âœ… é€šè¿‡
}
```

### 4.3 å€Ÿç”¨æ£€æŸ¥ç®—æ³•

#### æ•°æ®æµåˆ†æ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å€Ÿç”¨æ£€æŸ¥æ•°æ®æµåˆ†æ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  fn example(flag: bool) {                          â”‚
â”‚      let mut x = 5;       // Point 0               â”‚
â”‚                                                     â”‚
â”‚      let r1 = &x;         // Point 1: Borrow(x)    â”‚
â”‚                           // Loan L1 starts        â”‚
â”‚                                                     â”‚
â”‚      if flag {            // Point 2               â”‚
â”‚          println!("{}", r1); // Point 3: Use(L1)   â”‚
â”‚      }                    // Point 4: L1 ends      â”‚
â”‚                                                     â”‚
â”‚      x = 10;              // Point 5: Write(x)     â”‚
â”‚  }                                                  â”‚
â”‚                                                     â”‚
â”‚  æ•°æ®æµ:                                            â”‚
â”‚  Point 0: Loans = {}                               â”‚
â”‚  Point 1: Loans = {L1}                             â”‚
â”‚  Point 2: Loans = {L1}                             â”‚
â”‚  Point 3: Loans = {L1}     (ä½¿ç”¨L1)                â”‚
â”‚  Point 4: Loans = {}       (L1ç»“æŸ)                â”‚
â”‚  Point 5: Loans = {}       (å¯ä»¥å†™x)  âœ“            â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸‰åœ°è§„åˆ™ï¼ˆTwo-Phase Borrowsï¼‰

```rust
// ç¤ºä¾‹ï¼švec.push(vec.len())
let mut vec = vec![1, 2, 3];

// å±•å¼€è¿‡ç¨‹
Vec::push(&mut vec, Vec::len(&vec));
//         ^^^^^^^^  å€Ÿç”¨1: &mut
//                   ^^^^^^^^ å€Ÿç”¨2: &

// ä¸¤é˜¶æ®µå€Ÿç”¨
// Phase 1 (Reserve): &mut vecé¢„ç•™ï¼Œä½†æœªæ¿€æ´»
// Phase 2 (Activate): è®¡ç®—len(&vec)åæ¿€æ´»&mut
```

### 4.4 å€Ÿç”¨æ£€æŸ¥å™¨MIRåˆ†æ

#### MIRè¡¨ç¤º

```rust
// æºç 
fn borrow_example() {
    let mut x = 5;
    let y = &x;
    println!("{}", y);
}

// MIR (ç®€åŒ–)
fn borrow_example() -> () {
    let mut _0: ();
    let mut _1: i32;     // x
    let _2: &i32;        // y
    
    bb0: {
        _1 = const 5_i32;               // x = 5
        _2 = &_1;                       // y = &x  (Loan L1 starts)
        _0 = println!("{}", move _2);   // use y   (Use L1)
        return;                         // L1 ends
    }
}
```

#### å€Ÿç”¨æ£€æŸ¥åˆ†æ

```rust
// å€Ÿç”¨æ£€æŸ¥å™¨åˆ†æMIR
// 1. æ„å»ºCFG
// 2. è®¡ç®—æ´»è·ƒæ€§
// 3. è¿½è¸ªå€Ÿç”¨
// 4. æ£€æµ‹å†²çª

// ä¼ªä»£ç 
fn check_borrows(mir: &Mir) {
    let cfg = build_cfg(mir);
    let liveness = compute_liveness(&cfg);
    let loans = track_loans(&cfg);
    
    for (point, loans) in &loans {
        // æ£€æŸ¥æ˜¯å¦æœ‰å†²çªçš„å€Ÿç”¨
        check_for_conflicts(point, loans)?;
    }
}
```

---

## 5. MIRï¼šä¸­é—´è¡¨ç¤ºè¯¦è§£

### 5.1 MIRæ¦‚è¿°

MIRï¼ˆMid-level Intermediate Representationï¼‰æ˜¯Rustç¼–è¯‘å™¨çš„æ ¸å¿ƒä¸­é—´è¡¨ç¤ºï¼Œä»‹äºHIRå’ŒLLVM IRä¹‹é—´ã€‚

**MIRçš„ä¼˜åŠ¿**ï¼š

- ğŸ¯ **ç®€å•æ˜ç¡®**ï¼šåŸºäºCFGï¼ˆæ§åˆ¶æµå›¾ï¼‰
- ğŸ” **æ˜“äºåˆ†æ**ï¼šé€‚åˆæ•°æ®æµåˆ†æ
- âš¡ **ä¼˜åŒ–å‹å¥½**ï¼šæ”¯æŒå¤šç§ä¼˜åŒ–pass
- ğŸ›¡ï¸ **ç±»å‹å®‰å…¨**ï¼šä¿ç•™ç±»å‹ä¿¡æ¯

### 5.2 MIRç»“æ„

#### MIRç»„æˆè¦ç´ 

```rust
// rustc_middle/src/mir/mod.rs (ç®€åŒ–)
pub struct Body<'tcx> {
    pub basic_blocks: IndexVec<BasicBlock, BasicBlockData<'tcx>>,
    pub local_decls: IndexVec<Local, LocalDecl<'tcx>>,
    pub arg_count: usize,
    pub source_scopes: IndexVec<SourceScope, SourceScopeData>,
}

pub struct BasicBlockData<'tcx> {
    pub statements: Vec<Statement<'tcx>>,
    pub terminator: Option<Terminator<'tcx>>,
}

pub enum Statement<'tcx> {
    Assign(Box<(Place<'tcx>, Rvalue<'tcx>)>),
    SetDiscriminant { place: Place<'tcx>, variant_index: VariantIdx },
    StorageLive(Local),
    StorageDead(Local),
    Nop,
}

pub enum Terminator<'tcx> {
    Goto { target: BasicBlock },
    SwitchInt { discr: Operand<'tcx>, targets: SwitchTargets },
    Return,
    Unreachable,
    Drop { place: Place<'tcx>, target: BasicBlock, unwind: Option<BasicBlock> },
    Call { func: Operand<'tcx>, args: Vec<Operand<'tcx>>, destination: Place<'tcx>, target: Option<BasicBlock> },
}
```

### 5.3 MIRç¤ºä¾‹

#### ç®€å•å‡½æ•°

```rust
// æºç 
fn add(a: i32, b: i32) -> i32 {
    a + b
}

// MIR
fn add(_1: i32, _2: i32) -> i32 {
    let mut _0: i32;                     // è¿”å›å€¼
    
    bb0: {
        _0 = Add(move _1, move _2);     // _0 = _1 + _2
        return;                          // è¿”å›_0
    }
}
```

#### æ§åˆ¶æµ

```rust
// æºç 
fn max(a: i32, b: i32) -> i32 {
    if a > b {
        a
    } else {
        b
    }
}

// MIR
fn max(_1: i32, _2: i32) -> i32 {
    let mut _0: i32;                    // è¿”å›å€¼
    let mut _3: bool;                   // æ¡ä»¶
    
    bb0: {
        _3 = Gt(move _1, move _2);     // _3 = _1 > _2
        switchInt(move _3) -> [0: bb2, otherwise: bb1];
    }
    
    bb1: {                              // ifåˆ†æ”¯
        _0 = move _1;
        goto -> bb3;
    }
    
    bb2: {                              // elseåˆ†æ”¯
        _0 = move _2;
        goto -> bb3;
    }
    
    bb3: {                              // åˆå¹¶ç‚¹
        return;
    }
}
```

#### å¾ªç¯

```rust
// æºç 
fn sum_to(n: i32) -> i32 {
    let mut sum = 0;
    let mut i = 1;
    while i <= n {
        sum += i;
        i += 1;
    }
    sum
}

// MIR
fn sum_to(_1: i32) -> i32 {
    let mut _0: i32;                    // è¿”å›å€¼
    let mut _2: i32;                    // sum
    let mut _3: i32;                    // i
    let mut _4: bool;                   // æ¡ä»¶
    
    bb0: {
        _2 = const 0_i32;               // sum = 0
        _3 = const 1_i32;               // i = 1
        goto -> bb1;
    }
    
    bb1: {                              // å¾ªç¯å¤´
        _4 = Le(move _3, move _1);      // i <= n
        switchInt(move _4) -> [0: bb3, otherwise: bb2];
    }
    
    bb2: {                              // å¾ªç¯ä½“
        _2 = Add(move _2, move _3);     // sum += i
        _3 = Add(move _3, const 1_i32); // i += 1
        goto -> bb1;
    }
    
    bb3: {                              // å¾ªç¯å
        _0 = move _2;
        return;
    }
}
```

### 5.4 æŸ¥çœ‹MIRçš„æ–¹æ³•

#### å‘½ä»¤è¡Œæ ‡å¿—

```bash
# æŸ¥çœ‹MIR
rustc +nightly -Z unpretty=mir main.rs

# æŸ¥çœ‹ç‰¹å®šå‡½æ•°çš„MIR
rustc +nightly -Z dump-mir=all main.rs

# æŸ¥çœ‹MIRå›¾å½¢åŒ–ï¼ˆéœ€è¦graphvizï¼‰
rustc +nightly -Z dump-mir-graphviz main.rs
```

#### cargo-show-mirå·¥å…·

```bash
# å®‰è£…
cargo install cargo-show-mir

# ä½¿ç”¨
cargo show-mir --fn add
```

---

## 6. ä¼˜åŒ–Passè¯¦è§£

### 6.1 MIRä¼˜åŒ–Passåˆ—è¡¨

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MIRä¼˜åŒ–Pass                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. SimplifyCfg             - CFGç®€åŒ–                   â”‚
â”‚  2. ConstProp               - å¸¸é‡ä¼ æ’­                  â”‚
â”‚  3. CopyProp                - å¤åˆ¶ä¼ æ’­                  â”‚
â”‚  4. DeadStoreElimination    - æ­»å­˜å‚¨æ¶ˆé™¤                â”‚
â”‚  5. Inline                  - å‡½æ•°å†…è”                  â”‚
â”‚  6. InstCombine             - æŒ‡ä»¤åˆå¹¶                  â”‚
â”‚  7. SimplifyBranches        - åˆ†æ”¯ç®€åŒ–                  â”‚
â”‚  8. RemoveDeadBlocks        - æ­»ä»£ç å—æ¶ˆé™¤              â”‚
â”‚  9. UnreachableCodeRemoval  - ä¸å¯è¾¾ä»£ç æ¶ˆé™¤            â”‚
â”‚ 10. SimplifyLocals          - å±€éƒ¨å˜é‡ç®€åŒ–              â”‚
â”‚ 11. RemoveZsts              - é›¶å¤§å°ç±»å‹æ¶ˆé™¤            â”‚
â”‚ 12. AddRetag                - æ·»åŠ é‡æ–°æ ‡è®°ï¼ˆStacked     â”‚
â”‚                               Borrowsï¼‰                 â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å¸¸é‡ä¼ æ’­ç¤ºä¾‹

```rust
// ä¼˜åŒ–å‰
fn example() -> i32 {
    let x = 10;
    let y = 20;
    let z = x + y;
    z
}

// MIR (ä¼˜åŒ–å‰)
fn example() -> i32 {
    let mut _0: i32;
    let _1: i32;  // x
    let _2: i32;  // y
    let _3: i32;  // z
    
    bb0: {
        _1 = const 10_i32;
        _2 = const 20_i32;
        _3 = Add(move _1, move _2);
        _0 = move _3;
        return;
    }
}

// MIR (å¸¸é‡ä¼ æ’­å)
fn example() -> i32 {
    let mut _0: i32;
    
    bb0: {
        _0 = const 30_i32;  // ç›´æ¥è®¡ç®—ç»“æœ
        return;
    }
}
```

### 6.3 å†…è”ä¼˜åŒ–

```rust
// æºç 
#[inline]
fn square(x: i32) -> i32 {
    x * x
}

fn main() {
    let result = square(5);
    println!("{}", result);
}

// å†…è”å‰MIR
fn main() {
    bb0: {
        _1 = square(const 5_i32);  // å‡½æ•°è°ƒç”¨
        println!("{}", move _1);
        return;
    }
}

// å†…è”åMIR
fn main() {
    bb0: {
        _1 = Mul(const 5_i32, const 5_i32);  // ç›´æ¥è®¡ç®—
        println!("{}", move _1);
        return;
    }
}
```

### 6.4 æ­»ä»£ç æ¶ˆé™¤

```rust
// æºç 
fn example(flag: bool) -> i32 {
    let x = 10;
    let y = 20;  // æœªä½¿ç”¨
    if flag {
        x
    } else {
        0
    }
}

// ä¼˜åŒ–åï¼ˆæ¶ˆé™¤yï¼‰
fn example(flag: bool) -> i32 {
    let x = 10;
    if flag {
        x
    } else {
        0
    }
}
```

---

## 7. LLVMåç«¯é›†æˆ

### 7.1 LLVMæ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 LLVMç¼–è¯‘æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  MIR                                                   â”‚
â”‚   â†“                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚  MIR â†’ LLVM IR   â”‚  ä»£ç ç”Ÿæˆ                        â”‚
â”‚  â”‚  (Codegen)       â”‚  rustc_codegen_llvm             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚   â†“                                                    â”‚
â”‚  LLVM IR                                               â”‚
â”‚   â†“                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚  LLVMä¼˜åŒ–Pass    â”‚  -O1, -O2, -O3ä¼˜åŒ–              â”‚
â”‚  â”‚  (Optimizer)     â”‚  llvm-opt                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚   â†“                                                    â”‚
â”‚  ä¼˜åŒ–çš„LLVM IR                                         â”‚
â”‚   â†“                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚  æœºå™¨ç ç”Ÿæˆ      â”‚  ç›®æ ‡ç‰¹å®šä»£ç ç”Ÿæˆ                â”‚
â”‚  â”‚  (CodeGen)       â”‚  llc                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚   â†“                                                    â”‚
â”‚  æ±‡ç¼–/ç›®æ ‡æ–‡ä»¶                                         â”‚
â”‚   â†“                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚  é“¾æ¥            â”‚  é“¾æ¥å™¨ï¼ˆld, lldï¼‰               â”‚
â”‚  â”‚  (Linker)        â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚   â†“                                                    â”‚
â”‚  å¯æ‰§è¡Œæ–‡ä»¶                                            â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 MIRåˆ°LLVM IRçš„è½¬æ¢

```rust
// Rustæºç 
fn add(a: i32, b: i32) -> i32 {
    a + b
}

// LLVM IR
define i32 @add(i32 %a, i32 %b) {
entry:
  %0 = add nsw i32 %a, %b
  ret i32 %0
}
```

### 7.3 å¤æ‚ç¤ºä¾‹

```rust
// Rustæºç 
fn factorial(n: u32) -> u32 {
    if n == 0 {
        1
    } else {
        n * factorial(n - 1)
    }
}

// LLVM IR
define i32 @factorial(i32 %n) {
entry:
  %0 = icmp eq i32 %n, 0
  br i1 %0, label %then, label %else

then:
  ret i32 1

else:
  %1 = sub i32 %n, 1
  %2 = call i32 @factorial(i32 %1)
  %3 = mul i32 %n, %2
  ret i32 %3
}
```

### 7.4 æŸ¥çœ‹LLVM IR

```bash
# ç”ŸæˆLLVM IR
rustc --emit=llvm-ir main.rs

# ç”Ÿæˆä¼˜åŒ–çš„LLVM IR
rustc --emit=llvm-ir -C opt-level=3 main.rs

# æŸ¥çœ‹æ±‡ç¼–
rustc --emit=asm main.rs
```

---

## 8. ä»£ç ç”Ÿæˆä¸ABI

### 8.1 è°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰

```rust
// ä¸åŒçš„è°ƒç”¨çº¦å®š
extern "C" fn c_function() { }       // Cè°ƒç”¨çº¦å®š
extern "system" fn sys_function() { } // ç³»ç»Ÿè°ƒç”¨çº¦å®š
extern "Rust" fn rust_function() { }  // Rustè°ƒç”¨çº¦å®šï¼ˆé»˜è®¤ï¼‰
```

### 8.2 ABIå¸ƒå±€

```rust
// ç»“æ„ä½“å¸ƒå±€
#[repr(C)]
struct CLayout {
    a: u8,
    b: u32,
    c: u16,
}
// Cå¸ƒå±€: é¡ºåºæ’åˆ—ï¼Œå¸¦å¯¹é½

#[repr(Rust)]
struct RustLayout {
    a: u8,
    b: u32,
    c: u16,
}
// Rustå¸ƒå±€: å¯èƒ½é‡æ’åºä»¥æœ€å°åŒ–å¤§å°
```

### 8.3 é›¶æˆæœ¬æŠ½è±¡å®ç°

```rust
// é«˜çº§æŠ½è±¡
let sum: i32 = vec![1, 2, 3, 4, 5]
    .iter()
    .filter(|&&x| x % 2 == 0)
    .map(|&x| x * 2)
    .sum();

// ç¼–è¯‘åç­‰ä»·äºæ‰‹å†™å¾ªç¯ï¼ˆé›¶æˆæœ¬ï¼‰
let mut sum = 0;
for x in &[1, 2, 3, 4, 5] {
    if x % 2 == 0 {
        sum += x * 2;
    }
}
```

---

## 9. å¢é‡ç¼–è¯‘æœºåˆ¶

### 9.1 å¢é‡ç¼–è¯‘åŸç†

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å¢é‡ç¼–è¯‘ç³»ç»Ÿ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  1. ä¾èµ–å›¾æ„å»º                                      â”‚
â”‚     â”œâ”€ è¿½è¸ªæ¯ä¸ªå®šä¹‰çš„ä¾èµ–                          â”‚
â”‚     â””â”€ å»ºç«‹ç»†ç²’åº¦ä¾èµ–å…³ç³»                          â”‚
â”‚                                                     â”‚
â”‚  2. æŒ‡çº¹è®¡ç®—ï¼ˆFingerprintingï¼‰                      â”‚
â”‚     â”œâ”€ ä¸ºæ¯ä¸ªç¼–è¯‘å•å…ƒè®¡ç®—å“ˆå¸Œ                      â”‚
â”‚     â””â”€ æ£€æµ‹å˜åŒ–                                    â”‚
â”‚                                                     â”‚
â”‚  3. æŸ¥è¯¢ç³»ç»Ÿï¼ˆQuery Systemï¼‰                        â”‚
â”‚     â”œâ”€ ç¼“å­˜æŸ¥è¯¢ç»“æœ                                â”‚
â”‚     â”œâ”€ è·Ÿè¸ªæŸ¥è¯¢ä¾èµ–                                â”‚
â”‚     â””â”€ æŒ‰éœ€é‡æ–°è®¡ç®—                                â”‚
â”‚                                                     â”‚
â”‚  4. å¢é‡ç¼“å­˜                                        â”‚
â”‚     â”œâ”€ target/debug/incremental/                   â”‚
â”‚     â””â”€ æŒä¹…åŒ–ä¸­é—´ç»“æœ                              â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æŸ¥è¯¢ç³»ç»Ÿ

```rust
// rustcæŸ¥è¯¢ç³»ç»Ÿç¤ºä¾‹
query type_of(key: DefId) -> Ty {
    desc { |tcx| "computing type of `{}`", tcx.def_path_str(key) }
    cache_on_disk_if { key.is_local() }
}

query mir_built(key: ty::WithOptConstParam<LocalDefId>) -> &'tcx Steal<mir::Body<'tcx>> {
    storage(ArenaCacheSelector<'tcx>)
    desc { |tcx| "building MIR for `{}`", tcx.def_path_str(key.did.to_def_id()) }
}
```

---

## 10. å®è·µï¼šæ¢ç´¢ç¼–è¯‘å™¨å†…éƒ¨

### 10.1 æŸ¥çœ‹ç¼–è¯‘å™¨è¾“å‡º

```bash
# æŸ¥çœ‹å®Œæ•´ç¼–è¯‘è¿‡ç¨‹
cargo build -v

# æŸ¥çœ‹æ—¶é—´ç»Ÿè®¡
cargo build -Z time-passes

# æŸ¥çœ‹å„é˜¶æ®µè¯¦ç»†ä¿¡æ¯
RUSTFLAGS="-Z time-passes" cargo build
```

### 10.2 æŸ¥çœ‹MIR

```rust
// main.rs
fn factorial(n: u32) -> u32 {
    if n == 0 {
        1
    } else {
        n * factorial(n - 1)
    }
}

fn main() {
    println!("{}", factorial(5));
}
```

```bash
# æŸ¥çœ‹MIR
rustc +nightly -Z unpretty=mir main.rs > mir.txt
```

### 10.3 æŸ¥çœ‹LLVM IR

```bash
# ç”ŸæˆLLVM IR
rustc --emit=llvm-ir main.rs -o main.ll

# æŸ¥çœ‹ä¼˜åŒ–çš„LLVM IR
rustc --emit=llvm-ir -C opt-level=3 main.rs -o main_opt.ll
```

### 10.4 æŸ¥çœ‹æ±‡ç¼–

```bash
# ç”Ÿæˆæ±‡ç¼–
rustc --emit=asm main.rs -o main.s

# ä½¿ç”¨cargo-asm
cargo install cargo-asm
cargo asm crate_name::function_name
```

### 10.5 æ€§èƒ½åˆ†æ

```bash
# ç¼–è¯‘æ—¶é—´åˆ†æ
cargo build --timings

# ç”ŸæˆHTMLæŠ¥å‘Š
# æŸ¥çœ‹target/cargo-timings/cargo-timing.html
```

### 10.6 è°ƒè¯•ç¼–è¯‘å™¨

```bash
# è®¾ç½®RUST_BACKTRACE
RUST_BACKTRACE=1 cargo build

# æ›´è¯¦ç»†çš„å›æº¯
RUST_BACKTRACE=full cargo build

# ç¼–è¯‘å™¨å†…éƒ¨æ—¥å¿—
RUSTC_LOG=debug cargo build
```

---

## é™„å½•

### A. å¸¸ç”¨rustcæ ‡å¿—

```bash
# ç¼–è¯‘é€‰é¡¹
-C opt-level=N        # ä¼˜åŒ–çº§åˆ« (0, 1, 2, 3, s, z)
-C debuginfo=N        # è°ƒè¯•ä¿¡æ¯ (0, 1, 2)
-C lto                # é“¾æ¥æ—¶ä¼˜åŒ–
-C codegen-units=N    # ä»£ç ç”Ÿæˆå¹¶è¡Œåº¦

# è¾“å‡ºé€‰é¡¹
--emit=TYPE           # è¾“å‡ºç±»å‹ (asm, llvm-ir, mir, link)
--crate-type=TYPE     # crateç±»å‹ (bin, lib, dylib, staticlib)

# è°ƒè¯•é€‰é¡¹
-Z unpretty=TYPE      # æ‰“å°å†…éƒ¨è¡¨ç¤º
-Z dump-mir=PASS      # è½¬å‚¨MIR
-Z time-passes        # æ˜¾ç¤ºç¼–è¯‘æ—¶é—´
-Z print-type-sizes   # æ‰“å°ç±»å‹å¤§å°
```

### B. ç¼–è¯‘å™¨ç»„ä»¶ç´¢å¼•

| ç»„ä»¶ | Crate | åŠŸèƒ½ |
|------|-------|------|
| è¯æ³•åˆ†æ | `rustc_lexer` | TokenåŒ– |
| è¯­æ³•åˆ†æ | `rustc_parse` | ASTæ„å»º |
| HIR | `rustc_hir` | é«˜çº§IR |
| ç±»å‹æ£€æŸ¥ | `rustc_typeck` | ç±»å‹æ¨æ–­ |
| å€Ÿç”¨æ£€æŸ¥ | `rustc_borrowck` | æ‰€æœ‰æƒéªŒè¯ |
| MIR | `rustc_mir_build` | MIRæ„å»º |
| ä¼˜åŒ– | `rustc_mir_transform` | MIRä¼˜åŒ– |
| ä»£ç ç”Ÿæˆ | `rustc_codegen_llvm` | LLVMåç«¯ |

### C. å­¦ä¹ èµ„æº

- ğŸ“š [Rustç¼–è¯‘å™¨å¼€å‘æŒ‡å—](https://rustc-dev-guide.rust-lang.org/)
- ğŸ“š [MIRæ–‡æ¡£](https://rust-lang.github.io/rustc-guide/mir/index.html)
- ğŸ“š [LLVMæ–‡æ¡£](https://llvm.org/docs/)
- ğŸ“¹ [RustConfç¼–è¯‘å™¨æ¼”è®²](https://www.youtube.com/c/RustVideos)

### D. ç»ƒä¹ é¢˜

#### åˆçº§ç»ƒä¹ 

1. ä½¿ç”¨`-Z unpretty=mir`æŸ¥çœ‹ç®€å•å‡½æ•°çš„MIR
2. æ¯”è¾ƒdebugå’Œreleaseæ¨¡å¼çš„LLVM IRå·®å¼‚
3. æŸ¥çœ‹ä¸åŒä¼˜åŒ–çº§åˆ«çš„æ±‡ç¼–è¾“å‡º

#### ä¸­çº§ç»ƒä¹ 

1. åˆ†æä¸€ä¸ªåŒ…å«æ³›å‹çš„å‡½æ•°çš„å•æ€åŒ–è¿‡ç¨‹
2. è§‚å¯Ÿå†…è”ä¼˜åŒ–å¯¹ä»£ç çš„å½±å“
3. ä½¿ç”¨`cargo-expand`æŸ¥çœ‹å®å±•å¼€ç»“æœ

#### é«˜çº§ç»ƒä¹ 

1. ä¸ºè‡ªå®šä¹‰æ•°æ®ç»“æ„åˆ†æå†…å­˜å¸ƒå±€
2. è°ƒè¯•ä¸€ä¸ªå¤æ‚çš„å€Ÿç”¨æ£€æŸ¥é”™è¯¯
3. åˆ†æå¢é‡ç¼–è¯‘çš„ä¾èµ–å›¾

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-10-20  
**ç»´æŠ¤è€…**: Rust Learning Community

ğŸ”§ **æ·±å…¥ç†è§£ç¼–è¯‘å™¨ï¼ŒæŒæ¡Rustçš„çµé­‚ï¼** âœ¨
